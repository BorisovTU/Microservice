CREATE OR REPLACE PACKAGE BODY RSI_NPTXCALC
IS

  FUNCTION TaxDepositoryMode RETURN NUMBER RESULT_CACHE RELIES_ON(DREGVAL_DBT)
  IS
  BEGIN
    IF g_TaxDepositoryMode IS NULL THEN
      g_TaxDepositoryMode := 0;
      
      IF Rsb_Common.GetRegFlagValue('SECUR\РЕЖИМ ХРАНИЛИЩА ДАННЫХ ДЛЯ НУ') = 'X' THEN
        g_TaxDepositoryMode := 1;
      END IF;
    END IF;
    RETURN g_TaxDepositoryMode;
  END;

  FUNCTION ConsRepaymPit RETURN NUMBER RESULT_CACHE RELIES_ON(DREGVAL_DBT)
  IS
  BEGIN
    IF g_ConsRepaymPit IS NULL THEN
      g_ConsRepaymPit := 0;
      
      IF Rsb_Common.GetRegFlagValue('COMMON\НДФЛ\УЧИТЫВАТЬ ПОГАШЕНИЯ В НДФЛ') = 'X' THEN
        g_ConsRepaymPit := 1;
      END IF;
    END IF;
    RETURN g_ConsRepaymPit;
  END;

  FUNCTION IsIncludeMaterialInOut RETURN NUMBER RESULT_CACHE RELIES_ON(DREGVAL_DBT)
  IS
  BEGIN
    IF g_IsIncludeMaterialInOut IS NULL THEN
      g_IsIncludeMaterialInOut := 0;
      
      IF Rsb_Common.GetRegFlagValue('COMMON\НДФЛ\УЧИТЫВАТЬ МАТ.ВЫГОДУ В ЗАТРАТАХ') = 'X' THEN
        g_IsIncludeMaterialInOut := 1;
      END IF;
    END IF;
    RETURN g_IsIncludeMaterialInOut;
  END;


  FUNCTION GetPartyResident(p_PartyID IN NUMBER, p_OnDate IN DATE) RETURN NUMBER
  IS
    v_CategoryValue dobjattr_dbt.t_NumInList % TYPE;
    v_not_resident  dparty_dbt.t_NotResident % TYPE;

    v_PtIsRes NUMBER := RSI_NPTXC.NPTXPARTY_UNDEF;
  BEGIN
    BEGIN
      SELECT Attr.t_NumInList INTO v_CategoryValue
        FROM dobjatcor_dbt AtCor, dobjattr_dbt Attr
       WHERE AtCor.t_ObjectType = RSB_SECUR.OBJTYPE_PARTY  
         AND AtCor.t_GroupID    = 42 -- Является плательщиком НДФЛ
         AND AtCor.t_Object     = LPAD(p_PartyID, 10, '0' )
         AND AtCor.t_ValidFromDate  = (SELECT MAX(t.T_ValidFromDate)
                                         FROM DOBJATCOR_DBT t
                                         WHERE t.T_ObjectType = AtCor.T_ObjectType
                                           AND t.T_GroupID    = AtCor.T_GroupID
                                           AND t.t_Object     = AtCor.t_Object
                                           AND t.T_ValidFromDate <= p_OnDate
                                      )
         AND Attr.t_AttrID      = AtCor.t_AttrID
         AND Attr.t_ObjectType  = AtCor.t_ObjectType
         AND Attr.t_GroupID     = AtCor.t_GroupID
         AND AtCor.t_ValidToDate >= p_OnDate;

       IF v_CategoryValue = '1' THEN
         v_PtIsRes := RSI_NPTXC.NPTXPARTY_RESIDENT; --для резидента
       ELSIF v_CategoryValue = CHR(0) THEN
         v_PtIsRes := RSI_NPTXC.NPTXPARTY_NOTRESIDENT; --для нерезидента
       END IF;


     EXCEPTION
      WHEN NO_DATA_FOUND THEN v_PtIsRes := RSI_NPTXC.NPTXPARTY_UNDEF;
      WHEN OTHERS THEN
             return 0;
    END;

    IF v_PtIsRes = RSI_NPTXC.NPTXPARTY_UNDEF THEN
      SELECT party.t_NoTResident INTO v_not_resident
        FROM DPARTY_DBT party
       WHERE party.t_PartyID = p_PartyID;

      IF v_not_resident = 'X' THEN
        v_PtIsRes := RSI_NPTXC.NPTXPARTY_NOTRESIDENT; --для нерезидента
      ELSE
        v_PtIsRes := RSI_NPTXC.NPTXPARTY_RESIDENT; --для резидента
      END IF;
    END IF;


    RETURN v_PtIsRes;
  END; 


  FUNCTION GetDir (pClient    IN NUMBER,
                   ClientID   IN NUMBER,
                   DealPart   IN NUMBER,
                   IsBuy      IN NUMBER)
    RETURN NUMBER RESULT_CACHE
  AS
    v_Dir   NUMBER;
  BEGIN
    IF (pClient = ClientID)
    THEN
      IF (DealPart = 1)
      THEN
        IF (IsBuy = 1)
        THEN
          v_Dir := RSI_NPTXC.TXOBJ_DIR_OUT;
        ELSE
          v_Dir := RSI_NPTXC.TXOBJ_DIR_IN;
        END IF;
      ELSE
        IF (IsBuy = 1)
        THEN
          v_Dir := RSI_NPTXC.TXOBJ_DIR_IN;
        ELSE
          v_Dir := RSI_NPTXC.TXOBJ_DIR_OUT;
        END IF;
      END IF;
    ELSE
      IF (DealPart = 1)
      THEN
        IF (IsBuy = 1)
        THEN
          v_Dir := RSI_NPTXC.TXOBJ_DIR_IN;
        ELSE
          v_Dir := RSI_NPTXC.TXOBJ_DIR_OUT;
        END IF;
      ELSE
        IF (IsBuy = 1)
        THEN
          v_Dir := RSI_NPTXC.TXOBJ_DIR_OUT;
        ELSE
          v_Dir := RSI_NPTXC.TXOBJ_DIR_IN;
        END IF;
      END IF;
    END IF;

    RETURN v_Dir;
  END;

  FUNCTION K(p_FromFI IN NUMBER, p_Date IN DATE) RETURN NUMBER RESULT_CACHE RELIES_ON(DRATEDEF_DBT, DRATEHIST_DBT)
  AS
  BEGIN
    RETURN RSI_RSB_FIInstr.ConvSum(1, p_FromFI, RSI_RSB_FIInstr.NATCUR, p_Date);
  END;


  PROCEDURE CalcAmountOrNKD (pAmount        IN NUMBER,
                             pNKD           IN NUMBER,
                             pCFI           IN NUMBER,
                             pNKDFIID       IN NUMBER,
                             pFactDate      IN DATE,
                             pIsRepo        IN NUMBER,
                             pFaceValueFI   IN NUMBER,
                             pPFI           IN NUMBER,
                             pPrincipal     IN NUMBER,
                             pRetAmount     OUT NUMBER,
                             pRetNKD        OUT NUMBER)
  AS
    v_Amount             NUMBER := 0;
    v_NKD                NUMBER := 0;                        
    vNomOnDate           NUMBER;
    vDifferenceNominal   NUMBER;
    vRateCFI             NUMBER;
    vRAteNKDFIID         NUMBER;
    v_err                NUMBER;
  BEGIN
    v_err := 0;
    v_Amount := pAmount;

    v_NKD := pNKD;

    IF pNKD <> 0 THEN
      IF (pCFI <> pNKDFIID)
      THEN
        v_NKD := pNKD * K(pNKDFIID, pFactDate) / K(pCFI, pFactDate);
      END IF;

      v_Amount := v_Amount - v_NKD;

      IF ((pNKDFIID <> pFaceValueFI) OR (pIsRepo = 1))
      THEN
        v_NKD := pNKD * K(pNKDFIID, pFactDate) / K(pFaceValueFI, pFactDate);
      ELSE
        v_NKD := pNKD;
      END IF;
    END IF;

    pRetAmount := v_Amount;
    pRetNKD    := v_NKD;
    
  END;

  FUNCTION GetDealRQDate(p_BOfficeKind IN NUMBER, p_DealID IN NUMBER) RETURN DATE
  AS
    v_MinPlanDate DATE := g_ZeroDate;
    v_MinFactDate DATE := g_ZeroDate;
  BEGIN

    SELECT NVL(MIN(rq.t_FactDate), g_ZeroDate)
      INTO v_MinFactDate
      FROM ddlrq_dbt rq
     WHERE rq.t_DocKind    = p_BOfficeKind 
       AND rq.t_DocID      = p_DealID 
       AND rq.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC
       AND rq.t_SubKind    = RSI_DLRQ.DLRQ_SUBKIND_AVOIRISS
       AND rq.t_Type       = RSI_DLRQ.DLRQ_TYPE_DELIVERY
       AND rq.t_DealPart   = 1;

    IF v_MinFactDate = g_ZeroDate THEN
      SELECT NVL(MIN(rq.t_PlanDate), g_ZeroDate)
        INTO v_MinPlanDate
        FROM ddlrq_dbt rq
       WHERE rq.t_DocKind    = p_BOfficeKind 
         AND rq.t_DocID      = p_DealID 
         AND rq.t_State      <> RSI_DLRQ.DLRQ_STATE_EXEC
         AND rq.t_SubKind    = RSI_DLRQ.DLRQ_SUBKIND_AVOIRISS
         AND rq.t_Type       = RSI_DLRQ.DLRQ_TYPE_DELIVERY
         AND rq.t_DealPart   = 1;

      RETURN v_MinPlanDate;
    END IF;

    RETURN v_MinFactDate;
  END;

  PROCEDURE LoadNptxData(p_ClientID IN NUMBER, p_BegDate IN DATE, p_EndDate IN DATE)
  IS

  BEGIN

    DELETE FROM DNPTXCOMM_TMP;

    --Код выборки позаимствован из вьюхи V_DLCOMISALL. Так гораздо быстрее работает, чем делать выборку из вьюхи
    INSERT INTO DNPTXCOMM_TMP
    SELECT Comis.T_ID,                    
           Comis.T_DOCKIND,          
           Comis.T_DOCID,              
           Comis.T_CONTRACT,        
           Comis.T_FEETYPE,           
           Comis.T_COMNUMBER,      
           Comis.T_SUM,                   
           Comis.T_NDS,                  
           Comis.T_DATE,                
           Comis.T_PLANPAYDATE,  
           Comis.T_FACTPAYDATE,  
           Comis.T_INPUTMEDIUM,  
           Comis.T_SERVOPERID,    
           Comis.T_ISBACK,            
           Comis.T_IMMATERIAL,    
           Comis.T_TYPE         
      FROM (SELECT CAST (q.T_ID AS NUMBER (10)) AS T_ID,
                   q.T_DOCKIND AS T_DOCKIND,
                   CAST (q.T_DOCID AS NUMBER (10)) AS T_DOCID,
                   q.T_CONTRACT AS T_CONTRACT,
                   CAST (q.T_FEETYPE AS NUMBER (5)) AS T_FEETYPE,
                   CAST (q.T_COMNUMBER AS NUMBER (5)) AS T_COMNUMBER,
                   CAST (q.T_SUM AS NUMBER (32, 12)) AS T_SUM,
                   CAST (q.T_NDS AS NUMBER (32, 12)) AS T_NDS,
                   CAST (q.T_DATE AS DATE) AS T_DATE,
                   CAST (q.T_PLANPAYDATE AS DATE) AS T_PLANPAYDATE,
                   q.T_FACTPAYDATE AS T_FACTPAYDATE,
                   CAST (q.T_INPUTMEDIUM AS CHAR (1)) AS T_INPUTMEDIUM,
                   CAST (q.T_SERVOPERID AS NUMBER (10)) AS T_SERVOPERID,
                   CAST (q.T_ISBACK AS CHAR (1)) AS T_ISBACK,
                   CAST (q.T_IMMATERIAL AS CHAR (1)) AS T_IMMATERIAL,
                   CAST (q.T_TYPE AS NUMBER (5)) AS T_TYPE
              FROM (SELECT DLCOMIS.T_ID AS T_ID,
                           DLCOMIS.T_DOCKIND AS T_DOCKIND,
                           DLCOMIS.T_DOCID AS T_DOCID,
                           DLCOMIS.T_CONTRACT AS T_CONTRACT,
                           DLCOMIS.T_FEETYPE AS T_FEETYPE,
                           DLCOMIS.T_COMNUMBER AS T_COMNUMBER,
                           DLCOMIS.T_SUM AS T_SUM,
                           DLCOMIS.T_NDS AS T_NDS,
                           DLCOMIS.T_DATE AS T_DATE,
                           DLCOMIS.T_PLANPAYDATE AS T_PLANPAYDATE,
                           DLCOMIS.T_FACTPAYDATE AS T_FACTPAYDATE,
                           DLCOMIS.T_INPUTMEDIUM AS T_INPUTMEDIUM,
                           DLCOMIS.T_SERVOPERID AS T_SERVOPERID,
                           DLCOMIS.T_ISBACK AS T_ISBACK,
                           DLCOMIS.T_IMMATERIAL AS T_IMMATERIAL,
                           1 AS T_TYPE,
                           DLCOMIS.T_CLIENTCONTRID,
                           DLCOMIS.T_ISBANKEXPENSES
                      FROM DDLCOMIS_DBT DLCOMIS, dsfcontr_dbt sf
                     WHERE DLCOMIS.T_DOCKIND IN (RSB_SECUR.DL_SECURITYDOC, RSB_SECUR.DL_RETIREMENT, RSB_SECUR.DL_AVRWRT)
                       AND (NOT EXISTS (SELECT 1
                                          FROM DOBJATCOR_DBT OBJATCOR
                                         WHERE OBJATCOR.T_OBJECTTYPE = 650
                                           AND OBJATCOR.T_GROUPID = 13
                                           AND OBJATCOR.T_ATTRID = 1
                                           AND OBJATCOR.T_OBJECT = CONCAT(LPAD(DLCOMIS.T_FEETYPE, 5, '0'), LPAD(DLCOMIS.T_COMNUMBER, 5, '0'))
                                       )
                            OR DLCOMIS.T_COMNUMBER = 15) /*PNV спасибо тем, кто использовал эту дистр.комиссию в сделках БОЦБ, пришлось забить ее здесь гвоздями, т.к. она TDF и должна быть в НДФЛ*/
                       AND DLCOMIS.T_FACTPAYDATE <= p_EndDate
                       AND sf.t_ID      = DLCOMIS.T_CONTRACT
                       AND sf.t_PartyID = p_ClientID
                       AND sf.t_ServKind IN (RSI_NPTO.PTSK_STOCKDL, RSI_NPTO.PTSK_DV)
                    UNION ALL
                    SELECT DEFCOM.T_ID AS T_ID,
                           BASOBJ.T_BASEOBJECTTYPE AS T_DOCKIND,
                           TO_NUMBER (BASOBJ.T_BASEOBJECTID) AS T_DOCID,
                           DEFCOM.T_CONID AS T_CONTRACT,
                           DEFCOM.T_FEETYPE AS T_FEETYPE,
                           DEFCOM.T_COMMNUMBER AS T_COMNUMBER,
                           BASOBJ.T_COMMSUM AS T_SUM,
                           BASOBJ.T_NDSSUM AS T_NDS,
                           DEFCOM.T_DATEFEE AS T_DATE,
                           DEFCOM.T_DATEFEE AS T_PLANPAYDATE,
                           DEFCOM.T_DATEFEE AS T_FACTPAYDATE,
                           'Р' AS T_INPUTMEDIUM,
                           0 AS T_SERVOPERID,
                           CHR (0) AS T_ISBACK,
                           CHR (0) AS T_IMMATERIAL,
                           2 AS T_TYPE,
                           DEFCOM.T_CONID AS T_CLIENTCONTRID,
                           CHR (0) AS T_ISBANKEXPENSES
                      FROM DSFBASOBJ_DBT BASOBJ,
                           DSFDEFCOM_DBT DEFCOM,
                           DSFCOMISS_DBT COMISS,
                           dsfcontr_dbt sf
                     WHERE DEFCOM.T_ID = BASOBJ.T_DEFCOMMID
                       AND COMISS.T_FEETYPE = DEFCOM.T_FEETYPE
                       AND COMISS.T_NUMBER = DEFCOM.T_COMMNUMBER
                       AND COMISS.T_SERVICEKIND = 1              --Фондовый дилинг
                       AND BASOBJ.T_BASEOBJECTTYPE IN (RSB_SECUR.DL_SECURITYDOC, RSB_SECUR.DL_RETIREMENT, RSB_SECUR.DL_AVRWRT)
                       AND sf.t_ID = DEFCOM.T_CONID
                       AND sf.t_PartyID = p_ClientID
                       AND sf.t_ServKind IN (RSI_NPTO.PTSK_STOCKDL, RSI_NPTO.PTSK_DV)
                       AND DEFCOM.T_DATEFEE <= p_EndDate
                       AND EXISTS (SELECT 1
                                     FROM DOBJATCOR_DBT OBJATCOR
                                    WHERE     OBJATCOR.T_OBJECTTYPE = 650
                                      AND OBJATCOR.T_GROUPID = 13
                                      AND OBJATCOR.T_ATTRID = 1
                                      AND OBJATCOR.T_OBJECT = CONCAT(LPAD(COMISS.T_FEETYPE, 5, '0'), LPAD(COMISS.T_NUMBER, 5, '0'))
                                  )
                   ) q
           ) Comis;

    DELETE FROM DFIID_TMP;
    --Добавить информацию об обращаемости ц/б по сделкам клиента
    RSI_NPTO.RecalcCirculate(p_ClientID, p_BegDate, p_EndDate, 0);

  END;

  FUNCTION GetSetCirculate(p_FIID IN NUMBER, p_Date IN DATE) RETURN NUMBER
  AS
    v_Circulate NUMBER;
  BEGIN
    v_Circulate := RSI_NPTO.GetFICirculateNPTXFI(p_FIID, p_Date);

    IF v_Circulate = 0 THEN
      v_Circulate := npto.Market1date(p_FIID, p_Date);
      
      BEGIN
        INSERT INTO DNPTXFI_DBT(T_FIID, T_DATE, T_CIRCULATE) VALUES(p_FIID, p_Date, v_Circulate);

        EXCEPTION
          WHEN OTHERS THEN NULL;
      END;
    END IF;

    RETURN v_Circulate;
  END;

  PROCEDURE InitNPTXOBJ(p_nptxobj IN OUT DNPTXOBJ_TMP%ROWTYPE)
  AS
  BEGIN
    p_nptxobj.T_ID             := 0;
    p_nptxobj.T_FUNCTIONKIND   := 0;
    p_nptxobj.T_DATE           := g_ZeroDate;   
    p_nptxobj.T_CLIENT         := -1;
    p_nptxobj.T_DIRECTION      := 0;        
    p_nptxobj.T_LEVEL          := 0;
    p_nptxobj.T_USER           := CHR(0);
    p_nptxobj.T_KIND           := 0;                              
    p_nptxobj.T_SUM            := 0;                                                 
    p_nptxobj.T_CUR            := -1;                                
    p_nptxobj.T_ANALITICKIND1  := 0;                           
    p_nptxobj.T_ANALITIC1      := -1;                                   
    p_nptxobj.T_ANALITICKIND2  := 0;                    
    p_nptxobj.T_ANALITIC2      := -1;                                          
    p_nptxobj.T_ANALITICKIND3  := 0;                     
    p_nptxobj.T_ANALITIC3      := -1;                             
    p_nptxobj.T_ANALITICKIND4  := 0;                     
    p_nptxobj.T_ANALITIC4      := -1;                        
    p_nptxobj.T_ANALITICKIND5  := 0;                     
    p_nptxobj.T_ANALITIC5      := -1;                         
    p_nptxobj.T_ANALITICKIND6  := 0; 
    p_nptxobj.T_ANALITIC6      := -1;                                            
    p_nptxobj.T_COMMENT        := CHR(1);      
    p_nptxobj.T_DOCID          := 0;
    p_nptxobj.T_STEP           := 0; 
    p_nptxobj.T_REESTRSUM      := 0;     
    p_nptxobj.T_FROMOUTSYST    := CHR(0);
    p_nptxobj.T_OUTSYSTCODE    := CHR(1);
    p_nptxobj.T_OUTOBJID       := CHR(1);
    p_nptxobj.T_SOURCEOBJID    := 0;
    p_nptxobj.T_TECHNICAL      := CHR(0);
    p_nptxobj.T_ACTION         := RSI_NPTXC.NPTXBC_ACTION_CREATE;
    p_nptxobj.T_REALOBJID      := 0;
    p_nptxobj.T_CONVDATE       := g_ZeroDate;
    p_nptxobj.T_TAXPERIOD      := 0;
    p_nptxobj.T_TRANSFDATE     := g_ZeroDate;
    p_nptxobj.T_TRANSFKIND     := 0;
    p_nptxobj.T_HOLDING_PERIOD := 0;
  END;

  /**
  @brief Скорректировать параметр "Технический" в объектах НДР во временной таблице
  @param [in] p_DocID Идентификатор операции (расчета НОБ), в которой выполняется создание и корректировка объектов
  */
  PROCEDURE CorrectTechnicalInObjTMP(p_DocID IN NUMBER, p_Step IN NUMBER, p_Level IN NUMBER)
  AS
    v_nptxop DNPTXOP_DBT%ROWTYPE;

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_IsTechnical NUMBER := 0;
  BEGIN

    SELECT * INTO v_nptxop FROM dnptxop_dbt WHERE t_ID = p_DocID;

    v_IsTechnical := RSB_SECUR.GetMainObjAttr(132 /*OBJTYPE_NPTXCALC*/, LPAD(v_nptxop.t_ID, 34, '0'), 1, v_nptxop.t_OperDate);

    IF p_Level = 3 THEN
      /*Для операций расчета НОБ со снятым признаком "Пересчет" и установленной категорией "Технический расчет" после формирования объектов НДР 3 уровня 
        выполнить отбор из таблицы с удаленными в этой операции объектами НДР все объекты НДР 3го уровня без признака "Технический" и датой, 
        равной дате предыдущего расчета из параметров выполняемой операции расчета. 
      */
      IF v_nptxop.t_Recalc = CHR(0) AND v_IsTechnical <> 0 THEN
        UPDATE dnptxobj_tmp tmp
           SET tmp.t_Technical = CHR(0)
         WHERE tmp.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
           /*Если есть удаленные объекты НДР, которые ссылаются на удаленную связь, но она точно такая же (кроме ID), как и связь из нового НДР*/
           AND (EXISTS(SELECT 1
                        FROM DNPTXOBJBC_DBT objbc,
                             DNPTXLNK_DBT lnk,
                             DNPTXLNKBC_DBT lnkbc,
                             DNPTXLOT_DBT buy,
                             DNPTXLOT_DBT sale,
                             DNPTXLOTBC_DBT buybc,
                             DNPTXLOTBC_DBT salebc
                       WHERE     objbc.t_DocID = v_nptxop.t_ID
                             AND objbc.T_CLIENT = tmp.T_CLIENT
                             AND objbc.T_DIRECTION = tmp.T_DIRECTION
                             AND objbc.T_LEVEL = tmp.T_LEVEL
                             AND objbc.T_KIND = tmp.T_KIND
                             AND objbc.T_SUM = tmp.T_SUM
                             AND objbc.T_CUR = tmp.T_CUR
                             AND objbc.T_ANALITICKIND1 = tmp.T_ANALITICKIND1
                             AND objbc.T_ANALITIC1 = tmp.T_ANALITIC1
                             AND objbc.T_ANALITICKIND2 = tmp.T_ANALITICKIND2
                             AND objbc.T_ANALITICKIND3 = tmp.T_ANALITICKIND3
                             AND objbc.T_ANALITIC3 = tmp.T_ANALITIC3
                             AND objbc.T_ANALITICKIND4 = tmp.T_ANALITICKIND4
                             AND objbc.T_ANALITIC4 = tmp.T_ANALITIC4
                             AND objbc.T_ANALITICKIND5 = tmp.T_ANALITICKIND5
                             AND objbc.T_ANALITIC5 = tmp.T_ANALITIC5
                             AND objbc.T_ANALITICKIND6 = tmp.T_ANALITICKIND6
                             AND objbc.T_ANALITIC6 = tmp.T_ANALITIC6
                             AND objbc.T_TECHNICAL <> CHR (88)
                             AND objbc.T_DATE = v_nptxop.T_PREVDATE
                             AND lnk.t_ID = tmp.t_Analitic2
                             AND buy.t_ID = lnk.t_BuyID
                             AND sale.t_ID = lnk.t_SaleID
                             AND lnkbc.t_ID = objbc.t_Analitic2
                             AND buybc.t_ID = lnkbc.t_BuyID
                             AND salebc.t_ID = lnkbc.t_SaleID
                             AND lnk.t_Amount = lnkbc.t_Amount
                             AND buy.t_DocKind = buybc.t_DocKind
                             AND buy.t_DocID = buybc.t_DocID
                             AND sale.t_DocKind = salebc.t_DocKind
                             AND sale.t_DocID = salebc.t_DocID
                     )
                OR
                /*Или есть удаленные НДР, ссылающиеся на ту же самую связь*/
                EXISTS(SELECT 1
                        FROM DNPTXOBJBC_DBT objbc
                       WHERE     objbc.t_DocID = v_nptxop.t_ID
                             AND objbc.T_CLIENT = tmp.T_CLIENT
                             AND objbc.T_DIRECTION = tmp.T_DIRECTION
                             AND objbc.T_LEVEL = tmp.T_LEVEL
                             AND objbc.T_KIND = tmp.T_KIND
                             AND objbc.T_SUM = tmp.T_SUM
                             AND objbc.T_CUR = tmp.T_CUR
                             AND objbc.T_ANALITICKIND1 = tmp.T_ANALITICKIND1
                             AND objbc.T_ANALITIC1 = tmp.T_ANALITIC1
                             AND objbc.T_ANALITICKIND2 = tmp.T_ANALITICKIND2
                             AND objbc.T_ANALITIC2 = tmp.T_ANALITIC2
                             AND objbc.T_ANALITICKIND3 = tmp.T_ANALITICKIND3
                             AND objbc.T_ANALITIC3 = tmp.T_ANALITIC3
                             AND objbc.T_ANALITICKIND4 = tmp.T_ANALITICKIND4
                             AND objbc.T_ANALITIC4 = tmp.T_ANALITIC4
                             AND objbc.T_ANALITICKIND5 = tmp.T_ANALITICKIND5
                             AND objbc.T_ANALITIC5 = tmp.T_ANALITIC5
                             AND objbc.T_ANALITICKIND6 = tmp.T_ANALITICKIND6
                             AND objbc.T_ANALITIC6 = tmp.T_ANALITIC6
                             AND objbc.T_TECHNICAL <> CHR (88)
                             AND objbc.T_DATE = v_nptxop.T_PREVDATE
                     )
              );

      END IF;

      IF v_nptxop.t_Recalc = CHR(0) THEN
        UPDATE dnptxobj_tmp tmp
           SET tmp.t_Date = (SELECT objbc.t_Date
                               FROM DNPTXOBJBC_DBT objbc,
                                    DNPTXLNK_DBT lnk,
                                    DNPTXLNKBC_DBT lnkbc,
                                    DNPTXLOT_DBT buy,
                                    DNPTXLOT_DBT sale,
                                    DNPTXLOTBC_DBT buybc,
                                    DNPTXLOTBC_DBT salebc
                              WHERE     objbc.t_DocID = v_nptxop.t_ID
                                    AND objbc.T_CLIENT = tmp.T_CLIENT
                                    AND objbc.T_DIRECTION = tmp.T_DIRECTION
                                    AND objbc.T_LEVEL = tmp.T_LEVEL
                                    AND objbc.T_KIND = tmp.T_KIND
                                    AND objbc.T_SUM = tmp.T_SUM
                                    AND objbc.T_CUR = tmp.T_CUR
                                    AND objbc.T_ANALITICKIND1 = tmp.T_ANALITICKIND1
                                    AND objbc.T_ANALITIC1 = tmp.T_ANALITIC1
                                    AND objbc.T_ANALITICKIND2 = tmp.T_ANALITICKIND2
                                    AND objbc.T_ANALITICKIND3 = tmp.T_ANALITICKIND3
                                    AND objbc.T_ANALITIC3 = tmp.T_ANALITIC3
                                    AND objbc.T_ANALITICKIND4 = tmp.T_ANALITICKIND4
                                    AND objbc.T_ANALITIC4 = tmp.T_ANALITIC4
                                    AND objbc.T_ANALITICKIND5 = tmp.T_ANALITICKIND5
                                    AND objbc.T_ANALITIC5 = tmp.T_ANALITIC5
                                    AND objbc.T_ANALITICKIND6 = tmp.T_ANALITICKIND6
                                    AND objbc.T_ANALITIC6 = tmp.T_ANALITIC6
                                    AND objbc.T_DATE = v_nptxop.T_PREVDATE
                                    AND lnk.t_ID = tmp.t_Analitic2
                                    AND buy.t_ID = lnk.t_BuyID
                                    AND sale.t_ID = lnk.t_SaleID
                                    AND lnkbc.t_ID = objbc.t_Analitic2
                                    AND buybc.t_ID = lnkbc.t_BuyID
                                    AND salebc.t_ID = lnkbc.t_SaleID
                                    AND lnk.t_Amount = lnkbc.t_Amount
                                    AND buy.t_DocKind = buybc.t_DocKind
                                    AND buy.t_DocID = buybc.t_DocID
                                    AND sale.t_DocKind = salebc.t_DocKind
                                    AND sale.t_DocID = salebc.t_DocID
                                    AND ROWNUM = 1
                              )
         WHERE tmp.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
           --Если есть удаленные объекты НДР, которые ссылаются на удаленную связь, но она точно такая же (кроме ID), как и связь из нового НДР
           AND EXISTS(SELECT 1
                       FROM DNPTXOBJBC_DBT objbc,
                            DNPTXLNK_DBT lnk,
                            DNPTXLNKBC_DBT lnkbc,
                            DNPTXLOT_DBT buy,
                            DNPTXLOT_DBT sale,
                            DNPTXLOTBC_DBT buybc,
                            DNPTXLOTBC_DBT salebc
                      WHERE     objbc.t_DocID = v_nptxop.t_ID
                            AND objbc.T_CLIENT = tmp.T_CLIENT
                            AND objbc.T_DIRECTION = tmp.T_DIRECTION
                            AND objbc.T_LEVEL = tmp.T_LEVEL
                            AND objbc.T_KIND = tmp.T_KIND
                            AND objbc.T_SUM = tmp.T_SUM
                            AND objbc.T_CUR = tmp.T_CUR
                            AND objbc.T_ANALITICKIND1 = tmp.T_ANALITICKIND1
                            AND objbc.T_ANALITIC1 = tmp.T_ANALITIC1
                            AND objbc.T_ANALITICKIND2 = tmp.T_ANALITICKIND2
                            AND objbc.T_ANALITICKIND3 = tmp.T_ANALITICKIND3
                            AND objbc.T_ANALITIC3 = tmp.T_ANALITIC3
                            AND objbc.T_ANALITICKIND4 = tmp.T_ANALITICKIND4
                            AND objbc.T_ANALITIC4 = tmp.T_ANALITIC4
                            AND objbc.T_ANALITICKIND5 = tmp.T_ANALITICKIND5
                            AND objbc.T_ANALITIC5 = tmp.T_ANALITIC5
                            AND objbc.T_ANALITICKIND6 = tmp.T_ANALITICKIND6
                            AND objbc.T_ANALITIC6 = tmp.T_ANALITIC6
                            AND objbc.T_DATE = v_nptxop.T_PREVDATE
                            AND lnk.t_ID = tmp.t_Analitic2
                            AND buy.t_ID = lnk.t_BuyID
                            AND sale.t_ID = lnk.t_SaleID
                            AND lnkbc.t_ID = objbc.t_Analitic2
                            AND buybc.t_ID = lnkbc.t_BuyID
                            AND salebc.t_ID = lnkbc.t_SaleID
                            AND lnk.t_Amount = lnkbc.t_Amount
                            AND buy.t_DocKind = buybc.t_DocKind
                            AND buy.t_DocID = buybc.t_DocID
                            AND sale.t_DocKind = salebc.t_DocKind
                            AND sale.t_DocID = salebc.t_DocID
                    );

        UPDATE dnptxobj_tmp tmp
           SET tmp.t_Date = (SELECT objbc.t_Date
                               FROM DNPTXOBJBC_DBT objbc
                              WHERE     objbc.t_DocID = v_nptxop.t_ID
                                    AND objbc.T_CLIENT = tmp.T_CLIENT
                                    AND objbc.T_DIRECTION = tmp.T_DIRECTION
                                    AND objbc.T_LEVEL = tmp.T_LEVEL
                                    AND objbc.T_KIND = tmp.T_KIND
                                    AND objbc.T_SUM = tmp.T_SUM
                                    AND objbc.T_CUR = tmp.T_CUR
                                    AND objbc.T_ANALITICKIND1 = tmp.T_ANALITICKIND1
                                    AND objbc.T_ANALITIC1 = tmp.T_ANALITIC1
                                    AND objbc.T_ANALITICKIND2 = tmp.T_ANALITICKIND2
                                    AND objbc.T_ANALITIC2 = tmp.T_ANALITIC2
                                    AND objbc.T_ANALITICKIND3 = tmp.T_ANALITICKIND3
                                    AND objbc.T_ANALITIC3 = tmp.T_ANALITIC3
                                    AND objbc.T_ANALITICKIND4 = tmp.T_ANALITICKIND4
                                    AND objbc.T_ANALITIC4 = tmp.T_ANALITIC4
                                    AND objbc.T_ANALITICKIND5 = tmp.T_ANALITICKIND5
                                    AND objbc.T_ANALITIC5 = tmp.T_ANALITIC5
                                    AND objbc.T_ANALITICKIND6 = tmp.T_ANALITICKIND6
                                    AND objbc.T_ANALITIC6 = tmp.T_ANALITIC6
                                    AND objbc.T_DATE = v_nptxop.T_PREVDATE
                                    AND ROWNUM = 1
                            )
         WHERE tmp.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
           AND --есть удаленные НДР, ссылающиеся на ту же самую связь
                EXISTS(SELECT 1
                        FROM DNPTXOBJBC_DBT objbc
                       WHERE     objbc.t_DocID = v_nptxop.t_ID
                             AND objbc.T_CLIENT = tmp.T_CLIENT
                             AND objbc.T_DIRECTION = tmp.T_DIRECTION
                             AND objbc.T_LEVEL = tmp.T_LEVEL
                             AND objbc.T_KIND = tmp.T_KIND
                             AND objbc.T_SUM = tmp.T_SUM
                             AND objbc.T_CUR = tmp.T_CUR
                             AND objbc.T_ANALITICKIND1 = tmp.T_ANALITICKIND1
                             AND objbc.T_ANALITIC1 = tmp.T_ANALITIC1
                             AND objbc.T_ANALITICKIND2 = tmp.T_ANALITICKIND2
                             AND objbc.T_ANALITIC2 = tmp.T_ANALITIC2
                             AND objbc.T_ANALITICKIND3 = tmp.T_ANALITICKIND3
                             AND objbc.T_ANALITIC3 = tmp.T_ANALITIC3
                             AND objbc.T_ANALITICKIND4 = tmp.T_ANALITICKIND4
                             AND objbc.T_ANALITIC4 = tmp.T_ANALITIC4
                             AND objbc.T_ANALITICKIND5 = tmp.T_ANALITICKIND5
                             AND objbc.T_ANALITIC5 = tmp.T_ANALITIC5
                             AND objbc.T_ANALITICKIND6 = tmp.T_ANALITICKIND6
                             AND objbc.T_ANALITIC6 = tmp.T_ANALITIC6
                             AND objbc.T_DATE = v_nptxop.T_PREVDATE
                     ); 
      END IF;

      --Из-за особенностей расчетов могут возникать абсолютно одинаковы НРД 3-го уровня, отличающие только знаком суммы.
      --Удалим их из временной таблицы
      DELETE FROM DNPTXOBJ_TMP TMP
       WHERE TMP.T_LEVEL = 3
         AND EXISTS(SELECT 1
                      FROM DNPTXOBJ_TMP TMP1
                     WHERE TMP1.T_CLIENT        = TMP.T_CLIENT
                       AND TMP1.T_DIRECTION     = TMP.T_DIRECTION
                       AND TMP1.T_LEVEL         = TMP.T_LEVEL
                       AND TMP1.T_KIND          = TMP.T_KIND
                       AND TMP1.T_SUM           = -1*TMP.T_SUM
                       AND TMP1.T_CUR           = TMP.T_CUR
                       AND TMP1.T_ANALITICKIND1 = TMP.T_ANALITICKIND1
                       AND TMP1.T_ANALITIC1     = TMP.T_ANALITIC1
                       AND TMP1.T_ANALITICKIND2 = TMP.T_ANALITICKIND2
                       AND TMP1.T_ANALITIC2     = TMP.T_ANALITIC2
                       AND TMP1.T_ANALITICKIND3 = TMP.T_ANALITICKIND3
                       AND TMP1.T_ANALITIC3     = TMP.T_ANALITIC3
                       AND TMP1.T_ANALITICKIND4 = TMP.T_ANALITICKIND4
                       AND TMP1.T_ANALITIC4     = TMP.T_ANALITIC4
                       AND TMP1.T_ANALITICKIND5 = TMP.T_ANALITICKIND5
                       AND TMP1.T_ANALITIC5     = TMP.T_ANALITIC5
                       AND TMP1.T_ANALITICKIND6 = TMP.T_ANALITICKIND6
                       AND TMP1.T_ANALITIC6     = TMP.T_ANALITIC6
                       AND TMP1.T_DATE          = TMP.T_DATE
                   );
    END IF;

    /*Для уровней 3-7 удалим технические НДР от прежних расчетов и создадим их копии под текущей операцией, но с новой датой (кроме 3 ур.)*/
    IF p_Level >= 3 THEN
      IF v_nptxop.t_Recalc <> 'X'
      THEN
         FOR CurObj IN (SELECT nptxobj.*
                          FROM DNPTXOBJ_DBT nptxobj, DNPTXKIND_DBT K
                         WHERE nptxobj.t_Client = v_nptxop.t_Client
                           AND nptxobj.t_Date <= v_nptxop.t_OperDate
                           AND EXTRACT(YEAR FROM nptxobj.t_Date) = EXTRACT(YEAR FROM v_nptxop.t_OperDate)
                           AND nptxobj.t_Technical = 'X'
                           AND nptxobj.t_Level = p_Level
                           AND K.t_Element = nptxobj.t_Kind
                           AND NOT EXISTS(SELECT 1 
                                           FROM DNPTXOBJ_TMP TMP
                                          WHERE TMP.T_ACTION = RSI_NPTXC.NPTXBC_ACTION_DELETE
                                            AND TMP.T_REALOBJID = nptxobj.t_ObjID
                                         )
                           AND 1 = (CASE WHEN v_nptxop.t_IIS = 'X' AND (instr(K.t_Code, 'ИИС') > 0 OR (nptxobj.t_AnaliticKind6 = RSI_NPTXC.TXOBJ_KIND6020 AND RSI_NPTO.CheckContrIIS(nptxobj.t_Analitic6) != 0)) THEN 1
                                         WHEN v_nptxop.t_IIS = CHR(0) AND instr(K.t_Code, 'ИИС') = 0 AND (nptxobj.t_AnaliticKind6 = 0 OR (nptxobj.t_AnaliticKind6 = RSI_NPTXC.TXOBJ_KIND6020 AND RSI_NPTO.CheckContrIIS(nptxobj.t_Analitic6) = 0)) THEN 1
                                         ELSE 0 END
                                   )
                           AND 1 = (CASE WHEN v_nptxop.t_IIS = CHR(0) OR v_nptxop.t_Contract <= 0 THEN 1
                                         WHEN v_nptxop.t_IIS = 'X' AND v_nptxop.t_Contract > 0 AND nptxobj.t_AnaliticKind6 = RSI_NPTXC.TXOBJ_KIND6020 AND nptxobj.t_Analitic6 IN (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = v_nptxop.t_Contract) THEN 1
                                         ELSE 0 END  
                                   )
                           AND (RSI_NPTO.GetLucreStartTaxPeriod() < EXTRACT(YEAR FROM nptxobj.t_Date) 
                                OR (v_nptxop.t_SubKind_Operation = RSI_NPTXC.DL_TXBASECALC_OPTYPE_LUCRE AND nptxobj.t_Kind IN (RSI_NPTXC.TXOBJ_MATERIAL, RSI_NPTXC.TXOBJ_PAIDMATERIAL, RSI_NPTXC.TXOBJ_DUEMATERIAL, RSI_NPTXC.TXOBJ_MATERIAL, RSI_NPTXC.TXOBJ_PLUSG_2640, RSI_NPTXC.TXOBJ_PLUSG_2641))
                                OR (v_nptxop.t_SubKind_Operation <> RSI_NPTXC.DL_TXBASECALC_OPTYPE_LUCRE AND nptxobj.t_Kind NOT IN (RSI_NPTXC.TXOBJ_MATERIAL, RSI_NPTXC.TXOBJ_PAIDMATERIAL, RSI_NPTXC.TXOBJ_DUEMATERIAL, RSI_NPTXC.TXOBJ_MATERIAL, RSI_NPTXC.TXOBJ_PLUSG_2640, RSI_NPTXC.TXOBJ_PLUSG_2641))
                               )
                       )
         LOOP
            
            --Удаляем прежний НДР
            InitNPTXOBJ(nptxobj);

            nptxobj.T_DOCID      := p_DocID;
            nptxobj.T_STEP       := p_Step;
            nptxobj.T_ACTION     := RSI_NPTXC.NPTXBC_ACTION_DELETE;
            nptxobj.T_REALOBJID  := CurObj.T_OBJID;   

            nptxobj_ins.extend;
            nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

            --Создаем такой же новый с новой датой
            InitNPTXOBJ(nptxobj);

            nptxobj.T_FUNCTIONKIND   := 1; 
            nptxobj.T_DATE           := (CASE WHEN CurObj.T_LEVEL = 3 THEN CurObj.T_DATE ELSE v_nptxop.t_OperDate END);         
            nptxobj.T_CLIENT         := CurObj.T_CLIENT;       
            nptxobj.T_DIRECTION      := CurObj.T_DIRECTION;    
            nptxobj.T_LEVEL          := CurObj.T_LEVEL;        
            nptxobj.T_KIND           := CurObj.T_KIND;         
            nptxobj.T_SUM            := CurObj.T_SUM;          
            nptxobj.T_CUR            := CurObj.T_CUR;          
            nptxobj.T_ANALITICKIND1  := CurObj.T_ANALITICKIND1;
            nptxobj.T_ANALITIC1      := CurObj.T_ANALITIC1;    
            nptxobj.T_ANALITICKIND2  := CurObj.T_ANALITICKIND2;
            nptxobj.T_ANALITIC2      := CurObj.T_ANALITIC2;    
            nptxobj.T_ANALITICKIND3  := CurObj.T_ANALITICKIND3;
            nptxobj.T_ANALITIC3      := CurObj.T_ANALITIC3;    
            nptxobj.T_ANALITICKIND4  := CurObj.T_ANALITICKIND4;
            nptxobj.T_ANALITIC4      := CurObj.T_ANALITIC4;    
            nptxobj.T_ANALITICKIND5  := CurObj.T_ANALITICKIND5;
            nptxobj.T_ANALITIC5      := CurObj.T_ANALITIC5;    
            nptxobj.T_ANALITICKIND6  := CurObj.T_ANALITICKIND6;
            nptxobj.T_ANALITIC6      := CurObj.T_ANALITIC6;    
            nptxobj.T_COMMENT        := CurObj.T_COMMENT;      
            nptxobj.T_DOCID          := p_DocID;        
            nptxobj.T_STEP           := p_Step;         
            nptxobj.T_TECHNICAL      := (CASE WHEN v_IsTechnical = 0 THEN CHR(0) ELSE CurObj.T_TECHNICAL END);    
            nptxobj.T_TRANSFDATE     := CurObj.T_TRANSFDATE;
            nptxobj.T_TRANSFKIND     := CurObj.T_TRANSFKIND; 
            nptxobj.T_CHANGECODE     := CurObj.T_CHANGECODE;

            nptxobj_ins.extend;
            nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
            
         END LOOP;
         
         IF nptxobj_ins.COUNT > 0 THEN
           FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
                INSERT INTO DNPTXOBJ_TMP
                     VALUES nptxobj_ins(indx);
            
           nptxobj_ins.Delete;
         END IF;
      END IF;
    END IF;              
    
  END;
  
  /**
  @brief [in] Для объектов НДР, создаваемых в операциях пересчета НОБ, определяем признак "Технический расчет"
  @param [in] pBegDate Дата начала
  @param [in] pEndDate Дата окончания
  @param [in] pClient ID клиента
  @param [in] pKind Вид объектов НДР
  @param [in] pAnaliticKind1 Вид аналитики 1
  @param [in] pAnalitic1 Значение аналитики 1
  @param [in] pAnalitickind2 Вид аналитики 2
  @param [in] pAnalitic2 Значение аналитики 2
  @param [in] pAnaliticKind3 Вид аналитики 3
  @param [in] pAnalitic3 Значение аналитики 3
  @param [in] pAnaliticKind4 Вид аналитики 4
  @param [in] pAnalitic4 Значение аналитики 4
  @param [in] pAnaliticKind5 Вид аналитики 5
  @param [in] pAnalitic5 Значение аналитики 5
  @param [in] pAnaliticKind6 Вид аналитики 6
  @param [in] pAnalitic6 Значение аналитики 6
  @param [in] pTechnical Признак технического расчета, установленный на операции расчета НОБ
  @param [in] pRecalc Признак "Пересчет", установленный на операции расчета НОБ
  */
  FUNCTION IsTechnicalOldNPTXOBJ(pDocID IN NUMBER,
                                 pBegDate IN DATE,
                                 pEndDate IN DATE,
                                 pClient IN NUMBER,
                                 pKind IN NUMBER,
                                 pLevel IN NUMBER,
                                 pAnaliticKind1 IN NUMBER,
                                 pAnalitic1 IN NUMBER,
                                 pAnalitickind2 IN NUMBER,
                                 pAnalitic2 IN NUMBER,
                                 pAnaliticKind3 IN NUMBER,
                                 pAnalitic3 IN NUMBER,
                                 pAnaliticKind4 IN NUMBER,
                                 pAnalitic4 IN NUMBER,
                                 pAnaliticKind5 IN NUMBER,
                                 pAnalitic5 IN NUMBER,
                                 pAnaliticKind6 IN NUMBER,
                                 pAnalitic6 IN NUMBER,
                                 pTechnical IN NUMBER,
                                 pRecalc IN CHAR,
                                 pOutSystCode IN VARCHAR2 DEFAULT CHR(1),
                                 pTransfDate IN DATE DEFAULT TO_DATE('01.01.0001','DD.MM.YYYY'),
                                 pTransfKind IN NUMBER DEFAULT 0,
                                 pHolding_Period IN NUMBER DEFAULT 0
                                ) RETURN CHAR
  IS
     v_nptxop DNPTXOP_DBT%ROWTYPE;
     v_Technical CHAR := CHR(0);
     v_FindTech BOOLEAN := FALSE;

     v_AnaliticKind6 NUMBER;
     v_Analitic6     NUMBER;
  BEGIN

     v_AnaliticKind6 := pAnaliticKind6;
     v_Analitic6     := pAnalitic6;    

     IF pLevel >= 3 AND pLevel <= 7 AND pAnaliticKind6 = RSI_NPTXC.TXOBJ_KIND6020 AND RSI_NPTO.CheckContrIIS(pAnalitic6) = 0 THEN
       v_AnaliticKind6 := 0;
       v_Analitic6     := -1;
     END IF;
     
     IF pRecalc = CHR(88)
     THEN
        
       SELECT * INTO v_nptxop
         FROM dnptxop_dbt
        WHERE t_ID = pDocID;

       IF pEndDate < v_nptxop.t_EndRecalcDate THEN
         --Если это не последний период расчета, то значит уже была какая-то не техническая операция, так как периоды определяются именно по выводам, закрытиям договора и т.п.
         --Поэтому признак "Технический" не ставим
         v_Technical := CHR(0);
       ELSIF pEndDate = v_nptxop.t_EndRecalcDate THEN  --Если это последний период расчета, то признак "Технический" для НДР определяем по прошлым НДР

         IF pLevel = 3 THEN
           BEGIN
             SELECT objbc.T_TECHNICAL INTO v_Technical
               FROM DNPTXOBJBC_DBT objbc,
                    DNPTXLNK_DBT lnk,
                    DNPTXLNKBC_DBT lnkbc,
                    DNPTXLOT_DBT buy,
                    DNPTXLOT_DBT sale,
                    DNPTXLOTBC_DBT buybc,
                    DNPTXLOTBC_DBT salebc
              WHERE     objbc.t_DocID = pDocID
                    AND objbc.T_CLIENT = pClient
                    AND objbc.T_LEVEL = pLevel
                    AND objbc.T_KIND = pKind
                    AND objbc.T_ANALITICKIND1 = pAnaliticKind1
                    AND objbc.T_ANALITIC1 = pAnalitic1
                    AND objbc.T_ANALITICKIND2 = pAnaliticKind2
                    AND objbc.T_ANALITICKIND3 = pAnaliticKind3
                    AND objbc.T_ANALITIC3 = pAnalitic3
                    AND objbc.T_ANALITICKIND4 = pAnaliticKind4
                    AND objbc.T_ANALITIC4 = pAnalitic4
                    AND objbc.T_ANALITICKIND5 = pAnaliticKind5
                    AND objbc.T_ANALITIC5 = pAnalitic5
                    AND objbc.T_ANALITICKIND6 = v_AnaliticKind6
                    AND objbc.T_ANALITIC6 = v_Analitic6
                    AND objbc.t_OutSystCode = (CASE WHEN pOutSystCode IS NULL OR pOutSystCode = CHR(1) THEN objbc.t_OutSystCode ELSE pOutSystCode END)
                    AND objbc.t_TransfDate = (CASE WHEN pTransfDate IS NULL OR pTransfDate = g_ZeroDate THEN objbc.t_TransfDate ELSE pTransfDate END)
                    AND objbc.t_TransfKind = (CASE WHEN pTransfKind IS NULL OR pTransfKind = 0 THEN objbc.t_TransfKind ELSE pTransfKind END)
                    AND objbc.t_Holding_Period = (CASE WHEN pHolding_Period IS NULL OR pHolding_Period = 0 THEN objbc.t_Holding_Period ELSE pHolding_Period END)
                    AND lnk.t_ID = pAnalitic2
                    AND buy.t_ID = lnk.t_BuyID
                    AND sale.t_ID = lnk.t_SaleID
                    AND lnkbc.t_ID = objbc.t_Analitic2
                    AND buybc.t_ID = lnkbc.t_BuyID
                    AND salebc.t_ID = lnkbc.t_SaleID
                    AND lnk.t_Amount = lnkbc.t_Amount
                    AND buy.t_DocKind = buybc.t_DocKind
                    AND buy.t_DocID = buybc.t_DocID
                    AND sale.t_DocKind = salebc.t_DocKind
                    AND sale.t_DocID = salebc.t_DocID
                    AND ROWNUM = 1;
           
             v_FindTech := TRUE;

           EXCEPTION
             WHEN NO_DATA_FOUND
             THEN v_FindTech := FALSE;
           END;

         END IF;

         IF v_FindTech = FALSE THEN
           BEGIN

               -- При установленном флаге "Пересчет" ищем старую операцию расчета НОБ, в которой образовался объект НДР, предшествующий текущему,,
               -- и на которой уставновлено значение категории "Технический расчет" = "Технический". Если такая операция существует,
               -- то в новый НДР устанавливаем признак "t_Technical"
               SELECT objbc.t_Technical INTO v_Technical
               FROM DNPTXOP_DBT nptxop, DNPTXOBDCBC_DBT obdcbc, DNPTXOBJBC_DBT objbc
               WHERE nptxop.t_DocKind = RSI_NPTXC.DL_CALCNDFL
                 AND nptxop.t_Kind_Operation = 2035
                 AND nptxop.t_OperDate >= pBegDate
                 AND nptxop.t_PrevDate <= pEndDate
                 AND nptxop.t_Client = pClient
                 AND obdcbc.t_DocID = nptxop.t_ID
                 AND objbc.t_ObjID = obdcbc.t_ObjID
                 AND objbc.t_DocID = pDocID
                 AND objbc.t_Client = pClient
                 AND objbc.t_Kind = pKind
                 AND objbc.t_Level = pLevel
                 AND objbc.t_OutSystCode = (CASE WHEN pOutSystCode IS NULL OR pOutSystCode = CHR(1) THEN objbc.t_OutSystCode ELSE pOutSystCode END)
                 AND objbc.t_TransfDate = (CASE WHEN pTransfDate IS NULL OR pTransfDate = g_ZeroDate THEN objbc.t_TransfDate ELSE pTransfDate END)
                 AND objbc.t_TransfKind = (CASE WHEN pTransfKind IS NULL OR pTransfKind = 0 THEN objbc.t_TransfKind ELSE pTransfKind END)
                 AND objbc.t_Holding_Period = (CASE WHEN pHolding_Period IS NULL OR pHolding_Period = 0 THEN objbc.t_Holding_Period ELSE pHolding_Period END)
                 AND (
                        (
                           pAnaliticKind1 > 0
                           AND objbc.t_AnaliticKind1 = pAnaliticKind1
                        )
                        OR pAnaliticKind1 <= 0
                     )
                 AND (
                        (
                           pAnalitic1 > 0
                           AND objbc.t_Analitic1 = pAnalitic1
                        )
                        OR pAnalitic1 <= 0
                     )
                 AND (
                        (
                           pAnaliticKind2 > 0
                           AND objbc.t_AnaliticKind2 = pAnaliticKind2
                        )
                        OR pAnaliticKind2 <= 0
                     )
                 AND (
                        (
                           pAnalitic2 > 0
                           AND objbc.t_Analitic2 = pAnalitic2
                        )
                        OR pAnalitic2 <= 0
                     )
                 AND (
                        (
                           pAnaliticKind3 > 0
                           AND objbc.t_AnaliticKind3 = pAnaliticKind3
                        )
                        OR pAnaliticKind3 <= 0
                     )
                 AND (
                        (
                           pAnalitic3 > 0
                           AND objbc.t_Analitic3 = pAnalitic3
                        )
                        OR pAnalitic3 <= 0
                     )
                 AND (
                        (
                           pAnaliticKind4 > 0
                           AND objbc.t_AnaliticKind4 = pAnaliticKind4
                        )
                        OR pAnaliticKind4 <= 0
                     )
                 AND (
                        (
                           pAnalitic4 > 0
                           AND objbc.t_Analitic4 = pAnalitic4
                        )
                        OR pAnalitic4 <= 0
                     )
                 AND (
                        (
                           pAnaliticKind5 > 0
                           AND objbc.t_AnaliticKind5 = pAnaliticKind5
                        )
                        OR pAnaliticKind5 <= 0
                     )
                 AND (
                        (
                           pAnalitic5 > 0
                           AND objbc.t_Analitic5 = pAnalitic5
                        )
                        OR pAnalitic5 <= 0
                     )
                 AND (
                        (
                           v_AnaliticKind6 > 0
                           AND objbc.t_AnaliticKind6 = v_AnaliticKind6
                        )
                        OR v_AnaliticKind6 <= 0
                     )
                 AND (
                        (
                           v_Analitic6 > 0
                           AND objbc.t_Analitic6 = v_Analitic6
                        )
                        OR v_Analitic6 <= 0
                     )
                 AND objbc.t_Technical = 'X'
                 AND ROWNUM = 1;
              
            EXCEPTION
              WHEN NO_DATA_FOUND
              THEN v_FindTech := FALSE; v_Technical := CHR(0);
           END;
         END IF;

         IF v_FindTech = FALSE THEN
           --Если объект не нашли и т.к. это последний период расчета, то при пересчете дата окончания периода должна быть равна дате предыдущего расчета
           --Ищем эту предыдущую операцию и берем категорию признак с неё
           FOR one_rec IN (SELECT (CASE WHEN RSB_SECUR.GetMainObjAttr(132 /*OBJTYPE_NPTXCALC*/, LPAD(nptxop.t_ID, 34, '0'), 1, nptxop.t_OperDate) > 0 THEN CHR(88) ELSE CHR(0) END) as IsTech
                             FROM dnptxop_dbt nptxop
                            WHERE nptxop.t_DocKind = RSI_NPTXC.DL_CALCNDFL
                              AND nptxop.t_Client = v_nptxop.t_Client
                              AND nptxop.t_IIS = v_nptxop.t_IIS
                              AND nptxop.t_Contract = v_nptxop.t_Contract
                              AND nptxop.t_OperDate <= v_nptxop.t_EndRecalcDate
                              AND EXTRACT(YEAR FROM nptxop.t_OperDate) = EXTRACT(YEAR FROM v_nptxop.t_EndRecalcDate)
                              AND nptxop.t_Status > RSI_NPTXC.DL_TXOP_Prep
                              AND nptxop.t_ID <> v_nptxop.t_ID
                              AND nptxop.t_Recalc = CHR(0)
                            ORDER BY nptxop.t_OperDate DESC, nptxop.t_ID DESC
                          )
           LOOP
             v_Technical := one_rec.IsTech;

             EXIT;
           END LOOP;
         END IF;
       END IF;
        -- Если в опеации не установлен флаг пересчет, то признак "Технический расчет" определяем из параметра pTechnical
     ELSE 
        IF pTechnical = 1
        THEN v_Technical := CHR(88);
        ELSE v_Technical := CHR(0);
        END IF;
     END IF;
     
     return v_Technical;
  END;
  
  /**
  @brief Существует более ранняя операция расчета НОБ с категорией "Признак технического расчета" = "Технический"
  @param [in] pOperDate Дата текущей операции
  @param [in] pClientID ID клиента
  @return 1 - да
  @return 0 - нет
  */
  FUNCTION IsExistEarlyNPTXOPTech(pOperDate DATE, pClientID NUMBER) RETURN NUMBER
  IS
     v_Exist NUMBER := 0;
  BEGIN
     SELECT 1 INTO v_Exist
     FROM DNPTXOP_DBT nptxop
     WHERE nptxop.t_Client = pClientID
       AND nptxop.t_DocKind = RSI_NPTXC.DL_CALCNDFL
       AND nptxop.t_Kind_Operation = 2035
       AND nptxop.t_OperDate <= pOperDate
       AND EXTRACT(YEAR FROM nptxop.t_OperDate) = EXTRACT(YEAR FROM pOperDate)
       AND RSB_SECUR.GetMainObjAttr(132 /*OBJTYPE_NPTXCALC*/, LPAD(nptxop.t_ID, 34, '0'), 1, nptxop.t_OperDate) = 1
       AND EXISTS(
                    SELECT 1
                    FROM DNPTXOBDC_DBT obdc
                    WHERE obdc.t_DocID = nptxop.t_ID
                 )
       AND ROWNUM  = 1;
       
     RETURN v_Exist;
  EXCEPTION
     WHEN NO_DATA_FOUND
     THEN RETURN 0;
  END;
  
  /**
  @brief Удаление объектов НДР с установленным признаком "Технический"
  @param [in] pDocID ID текущей операции
  @param [in] pOperDate Дата текущей операии
  @param [in] pCLientID ID клиента
  @param [in] pKind Вид объектов НДР
  @param [in] pAnaliticKind1 Вид аналитики 1
  @param [in] pAnalitic1 Значение аналитики 1
  @param [in] pAnaliticKind2 Вид аналитики 2
  @param [in] pAnalitic2 Значение аналитики 2
  @param [in] pAnaliticKind3 Вид аналитики 3
  @param [in] pAnalitic3 Значение аналитики 3
  @param [in] pAnaliticKind4 Вид аналитики 4
  @param [in] pAnalitic4 Значение аналитики 4
  @param [in] pAnaliticKind5 Вид аналитики 5
  @param [in] pAnalitic5 Значение аналитики 5
  @param [in] pAnaliticKind6 Вид аналитики 6
  @param [in] pAnalitic6 Значение аналитики 6
  @param [in] pExistEarlyNPTXOPTech Существует более ранняя операция расчета НОБ с категорией "Признак технического расчета" = "Технический"
  @param [in] pTechnical Значение категории "Признак технического расчета" на операции
  @param [in] pRecalc Значение признака "Пеесчет" из панели текущей операции
  */
  PROCEDURE DeleteNPTXOBJTech(pDocID NUMBER,
                              pStep NUMBER,
                              pOperDate DATE,
                              pCLientID NUMBER,
                              pKind NUMBER,
                              pAnaliticKind1 NUMBER,
                              pAnalitic1 NUMBER,
                              pAnaliticKind2 NUMBER,
                              pAnalitic2 NUMBER,
                              pAnaliticKind3 NUMBER,
                              pAnalitic3 NUMBER,
                              pAnaliticKind4 NUMBER,
                              pAnalitic4 NUMBER,
                              pAnaliticKind5 NUMBER,
                              pAnalitic5 NUMBER,
                              pAnaliticKind6 NUMBER,
                              pAnalitic6 NUMBER,
                              pExistEarlyNPTXOPTech NUMBER,
                              pRecalc CHAR,
                              pOutSystCode VARCHAR2 DEFAULT CHR(1),
                              pTransfKind NUMBER DEFAULT 0,
                              pHolding_Period IN NUMBER DEFAULT 0
                             )
  IS

     TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
     nptxobj     dnptxobj_tmp%rowtype;
     nptxobj_ins nptxobj_t := nptxobj_t();
  
  BEGIN
     /*если (операция имеет категорию ?Признак технического расчета? = Технический ИЛИ операция имеет категорию ?Признак технического расчета? = НЕТ) И существует более ранняя в этом же налоговом
       периоде операция расчета НОБ с категорией ?Признак технического расчета? = Технический*/
     IF (pRecalc IS NULL or pRecalc <> 'X') AND pExistEarlyNPTXOPTech = 1
     THEN
        FOR CurObj IN (SELECT nptxobj.t_ObjID
                         FROM DNPTXOBJ_DBT nptxobj
                        WHERE nptxobj.t_Client = pClientID
                          AND nptxobj.t_Kind = pKind
                          AND nptxobj.t_AnaliticKind1 = pAnaliticKind1
                          AND nptxobj.t_Analitic1 = pAnalitic1
                          AND nptxobj.t_AnaliticKind2 = pAnaliticKind2
                          AND nptxobj.t_Analitic2 = pAnalitic2
                          AND nptxobj.t_AnaliticKind3 = pAnaliticKind3
                          AND nptxobj.t_Analitic3 = pAnalitic3
                          AND nptxobj.t_AnaliticKind4 = pAnaliticKind4
                          AND nptxobj.t_Analitic4 = pAnalitic4
                          AND nptxobj.t_AnaliticKind5 = pAnaliticKind5
                          AND nptxobj.t_Analitic5 = pAnalitic5
                          AND nptxobj.t_AnaliticKind6 = pAnaliticKind6
                          AND nptxobj.t_Analitic6 = pAnalitic6
                          AND nptxobj.t_TransfKind = pTransfKind
                          AND nptxobj.t_Date <= pOperDate
                          AND EXTRACT(YEAR FROM nptxobj.t_Date) = EXTRACT(YEAR FROM pOperDate)
                          AND nptxobj.t_OutSystCode = (CASE WHEN pOutSystCode IS NULL OR pOutSystCode = CHR(1) THEN nptxobj.t_OutSystCode ELSE pOutSystCode END)
                          AND nptxobj.t_TransfKind = (CASE WHEN pTransfKind IS NULL OR pTransfKind = 0 THEN nptxobj.t_TransfKind ELSE pTransfKind END)
                          AND nptxobj.t_Holding_Period = (CASE WHEN pHolding_Period IS NULL OR pHolding_Period = 0 THEN nptxobj.t_Holding_Period ELSE pHolding_Period END)
                          AND nptxobj.t_Technical = 'X'
                          AND NOT EXISTS(SELECT 1 FROM DNPTXOBJ_TMP TMP WHERE TMP.t_RealObjID = nptxobj.t_ObjID AND TMP.t_Action = RSI_NPTXC.NPTXBC_ACTION_DELETE)
                      )
        LOOP
           
           InitNPTXOBJ(nptxobj);

           nptxobj.T_DOCID      := pDocID;
           nptxobj.T_STEP       := pStep;
           nptxobj.T_ACTION     := RSI_NPTXC.NPTXBC_ACTION_DELETE;
           nptxobj.T_REALOBJID  := CurObj.T_OBJID;   

           nptxobj_ins.extend;
           nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
           
        END LOOP;

        IF nptxobj_ins.COUNT > 0 THEN
          FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
               INSERT INTO DNPTXOBJ_TMP
                    VALUES nptxobj_ins(indx);

          nptxobj_ins.Delete;
        END IF;
     END IF;
  END;
  
  /**
  @brief Получение суммы объектов НДР с признаком "Технический", которые были созданы ранее даты текущей операции
  @param [in] pDocID ID текущей операции
  @param [in] pOperDate Дата текущей операции
  @param [in] pClientID ID клиента
  @param [in] pKind Вид объектов НДР
  @param [in] pAnaliticKind1 Вид аналитики 1
  @param [in] pAnalitic1 Значение аналитики 1
  @param [in] pAnaliticKind2 Вид аналитики 2
  @param [in] pAnalitic2 Значение аналитики 2
  @param [in] pAnaliticKind3 Вид аналитики 3
  @param [in] pAnalitic3 Значение аналитики 3
  @param [in] pAnaliticKind4 Вид аналитики 4
  @param [in] pAnalitic4 Значение аналитики 4
  @param [in] pAnaliticKind5 Вид аналитики 5
  @param [in] pAnalitic5 Значение аналитики 5
  @param [in] pAnaliticKind6 Вид аналитики 6
  @param [in] pAnalitic6 Значение аналитики 6
  @param [in] pExistEarlyNPTXOPTech Существуют операции расчета НОБ с категорией "Признак технического расчета" = "Технический"
  @param [in] pTechnical Значение категории "Признак технического расчета" для текущей операции
  @param [in] pRecalc Значение признака "Пересчет" из панели текущей операции
  @param [in] pTransfKind Значение признака трансформации
  @return NUMBER
  */
  FUNCTION GetSumNPTXOBJTech(pDocID NUMBER,
                             pOperDate DATE,
                             pCLientID NUMBER,
                             pKind NUMBER,
                             pAnaliticKind1 NUMBER,
                             pAnalitic1 NUMBER,
                             pAnaliticKind2 NUMBER,
                             pAnalitic2 NUMBER,
                             pAnaliticKind3 NUMBER,
                             pAnalitic3 NUMBER,
                             pAnaliticKind4 NUMBER,
                             pAnalitic4 NUMBER,
                             pAnaliticKind5 NUMBER,
                             pAnalitic5 NUMBER,
                             pAnaliticKind6 NUMBER,
                             pAnalitic6 NUMBER,
                             pExistEarlyNPTXOPTech NUMBER,
                             pRecalc CHAR,
                             pOutSystCode VARCHAR2 DEFAULT CHR(1),
                             pTransfKind NUMBER DEFAULT 0,
                             pHolding_Period IN NUMBER DEFAULT 0
                            ) RETURN NUMBER
  IS
     v_Sum NUMBER := 0;
  BEGIN
     /*если (операция имеет категорию ?Признак технического расчета? = Технический ИЛИ операция имеет категорию ?Признак технического расчета? = НЕТ) И существует более ранняя в этом же налоговом
       периоде операция расчета НОБ с категорией ?Признак технического расчета? = Технический*/
     IF (pRecalc IS NULL or pRecalc <> 'X') AND pExistEarlyNPTXOPTech = 1
     THEN
        -- к сумме полученного НДР прибавляем сумму НДР с признаком "Технического расчет" = ДА;
        SELECT NVL(SUM(nptxobj.t_Sum), 0) INTO v_Sum
        FROM DNPTXOBJ_DBT nptxobj
        WHERE nptxobj.t_Client = pClientID
          AND nptxobj.t_Kind = pKind
          AND nptxobj.t_AnaliticKind1 = pAnaliticKind1
          AND nptxobj.t_Analitic1 = pAnalitic1
          AND nptxobj.t_AnaliticKind2 = pAnaliticKind2
          AND nptxobj.t_Analitic2 = pAnalitic2
          AND nptxobj.t_AnaliticKind3 = pAnaliticKind3
          AND nptxobj.t_Analitic3 = pAnalitic3
          AND nptxobj.t_AnaliticKind4 = pAnaliticKind4
          AND nptxobj.t_Analitic4 = pAnalitic4
          AND nptxobj.t_AnaliticKind5 = pAnaliticKind5
          AND nptxobj.t_Analitic5 = pAnalitic5
          AND nptxobj.t_AnaliticKind6 = pAnaliticKind6
          AND nptxobj.t_Analitic6 = pAnalitic6
          AND nptxobj.t_Date <= pOperDate
          AND EXTRACT(YEAR FROM nptxobj.t_Date) = EXTRACT(YEAR FROM pOperDate)
          AND nptxobj.t_OutSystCode = (CASE WHEN pOutSystCode IS NULL OR pOutSystCode = CHR(1) THEN nptxobj.t_OutSystCode ELSE pOutSystCode END)
          AND nptxobj.t_TransfKind = (CASE WHEN pTransfKind IS NULL OR pTransfKind = 0 THEN nptxobj.t_TransfKind ELSE pTransfKind END)
          AND nptxobj.t_Holding_Period = (CASE WHEN pHolding_Period IS NULL OR pHolding_Period = 0 THEN nptxobj.t_Holding_Period ELSE pHolding_Period END)
          AND nptxobj.t_Technical = 'X'
          AND NOT EXISTS(SELECT 1 FROM DNPTXOBJ_TMP TMP WHERE TMP.t_RealObjID = nptxobj.t_ObjID AND TMP.t_Action = RSI_NPTXC.NPTXBC_ACTION_DELETE);
     END IF;
       
     RETURN v_Sum;
  EXCEPTION
     WHEN NO_DATA_FOUND
     THEN RETURN 0;
  END;

  --Расчет объектов НДР по оплате основной суммы сделки и НКД
  PROCEDURE CreateTaxObjects1_1(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

    v_Amount NUMBER;
    v_NKD    NUMBER;

  BEGIN

    pStat := 0;

    FOR one_rec IN (WITH sf AS (SELECT t_ID, t_PartyID 
                                  FROM dsfcontr_dbt 
                                 WHERE t_PartyID = pClient 
                                   AND t_ServKind = RSI_NPTO.PTSK_STOCKDL
                                   AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS
                                   AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))  
                               )
                    SELECT RQ.t_FactDate RQDate,
                           Opr.IsBuy,
                           Leg.t_CFI,
                           Tick.t_DealID,
                           Tick.t_DealDate,
                           Leg.t_PFI,
                           Leg.t_NKDFIID,
                           Leg.t_Principal,
                           Leg.t_NKD,
                           RQ.t_Amount,
                           Fin.t_FaceValueFI,
                           RQ.t_FactDate,
                           RQ.t_DealPart,
                           Tick.t_ClientID,
                           Tick.t_ClientContrID,
                           Tick.t_IsPartyClient,
                           Tick.t_PartyContrID,
                           Opr.IsRepo
                      FROM ddlrq_dbt RQ,
                           sf,
                           ddl_tick_dbt Tick,
                           ddl_leg_dbt Leg,
                           dfininstr_dbt Fin,
                           (SELECT t_Kind_Operation, 
                                   Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(t_SysTypes)) IsRepo,
                                   Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(t_SysTypes)) IsBuy
                              FROM doprkoper_dbt
                             WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC) Opr
                     WHERE     RQ.t_DocKind  = RSB_SECUR.DL_SECURITYDOC
                       AND RQ.t_State    = RSI_DLRQ.DLRQ_STATE_EXEC
                       AND RQ.t_SubKind  = RSI_DLRQ.DLRQ_SUBKIND_CURRENCY
                       AND RQ.t_Type     = RSI_DLRQ.DLRQ_TYPE_PAYMENT 
                       AND RQ.t_DealPart IN (1, 2)
                       AND RQ.t_FactDate >= pBegDate
                       AND RQ.t_FactDate <= pEndDate
                       AND Tick.t_DealID = RQ.t_DocID
                       AND (   (    Tick.t_ClientID = sf.t_PartyID
                                AND Tick.t_ClientContrID = sf.t_ID)
                            OR (    Tick.t_PartyID = sf.t_PartyID
                                AND Tick.t_IsPartyClient = 'X'
                                AND Tick.t_PartyContrID = sf.t_ID)
                           )
                       AND Opr.t_Kind_Operation = Tick.t_DealType
                       AND Leg.t_DealID  = Tick.t_DealID
                       AND Leg.t_LegID   = 0
                       AND Leg.t_LegKind = (CASE WHEN RQ.t_DealPart = 1 THEN 0 ELSE 2 END)
                       AND Leg.t_PFI     = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)
                       AND Fin.t_FIID    = Leg.t_PFI
                   )
    LOOP

      CalcAmountOrNKD (one_rec.t_Amount,
                       one_rec.t_NKD,
                       one_rec.t_CFI,
                       one_rec.t_NKDFIID,
                       one_rec.t_DealDate,   --DEF-110511 Конвертируем на дату заключения сделки
                       one_rec.IsRepo,
                       one_rec.t_FaceValueFI,
                       one_rec.t_PFI,
                       one_rec.t_Principal,
                       v_Amount,
                       v_NKD);
 
      IF v_Amount <> 0 OR v_NKD <> 0 THEN
        v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate); 
        v_TaxGroup := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);
      END IF;

      IF v_Amount <> 0 THEN

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.RQDate;   
        nptxobj.T_CLIENT         := pCLient;
        nptxobj.T_DIRECTION      := GetDir(pClient, one_rec.t_ClientID, one_rec.t_DealPart, one_rec.IsBuy);        
        nptxobj.T_LEVEL          := 1;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_MAIN;                              
        nptxobj.T_SUM            := v_Amount;                                                 
        nptxobj.T_CUR            := one_rec.t_CFI;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
        nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END);                                            
        nptxobj.T_COMMENT        := 'Оплата основной суммы сделки';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      END IF;

      IF v_NKD <> 0 THEN

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.RQDate;   
        nptxobj.T_CLIENT         := pCLient;
        nptxobj.T_DIRECTION      := GetDir(pClient, one_rec.t_ClientID, one_rec.t_DealPart, one_rec.IsBuy);        
        nptxobj.T_LEVEL          := 1;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_NKD;                              
        nptxobj.T_SUM            := v_NKD;                                                 
        nptxobj.T_CUR            := one_rec.t_FaceValueFI;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
        nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END);                                            
        nptxobj.T_COMMENT        := 'НКД по сделке';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep;
        nptxobj.T_TECHNICAL      := CHR(0);
        nptxobj.T_CONVDATE       := one_rec.t_DealDate; --DEF-110511 для рублевой суммы берем курс на дату заключения сделки (для совпадения суммы НКД с биржевым файлом сделок)

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      END IF;


      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END; --CreateTaxObjects1_1

  --Расчет объектов НДР по авансу/задатку
  PROCEDURE CreateTaxObjects1_2(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

  BEGIN

    pStat := 0;

    FOR one_rec IN (WITH sf AS (SELECT t_ID, t_PartyID 
                                  FROM dsfcontr_dbt 
                                 WHERE t_PartyID = pClient 
                                   AND t_ServKind = RSI_NPTO.PTSK_STOCKDL
                                   AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS
                                   AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                               )
                    SELECT RQ.t_FactDate RQDate,
                           Opr.IsBuy,
                           Leg.t_CFI,
                           Tick.t_DealID,
                           Leg.t_PFI,
                           Leg.t_NKDFIID,
                           Leg.t_Principal,
                           Leg.t_NKD,
                           RQ.t_Amount,
                           Fin.t_FaceValueFI,
                           RQ.t_FactDate,
                           RQ.t_DealPart,
                           Tick.t_ClientID,
                           Tick.t_ClientContrID,
                           Tick.t_IsPartyClient,
                           Tick.t_PartyContrID,
                           Tick.t_DealDate,
                           RQ.t_Type
                      FROM ddlrq_dbt RQ, sf,
                           ddl_tick_dbt Tick,
                           ddl_leg_dbt Leg,
                           dfininstr_dbt Fin,
                           (SELECT t_Kind_Operation, Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(t_SysTypes)) IsBuy
                              FROM doprkoper_dbt
                             WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC) Opr
                     WHERE     RQ.t_DocKind  = RSB_SECUR.DL_SECURITYDOC
                           AND RQ.t_State    = RSI_DLRQ.DLRQ_STATE_EXEC
                           AND RQ.t_SubKind  = RSI_DLRQ.DLRQ_SUBKIND_CURRENCY
                           AND RQ.t_Type     IN (RSI_DLRQ.DLRQ_TYPE_AVANCE, RSI_DLRQ.DLRQ_TYPE_DEPOSIT) 
                           AND RQ.t_DealPart IN (1, 2)
                           AND RQ.t_FactDate >= pBegDate
                           AND RQ.t_FactDate <= pEndDate
                           AND Tick.t_DealID = RQ.t_DocID
                           AND (   (    Tick.t_ClientID = sf.t_PartyID
                                    AND Tick.t_ClientContrID = sf.t_ID)
                                OR (    Tick.t_PartyID = sf.t_PartyID
                                    AND Tick.t_IsPartyClient = 'X'
                                    AND Tick.t_PartyContrID = sf.t_ID)
                               )
                           AND Opr.t_Kind_Operation = Tick.t_DealType
                           AND Leg.t_DealID  = Tick.t_DealID
                           AND Leg.t_LegID   = 0
                           AND Leg.t_LegKind = DECODE (RQ.t_DealPart, 1, 0, 2)
                           AND Leg.t_PFI     = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)
                           AND Fin.t_FIID    = Leg.t_PFI
                   )
    LOOP

      InitNPTXOBJ(nptxobj);

      v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate); 
      v_TaxGroup := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

      nptxobj.T_FUNCTIONKIND   := 1;
      nptxobj.T_DATE           := one_rec.RQDate;   
      nptxobj.T_CLIENT         := pCLient;
      nptxobj.T_DIRECTION      := GetDir(pClient, one_rec.t_ClientID, one_rec.t_DealPart, one_rec.IsBuy);        
      nptxobj.T_LEVEL          := 1;
      nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_MAIN;                              
      nptxobj.T_SUM            := one_rec.t_Amount;                                                 
      nptxobj.T_CUR            := one_rec.t_CFI;                                
      nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
      nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
      nptxobj.T_ANALITICKIND2  := 0;                    
      nptxobj.T_ANALITIC2      := -1;                                          
      nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
      nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
      nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
      nptxobj.T_ANALITIC4      := v_Circulate;                                     
      nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
      nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
      nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
      nptxobj.T_ANALITIC6      := (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END);                                            
      nptxobj.T_COMMENT        := (CASE WHEN one_rec.t_Type = RSI_DLRQ.DLRQ_TYPE_AVANCE THEN 'Аванс' ELSE 'Задаток' END);      
      nptxobj.T_DOCID          := pDocID;
      nptxobj.T_STEP           := pStep; 
      nptxobj.T_TECHNICAL      := CHR(0);

      nptxobj_ins.extend;
      nptxobj_ins(nptxobj_ins.LAST) := nptxobj;


      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END; --CreateTaxObjects1_2

  --Расчет объектов НДР по комиссиям
  PROCEDURE CreateTaxObjects1_3(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

  BEGIN

    pStat := 0;

    FOR one_rec IN (WITH sf AS (SELECT t_ID, t_PartyID 
                                  FROM dsfcontr_dbt 
                                 WHERE t_PartyID = pClient 
                                   AND t_ServKind = RSI_NPTO.PTSK_STOCKDL
                                   AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS
                                   AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                               )
                    SELECT Comis.t_FactPayDate, Comis.t_Sum AllSum, M.T_FIID_COMM Currency,
                           Comis.T_DocKind, 
                           Comis.T_DocID, 
                           Comis.T_Contract, 
                           Comis.T_PLANPAYDATE,
                           Tick.t_DealID, Leg.t_PFI, Tick.t_DealDate, 
                           Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID, Tick.t_PartyID as TickPartyID
                      FROM DNPTXCOMM_TMP Comis, sf, ddl_tick_dbt Tick, ddl_leg_dbt Leg, DSFCOMISS_DBT M 
                     WHERE Comis.t_DocKind      = RSB_SECUR.DL_SECURITYDOC
                       AND Comis.t_FactPayDate >= pBegDate
                       AND Comis.t_FactPayDate <= pEndDate
                       AND Comis.T_Contract     = sf.T_ID
                       AND Tick.t_DealID        = Comis.t_DocID 
                       AND ((Tick.t_ClientID = sf.T_PARTYID) OR 
                            (Tick.t_IsPartyClient = 'X' AND Tick.t_PartyID = sf.T_PARTYID))
                       AND Leg.t_DealID  = Tick.t_DealID 
                       AND Leg.t_LegID   = 0 
                       AND Leg.t_LegKind = 0
                       AND Leg.t_PFI     = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END) 
                       AND M.T_FEETYPE = Comis.T_FEETYPE   
                       AND M.T_NUMBER  = Comis.T_COMNUMBER
                   )
    LOOP

      IF TaxDepositoryMode <> 0 OR
         0 = rsb_secur.CheckExistGrDealByCom(one_rec.T_DocKind, 
                                             one_rec.T_DocID, 
                                             one_rec.T_Contract, 
                                             one_rec.T_PLANPAYDATE, 
                                             RSI_DLGR.DLGRACC_STATE_PLAN,
                                             (CASE WHEN one_rec.t_IsPartyClient = 'X' AND pClient = one_rec.TickPartyID THEN RSI_DLGR.DLGR_TEMPL_PAYCOMCONTR 
                                                   ELSE RSI_DLGR.DLGR_TEMPL_PAYCOM END)
                                            )
      THEN
        v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
        v_TaxGroup := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_FactPayDate;   
        nptxobj.T_CLIENT         := pCLient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
        nptxobj.T_LEVEL          := 1;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_COM;                              
        nptxobj.T_SUM            := one_rec.AllSum;                                                 
        nptxobj.T_CUR            := one_rec.Currency;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
        nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END);                                            
        nptxobj.T_COMMENT        := 'Комиссия по сделке';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;
  END;
    

  --Расчет объектов НДР по комиссиям
  PROCEDURE CreateTaxObjects1_4(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

  BEGIN

    pStat := 0;

    FOR one_rec IN (SELECT DefCom.t_DatePay, BasObj.t_CommSum AllSum, DefCom.t_FIID_commSum Currency,
                           Tick.t_DealID, Leg.t_PFI, Tick.t_DealDate, 
                           Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID 
                      FROM dsfbasobj_dbt BasObj, dsfdefcom_dbt DefCom, ddl_tick_dbt Tick, ddl_leg_dbt Leg, dsfcomiss_dbt comiss, DSFCONTR_DBT Contr 
                     WHERE Tick.t_DealID = BasObj.t_BaseObjectID 
                       AND Tick.t_BOfficeKind = BasObj.t_BaseObjectType 
                       AND Leg.t_DealID = Tick.t_DealID 
                       AND Leg.t_LegID = 0 
                       AND Leg.t_LegKind = 0 
                       AND Leg.t_PFI     = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END) 
                       AND DefCom.t_ID = BasObj.t_DefCommID 
                       AND DefCom.t_DatePay >= pBegDate 
                       AND DefCom.t_DatePay <= pEndDate 
                       AND DefCom.t_ConID = Contr.T_ID 
                       AND BasObj.t_AccountedInIncluded <> 1 
                       AND comiss.t_feeType = DefCom.t_feeType 
                       AND comiss.t_number  = DefCom.t_commNumber 
                       AND comiss.t_FormAlg = 2 /*SFCOMISS_FORMALG_MANUAL*/
                       AND comiss.t_feeType = 1 /*SF_FEE_TYPE_PERIOD*/
                       AND ((Tick.t_ClientID = pClient AND Contr.T_ID = Tick.t_ClientContrID 
                             AND ((pContract IS NULL) OR (pContract <= 0) OR (Tick.t_ClientContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                            ) OR 
                            (Tick.t_PartyID = pClient AND Tick.t_IsPartyClient = 'X' AND Contr.T_ID = Tick.t_PartyContrID 
                             AND ((pContract IS NULL) OR (pContract <= 0) OR (Tick.t_PartyContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                            ))
                       AND RSI_NPTO.CheckContrIIS(Contr.T_ID)  = pIIS 
                       AND Tick.t_BOfficeKind = RSB_SECUR.DL_SECURITYDOC
                   )
    LOOP

      v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
      v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

      InitNPTXOBJ(nptxobj);

      nptxobj.T_FUNCTIONKIND   := 1;
      nptxobj.T_DATE           := one_rec.t_DatePay;   
      nptxobj.T_CLIENT         := pCLient;
      nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
      nptxobj.T_LEVEL          := 1;
      nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_COM;                              
      nptxobj.T_SUM            := one_rec.AllSum;                                                 
      nptxobj.T_CUR            := one_rec.Currency;                                
      nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
      nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
      nptxobj.T_ANALITICKIND2  := 0;                    
      nptxobj.T_ANALITIC2      := -1;                                          
      nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
      nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
      nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
      nptxobj.T_ANALITIC4      := v_Circulate;                                     
      nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
      nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
      nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
      nptxobj.T_ANALITIC6      := (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END);                                            
      nptxobj.T_COMMENT        := 'Комиссия по сделке';      
      nptxobj.T_DOCID          := pDocID;
      nptxobj.T_STEP           := pStep; 
      nptxobj.T_TECHNICAL      := CHR(0);

      nptxobj_ins.extend;
      nptxobj_ins(nptxobj_ins.LAST) := nptxobj;


      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по депозитарным комиссиям
  PROCEDURE CreateTaxObjects1_5(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

  BEGIN

    pStat := 0;

    IF pIIS = 0 THEN

      FOR one_rec IN (SELECT sfdef.t_DatePay, 
                             (CASE WHEN sfdef.t_ID_Operation = 0 THEN (SELECT bobj.t_CommSum 
                                                                         FROM dsfbasobj_dbt bobj 
                                                                        WHERE bobj.t_DefCommID = sfdef.t_ID 
                                                                          AND bobj.t_BaseObjectType = RSB_SECUR.OBJTYPE_OPERATIONDEPO
                                                                          AND bobj.t_BaseObjectID = TO_CHAR(draft.t_AutoKey)
                                                                       )
                                   ELSE (sfdef.t_Sum + sfdef.t_SumNDS) END ) AS AllSum, 
                             (CASE WHEN sfdef.t_ID_Operation = 0 THEN (SELECT bobj.t_FIID 
                                                                         FROM dsfbasobj_dbt bobj 
                                                                        WHERE bobj.t_DefCommID = sfdef.t_ID 
                                                                          AND bobj.t_BaseObjectType = RSB_SECUR.OBJTYPE_OPERATIONDEPO
                                                                          AND bobj.t_BaseObjectID = TO_CHAR(draft.t_AutoKey)
                                                                       )
                                   ELSE sfdef.t_FIID_Sum END ) AS Currency, 
                             Tick.t_DealID, Leg.t_PFI, Tick.t_DealDate 
                        FROM ddlrq_dbt RQ, ddl_tick_dbt Tick, dspdrprop_dbt spdrprop, dspdraft_dbt draft, doproper_dbt opr, dsfdef_dbt sfdef, ddl_leg_dbt Leg, DSFCONTR_DBT Contr 
                       WHERE RQ.t_DocKind    = RSB_SECUR.DL_SECURITYDOC
                         AND RQ.t_SubKind    = RSI_DLRQ.DLRQ_SUBKIND_AVOIRISS
                         AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_DELIVERY
                         AND RQ.t_DealPart   = 1 
                         AND Tick.t_DealID   = RQ.t_DocID  
                         AND ((Tick.t_ClientID = pClient AND Contr.T_PARTYID = Tick.t_ClientID) OR 
                              (Tick.t_PartyID = pClient AND Tick.t_IsPartyClient = 'X' AND Contr.T_PARTYID = Tick.t_PartyID)) 
                         AND spdrprop.t_PaymentID = RQ.t_ID 
                         AND spdrprop.t_DocumentKind = Tick.t_BOfficeKind 
                         AND spdrprop.t_DocumentID = Tick.t_DealID 
                         AND draft.t_AutoKey = spdrprop.t_DraftID 
                         AND opr.t_DocKind = draft.t_Kind 
                         AND opr.t_DocumentID = TO_CHAR(draft.t_AutoKey)
                         AND (    sfdef.t_ID_Operation = opr.t_ID_Operation 
                               OR (sfdef.t_ID_Operation = 0 AND EXISTS(SELECT 1 FROM dsfbasobj_dbt bobj 
                                                                        WHERE bobj.t_DefCommID = sfdef.t_ID 
                                                                          AND bobj.t_BaseObjectType = RSB_SECUR.OBJTYPE_OPERATIONDEPO
                                                                          AND bobj.t_BaseObjectID = TO_CHAR(draft.t_AutoKey)))
                             )
                         AND sfdef.t_DatePay >= pBegDate 
                         AND sfdef.t_DatePay <= pEndDate 
                         AND sfdef.t_SfContrID = Contr.T_ID 
                         AND ((pContract IS NULL) OR (pContract <= 0) OR (Contr.t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                         AND Leg.t_DealID = Tick.t_DealID  
                         AND Leg.t_LegID   = 0  
                         AND Leg.t_LegKind = 0
                         AND Leg.t_PFI     = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)
                     )
      LOOP

        v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
        v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_DatePay;   
        nptxobj.T_CLIENT         := pCLient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
        nptxobj.T_LEVEL          := 1;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_COM;                              
        nptxobj.T_SUM            := one_rec.AllSum;                                                 
        nptxobj.T_CUR            := one_rec.Currency;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
        nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := 0;                    
        nptxobj.T_ANALITIC6      := -1;                                            
        nptxobj.T_COMMENT        := 'Комиссия по сделке';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;


        IF nptxobj_ins.COUNT >= g_Limit THEN
          FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
               INSERT INTO DNPTXOBJ_TMP
                    VALUES nptxobj_ins(indx);

          nptxobj_ins.Delete;
          nptxobj_ins := nptxobj_t();
        END IF;

      END LOOP;

      IF nptxobj_ins.COUNT > 0 THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
      END IF;
    END IF;

  END;

  FUNCTION GetFaceValue_Ex(p_FIID IN NUMBER, p_ValueDate IN DATE) RETURN NUMBER RESULT_CACHE RELIES_ON(DFIVLHIST_DBT, DFININSTR_DBT, DAVOIRISS_DBT, DFIWARNTS_DBT)
  AS
    v_FaceValue NUMBER := 0;
  BEGIN
    v_FaceValue := RSI_RSB_FIInstr.FI_GetNominalOnDate(p_FIID, p_ValueDate);

    IF v_FaceValue = 0 THEN
      v_FaceValue := 1;
    END IF;

    RETURN v_FaceValue;
  END;

  FUNCTION KN(p_FIID IN NUMBER, p_ValueDate IN DATE) RETURN NUMBER RESULT_CACHE RELIES_ON(DFIVLHIST_DBT, DFININSTR_DBT, DAVOIRISS_DBT, DFIWARNTS_DBT)
  AS
    v_RetVal      NUMBER := 0;

    v_FI_Kind     NUMBER;
    v_AvoirKind   NUMBER;
  BEGIN
     
    SELECT t_FI_Kind, t_AvoirKind
      INTO v_FI_Kind, v_AvoirKind
      FROM dfininstr_dbt
     WHERE t_FIID = p_FIID;

    IF RSI_RSB_FIInstr.FI_AvrKindsGetRoot(v_FI_Kind, v_AvoirKind) = RSI_RSB_FIInstr.AVOIRKIND_BOND THEN
      v_RetVal := GetFaceValue_Ex(p_FIID, p_ValueDate) / 100.0;
    ELSE
      v_RetVal := 1;
    END IF;

    RETURN v_RetVal;
  END;

  FUNCTION PrDeal(p_DocKind       IN NUMBER,
                  p_DocID         IN NUMBER,
                  p_FIID          IN NUMBER,
                  p_CFI           IN NUMBER,
                  p_LegPrice      IN NUMBER,
                  p_DealDate      IN DATE,
                  p_FactDate      IN DATE,
                  p_RelativePrice IN NUMBER
                 ) RETURN NUMBER
  AS
    v_RetVal      NUMBER := 0;
    v_KN          NUMBER := 0;

    v_FaceValueFI NUMBER;
    v_IsBond      NUMBER;
  BEGIN

    SELECT t_FaceValueFI, DECODE(RSI_RSB_FIInstr.FI_AvrKindsGetRoot(t_FI_Kind, t_AvoirKind), RSI_RSB_FIInstr.AVOIRKIND_BOND, 1, 0)
      INTO v_FaceValueFI, v_IsBond
      FROM dfininstr_dbt
     WHERE t_FIID = p_FIID;

    v_RetVal := p_LegPrice;

    IF p_DocKind = RSB_SECUR.DL_AVRWRT THEN
      IF v_IsBond = 0 AND v_FaceValueFI != p_CFI THEN
        v_RetVal := v_RetVal * K(p_CFI, p_DealDate) / K(v_FaceValueFI, p_DealDate);
      END IF;
    ELSE
      IF v_IsBond != 0 AND p_RelativePrice != 0 THEN
        v_RetVal := v_RetVal * KN(p_FIID, p_FactDate);
      ELSIF v_FaceValueFI != p_CFI THEN
        v_RetVal := v_RetVal * K(p_CFI, p_DealDate) / K(v_FaceValueFI, p_DealDate);
      END IF;
    END IF;

    RETURN v_RetVal;
  END;

  FUNCTION GetAllSumm_6(p_DocKind        IN NUMBER,
                        p_DealID         IN NUMBER,
                        p_Principal      IN NUMBER,
                        p_PFI            IN NUMBER,
                        p_CFI            IN NUMBER,
                        p_Price          IN NUMBER,
                        p_DealDate       IN DATE,
                        p_FactDate       IN DATE,
                        p_RelativePrice  IN NUMBER,
                        p_MaxMarketPrice IN NUMBER
                       ) RETURN NUMBER
  AS
    v_AllSumm NUMBER := 0;

    v_PrDeal  NUMBER;
    v_KN      NUMBER;
  BEGIN

    v_PrDeal := PrDeal(p_DocKind, p_DealID, p_PFI, p_CFI, p_Price, p_DealDate, p_FactDate, p_RelativePrice);

    v_KN := KN(p_PFI, p_FactDate);

    IF v_PrDeal > p_MaxMarketPrice * v_KN THEN
      v_AllSumm := (p_MaxMarketPrice * v_KN - v_PrDeal) * p_Principal;
    END IF;

    RETURN v_AllSumm;
  END;

  PROCEDURE CreateTaxObjects1_6(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

    v_Sum NUMBER;
    v_Market VARCHAR2(100);
    v_MaxMarketPrice NUMBER;
    v_FactDate DATE;

  BEGIN

    pStat := 0;

    FOR one_rec IN (WITH sf AS (SELECT t_ID, t_PartyID 
                                  FROM dsfcontr_dbt 
                                 WHERE t_PartyID = pClient 
                                   AND t_ServKind = RSI_NPTO.PTSK_STOCKDL
                                   AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS
                                   AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                               )
                    SELECT /*+LEADING(Tick)*/ RQ.t_FactDate RQDate, 
                           RQ.t_DocKind, Leg.t_CFI, Leg.t_PFI, Leg.t_Price, Leg.t_Principal, Leg.t_RelativePrice, 
                           Fin.t_FaceValueFI, Tick.t_DealID, Tick.t_DealDate, Tick.t_BOfficeKind,
                           Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID,   
                           Opr.IsRepo, Opr.IsLoan 
                      FROM ddlrq_dbt RQ, sf, ddl_tick_dbt Tick, ddl_leg_dbt Leg, dfininstr_dbt Fin, 
                           (SELECT t_Kind_Operation, 
                                   Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(t_SysTypes))  IsBuy,
                                   Rsb_Secur.IsSale(rsb_secur.get_OperationGroup(t_SysTypes)) IsSale,
                                   Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(t_SysTypes)) IsRepo,
                                   Rsb_Secur.IsLoan(rsb_secur.get_OperationGroup(t_SysTypes)) IsLoan
                              FROM doprkoper_dbt 
                             WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC) Opr 
                     WHERE RQ.t_DocKind    = RSB_SECUR.DL_SECURITYDOC
                       AND RQ.t_FactDate  >= pBegDate 
                       AND RQ.t_FactDate  <= pEndDate 
                       AND RQ.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC 
                       AND RQ.t_SubKind    = RSI_DLRQ.DLRQ_SUBKIND_CURRENCY
                       AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_PAYMENT
                       AND RQ.t_DealPart   = 1
                       AND Tick.t_DealID   = RQ.t_DocID 
                       AND Opr.t_Kind_Operation  = Tick.t_DealType
                       AND ((Tick.t_ClientID = sf.t_PartyID AND Opr.IsBuy = 1 AND Tick.t_ClientContrID = sf.t_ID) OR 
                            (Tick.t_PartyID = sf.t_PartyID AND Tick.t_IsPartyClient = 'X' AND Opr.IsSale = 1 AND Tick.t_PartyContrID = sf.t_ID) )
                       AND Leg.t_DealID    = Tick.t_DealID 
                       AND Leg.t_LegID     = 0 
                       AND Leg.t_LegKind   = 0 
                       AND Leg.t_PFI       = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                       AND Fin.t_FIID      = Leg.t_PFI 
                      
                   )
    LOOP

      IF (one_rec.IsRepo = 0 AND one_rec.IsLoan = 0) OR  
           RSI_NPTX.CheckCateg(RSB_SECUR.OBJTYPE_SECDEAL, 23, LPAD(one_rec.t_DealID, 34, '0'), 2)=1  --категория "Является налоговым Репо" на сделке DDL_TICK.T_DEALID задана и равна False
      THEN

        v_Market := npto.GetMaxMarket(one_rec.t_PFI, one_rec.t_DealDate, one_rec.t_DealID);

        IF UPPER(v_Market) != 'ФАКТ' THEN

          v_FactDate := GetDealRQDate(one_rec.t_BOfficeKind, one_rec.t_DealID);

          v_MaxMarketPrice := npto.GetMaxMarketPrice(one_rec.t_PFI, one_rec.t_DealDate, one_rec.t_DealID);

          v_Sum := GetAllSumm_6(one_rec.t_DocKind,        
                                one_rec.t_DealID,
                                one_rec.t_Principal, 
                                one_rec.t_PFI,
                                one_rec.t_CFI,
                                one_rec.t_Price,
                                one_rec.t_DealDate,
                                v_FactDate,
                                (CASE WHEN one_rec.t_RelativePrice = 'X' THEN 1 ELSE 0 END),
                                v_MaxMarketPrice 
                               );

          v_Sum := ROUND(v_Sum, 2);

          IF v_Sum <> 0 THEN

            v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
            v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

            InitNPTXOBJ(nptxobj);

            nptxobj.T_FUNCTIONKIND   := 1;
            nptxobj.T_DATE           := one_rec.RQDate;   
            nptxobj.T_CLIENT         := pCLient;
            nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
            nptxobj.T_LEVEL          := 1;
            nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_DIF;                              
            nptxobj.T_SUM            := v_Sum;                                                 
            nptxobj.T_CUR            := one_rec.t_FaceValueFI;                                
            nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
            nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
            nptxobj.T_ANALITICKIND2  := 0;                    
            nptxobj.T_ANALITIC2      := -1;                                          
            nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
            nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
            nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
            nptxobj.T_ANALITIC4      := v_Circulate;                                     
            nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
            nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
            nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
            nptxobj.T_ANALITIC6      := (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END);                                            
            nptxobj.T_COMMENT        := 'Корректировка сумм покупки при пересчете по рыночной цене';      
            nptxobj.T_DOCID          := pDocID;
            nptxobj.T_STEP           := pStep; 
            nptxobj.T_TECHNICAL      := CHR(0);

            nptxobj_ins.extend;
            nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

          END IF;

        END IF;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;
    
  END;

  FUNCTION GetAllSumm_7(p_DocKind        IN NUMBER,
                        p_DealID         IN NUMBER,
                        p_Principal      IN NUMBER,
                        p_PFI            IN NUMBER,
                        p_CFI            IN NUMBER,
                        p_Price          IN NUMBER,
                        p_DealDate       IN DATE,
                        p_FactDate       IN DATE,
                        p_RelativePrice  IN NUMBER,
                        p_MinMarketPrice IN NUMBER
                       ) RETURN NUMBER
  AS
    v_AllSumm NUMBER := 0;

    v_PrDeal  NUMBER;
    v_KN      NUMBER;
  BEGIN

    v_PrDeal := PrDeal(p_DocKind, p_DealID, p_PFI, p_CFI, p_Price, p_DealDate, p_FactDate, p_RelativePrice);

    v_KN := KN(p_PFI, p_FactDate);

    IF v_PrDeal < p_MinMarketPrice * v_KN THEN
      v_AllSumm := (p_MinMarketPrice * v_KN - v_PrDeal) * p_Principal;
    END IF;

    RETURN v_AllSumm;
  END;


  --Расчет объектов НДР по продажам при пересчете по рыночной цене
  PROCEDURE CreateTaxObjects1_7(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

    v_Sum NUMBER;
    v_Market VARCHAR2(100);
    v_MinMarketPrice NUMBER;
    v_FactDate DATE;

  BEGIN

    pStat := 0;

    FOR one_rec IN (WITH sf AS (SELECT t_ID, t_PartyID 
                                  FROM dsfcontr_dbt 
                                 WHERE t_PartyID = pClient 
                                   AND t_ServKind = RSI_NPTO.PTSK_STOCKDL
                                   AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS
                                   AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                               )
                    SELECT /*+LEADING(Tick)*/ RQ.t_FactDate RQDate, 
                           RQ.t_DocKind, Leg.t_CFI, Leg.t_PFI, Leg.t_Price, Leg.t_Principal, Leg.t_RelativePrice, 
                           Fin.t_FaceValueFI, Tick.t_DealID, Tick.t_DealDate, Tick.t_BOfficeKind,
                           Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID,
                           Opr.IsRepo, Opr.IsLoan
                      FROM ddlrq_dbt RQ, sf, ddl_tick_dbt Tick, ddl_leg_dbt Leg, dfininstr_dbt Fin, 
                           (SELECT t_Kind_Operation, 
                                   Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(t_SysTypes)) IsBuy,
                                   Rsb_Secur.IsSale(rsb_secur.get_OperationGroup(t_SysTypes)) IsSale,
                                   Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(t_SysTypes)) IsRepo,
                                   Rsb_Secur.IsLoan(rsb_secur.get_OperationGroup(t_SysTypes)) IsLoan 
                              FROM doprkoper_dbt WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC) Opr 
                     WHERE RQ.t_DocKind    = RSB_SECUR.DL_SECURITYDOC
                       AND RQ.t_FactDate  >= pBegDate 
                       AND RQ.t_FactDate  <= pEndDate 
                       AND RQ.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC 
                       AND RQ.t_SubKind    = RSI_DLRQ.DLRQ_SUBKIND_CURRENCY
                       AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_PAYMENT
                       AND RQ.t_DealPart   = 1 
                       AND Tick.t_DealID   = RQ.t_DocID 
                       AND ((Tick.t_ClientID = sf.t_PartyID AND Opr.IsSale = 1 AND Tick.t_ClientContrID = sf.t_ID ) OR 
                            (Tick.t_PartyID = sf.t_PartyID AND  Tick.t_IsPartyClient = 'X' AND Opr.IsBuy = 1 AND Tick.t_PartyContrID = sf.t_ID) ) 
                       AND Opr.t_Kind_Operation = Tick.t_DealType 
                       AND Leg.t_DealID         = Tick.t_DealID 
                       AND Leg.t_LegID          = 0 
                       AND Leg.t_LegKind        = 0 
                       AND Leg.t_PFI            = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                       AND Fin.t_FIID           = Leg.t_PFI 
                   )
    LOOP

      v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

      IF ((one_rec.IsRepo = 0 AND one_rec.IsLoan = 0) OR  
           RSI_NPTX.CheckCateg(RSB_SECUR.OBJTYPE_SECDEAL, 23, LPAD(one_rec.t_DealID, 34, '0'), 2)=1  --категория "Является налоговым Репо" на сделке DDL_TICK.T_DEALID задана и равна False
         ) AND 
         NOT (one_rec.IsRepo = 1 AND v_TaxGroup = RSI_NPTXC.TXGROUP_100)
      THEN

        v_Market := npto.GetMinMarket(one_rec.t_PFI, one_rec.t_DealDate, one_rec.t_DealID);

        IF UPPER(v_Market) != 'ФАКТ' THEN

          v_FactDate := GetDealRQDate(one_rec.t_BOfficeKind, one_rec.t_DealID);

          v_MinMarketPrice := npto.GetMinMarketPrice(one_rec.t_PFI, one_rec.t_DealDate, one_rec.t_DealID);

          v_Sum := GetAllSumm_7(one_rec.t_DocKind,        
                                one_rec.t_DealID,
                                one_rec.t_Principal, 
                                one_rec.t_PFI,
                                one_rec.t_CFI,
                                one_rec.t_Price,
                                one_rec.t_DealDate,
                                v_FactDate,
                                (CASE WHEN one_rec.t_RelativePrice = 'X' THEN 1 ELSE 0 END),
                                v_MinMarketPrice 
                               );

          v_Sum := ROUND(v_Sum, 2);

          IF v_Sum <> 0 THEN

            v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);

            InitNPTXOBJ(nptxobj);

            nptxobj.T_FUNCTIONKIND   := 1;
            nptxobj.T_DATE           := one_rec.RQDate;   
            nptxobj.T_CLIENT         := pCLient;
            nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
            nptxobj.T_LEVEL          := 1;
            nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_DIF;                              
            nptxobj.T_SUM            := v_Sum;                                                 
            nptxobj.T_CUR            := one_rec.t_FaceValueFI;                                
            nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
            nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
            nptxobj.T_ANALITICKIND2  := 0;                    
            nptxobj.T_ANALITIC2      := -1;                                          
            nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
            nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
            nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
            nptxobj.T_ANALITIC4      := v_Circulate;                                     
            nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
            nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
            nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
            nptxobj.T_ANALITIC6      := (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END);                                            
            nptxobj.T_COMMENT        := 'Корректировка сумм продажи при пересчете по рыночной цене';      
            nptxobj.T_DOCID          := pDocID;
            nptxobj.T_STEP           := pStep; 
            nptxobj.T_TECHNICAL      := CHR(0);

            nptxobj_ins.extend;
            nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

          END IF;

        END IF;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по платежам по процентам в Репо
  PROCEDURE CreateTaxObjects1_8(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

  BEGIN

    pStat := 0;

    FOR one_rec IN (SELECT RQ.t_FactDate, RQ.t_Amount, RQ.t_FIID, Leg.t_PFI, 
                           RQ.t_Kind, Tick.t_DealID, Tick.t_DealDate, 
                           Tick.t_ClientID, 
                           Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID   
                      FROM dsfcontr_dbt sf, ddlrq_dbt RQ, ddl_tick_dbt Tick, ddl_leg_dbt Leg, 
                           (SELECT t_Kind_Operation 
                              FROM doprkoper_dbt 
                             WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC
                               AND Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(t_SysTypes)) = 1) Opr 
                     WHERE sf.t_PartyID         = pClient
                       AND sf.t_ServKind        = RSI_NPTO.PTSK_STOCKDL
                       AND RSI_NPTO.CheckContrIIS(sf.t_ID) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (sf.t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND ( (Tick.t_ClientID = pClient AND Tick.t_ClientContrID = sf.t_ID) 
                            OR (Tick.t_PartyID = pClient AND Tick.t_IsPartyClient = 'X' AND Tick.t_PartyContrID = sf.t_ID))
                       AND RQ.t_DocKind         = RSB_SECUR.DL_SECURITYDOC
                       AND RQ.t_DocID           = Tick.t_DealID
                       AND RQ.t_FactDate       >= pBegDate
                       AND RQ.t_FactDate       <= pEndDate
                       AND RQ.t_State           = RSI_DLRQ.DLRQ_STATE_EXEC
                       AND RQ.t_SubKind         = RSI_DLRQ.DLRQ_SUBKIND_CURRENCY
                       AND RQ.t_Type            = RSI_DLRQ.DLRQ_TYPE_INCREPO
                       AND Opr.t_Kind_Operation = Tick.t_DealType 
                       AND Leg.t_DealID         = Tick.t_DealID 
                       AND Leg.t_LegID          = 0 
                       AND Leg.t_LegKind        = 2 
                       AND Leg.t_PFI            = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                       AND RSI_NPTX.CheckCateg(RSB_SECUR.OBJTYPE_SECDEAL, 23, LPAD(Tick.t_DealID, 34, '0'), 2) <> 1 --категория "Является налоговым Репо" на сделке DDL_TICK.T_DEALID не задана или не равна False
                   )
    LOOP

      v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
      v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

      InitNPTXOBJ(nptxobj);

      nptxobj.T_FUNCTIONKIND   := 1;
      nptxobj.T_DATE           := one_rec.t_FactDate;   
      nptxobj.T_CLIENT         := pCLient;
      nptxobj.T_DIRECTION      := (CASE WHEN pClient = one_rec.t_ClientID THEN
                                             (CASE WHEN one_rec.t_Kind = RSI_DLRQ.DLRQ_KIND_COMMIT THEN RSI_NPTXC.TXOBJ_DIR_OUT ELSE RSI_NPTXC.TXOBJ_DIR_IN END)
                                        ELSE (CASE WHEN one_rec.t_Kind = RSI_DLRQ.DLRQ_KIND_COMMIT THEN RSI_NPTXC.TXOBJ_DIR_IN  ELSE RSI_NPTXC.TXOBJ_DIR_OUT END)
                                        END);        
      nptxobj.T_LEVEL          := 1;
      nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_PROCREPOPAY;                              
      nptxobj.T_SUM            := one_rec.t_Amount;                                                 
      nptxobj.T_CUR            := one_rec.t_FIID;                                
      nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
      nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
      nptxobj.T_ANALITICKIND2  := 0;                    
      nptxobj.T_ANALITIC2      := -1;                                          
      nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
      nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
      nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
      nptxobj.T_ANALITIC4      := v_Circulate;                                     
      nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
      nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
      nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
      nptxobj.T_ANALITIC6      := (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END);                                            
      nptxobj.T_COMMENT        := 'Платеж по процентам РЕПО';      
      nptxobj.T_DOCID          := pDocID;
      nptxobj.T_STEP           := pStep; 
      nptxobj.T_TECHNICAL      := CHR(0);

      nptxobj_ins.extend;
      nptxobj_ins(nptxobj_ins.LAST) := nptxobj;


      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;
  
  END;

  --Расчет объектов НДР по платежам по купону в Репо
  PROCEDURE CreateTaxObjects1_9(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

  BEGIN

    pStat := 0;

    FOR one_rec IN (SELECT RQ.t_FactDate, RQ.t_Amount, RQ.t_FIID, Leg.t_PFI, 
                           Opr.IsBuy, Tick.t_DealID, Tick.t_DealDate, 
                           Tick.t_ClientID,  
                           Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID   
                      FROM ddlrq_dbt RQ, ddl_tick_dbt Tick, ddl_leg_dbt Leg, 
                           (SELECT t_Kind_Operation, 
                                   Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(t_SysTypes)) IsBuy
                              FROM doprkoper_dbt 
                             WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC
                               AND Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(t_SysTypes)) = 1) Opr 
                     WHERE RQ.t_DocKind = RSB_SECUR.DL_SECURITYDOC
                       AND RQ.t_FactDate >= pBegDate
                       AND RQ.t_FactDate <= pEndDate
                       AND RQ.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC 
                       AND RQ.t_SubKind    = RSI_DLRQ.DLRQ_SUBKIND_CURRENCY
                       AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_PAYMREPOCOUP
                       AND Tick.t_DealID   = RQ.t_DocID
                       AND ( (Tick.t_ClientID = pClient  AND RSI_NPTO.CheckContrIIS(Tick.t_ClientContrID) = pIIS 
                              AND ((pContract IS NULL) OR (pContract <= 0) OR (Tick.t_ClientContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                              ) 
                            OR (Tick.t_PartyID = pClient AND Tick.t_IsPartyClient = 'X' AND RSI_NPTO.CheckContrIIS(Tick.t_PartyContrID) = pIIS 
                                AND ((pContract IS NULL) OR (pContract <= 0) OR (Tick.t_PartyContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                                )
                            ) 
                       AND Opr.t_Kind_Operation = Tick.t_DealType 
                       AND Leg.t_DealID         = Tick.t_DealID 
                       AND Leg.t_LegID          = 0 
                       AND Leg.t_LegKind        = 2 
                       AND Leg.t_PFI            = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                       AND RSI_NPTX.CheckCateg(RSB_SECUR.OBJTYPE_SECDEAL, 23, LPAD(Tick.t_DealID, 34, '0'), 2) <> 1 --категория "Является налоговым Репо" на сделке DDL_TICK.T_DEALID не задана или не равна False
                    --Измен.стоим.при выплате.купона. = да
                       AND (SELECT Attr.t_NumInList 
                              FROM dobjatcor_dbt AtCor, dobjattr_dbt Attr  
                             WHERE AtCor.t_ObjectType = RSB_SECUR.OBJTYPE_SECDEAL 
                               AND AtCor.t_GroupID    = 18 
                               AND AtCor.t_Object     = LPAD( Tick.t_DealID, 34, '0' ) 
                               AND AtCor.t_ValidFromDate  = ( SELECT MAX(t.T_ValidFromDate) 
                                                                FROM DOBJATCOR_DBT t 
                                                               WHERE t.T_ObjectType = AtCor.T_ObjectType 
                                                                 AND t.T_GroupID    = AtCor.T_GroupID    
                                                                 AND t.t_Object     = AtCor.t_Object     
                                                                 AND t.T_ValidFromDate <= pEndDate              
                                                            ) 
                               AND Attr.t_AttrID      = AtCor.t_AttrID 
                               AND Attr.t_ObjectType  = AtCor.t_ObjectType 
                               AND Attr.t_GroupID     = AtCor.t_GroupID 
                           ) = '1'   --да                   
                 )
    LOOP

      v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
      v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

      InitNPTXOBJ(nptxobj);

      nptxobj.T_FUNCTIONKIND   := 1;
      nptxobj.T_DATE           := one_rec.t_FactDate;   
      nptxobj.T_CLIENT         := pCLient;
      nptxobj.T_DIRECTION      := (CASE WHEN pClient = one_rec.t_ClientID THEN
                                             (CASE WHEN one_rec.IsBuy = 1 THEN RSI_NPTXC.TXOBJ_DIR_IN  ELSE RSI_NPTXC.TXOBJ_DIR_OUT END)
                                        ELSE (CASE WHEN one_rec.IsBuy = 1 THEN RSI_NPTXC.TXOBJ_DIR_OUT ELSE RSI_NPTXC.TXOBJ_DIR_IN END)
                                        END);        
      nptxobj.T_LEVEL          := 1;
      nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_PAY;                              
      nptxobj.T_SUM            := one_rec.t_Amount;                                                 
      nptxobj.T_CUR            := one_rec.t_FIID;                                
      nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
      nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
      nptxobj.T_ANALITICKIND2  := 0;                    
      nptxobj.T_ANALITIC2      := -1;                                          
      nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
      nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
      nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
      nptxobj.T_ANALITIC4      := v_Circulate;                                     
      nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
      nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
      nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
      nptxobj.T_ANALITIC6      := (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END);                                            
      nptxobj.T_COMMENT        := 'Платежи купона по Репо';      
      nptxobj.T_DOCID          := pDocID;
      nptxobj.T_STEP           := pStep; 
      nptxobj.T_TECHNICAL      := CHR(0);

      nptxobj_ins.extend;
      nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;


    FOR one_rec IN (SELECT RQ.t_FactDate, RQ.t_Amount, RQ.t_FIID, Leg.t_PFI, 
                              Opr.IsBuy, Tick.t_DealID, Tick.t_DealDate, 
                              Tick.t_ClientID,  
                              Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID   
                         FROM ddlrq_dbt RQ, ddl_tick_dbt Tick, ddl_leg_dbt Leg, 
                              (SELECT t_Kind_Operation, 
                                      Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(t_SysTypes)) IsBuy
                                 FROM doprkoper_dbt 
                                WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC
                                  AND Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(t_SysTypes)) = 1) Opr 
                        WHERE RQ.t_DocKind = RSB_SECUR.DL_SECURITYDOC
                          AND RQ.t_FactDate >= pBegDate
                          AND RQ.t_FactDate <= pEndDate
                          AND RQ.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC 
                          AND RQ.t_SubKind    = RSI_DLRQ.DLRQ_SUBKIND_CURRENCY
                          AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_PAYMREPOCOUP
                          AND Tick.t_DealID   = RQ.t_DocID
                          AND ( (Tick.t_ClientID = pClient  AND RSI_NPTO.CheckContrIIS(Tick.t_ClientContrID) = pIIS ) 
                               OR (Tick.t_PartyID = pClient AND Tick.t_IsPartyClient = 'X' AND RSI_NPTO.CheckContrIIS(Tick.t_PartyContrID) = pIIS)) 
                          AND Opr.t_Kind_Operation = Tick.t_DealType 
                          AND Leg.t_DealID         = Tick.t_DealID 
                          AND Leg.t_LegID          = 0 
                          AND Leg.t_LegKind        = 2 
                          AND Leg.t_PFI            = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                          AND RSI_NPTX.CheckCateg(RSB_SECUR.OBJTYPE_SECDEAL, 23, LPAD(Tick.t_DealID, 34, '0'), 2) <> 1 --категория "Является налоговым Репо" на сделке DDL_TICK.T_DEALID не задана или не равна False
                       --Измен.стоим.при выплате.купона. = нет
                          AND (SELECT Attr.t_NumInList 
                                 FROM dobjatcor_dbt AtCor, dobjattr_dbt Attr  
                                WHERE AtCor.t_ObjectType = RSB_SECUR.OBJTYPE_SECDEAL 
                                  AND AtCor.t_GroupID    = 18 
                                  AND AtCor.t_Object     = LPAD( Tick.t_DealID, 34, '0' ) 
                                  AND AtCor.t_ValidFromDate  = ( SELECT MAX(t.T_ValidFromDate) 
                                                                   FROM DOBJATCOR_DBT t 
                                                                  WHERE t.T_ObjectType = AtCor.T_ObjectType 
                                                                    AND t.T_GroupID    = AtCor.T_GroupID    
                                                                    AND t.t_Object     = AtCor.t_Object     
                                                                    AND t.T_ValidFromDate <= pEndDate              
                                                               ) 
                                  AND Attr.t_AttrID      = AtCor.t_AttrID 
                                  AND Attr.t_ObjectType  = AtCor.t_ObjectType 
                                  AND Attr.t_GroupID     = AtCor.t_GroupID 
                              ) = '0'   --нет                   
                      )
    LOOP

      v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
      v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

      InitNPTXOBJ(nptxobj);

      nptxobj.T_FUNCTIONKIND   := 1;
      nptxobj.T_DATE           := one_rec.t_FactDate;   
      nptxobj.T_CLIENT         := pCLient;
      nptxobj.T_DIRECTION      := (CASE WHEN pClient = one_rec.t_ClientID THEN
                                             (CASE WHEN one_rec.IsBuy = 1 THEN RSI_NPTXC.TXOBJ_DIR_OUT ELSE RSI_NPTXC.TXOBJ_DIR_IN END)
                                        ELSE (CASE WHEN one_rec.IsBuy = 1 THEN RSI_NPTXC.TXOBJ_DIR_IN  ELSE RSI_NPTXC.TXOBJ_DIR_OUT END)
                                        END);        
      nptxobj.T_LEVEL          := 1;
      nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_PAY;                              
      nptxobj.T_SUM            := one_rec.t_Amount;                                                 
      nptxobj.T_CUR            := one_rec.t_FIID;                                
      nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
      nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
      nptxobj.T_ANALITICKIND2  := 0;                    
      nptxobj.T_ANALITIC2      := -1;                                          
      nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
      nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
      nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
      nptxobj.T_ANALITIC4      := v_Circulate;                                     
      nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
      nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
      nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
      nptxobj.T_ANALITIC6      := (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END);                                            
      nptxobj.T_COMMENT        := 'Платежи купона по Репо';      
      nptxobj.T_DOCID          := pDocID;
      nptxobj.T_STEP           := pStep; 

      nptxobj_ins.extend;
      nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по платежам по ЧП в Репо
  PROCEDURE CreateTaxObjects1_10(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

  BEGIN

    pStat := 0;

    FOR one_rec IN (SELECT RQ.t_FactDate, RQ.t_Amount, RQ.t_FIID, Leg.t_PFI, 
                           Opr.IsBuy, Tick.t_DealID, Tick.t_DealDate, 
                           Tick.t_ClientID,  
                           Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID   
                      FROM ddlrq_dbt RQ, ddl_tick_dbt Tick, ddl_leg_dbt Leg, 
                           (SELECT t_Kind_Operation, 
                                   Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(t_SysTypes)) IsBuy
                              FROM doprkoper_dbt 
                             WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC
                               AND Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(t_SysTypes)) = 1) Opr 
                     WHERE RQ.t_DocKind = RSB_SECUR.DL_SECURITYDOC
                       AND RQ.t_FactDate >= pBegDate
                       AND RQ.t_FactDate <= pEndDate
                       AND RQ.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC 
                       AND RQ.t_SubKind    = RSI_DLRQ.DLRQ_SUBKIND_CURRENCY
                       AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_PAYMREPOPART
                       AND Tick.t_DealID   = RQ.t_DocID
                       AND ( (Tick.t_ClientID = pClient  AND RSI_NPTO.CheckContrIIS(Tick.t_ClientContrID) = pIIS 
                              AND ((pContract IS NULL) OR (pContract <= 0) OR (Tick.t_ClientContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                             ) 
                            OR (Tick.t_PartyID = pClient AND Tick.t_IsPartyClient = 'X' AND RSI_NPTO.CheckContrIIS(Tick.t_PartyContrID) = pIIS) 
                                AND ((pContract IS NULL) OR (pContract <= 0) OR (Tick.t_PartyContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                                ) 
                       AND Opr.t_Kind_Operation = Tick.t_DealType 
                       AND Leg.t_DealID         = Tick.t_DealID 
                       AND Leg.t_LegID          = 0 
                       AND Leg.t_LegKind        = 2 
                       AND Leg.t_PFI            = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                       AND RSI_NPTX.CheckCateg(RSB_SECUR.OBJTYPE_SECDEAL, 23, LPAD(Tick.t_DealID, 34, '0'), 2) <> 1 --категория "Является налоговым Репо" на сделке DDL_TICK.T_DEALID не задана или не равна False
                    --Измен.стоим.при выплате.амортиз. = да
                       AND (SELECT Attr.t_NumInList 
                              FROM dobjatcor_dbt AtCor, dobjattr_dbt Attr  
                             WHERE AtCor.t_ObjectType = RSB_SECUR.OBJTYPE_SECDEAL 
                               AND AtCor.t_GroupID    = 22 
                               AND AtCor.t_Object     = LPAD( Tick.t_DealID, 34, '0' ) 
                               AND AtCor.t_ValidFromDate  = ( SELECT MAX(t.T_ValidFromDate) 
                                                                FROM DOBJATCOR_DBT t 
                                                               WHERE t.T_ObjectType = AtCor.T_ObjectType 
                                                                 AND t.T_GroupID    = AtCor.T_GroupID    
                                                                 AND t.t_Object     = AtCor.t_Object     
                                                                 AND t.T_ValidFromDate <= pEndDate              
                                                            ) 
                               AND Attr.t_AttrID      = AtCor.t_AttrID 
                               AND Attr.t_ObjectType  = AtCor.t_ObjectType 
                               AND Attr.t_GroupID     = AtCor.t_GroupID 
                           ) = '1'   --да                   
                 )
    LOOP

      v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
      v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

      InitNPTXOBJ(nptxobj);

      nptxobj.T_FUNCTIONKIND   := 1;
      nptxobj.T_DATE           := one_rec.t_FactDate;   
      nptxobj.T_CLIENT         := pCLient;
      nptxobj.T_DIRECTION      := (CASE WHEN pClient = one_rec.t_ClientID THEN
                                             (CASE WHEN one_rec.IsBuy = 1 THEN RSI_NPTXC.TXOBJ_DIR_IN  ELSE RSI_NPTXC.TXOBJ_DIR_OUT END)
                                        ELSE (CASE WHEN one_rec.IsBuy = 1 THEN RSI_NPTXC.TXOBJ_DIR_OUT ELSE RSI_NPTXC.TXOBJ_DIR_IN END)
                                        END);        
      nptxobj.T_LEVEL          := 1;
      nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_PAY;                              
      nptxobj.T_SUM            := one_rec.t_Amount;                                                 
      nptxobj.T_CUR            := one_rec.t_FIID;                                
      nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
      nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
      nptxobj.T_ANALITICKIND2  := 0;                    
      nptxobj.T_ANALITIC2      := -1;                                          
      nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
      nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
      nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
      nptxobj.T_ANALITIC4      := v_Circulate;                                     
      nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
      nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
      nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
      nptxobj.T_ANALITIC6      := (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END);                                            
      nptxobj.T_COMMENT        := 'Частичные погашения по Репо';      
      nptxobj.T_DOCID          := pDocID;
      nptxobj.T_STEP           := pStep; 
      nptxobj.T_TECHNICAL      := CHR(0);

      nptxobj_ins.extend;
      nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;


    FOR one_rec IN (SELECT RQ.t_FactDate, RQ.t_Amount, RQ.t_FIID, Leg.t_PFI, 
                           Opr.IsBuy, Tick.t_DealID, Tick.t_DealDate, 
                           Tick.t_ClientID,  
                           Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID   
                      FROM ddlrq_dbt RQ, ddl_tick_dbt Tick, ddl_leg_dbt Leg, 
                           (SELECT t_Kind_Operation, 
                                   Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(t_SysTypes)) IsBuy
                              FROM doprkoper_dbt 
                             WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC
                               AND Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(t_SysTypes)) = 1) Opr 
                     WHERE RQ.t_DocKind = RSB_SECUR.DL_SECURITYDOC
                       AND RQ.t_FactDate >= pBegDate
                       AND RQ.t_FactDate <= pEndDate
                       AND RQ.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC 
                       AND RQ.t_SubKind    = RSI_DLRQ.DLRQ_SUBKIND_CURRENCY
                       AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_PAYMREPOPART
                       AND Tick.t_DealID   = RQ.t_DocID
                       AND ( (Tick.t_ClientID = pClient  AND RSI_NPTO.CheckContrIIS(Tick.t_ClientContrID) = pIIS ) 
                            OR (Tick.t_PartyID = pClient AND Tick.t_IsPartyClient = 'X' AND RSI_NPTO.CheckContrIIS(Tick.t_PartyContrID) = pIIS)) 
                       AND Opr.t_Kind_Operation = Tick.t_DealType 
                       AND Leg.t_DealID         = Tick.t_DealID 
                       AND Leg.t_LegID          = 0 
                       AND Leg.t_LegKind        = 2 
                       AND Leg.t_PFI            = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                       AND RSI_NPTX.CheckCateg(RSB_SECUR.OBJTYPE_SECDEAL, 23, LPAD(Tick.t_DealID, 34, '0'), 2) <> 1 --категория "Является налоговым Репо" на сделке DDL_TICK.T_DEALID не задана или не равна False
                    --Измен.стоим.при выплате.амортиз. = нет
                       AND (SELECT Attr.t_NumInList 
                              FROM dobjatcor_dbt AtCor, dobjattr_dbt Attr  
                             WHERE AtCor.t_ObjectType = RSB_SECUR.OBJTYPE_SECDEAL 
                               AND AtCor.t_GroupID    = 22 
                               AND AtCor.t_Object     = LPAD( Tick.t_DealID, 34, '0' ) 
                               AND AtCor.t_ValidFromDate  = ( SELECT MAX(t.T_ValidFromDate) 
                                                                FROM DOBJATCOR_DBT t 
                                                               WHERE t.T_ObjectType = AtCor.T_ObjectType 
                                                                 AND t.T_GroupID    = AtCor.T_GroupID    
                                                                 AND t.t_Object     = AtCor.t_Object     
                                                                 AND t.T_ValidFromDate <= pEndDate              
                                                            ) 
                               AND Attr.t_AttrID      = AtCor.t_AttrID 
                               AND Attr.t_ObjectType  = AtCor.t_ObjectType 
                               AND Attr.t_GroupID     = AtCor.t_GroupID 
                           ) = '0'   --нет                   
                 )
    LOOP

      v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
      v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

      InitNPTXOBJ(nptxobj);

      nptxobj.T_FUNCTIONKIND   := 1;
      nptxobj.T_DATE           := one_rec.t_FactDate;   
      nptxobj.T_CLIENT         := pCLient;
      nptxobj.T_DIRECTION      := (CASE WHEN pClient = one_rec.t_ClientID THEN
                                             (CASE WHEN one_rec.IsBuy = 1 THEN RSI_NPTXC.TXOBJ_DIR_OUT  ELSE RSI_NPTXC.TXOBJ_DIR_IN END)
                                        ELSE (CASE WHEN one_rec.IsBuy = 1 THEN RSI_NPTXC.TXOBJ_DIR_IN ELSE RSI_NPTXC.TXOBJ_DIR_OUT END)
                                        END);        
      nptxobj.T_LEVEL          := 1;
      nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_PAY;                              
      nptxobj.T_SUM            := one_rec.t_Amount;                                                 
      nptxobj.T_CUR            := one_rec.t_FIID;                                
      nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
      nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
      nptxobj.T_ANALITICKIND2  := 0;                    
      nptxobj.T_ANALITIC2      := -1;                                          
      nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
      nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
      nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
      nptxobj.T_ANALITIC4      := v_Circulate;                                     
      nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
      nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
      nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
      nptxobj.T_ANALITIC6      := (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END);                                            
      nptxobj.T_COMMENT        := 'Частичные погашения по Репо';      
      nptxobj.T_DOCID          := pDocID;
      nptxobj.T_STEP           := pStep; 

      nptxobj_ins.extend;
      nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;
  END;

  --Расчет объектов НДР по компенсационным платежам в Репо
  PROCEDURE CreateTaxObjects1_11(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

  BEGIN

    pStat := 0;

    FOR one_rec IN (SELECT RQ.t_FactDate, RQ.t_Amount, RQ.t_FIID, RQ.t_Kind, Leg.t_PFI, 
                           Opr.IsBuy, Tick.t_DealID, Tick.t_DealDate, 
                           Tick.t_ClientID,  
                           Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID   
                      FROM ddlrq_dbt RQ, ddl_tick_dbt Tick, ddl_leg_dbt Leg, 
                           (SELECT t_Kind_Operation, 
                                   Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(t_SysTypes)) IsBuy
                              FROM doprkoper_dbt 
                             WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC
                               AND Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(t_SysTypes)) = 1) Opr 
                     WHERE RQ.t_DocKind = RSB_SECUR.DL_SECURITYDOC
                       AND RQ.t_FactDate >= pBegDate
                       AND RQ.t_FactDate <= pEndDate
                       AND RQ.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC 
                       AND RQ.t_SubKind    = RSI_DLRQ.DLRQ_SUBKIND_CURRENCY
                       AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_COMPPAYM
                       AND Tick.t_DealID   = RQ.t_DocID
                       AND ( (Tick.t_ClientID = pClient  AND RSI_NPTO.CheckContrIIS(Tick.t_ClientContrID) = pIIS 
                              AND ((pContract IS NULL) OR (pContract <= 0) OR (Tick.t_ClientContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                              ) 
                            OR (Tick.t_PartyID = pClient AND Tick.t_IsPartyClient = 'X' AND RSI_NPTO.CheckContrIIS(Tick.t_PartyContrID) = pIIS 
                                AND ((pContract IS NULL) OR (pContract <= 0) OR (Tick.t_PartyContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                                )
                            ) 
                       AND Opr.t_Kind_Operation = Tick.t_DealType 
                       AND Leg.t_DealID         = Tick.t_DealID 
                       AND Leg.t_LegID          = 0 
                       AND Leg.t_LegKind        = 2 
                       AND Leg.t_PFI            = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                       AND RSI_NPTX.CheckCateg(RSB_SECUR.OBJTYPE_SECDEAL, 23, LPAD(Tick.t_DealID, 34, '0'), 2) <> 1 --категория "Является налоговым Репо" на сделке DDL_TICK.T_DEALID не задана или не равна False
                    --Измен.стоим.выпл.комп.взноса = да
                       AND (SELECT Attr.t_NumInList 
                              FROM dobjatcor_dbt AtCor, dobjattr_dbt Attr  
                             WHERE AtCor.t_ObjectType = RSB_SECUR.OBJTYPE_SECDEAL 
                               AND AtCor.t_GroupID    = 21 
                               AND AtCor.t_Object     = LPAD( Tick.t_DealID, 34, '0' ) 
                               AND AtCor.t_ValidFromDate  = ( SELECT MAX(t.T_ValidFromDate) 
                                                                FROM DOBJATCOR_DBT t 
                                                               WHERE t.T_ObjectType = AtCor.T_ObjectType 
                                                                 AND t.T_GroupID    = AtCor.T_GroupID    
                                                                 AND t.t_Object     = AtCor.t_Object     
                                                                 AND t.T_ValidFromDate <= pEndDate              
                                                            ) 
                               AND Attr.t_AttrID      = AtCor.t_AttrID 
                               AND Attr.t_ObjectType  = AtCor.t_ObjectType 
                               AND Attr.t_GroupID     = AtCor.t_GroupID 
                           ) = '1'   --да                   
                 )
    LOOP

      v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
      v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

      InitNPTXOBJ(nptxobj);

      nptxobj.T_FUNCTIONKIND   := 1;
      nptxobj.T_DATE           := one_rec.t_FactDate;   
      nptxobj.T_CLIENT         := pCLient;
      nptxobj.T_DIRECTION      := (CASE WHEN pClient = one_rec.t_ClientID THEN
                                             (CASE WHEN one_rec.t_Kind = RSI_DLRQ.DLRQ_KIND_REQUEST THEN RSI_NPTXC.TXOBJ_DIR_IN  ELSE RSI_NPTXC.TXOBJ_DIR_OUT END)
                                        ELSE (CASE WHEN one_rec.t_Kind = RSI_DLRQ.DLRQ_KIND_REQUEST THEN RSI_NPTXC.TXOBJ_DIR_OUT ELSE RSI_NPTXC.TXOBJ_DIR_IN END)
                                        END);        
      nptxobj.T_LEVEL          := 1;
      nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_PAY;                              
      nptxobj.T_SUM            := one_rec.t_Amount;                                                 
      nptxobj.T_CUR            := one_rec.t_FIID;                                
      nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
      nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
      nptxobj.T_ANALITICKIND2  := 0;                    
      nptxobj.T_ANALITIC2      := -1;                                          
      nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
      nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
      nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
      nptxobj.T_ANALITIC4      := v_Circulate;                                     
      nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
      nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
      nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
      nptxobj.T_ANALITIC6      := (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END);                                            
      nptxobj.T_COMMENT        := 'Компенсационные по Репо';      
      nptxobj.T_DOCID          := pDocID;
      nptxobj.T_STEP           := pStep; 
      nptxobj.T_TECHNICAL      := CHR(0);

      nptxobj_ins.extend;
      nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;
  END;

  --Расчет объектов НДР по основной сумме погашений
  PROCEDURE CreateTaxObjects1_12(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

  BEGIN

    pStat := 0;

    IF ConsRepaymPit <> 0 THEN

      FOR one_rec IN (WITH sf AS (SELECT t_PartyID, t_ID 
                                    FROM dsfcontr_dbt 
                                   WHERE t_PartyID = pCLient 
                                     AND t_ServKind = RSI_NPTO.PTSK_STOCKDL 
                                     AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS
                                     AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                                 )
                      SELECT Tick.t_DealID, Tick.t_DealDate, Leg.t_PFI, Leg.t_Cost, Fin.t_FaceValueFI, 
                             Tick.t_ClientContrID, RQ.t_FactDate 
                        FROM ddl_tick_dbt Tick, sf, ddl_leg_dbt Leg, dfininstr_dbt Fin, ddlrq_dbt rq  
                       WHERE RQ.t_DocKind    = RSB_SECUR.DL_RETIREMENT 
                         AND RQ.t_FactDate   >= pBegDate 
                         AND RQ.t_FactDate   <= pEndDate
                         AND RQ.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC  
                         AND RQ.t_SubKind    = RSI_DLRQ.DLRQ_SUBKIND_CURRENCY
                         AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_PAYMENT
                         AND RQ.t_DealPart   = 1 
                         AND Tick.t_DealID   = RQ.t_DocID
                         AND Tick.t_ClientID = sf.t_PartyID 
                         AND Tick.t_ClientContrID = sf.t_ID
                         AND Tick.t_CouponNDFL = chr(88) /*Изменение РСХБ, перенесенное в дистрибутив - PNV убрать погашение из расчета НОБ*/ 
                         AND Leg.t_DealID    = Tick.t_DealID 
                         AND Leg.t_LegID     = 0 
                         AND Leg.t_LegKind   = 0 
                         AND Leg.t_PFI       = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                         AND Leg.t_Cost      > 0
                         AND Fin.t_FIID      = Leg.t_PFI                   
                   )
      LOOP

        v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
        v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_FactDate;   
        nptxobj.T_CLIENT         := pCLient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
        nptxobj.T_LEVEL          := 1;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_MAIN;                              
        nptxobj.T_SUM            := one_rec.t_Cost;                                                 
        nptxobj.T_CUR            := one_rec.t_FaceValueFI;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1020;                           
        nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := one_rec.t_ClientContrID;                                            
        nptxobj.T_COMMENT        := 'Основная сумма погашения';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

        IF nptxobj_ins.COUNT >= g_Limit THEN
          FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
               INSERT INTO DNPTXOBJ_TMP
                    VALUES nptxobj_ins(indx);

          nptxobj_ins.Delete;
          nptxobj_ins := nptxobj_t();
        END IF;

      END LOOP;

      IF nptxobj_ins.COUNT > 0 THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
      END IF;
    END IF;

  END;

  --Расчет объектов НДР по сумме НКД в погашениях
  PROCEDURE CreateTaxObjects1_13(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

  BEGIN

    pStat := 0;

    IF ConsRepaymPit <> 0 THEN

      FOR one_rec IN (SELECT Tick.t_DealID, Tick.t_DealDate, Leg.t_PFI, Leg.t_NKD, Fin.t_FaceValueFI, 
                             Tick.t_ClientContrID, RQ.t_FactDate 
                        FROM ddl_tick_dbt Tick, ddl_leg_dbt Leg, dfininstr_dbt Fin, ddlrq_dbt rq  
                       WHERE RQ.t_DocKind    = RSB_SECUR.DL_RETIREMENT 
                         AND RQ.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC  
                         AND RQ.t_SubKind    = RSI_DLRQ.DLRQ_SUBKIND_CURRENCY
                         AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_PAYMENT
                         AND RQ.t_DealPart   = 1 
                         AND Tick.t_DealID   = RQ.t_DocID
                         AND Tick.t_ClientID = pClient 
                         AND Tick.t_DealDate   >= pBegDate 
                         AND Tick.t_DealDate   <= pEndDate
                         AND RSI_NPTO.CheckContrIIS(Tick.t_ClientContrID) = pIIS
                         AND ((pContract IS NULL) OR (pContract <= 0) OR (Tick.t_ClientContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                         AND Tick.t_CouponNDFL = chr(88)  
                         AND Leg.t_DealID    = Tick.t_DealID 
                         AND Leg.t_LegID     = 0 
                         AND Leg.t_LegKind   = 0 
                         AND Leg.t_PFI       = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                         AND Leg.t_NKD       > 0
                         AND Fin.t_FIID      = Leg.t_PFI                   
                   )
      LOOP

        v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
        v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_FactDate;   
        nptxobj.T_CLIENT         := pCLient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
        nptxobj.T_LEVEL          := 1;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_NKD;                              
        nptxobj.T_SUM            := one_rec.t_NKD;                                                 
        nptxobj.T_CUR            := one_rec.t_FaceValueFI;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1020;                           
        nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := one_rec.t_ClientContrID;                                            
        nptxobj.T_COMMENT        := 'Купон в погашении';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

        IF nptxobj_ins.COUNT >= g_Limit THEN
          FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
               INSERT INTO DNPTXOBJ_TMP
                    VALUES nptxobj_ins(indx);

          nptxobj_ins.Delete;
          nptxobj_ins := nptxobj_t();
        END IF;

      END LOOP;

      IF nptxobj_ins.COUNT > 0 THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
      END IF;
    END IF;
  END;

  --Расчет объектов НДР по комиссиям погашений
  PROCEDURE CreateTaxObjects1_14(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

  BEGIN

    pStat := 0;

    FOR one_rec IN (SELECT Comis.t_FactPayDate, Comis.t_Sum AllSum, M.T_FIID_COMM Currency, 
                           Tick.t_DealID, Leg.t_PFI, 
                           Tick.t_ClientContrID, Tick.t_DealDate 
                      FROM DNPTXCOMM_TMP Comis, ddl_tick_dbt Tick, ddl_leg_dbt Leg, DSFCOMISS_DBT M 
                     WHERE Comis.t_DocKind      = RSB_SECUR.DL_RETIREMENT
                       AND Comis.t_FactPayDate >= pBegDate 
                       AND Comis.t_FactPayDate <= pEndDate
                       AND Tick.t_DealID        = Comis.t_DocID 
                       AND Tick.t_ClientID      = pClient 
                       AND Tick.t_ClientContrID = Comis.T_Contract
                       AND Tick.t_CouponNDFL    = chr(88) /*Изменение РСХБ, перенесенное в дистрибутив - PNV убрать погашение из расчета НОБ*/
                       AND RSI_NPTO.CheckContrIIS(Tick.t_ClientContrID) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (Tick.t_ClientContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND Leg.t_DealID         = Tick.t_DealID 
                       AND Leg.t_LegID          = 0 
                       AND Leg.t_LegKind        = 0 
                       AND Leg.t_PFI            = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                       AND (TaxDepositoryMode <> 0 OR
                            0 = rsb_secur.CheckExistGrDealByCom(Comis.T_DocKind, Comis.T_DocID, Comis.T_Contract, Comis.T_PLANPAYDATE, RSI_DLGR.DLGRACC_STATE_PLAN) 
                           )
                       AND M.T_FEETYPE = Comis.T_FEETYPE   
                       AND M.T_NUMBER  = Comis.T_COMNUMBER                   
                 )
    LOOP

      v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
      v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

      InitNPTXOBJ(nptxobj);

      nptxobj.T_FUNCTIONKIND   := 1;
      nptxobj.T_DATE           := one_rec.t_FactPayDate;   
      nptxobj.T_CLIENT         := pCLient;
      nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
      nptxobj.T_LEVEL          := 1;
      nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_COM;                              
      nptxobj.T_SUM            := one_rec.AllSum;                                                 
      nptxobj.T_CUR            := one_rec.Currency;                                
      nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1020;                           
      nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
      nptxobj.T_ANALITICKIND2  := 0;                    
      nptxobj.T_ANALITIC2      := -1;                                          
      nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
      nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
      nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
      nptxobj.T_ANALITIC4      := v_Circulate;                                     
      nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
      nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
      nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
      nptxobj.T_ANALITIC6      := one_rec.t_ClientContrID;                                            
      nptxobj.T_COMMENT        := 'Комиссия по операции погашения';      
      nptxobj.T_DOCID          := pDocID;
      nptxobj.T_STEP           := pStep; 
      nptxobj.T_TECHNICAL      := CHR(0);

      nptxobj_ins.extend;
      nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;
  END;

  --Расчет объектов НДР по зачислению или списанию (только с категорией "Сделка замещения")
  PROCEDURE CreateTaxObjects1_15(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

    v_BuyDate   DATE;
    v_SaleDate  DATE;
    v_Cost      NUMBER;
    v_NKD       NUMBER;
    v_Outlay    NUMBER;

  BEGIN

    pStat := 0;

    --Зачисления
    FOR one_rec IN (SELECT Tick.t_DealID, Tick.t_BOfficeKind, Leg.t_PFI, leg.t_cfi cfi, Fin.t_FaceValueFI, 
                           Leg.t_CFI, Tick.t_PreOutlayFIID, Leg.t_Price, Leg.t_Cost, Leg.t_Nkd, Leg.T_NKDFIID, Tick.t_PreOutlay, Tick.t_Flag3,
                           Leg.t_Start,Tick.t_DealDate, Tick.t_ClientContrID 
                      FROM ddl_tick_dbt Tick, ddl_leg_dbt Leg, dfininstr_dbt Fin, 
                           (SELECT t_Kind_Operation 
                              FROM doprkoper_dbt 
                             WHERE t_DocKind = RSB_SECUR.DL_AVRWRT
                               AND Rsb_Secur.IsAvrWrtIn(rsb_secur.get_OperationGroup(t_SysTypes)) = 1) Opr, DDLRQ_DBT RQ 
                     WHERE RQ.t_DocKind    = RSB_SECUR.DL_AVRWRT
                       AND RQ.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC 
                       AND RQ.t_SubKind    = RSI_DLRQ.DLRQ_SUBKIND_AVOIRISS
                       AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_DELIVERY
                       AND RQ.t_DealPart   = 1 
                       AND Tick.t_DealID   = RQ.t_DocID
                       AND Tick.t_ClientID = pClient 
                       AND RSI_NPTO.CheckContrIIS(Tick.t_ClientContrID) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (Tick.t_ClientContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND Opr.t_Kind_Operation = Tick.t_DealType 
                       AND Leg.t_DealID         = Tick.t_DealID 
                       AND Leg.t_LegID          = 0 
                       AND Leg.t_LegKind        = 0 
                       AND Leg.t_PFI            = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                       AND Fin.t_FIID           = Leg.t_PFI 
                       AND RSI_RSB_FIINSTR.FI_ISKSU(Tick.t_PFI) = 0
                       AND 1 = (CASE WHEN TaxDepositoryMode = 0 AND RQ.t_FactDate >= pBegDate AND RQ.t_FactDate <= pEndDate AND Tick.t_Flag3 = 'X' /*учитывать в налоговом учете*/  THEN 1
                                     WHEN TaxDepositoryMode <> 0 AND 
                                          DECODE( Leg.t_Start, g_ZeroDate, Tick.t_DealDate, Leg.t_Start ) >= pBegDate AND 
                                          DECODE( Leg.t_Start, g_ZeroDate, Tick.t_DealDate, Leg.t_Start ) <= pEndDate THEN 1
                                     ELSE 0 END
                               )
                   )
    LOOP

      IF one_rec.t_Flag3 <> 'X' THEN
        v_BuyDate := CASE WHEN one_rec.t_Start = g_ZeroDate THEN one_rec.t_DealDate ELSE one_rec.t_Start END;
        v_Cost    := one_rec.t_Cost;
        v_NKD     := one_rec.t_Nkd;
      ELSE
        v_BuyDate := npto.GetDateFromAvrWrtIn(one_rec.t_DealID, one_rec.t_Start, one_rec.t_DealDate);
        v_Cost    := npto.GetCostFromAvrWrtIn(one_rec.t_DealID, one_rec.t_Cost);
        v_NKD     := npto.GetNkdFromAvrWrtIn(one_rec.t_DealID, one_rec.t_Nkd);
      END IF;
 
      v_Circulate := GetSetCirculate(one_rec.t_PFI, v_BuyDate); 
      v_TaxGroup := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

      IF v_Cost <> 0 THEN

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := v_BuyDate;   
        nptxobj.T_CLIENT         := pCLient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
        nptxobj.T_LEVEL          := 1;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_MAIN;                              
        nptxobj.T_SUM            := v_Cost;                                                 
        nptxobj.T_CUR            := one_rec.t_CFI;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1070;                           
        nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := one_rec.t_ClientContrID;                                            
        nptxobj.T_COMMENT        := 'Затраты на основную стоимость при зачислении ц/б';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      END IF;

      IF v_Nkd <> 0 THEN

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := v_BuyDate;   
        nptxobj.T_CLIENT         := pCLient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
        nptxobj.T_LEVEL          := 1;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_NKD;                              
        nptxobj.T_SUM            := v_Nkd;                                                 
        nptxobj.T_CUR            := one_rec.T_NKDFIID;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1070;                           
        nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := one_rec.t_ClientContrID;                                            
        nptxobj.T_COMMENT        := 'НКД при зачислении ц/б';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      END IF;

      --Расчет затрат - изменение РСХБ, перенесенное в дистрибутив

      FOR one_com IN (SELECT dls.t_Date, dls.t_Sum, dls.t_Currency
                        FROM ddlsum_dbt dls
                       WHERE dls.t_DocKind = one_rec.t_BOfficeKind
                         AND dls.t_DocId = one_rec.t_DealID
                         AND dls.t_Kind = RSI_NPTXC.DLSUM_KIND_OUTLAYWRTTAX)
      LOOP

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_com.t_Date;   
        nptxobj.T_CLIENT         := pCLient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
        nptxobj.T_LEVEL          := 1;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_COM;                              
        nptxobj.T_SUM            := one_com.t_Sum;                                                 
        nptxobj.T_CUR            := one_com.t_Currency;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1070;                           
        nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := one_rec.t_ClientContrID;                                            
        nptxobj.T_COMMENT        := 'Затраты на комиссию при зачислении ц/б';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END LOOP;


      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;


    --Списания с категорией "Сделка замещения"

    FOR one_rec IN (SELECT Tick.t_DealID, Tick.t_BOfficeKind, Leg.t_PFI, leg.t_cfi cfi, Fin.t_FaceValueFI, 
                           Leg.t_CFI, Tick.t_PreOutlayFIID, Leg.t_Price, Leg.t_Cost, Leg.t_Nkd, Leg.T_NKDFIID, Tick.t_PreOutlay, Tick.t_Flag3,
                           Leg.t_Start,Tick.t_DealDate, Tick.t_ClientContrID 
                      FROM ddl_tick_dbt Tick, ddl_leg_dbt Leg, dfininstr_dbt Fin, 
                           (SELECT t_Kind_Operation 
                              FROM doprkoper_dbt 
                             WHERE t_DocKind = RSB_SECUR.DL_AVRWRT
                               AND Rsb_Secur.IsAvrWrtOut(rsb_secur.get_OperationGroup(t_SysTypes)) = 1) Opr, DDLRQ_DBT RQ 
                     WHERE RQ.t_DocKind    = RSB_SECUR.DL_AVRWRT
                       AND RQ.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC 
                       AND RQ.t_SubKind    = RSI_DLRQ.DLRQ_SUBKIND_AVOIRISS
                       AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_DELIVERY
                       AND RQ.t_DealPart   = 1 
                       AND Tick.t_DealID   = RQ.t_DocID
                       AND Tick.t_ClientID = pClient 
                       AND RSI_NPTO.CheckContrIIS(Tick.t_ClientContrID) = pIIS
                       AND RSB_SECUR.GetMainObjAttr(101, LPAD(Tick.t_DealID, 34, '0'), 55, Tick.t_DealDate) = 1
                       AND Opr.t_Kind_Operation = Tick.t_DealType 
                       AND Leg.t_DealID         = Tick.t_DealID 
                       AND Leg.t_LegID          = 0 
                       AND Leg.t_LegKind        = 0 
                       AND Leg.t_PFI            = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                       AND Fin.t_FIID           = Leg.t_PFI 
                       AND RSI_RSB_FIINSTR.FI_ISKSU(Tick.t_PFI) = 0
                       AND 1 = (CASE WHEN TaxDepositoryMode = 0 AND RQ.t_FactDate >= pBegDate AND RQ.t_FactDate <= pEndDate AND Tick.t_Flag3 = 'X' /*учитывать в налоговом учете*/  THEN 1
                                     WHEN TaxDepositoryMode <> 0 AND 
                                          DECODE( Leg.t_Start, g_ZeroDate, Tick.t_DealDate, Leg.t_Start ) >= pBegDate AND 
                                          DECODE( Leg.t_Start, g_ZeroDate, Tick.t_DealDate, Leg.t_Start ) <= pEndDate THEN 1
                                     ELSE 0 END
                               )
                   )
    LOOP

      IF one_rec.t_Flag3 <> 'X' THEN
        v_SaleDate := CASE WHEN one_rec.t_Start = g_ZeroDate THEN one_rec.t_DealDate ELSE one_rec.t_Start END;
        v_Cost    := one_rec.t_Cost;
        v_NKD     := one_rec.t_Nkd;
      ELSE
        v_SaleDate := npto.GetDateFromAvrWrtIn(one_rec.t_DealID, one_rec.t_Start, one_rec.t_DealDate);
        v_Cost     := npto.GetCostFromAvrWrtIn(one_rec.t_DealID, one_rec.t_Cost);
        v_NKD      := npto.GetNkdFromAvrWrtIn(one_rec.t_DealID, one_rec.t_Nkd);
      END IF;
 
      v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate); 
      v_TaxGroup := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

      IF v_Cost <> 0 THEN

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := v_SaleDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
        nptxobj.T_LEVEL          := 1;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_MAIN;                              
        nptxobj.T_SUM            := v_Cost;                                                 
        nptxobj.T_CUR            := one_rec.t_CFI;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1070;                           
        nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := one_rec.t_ClientContrID;                                            
        nptxobj.T_COMMENT        := 'Затраты на основную стоимость при списании ц/б (категория "Сделка замещения" = ДА)';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      END IF;

      IF v_Nkd <> 0 THEN

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := v_SaleDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
        nptxobj.T_LEVEL          := 1;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_NKD;                              
        nptxobj.T_SUM            := v_Nkd;                                                 
        nptxobj.T_CUR            := one_rec.T_NKDFIID;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1070;                           
        nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := one_rec.t_ClientContrID;                                            
        nptxobj.T_COMMENT        := 'НКД при списании ц/б (категория "Сделка замещения" = ДА)';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      END IF;

      --Расчет затрат
      FOR one_com IN (SELECT dls.t_Date, dls.t_Sum, dls.t_Currency
                        FROM ddlsum_dbt dls
                       WHERE dls.t_DocKind = one_rec.t_BOfficeKind
                         AND dls.t_DocId = one_rec.t_DealID
                         AND dls.t_Kind = RSI_NPTXC.DLSUM_KIND_OUTLAYWRTTAX)
      LOOP

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_com.t_Date;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
        nptxobj.T_LEVEL          := 1;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_COM;                              
        nptxobj.T_SUM            := one_com.t_Sum;                                                 
        nptxobj.T_CUR            := one_com.t_Currency;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1070;                           
        nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := one_rec.t_ClientContrID;                                            
        nptxobj.T_COMMENT        := 'Расчет затрат при списании ц/б (категория "Сделка замещения" = ДА)';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END LOOP;


      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по виртуальным сделкам
  PROCEDURE CreateTaxObjects1_16(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

    v_NKD NUMBER;

  BEGIN

    pStat := 0;

    FOR one_rec IN (WITH sf AS (SELECT t_PartyID, t_ID 
                                  FROM dsfcontr_dbt 
                                 WHERE t_PartyID = pClient 
                                   AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS
                                   AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                               )
                    SELECT Lot.t_Price, Lot.t_Amount, Lot.t_PriceFIID, Lot.t_ID, Lot.t_FIID, Lot.t_NKD, Lot.t_Contract, Lot.t_DealDate,
                           Fin.t_FaceValueFI, Lot.t_BegSaleDate,  
                           (SELECT RQ.t_FactDate 
                              FROM ddlrq_dbt RQ 
                             WHERE RQ.t_DocKind  = RealLot.t_DocKind 
                               AND RQ.t_DocID    = RealLot.t_DocID 
                               AND RQ.t_SubKind  = RSI_DLRQ.DLRQ_SUBKIND_CURRENCY
                               AND RQ.t_Type     = RSI_DLRQ.DLRQ_TYPE_PAYMENT
                               AND RQ.t_DealPart = 1 
                               AND ROWNUM = 1) PayDate
                      FROM dnptxlot_dbt Lot, sf, dnptxlot_dbt RealLot, dfininstr_dbt Fin 
                     WHERE Fin.t_FIID      = Lot.t_FIID 
                       AND Lot.t_Type      = RSI_NPTXC.NPTXDEAL_CALC 
                       AND Lot.t_Kind      = RSI_NPTXC.NPTXLOTS_SALE
                       AND Lot.t_RealID    = RealLot.t_ID 
                       AND Lot.t_SaleDate >= pBegDate 
                       AND Lot.t_SaleDate <= pEndDate 
                       AND Lot.t_Client    = sf.t_PartyID
                       AND Lot.t_FIID      = (CASE WHEN pFIID != -1 THEN pFIID ELSE Lot.t_FIID END)
                       AND Lot.t_Contract  = sf.t_ID                   
                 )
    LOOP

      v_Circulate := GetSetCirculate(one_rec.t_FIID, one_rec.t_DealDate);
      v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_FIID);

      InitNPTXOBJ(nptxobj);

      nptxobj.T_FUNCTIONKIND   := 1;
      nptxobj.T_DATE           := one_rec.PayDate;   
      nptxobj.T_CLIENT         := pCLient;
      nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
      nptxobj.T_LEVEL          := 1;
      nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_MAIN;                              
      nptxobj.T_SUM            := one_rec.t_Price*one_rec.t_Amount;                                                 
      nptxobj.T_CUR            := one_rec.t_PriceFIID;                                
      nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1080;                           
      nptxobj.T_ANALITIC1      := one_rec.t_ID;                                   
      nptxobj.T_ANALITICKIND2  := 0;                    
      nptxobj.T_ANALITIC2      := -1;                                          
      nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
      nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
      nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
      nptxobj.T_ANALITIC4      := v_Circulate;                                     
      nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
      nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
      nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
      nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
      nptxobj.T_COMMENT        := 'Основная стоимость по виртуальным сделкам';      
      nptxobj.T_DOCID          := pDocID;
      nptxobj.T_STEP           := pStep; 
      nptxobj.T_TECHNICAL      := CHR(0);

      nptxobj_ins.extend;
      nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      v_NKD := RSI_RSB_FIInstr.FI_CalcNKD(one_rec.t_FIID, one_rec.t_BegSaleDate, 1, 0);
      IF v_NKD <> 0 THEN
        InitNPTXOBJ(nptxobj); 

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.PayDate;   
        nptxobj.T_CLIENT         := pCLient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
        nptxobj.T_LEVEL          := 1;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_NKD;                              
        nptxobj.T_SUM            := v_NKD;                                                 
        nptxobj.T_CUR            := one_rec.t_FaceValueFI;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1080;                           
        nptxobj.T_ANALITIC1      := one_rec.t_ID;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := 'НКД по виртуальным сделкам';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;
  END;

  --Расчет объектов НДР по конвертациям
  PROCEDURE CreateTaxObjects1_17(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

  BEGIN

    pStat := 0;

    FOR one_rec IN (SELECT RQ.t_FactDate, Leg.t_Cost, Leg.t_PFI, 
                           Fin.t_FaceValueFI, Tick.t_DealID, Tick.t_DealDate,
                           Tick.t_ClientContrID 
                      FROM ddlrq_dbt RQ, ddl_tick_dbt Tick, ddl_leg_dbt Leg, dfininstr_dbt Fin 
                     WHERE RQ.t_DocKind = RSB_SECUR.DL_CONVAVR
                       AND RQ.t_FactDate  >= pBegDate
                       AND RQ.t_FactDate  <= pEndDate
                       AND RQ.t_FactDate   < TO_DATE('01.01.2015','DD.MM.YYYY')
                       AND RQ.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC 
                       AND RQ.t_SubKind    = RSI_DLRQ.DLRQ_SUBKIND_AVOIRISS
                       AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_DELIVERY
                       AND RQ.t_DealPart   = 2 
                       AND Tick.t_DealID   = RQ.t_DocID 
                       AND Tick.t_ClientID = pClient 
                       AND RSI_NPTO.CheckContrIIS(Tick.t_ClientContrID) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (Tick.t_ClientContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND Leg.t_DealID    = Tick.t_DealID 
                       AND Leg.t_LegID     = 0 
                       AND Leg.t_LegKind   = 2 
                       AND Leg.t_PFI       = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                       AND Fin.t_FIID      = Leg.t_PFI                   
                 )
    LOOP

      v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
      v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

      InitNPTXOBJ(nptxobj);

      nptxobj.T_FUNCTIONKIND   := 1;
      nptxobj.T_DATE           := one_rec.t_FactDate;   
      nptxobj.T_CLIENT         := pCLient;
      nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
      nptxobj.T_LEVEL          := 1;
      nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_MAIN;                              
      nptxobj.T_SUM            := one_rec.t_Cost;                                                 
      nptxobj.T_CUR            := one_rec.t_FaceValueFI;                                
      nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1030;                           
      nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
      nptxobj.T_ANALITICKIND2  := 0;                    
      nptxobj.T_ANALITIC2      := -1;                                          
      nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
      nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
      nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
      nptxobj.T_ANALITIC4      := v_Circulate;                                     
      nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
      nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
      nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
      nptxobj.T_ANALITIC6      := one_rec.t_ClientContrID;                                            
      nptxobj.T_COMMENT        := 'Основная стоимость по зачисляемым ц/б при конвертации';      
      nptxobj.T_DOCID          := pDocID;
      nptxobj.T_STEP           := pStep; 
      nptxobj.T_TECHNICAL      := CHR(0);

      nptxobj_ins.extend;
      nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по конвертациям
  PROCEDURE CreateTaxObjects1_18(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

  BEGIN

    pStat := 0;

    FOR one_rec IN (SELECT RQ.t_FactDate, Leg.t_Cost, Leg.t_PFI, 
                           Fin.t_FaceValueFI, Tick.t_DealID, Tick.t_DealDate,
                           Tick.t_ClientContrID 
                      FROM ddlrq_dbt RQ, ddl_tick_dbt Tick, ddl_leg_dbt Leg, dfininstr_dbt Fin 
                     WHERE RQ.t_DocKind    = RSB_SECUR.DL_CONVAVR 
                       AND RQ.t_FactDate  >= pBegDate
                       AND RQ.t_FactDate  <= pEndDate
                       AND RQ.t_FactDate   < TO_DATE('01.01.2015','DD.MM.YYYY')
                       AND RQ.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC 
                       AND RQ.t_SubKind    = RSI_DLRQ.DLRQ_SUBKIND_AVOIRISS
                       AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_DELIVERY
                       AND RQ.t_DealPart   = 1 
                       AND Tick.t_DealID   = RQ.t_DocID 
                       AND Tick.t_ClientID = pClient 
                       AND RSI_NPTO.CheckContrIIS(Tick.t_ClientContrID) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (Tick.t_ClientContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND Leg.t_DealID    = Tick.t_DealID 
                       AND Leg.t_LegID     = 0 
                       AND Leg.t_LegKind   = 0 
                       AND Leg.t_PFI       = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)
                       AND Fin.t_FIID      = Leg.t_PFI                   
                 )
    LOOP

      v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
      v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

      InitNPTXOBJ(nptxobj);

      nptxobj.T_FUNCTIONKIND   := 1;
      nptxobj.T_DATE           := one_rec.t_FactDate;   
      nptxobj.T_CLIENT         := pCLient;
      nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
      nptxobj.T_LEVEL          := 1;
      nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_MAIN;                              
      nptxobj.T_SUM            := one_rec.t_Cost;                                                 
      nptxobj.T_CUR            := one_rec.t_FaceValueFI;                                
      nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1030;                           
      nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
      nptxobj.T_ANALITICKIND2  := 0;                    
      nptxobj.T_ANALITIC2      := -1;                                          
      nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
      nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
      nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
      nptxobj.T_ANALITIC4      := v_Circulate;                                     
      nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
      nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
      nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
      nptxobj.T_ANALITIC6      := one_rec.t_ClientContrID;                                            
      nptxobj.T_COMMENT        := 'Основная стоимость по списываемым ц/б при конвертации';      
      nptxobj.T_DOCID          := pDocID;
      nptxobj.T_STEP           := pStep; 
      nptxobj.T_TECHNICAL      := CHR(0);

      nptxobj_ins.extend;
      nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по операциям ГО и ИН
  PROCEDURE CreateTaxObjects1_19(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

  BEGIN

    pStat := 0;

    FOR one_rec IN (SELECT Lot.t_ID, Lot.t_Price, Lot.t_Amount, Lot.t_PriceFIID, Lot.t_FIID, Lot.t_NKD, Lot.t_Contract,
                           Fin.t_FaceValueFI, Lot.t_BuyDate, Lot.t_AnaliticKind1, Lot.t_Analitic1, 
                           Lot.t_DealDate
                      FROM v_npx_dnptxlot Lot, dfininstr_dbt Fin 
                     WHERE Fin.t_FIID     = Lot.t_FIID 
                       AND Lot.t_Client   = pClient
                       AND RSI_NPTO.CheckContrIIS(Lot.t_Contract) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (Lot.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND Lot.t_Kind     = RSI_NPTXC.NPTXLOTS_BUY
                       AND EXISTS(SELECT 1
                                    FROM dnptxop_dbt nptxop, doproper_dbt op, dnptxbc_dbt bc
                                   WHERE nptxop.t_ID = pDocID
                                     AND op.t_DocKind = nptxop.t_DocKind
                                     AND op.t_DocumentID = LPAD(nptxop.t_ID, 34, '0')
                                     AND bc.t_ObjKind = RSI_NPTXC.NPTXBC_OBJKIND_LOT
                                     AND bc.t_ObjID = Lot.t_ID
                                     AND bc.t_ID_Operation = op.t_ID_Operation
                                     AND bc.t_Action = RSI_NPTXC.NPTXBC_ACTION_CREATE
                                 )
                       AND Lot.t_BuyDate <= pEndDate
                       AND ( Lot.t_Origin = RSI_NPTXC.NPTXLOTORIGIN_GO OR Lot.t_Origin = RSI_NPTXC.NPTXLOTORIGIN_IN) 
                       AND Lot.t_FIID     = (CASE WHEN pFIID != -1 THEN pFIID ELSE Lot.t_FIID END)
                       AND NOT EXISTS(SELECT 1
                                        FROM dnptxobj_dbt obj
                                       WHERE obj.t_Client = pClient
                                         AND obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                         AND obj.t_Direction = RSI_NPTXC.TXOBJ_DIR_OUT
                                         AND obj.t_AnaliticKind1 = Lot.t_AnaliticKind1
                                         AND obj.t_Analitic1 = Lot.t_Analitic1
                                         AND obj.t_AnaliticKind3 = RSI_NPTXC.TXOBJ_KIND3010
                                         AND obj.t_Analitic3 = Lot.t_FIID
                                         AND obj.t_AnaliticKind6 = RSI_NPTXC.TXOBJ_KIND6020
                                         AND obj.t_Analitic6 = Lot.t_Contract  
                                     )
                       AND NOT EXISTS(SELECT 1
                                        FROM dnptxobj_tmp obj
                                       WHERE obj.t_Client = pClient
                                         AND obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                         AND obj.t_Direction = RSI_NPTXC.TXOBJ_DIR_OUT
                                         AND obj.t_AnaliticKind1 = Lot.t_AnaliticKind1
                                         AND obj.t_Analitic1 = Lot.t_Analitic1
                                         AND obj.t_AnaliticKind3 = RSI_NPTXC.TXOBJ_KIND3010
                                         AND obj.t_Analitic3 = Lot.t_FIID
                                         AND obj.t_AnaliticKind6 = RSI_NPTXC.TXOBJ_KIND6020
                                         AND obj.t_Analitic6 = Lot.t_Contract  
                                     )                               
                 )
    LOOP

      v_Circulate := GetSetCirculate(one_rec.t_FIID, one_rec.t_DealDate);
      v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_FIID);

      InitNPTXOBJ(nptxobj);

      nptxobj.T_FUNCTIONKIND   := 1;
      nptxobj.T_DATE           := one_rec.t_BuyDate;   
      nptxobj.T_CLIENT         := pCLient;
      nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
      nptxobj.T_LEVEL          := 1;
      nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_MAIN;                              
      nptxobj.T_SUM            := one_rec.t_Price * one_rec.t_Amount;                                                 
      nptxobj.T_CUR            := one_rec.t_PriceFIID;                                
      nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
      nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
      nptxobj.T_ANALITICKIND2  := 0;                    
      nptxobj.T_ANALITIC2      := -1;                                          
      nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
      nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
      nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
      nptxobj.T_ANALITIC4      := v_Circulate;                                     
      nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
      nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
      nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
      nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
      nptxobj.T_COMMENT        := 'Основная стоимость по глобальным операциям';      
      nptxobj.T_DOCID          := pDocID;
      nptxobj.T_STEP           := pStep; 
      nptxobj.T_TECHNICAL      := CHR(0);

      nptxobj_ins.extend;
      nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      IF one_rec.t_NKD <> 0 THEN
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_BuyDate;   
        nptxobj.T_CLIENT         := pCLient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
        nptxobj.T_LEVEL          := 1;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_NKD;                              
        nptxobj.T_SUM            := one_rec.t_NKD;                                                 
        nptxobj.T_CUR            := one_rec.t_PriceFIID;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := 'НКД по по глобальным операциям';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по операциям ГО и ИН
  PROCEDURE CreateTaxObjects1_20(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

  BEGIN

    pStat := 0;

    FOR one_rec IN (SELECT Lot.t_ID, Lot.t_Price, Lot.t_Amount, Lot.t_PriceFIID, Lot.t_FIID, Lot.t_NKD, Lot.t_Contract, 
                           Fin.t_FaceValueFI, Lot.t_SaleDate, Lot.t_AnaliticKind1, Lot.t_Analitic1, 
                           Lot.t_DealDate 
                      FROM v_npx_dnptxlot Lot, dfininstr_dbt Fin 
                     WHERE Fin.t_FIID      = Lot.t_FIID 
                       AND Lot.t_Client    = pClient 
                       AND RSI_NPTO.CheckContrIIS(Lot.t_Contract) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (Lot.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND Lot.t_Kind      = RSI_NPTXC.NPTXLOTS_SALE
                       AND EXISTS(SELECT 1
                                    FROM dnptxop_dbt nptxop, doproper_dbt op, dnptxbc_dbt bc
                                   WHERE nptxop.t_ID = pDocID
                                     AND op.t_DocKind = nptxop.t_DocKind
                                     AND op.t_DocumentID = LPAD(nptxop.t_ID, 34, '0')
                                     AND bc.t_ObjKind = RSI_NPTXC.NPTXBC_OBJKIND_LOT
                                     AND bc.t_ObjID = Lot.t_ID
                                     AND bc.t_ID_Operation = op.t_ID_Operation
                                     AND bc.t_Action = RSI_NPTXC.NPTXBC_ACTION_CREATE
                                 )
                       AND Lot.t_SaleDate <= pEndDate
                       AND (Lot.t_Origin = RSI_NPTXC.NPTXLOTORIGIN_GO OR Lot.t_Origin = RSI_NPTXC.NPTXLOTORIGIN_IN)  
                       AND Lot.t_FIID      = (CASE WHEN pFIID != -1 THEN pFIID ELSE Lot.t_FIID END)                   
                 )
    LOOP

      v_Circulate := GetSetCirculate(one_rec.t_FIID, one_rec.t_DealDate);
      v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_FIID);

      InitNPTXOBJ(nptxobj);

      nptxobj.T_FUNCTIONKIND   := 1;
      nptxobj.T_DATE           := one_rec.t_SaleDate;   
      nptxobj.T_CLIENT         := pCLient;
      nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
      nptxobj.T_LEVEL          := 1;
      nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_MAIN;                              
      nptxobj.T_SUM            := one_rec.t_Price * one_rec.t_Amount;                                                 
      nptxobj.T_CUR            := one_rec.t_PriceFIID;                                
      nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
      nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
      nptxobj.T_ANALITICKIND2  := 0;                    
      nptxobj.T_ANALITIC2      := -1;                                          
      nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
      nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
      nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
      nptxobj.T_ANALITIC4      := v_Circulate;                                     
      nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
      nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
      nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
      nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
      nptxobj.T_COMMENT        := 'Основная стоимость по глобальным операциям';      
      nptxobj.T_DOCID          := pDocID;
      nptxobj.T_STEP           := pStep; 
      nptxobj.T_TECHNICAL      := CHR(0);

      nptxobj_ins.extend;
      nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      IF one_rec.t_NKD <> 0 THEN
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_SaleDate;   
        nptxobj.T_CLIENT         := pCLient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
        nptxobj.T_LEVEL          := 1;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_NKD;                              
        nptxobj.T_SUM            := one_rec.t_NKD;                                                 
        nptxobj.T_CUR            := one_rec.t_PriceFIID;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := 'НКД по по глобальным операциям';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по ПИ
  PROCEDURE CreateTaxObjects1_21(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS
    v_nptxobj    nptxobj_t;

    CURSOR LIST_OBJ
    IS

      SELECT 0,                  --T_ID,
             1,                  --T_FUNCTIONKIND,
             qq.T_DATE,
             pClient,            --T_CLIENT,
             qq.T_DIRECTION,
             1,                  --T_LEVEL,
             CHR(0),             --T_USER,
             qq.T_KIND,
             qq.T_SUM,
             qq.T_CUR,
             qq.T_ANALITICKIND1,
             qq.T_ANALITIC1,
             0,                  --T_ANALITICKIND2,
             -1,                 --T_ANALITIC2,
             qq.T_ANALITICKIND3,
             qq.T_ANALITIC3,
             qq.T_ANALITICKIND4,
             qq.T_ANALITIC4,
             qq.T_ANALITICKIND5,
             qq.T_ANALITIC5,
             qq.T_ANALITICKIND6,    
             qq.T_ANALITIC6,
             qq.T_COMMENT,
             pDocID,             --T_DOCID,
             pStep,              --T_STEP,
             0,                  --T_REESTRSUM,
             CHR(0),             --T_FROMOUTSYST,
             CHR(1),             --T_OUTSYSTCODE,
             CHR(1),             --T_OUTOBJID,
             0,                  --T_SOURCEOBJID
             CHR(0) AS T_TECHNICAL,
             RSI_NPTXC.NPTXBC_ACTION_CREATE,
             0,
             g_ZeroDate,
             0,
             g_ZeroDate,
             0,
             0,
             CHR(0)
        FROM (WITH q
                   AS (SELECT FiTurn.*, Fin.t_ParentFI Currency, Fin.t_AvoirKind, 
                              npto.GetPaperTaxGroupNPTX( FiTurn.t_FIID ) TaxGroup,
                              (CASE WHEN FiTurn.t_MarginDay + FiTurn.t_MarginDeals != 0 THEN FiTurn.t_MarginDay + FiTurn.t_MarginDeals ELSE FiTurn.t_Margin END) as TotalMargin 
                         FROM ddvfiturn_dbt FiTurn, dfininstr_dbt Fin 
                        WHERE FiTurn.t_FIID = Fin.t_FIID 
                          AND FiTurn.t_Date >= pBegDate
                          AND FiTurn.t_Date <= pEndDate
                          AND FiTurn.t_Client = pCLient
                          AND RSI_NPTO.CheckContrIIS(FiTurn.t_ClientContr) = pIIS
                          AND ((pContract IS NULL) OR (pContract <= 0) OR (FiTurn.t_ClientContr in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                      ),
                   q_c AS (SELECT com.t_Sum, com.t_Date, com.t_ClientContr, com.t_FIID, sfcom.t_FIID_COMM as ComFIID, sfcom.t_ReceiverID,
                                  q.t_ID as FitID, q.TaxGroup as FitTaxGroup,
                                  RSI_RSB_FIInstr.ConvSum(com.t_Sum, sfcom.t_FIID_COMM, RSI_RSB_FIInstr.NATCUR, com.t_Date) as SumNat
                             FROM q, ddvfi_com_dbt com, dsfcomiss_dbt sfcom
                            WHERE com.t_Department  = q.t_Department
                              AND com.t_Broker      = q.t_Broker
                              AND com.t_ClientContr = q.t_ClientContr
                              AND com.t_FIID        = q.t_FIID
                              AND com.t_Date        = q.t_Date
                              AND sfcom.t_ComissID  = com.t_ComissID
                          )/*,
                   q_enforcementpay AS (SELECT FiTurn.*, Fin.t_ParentFI Currency, Fin.t_AvoirKind, 
                                               npto.GetPaperTaxGroupNPTX( FiTurn.t_FIID ) TaxGroup
                                          FROM ddvfiturn_dbt FiTurn, dfininstr_dbt Fin 
                                         WHERE FiTurn.t_FIID = Fin.t_FIID 
                                           AND FiTurn.t_PayDate >= pBegDate
                                           AND FiTurn.t_PayDate <= pEndDate
                                           AND FiTurn.t_Client = pCLient
                                           AND RSI_NPTO.CheckContrIIS(FiTurn.t_ClientContr) = pIIS
                                           AND ((pContract IS NULL) OR (pContract <= 0) OR (FiTurn.t_ClientContr in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                                           AND FiTurn.t_EnforcementPay <> 0
                                       )   */
              SELECT q.t_Date AS T_DATE,
                     (CASE WHEN q.TotalMargin < 0 THEN RSI_NPTXC.TXOBJ_DIR_OUT ELSE RSI_NPTXC.TXOBJ_DIR_IN END) AS T_DIRECTION,
                     RSI_NPTXC.TXOBJ_VAR AS T_KIND,
                     ABS(q.TotalMargin) AS T_SUM,
                     q.Currency AS T_CUR,
                     RSI_NPTXC.TXOBJ_KIND1040 AS T_ANALITICKIND1,
                     q.t_ID AS T_ANALITIC1,
                     RSI_NPTXC.TXOBJ_KIND3020 AS T_ANALITICKIND3,
                     q.t_FIID AS T_ANALITIC3,
                     RSI_NPTXC.TXOBJ_KIND4010 AS T_ANALITICKIND4,
                     RSI_NPTXC.NPTX_FI_CIRCULATE AS T_ANALITIC4,
                     RSI_NPTXC.TXOBJ_KIND5010 AS T_ANALITICKIND5,
                     q.TaxGroup AS T_ANALITIC5,
                     RSI_NPTXC.TXOBJ_KIND6020 AS T_ANALITICKIND6,
                     q.t_ClientContr AS T_ANALITIC6,
                     'Вариационная маржа' AS T_COMMENT,
                     q.t_ID AS ID
                FROM q
               WHERE q.TotalMargin <> 0
              UNION ALL
              SELECT q.t_Date AS T_DATE,
                     RSI_NPTXC.TXOBJ_DIR_IN AS T_DIRECTION,
                     RSI_NPTXC.TXOBJ_PREM AS T_KIND,
                     q.t_ReceivedBonus AS T_SUM,
                     q.Currency AS T_CUR,
                     RSI_NPTXC.TXOBJ_KIND1040 AS T_ANALITICKIND1,
                     q.t_ID AS T_ANALITIC1,
                     RSI_NPTXC.TXOBJ_KIND3020 AS T_ANALITICKIND3,
                     q.t_FIID AS T_ANALITIC3,
                     RSI_NPTXC.TXOBJ_KIND4010 AS T_ANALITICKIND4,
                     RSI_NPTXC.NPTX_FI_CIRCULATE AS T_ANALITIC4,
                     RSI_NPTXC.TXOBJ_KIND5010 AS T_ANALITICKIND5,
                     q.TaxGroup AS T_ANALITIC5,
                     RSI_NPTXC.TXOBJ_KIND6020 AS T_ANALITICKIND6,
                     q.t_ClientContr AS T_ANALITIC6,
                     'Полученная премия по опционам' AS T_COMMENT,
                     q.t_ID AS ID
                FROM q
               WHERE q.t_ReceivedBonus <> 0
              UNION ALL
              SELECT q.t_Date AS T_DATE,
                     RSI_NPTXC.TXOBJ_DIR_OUT AS T_DIRECTION,
                     RSI_NPTXC.TXOBJ_PREM AS T_KIND,
                     q.t_PaidBonus AS T_SUM,
                     q.Currency AS T_CUR,
                     RSI_NPTXC.TXOBJ_KIND1040 AS T_ANALITICKIND1,
                     q.t_ID AS T_ANALITIC1,
                     RSI_NPTXC.TXOBJ_KIND3020 AS T_ANALITICKIND3,
                     q.t_FIID AS T_ANALITIC3,
                     RSI_NPTXC.TXOBJ_KIND4010 AS T_ANALITICKIND4,
                     RSI_NPTXC.NPTX_FI_CIRCULATE AS T_ANALITIC4,
                     RSI_NPTXC.TXOBJ_KIND5010 AS T_ANALITICKIND5,
                     q.TaxGroup AS T_ANALITIC5,
                     RSI_NPTXC.TXOBJ_KIND6020 AS T_ANALITICKIND6,
                     q.t_ClientContr AS T_ANALITIC6,
                     'Уплаченная премия по опционам' AS T_COMMENT,
                     q.t_ID AS ID
                FROM q
               WHERE q.t_PaidBonus <> 0
               UNION ALL
               SELECT q_c.t_Date AS T_DATE,
                      RSI_NPTXC.TXOBJ_DIR_OUT AS T_DIRECTION,
                      RSI_NPTXC.TXOBJ_COM AS T_KIND,
                      q_c.t_Sum AS T_SUM,
                      q_c.ComFIID AS T_CUR,
                      RSI_NPTXC.TXOBJ_KIND1040 AS T_ANALITICKIND1,
                      q_c.FitID AS T_ANALITIC1,
                      RSI_NPTXC.TXOBJ_KIND3020 AS T_ANALITICKIND3,
                      q_c.t_FIID AS T_ANALITIC3,
                      RSI_NPTXC.TXOBJ_KIND4010 AS T_ANALITICKIND4,
                      RSI_NPTXC.NPTX_FI_CIRCULATE AS T_ANALITIC4,
                      RSI_NPTXC.TXOBJ_KIND5010 AS T_ANALITICKIND5,
                      q_c.FitTaxGroup AS T_ANALITIC5,
                      RSI_NPTXC.TXOBJ_KIND6020 AS T_ANALITICKIND6,
                      q_c.t_ClientContr AS T_ANALITIC6,
                      (CASE WHEN q_c.t_ReceiverID = RSBSESSIONDATA.OurBank THEN 'Комиссия банка по ПИ' ELSE 'Комиссия биржи/брокера по ПИ' END) AS T_COMMENT,
                      q_c.FitID AS ID
                 FROM q_c
                WHERE q_c.t_Sum <> 0
               UNION ALL
               SELECT q.t_Date AS T_DATE,
                      (CASE WHEN (RSI_RSB_FIInstr.ConvSum(q.TotalMargin + q.t_ReceivedBonus - q.t_PaidBonus, q.Currency, RSI_RSB_FIInstr.NATCUR, q.t_Date) 
                                 - (SELECT NVL(SUM(q_c.SumNat), 0) FROM q_c WHERE q_c.FitID = q.t_ID)) > 0 THEN RSI_NPTXC.TXOBJ_DIR_IN ELSE RSI_NPTXC.TXOBJ_DIR_OUT END) AS T_DIRECTION,
                      RSI_NPTXC.TXOBJ_FR_DERIV AS T_KIND,
                      ABS(RSI_RSB_FIInstr.ConvSum(q.TotalMargin + q.t_ReceivedBonus - q.t_PaidBonus, q.Currency, RSI_RSB_FIInstr.NATCUR, q.t_Date) 
                          - (SELECT NVL(SUM(q_c.SumNat), 0) FROM q_c WHERE q_c.FitID = q.t_ID)) AS T_SUM,
                      RSI_RSB_FIInstr.NATCUR AS T_CUR,
                      RSI_NPTXC.TXOBJ_KIND1040 AS T_ANALITICKIND1,
                      q.t_ID AS T_ANALITIC1,
                      RSI_NPTXC.TXOBJ_KIND3020 AS T_ANALITICKIND3,
                      q.t_FIID AS T_ANALITIC3,
                      RSI_NPTXC.TXOBJ_KIND4010 AS T_ANALITICKIND4,
                      RSI_NPTXC.NPTX_FI_CIRCULATE AS T_ANALITIC4,
                      RSI_NPTXC.TXOBJ_KIND5010 AS T_ANALITICKIND5,
                      q.TaxGroup AS T_ANALITIC5,
                      RSI_NPTXC.TXOBJ_KIND6020 AS T_ANALITICKIND6,
                      q.t_ClientContr AS T_ANALITIC6,
                      'Финансовый результат' AS T_COMMENT,
                      q.t_ID AS ID
                 FROM q
             /*  UNION ALL
               SELECT q_enforcementpay.t_PayDate AS T_DATE,
                     (CASE WHEN q_enforcementpay.t_EnforcementPay < 0 THEN RSI_NPTXC.TXOBJ_DIR_OUT ELSE RSI_NPTXC.TXOBJ_DIR_IN END) AS T_DIRECTION,
                     RSI_NPTXC.TXOBJ_VAR AS T_KIND,
                     ABS(q_enforcementpay.t_EnforcementPay) AS T_SUM,
                     RSI_RSB_FIInstr.NATCUR AS T_CUR,
                     RSI_NPTXC.TXOBJ_KIND1040 AS T_ANALITICKIND1,
                     q_enforcementpay.t_ID AS T_ANALITIC1,
                     RSI_NPTXC.TXOBJ_KIND3020 AS T_ANALITICKIND3,
                     q_enforcementpay.t_FIID AS T_ANALITIC3,
                     RSI_NPTXC.TXOBJ_KIND4010 AS T_ANALITICKIND4,
                     RSI_NPTXC.NPTX_FI_CIRCULATE AS T_ANALITIC4,
                     RSI_NPTXC.TXOBJ_KIND5010 AS T_ANALITICKIND5,
                     q_enforcementpay.TaxGroup AS T_ANALITIC5,
                     RSI_NPTXC.TXOBJ_KIND6020 AS T_ANALITICKIND6,
                     q_enforcementpay.t_ClientContr AS T_ANALITIC6,
                     'Платеж по вечн.фьюч' AS T_COMMENT,
                     q_enforcementpay.t_ID AS ID
                FROM q_enforcementpay */
              ) qq
       WHERE qq.T_SUM <> 0
    ORDER BY qq.T_DATE, qq.ID;

    BEGIN

    pStat := 0;

    IF pFIID = -1 THEN
      OPEN LIST_OBJ;
      LOOP
          FETCH LIST_OBJ BULK COLLECT INTO v_nptxobj LIMIT g_Limit;
          EXIT WHEN v_nptxobj.COUNT = 0;

            FORALL indx IN v_nptxobj.FIRST .. v_nptxobj.LAST
               INSERT INTO DNPTXOBJ_TMP
                    VALUES v_nptxobj(indx);

          EXIT WHEN LIST_OBJ%NOTFOUND;
      END LOOP;
      CLOSE LIST_OBJ;
    END IF;

  END;

  --Расчет объектов НДР по внебиржевым сделкам ПИ
  PROCEDURE CreateTaxObjects1_22(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS
    v_nptxobj    nptxobj_t;

    CURSOR LIST_OBJ
    IS

      SELECT 0,                  --T_ID,
             1,                  --T_FUNCTIONKIND,
             qq.T_DATE,
             pClient,            --T_CLIENT,
             qq.T_DIRECTION,
             1,                  --T_LEVEL,
             CHR(0),             --T_USER,
             qq.T_KIND,
             qq.T_SUM,
             qq.T_CUR,
             qq.T_ANALITICKIND1,
             qq.T_ANALITIC1,
             0,                  --T_ANALITICKIND2,
             -1,                 --T_ANALITIC2,
             qq.T_ANALITICKIND3,
             qq.T_ANALITIC3,
             qq.T_ANALITICKIND4,
             qq.T_ANALITIC4,
             qq.T_ANALITICKIND5,
             qq.T_ANALITIC5,
             qq.T_ANALITICKIND6,    
             qq.T_ANALITIC6,
             qq.T_COMMENT,
             pDocID,             --T_DOCID,
             pStep,              --T_STEP,
             0,                  --T_REESTRSUM,
             CHR(0),             --T_FROMOUTSYST,
             CHR(1),             --T_OUTSYSTCODE,
             CHR(1),             --T_OUTOBJID,
             0,                  --T_SOURCEOBJID
             CHR(0) AS T_TECHNICAL,
             RSI_NPTXC.NPTXBC_ACTION_CREATE,
             0,
             g_ZeroDate,
             0,
             g_ZeroDate,
             0,
             0,
             CHR(0)
        FROM (WITH q
                   AS (SELECT s.*,
                              (CASE WHEN s.BaseFI_KIND = RSI_RSB_FIINSTR.FIKIND_AVOIRISS OR s.BaseFI_KIND = RSI_RSB_FIINSTR.FIKIND_INDEX THEN RSI_NPTXC.TXGROUP_80 ELSE RSI_NPTXC.TXGROUP_90 END) as TaxGroup
                         FROM (SELECT D.t_ID, D.t_Forvard, D.t_DVKind, D.t_Type, D.t_ClientContr,
                                      (CASE WHEN D.t_Forvard = 'X' THEN 1 /*DV_NFIType_Forward*/ ELSE 0 /*DV_NFIType_BaseActiv*/ END) as NFIType,
                                      (CASE WHEN FIN.t_FI_Kind = RSI_NPTXC.FIKIND_DERIVATIVE THEN FIN.t_FaceValueFI
                                            ELSE NFI.t_FIID END) AS BaseFIID,
                                      (CASE WHEN D.t_DVKind = RSB_DERIVATIVES.DV_CURSWAP OR D.t_DVKind = RSB_DERIVATIVES.DV_PCTSWAP THEN RSI_RSB_FIINSTR.FIKIND_CURRENCY
                                            ELSE FIN.t_FaceValueFI END) AS BaseFI_KIND
                                 FROM DDVNDEAL_DBT D, DDVNFI_DBT NFI, DFININSTR_DBT FIN 
                                WHERE D.t_Client = pClient
                                  AND RSI_NPTO.CheckContrIIS(D.t_ClientContr) = pIIS
                                  AND ((pContract IS NULL) OR (pContract <= 0) OR (D.t_ClientContr in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                                  AND EXISTS ( SELECT P.t_PaymentID 
                                                 FROM DPMPAYM_DBT P 
                                                WHERE P.T_DOCKIND = RSB_SECUR.DL_DVNDEAL
                                                  AND P.T_DOCUMENTID = D.T_ID 
                                                  AND P.T_PAYMSTATUS = PM_COMMON.PM_FINISHED 
                                                  AND P.T_PURPOSE in(70 /*Учет вариационной маржи*/,6 /*Платеж премии по опциону*/)     /*Изменение РСХБ, перенесенное в дистрибутив  - PDV 516031 Не брать комиссию по сделкам "СпецСВОП"*/
                                                  AND P.t_ValueDate >= pBegDate
                                                  AND P.t_ValueDate <= pEndDate
                                             ) 
                                  AND NFI.t_DealID = D.t_ID
                                  AND NFI.t_Type = (CASE WHEN D.t_Forvard = 'X' THEN 1 /*DV_NFIType_Forward*/ ELSE 0 /*DV_NFIType_BaseActiv*/ END)
                                  AND FIN.T_FIID = NFI.t_FIID
                              ) s
                        WHERE 1 = (CASE WHEN pFIID = -1 THEN 1
                                        WHEN s.BaseFI_KIND = RSI_RSB_FIINSTR.FIKIND_AVOIRISS AND s.BaseFIID = pFIID THEN 1
                                        ELSE 0 END) 
                      ),
                   pm_var AS (SELECT q.t_ID, pm.t_ValueDate, pm.t_Receiver, pm.t_OrderAmount, pm.t_OrderFIID,
                                     RSI_RSB_FIInstr.ConvSum(pm.t_OrderAmount, pm.t_OrderFIID, RSI_RSB_FIInstr.NATCUR, pm.t_ValueDate) as OrderAmountNat 
                                FROM q, dpmpaym_dbt pm
                               WHERE pm.t_DocKind    = RSB_SECUR.DL_DVNDEAL
                                 AND pm.t_DocumentID = q.t_ID
                                 AND pm.t_PaymStatus = PM_COMMON.PM_FINISHED
                                 AND pm.t_Purpose    = 70 /*Учет вариационной маржи*/
                                 AND pm.t_ValueDate >= pBegDate
                                 AND pm.t_ValueDate <= pEndDate),
                   pm_pri AS (SELECT q.t_ID, pm.t_ValueDate, pm.t_Receiver, pm.t_OrderAmount, pm.t_OrderFIID,
                                     RSI_RSB_FIInstr.ConvSum(pm.t_OrderAmount, pm.t_OrderFIID, RSI_RSB_FIInstr.NATCUR, pm.t_ValueDate) as OrderAmountNat 
                                FROM q, dpmpaym_dbt pm
                               WHERE pm.t_DocKind    = RSB_SECUR.DL_DVNDEAL
                                 AND pm.t_DocumentID = q.t_ID
                                 AND pm.t_PaymStatus = PM_COMMON.PM_FINISHED
                                 AND pm.t_Purpose    = 6 /*Платеж премии по опциону*/
                                 AND pm.t_ValueDate >= pBegDate
                                 AND pm.t_ValueDate <= pEndDate),
                   pm_com AS (SELECT q.t_ID, pm.t_ValueDate, pm.t_Receiver, pm.t_OrderAmount, pm.t_OrderFIID, pm.t_Purpose,
                                     RSI_RSB_FIInstr.ConvSum(pm.t_OrderAmount, pm.t_OrderFIID, RSI_RSB_FIInstr.NATCUR, pm.t_ValueDate) as OrderAmountNat 
                                FROM q, dpmpaym_dbt pm
                               WHERE pm.t_DocKind    = RSB_SECUR.DL_DVNDEAL
                                 AND pm.t_DocumentID = q.t_ID
                                 AND pm.t_PaymStatus = PM_COMMON.PM_FINISHED
                                 AND pm.t_Purpose    IN (72/*Комиссия Банку*/, 41 /*Комиссия брокеру*/)
                                 AND pm.t_ValueDate >= pBegDate
                                 AND pm.t_ValueDate <= pEndDate)
              SELECT pm_var.t_ValueDate AS T_DATE,
                     (CASE WHEN pm_var.t_Receiver = pClient THEN RSI_NPTXC.TXOBJ_DIR_IN ELSE RSI_NPTXC.TXOBJ_DIR_OUT END) AS T_DIRECTION,
                     RSI_NPTXC.TXOBJ_VAR AS T_KIND,
                     pm_var.t_OrderAmount AS T_SUM,
                     pm_var.t_OrderFIID AS T_CUR,
                     RSI_NPTXC.TXOBJ_KIND1090 AS T_ANALITICKIND1,
                     q.t_ID AS T_ANALITIC1,
                     (CASE WHEN q.BaseFI_KIND = RSI_RSB_FIINSTR.FIKIND_AVOIRISS THEN RSI_NPTXC.TXOBJ_KIND3010 ELSE RSI_NPTXC.TXOBJ_KIND3020 END) AS T_ANALITICKIND3,
                     q.BaseFIID AS T_ANALITIC3,
                     RSI_NPTXC.TXOBJ_KIND4010 AS T_ANALITICKIND4,
                     RSI_NPTXC.NPTX_FI_NOCIRCULATE AS T_ANALITIC4,
                     RSI_NPTXC.TXOBJ_KIND5010 AS T_ANALITICKIND5,
                     q.TaxGroup AS T_ANALITIC5,
                     RSI_NPTXC.TXOBJ_KIND6020 AS T_ANALITICKIND6,
                     q.t_ClientContr AS T_ANALITIC6,
                     'Вариационная маржа' AS T_COMMENT,
                     q.t_ID AS ID
                FROM q, pm_var
               WHERE pm_var.t_ID = q.t_ID
              UNION ALL
              SELECT pm_pri.t_ValueDate AS T_DATE,
                     (CASE WHEN q.t_Type = RSB_DERIVATIVES.ALG_DV_SALE THEN RSI_NPTXC.TXOBJ_DIR_IN ELSE RSI_NPTXC.TXOBJ_DIR_OUT END) AS T_DIRECTION,
                     RSI_NPTXC.TXOBJ_PREM AS T_KIND,
                     pm_pri.t_OrderAmount AS T_SUM,
                     pm_pri.t_OrderFIID AS T_CUR,
                     RSI_NPTXC.TXOBJ_KIND1090 AS T_ANALITICKIND1,
                     q.t_ID AS T_ANALITIC1,
                     (CASE WHEN q.BaseFI_KIND = RSI_RSB_FIINSTR.FIKIND_AVOIRISS THEN RSI_NPTXC.TXOBJ_KIND3010 ELSE RSI_NPTXC.TXOBJ_KIND3020 END) AS T_ANALITICKIND3,
                     q.BaseFIID AS T_ANALITIC3,
                     RSI_NPTXC.TXOBJ_KIND4010 AS T_ANALITICKIND4,
                     RSI_NPTXC.NPTX_FI_NOCIRCULATE AS T_ANALITIC4,
                     RSI_NPTXC.TXOBJ_KIND5010 AS T_ANALITICKIND5,
                     q.TaxGroup AS T_ANALITIC5,
                     RSI_NPTXC.TXOBJ_KIND6020 AS T_ANALITICKIND6,
                     q.t_ClientContr AS T_ANALITIC6,
                     (CASE WHEN q.t_Type = RSB_DERIVATIVES.ALG_DV_SALE THEN 'Полученная премия по опционам' ELSE 'Уплаченная премия по опционам' END) AS T_COMMENT,
                     q.t_ID AS ID
                FROM q, pm_pri
               WHERE q.t_DVKind = RSB_DERIVATIVES.DV_OPTION
                 AND pm_pri.t_ID = q.t_ID
              UNION ALL
              SELECT pm_com.t_ValueDate AS T_DATE,
                     RSI_NPTXC.TXOBJ_DIR_OUT AS T_DIRECTION,
                     RSI_NPTXC.TXOBJ_COM AS T_KIND,
                     pm_com.t_OrderAmount AS T_SUM,
                     pm_com.t_OrderFIID AS T_CUR,
                     RSI_NPTXC.TXOBJ_KIND1090 AS T_ANALITICKIND1,
                     q.t_ID AS T_ANALITIC1,
                     (CASE WHEN q.BaseFI_KIND = RSI_RSB_FIINSTR.FIKIND_AVOIRISS THEN RSI_NPTXC.TXOBJ_KIND3010 ELSE RSI_NPTXC.TXOBJ_KIND3020 END) AS T_ANALITICKIND3,
                     q.BaseFIID AS T_ANALITIC3,
                     RSI_NPTXC.TXOBJ_KIND4010 AS T_ANALITICKIND4,
                     RSI_NPTXC.NPTX_FI_NOCIRCULATE AS T_ANALITIC4,
                     RSI_NPTXC.TXOBJ_KIND5010 AS T_ANALITICKIND5,
                     q.TaxGroup AS T_ANALITIC5,
                     RSI_NPTXC.TXOBJ_KIND6020 AS T_ANALITICKIND6,
                     q.t_ClientContr AS T_ANALITIC6,
                     (CASE WHEN pm_com.t_Purpose = 72/*Комиссия Банку*/ THEN 'Комиссия банка по ПИ' ELSE 'Комиссия посреднику по ПИ' END) AS T_COMMENT,
                     q.t_ID AS ID
                FROM q, pm_com
               WHERE pm_com.t_ID = q.t_ID
              UNION ALL
              SELECT pEndDate AS T_DATE,
                     (CASE WHEN ((SELECT NVL(SUM(pm1.OrderAmountNat * (CASE WHEN pm1.t_Receiver = pClient THEN 1 ELSE -1 END)), 0) FROM pm_var pm1 WHERE pm1.t_ID = q.t_ID) +
                                 (CASE WHEN q.t_DVKind = RSB_DERIVATIVES.DV_OPTION THEN (SELECT NVL(SUM(pm2.OrderAmountNat * (CASE WHEN q.t_Type = RSB_DERIVATIVES.ALG_DV_SALE THEN 1 ELSE -1 END)), 0) FROM pm_pri pm2 WHERE pm2.t_ID = q.t_ID) ELSE 0 END) -
                                 (SELECT NVL(SUM(pm3.OrderAmountNat), 0) FROM pm_com pm3 WHERE pm3.t_ID = q.t_ID)
                                ) > 0 THEN RSI_NPTXC.TXOBJ_DIR_IN ELSE RSI_NPTXC.TXOBJ_DIR_OUT END) AS T_DIRECTION,
                     RSI_NPTXC.TXOBJ_FR_DERIV AS T_KIND,
                     ABS((SELECT NVL(SUM(pm1.OrderAmountNat * (CASE WHEN pm1.t_Receiver = pClient THEN 1 ELSE -1 END)), 0) FROM pm_var pm1 WHERE pm1.t_ID = q.t_ID) +
                         (CASE WHEN q.t_DVKind = RSB_DERIVATIVES.DV_OPTION THEN (SELECT NVL(SUM(pm2.OrderAmountNat * (CASE WHEN q.t_Type = RSB_DERIVATIVES.ALG_DV_SALE THEN 1 ELSE -1 END)), 0) FROM pm_pri pm2 WHERE pm2.t_ID = q.t_ID) ELSE 0 END) -
                         (SELECT NVL(SUM(pm3.OrderAmountNat), 0) FROM pm_com pm3 WHERE pm3.t_ID = q.t_ID)
                        ) AS T_SUM,
                     RSI_RSB_FIInstr.NATCUR AS T_CUR,
                     RSI_NPTXC.TXOBJ_KIND1090 AS T_ANALITICKIND1,
                     q.t_ID AS T_ANALITIC1,
                     (CASE WHEN q.BaseFI_KIND = RSI_RSB_FIINSTR.FIKIND_AVOIRISS THEN RSI_NPTXC.TXOBJ_KIND3010 ELSE RSI_NPTXC.TXOBJ_KIND3020 END) AS T_ANALITICKIND3,
                     q.BaseFIID AS T_ANALITIC3,
                     RSI_NPTXC.TXOBJ_KIND4010 AS T_ANALITICKIND4,
                     RSI_NPTXC.NPTX_FI_NOCIRCULATE AS T_ANALITIC4,
                     RSI_NPTXC.TXOBJ_KIND5010 AS T_ANALITICKIND5,
                     q.TaxGroup AS T_ANALITIC5,
                     RSI_NPTXC.TXOBJ_KIND6020 AS T_ANALITICKIND6,
                     q.t_ClientContr AS T_ANALITIC6,
                     'Финансовый результат' AS T_COMMENT,
                     q.t_ID AS ID
                FROM q
              ) qq
       WHERE qq.T_SUM <> 0
    ORDER BY qq.T_DATE, qq.ID;

    BEGIN

    pStat := 0;

    OPEN LIST_OBJ;
    LOOP
        FETCH LIST_OBJ BULK COLLECT INTO v_nptxobj LIMIT g_Limit;
        EXIT WHEN v_nptxobj.COUNT = 0;

          FORALL indx IN v_nptxobj.FIRST .. v_nptxobj.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES v_nptxobj(indx);

        EXIT WHEN LIST_OBJ%NOTFOUND;
    END LOOP;
    CLOSE LIST_OBJ;

  END;

  FUNCTION GetAllSummMaterial_1(p_DocKind        IN NUMBER,
                                p_DealID         IN NUMBER,
                                p_Principal      IN NUMBER,
                                p_PFI            IN NUMBER,
                                p_CFI            IN NUMBER,
                                p_Price          IN NUMBER,
                                p_DealDate       IN DATE,
                                p_FactDate       IN DATE,
                                p_AvFactDate     IN DATE,
                                p_RelativePrice  IN NUMBER,
                                p_MinMarketPrice IN NUMBER,
                                p_EndDate        IN DATE,
                                p_Client         IN NUMBER,
                                p_FaceValueFI    IN NUMBER 
                               ) RETURN NUMBER
  AS
    v_AllSumm NUMBER := 0;

    v_PrDeal  NUMBER;
    v_KN      NUMBER;
    v_K       NUMBER;

    v_SCB1    NUMBER := 0;                         
    v_SCB2    NUMBER := 0;
    v_SCB     NUMBER;

  BEGIN

    FOR one_rec IN (SELECT Comis.t_Sum, M.T_FIID_COMM, Comis.t_FactPayDate, Comis.t_DocKind, Comis.t_DocID, Contr.T_ID, Comis.T_PLANPAYDATE  
                      FROM DNPTXCOMM_TMP Comis, DSFCOMISS_DBT M, DSFCONTR_DBT Contr 
                     WHERE Comis.t_DocKind = p_DocKind 
                       AND Comis.t_DocID   = p_DealID
                       AND Contr.T_ID      = Comis.T_Contract 
                       AND Contr.T_PARTYID = p_Client
                       AND Comis.t_FactPayDate <= p_EndDate
                       AND M.T_FEETYPE          = Comis.T_FEETYPE   
                       AND M.T_NUMBER           = Comis.T_COMNUMBER
                    )
    LOOP
      IF TaxDepositoryMode <> 0 OR RSB_SECUR.CheckExistGrDealByCom(one_rec.t_DocKind, one_rec.t_DocID, one_rec.T_ID, one_rec.T_PLANPAYDATE, RSI_DLGR.DLGRACC_STATE_PLAN) = 0 THEN
        v_SCB1 := v_SCB1 + NVL(RSB_FIInstr.ConvSum(one_rec.t_Sum, one_rec.T_FIID_COMM, RSI_RSB_FIInstr.NATCUR, one_rec.t_FactPayDate),0);
      END IF;

    END LOOP;

    FOR one_rec IN (SELECT dls.t_Date, dls.t_Sum, dls.t_Currency
                      FROM ddlsum_dbt dls
                     WHERE dls.t_DocKind = p_DocKind
                       AND dls.t_DocId = p_DealID
                       AND dls.t_Kind = RSI_NPTXC.DLSUM_KIND_OUTLAYWRTTAX)
    LOOP
      v_SCB1 := v_SCB1 + NVL(RSB_FIInstr.ConvSum(one_rec.t_Sum, one_rec.t_Currency, RSI_RSB_FIInstr.NATCUR, one_rec.t_Date),0);
    END LOOP;

    FOR one_rec IN (SELECT BasObj.t_CommSum, DefCom.t_FIID_commSum, DefCom.t_DatePay 
                      FROM dsfbasobj_dbt BasObj, dsfdefcom_dbt DefCom, dsfcomiss_dbt comiss, ddl_tick_dbt Tick, DSFCONTR_DBT Contr 
                     WHERE Tick.t_DealID      = p_DealID
                       AND Tick.t_BOfficeKind = p_DocKind
                       AND DefCom.t_ConID     = Contr.T_ID 
                       AND Contr.T_PARTYID    = p_Client
                       AND ((Contr.T_PARTYID = Tick.t_ClientID) OR (Tick.t_IsPartyClient = 'X' AND Contr.T_PARTYID = Tick.t_PartyID)) 
                       AND DefCom.t_DatePay             <= p_EndDate 
                       AND comiss.t_feeType              = DefCom.t_feeType 
                       AND comiss.t_number               = DefCom.t_commNumber 
                       AND comiss.t_FormAlg              = 2 /*SFCOMISS_FORMALG_MANUAL*/
                       AND comiss.t_feeType              = 1 /*SF_FEE_TYPE_PERIOD*/     
                       AND BasObj.t_FeeType              = comiss.t_feeType 
                       AND BasObj.t_DefCommID            = DefCom.t_ID 
                       AND BasObj.t_BaseObjectType       = Tick.t_BOfficeKind 
                       AND BasObj.t_BaseObjectID         = Tick.t_DealID 
                       AND BasObj.t_AccountedInIncluded <> 1
                    )
    LOOP
      v_SCB2 := v_SCB2 + NVL(RSB_FIInstr.ConvSum(one_rec.t_CommSum, one_rec.t_FIID_commSum, RSI_RSB_FIInstr.NATCUR, one_rec.t_DatePay),0);
    END LOOP;
    
    v_SCB  := v_SCB1 + v_SCB2;
    
    v_PrDeal := PrDeal(p_DocKind, p_DealID, p_PFI, p_CFI, p_Price, p_DealDate, p_FactDate, p_RelativePrice);

    v_KN := KN(p_PFI, p_AvFactDate);

    v_K := K(p_FaceValueFI, p_AvFactDate);

    IF (v_PrDeal * p_Principal * v_K + v_SCB) < (p_MinMarketPrice * v_KN * p_Principal * v_K) THEN
      v_AllSumm := (p_MinMarketPrice * v_KN - v_PrDeal) * p_Principal * v_K - v_SCB;
    END IF;

    RETURN v_AllSumm;
  END;


  --Расчет объектов НДР по материальной выгоде
  PROCEDURE CreateMaterialTaxObjects1_1(pBegDate   IN DATE,
                                        pEndDate   IN DATE,
                                        pClient    IN NUMBER,
                                        pIIS       IN NUMBER,
                                        pDocID     IN NUMBER,
                                        pStep      IN NUMBER,
                                        pFIID      IN NUMBER,
                                        pContract  IN NUMBER,
                                        pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

    v_Sum NUMBER;
    v_Market VARCHAR2(100);
    v_MinMarketPrice NUMBER;

    v_StartDate DATE;

  BEGIN

    pStat := 0;

    v_StartDate := to_date(RSB_COMMON.GetRegStrValue('COMMON\НДФЛ\ДАТА_ЛЬГОТЫ_ПО_МАТВЫГОДЕ'), 'dd.mm.yyyy');

    FOR one_rec IN (SELECT *
                    FROM ( 
                            WITH sf AS (SELECT t_ID, t_PartyID 
                                       FROM dsfcontr_dbt 
                                        WHERE t_PartyID = pClient
                                          AND t_ServKind = RSI_NPTO.PTSK_STOCKDL
                                          AND (EXTRACT(YEAR FROM pEndDate) >= RSI_NPTO.GetLucreStartTaxPeriod() OR RSI_NPTO.CheckContrIIS(t_ID) = pIIS)
                                          AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                                       )
                            SELECT RQ.t_FactDate AvFactDate,  
                                   RQ.t_FactDate t_FactDate, RQ.t_DocKind, Leg.t_CFI, Leg.t_PFI, Leg.t_Price, Leg.t_Principal, Leg.t_RelativePrice, 
                                   Fin.t_FaceValueFI, Tick.t_DealID, Tick.t_DealDate, 
                                   Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID,
                                   Opr.IsRepo, Opr.IsLoan   
                            FROM sf, ddl_tick_dbt Tick, ddlrq_dbt RQ, ddl_leg_dbt Leg, dfininstr_dbt Fin, 
                                 (SELECT t_Kind_Operation, 
                                              Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(t_SysTypes)) IsBuy,
                                              Rsb_Secur.IsSale(rsb_secur.get_OperationGroup(t_SysTypes)) IsSale,
                                              Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(t_SysTypes)) IsRepo,
                                              Rsb_Secur.IsLoan(rsb_secur.get_OperationGroup(t_SysTypes)) IsLoan 
                                  FROM doprkoper_dbt WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC) Opr 
                            WHERE Tick.t_BOfficeKind = RSB_SECUR.DL_SECURITYDOC
                              AND Tick.t_DealDate < TO_DATE('01.01.2016','DD.MM.YYYY')
                              AND Tick.t_ClientID = sf.t_PartyID AND Tick.t_ClientContrID = sf.t_ID AND Opr.IsBuy = 1 
                              AND RQ.t_DocKind    = Tick.t_BOfficeKind
                              AND RQ.t_DocID      = Tick.t_DealID
                              AND RQ.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC 
                              AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_DELIVERY
                              AND RQ.t_DealPart   = 1 
                              AND RQ.t_FactDate   BETWEEN pBegDate AND pEndDate
                              AND Opr.t_Kind_Operation = Tick.t_DealType 
                              AND Leg.t_DealID    = Tick.t_DealID 
                              AND Leg.t_LegID     = 0 
                              AND Leg.t_LegKind   = 0 
                              AND Leg.t_PFI       = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                              AND Fin.t_FIID      = Leg.t_PFI 
                            UNION ALL
                            SELECT RQ.t_FactDate AvFactDate,  
                                   (CASE WHEN RQ.t_FactDate < PM.t_FactDate THEN PM.t_FactDate ELSE RQ.t_FactDate END) t_FactDate, 
                                   RQ.t_DocKind, Leg.t_CFI, Leg.t_PFI, Leg.t_Price, Leg.t_Principal, Leg.t_RelativePrice, 
                                   Fin.t_FaceValueFI, Tick.t_DealID, Tick.t_DealDate, 
                                   Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID,
                                   Opr.IsRepo, Opr.IsLoan   
                            FROM sf, ddl_tick_dbt Tick, ddlrq_dbt RQ, ddl_leg_dbt Leg, dfininstr_dbt Fin, 
                                 (SELECT t_Kind_Operation, 
                                         Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(t_SysTypes)) IsBuy,
                                         Rsb_Secur.IsSale(rsb_secur.get_OperationGroup(t_SysTypes)) IsSale,
                                         Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(t_SysTypes)) IsRepo,
                                         Rsb_Secur.IsLoan(rsb_secur.get_OperationGroup(t_SysTypes)) IsLoan 
                                  FROM doprkoper_dbt WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC) Opr, ddlrq_dbt PM 
                            WHERE Tick.t_BOfficeKind = RSB_SECUR.DL_SECURITYDOC
                              AND Tick.t_DealDate >= TO_DATE('01.01.2016','DD.MM.YYYY')
                              AND Tick.t_DealDate <= pEndDate
                              AND Tick.t_ClientID = sf.t_PartyID AND Tick.t_ClientContrID = sf.t_ID AND Opr.IsBuy = 1 
                              AND RQ.t_DocKind    = Tick.t_BOfficeKind
                              AND RQ.t_DocID      = Tick.t_DealID
                              AND RQ.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC 
                              AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_DELIVERY
                              AND RQ.t_DealPart   = 1 
                              AND Opr.t_Kind_Operation = Tick.t_DealType 
                              AND Leg.t_DealID    = Tick.t_DealID 
                              AND Leg.t_LegID     = 0 
                              AND Leg.t_LegKind   = 0 
                              AND Leg.t_PFI       = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                              AND Fin.t_FIID      = Leg.t_PFI 
                              AND PM.t_DocID      = Tick.t_DealID 
                              AND PM.t_DocKind    = Tick.t_BOfficeKind 
                              AND PM.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC
                              AND PM.t_Type       = RSI_DLRQ.DLRQ_TYPE_PAYMENT 
                              AND PM.t_DealPart   = 1 
                              AND (RQ.t_FactDate BETWEEN pBegDate AND pEndDate OR PM.t_FactDate BETWEEN pBegDate AND pEndDate)
                              AND (CASE WHEN RQ.t_FactDate < PM.t_FactDate THEN PM.t_FactDate ELSE RQ.t_FactDate END) BETWEEN pBegDate AND pEndDate
                            UNION ALL
                            SELECT RQ.t_FactDate AvFactDate,  
                                   RQ.t_FactDate t_FactDate, RQ.t_DocKind, Leg.t_CFI, Leg.t_PFI, Leg.t_Price, Leg.t_Principal, Leg.t_RelativePrice, 
                                   Fin.t_FaceValueFI, Tick.t_DealID, Tick.t_DealDate, 
                                   Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID,
                                   Opr.IsRepo, Opr.IsLoan   
                            FROM sf, ddl_tick_dbt Tick, ddlrq_dbt RQ, ddl_leg_dbt Leg, dfininstr_dbt Fin, 
                                 (SELECT t_Kind_Operation, 
                                              Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(t_SysTypes)) IsBuy,
                                              Rsb_Secur.IsSale(rsb_secur.get_OperationGroup(t_SysTypes)) IsSale,
                                              Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(t_SysTypes)) IsRepo,
                                              Rsb_Secur.IsLoan(rsb_secur.get_OperationGroup(t_SysTypes)) IsLoan 
                                  FROM doprkoper_dbt WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC) Opr 
                            WHERE Tick.t_BOfficeKind = RSB_SECUR.DL_SECURITYDOC
                              AND Tick.t_DealDate < TO_DATE('01.01.2016','DD.MM.YYYY')
                              AND Tick.t_PartyID = sf.t_PartyID AND Tick.t_IsPartyClient = 'X' AND Tick.t_PartyContrID = sf.t_ID AND Opr.IsSale = 1 
                              AND RQ.t_DocKind    = Tick.t_BOfficeKind
                              AND RQ.t_DocID      = Tick.t_DealID
                              AND RQ.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC 
                              AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_DELIVERY
                              AND RQ.t_DealPart   = 1 
                              AND RQ.t_FactDate   BETWEEN pBegDate AND pEndDate
                              AND Opr.t_Kind_Operation = Tick.t_DealType 
                              AND Leg.t_DealID    = Tick.t_DealID 
                              AND Leg.t_LegID     = 0 
                              AND Leg.t_LegKind   = 0 
                              AND Leg.t_PFI       = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                              AND Fin.t_FIID      = Leg.t_PFI 
                            UNION ALL
                            SELECT RQ.t_FactDate AvFactDate,  
                                   (CASE WHEN RQ.t_FactDate < PM.t_FactDate THEN PM.t_FactDate ELSE RQ.t_FactDate END) t_FactDate, 
                                   RQ.t_DocKind, Leg.t_CFI, Leg.t_PFI, Leg.t_Price, Leg.t_Principal, Leg.t_RelativePrice, 
                                   Fin.t_FaceValueFI, Tick.t_DealID, Tick.t_DealDate, 
                                   Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID,
                                   Opr.IsRepo, Opr.IsLoan   
                            FROM sf, ddl_tick_dbt Tick, ddlrq_dbt RQ, ddl_leg_dbt Leg, dfininstr_dbt Fin, 
                                 (SELECT t_Kind_Operation, 
                                         Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(t_SysTypes)) IsBuy,
                                         Rsb_Secur.IsSale(rsb_secur.get_OperationGroup(t_SysTypes)) IsSale,
                                         Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(t_SysTypes)) IsRepo,
                                         Rsb_Secur.IsLoan(rsb_secur.get_OperationGroup(t_SysTypes)) IsLoan 
                                  FROM doprkoper_dbt WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC) Opr, ddlrq_dbt PM 
                            WHERE Tick.t_BOfficeKind = RSB_SECUR.DL_SECURITYDOC
                              AND Tick.t_DealDate >= TO_DATE('01.01.2016','DD.MM.YYYY')
                              AND Tick.t_DealDate <= pEndDate
                              AND Tick.t_PartyID = sf.t_PartyID AND Tick.t_IsPartyClient = 'X' AND Tick.t_PartyContrID = sf.t_ID AND Opr.IsSale = 1 
                              AND RQ.t_DocKind    = Tick.t_BOfficeKind
                              AND RQ.t_DocID      = Tick.t_DealID
                              AND RQ.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC 
                              AND RQ.t_Type       = RSI_DLRQ.DLRQ_TYPE_DELIVERY
                              AND RQ.t_DealPart   = 1 
                              AND Opr.t_Kind_Operation = Tick.t_DealType 
                              AND Leg.t_DealID    = Tick.t_DealID 
                              AND Leg.t_LegID     = 0 
                              AND Leg.t_LegKind   = 0 
                              AND Leg.t_PFI       = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                              AND Fin.t_FIID      = Leg.t_PFI 
                              AND PM.t_DocID      = Tick.t_DealID 
                              AND PM.t_DocKind    = Tick.t_BOfficeKind 
                              AND PM.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC
                              AND PM.t_Type       = RSI_DLRQ.DLRQ_TYPE_PAYMENT 
                              AND PM.t_DealPart   = 1 
                              AND (RQ.t_FactDate BETWEEN pBegDate AND pEndDate OR PM.t_FactDate BETWEEN pBegDate AND pEndDate)
                              AND (CASE WHEN RQ.t_FactDate < PM.t_FactDate THEN PM.t_FactDate ELSE RQ.t_FactDate END) BETWEEN pBegDate AND pEndDate
                         ) q
                    WHERE q.t_FactDate < to_date('01.01.2021', 'dd.mm.yyyy')
                       or q.t_FactDate > v_StartDate
                   )
    LOOP
      v_Sum := 0;

      v_TaxGroup := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

      IF  ((one_rec.IsRepo = 0 AND one_rec.IsLoan = 0) OR  
           RSI_NPTX.CheckCateg(RSB_SECUR.OBJTYPE_SECDEAL, 23, LPAD(one_rec.t_DealID, 34, '0'), 2)=1  --категория "Является налоговым Репо" на сделке DDL_TICK.T_DEALID задана и равна False
          ) AND
          ( 
             v_TaxGroup <> 40 
             OR RSB_SECUR.GetMainObjAttr(RSB_SECUR.OBJTYPE_SECDEAL, LPAD(one_rec.t_DealID, 34, '0'), 53, one_rec.t_DealDate) <> 2 --категория "Первичное размещение"
          ) THEN


        v_Market := NPTO.GetMinMarket(one_rec.t_PFI, one_rec.t_DealDate, one_rec.t_DealID);

        IF UPPER(v_Market) != 'ФАКТ' THEN
       
          v_MinMarketPrice := npto.GetMinMarketPrice(one_rec.t_PFI, one_rec.t_DealDate, one_rec.t_DealID);

          v_Sum := GetAllSummMaterial_1(one_rec.t_DocKind,        
                                        one_rec.t_DealID,
                                        one_rec.t_Principal, 
                                        one_rec.t_PFI,
                                        one_rec.t_CFI,
                                        one_rec.t_Price,
                                        one_rec.t_DealDate,
                                        one_rec.t_FactDate,
                                        one_rec.AvFactDate,
                                        (CASE WHEN one_rec.t_RelativePrice = 'X' THEN 1 ELSE 0 END),
                                        v_MinMarketPrice,
                                        pEndDate,
                                        pClient,
                                        one_rec.t_FaceValueFI 
                                       );
        END IF;
      END IF;

      IF v_Sum <> 0 THEN

        v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate); 

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 2;
        nptxobj.T_DATE           := one_rec.t_FactDate;   
        nptxobj.T_CLIENT         := pCLient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
        nptxobj.T_LEVEL          := 1;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_MATERIAL;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := RSI_RSB_FIInstr.NATCUR;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
        nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END);                                            
        nptxobj.T_COMMENT        := 'Материальная выгода по покупке';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;


  END;

  --Расчет объектов НДР по материальной выгоде по зачислению
  PROCEDURE CreateMaterialTaxObjects1_2(pBegDate   IN DATE,
                                        pEndDate   IN DATE,
                                        pClient    IN NUMBER,
                                        pIIS       IN NUMBER,
                                        pDocID     IN NUMBER,
                                        pStep      IN NUMBER,
                                        pFIID      IN NUMBER,
                                        pContract  IN NUMBER,
                                        pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

    v_Sum NUMBER;
    v_Market VARCHAR2(100);
    v_MinMarketPrice NUMBER;

    v_ExternalOper    NUMBER;
    v_ReplacementDeal NUMBER;

    v_StartDate DATE;

  BEGIN

    pStat := 0;

    v_StartDate := to_date(RSB_COMMON.GetRegStrValue('COMMON\НДФЛ\ДАТА_ЛЬГОТЫ_ПО_МАТВЫГОДЕ'), 'dd.mm.yyyy');


    FOR one_rec IN (SELECT *
                    FROM (
                            WITH sf AS (SELECT t_ID, t_PartyID 
                                       FROM dsfcontr_dbt 
                                        WHERE t_PartyID = pClient
                                          AND t_ServKind = RSI_NPTO.PTSK_STOCKDL
                                          AND (EXTRACT(YEAR FROM pEndDate) >= RSI_NPTO.GetLucreStartTaxPeriod() OR RSI_NPTO.CheckContrIIS(t_ID) = pIIS)
                                          AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                                       )
                            SELECT RQ.t_FactDate, RQ.t_DocKind, Leg.t_CFI, Leg.t_PFI, Leg.t_Principal, Leg.t_RelativePrice, 
                                   Fin.t_FaceValueFI, Tick.t_DealID, Tick.t_DealDate, 
                                   Tick.t_ClientContrID, 
                                   (CASE WHEN Tick.t_Flag3 <> 'X' THEN DECODE( Leg.t_Start, g_ZeroDate, Tick.t_DealDate, Leg.t_Start )
                                         ELSE npto.GetDateFromAvrWrtIn( Tick.t_DealID, Leg.t_Start, Tick.t_DealDate ) END) BuyDate,
                                   (CASE WHEN Tick.t_Flag3 <> 'X' THEN Leg.t_Price
                                         ELSE npto.GetPriceFromAvrWrtIn( Tick.t_DealID, Leg.t_Price ) END) Price,
                                   NVL((SELECT t_Sum
                                          FROM ddlsum_dbt
                                         WHERE t_DocKind = Tick.t_BOfficeKind
                                           AND t_DocID   = Tick.t_DealID
                                           AND t_Kind    = RSI_NPTXC.DLSUM_KIND_OTHERLUCRESUM
                                           AND ROWNUM    = 1
                                       ), 0) as OtherLucreSum 
                            FROM sf, ddl_tick_dbt Tick, ddlrq_dbt RQ, ddl_leg_dbt Leg, dfininstr_dbt Fin, 
                                 (SELECT t_Kind_Operation
                                    FROM doprkoper_dbt 
                                   WHERE t_DocKind = RSB_SECUR.DL_AVRWRT 
                                     AND Rsb_Secur.IsAvrWrtIn(rsb_secur.get_OperationGroup(t_SysTypes)) = 1) Opr 
                            WHERE Tick.t_BOfficeKind   = RSB_SECUR.DL_AVRWRT
                              AND Tick.t_ClientID      = sf.t_PartyID
                              AND Tick.t_ClientContrID = sf.t_ID
                              AND Tick.t_Flag2         = 'X'
                              AND RQ.t_DocKind         = Tick.t_BOfficeKind
                              AND RQ.t_DocID           = Tick.t_DealID
                              AND RQ.t_State           = RSI_DLRQ.DLRQ_STATE_EXEC
                              AND RQ.t_Type            = RSI_DLRQ.DLRQ_TYPE_DELIVERY
                              AND RQ.t_DealPart        = 1
                              AND Opr.t_Kind_Operation = Tick.t_DealType
                              AND Leg.t_DealID         = Tick.t_DealID 
                              AND Leg.t_LegID          = 0 
                              AND Leg.t_LegKind        = 0 
                              AND Leg.t_PFI            = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)  
                              AND Fin.t_FIID           = Leg.t_PFI 
                              AND 1 = (CASE WHEN TaxDepositoryMode <> 0 AND
                                                 DECODE( Leg.t_Start, g_ZeroDate, Tick.t_DealDate, Leg.t_Start ) >= pBegDate AND
                                                 DECODE( Leg.t_Start, g_ZeroDate, Tick.t_DealDate, Leg.t_Start ) <= pEndDate THEN 1
                                            WHEN TaxDepositoryMode = 0 AND
                                                 RQ.t_FactDate >= pBegDate AND                            
                                                 RQ.t_FactDate <= pEndDate AND                            
                                                 Tick.t_Flag3 = 'X' /*учитывать в налоговом учете*/ THEN 1
                                            ELSE 0 END)    
                         ) q
                         WHERE q.BuyDate < to_date('01.01.2021', 'dd.mm.yyyy')
                            or q.BuyDate > v_StartDate
                   )
    LOOP
      v_Sum := 0;

      v_TaxGroup := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

      IF one_rec.OtherLucreSum <> 0 THEN
        v_Sum := one_rec.OtherLucreSum;
      ELSIF  v_TaxGroup <> 100 AND 
          (v_TaxGroup <> 40 
           or RSB_SECUR.GetMainObjAttr(RSB_SECUR.OBJTYPE_SECDEAL, LPAD(one_rec.t_DealID, 34, '0'), 53, one_rec.t_DealDate) <> 2 --категория "Первичное размещение"
          ) THEN

        v_Market := NPTO.GetMinMarket(one_rec.t_PFI, one_rec.BuyDate, one_rec.t_DealID);

        IF UPPER(v_Market) != 'ФАКТ' THEN
       
          v_MinMarketPrice := npto.GetMinMarketPrice(one_rec.t_PFI, one_rec.BuyDate, one_rec.t_DealID);

          v_Sum := GetAllSummMaterial_1(one_rec.t_DocKind,        
                                        one_rec.t_DealID,
                                        one_rec.t_Principal, 
                                        one_rec.t_PFI,
                                        one_rec.t_CFI,
                                        one_rec.Price,
                                        one_rec.t_DealDate,
                                        one_rec.BuyDate,
                                        one_rec.BuyDate,
                                        (CASE WHEN one_rec.t_RelativePrice = 'X' THEN 1 ELSE 0 END),
                                        v_MinMarketPrice,
                                        pEndDate,
                                        pClient,
                                        one_rec.t_FaceValueFI 
                                       );
        END IF;
      END IF;

      IF v_Sum <> 0 THEN

        v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.BuyDate); 

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 2;
        nptxobj.T_DATE           := one_rec.BuyDate;   
        nptxobj.T_CLIENT         := pCLient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
        nptxobj.T_LEVEL          := 1;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_MATERIAL;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := RSI_RSB_FIInstr.NATCUR;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1070;                           
        nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := one_rec.t_ClientContrID;                                            
        nptxobj.T_COMMENT        := 'Материальная выгода по зачислению';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        IF RSI_NPTO.GetLucreStartTaxPeriod() <= EXTRACT(YEAR FROM pEndDate) THEN
          v_ExternalOper    := RSB_SECUR.GetMainObjAttr(RSB_SECUR.OBJTYPE_SECDEAL, LPAD(one_rec.t_DealID, 34, '0'), 111, one_rec.t_DealDate);
          v_ReplacementDeal := RSB_SECUR.GetMainObjAttr(RSB_SECUR.OBJTYPE_SECDEAL, LPAD(one_rec.t_DealID, 34, '0'), 55, one_rec.t_DealDate);

          IF v_ExternalOper = 2 --категория "Внешняя операция" = ДА 
            THEN
            --По операциям зачисления ц/б с категорией "Внешняя операция" = ДА (номер категории = 111) НДР Material формируется с признаком "Внешняя система" = ДА, код внешней системы = "др. ПУ"
            nptxobj.T_FROMOUTSYST := 'X';
            nptxobj.T_OUTSYSTCODE := 'др. ПУ';
          ELSE  --"Внешняя операция" != ДА
            IF v_ReplacementDeal = 1 THEN --"сделка замещения" = ДА
              nptxobj.T_FROMOUTSYST := CHR(0);
              nptxobj.T_OUTSYSTCODE := CHR(1);
            ELSE
              --Для операций "Внешняя операция" != ДА (номер категории = 111), кроме операций, на которых установлена категория "сделка замещения" = ДА (номер категории = 55)) 
              --НДР Material формируется с признаком "Внешняя система" = пусто, код внешней системы = "РСХБ" (для ц/б, переведенных с договора на договор внутри банка)
              nptxobj.T_FROMOUTSYST := CHR(0);
              nptxobj.T_OUTSYSTCODE := 'РСХБ';
            END IF;
          END IF;
        ELSE
          nptxobj.T_FROMOUTSYST := CHR(0);
          nptxobj.T_OUTSYSTCODE := CHR(1);
        END IF;

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;


  PROCEDURE CreateMaterialTaxObjects1_3(pBegDate   IN DATE,
                                        pEndDate   IN DATE,
                                        pClient    IN NUMBER,
                                        pIIS       IN NUMBER,
                                        pDocID     IN NUMBER,
                                        pStep      IN NUMBER,
                                        pFIID      IN NUMBER,
                                        pContract  IN NUMBER,
                                        pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_TaxGroup  NUMBER;
    
    v_Market VARCHAR2(100);
    v_MinMarketPrice NUMBER;
    v_Material NUMBER;

    v_StartDate DATE;

  BEGIN

    pStat := 0;

    FOR one_rec IN (SELECT s.*,
                          (CASE WHEN s.BaseFI_KIND = RSI_RSB_FIINSTR.FIKIND_AVOIRISS OR s.BaseFI_KIND = RSI_RSB_FIINSTR.FIKIND_INDEX THEN RSI_NPTXC.TXGROUP_80 ELSE RSI_NPTXC.TXGROUP_90 END) as TaxGroup
                     FROM (SELECT D.t_ID, D.t_Forvard, D.t_DVKind, D.t_Type, D.t_Date, D.t_Contractor, D.t_Bonus, D.t_BonusFIID, D.t_ClientContr, 
                                  (CASE WHEN D.t_Forvard = 'X' THEN 1 /*DV_NFIType_Forward*/ ELSE 0 /*DV_NFIType_BaseActiv*/ END) as NFIType,
                                  (CASE WHEN FIN.t_FI_Kind = RSI_NPTXC.FIKIND_DERIVATIVE THEN FIN.t_FaceValueFI
                                        ELSE NFI.t_FIID END) AS BaseFIID,
                                  (CASE WHEN D.t_DVKind = RSB_DERIVATIVES.DV_CURSWAP OR D.t_DVKind = RSB_DERIVATIVES.DV_PCTSWAP THEN RSI_RSB_FIINSTR.FIKIND_CURRENCY
                                        ELSE FIN.t_FaceValueFI END) AS BaseFI_KIND,
                                  (CASE WHEN D.t_DVKind = RSB_DERIVATIVES.DV_FORWARD THEN RSI_RSB_FIInstr.ConvSum(NFI.t_Price * NFI.t_Amount, NFI.t_PriceFIID, RSI_RSB_FIInstr.NATCUR, D.t_Date)
                                        ELSE RSI_RSB_FIInstr.ConvSum(D.t_Bonus, D.t_BonusFIID, RSI_RSB_FIInstr.NATCUR, D.t_Date) END) as Soper,
                                  (SELECT NVL(SUM(RSI_RSB_FIInstr.ConvSum(P.t_OrderAmount, P.t_OrderFIID, RSI_RSB_FIInstr.NATCUR, P.t_ValueDate)), 0)
                                     FROM DPMPAYM_DBT P
                                    WHERE P.T_DOCKIND = RSB_SECUR.DL_DVNDEAL
                                      AND P.T_DOCUMENTID = D.t_ID
                                      AND (P.T_PAYMSTATUS >= 3000 /*PM_READY_TO_SEND*/ OR P.T_PAYMSTATUS = 150 /*PM_CLOSED_W_M_MOVEMENT*/)
                                      AND P.T_PURPOSE IN (72/*Комиссия Банку*/, 41 /*Комиссия брокеру*/)
                                      AND P.t_ValueDate >= pBegDate
                                      AND P.t_ValueDate <= pEndDate
                                  ) as SK
                             FROM DDVNDEAL_DBT D, DDVNFI_DBT NFI, DFININSTR_DBT FIN 
                            WHERE D.t_Client = pClient 
                              AND D.t_Type = RSB_DERIVATIVES.ALG_DV_BUY 
                              AND D.t_Date >= pBegDate 
                              AND D.t_Date <= pEndDate 
                              AND ((D.t_DVKind = RSB_DERIVATIVES.DV_FORWARD AND D.t_ISPFI = 'X') or D.t_DVKind = RSB_DERIVATIVES.DV_OPTION) 
                              AND (EXTRACT(YEAR FROM pEndDate) >= RSI_NPTO.GetLucreStartTaxPeriod() OR RSI_NPTO.CheckContrIIS(D.t_ClientContr) = pIIS)
                              AND ((pContract IS NULL) OR (pContract <= 0) OR (D.t_ClientContr in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                              AND NFI.t_DealID = D.t_ID
                              AND NFI.t_Type = (CASE WHEN D.t_Forvard = 'X' THEN 1 /*DV_NFIType_Forward*/ ELSE 0 /*DV_NFIType_BaseActiv*/ END)
                              AND FIN.T_FIID = NFI.t_FIID
                          ) s
                    WHERE 1 = (CASE WHEN pFIID = -1 THEN 1
                                    WHEN s.BaseFI_KIND = RSI_RSB_FIINSTR.FIKIND_AVOIRISS AND s.BaseFIID = pFIID THEN 1
                                    ELSE 0 END)    
                       AND (
                              s.t_Date < to_date('01.01.2021', 'dd.mm.yyyy')
                              or s.t_Date > v_StartDate
                           )
                   )
    LOOP

      v_Market := npto.GetMarket_DV(one_rec.t_ID);

      IF UPPER(v_Market) != 'ФАКТ' THEN

        v_MinMarketPrice := npto.GetMinMarketPrice_DV(one_rec.t_ID);

        v_Material := (CASE WHEN one_rec.Soper + one_rec.SK < v_MinMarketPrice THEN v_MinMarketPrice - one_rec.Soper - one_rec.SK ELSE v_MinMarketPrice END);

        IF v_Material <> 0 THEN

          InitNPTXOBJ(nptxobj);

          nptxobj.T_FUNCTIONKIND   := 2;
          nptxobj.T_DATE           := one_rec.t_Date;   
          nptxobj.T_CLIENT         := pCLient;
          nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
          nptxobj.T_LEVEL          := 1;
          nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_MATERIAL;                              
          nptxobj.T_SUM            := v_Material;                                                 
          nptxobj.T_CUR            := RSI_RSB_FIInstr.NATCUR;                                
          nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1090;                           
          nptxobj.T_ANALITIC1      := one_rec.t_ID;                                   
          nptxobj.T_ANALITICKIND2  := 0;                    
          nptxobj.T_ANALITIC2      := -1;                                          
          nptxobj.T_ANALITICKIND3  := (CASE WHEN one_rec.BaseFI_KIND = RSI_RSB_FIINSTR.FIKIND_AVOIRISS THEN RSI_NPTXC.TXOBJ_KIND3010 ELSE RSI_NPTXC.TXOBJ_KIND3020 END);                    
          nptxobj.T_ANALITIC3      := one_rec.BaseFIID;                                        
          nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
          nptxobj.T_ANALITIC4      := RSI_NPTXC.NPTX_FI_NOCIRCULATE;                                     
          nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
          nptxobj.T_ANALITIC5      := one_rec.TaxGroup;                                      
          nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
          nptxobj.T_ANALITIC6      := one_rec.t_ClientContr;                                            
          nptxobj.T_COMMENT        := 'Корректировка сумм покупки при пересчете по рыночной цене';      
          nptxobj.T_DOCID          := pDocID;
          nptxobj.T_STEP           := pStep; 
          nptxobj.T_TECHNICAL      := CHR(0);

          nptxobj_ins.extend;
          nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

        END IF;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  FUNCTION GetNPTXOBJSum_0(p_ClientID  IN NUMBER,
                           p_Kind      IN NUMBER,
                           p_MinDate   IN DATE,
                           p_MaxDate   IN DATE,
                           p_Direction IN NUMBER, 
                           p_AK1       IN NUMBER,
                           p_A1        IN NUMBER,
                           p_AK2       IN NUMBER,
                           p_A2        IN NUMBER,
                           p_AK3       IN NUMBER,
                           p_A3        IN NUMBER,
                           p_AK4       IN NUMBER,
                           p_A4        IN NUMBER,
                           p_AK5       IN NUMBER,
                           p_A5        IN NUMBER,
                           p_AK6       IN NUMBER,
                           p_A6        IN NUMBER
                          ) RETURN NUMBER
  AS
    v_Sum NUMBER := 0;

    v_Query VARCHAR2(1000);
  BEGIN

    v_Query := 'SELECT NVL(SUM(obj.t_Sum0), 0) ' ||
               '  FROM dnptxobj_dbt obj ' ||
               ' WHERE obj.t_Kind  = :Kind ' ||
               '   AND obj.t_Date >= :MinDate ' ||
               '   AND obj.t_Date <= :MaxDate ';

    IF p_Direction != 0 THEN
      v_Query := v_Query || ' AND obj.t_Direction = ' || p_Direction;
    END IF;

    IF p_ClientID > 0 THEN
      v_Query := v_Query || ' AND obj.t_Client = ' || p_ClientID;
    END IF;

    IF p_AK1 != 0 THEN
      v_Query := v_Query || ' AND obj.t_AnaliticKind1 = '||p_AK1||' AND obj.t_Analitic1 = '||p_A1;
    END IF;

    IF p_AK2 != 0 THEN
      v_Query := v_Query || ' AND obj.t_AnaliticKind2 = '||p_AK2||' AND obj.t_Analitic2 = '||p_A2;
    END IF;

    IF p_AK3 != 0 THEN
      v_Query := v_Query || ' AND obj.t_AnaliticKind3 = '||p_AK3||' AND obj.t_Analitic3 = '||p_A3;
    END IF;

    IF p_AK4 != 0 THEN
      v_Query := v_Query || ' AND obj.t_AnaliticKind4 = '||p_AK4||' AND obj.t_Analitic4 = '||p_A4;
    END IF;

    IF p_AK5 != 0 THEN
      v_Query := v_Query || ' AND obj.t_AnaliticKind5 = '||p_AK5||' AND obj.t_Analitic5 = '||p_A5;
    END IF;

    IF p_AK6 != 0 THEN
      v_Query := v_Query || ' AND obj.t_AnaliticKind6 = '||p_AK6||' AND obj.t_Analitic6 = '||p_A6;
    END IF;

    EXECUTE IMMEDIATE v_Query INTO v_Sum USING IN p_Kind, p_MinDate, p_MaxDate;

    RETURN ROUND(v_Sum, 2);
  END;


  FUNCTION GetNPTXOBJSum_0_124(p_Client    IN NUMBER,
                               p_Kind      IN NUMBER,
                               p_MinDate   IN DATE,
                               p_MaxDate   IN DATE,
                               p_Direction IN NUMBER, 
                               p_AK1       IN NUMBER,
                               p_A1        IN NUMBER,
                               p_AK2       IN NUMBER,
                               p_A2        IN NUMBER,
                               p_AK4       IN NUMBER,
                               p_A4        IN NUMBER
                              ) RETURN NUMBER
  AS
    v_Sum NUMBER := 0;
  BEGIN

    IF p_Direction = 0 THEN
      SELECT NVL(SUM(obj.t_Sum0), 0) 
        INTO v_Sum
        FROM dnptxobj_dbt obj
       WHERE obj.t_Client        = p_Client 
         AND obj.t_Kind          = p_Kind
         AND obj.t_AnaliticKind1 = p_AK1
         AND obj.t_Analitic1     = p_A1
         AND obj.t_AnaliticKind2 = p_AK2
         AND obj.t_Analitic2     = p_A2 
         AND obj.t_AnaliticKind4 = p_AK4
         AND obj.t_Analitic4     = p_A4
         AND obj.t_Date BETWEEN p_MinDate AND p_MaxDate;
    ELSE
      SELECT NVL(SUM(obj.t_Sum0), 0) 
        INTO v_Sum
        FROM dnptxobj_dbt obj
       WHERE obj.t_Client        = p_Client 
         AND obj.t_Kind          = p_Kind
         AND obj.t_AnaliticKind1 = p_AK1
         AND obj.t_Analitic1     = p_A1
         AND obj.t_AnaliticKind2 = p_AK2
         AND obj.t_Analitic2     = p_A2 
         AND obj.t_AnaliticKind4 = p_AK4
         AND obj.t_Analitic4     = p_A4
         AND obj.t_Date BETWEEN p_MinDate AND p_MaxDate 
         AND obj.t_Direction = p_Direction;
    END IF;

    RETURN ROUND(v_Sum, 2);

  END;

  FUNCTION GetNPTXOBJSum_0_345(p_Client    IN NUMBER,
                               p_IIS       IN NUMBER,
                               p_Kind      IN NUMBER,
                               p_MinDate   IN DATE,
                               p_MaxDate   IN DATE,
                               p_Direction IN NUMBER, 
                               p_AK3       IN NUMBER,
                               p_A3        IN NUMBER,
                               p_AK4       IN NUMBER,
                               p_A4        IN NUMBER,
                               p_AK5       IN NUMBER,
                               p_A5        IN NUMBER,
                               p_AK6       IN NUMBER,
                               p_A6        IN NUMBER,
                               p_NoRound   IN NUMBER DEFAULT 0
                              ) RETURN NUMBER
  AS
    v_Sum NUMBER := 0;

    v_AK6  NUMBER;
    v_A6   NUMBER;

    v_IISA6  NUMBER;
  BEGIN

    v_AK6 := p_AK6;
    v_A6  := p_A6;
    v_IISA6 := RSI_NPTO.CheckContrIIS(v_A6);
    
    IF v_AK6 = RSI_NPTXC.TXOBJ_KIND6020 AND v_IISA6 = 0 THEN
      v_AK6 := 0;
      v_A6  := -1;
    END IF;

    IF p_Direction = 0 THEN
      SELECT NVL(SUM(obj.t_Sum0), 0) 
        INTO v_Sum
        FROM dnptxobj_dbt obj
       WHERE obj.t_Client        = p_Client 
         AND obj.t_Kind          = p_Kind
         AND obj.t_AnaliticKind3 = p_AK3
         AND obj.t_Analitic3     = p_A3
         AND obj.t_AnaliticKind4 = p_AK4
         AND obj.t_Analitic4     = p_A4 
         AND obj.t_AnaliticKind5 = p_AK5
         AND obj.t_Analitic5     = p_A5
         AND obj.t_Date BETWEEN p_MinDate AND p_MaxDate
         AND (v_A6 <= 0 OR (obj.t_AnaliticKind6 = v_AK6 AND obj.t_Analitic6 = v_A6))
         AND ((p_IIS < 0 AND RSI_NPTO.CheckObjIIS(RSI_NPTXC.TXOBJ_KIND6020, obj.t_Analitic6) = v_IISA6)
              OR RSI_NPTO.CheckObjIIS(RSI_NPTXC.TXOBJ_KIND6020, obj.t_Analitic6) = p_IIS);
    ELSE
      SELECT NVL(SUM(obj.t_Sum0), 0) 
        INTO v_Sum
        FROM dnptxobj_dbt obj
       WHERE obj.t_Client        = p_Client 
         AND obj.t_Kind          = p_Kind
         AND obj.t_AnaliticKind3 = p_AK3
         AND obj.t_Analitic3     = p_A3
         AND obj.t_AnaliticKind4 = p_AK4
         AND obj.t_Analitic4     = p_A4 
         AND obj.t_AnaliticKind5 = p_AK5
         AND obj.t_Analitic5     = p_A5
         AND (v_A6 <= 0 OR (obj.t_AnaliticKind6 = v_AK6 AND obj.t_Analitic6 = v_A6))
         AND obj.t_Date BETWEEN p_MinDate AND p_MaxDate 
         AND obj.t_Direction = p_Direction
         AND ((p_IIS < 0 AND RSI_NPTO.CheckObjIIS(RSI_NPTXC.TXOBJ_KIND6020, obj.t_Analitic6) = v_IISA6)
              OR RSI_NPTO.CheckObjIIS(RSI_NPTXC.TXOBJ_KIND6020, obj.t_Analitic6) = p_IIS);
    END IF;

    IF p_NoRound = 0 THEN
      v_Sum := ROUND(v_Sum, 2);
    END IF;

    RETURN v_Sum;

  END;

  FUNCTION GetNPTXOBJSumByLink_0(p_LinkID    IN NUMBER,
                                 p_Kind      IN NUMBER,
                                 p_MinDate   IN DATE,
                                 p_MaxDate   IN DATE,
                                 p_Direction IN NUMBER DEFAULT 0,
                                 p_NoRound   IN NUMBER DEFAULT 0
                                ) RETURN NUMBER
  AS
    v_Sum NUMBER := 0;
  BEGIN

    IF p_Direction = 0 THEN
      SELECT NVL(SUM(obj.t_Sum0), 0) 
        INTO v_Sum
        FROM dnptxobj_dbt obj
       WHERE obj.t_Kind          = p_Kind
         AND obj.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
         AND obj.t_Analitic2     = p_LinkID
         AND obj.t_Date BETWEEN p_MinDate AND p_MaxDate;
    ELSE
      SELECT NVL(SUM(obj.t_Sum0), 0) 
        INTO v_Sum
        FROM dnptxobj_dbt obj
       WHERE obj.t_Kind          = p_Kind
         AND obj.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
         AND obj.t_Analitic2     = p_LinkID
         AND obj.t_Date BETWEEN p_MinDate AND p_MaxDate 
         AND obj.t_Direction = p_Direction;
    END IF;

    IF p_NoRound <> 0 THEN
      RETURN v_Sum;
    END IF;

    RETURN ROUND(v_Sum, 2);

  END;

  FUNCTION GetNPTXOBJSumByLink_0_tmp(p_LinkID    IN NUMBER,
                                 p_Kind      IN NUMBER,
                                 p_MinDate   IN DATE,
                                 p_MaxDate   IN DATE,
                                 p_Direction IN NUMBER DEFAULT 0,
                                 p_NoRound   IN NUMBER DEFAULT 0
                                ) RETURN NUMBER
  AS
    v_Sum NUMBER := 0;
  BEGIN

    IF p_Direction = 0 THEN
      SELECT NVL(SUM(RSI_RSB_FiInstr.ConvSum(obj.t_Sum, obj.t_Cur, RSI_RSB_FIINSTR.NATCUR, obj.t_Date, 0)), 0) 
        INTO v_Sum
        FROM dnptxobj_tmp obj
       WHERE obj.t_Kind          = p_Kind
         AND obj.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
         AND obj.t_Analitic2     = p_LinkID
         AND obj.t_Date BETWEEN p_MinDate AND p_MaxDate;
    ELSE
      SELECT NVL(SUM(RSI_RSB_FiInstr.ConvSum(obj.t_Sum, obj.t_Cur, RSI_RSB_FIINSTR.NATCUR, obj.t_Date, 0)), 0) 
        INTO v_Sum
        FROM dnptxobj_tmp obj
       WHERE obj.t_Kind          = p_Kind
         AND obj.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
         AND obj.t_Analitic2     = p_LinkID
         AND obj.t_Date BETWEEN p_MinDate AND p_MaxDate 
         AND obj.t_Direction = p_Direction;
    END IF;

    IF p_NoRound <> 0 THEN
      RETURN v_Sum;
    END IF;

    RETURN ROUND(v_Sum, 2);

  END;

  PROCEDURE GetNPTXOBJSumByA1(p_Sum       OUT NUMBER,
                              p_Sum0      OUT NUMBER,
                              p_Client    IN NUMBER,
                              p_AK1       IN NUMBER,
                              p_A1        IN NUMBER,
                              p_Kind      IN NUMBER,
                              p_MinDate   IN DATE,
                              p_MaxDate   IN DATE,
                              p_Direction IN NUMBER DEFAULT 0
                             ) 
  AS
    v_Sum NUMBER := 0;
  BEGIN

    IF p_Direction = 0 THEN
      SELECT NVL(SUM(obj.t_Sum0), 0), NVL(SUM(obj.t_Sum), 0) 
        INTO p_Sum0, p_Sum
        FROM dnptxobj_dbt obj
       WHERE obj.t_Client        = p_Client
         AND obj.t_Kind          = p_Kind
         AND obj.t_AnaliticKind1 = p_AK1
         AND obj.t_Analitic1     = p_A1
         AND obj.t_Date BETWEEN p_MinDate AND p_MaxDate;
    ELSE
      SELECT NVL(SUM(obj.t_Sum0), 0), NVL(SUM(obj.t_Sum), 0) 
        INTO p_Sum0, p_Sum
        FROM dnptxobj_dbt obj
       WHERE obj.t_Client        = p_Client
         AND obj.t_Kind          = p_Kind
         AND obj.t_AnaliticKind1 = p_AK1
         AND obj.t_Analitic1     = p_A1
         AND obj.t_Date BETWEEN p_MinDate AND p_MaxDate 
         AND obj.t_Direction = p_Direction;
    END IF;

    p_Sum  := ROUND(p_Sum, 2);
    p_Sum0 := ROUND(p_Sum0, 2);
  END;

  FUNCTION GetNPTXOBJSumByDeal_0(p_Client    IN NUMBER,
                                 p_DealID    IN NUMBER,
                                 p_Kind      IN NUMBER,
                                 p_MinDate   IN DATE,
                                 p_MaxDate   IN DATE,
                                 p_Direction IN NUMBER DEFAULT 0
                                ) RETURN NUMBER
  AS
    v_Sum  NUMBER;
    v_Sum0 NUMBER;
  BEGIN

    GetNPTXOBJSumByA1(v_Sum,
                      v_Sum0,
                      p_Client,
                      RSI_NPTXC.TXOBJ_KIND1010,
                      p_DealID,
                      p_Kind,      
                      p_MinDate,   
                      p_MaxDate,
                      p_Direction 
                     );

    RETURN v_Sum0;
  END;

  --ПосчитатьРубСуммуПоСвязиСоЗнаком
  FUNCTION GetSumByLnkWithSign_0(p_LinkID IN NUMBER, p_Kind IN NUMBER, p_BegDate IN DATE, p_EndDate IN DATE, p_NoRound IN NUMBER DEFAULT 0) RETURN NUMBER
  AS
  BEGIN
    RETURN GetNPTXOBJSumByLink_0(p_LinkID, p_Kind, p_BegDate, p_EndDate, RSI_NPTXC.TXOBJ_DIR_IN, p_NoRound) -
           GetNPTXOBJSumByLink_0(p_LinkID, p_Kind, p_BegDate, p_EndDate, RSI_NPTXC.TXOBJ_DIR_OUT, p_NoRound);
  END;

  FUNCTION GetSumByLnkWithSign_0_tmp(p_LinkID IN NUMBER, p_Kind IN NUMBER, p_BegDate IN DATE, p_EndDate IN DATE, p_NoRound IN NUMBER DEFAULT 0) RETURN NUMBER
  AS
  BEGIN
    RETURN GetNPTXOBJSumByLink_0_tmp(p_LinkID, p_Kind, p_BegDate, p_EndDate, RSI_NPTXC.TXOBJ_DIR_IN, p_NoRound) -
           GetNPTXOBJSumByLink_0_tmp(p_LinkID, p_Kind, p_BegDate, p_EndDate, RSI_NPTXC.TXOBJ_DIR_OUT, p_NoRound);
  END;

  --ПосчитатьРубСуммуПоСделкеСоЗнаком
  FUNCTION GetSumByDealWithSign_0(p_Client IN NUMBER, p_DealID IN NUMBER, p_Kind IN NUMBER, p_BegDate IN DATE, p_EndDate IN DATE) RETURN NUMBER
  AS
  BEGIN
    RETURN GetNPTXOBJSumByDeal_0(p_Client, p_DealID, p_Kind, p_BegDate, p_EndDate, RSI_NPTXC.TXOBJ_DIR_IN) -
           GetNPTXOBJSumByDeal_0(p_Client, p_DealID, p_Kind, p_BegDate, p_EndDate, RSI_NPTXC.TXOBJ_DIR_OUT);
  END;

  FUNCTION NPS_0(p_LinkID IN NUMBER, p_EndDate IN DATE, p_NoRound IN NUMBER DEFAULT 0) RETURN NUMBER
  AS
  BEGIN
    RETURN GetNPTXOBJSumByLink_0(p_LinkID, RSI_NPTXC.TXOBJ_NKDS, g_ZeroDate, p_EndDate, 0, p_NoRound);
  END;

  FUNCTION NPB_0(p_LinkID IN NUMBER, p_EndDate IN DATE, p_NoRound IN NUMBER DEFAULT 0) RETURN NUMBER
  AS
  BEGIN
    RETURN GetNPTXOBJSumByLink_0(p_LinkID, RSI_NPTXC.TXOBJ_NKDB, g_ZeroDate, p_EndDate, 0, p_NoRound);
  END;

  FUNCTION CM(p_LinkID IN NUMBER, p_EndDate IN DATE, p_NoRound IN NUMBER DEFAULT 0) RETURN NUMBER
  AS
    v_MaterialB0 NUMBER := 0;
  BEGIN

    IF IsIncludeMaterialInOut <> 0 THEN
      v_MaterialB0 := GetNPTXOBJSumByLink_0(p_LinkID, RSI_NPTXC.TXOBJ_MATERIALB, g_ZeroDate, p_EndDate, 0, p_NoRound);
    END IF;

    RETURN v_MaterialB0 +
           GetNPTXOBJSumByLink_0(p_LinkID, RSI_NPTXC.TXOBJ_TAXPM_LINK, g_ZeroDate, p_EndDate, 0, p_NoRound)+
           GetNPTXOBJSumByLink_0(p_LinkID, RSI_NPTXC.TXOBJ_COMS,       g_ZeroDate, p_EndDate, 0, p_NoRound)+
           GetNPTXOBJSumByLink_0(p_LinkID, RSI_NPTXC.TXOBJ_COMB,       g_ZeroDate, p_EndDate, 0, p_NoRound);
  END;

  FUNCTION CM_Short(p_LinkID IN NUMBER, p_EndDate IN DATE) RETURN NUMBER
  AS
    v_MaterialB0 NUMBER := 0;
  BEGIN

    IF IsIncludeMaterialInOut <> 0 THEN
      v_MaterialB0 := GetNPTXOBJSumByLink_0(p_LinkID, RSI_NPTXC.TXOBJ_MATERIALB_SHORT, g_ZeroDate, p_EndDate);
    END IF;
                                          
    RETURN v_MaterialB0 +
           GetNPTXOBJSumByLink_0(p_LinkID, RSI_NPTXC.TXOBJ_TAXPM_LINK_SHORT, g_ZeroDate, p_EndDate)+
           GetNPTXOBJSumByLink_0(p_LinkID, RSI_NPTXC.TXOBJ_COMS_SHORT,       g_ZeroDate, p_EndDate)+
           GetNPTXOBJSumByLink_0(p_LinkID, RSI_NPTXC.TXOBJ_COMB_SHORT,       g_ZeroDate, p_EndDate);
  END;

  FUNCTION DSC(p_LinkID IN NUMBER, p_BegDate IN DATE, p_EndDate IN DATE, p_NoRound IN NUMBER DEFAULT 0) RETURN NUMBER
  AS 
  BEGIN
    RETURN GetSumByLnkWithSign_0(p_LinkID, RSI_NPTXC.TXOBJ_DISCOUNT_LINK, p_BegDate, p_EndDate, p_NoRound);
  END;

  FUNCTION NPS(p_LinkID IN NUMBER, p_EndDate IN DATE, p_NoRound IN NUMBER DEFAULT 0) RETURN NUMBER
  AS
  BEGIN
   RETURN GetNPTXOBJSumByLink_0(p_LinkID, RSI_NPTXC.TXOBJ_NKDS,       g_ZeroDate, p_EndDate, 0, p_NoRound)+
          GetNPTXOBJSumByLink_0(p_LinkID, RSI_NPTXC.TXOBJ_NKDS_SHORT, g_ZeroDate, p_EndDate, 0, p_NoRound);

  END;

  FUNCTION NPB(p_LinkID IN NUMBER, p_EndDate IN DATE, p_NoRound IN NUMBER DEFAULT 0) RETURN NUMBER
  AS
  BEGIN
   RETURN GetNPTXOBJSumByLink_0(p_LinkID, RSI_NPTXC.TXOBJ_NKDB,       g_ZeroDate, p_EndDate, 0, p_NoRound)+
          GetNPTXOBJSumByLink_0(p_LinkID, RSI_NPTXC.TXOBJ_NKDB_SHORT, g_ZeroDate, p_EndDate, 0, p_NoRound);

  END;

  --ПолучитьСуммы
  PROCEDURE GetSumDR(p_C1 IN NUMBER, p_C2 IN NUMBER, p_D OUT NUMBER, p_R OUT NUMBER)
  IS
  BEGIN
    p_D := 0;
    p_R := 0;
    IF p_C2 < 0 AND p_C1 > 0 THEN
      p_D := -p_C1;
      p_R := ABS(p_C2);
    ELSIF p_C2 > 0 AND p_C1 < 0 THEN
      p_D := p_C2;
      p_R := p_C1;
    ELSIF p_C2 < 0 AND p_C1 < 0 AND ABS(p_C1) > ABS(p_C2) THEN
      p_R := ABS(p_C2) - ABS(p_C1); -- сумма получается отрицательная
    ELSIF p_C2 > 0 AND p_C1 > 0 AND p_C1 > p_C2 THEN
      p_D := p_C2 - p_C1; -- сумма - отрицательная
    ELSIF p_C2 < 0 AND p_C1 < 0 AND ABS(p_C2) > ABS(p_C1) THEN
      p_R := ABS(p_C2) - ABS(p_C1); -- положительная
    ELSIF p_C2 > 0 AND p_C1 > 0 AND p_C2 > p_C1 THEN
      p_D := p_C2 - p_C1; -- положительная
    ELSIF p_C2 > 0 AND p_C1 = 0 THEN
      p_D := p_C2;
    ELSIF p_C2 < 0 AND p_C1 = 0 THEN
      p_R := ABS(p_C2);
    ELSIF p_C2 = 0 AND p_C1 > 0 THEN
      p_D := -p_C1; -- отрицательная сумма
    ELSIF p_C2 = 0 AND p_C1 < 0 THEN
      p_R := p_C1; -- отрицательная сумма
    END IF;
  END;

  FUNCTION GetSumD(p_C1 IN NUMBER, p_C2 IN NUMBER) RETURN NUMBER
  AS
    v_D NUMBER := 0;
    v_R NUMBER := 0;
  BEGIN

    GetSumDR(p_C1, p_C2, v_D, v_R);

    RETURN ROUND(v_D, 2);
  END;

  FUNCTION GetSumR(p_C1 IN NUMBER, p_C2 IN NUMBER) RETURN NUMBER
  AS
    v_D NUMBER := 0;
    v_R NUMBER := 0;
  BEGIN

    GetSumDR(p_C1, p_C2, v_D, v_R);

    RETURN ROUND(v_R, 2);
  END;


  FUNCTION FRepo_Ex(p_DealID IN NUMBER, p_D2 IN DATE, p_CFI IN NUMBER, p_Direction IN NUMBER, p_Client IN NUMBER) RETURN NUMBER
  AS
    v_S NUMBER := 0;
  BEGIN

    SELECT NVL(SUM((CASE WHEN t_Cur = p_CFI THEN t_Sum ELSE RSB_FIInstr.ConvSum(t_Sum, t_Cur, p_CFI, t_Date) END)),0)
      INTO v_S
      FROM dnptxobj_dbt                                                          
     WHERE t_AnaliticKind1 = RSI_NPTXC.TXOBJ_KIND1010                                    
       AND t_Analitic1     = p_DealID                                        
       AND t_Direction     = p_Direction 
       AND t_Client        = p_Client
       AND t_Kind IN (RSI_NPTXC.TXOBJ_MAIN, RSI_NPTXC.TXOBJ_NKD, RSI_NPTXC.TXOBJ_PAY, RSI_NPTXC.TXOBJ_PROCREPOPAY);

    RETURN v_S;
  END;


  FUNCTION FRepo(p_DealID IN NUMBER, p_D2 IN DATE, p_CFI IN NUMBER, p_Client IN NUMBER) RETURN NUMBER
  AS
  BEGIN
    RETURN FRepo_Ex(p_DealID, p_D2, p_CFI, RSI_NPTXC.TXOBJ_DIR_IN, p_Client) - FRepo_Ex(p_DealID, p_D2, p_CFI, RSI_NPTXC.TXOBJ_DIR_OUT, p_Client);
  END;

  FUNCTION GetCbKeyRate(p_OnDate IN DATE) RETURN NUMBER RESULT_CACHE RELIES_ON(DCBKEYRATE_DBT)
  AS
    v_Rate NUMBER := 0;
  BEGIN
    
    FOR one_rec IN (SELECT t_Rate
                      FROM DCBKEYRATE_DBT
                     WHERE t_FIID = RSI_RSB_FIInstr.NATCUR
                       AND t_DateFrom <= p_OnDate
                     ORDER BY t_DateFrom DESC
                   )
    LOOP

      v_Rate := one_rec.t_Rate;
      EXIT;
    END LOOP;

    RETURN v_Rate;
  END;

  FUNCTION NDays30(p_D IN DATE) RETURN NUMBER
  AS
    v_Day NUMBER;
  BEGIN
    v_Day := EXTRACT(DAY FROM p_D);
    IF v_Day = 31 THEN
      v_Day := 30;
    END IF;

    RETURN 360*EXTRACT(YEAR FROM p_D) + 30*EXTRACT(MONTH FROM p_D)-1 + v_Day;
  END;

  FUNCTION NDays30Correct(p_D1 IN DATE, p_D2 IN DATE) RETURN NUMBER
  AS
  BEGIN
    RETURN NDays30(p_D2) - NDays30(p_D1);
  END;

  FUNCTION GetDaysInYear(p_Y IN NUMBER) RETURN NUMBER
  AS
  BEGIN
    RETURN TO_NUMBER(TO_CHAR(TO_DATE('31.12.'||p_Y, 'DD.MM.YYYY'), 'DDD'));
  END;

  FUNCTION T36X(p_D1 IN DATE, p_D2 IN DATE, p_DaysInYear IN NUMBER) RETURN NUMBER
  AS
    v_CY NUMBER; 
    v_Y1 NUMBER;
    v_Y2 NUMBER;
    v_T1 NUMBER := 0; 
    v_T2 NUMBER := 0; 
    v_T3 NUMBER := 0;
  BEGIN
     
     v_Y1 := EXTRACT(YEAR FROM p_D1);
     v_Y2 := EXTRACT(YEAR FROM p_D2);

     IF( v_Y1 = v_Y2 ) THEN
        IF( GetDaysInYear(v_Y1) = p_DaysInYear ) THEN
           RETURN p_D2-p_D1;
        ELSE
           RETURN 0;
        END IF;
     ELSE
        IF( GetDaysInYear(v_Y1) = p_DaysInYear ) THEN
          v_T1 := TO_DATE('31.12.'||v_Y1,'DD.MM.YYYY')-p_D1;
        END IF;
        IF( GetDaysInYear(v_Y2) = p_DaysInYear ) THEN
          v_T2 := p_D2-TO_DATE('31.12.'||(v_Y2-1),'DD.MM.YYYY'); -- если даты за разные годы, то начало интервала не учитываем, но учитываем конец. Следовательно, к кусочку за год окончания интервала, +1 день.
        END IF;

        v_CY := v_Y1+1;
        WHILE( v_CY <= v_Y2-1 ) LOOP
           IF( GetDaysInYear(v_CY) = p_DaysInYear ) THEN
             v_T3 := v_T3 + p_DaysInYear;
           END IF;
           v_CY := v_CY + 1;
        END LOOP;

        RETURN v_T1 + v_T2 + v_T3;
     END IF;

     RETURN 0;
  END;

  FUNCTION Kyear(p_Basis IN NUMBER, p_D1 IN DATE, p_D2 IN DATE) RETURN NUMBER
  AS
   v_Y1  NUMBER;
   v_Y2  NUMBER;
   v_CY  NUMBER;
   v_TX1 NUMBER := 0;
   v_TX2 NUMBER := 0;

  BEGIN

    IF(p_D1 = p_D2) THEN
       IF((p_Basis = RSB_SECUR.SP_KINDBASISCALC_CAL_CAL) OR (p_Basis = RSB_SECUR.SP_KINDBASISCALC_CAL_30)) THEN
          RETURN 1.0/GetDaysInYear(EXTRACT(YEAR FROM p_D2));
       ELSIF ((p_Basis = RSB_SECUR.SP_KINDBASISCALC_360_30) OR (p_Basis = RSB_SECUR.SP_KINDBASISCALC_360_CAL)) THEN
          RETURN 1.0/360.0;
       ELSIF ((p_Basis = RSB_SECUR.SP_KINDBASISCALC_365_CAL) or (p_Basis = RSB_SECUR.SP_KINDBASISCALC_365_30)) THEN
          RETURN 1.0/365.0;
       END IF;
    ELSE
       IF( p_Basis = RSB_SECUR.SP_KINDBASISCALC_365_CAL ) THEN
          RETURN (p_D2-p_D1)/365.0;

       ELSIF( p_Basis = RSB_SECUR.SP_KINDBASISCALC_CAL_CAL ) THEN
          v_TX1 := T36X(p_D1, p_D2, 366);
          v_TX2 := T36X(p_D1, p_D2, 365);

          RETURN ( v_TX1/366.0)+(v_TX2/365.0);

       ELSIF( p_Basis = RSB_SECUR.SP_KINDBASISCALC_CAL_30 ) THEN
          v_Y1 := EXTRACT(YEAR FROM p_D1);
          v_Y2 := EXTRACT(YEAR FROM p_D2);
          v_CY := v_Y1;
          WHILE(v_CY <= v_Y2) LOOP
            IF(GetDaysInYear(v_CY) = 366) THEN --високосный год
              IF((TO_DATE('29.02.'||v_CY, 'DD.MM.YYYY') >= p_D1) AND (TO_DATE('29.02.'||v_CY, 'DD.MM.YYYY') <= p_D2)) THEN
                --если между датами Д1 и Д2 есть 29 февраля, то делим на 366
                RETURN NDays30Correct(p_D1, p_D2 )/366.0;
              END IF;
            END IF;
            v_CY := v_CY + 1;
          END LOOP;

          RETURN NDays30Correct( p_D1, p_D2 )/365.0;

       ELSIF( p_Basis = RSB_SECUR.SP_KINDBASISCALC_360_30 ) THEN
          RETURN NDays30Correct(p_D1, p_D2)/360.0;

       ELSIF( p_Basis = RSB_SECUR.SP_KINDBASISCALC_360_CAL ) THEN
          RETURN (p_D2-p_D1)/360.0;

       ELSIF( p_Basis = RSB_SECUR.SP_KINDBASISCALC_365_30 ) THEN
          RETURN NDays30Correct(p_D1, p_D2)/365.0;
       END IF;
    END IF;

    RETURN 0;
  END;

  FUNCTION SumYear(p_DealID IN NUMBER, p_D2 IN DATE, p_CFI IN NUMBER, p_Dir1 IN NUMBER, p_Basis IN NUMBER, p_Client IN NUMBER, p_IsBuy IN NUMBER) RETURN NUMBER
  AS
    v_RetVal   NUMBER := 0;
    v_PrevDate DATE   := g_ZeroDate; 
    v_Kyear    NUMBER := 0;
    v_Ki       NUMBER;
  BEGIN

    FOR rsd IN (SELECT obj.*, NVL(RSB_FIInstr.ConvSum(t_Sum, t_Cur, p_CFI, t_Date),0) as S         
                  FROM dnptxobj_dbt obj                                                        
                 WHERE obj.t_Kind IN (RSI_NPTXC.TXOBJ_MAIN, RSI_NPTXC.TXOBJ_NKD) 
                   AND obj.t_AnaliticKind1 = RSI_NPTXC.TXOBJ_KIND1010                                                 
                   AND obj.t_Analitic1 = p_DealID                                                     
                   AND obj.t_Direction = p_Dir1                                                     
                   AND obj.t_Client = p_Client                                                        
                 ORDER BY obj.t_Date                                                          
               )
    LOOP
      IF(v_PrevDate != rsd.t_Date) THEN
        v_Kyear    := Kyear(p_Basis, rsd.t_Date, p_D2);
        v_prevDate := rsd.t_Date;
      END IF;

      v_RetVal := v_RetVal + rsd.S * v_Kyear;
    END LOOP;


    FOR rsd IN (SELECT obj.*, NVL(RSB_FIInstr.ConvSum(t_Sum, t_Cur, p_CFI, t_Date),0) as S 
                  FROM dnptxobj_dbt obj                                                          
                 WHERE obj.t_Kind = RSI_NPTXC.TXOBJ_PAY                                          
                   AND obj.t_AnaliticKind1 = RSI_NPTXC.TXOBJ_KIND1010                                   
                   AND obj.t_Analitic1 = p_DealID
                   AND obj.t_Client = p_Client
                 ORDER BY obj.t_Date                                                          
               )
    LOOP
      v_Ki := 1;
      IF( ((rsd.S = RSI_NPTXC.TXOBJ_DIR_OUT) AND (p_IsBuy != 1)) OR ((rsd.S = RSI_NPTXC.TXOBJ_DIR_IN) AND (p_IsBuy = 1)) ) THEN
        v_Ki := -1;
      END IF;

      IF(v_PrevDate != rsd.t_Date) THEN
        v_Kyear    := Kyear(p_Basis, rsd.t_Date, p_D2);
        v_PrevDate := rsd.t_Date;
      END IF;

      v_RetVal := v_RetVal + (v_Ki * rsd.S * v_Kyear);
    END LOOP;

    RETURN v_RetVal;
  END;

  --Добавить во временную таблицу дочерние связи от продажи замещенных ц/б
  PROCEDURE AddChildLinksToTMP(pDocID IN NUMBER, pBegDate IN DATE, pEndDate IN DATE, pClearLnk BOOLEAN)
  AS
    v_OldWrtAmount     NUMBER;
    v_SaveOldWrtAmount NUMBER;
    v_Amount           NUMBER;
    v_Amount2          NUMBER;
    v_RestPLnkAmount   NUMBER;
    v_TotalAmount      NUMBER;
  BEGIN
    --Удалить из временной таблицы связи продажи замещения по покупкам до g_MaxBuyDateForRepl, т.к. по ним НДР нужно создавать только при выбытии замещенных ц/б
    DELETE FROM DNPTXOP1OPLNK_TMP TMP
     WHERE TMP.T_DOCID = TMP.T_PARENT_DOCID
       AND EXISTS(SELECT 1 
                    FROM DNPTXLNK_DBT LNK, DNPTXLOT_DBT BUY, DNPTXLOT_DBT SALE
                   WHERE LNK.T_ID = TMP.T_DOCID
                     AND BUY.T_ID = LNK.T_BUYID
                     AND BUY.T_BUYDATE <= g_MaxBuyDateForRepl
                     AND SALE.T_ID = LNK.T_SALEID
                     AND RSB_SECUR.GetMainObjAttr(101, LPAD(SALE.t_DocID, 34, '0'), 55, LNK.T_DATE) = 1
                 );


    --Для каждой из проданных замещенных ц/б в этой операции расчета НОБ добавим во временную таблицу связи замещения покупок до g_MaxBuyDateForRepl
    FOR one_fi IN (SELECT DISTINCT S.T_FIID
                     FROM DNPTXOP_DBT NPTXOP, DOPROPER_DBT OP, DNPTXBC_DBT NBC, DNPTXLNK_DBT S, V_NPX_DNPTXLOT LB, DDL_TICK_DBT TKB, V_NPX_DNPTXLOT LS, DDL_TICK_DBT TKS
                    WHERE NPTXOP.T_ID = pDocID
                      AND OP.T_DOCKIND = NPTXOP.T_DOCKIND
                      AND OP.T_DOCUMENTID = LPAD(NPTXOP.T_ID, 34, '0')
                      AND NBC.T_ID_OPERATION = OP.T_ID_OPERATION
                      AND NBC.T_OBJKIND = RSI_NPTXC.NPTXBC_OBJKIND_LNK
                      AND NBC.T_ACTION = RSI_NPTXC.NPTXBC_ACTION_CREATE
                      AND S.T_ID = NBC.T_OBJID
                      AND S.t_Date >= pBegDate
                      AND S.t_Date <= pEndDate
                      AND LB.T_ID = S.T_BUYID
                      AND TKB.T_BOFFICEKIND = LB.T_DOCKIND
                      AND TKB.T_DEALID      = LB.T_DOCID
                      AND RSB_SECUR.GetMainObjAttr(101, LPAD(TKB.t_DealID, 34, '0'), 55, S.T_DATE) = 1
                      AND LS.T_ID = S.T_SALEID
                      AND TKS.T_BOFFICEKIND = LS.T_DOCKIND
                      AND TKS.T_DEALID      = LS.T_DOCID
                      AND RSB_SECUR.IsAvrWrtOut(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(TKS.t_DealType, TKS.t_BofficeKind))) = 0
                  )
    LOOP
      v_TotalAmount := 0;

      --Посчитаем, сколько бумаг замещенной ц/б мы уже учли при других расчетах НОБ
      --Здесь мы не проверяем учет бумаг до g_MaxBuyDateForRepl, поскольку далее, если v_OldWrtAmount будет больше, чем бумаг по подходящим покупкам, то это будет означать, что подходящие выбывшие ц/б мы уже учли в других расчетах НОБ
      SELECT NVL(SUM(Q.T_AMOUNT), 0) INTO v_OldWrtAmount
        FROM (SELECT DISTINCT S2.*  
                FROM DNPTXOP_DBT NPTXOP, DOPROPER_DBT OP, DNPTXBC_DBT NBC, DNPTXLNK_DBT S, V_NPX_DNPTXLOT LB, DDL_TICK_DBT TKB, DNPTXLNK_DBT S2, DNPTXBC_DBT NBC2
               WHERE NPTXOP.T_ID = pDocID
                 AND OP.T_DOCKIND = NPTXOP.T_DOCKIND
                 AND OP.T_DOCUMENTID = LPAD(NPTXOP.T_ID, 34, '0')
                 AND NBC.T_ID_OPERATION = OP.T_ID_OPERATION
                 AND NBC.T_OBJKIND = RSI_NPTXC.NPTXBC_OBJKIND_LNK
                 AND NBC.T_ACTION = RSI_NPTXC.NPTXBC_ACTION_CREATE
                 AND S.T_ID = NBC.T_OBJID
                 AND S.t_Date >= pBegDate
                 AND S.t_Date <= pEndDate
                 AND S.T_FIID = one_fi.t_FIID
                 AND LB.T_ID = S.T_BUYID
                 AND TKB.T_BOFFICEKIND = LB.T_DOCKIND
                 AND TKB.T_DEALID      = LB.T_DOCID
                 AND RSB_SECUR.GetMainObjAttr(101, LPAD(TKB.t_DealID, 34, '0'), 55, S.T_DATE) = 1
                 AND S2.T_BUYID = S.T_BUYID
                 AND S2.T_ID <> S.T_ID
                 AND NBC2.T_OBJID = S2.T_ID
                 AND NBC2.T_ID_OPERATION <> NBC.T_ID_OPERATION
                 AND NBC2.T_OBJKIND = RSI_NPTXC.NPTXBC_OBJKIND_LNK
                 AND NBC2.T_ACTION = RSI_NPTXC.NPTXBC_ACTION_CREATE
             ) Q;

       v_SaveOldWrtAmount := v_OldWrtAmount;

       --Перебираем все связи продажи замещенной ц/б в этой операции расчета НОБ
       FOR one_parent_lnk IN (SELECT S.T_ID, S.T_AMOUNT, NVL(rsb_struct.getInt(rsi_rsb_kernel.GetNote(RSB_SECUR.OBJTYPE_SECDEAL, LPAD(TKB.T_DEALID, 34, '0'), 38/*Идентификатор связанной сделки замещения*/, S.T_DATE)), 0) AS SaleDealID
                               FROM DNPTXOP_DBT NPTXOP, DOPROPER_DBT OP, DNPTXBC_DBT NBC, DNPTXLNK_DBT S, V_NPX_DNPTXLOT LB, DDL_TICK_DBT TKB, V_NPX_DNPTXLOT LS, DDL_TICK_DBT TKS
                              WHERE NPTXOP.T_ID = pDocID
                                AND OP.T_DOCKIND = NPTXOP.T_DOCKIND
                                AND OP.T_DOCUMENTID = LPAD(NPTXOP.T_ID, 34, '0')
                                AND NBC.T_ID_OPERATION = OP.T_ID_OPERATION
                                AND NBC.T_OBJKIND = RSI_NPTXC.NPTXBC_OBJKIND_LNK
                                AND NBC.T_ACTION = RSI_NPTXC.NPTXBC_ACTION_CREATE
                                AND S.T_ID = NBC.T_OBJID
                                AND S.T_FIID = one_fi.T_FIID
                                AND S.t_Date >= pBegDate
                                AND S.t_Date <= pEndDate
                                AND LB.T_ID = S.T_BUYID
                                AND TKB.T_BOFFICEKIND = LB.T_DOCKIND
                                AND TKB.T_DEALID      = LB.T_DOCID
                                AND RSB_SECUR.GetMainObjAttr(101, LPAD(TKB.t_DealID, 34, '0'), 55, S.T_DATE) = 1
                                AND LS.T_ID = S.T_SALEID
                                AND TKS.T_BOFFICEKIND = LS.T_DOCKIND
                                AND TKS.T_DEALID      = LS.T_DOCID
                                AND RSB_SECUR.IsAvrWrtOut(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(TKS.t_DealType, TKS.t_BofficeKind))) = 0
                                ORDER BY S.T_ID ASC
                           )
      LOOP
         
        v_RestPLnkAmount := one_parent_lnk.t_Amount;

        --Перебираем все связи замещения, у которых продажа ссылается на покупку из связи продажи замещенной ц/б
        --При этом отбираем только связи замещения покупок, которые были соверены до g_MaxBuyDateForRepl
        --Сортируем сделки покупки по дате и времени, считаем нарастающим итогом сумму бумаг TotalAmount
        --Чтобы не отобрать ранее учтенные покупки в других расчетах НОБ, отбираем только такие записи, у которых TotalAmount больше, чем сумма ранее учтенных бумаг + учтенных в этой операции по другим связям.
        FOR one_lnk IN (SELECT Q1.*
                          FROM (SELECT Q.*, sum(Q.LnkAmount) OVER(ORDER BY Q.T_DEALDATE ASC, Q.T_DEALTIME ASC, Q.T_DOCID ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as TotalAmount
                                  FROM (SELECT S.T_ID, LB.T_DEALDATE, LB.T_DEALTIME, LB.T_DOCID, S.T_AMOUNT as LnkAmount
                                          FROM DDL_TICK_DBT TKS, V_NPX_DNPTXLOT LS, DNPTXLNK_DBT S, V_NPX_DNPTXLOT LB
                                         WHERE TKS.T_DEALID = one_parent_lnk.SaleDealID
                                           AND LS.T_DOCKIND = TKS.T_BOFFICEKIND
                                           AND LS.T_DOCID   = TKS.T_DEALID
                                           AND S.T_SALEID = LS.T_ID
                                           AND LB.T_ID = S.T_BUYID
                                           AND LB.T_BUYDATE <= g_MaxBuyDateForRepl
                                       ) Q
                                 WHERE Q.LnkAmount > 0
                               ) Q1
                         WHERE Q1.TotalAmount > (v_OldWrtAmount + v_TotalAmount)
                        ORDER BY Q1.T_DEALDATE ASC, Q1.T_DEALTIME ASC, Q1.T_DOCID ASC
                       )
        LOOP

          v_Amount := LEAST(v_RestPLnkAmount, one_lnk.TotalAmount - (v_OldWrtAmount + v_TotalAmount));

          --Так как далее отбираемые объекты НДР по каждой связи создаются на всё количество (из родительской связи) проданных связью ц/б, то надо запомнить это значение, так как далее его сложно вычислить
          v_Amount2 := v_OldWrtAmount + v_TotalAmount - one_lnk.TotalAmount + one_lnk.LnkAmount + v_Amount; 

          
          INSERT INTO DNPTXOP1OPLNK_TMP (T_DOCID, T_PARENT_DOCID, T_AMOUNT, T_AMOUNT1, T_AMOUNT2) VALUES(one_lnk.t_ID, one_parent_lnk.t_ID, v_Amount, 0, v_Amount2);


          v_TotalAmount := v_TotalAmount + v_Amount;

          v_RestPLnkAmount := v_RestPLnkAmount - v_Amount;

          IF v_RestPLnkAmount = 0 THEN
            EXIT;
          END IF;
        END LOOP;

        IF pClearLnk = TRUE THEN
          --В записи по родительской связи установим оставшийся свободный остаток, т.е. то количество, которое приходится на замещенные ц/б, купленные после g_MaxBuyDateForRepl
          UPDATE DNPTXOP1OPLNK_TMP T
             SET T.T_AMOUNT = v_RestPLnkAmount
           WHERE T.T_DOCID = one_parent_lnk.t_ID
             AND T.T_PARENT_DOCID = T.T_DOCID;
        END IF;

      END LOOP;

      IF pClearLnk = TRUE THEN
        --Удаляем записи с нулевым количеством
        DELETE FROM DNPTXOP1OPLNK_TMP T
         WHERE T.T_PARENT_DOCID = T.T_DOCID
           AND T_AMOUNT = 0; 
      END IF;

      --Для всех записей по одной связи устанавливаем максимальное проданное кол-во
      UPDATE DNPTXOP1OPLNK_TMP T SET T.T_AMOUNT2 = (SELECT MAX(T1.T_AMOUNT2) FROM DNPTXOP1OPLNK_TMP T1 WHERE T.T_DOCID = T1.T_DOCID)
      WHERE EXISTS(SELECT 1 FROM DNPTXLNK_DBT S WHERE S.T_ID = T.T_PARENT_DOCID AND S.T_FIID = one_fi.t_FIID);

      --Для всех записей по одной связи устанавливаем общее кол-во проданных в данной операции ц/б
      UPDATE DNPTXOP1OPLNK_TMP T
         SET T.T_AMOUNT1 = (SELECT SUM(T1.T_AMOUNT) FROM DNPTXOP1OPLNK_TMP T1 WHERE T1.T_DOCID = T.T_DOCID)
       WHERE EXISTS(SELECT 1 FROM DNPTXLNK_DBT S WHERE S.T_ID = T.T_PARENT_DOCID AND S.T_FIID = one_fi.t_FIID);

    
    END LOOP;

  END;

  --Расчет объектов НДР по данным из депозитария
  PROCEDURE CreateTaxObjects2_0(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Dir     NUMBER;
    v_Kind    NUMBER;
    v_Sum     NUMBER;
    v_Comment DNPTXOBJ_TMP.T_COMMENT%TYPE;
    
    v_K      NUMBER;
    v_LBCourseNominal NUMBER;
    v_NominalAVROnBuyDateLink NUMBER;
    v_LBAmount NUMBER;
    v_LSSaleDate date;

    v_Rest NUMBER := 0;
  BEGIN
  
    pStat := 0;

    v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
    v_Kind    := RSI_NPTXC.TXOBJ_NKDB_TS;
    v_Comment := 'Затраты на оплату НКД для учета выплат от эмитента';

    FOR one_rec IN (SELECT q.*,
                           NVL((SELECT SUM(o1.t_Sum0)
                                  FROM DNPTXOBJ_DBT o1
                                 WHERE o1.t_Client = pClient
                                   AND o1.t_Kind = v_Kind
                                   AND o1.t_Direction = v_Dir
                                   AND o1.T_ANALITICKIND1 = q.T_ANALITICKIND1  
                                   AND o1.T_ANALITIC1     = q.T_ANALITIC1      
                                   AND o1.T_ANALITICKIND2 = q.T_ANALITICKIND2  
                                   AND o1.T_ANALITIC2     = q.T_ANALITIC2      
                                   AND o1.T_ANALITICKIND3 = q.T_ANALITICKIND3  
                                   AND o1.T_ANALITIC3     = q.T_ANALITIC3      
                                   AND o1.T_ANALITICKIND4 = q.T_ANALITICKIND4  
                                   AND o1.T_ANALITIC4     = q.T_ANALITIC4      
                                   AND o1.T_ANALITICKIND5 = q.T_ANALITICKIND5  
                                   AND o1.T_ANALITIC5     = q.T_ANALITIC5      
                                   AND o1.T_ANALITICKIND6 = q.T_ANALITICKIND6  
                                   AND o1.T_ANALITIC6     = q.T_ANALITIC6
                               ), 0) as PrevSumNkdB_TS
                      FROM (SELECT LB.t_AnaliticKind1,
                                   LB.t_ID as LB_ID,
                                   LB.t_Analitic1,
                                   LB.t_BuyDate as LB_BuyDate,
                                   LB.t_Amount as LBAmount,
                                   RSI_RSB_FIInstr.ConvSum (LB.T_NKD,
                                                            Leg.T_NKDFIID,
                                                            RSI_RSB_FIInstr.NATCUR,
                                                            LB.T_BUYDATE) as T_NKD,
                                   LB.T_NKD as NKD_CUR,
                                   N.T_ANALITICKIND2,
                                   N.T_ANALITIC2,
                                   RSI_NPTXC.TXOBJ_KIND3010 AS T_ANALITICKIND3,
                                   LB.T_FIID as T_ANALITIC3,
                                   RSI_NPTXC.TXOBJ_KIND4010 AS T_ANALITICKIND4,
                                   npto.Market2dates (LB.T_FIID, LB.T_BUYDATE, LB.T_DEALDATE)
                                      AS T_ANALITIC4,
                                   N.T_ANALITICKIND5,
                                   N.T_ANALITIC5,
                                   N.T_ANALITICKIND6,
                                   N.T_ANALITIC6,
                                   N.T_CUR,
                                   N.T_DATE,
                                   fin.t_fi_kind, fin.t_avoirkind,
                                   Leg.T_NKDFIID,
                                   fin.t_FaceValueFI
                              FROM dnptxobj_dbt N,
                                   DFIWARNTS_DBT wrn,
                                   v_npx_dnptxlot LB,
                                   ddl_tick_dbt Tick,
                                   ddl_leg_dbt Leg,
                                   dfininstr_dbt fin
                             WHERE     N.t_Client = pClient
                                   AND N.t_Kind = RSI_NPTXC.TXOBJ_PROCSEC_TS
                                   AND N.t_Date BETWEEN pBegDate AND pEndDate
                                   AND N.t_ObjID IN (SELECT MAX(DC1.T_OBJID)
                                                       FROM DCDRECORDS_DBT CD, DCDNPTXOBDC_DBT DC, DCDRECORDS_DBT CD1, DCDNPTXOBDC_DBT DC1
                                                      WHERE DC.T_OBJID = N.T_OBJID
                                                        AND CD.T_ID = DC.T_RECID
                                                        AND CD1.T_PARTYID = CD.T_PARTYID
                                                        AND CD1.T_FIID = CD.T_FIID
                                                        AND CD1.T_COUPONNUMBER = CD.T_COUPONNUMBER
                                                        AND CD1.T_CORPORATEACTIONTYPE = CD.T_CORPORATEACTIONTYPE
                                                        AND DC1.T_RECID = CD1.T_ID
                                                    )
                                   AND N.t_Sum0 > 0
                                   AND wrn.T_FIID = N.T_ANALITIC3
                                   AND wrn.T_NUMBER = TO_CHAR (N.T_ANALITIC2)
                                   AND wrn.T_ISPARTIAL = CHR(0)
                                   AND LB.t_AnaliticKind1 IN (RSI_NPTXC.TXOBJ_KIND1010, RSI_NPTXC.TXOBJ_KIND1070)
                                   AND LB.T_BUYDATE BETWEEN wrn.T_FIRSTDATE AND wrn.T_DRAWINGDATE
                                   AND LB.T_FIID = N.T_ANALITIC3
                                   AND LB.t_Kind = 1
                                   AND LB.t_Client = N.t_Client
                                   AND LB.t_Contract = N.t_Analitic6
                                   AND Tick.t_BOfficeKind = LB.T_DOCKIND
                                   AND TICK.T_DEALID = LB.T_DOCID
                                   AND Leg.t_DealID = Tick.t_DealID
                                   AND Leg.t_LegID = 0
                                   AND Leg.t_LegKind = 0
                                   AND fin.t_fiid = lb.t_fiid
                          ) q
                   )
    LOOP

      v_Rest := 0;
      v_Sum  := 0;
      
      BEGIN 
        SELECT T.t_Amount INTO v_Rest
          FROM dnptxts_dbt T 
         WHERE T.t_SaleID = 0
           AND T.t_BuyID  = one_rec.LB_ID 
           AND T.t_Type   = RSI_NPTXC.NPTXTS_REST
           AND T.t_Client = pClient
           AND RSI_NPTO.CheckContrIIS(T.t_Contract) = pIIS
           AND ((pContract IS NULL) OR (pContract <= 0) OR (T.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
           AND T.t_Amount > 0
           AND T.t_BegDate <= one_rec.t_Date
           AND (T.t_EndDate > one_rec.t_Date or T.t_EndDate = g_ZeroDate)
           AND ROWNUM = 1;

        EXCEPTION
             WHEN NO_DATA_FOUND THEN v_Rest := 0;
      END;

      IF v_Rest > 0 THEN
        v_Sum := one_rec.T_NKD * v_Rest / one_rec.LBAmount - one_rec.PrevSumNkdB_TS;
        
        IF (one_rec.t_FI_Kind = RSI_RSB_FIINSTR.FIKIND_AVOIRISS) and (one_rec.t_AvoirKind = RSI_RSB_FIINSTR.AVOIRKIND_BOND_OVVZ) and (one_rec.t_Date >= TO_DATE('01.01.2019','DD.MM.YYYY'))
           and one_rec.T_NKDFIID <> RSI_RSB_FIInstr.NATCUR
          THEN

          v_Sum := one_rec.NKD_CUR * v_Rest / one_rec.LBAmount;

          v_Sum := NVL(rsb_fiinstr.ConvSum(v_Sum, one_rec.T_NKDFIID, RSI_RSB_FIInstr.NATCUR, one_rec.t_Date), 0.0) - one_rec.PrevSumNkdB_TS;
        END IF;
      END IF;

      v_Sum := ROUND(v_Sum, 2);

      IF(v_Sum != 0) THEN
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.T_DATE;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;
        nptxobj.T_SUM            := v_Sum;
        nptxobj.T_CUR            := RSI_RSB_FIInstr.NATCUR;
        nptxobj.T_ANALITICKIND1  := one_rec.T_ANALITICKIND1;
        nptxobj.T_ANALITIC1      := one_rec.T_ANALITIC1;
        nptxobj.T_ANALITICKIND2  := one_rec.T_ANALITICKIND2;
        nptxobj.T_ANALITIC2      := one_rec.T_ANALITIC2;
        nptxobj.T_ANALITICKIND3  := one_rec.T_ANALITICKIND3;
        nptxobj.T_ANALITIC3      := one_rec.T_ANALITIC3;
        nptxobj.T_ANALITICKIND4  := one_rec.T_ANALITICKIND4;
        nptxobj.T_ANALITIC4      := one_rec.T_ANALITIC4;
        nptxobj.T_ANALITICKIND5  := one_rec.T_ANALITICKIND5;
        nptxobj.T_ANALITIC5      := one_rec.T_ANALITIC5;
        nptxobj.T_ANALITICKIND6  := one_rec.T_ANALITICKIND6;
        nptxobj.T_ANALITIC6      := one_rec.T_ANALITIC6;
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по процентам РЕПО
  PROCEDURE CreateTaxObjects2_1(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

    v_Dir  NUMBER;
    v_Dir1 NUMBER;

    v_FRepo   NUMBER;
    v_KR      NUMBER;
    v_StRate  NUMBER;
    v_SumYear NUMBER; 
  BEGIN

    pStat := 0;

    FOR one_rec IN (WITH sf AS (SELECT t_PartyID, t_ID 
                                  FROM dsfcontr_dbt 
                                 WHERE t_PartyID = pClient 
                                   AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS 
                                   AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                               )
                    SELECT /*+LEADING(Tick)*/ (CASE WHEN PmMoney.t_FactDate > PmAvoir.t_FactDate THEN PmMoney.t_FactDate ELSE PmAvoir.t_FactDate END) D2R, 
                           Opr.IsBuy, Tick.t_DealID, Tick.t_DealDate, PmMoney.t_FactDate DatePay2Fact, 
                           Leg1.t_CFI, Leg1.t_PayFIID, Leg1.t_PFI, Leg1.t_Basis, Leg2.t_IncomeRate, 
                           Tick.t_ClientID, 
                           Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID   
                      FROM ddl_tick_dbt Tick, sf, ddlrq_dbt PmMoney, ddlrq_dbt PmAvoir, ddl_leg_dbt Leg1, ddl_leg_dbt Leg2, 
                           (SELECT t_Kind_Operation, t_DocKind, Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(t_SysTypes)) IsBuy 
                              FROM doprkoper_dbt
                             WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC
                           ) Opr 
                     WHERE Tick.t_BOfficeKind = RSB_SECUR.DL_SECURITYDOC
                       AND ( (Tick.t_ClientID = sf.t_PartyID AND Tick.t_ClientContrID = sf.t_ID  ) 
                            OR (Tick.t_PartyID = sf.t_PartyID AND Tick.t_PartyContrID = sf.t_ID AND Tick.t_IsPartyClient = 'X'))
                       AND Opr.t_Kind_Operation = Tick.t_DealType 
                       AND Leg1.t_DealID      = Tick.t_DealID 
                       AND Leg1.t_LegID       = 0 
                       AND Leg1.t_LegKind     = 0 
                       AND Leg1.t_PFI          = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg1.t_PFI END)
                       AND Leg2.t_DealID      = Tick.t_DealID 
                       AND Leg2.t_LegID       = 0 
                       AND Leg2.t_LegKind     = 2 
                       AND PmMoney.t_DocID    = Tick.t_DealID     
                       AND PmMoney.t_DocKind  = Tick.t_BOfficeKind
                       AND PmMoney.t_State    = RSI_DLRQ.DLRQ_STATE_EXEC 
                       AND PmMoney.t_SubKind  = RSI_DLRQ.DLRQ_SUBKIND_CURRENCY
                       AND PmMoney.t_Type     = RSI_DLRQ.DLRQ_TYPE_PAYMENT
                       AND PmMoney.t_DealPart = 2 
                       AND PmAvoir.t_DocID    = Tick.t_DealID     
                       AND PmAvoir.t_DocKind  = Tick.t_BOfficeKind
                       AND PmAvoir.t_State    = RSI_DLRQ.DLRQ_STATE_EXEC 
                       AND PmAvoir.t_SubKind  = RSI_DLRQ.DLRQ_SUBKIND_AVOIRISS
                       AND PmAvoir.t_Type     = RSI_DLRQ.DLRQ_TYPE_DELIVERY
                       AND PmAvoir.t_DealPart = 2
                       AND (CASE WHEN PmMoney.t_FactDate > PmAvoir.t_FactDate THEN PmMoney.t_FactDate ELSE PmAvoir.t_FactDate END ) >= pBegDate 
                       AND (CASE WHEN PmMoney.t_FactDate > PmAvoir.t_FactDate THEN PmMoney.t_FactDate ELSE PmAvoir.t_FactDate END ) <= pEndDate 
                    )
    LOOP
      v_Circulate := -1;

      v_FRepo := FRepo(one_rec.t_DealID, one_rec.D2R, one_rec.t_PayFIID, pClient);

      IF (((one_rec.t_IncomeRate > 0) AND (one_rec.IsBuy = 1)) OR
          ((one_rec.t_IncomeRate < 0) AND (one_rec.IsBuy = 0)) OR
          ((one_rec.t_IncomeRate = 0) AND (one_rec.IsBuy = 1) AND (v_FRepo > 0)) OR
          ((one_rec.t_IncomeRate = 0) AND (one_rec.IsBuy = 0) AND (v_FRepo < 0))
         ) THEN
         IF (pClient = one_rec.t_ClientID) THEN
            v_Dir := RSI_NPTXC.TXOBJ_DIR_IN;
         ELSE
            v_Dir := RSI_NPTXC.TXOBJ_DIR_OUT;
         END IF;

      ELSIF (((one_rec.t_IncomeRate < 0) AND (one_rec.IsBuy = 1)) OR
             ((one_rec.t_IncomeRate > 0) AND (one_rec.IsBuy = 0)) OR
             ((one_rec.t_IncomeRate = 0) AND (one_rec.IsBuy = 1) AND (v_FRepo < 0)) OR
             ((one_rec.t_IncomeRate = 0) AND (one_rec.IsBuy = 0) AND (v_FRepo > 0))
            ) THEN
         IF (pClient = one_rec.t_ClientID) THEN
            v_Dir := RSI_NPTXC.TXOBJ_DIR_OUT;
         ELSE
            v_Dir := RSI_NPTXC.TXOBJ_DIR_IN;
         END IF;
      END IF;

      v_FRepo := ROUND(v_FRepo, 2);

      IF v_FRepo != 0 THEN
        v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
        v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);
        
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.D2R;   
        nptxobj.T_CLIENT         := pCLient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_PROCFACT;                              
        nptxobj.T_SUM            := ABS(v_FRepo);                                                 
        nptxobj.T_CUR            := one_rec.t_PayFIID;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
        nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END);                                            
        nptxobj.T_COMMENT        := 'Фактические проценты по Репо';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      END IF;

      IF (((one_rec.IsBuy = 1) and (pClient = one_rec.t_ClientID)) or ((one_rec.IsBuy = 0) and (pClient != one_rec.t_ClientID))) THEN
        v_Dir1 := RSI_NPTXC.TXOBJ_DIR_OUT;
      ELSE
        v_Dir1 := RSI_NPTXC.TXOBJ_DIR_IN;
      END IF;

      IF(one_rec.t_PayFIID != RSI_RSB_FIInstr.NATCUR) THEN
        v_KR := 0.8;
      ELSE
        v_KR := 1.8;
      END IF;

      v_StRate := v_KR * GetCbKeyRate(one_rec.DatePay2Fact);

      v_SumYear := SumYear(one_rec.t_DealID, one_rec.D2R, one_rec.t_PayFIID, v_Dir1, one_rec.t_Basis, pClient, one_rec.IsBuy);

      IF(v_SumYear * v_StRate != 0) THEN
        IF(( (((one_rec.t_IncomeRate < 0) AND (one_rec.IsBuy = 1)) OR
              ((one_rec.t_IncomeRate > 0) AND (one_rec.IsBuy = 0)) OR
              ((one_rec.t_IncomeRate = 0) AND (one_rec.IsBuy = 1) AND (v_FRepo < 0)) OR
              ((one_rec.t_IncomeRate = 0) AND (one_rec.IsBuy = 0) AND (v_FRepo > 0))
             ) AND 
             (pClient = one_rec.t_ClientID)
           ) OR
           ( (((one_rec.t_IncomeRate < 0) AND (one_rec.IsBuy = 0)) OR
              ((one_rec.t_IncomeRate > 0) AND (one_rec.IsBuy = 1)) OR
              ((one_rec.t_IncomeRate = 0) AND (one_rec.IsBuy = 0) AND (v_FRepo < 0)) OR
              ((one_rec.t_IncomeRate = 0) AND (one_rec.IsBuy = 1) AND (v_FRepo > 0))
             ) AND 
             (pClient != one_rec.t_ClientID)
           )
          ) THEN

          IF v_Circulate = -1 THEN
            v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
            v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);
          END IF;

          InitNPTXOBJ(nptxobj);

          nptxobj.T_FUNCTIONKIND   := 1;
          nptxobj.T_DATE           := one_rec.D2R;   
          nptxobj.T_CLIENT         := pCLient;
          nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
          nptxobj.T_LEVEL          := 2;
          nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_PROCNORM;                              
          nptxobj.T_SUM            := ROUND(v_SumYear * v_StRate/100.0, 2);                                                 
          nptxobj.T_CUR            := one_rec.t_PayFIID;                                
          nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
          nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
          nptxobj.T_ANALITICKIND2  := 0;                    
          nptxobj.T_ANALITIC2      := -1;                                          
          nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
          nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
          nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
          nptxobj.T_ANALITIC4      := v_Circulate;                                     
          nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
          nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
          nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
          nptxobj.T_ANALITIC6      := (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END);                                            
          nptxobj.T_COMMENT        := 'Максимально допустимые проценты по Репо';      
          nptxobj.T_DOCID          := pDocID;
          nptxobj.T_STEP           := pStep; 
          nptxobj.T_TECHNICAL      := CHR(0);

          nptxobj_ins.extend;
          nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
        END IF;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по стоимости РЕПО
  PROCEDURE CreateTaxObjects2_2(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

    v_Main0     NUMBER;
    v_NKD0      NUMBER;
    v_Sum       NUMBER;

    v_FactDate  DATE;
     
  BEGIN

    pStat := 0;

    FOR one_rec IN (WITH sf AS (SELECT t_PartyID, t_ID 
                                  FROM dsfcontr_dbt 
                                 WHERE t_PartyID = pClient 
                                   AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS 
                                   AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                               )
                    SELECT Opr.IsBuy, Tick.t_DealID, Tick.t_BOfficeKind, Tick.t_DealDate, PmMoney.t_FactDate, 
                           Leg1.t_CFI, Leg1.t_PFI, Leg1.t_Principal, Leg2.t_IncomeRate, Fin.t_FaceValueFI, 
                           Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID,  
                           Tick.t_ClientID 
                      FROM ddlrq_dbt PmMoney, ddl_tick_dbt Tick, sf, ddl_leg_dbt Leg1, ddl_leg_dbt Leg2, dfininstr_dbt Fin,  
                           (SELECT t_Kind_Operation, Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(t_SysTypes)) IsBuy 
                              FROM doprkoper_dbt
                             WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC
                           ) Opr 
                     WHERE PmMoney.t_DocKind    = RSB_SECUR.DL_SECURITYDOC
                       AND PmMoney.t_State      = RSI_DLRQ.DLRQ_STATE_EXEC
                       AND PmMoney.t_SubKind    = RSI_DLRQ.DLRQ_SUBKIND_CURRENCY
                       AND PmMoney.t_Type       = RSI_DLRQ.DLRQ_TYPE_PAYMENT
                       AND PmMoney.t_DealPart   = 2
                       AND PmMoney.t_FactDate  >= pBegDate
                       AND PmMoney.t_FactDate  <= pEndDate
                       AND Tick.t_DealID        = PmMoney.t_DocID
                       AND ( (Tick.t_ClientID = sf.t_PartyID  AND Tick.t_ClientContrID = sf.t_ID) 
                            OR (Tick.t_PartyID = sf.t_PartyID AND Tick.t_PartyContrID = sf.t_ID AND Tick.t_IsPartyClient = 'X')) 
                       AND Opr.t_Kind_Operation = Tick.t_DealType 
                       AND Leg1.t_DealID  = Tick.t_DealID 
                       AND Leg1.t_LegID   = 0 
                       AND Leg1.t_LegKind = 0 
                       AND Leg1.t_PFI     = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg1.t_PFI END)
                       AND Leg2.t_DealID  = Tick.t_DealID 
                       AND Leg2.t_LegID   = 0 
                       AND Leg2.t_LegKind = 2 
                       AND Fin.t_FIID     = Leg1.t_PFI 
                       --примечания "Переквалификации сделки РЕПО/займа" и "Урегулирование сделки" не заполнены
                       AND NOT EXISTS(SELECT 1
                                        FROM dnotetext_dbt 
                                       WHERE t_Objecttype = RSB_SECUR.OBJTYPE_SECDEAL
                                         AND t_DocumentID = LPAD( Tick.t_DealID, 34, '0' ) 
                                         AND t_NoteKind IN (14 /*NOTEKIND_SECDEAL_REG_DEAL - Урегулирование сделки*/, 
                                                            19 /*NOTEKIND_SECDEAL_REQUALREPO - Переквалификация сделки РЕПО*/) 
                                     )  
                    )
    LOOP

      IF(((one_rec.IsBuy = 1) and (pClient = one_rec.t_ClientID)) or ((one_rec.IsBuy = 0) and (pClient != one_rec.t_ClientID))) THEN
         v_Main0 := GetNPTXOBJSumByDeal_0(pClient, one_rec.t_DealID, RSI_NPTXC.TXOBJ_MAIN, g_ZeroDate, g_MaxDate, RSI_NPTXC.TXOBJ_DIR_IN);
         v_NKD0  := GetNPTXOBJSumByDeal_0(pClient, one_rec.t_DealID, RSI_NPTXC.TXOBJ_NKD, g_ZeroDate, g_MaxDate, RSI_NPTXC.TXOBJ_DIR_IN);

         v_Sum := v_Main0 + v_NKD0 + GetSumByDealWithSign_0(pClient, one_rec.t_DealID, RSI_NPTXC.TXOBJ_PROCREPOPAY, g_ZeroDate, g_MaxDate);
      ELSE
         v_Main0 := GetNPTXOBJSumByDeal_0(pClient, one_rec.t_DealID, RSI_NPTXC.TXOBJ_MAIN, g_ZeroDate, g_MaxDate, RSI_NPTXC.TXOBJ_DIR_OUT);
         v_NKD0  := GetNPTXOBJSumByDeal_0(pClient, one_rec.t_DealID, RSI_NPTXC.TXOBJ_NKD, g_ZeroDate, g_MaxDate, RSI_NPTXC.TXOBJ_DIR_OUT);
         
         v_Sum := v_Main0 + v_NKD0 + GetSumByDealWithSign_0(pClient, one_rec.t_DealID, RSI_NPTXC.TXOBJ_PROCREPOPAY, g_ZeroDate, g_MaxDate);
      END IF;

      v_Sum := ROUND(v_Sum, 2);

      IF v_Sum <> 0 THEN

        v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
        v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);

        v_FactDate := GetDealRQDate(one_rec.t_BOfficeKind, one_rec.t_DealID);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := v_FactDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_COST;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := RSI_RSB_FIInstr.NATCUR;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1010;                           
        nptxobj.T_ANALITIC1      := one_rec.t_DealID;                                   
        nptxobj.T_ANALITICKIND2  := 0;                    
        nptxobj.T_ANALITIC2      := -1;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_PFI;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := v_TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END);                                            
        nptxobj.T_COMMENT        := 'Стоимость ц/б по Репо';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по остаткам
  PROCEDURE CreateTaxObjects2_3(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_Kind        NUMBER;
    v_Dir         NUMBER;
    v_Comment     DNPTXOBJ_TMP.T_COMMENT%TYPE;
    v_SumAmount_0 NUMBER;
    v_K           NUMBER;
    v_X           NUMBER;
    v_Sum         NUMBER;

  BEGIN

    pStat := 0;

    FOR one_rec IN (SELECT N.t_Date, N.t_Cur, N.t_Kind, N.t_Sum0, N.t_Sum, N.t_Analitic5, N.t_Analitic6, 
                           T.t_ID, T.t_FIID, T.t_Amount TAmount, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, LB.t_PriceFIID LBPriceFIID, 
                           (SELECT NVL(rsb_fiinstr.FI_GetNominalOnDate(fin.t_FIID, LS.t_SaleDate ), 0.0) 
                              FROM v_npx_dnptxlot LS 
                             WHERE LS.t_ID = T.t_SaleID) NominalAVROnSelDateLink, 
                           NVL(rsb_fiinstr.FI_GetNominalOnDate(fin.t_FIID, LB.t_BuyDate ), 0.0) NominalAVROnBuyDateLink, 
                           (SELECT NVL(rsb_fiinstr.ConvSum(1, fin.t_FaceValueFI, RSI_RSB_FIInstr.NATCUR, LS.t_saleDate ), 0.0) 
                              FROM v_npx_dnptxlot LS 
                             WHERE LS.t_ID = T.t_SaleID) LSCourseNominal, 
                           NVL(rsb_fiinstr.ConvSum(1, fin.t_FaceValueFI, RSI_RSB_FIInstr.NATCUR, LB.t_buyDate ), 0.0) LBCourseNominal, 
                           (SELECT NVL(rsb_fiinstr.ConvSum(1, LB.t_PriceFIID, RSI_RSB_FIInstr.NATCUR, LS.t_saleDate ), 0.0) 
                              FROM v_npx_dnptxlot LS 
                             WHERE LS.t_ID = T.t_SaleID) LB_Course_PriseFIID, 
                           DRWL.t_Cost, DRWL.t_Principal, 
                           (SELECT t_DrawingDate 
                              FROM dfiwarnts_dbt 
                             WHERE t_FIID = T.t_FIID 
                               AND t_IsPartial = 'X' 
                               AND t_Number = DRW.t_Number_Partly) DrawingDate,  
                           TO_NUMBER(DRW.t_Number_Partly) Number_Partly, 
                           DRW.t_DealType, DRW.t_BOfficeKind, DRW.t_Flag1, DRW.t_Flag4, 
                           fin.t_FI_Kind, fin.t_AvoirKind, fin.t_FaceValueFI, fin.t_FaceValue,
                           DRW.T_DealDate as DRWDealDate, 
                           (CASE WHEN LB.T_GOID > 0 THEN NVL((SELECT (CASE WHEN comm.t_CorpActionDate = g_ZeroDate THEN LB.t_DealDate ELSE comm.t_CorpActionDate END)
                                                                FROM dnptxgo_dbt go, ddl_comm_dbt comm
                                                               WHERE go.t_ID = LB.T_GOID
                                                                 AND comm.t_DocKind = go.t_DocKind
                                                                 AND comm.t_DocumentID = go.t_DocumentID
                                                             ), LB.t_DealDate)
                                 ELSE LB.t_DealDate END) as LBDealDate, 
                           (SELECT rsb_secur.get_OperationGroup(t_SysTypes) FROM doprkoper_dbt WHERE t_Kind_Operation = DRW.t_DealType) oGrp 
                      FROM dnptxobj_dbt N, v_npx_dnptxlot LB, dnptxts_dbt T, ddl_tick_dbt DRW, ddl_leg_dbt DRWL, dfininstr_dbt fin 
                     WHERE N.t_Client = pClient
                       AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_Kind IN (RSI_NPTXC.TXOBJ_MAIN,
                                        RSI_NPTXC.TXOBJ_COM, 
                                        RSI_NPTXC.TXOBJ_NKD, 
                                        RSI_NPTXC.TXOBJ_DIF,
                                        RSI_NPTXC.TXOBJ_MATERIAL
                                       ) 
                       AND N.t_AnaliticKind1 = LB.t_AnaliticKind1 
                       AND N.t_Analitic1     = LB.t_Analitic1 
                       AND LB.t_Kind IN (RSI_NPTXC.NPTXLOTS_BUY, 
                                         RSI_NPTXC.NPTXLOTS_BACKREPO,
                                         RSI_NPTXC.NPTXLOTS_LOANGET
                                        ) 
                       AND T.t_BuyID  = LB.t_ID 
                       AND T.t_Type   = RSI_NPTXC.NPTXTS_REST
                       AND T.t_Client = pClient
                       AND T.t_FIID   = (CASE WHEN pFIID != -1 THEN pFIID ELSE T.t_FIID END)
                       AND RSI_NPTO.CheckContrIIS(T.t_Contract) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (T.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND T.t_Amount > 0 
                       AND DRW.t_BOfficeKind   = RSB_SECUR.DL_RETIREMENT
                       AND DRW.t_ClientID      = pClient
                       AND DRW.t_Number_Partly <> CHR(1) 
                       AND DRW.t_DealDate      <= pBegDate 
                       AND DRW.t_DealDate      >= pEndDate
                       AND DRW.t_CouponNDFL    = CHR(88)   /*PNV убрать погашение из расчета НОБ*/
                       AND RSI_NPTO.CheckContrIIS(DRW.t_ClientContrID) = pIIS 
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (DRW.T_ClientContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND DRWL.t_DealID  = DRW.t_DealID 
                       AND DRWL.t_PFI     = T.t_FIID
                       AND DRWL.t_LegID   = 0 
                       AND DRWL.t_LegKind = 0 
                       AND T.t_BegDate    < DRW.t_DealDate 
                       AND (T.t_EndDate >= DRW.t_DealDate OR T.t_EndDate = g_ZeroDate )
                       AND fin.t_FIID     = T.t_FIID
                       /*NkdB_TS формируется до 31.12.2023*/
                       AND ((N.t_Kind != RSI_NPTXC.TXOBJ_NKD) OR (pBegDate <= TO_DATE('31.12.2023','DD.MM.YYYY')))
                    )
    LOOP

      IF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_MAIN) THEN
         v_Kind    := RSI_NPTXC.TXOBJ_MAINB_TS;
         v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
         v_Comment := 'Затраты на приобретение (основная сумма)';

      ELSIF (one_rec.t_Kind = RSI_NPTXC.TXOBJ_COM) THEN
         v_Kind    := RSI_NPTXC.TXOBJ_COMB_TS;
         v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
         v_Comment := 'Затраты на оплату комиссий при покупке';

      ELSIF (one_rec.t_Kind = RSI_NPTXC.TXOBJ_DIF) THEN
         v_Kind    := RSI_NPTXC.TXOBJ_DIFB_TS;
         v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
         v_Comment := 'Корректировка затрат по рыночной цене по сделке';

      ELSIF (one_rec.t_Kind = RSI_NPTXC.TXOBJ_NKD) THEN
         v_Kind    := RSI_NPTXC.TXOBJ_NKDB_TS;
         v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
         v_Comment := 'Затраты на оплату НКД для учета выплат от эмитента';
      ELSIF (one_rec.t_Kind = RSI_NPTXC.TXOBJ_MATERIAL) THEN
         v_Kind    := RSI_NPTXC.TXOBJ_MATERIALB_TS;
         v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
         v_Comment := 'Сумма мат. выгоды';
      END IF;

      v_SumAmount_0 := 0;
      IF( v_Kind != RSI_NPTXC.TXOBJ_DIFB_TS AND v_Kind != RSI_NPTXC.TXOBJ_MATERIALB_TS) THEN /*вычисляем льготное кол-во*/
        v_SumAmount_0 := RSI_NPTX.GetPrivAmountByTS(one_rec.t_ID, pEndDate, one_rec.DrawingDate);
      END IF;

      IF ( ((v_Kind = RSI_NPTXC.TXOBJ_MAINB_TS) OR (v_Kind = RSI_NPTXC.TXOBJ_COMB_TS) OR (v_Kind = RSI_NPTXC.TXOBJ_NKDB_TS)) AND
           ((one_rec.t_FI_Kind = RSI_RSB_FIINSTR.FIKIND_AVOIRISS) and (one_rec.t_AvoirKind = RSI_RSB_FIINSTR.AVOIRKIND_BOND_OVVZ) and (one_rec.t_Date >= TO_DATE('01.01.2019','DD.MM.YYYY')))
         ) THEN
         
        v_K := 0.0;
        IF(one_rec.t_Cur = RSI_RSB_FIInstr.NATCUR) THEN
          v_K := one_rec.LSCourseNominal / one_rec.LBCourseNominal;
        ELSE
          v_K := (CASE WHEN v_Kind = RSI_NPTXC.TXOBJ_NKDB_TS THEN one_rec.LSCourseNominal ELSE one_rec.LB_Course_PriseFIID END);
        END IF;
        /*( Сумма НДР 1 ур. из поля <сумма в валюте> * Номинал ц/б на дату связи            * количество в связи     / (количество в сделке * Номинал на дату покупки из связи) )*  K  */
        v_Sum := (one_rec.t_Sum * one_rec.NominalAVROnSelDateLink * one_rec.TAmount / (one_rec.LBAmount * one_rec.NominalAVROnBuyDateLink ) )* v_K; 
      ELSE
        v_Sum := one_rec.t_Sum0 * one_rec.t_Cost / one_rec.t_Principal * (one_rec.TAmount - v_SumAmount_0) / 
                              (GetFaceValue_Ex(one_rec.t_FIID, one_rec.t_BuyDate) * one_rec.LBAmount);
      END IF;

      v_Sum := ROUND(v_Sum, 2);

      IF((v_Sum != 0) AND RSB_SECUR.IsRet_Coupon(one_rec.oGrp) = 0) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.DRWDealDate, one_rec.LBDealDate);
        
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.DrawingDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := RSI_RSB_FIInstr.NATCUR;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1060;                           
        nptxobj.T_ANALITIC1      := one_rec.Number_Partly;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2020;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Analitic6;                                            
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
         
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

    -- Получить суммарные параметры НДР по вставленным объектам по связям
  -- Flag_Buy: для покупок, кроме того, берём сумму НДР в валюте
  -- ExcludeKind - НДР, кол-во связи по которым надо исключить из подсчета кол-ва ц\б в связи для Kind 
  PROCEDURE GetSumNdrByLink(p_LotID          IN NUMBER,
                            p_Flag_Buy       IN NUMBER,
                            p_Kind           IN NUMBER,
                            p_DocID          IN NUMBER,
                            p_Step           IN NUMBER,
                            p_SumAmount     OUT NUMBER, 
                            p_SumNDR        OUT NUMBER, 
                            p_SumNDR_DelNom OUT NUMBER, 
                            p_NeedDelNom     IN NUMBER, 
                            p_ExcludeKind    IN NUMBER DEFAULT 0)
  AS
    v_query VARCHAR2(2000);
  BEGIN

    p_SumAmount     := 0;
    p_SumNDR        := 0;
    p_SumNDR_DelNom := 0;

    v_query := ' SELECT (NDR1.sum+NDR2.sum) SumNDR, (NDR1.Amount+NDR2.Amount) SumAmount ';

    IF(p_Flag_Buy != 0) THEN
      v_query := v_query || ', (NDR1.NDR_DelNom1+NDR2.NDR_DelNom2) SumNDR_DelNom ';
    ELSE
      v_query := v_query || ', 0 SumNDR_DelNom ';
    END IF;

    v_query := v_query || ' FROM ' ||
                          ' (';

    IF(p_Flag_Buy != 0) THEN 
      v_query := v_query || ' SELECT nvl(sum(TXOBJ.t_sum0),0) sum, ';
      IF p_NeedDelNom != 0 THEN
        v_query := v_query || '      nvl(sum(TXOBJ.t_sum0/(CASE WHEN rsi_rsb_fiinstr.FI_GetNominalOnDate (TXOBJ.t_analitic3, TXOBJ.t_Date) = 0 THEN 1 ELSE rsi_rsb_fiinstr.FI_GetNominalOnDate (TXOBJ.t_analitic3, TXOBJ.t_Date) END)),0) NDR_DelNom1, ';
      ELSE
        v_query := v_query || '      0 NDR_DelNom1, ';
      END IF;
    ELSE
      v_query := v_query || ' SELECT nvl(sum(TXOBJ.t_sum),0) sum, ';
    END IF;


    IF( p_ExcludeKind > 0 ) THEN
      v_query := v_query || 'nvl(sum(case when exists( select 1 from DNPTXOBJ_DBT OBJ '||
                            '                           WHERE OBJ.T_KIND = '|| TO_CHAR(p_ExcludeKind) ||
                            '                             AND OBJ.T_ANALITICKIND2 = '|| TO_CHAR(RSI_NPTXC.TXOBJ_KIND2010) ||
                            '                             AND OBJ.T_ANALITIC2 = LNK.T_ID '||
                            '                        ) then 0 ELSE LNK.t_Amount end),0) Amount ';
    ELSE
      v_query := v_query || 'nvl(sum(LNK.t_Amount),0) Amount ';
    END IF;

    v_query := v_query || '    FROM DNPTXOBJ_DBT TXOBJ, DNPTXLNK_DBT LNK ';
    IF(p_Flag_Buy != 0) THEN 
      v_query := v_query || '   WHERE LNK.T_BUYID = :p_LotID';
    ELSE 
      v_query := v_query || '   WHERE LNK.T_SALEID = :p_LotID';
    END IF;

    v_query := v_query || '     AND TXOBJ.T_KIND = :p_Kind' ||
                          '     AND TXOBJ.T_ANALITICKIND2 = '|| TO_CHAR(RSI_NPTXC.TXOBJ_KIND2010) ||
                          '     AND TXOBJ.T_ANALITIC2 = LNK.T_ID '||
                          ') NDR1 ';

    v_query := v_query || ', (';
    IF(p_Flag_Buy != 0) THEN 
      v_query := v_query || ' SELECT nvl(sum(RSI_RSB_FIInstr.ConvSum( TXOBJ.t_Sum, TXOBJ.t_Cur, 0, TXOBJ.t_Date, 1 )),0) sum, ';
      IF p_NeedDelNom != 0 THEN
        v_query := v_query || '      nvl(sum(RSI_RSB_FIInstr.ConvSum( TXOBJ.t_Sum, TXOBJ.t_Cur, 0, TXOBJ.t_Date, 1 )/(CASE WHEN rsi_rsb_fiinstr.FI_GetNominalOnDate (TXOBJ.t_analitic3, TXOBJ.t_Date) = 0 THEN 1 ELSE rsi_rsb_fiinstr.FI_GetNominalOnDate (TXOBJ.t_analitic3, TXOBJ.t_Date) END)),0) NDR_DelNom2, ';
      ELSE
        v_query := v_query || '      0 NDR_DelNom2, ';
      END IF;
    ELSE
      v_query := v_query || ' SELECT nvl(sum(TXOBJ.t_sum),0) sum, ';
    END IF;

    IF( p_ExcludeKind > 0 ) THEN
       v_query := v_query || '         nvl(sum(case when exists( select 1 from DNPTXOBJ_DBT OBJ '||
                             '                                    WHERE OBJ.T_KIND = '|| TO_CHAR(p_ExcludeKind) ||
                             '                                      AND OBJ.T_ANALITICKIND2 = '|| TO_CHAR(RSI_NPTXC.TXOBJ_KIND2010) ||
                             '                                      AND OBJ.T_ANALITIC2 = LNK.T_ID '||
                             '                                 ) then 0 ELSE LNK.t_Amount end),0) Amount ';
    ELSE
       v_query := v_query || 'nvl(sum(LNK.t_Amount),0) Amount ';
    END IF;

    v_query := v_query || '    FROM DNPTXOBJ_TMP TXOBJ, DNPTXLNK_DBT LNK ' ;
    IF(p_Flag_Buy != 0) THEN 
      v_query := v_query || '   WHERE LNK.T_BUYID = :p_LotID_1';
    ELSE 
      v_query := v_query || '   WHERE LNK.T_SALEID = :p_LotID_1';
    END IF;

    v_query := v_query || '     AND TXOBJ.T_KIND = :p_Kind_1' ||
                          '     AND TXOBJ.T_ANALITICKIND2 = '|| TO_CHAR(RSI_NPTXC.TXOBJ_KIND2010) ||
                          '     AND TXOBJ.T_ANALITIC2 = LNK.T_ID ' ||
                          '     AND TXOBJ.T_DOCID = :p_DocID' ||
                          '     AND TXOBJ.T_STEP  = :p_Step' ||
                          ') NDR2 ';


    EXECUTE IMMEDIATE v_query INTO p_SumNDR, p_SumAmount, p_SumNDR_DelNom USING IN p_LotID, p_Kind, p_LotID, p_Kind, p_DocID, p_Step;/*DEF-34748*/

  END;

  -- Получить суммарные параметры НДР по вставленным объектам по записям ТС
  -- Flag_Buy: для покупок, кроме того, берём сумму НДР в валюте
  -- ExcludeKind - НДР, кол-во связи по которым надо исключить из подсчета кол-ва ц\б в связи для Kind 
  PROCEDURE GetSumNdrByTS(p_LotID          IN NUMBER,
                          p_Flag_Buy       IN NUMBER,
                          p_Kind           IN NUMBER,
                          p_DocID          IN NUMBER,
                          p_Step           IN NUMBER,
                          p_SumAmount     OUT NUMBER, 
                          p_SumNDR        OUT NUMBER, 
                          p_SumNDR_DelNom OUT NUMBER, 
                          p_NeedDelNom     IN NUMBER, 
                          p_ExcludeKind    IN NUMBER DEFAULT 0)
  AS
    v_query VARCHAR2(2000);
  BEGIN

    p_SumAmount     := 0;
    p_SumNDR        := 0;
    p_SumNDR_DelNom := 0;


    v_query := ' SELECT (NDR1.sum+NDR2.sum) SumNDR, (NDR1.Amount+NDR2.Amount) SumAmount ';

    IF(p_Flag_Buy != 0) THEN
      v_query := v_query || ', (NDR1.NDR_DelNom1+NDR2.NDR_DelNom2) SumNDR_DelNom ';
    ELSE
      v_query := v_query || ', 0 SumNDR_DelNom ';
    END IF;


    v_query := v_query || ' FROM ' ||
                          '(';
    IF(p_Flag_Buy != 0) THEN 
      v_query := v_query || '  SELECT nvl(sum(TXOBJ.t_sum0),0) sum, ';
      IF p_NeedDelNom != 0 THEN
        v_query := v_query || '       nvl(sum(TXOBJ.t_sum0/(CASE WHEN rsi_rsb_fiinstr.FI_GetNominalOnDate (TXOBJ.t_analitic3, TXOBJ.t_Date) = 0 THEN 1 ELSE rsi_rsb_fiinstr.FI_GetNominalOnDate (TXOBJ.t_analitic3, TXOBJ.t_Date) END)),0) NDR_DelNom1, ';
      ELSE
        v_query := v_query || '       0 NDR_DelNom1, ';
      END IF;
    ELSE
      v_query := v_query || '  SELECT nvl(sum(TXOBJ.t_sum),0) sum, ';
    END IF;

    IF( p_ExcludeKind > 0 ) THEN
      v_query := v_query || '         nvl(sum(case when exists( select 1 from DNPTXOBJ_DBT OBJ '||
                            '                                    WHERE OBJ.T_KIND = '|| TO_CHAR(p_ExcludeKind) ||
                            '                                      AND OBJ.T_ANALITICKIND2 = '|| TO_CHAR(RSI_NPTXC.TXOBJ_KIND2020) ||
                            '                                      AND OBJ.T_ANALITIC2 = TS.T_ID '||
                            '                                 ) then 0 ELSE TS.t_Amount end),0) Amount ';
    ELSE
      v_query := v_query || '         nvl(sum(TS.t_Amount),0) Amount ';
    END IF;

    v_query := v_query || '    FROM DNPTXOBJ_DBT TXOBJ, DNPTXTS_DBT TS ';
    IF(p_Flag_Buy != 0) THEN
      v_query := v_query || '   WHERE TS.T_BUYID = :p_LotID ';
    ELSE
      v_query := v_query || '   WHERE TS.T_SALEID = :p_LotID ';
    END IF;

    v_query := v_query || '     AND TXOBJ.T_KIND = :p_Kind ' ||
                          '     AND TXOBJ.T_ANALITICKIND2 = '|| TO_CHAR(RSI_NPTXC.TXOBJ_KIND2020) ||
                          '     AND TXOBJ.T_ANALITIC2 = TS.T_ID ' ||
                          ') NDR1 ';

    v_query := v_query || ', (';
    IF(p_Flag_Buy != 0) THEN 
      v_query := v_query || '  SELECT nvl(sum(RSI_RSB_FIInstr.ConvSum( TXOBJ.t_Sum, TXOBJ.t_Cur, 0, TXOBJ.t_Date, 1 )),0) sum, ';
      IF p_NeedDelNom != 0 THEN
        v_query := v_query || '       nvl(sum(RSI_RSB_FIInstr.ConvSum( TXOBJ.t_Sum, TXOBJ.t_Cur, 0, TXOBJ.t_Date, 1 )/(CASE WHEN rsi_rsb_fiinstr.FI_GetNominalOnDate (TXOBJ.t_analitic3, TXOBJ.t_Date) = 0 THEN 1 ELSE rsi_rsb_fiinstr.FI_GetNominalOnDate (TXOBJ.t_analitic3, TXOBJ.t_Date) END)),0) NDR_DelNom2, ';
      ELSE
        v_query := v_query || '       0 NDR_DelNom2, ';
      END IF;
    ELSE
      v_query := v_query || '  SELECT nvl(sum(TXOBJ.t_sum),0) sum, ';
    END IF;

    IF( p_ExcludeKind > 0 ) THEN
      v_query := v_query || '         nvl(sum(case when exists( select 1 from DNPTXOBJ_DBT OBJ '||
                            '                                    WHERE OBJ.T_KIND = '|| TO_CHAR(p_ExcludeKind) ||
                            '                                      AND OBJ.T_ANALITICKIND2 = '|| TO_CHAR(RSI_NPTXC.TXOBJ_KIND2020) ||
                            '                                      AND OBJ.T_ANALITIC2 = TS.T_ID '||
                            '                                 ) then 0 ELSE TS.t_Amount end),0) Amount ';
    ELSE
      v_query := v_query || '         nvl(sum(TS.t_Amount),0) Amount ';
    END IF;

    v_query := v_query || '    FROM DNPTXOBJ_TMP TXOBJ, DNPTXTS_DBT TS ';
    IF(p_Flag_Buy != 0) THEN
      v_query := v_query || '   WHERE TS.T_BUYID = :p_LotID_1 ';
    ELSE
      v_query := v_query || '   WHERE TS.T_SALEID = :p_LotID_1 ';
    END IF;

    v_query := v_query || '     AND TXOBJ.T_KIND = :p_Kind_1 ' ||
                          '     AND TXOBJ.T_ANALITICKIND2 = '|| TO_CHAR(RSI_NPTXC.TXOBJ_KIND2020) ||
                          '     AND TXOBJ.T_ANALITIC2 = TS.T_ID '||
                          '     AND TXOBJ.T_DOCID = :p_DocID ' ||
                          '     AND TXOBJ.T_STEP  = :p_Step ' ||
                          ') NDR2 ';

    EXECUTE IMMEDIATE v_query INTO p_SumNDR, p_SumAmount, p_SumNDR_DelNom USING IN p_LotID, p_Kind, p_LotID, p_Kind, p_DocID, p_Step;/*DEF-34748*/

  END;

  FUNCTION GetNDRCurrency(p_Client         IN NUMBER, 
                          p_Date           IN DATE,
                          p_Kind           IN NUMBER, 
                          p_Analitic5      IN NUMBER, 
                          p_AnaliticKind1N IN NUMBER, 
                          p_Analitic1N     IN NUMBER, 
                          p_Analitic3N     IN NUMBER DEFAULT -2) RETURN NUMBER
  AS
    v_CurID NUMBER := RSI_RSB_FIInstr.NATCUR;
  BEGIN

    SELECT t_Cur 
      INTO v_CurID
      FROM dnptxobj_dbt 
     WHERE t_Client        = p_Client 
       AND t_Date          = p_Date 
       AND t_Kind          = p_Kind 
       AND t_Analitic5     = p_Analitic5 
       AND t_AnaliticKind1 = p_AnaliticKind1N 
       AND t_Analitic1     = p_Analitic1N
       AND t_Analitic3     = (CASE WHEN p_Analitic3N = -2 THEN t_Analitic3 ELSE p_Analitic3N END)
       AND ROWNUM          = 1;

    RETURN v_CurID;

    EXCEPTION
         WHEN OTHERS THEN RETURN RSI_RSB_FIInstr.NATCUR;
  END;

  --Расчет объектов НДР по связям
  PROCEDURE CreateTaxObjects2_4(pBegDate IN  DATE,
                                pEndDate IN  DATE,
                                pClient  IN  NUMBER,
                                pIIS     IN  NUMBER,
                                pDocID   IN  NUMBER,
                                pStep    IN  NUMBER,
                                pFIID    IN  NUMBER,
                                pContract  IN NUMBER,
                                pStat    OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
                    
    v_prevBuyID     NUMBER;
    v_prevSumAmount NUMBER;
    v_prevSum       NUMBER;

    v_SumNDR_TS     NUMBER;
    v_SumNDR_TS_0   NUMBER;
    v_SumAmount_MB  NUMBER;
    v_SumAmount     NUMBER;
    v_SumAmount_0   NUMBER;
    v_SumNDR_TS_1   NUMBER;
    v_SumNDR_TS_0_1 NUMBER;
    v_SumNDR        NUMBER;
    v_SumNDR_0      NUMBER;
    v_SumNDR_1      NUMBER;
    v_SumNDR_0_1    NUMBER;
    v_Sum           NUMBER;
    v_Sum_0         NUMBER;
    v_SumNDR_DelNom NUMBER;
    v_diff          NUMBER; 

    v_K             NUMBER;
    v_CurN          NUMBER;

    v_Kpog NUMBER;

  BEGIN

    pStat := 0;

    v_prevBuyID     := 0;
    v_prevSumAmount := 0;
    v_prevSum       := 0;

    DELETE FROM DNPTXOP1OPLNK_TMP;

    --Вставим все подходящие связи во временную таблицу
    INSERT INTO DNPTXOP1OPLNK_TMP (T_DOCID, T_PARENT_DOCID, T_AMOUNT)
    WITH sf as (SELECT t_PartyID, t_ID 
                  FROM dsfcontr_dbt 
                 WHERE t_PartyID = pClient 
                   AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS 
                   AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
               )
    SELECT DISTINCT S.t_ID, S.t_ID, S.T_AMOUNT 
      FROM sf, dnptxlnk_dbt S, 
           (SELECT t_Date, t_Kind, NVL(SUM(t_Sum), 0) t_Sum, NVL(SUM(t_Sum0), 0) t_Sum0, t_Analitic5, t_AnaliticKind1, t_Analitic1, t_Analitic3 
              FROM dnptxobj_dbt 
             WHERE t_Client = pClient 
               AND t_Kind = RSI_NPTXC.TXOBJ_MAIN 
               AND (t_AnaliticKind1 <> RSI_NPTXC.TXOBJ_KIND1020
                   OR NOT EXISTS(SELECT 1 FROM ddl_tick_dbt tick
                                  WHERE tick.t_dealid = t_Analitic1
                                    AND RSI_RSB_FIINSTR.FI_ISKSU(tick.t_pfi) = 1)
                   )
               AND t_AnaliticKind3 = RSI_NPTXC.TXOBJ_KIND3010
             GROUP BY t_Date, t_Kind, t_Analitic5, t_AnaliticKind1, t_Analitic1, t_Analitic3                       
           ) N, v_npx_dnptxlot LB, v_npx_dnptxlot LS, dfininstr_dbt fin, ddl_tick_dbt tks, ddl_tick_dbt tkb 
     WHERE S.t_Client = sf.t_PartyID 
       AND S.t_Contract = sf.t_ID 
       AND N.t_AnaliticKind1 = LB.t_AnaliticKind1 
       AND N.t_Analitic1     = LB.t_Analitic1 
       AND fin.t_FIID        = S.t_FIID 
       AND EXISTS ( SELECT Obj.t_Analitic1 
                      FROM dnptxobj_dbt Obj 
                     WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                       AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                       AND Obj.t_Analitic1     = LS.t_Analitic1 
                       AND Obj.t_Client = pClient
                       AND RSI_NPTO.CheckObjIIS (Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                  ) 
       AND LB.t_Kind  = RSI_NPTXC.NPTXLOTS_BUY
       AND S.t_BuyID  = LB.t_ID 
       AND S.t_SaleID = LS.t_ID 
       AND (   LS.t_DocKind <> RSI_NPTXC.TXOBJ_KIND1070
            OR (LS.t_DocKind = RSI_NPTXC.TXOBJ_KIND1070 AND RSB_SECUR.GetMainObjAttr(101, LPAD(LS.t_DocID, 34, '0'), 55, LS.t_DealDate) = 1)
           )
       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
       AND S.t_Type = RSI_NPTXC.NPTXLNK_DELIVER
       AND N.t_Analitic3 = S.t_FIID 
       AND ((N.t_Date <= pEndDate AND S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
            (N.t_Date <= pEndDate AND N.t_Date >= pBegDate AND S.t_Date <  pBegDate) OR 
            (N.t_Date <  pBegDate AND S.t_Date <  pBegDate AND ( SELECT NVL(MIN(Obj.t_Date), g_ZeroDate) D 
                                                     FROM dnptxobj_dbt Obj 
                                                    WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                      AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                                      AND Obj.t_Analitic1     = LS.t_Analitic1 
                                                      AND Obj.t_Client = pClient
                                                      AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6) = pIIS
                                                 ) BETWEEN pBegDate AND pEndDate )) 
       AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
       AND tks.t_BOfficeKind = LS.t_DocKind
       AND tks.t_DealID = LS.t_DocID
       AND tkb.t_BOfficeKind = LB.t_DocKind
       AND tkb.t_DealID = LB.t_DocID;

    AddChildLinksToTMP(pDocID, pBegDate, pEndDate, TRUE);

    FOR one_rec IN (SELECT /*+ leading(TMP) index(S DNPTXLNK_DBT_IDX0) index(PS DNPTXLNK_DBT_IDX0) index(LB DNPTXLOT_DBT_IDX0) index(LS DNPTXLOT_DBT_IDX0) index(PLB DNPTXLOT_DBT_IDX0) index(PLS DNPTXLOT_DBT_IDX0) index(fin DFININSTR_DBT_IDX0)*/
                           N.t_Date, N.t_Sum, N.t_Sum0, N.t_Analitic5, 
                           LS.t_AnaliticKind1, LS.t_Analitic1, N.t_AnaliticKind1 t_AnaliticKind1N, N.t_Analitic1 t_Analitic1N, N.t_Analitic3 t_Analitic3N, N.t_Kind, 
                           S.t_ID, PS.t_FIID, PS.t_Date SDate, TMP.t_Amount SAmount, S.t_PrivAmount SPrivAmount, S.t_Contract, S.t_BuyID, 
                           LB.t_BuyDate, NVL(LB.t_Amount,0) LBAmount, LB.t_PriceFIID LBPriceFIID, LB.T_DOCID as BuyDealID, LB.t_DealCode as LBDealCode,
                           NVL(rsb_fiinstr.FI_GetNominalOnDate(PS.t_FIID, PS.t_Date), 0.0) NominalAVROnSelDateLink, 
                           NVL(rsb_fiinstr.FI_GetNominalOnDate(PS.t_FIID, LB.t_BuyDate), 0.0) NominalAVROnBuyDateLink, 
                           NVL(rsb_fiinstr.ConvSum(1, fin.t_FaceValueFI, RSI_RSB_FIInstr.NATCUR, PLS.t_saleDate), 0.0) PLSCourseNominal, 
                           NVL(rsb_fiinstr.ConvSum(1, fin.t_FaceValueFI, RSI_RSB_FIInstr.NATCUR, LB.t_buyDate), 0.0) LBCourseNominal, 
                           fin.t_FI_Kind, fin.t_AvoirKind, fin.t_FaceValueFI, fin.t_FaceValue, fin.t_FI_Code,
                           LS.t_DealDate as LSDealDate, LB.t_DealDate as LBDealDate,
                           PLS.t_DealDate as PLSDealDate, PLS.t_SaleDate as PLSSaleDate, PLB.t_BuyDate as PLBBuyDate,
                           NVL(RSB_SECUR.GetMainObjAttr(101, LPAD(LS.t_DocID, 34, '0'), 55, LS.t_DealDate), 0) as IsChSaleRepl,
                           NVL(RSB_SECUR.GetMainObjAttr(101, LPAD(PLS.t_DocID, 34, '0'), 55, PLS.t_DealDate), 0) as IsReplSale,
                           NVL(RSB_SECUR.GetMainObjAttr(101, LPAD(PLB.t_DocID, 34, '0'), 55, PLB.t_DealDate), 0) as IsReplBuy,
                           (CASE WHEN PLB.T_GOID > 0 THEN NVL((SELECT (CASE WHEN comm.t_CorpActionDate = g_ZeroDate THEN PLB.t_DealDate ELSE comm.t_CorpActionDate END)
                                                                 FROM dnptxgo_dbt go, ddl_comm_dbt comm
                                                                WHERE go.t_ID = PLB.T_GOID
                                                                  AND comm.t_DocKind = go.t_DocKind
                                                                  AND comm.t_DocumentID = go.t_DocumentID
                                                              ), PLB.t_DealDate)
                                 ELSE PLB.t_DealDate END) as PLBDealDate,
                           TMP.T_PARENT_DOCID as Parent_LnkID,
                           (CASE WHEN PLS.t_DocKind = RSB_SECUR.DL_RETIREMENT AND NVL(rsb_fiinstr.FI_GetNominalOnDate(PS.t_FIID, PLB.t_BuyDate), 0.0) > 0
                                      AND EXISTS(SELECT 1
                                                   FROM (SELECT DISTINCT obj.t_OutObjID
                                                           FROM dnptxobj_dbt obj
                                                          WHERE obj.t_AnaliticKind1 = RSI_NPTXC.TXOBJ_KIND1020
                                                            AND obj.t_Analitic1 = PLS.t_DocID
                                                            AND obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                            AND obj.t_OutObjID <> CHR(1)
                                                        ) o, dcdrecords_dbt cd
                                                  WHERE cd.t_PartyID = pClient
                                                    AND cd.t_RecordPaymentQtyID = TO_NUMBER(o.t_OutObjID)
                                                    AND cd.t_ID = (SELECT MAX(cd1.t_ID) 
                                                                     FROM dcdrecords_dbt cd1 
                                                                    WHERE cd1.t_PartyID = pClient
                                                                      AND cd1.t_RecordPaymentQtyID = TO_NUMBER(o.t_OutObjID)
                                                                  )
                                                ) THEN RSI_RSB_FIInstr.FI_GetNominalOnDate(PS.t_FIID, NVL((SELECT MAX(fw.t_DrawingDate)
                                                                                                             FROM dfiwarnts_dbt fw
                                                                                                            WHERE fw.t_FIID = PS.t_FIID
                                                                                                                  AND fw.T_ISCLOSED = 'X'
                                                                                                                  AND fw.t_IsPartial = 'X'
                                                                                                         ), PS.t_Date-1)) / rsb_fiinstr.FI_GetNominalOnDate(PS.t_FIID, PLB.t_BuyDate)
                                 ELSE 1 END
                           ) as Kpog,
                           (CASE WHEN PLS.t_DocKind = RSB_SECUR.DL_RETIREMENT THEN NVL((SELECT MAX(obj.t_Date)
                                                                                          FROM dnptxobj_dbt obj
                                                                                         WHERE obj.t_AnaliticKind1 = RSI_NPTXC.TXOBJ_KIND1020
                                                                                           AND obj.t_Analitic1 = PLS.t_DocID
                                                                                           AND obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                                                           AND obj.t_Direction = RSI_NPTXC.TXOBJ_DIR_IN
                                                                                        ), PS.t_Date
                                                                                       )
                                 ELSE PS.t_Date END) as NewObjDate,
                           sf.t_Number as ContrNumber
                      FROM dnptxlnk_dbt S, 
                           (SELECT t_Date, t_Kind, NVL(SUM(t_Sum), 0) t_Sum, NVL(SUM(t_Sum0), 0) t_Sum0, t_Analitic5, t_AnaliticKind1, t_Analitic1, t_Analitic3 
                              FROM dnptxobj_dbt 
                             WHERE t_Client = pClient 
                               AND t_Kind = RSI_NPTXC.TXOBJ_MAIN 
                               AND (t_AnaliticKind1 <> RSI_NPTXC.TXOBJ_KIND1020
                                   OR NOT EXISTS(SELECT 1 FROM ddl_tick_dbt tick
                                                  WHERE tick.t_dealid = t_Analitic1
                                                    AND RSI_RSB_FIINSTR.FI_ISKSU(tick.t_pfi) = 1)
                                   )
                               AND t_AnaliticKind3 = RSI_NPTXC.TXOBJ_KIND3010
                             GROUP BY t_Date, t_Kind, t_Analitic5, t_AnaliticKind1, t_Analitic1, t_Analitic3                       
                           ) N, v_npx_dnptxlot LB, v_npx_dnptxlot LS, dfininstr_dbt fin, DNPTXOP1OPLNK_TMP TMP, dnptxlnk_dbt PS, v_npx_dnptxlot PLB, v_npx_dnptxlot PLS, dsfcontr_dbt sf
                     WHERE S.t_ID = TMP.T_DOCID
                       AND PS.t_ID = TMP.T_PARENT_DOCID 
                       AND N.t_AnaliticKind1 = LB.t_AnaliticKind1 
                       AND N.t_Analitic1     = LB.t_Analitic1 
                       AND fin.t_FIID        = PS.t_FIID 
                       AND EXISTS ( SELECT Obj.t_Analitic1 
                                      FROM dnptxobj_dbt Obj 
                                     WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                       AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                       AND Obj.t_Analitic1     = LS.t_Analitic1 
                                       AND Obj.t_Client = pClient
                                       AND RSI_NPTO.CheckObjIIS (Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                                  ) 
                       AND LB.t_Kind  = RSI_NPTXC.NPTXLOTS_BUY
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID
                       AND PS.t_BuyID  = PLB.t_ID 
                       AND PS.t_SaleID = PLS.t_ID 
                       AND (   LS.t_DocKind <> RSI_NPTXC.TXOBJ_KIND1070
                            OR (LS.t_DocKind = RSI_NPTXC.TXOBJ_KIND1070 AND RSB_SECUR.GetMainObjAttr(101, LPAD(LS.t_DocID, 34, '0'), 55, LS.t_DealDate) = 1)
                           )
                       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
                       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
                       AND S.t_Type = RSI_NPTXC.NPTXLNK_DELIVER
                       AND N.t_Analitic3 = S.t_FIID 
                       AND ((TMP.T_DOCID <> TMP.T_PARENT_DOCID) OR
                            (N.t_Date <= pEndDate AND S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
                            (N.t_Date <= pEndDate AND N.t_Date >= pBegDate AND S.t_Date <  pBegDate) OR 
                            (N.t_Date <  pBegDate AND S.t_Date <  pBegDate AND ( SELECT NVL(MIN(Obj.t_Date), g_ZeroDate) D 
                                                                     FROM dnptxobj_dbt Obj 
                                                                    WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                                      AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                                                      AND Obj.t_Analitic1     = LS.t_Analitic1 
                                                                      AND Obj.t_Client = pClient
                                                                      AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6) = pIIS
                                                                 ) BETWEEN pBegDate AND pEndDate ))
                       AND sf.t_ID = PS.t_Contract                                           
                     ORDER BY S.t_BuyID
                    )
    LOOP

      v_Kpog := one_rec.Kpog;

      IF(one_rec.Parent_LnkID <> one_rec.t_ID) THEN
        v_SumAmount   := 0;
        v_SumNDR      := 0;
        v_SumNDR_TS   := 0;
        v_SumNDR_1    := 0;
        v_SumNDR_TS_1 := 0;
      ELSIF(v_prevBuyID != one_rec.t_BuyID) THEN

        v_SumNDR_TS := 0;
        GetSumNdrByLink(one_rec.t_BuyID, 1, RSI_NPTXC.TXOBJ_MAINB_TS, pDocID, pStep, v_SumAmount, v_SumNDR_TS, v_SumNDR_DelNom, 0);
        
        v_SumNDR_TS_0 := 0;
        GetSumNdrByLink(one_rec.t_BuyID, 1, RSI_NPTXC.TXOBJ_MAINB_TS_0, pDocID, pStep, v_SumAmount, v_SumNDR_TS_0, v_SumNDR_DelNom, 0);

        v_SumNDR_TS := v_SumNDR_TS + v_SumNDR_TS_0;

        GetSumNdrByLink(one_rec.t_BuyID, 1, RSI_NPTXC.TXOBJ_MAINB_0, pDocID, pStep, v_SumAmount_0, v_SumNDR_0, v_SumNDR_DelNom, 0, RSI_NPTXC.TXOBJ_MAINB);

        GetSumNdrByLink(one_rec.t_BuyID, 1, RSI_NPTXC.TXOBJ_MAINB, pDocID, pStep, v_SumAmount, v_SumNDR, v_SumNDR_DelNom, 0);

        v_SumAmount_MB := v_SumAmount + v_SumAmount_0;

        --Если объекты НДР были созданы не по связям, а по остаткам
        GetSumNdrByTS(one_rec.t_BuyID, 1, RSI_NPTXC.TXOBJ_MAINB_TS, pDocID, pStep, v_SumAmount, v_SumNDR_TS_1, v_SumNDR_DelNom, 0);
        
        GetSumNdrByTS(one_rec.t_BuyID, 1, RSI_NPTXC.TXOBJ_MAINB_TS_0, pDocID, pStep, v_SumAmount, v_SumNDR_TS_0_1, v_SumNDR_DelNom, 0);

        v_SumNDR_TS_1 := v_SumNDR_TS_1 + v_SumNDR_TS_0_1;

        GetSumNdrByTS(one_rec.t_BuyID, 1, RSI_NPTXC.TXOBJ_MAINB_0, pDocID, pStep, v_SumAmount_0, v_SumNDR_0_1, v_SumNDR_DelNom, 0, RSI_NPTXC.TXOBJ_MAINB);

        GetSumNdrByTS(one_rec.t_BuyID, 1, RSI_NPTXC.TXOBJ_MAINB, pDocID, pStep, v_SumAmount, v_SumNDR_1, v_SumNDR_DelNom, 0);

        v_SumAmount := v_SumAmount + v_SumAmount_MB + v_SumAmount_0;
        v_SumNDR    := v_SumNDR + v_SumNDR_1 + v_SumNDR_0 + v_SumNDR_0_1;

      ELSIF(v_prevSum != 0) THEN
        v_SumNDR    := v_SumNDR + v_prevSum;
        v_SumAmount := v_SumAmount + v_prevSumAmount;
      END IF;


      IF ((one_rec.LBAmount - v_SumAmount) < 0) THEN                                                                                        
        RSI_NPTMSG.PutMsg(RSI_NPTXC.MES_ERROR, one_rec.ContrNumber||' Количество бумаг '||one_rec.t_FI_Code||' в связях превышает количество бумаг в сделке '||one_rec.LBDealCode);
      ELSIF ((one_rec.LBAmount - v_SumAmount) = 0) THEN
        v_Sum   := 0;
        v_Sum_0 := 0;
      ELSIF ((one_rec.t_FI_Kind = RSI_RSB_FIINSTR.FIKIND_AVOIRISS) AND (one_rec.t_AvoirKind = RSI_RSB_FIINSTR.AVOIRKIND_BOND_OVVZ) and (one_rec.SDate >= TO_DATE('01.01.2019','DD.MM.YYYY'))) THEN
        /*ОВВЗ и дата продажи больще 1 января 2019 года*/
        v_K := 0;
        v_CurN := GetNDRCurrency(pClient, one_rec.t_Date, one_rec.t_Kind, one_rec.t_Analitic5, one_rec.t_AnaliticKind1N, one_rec.t_Analitic1N, one_rec.t_Analitic3N );

        IF(v_CurN = RSI_RSB_FIInstr.NATCUR) THEN
          IF(one_rec.LBCourseNominal != 0) THEN -- prevent error divide by zero
            v_K := one_rec.PLSCourseNominal / one_rec.LBCourseNominal;
          END IF;
        ELSE
          v_K := NVL(rsb_fiinstr.ConvSum(1, v_CurN, RSI_RSB_FIInstr.NATCUR, (CASE WHEN one_rec.IsChSaleRepl <> 0 or (one_rec.IsReplBuy = 0 and one_rec.IsReplSale = 0) THEN one_rec.PLSSaleDate ELSE one_rec.PLBBuyDate END)), 0.0);
        END IF;
        /*( Сумма НДР 1 ур. из поля <сумма в валюте> * Номинал ц/б на дату связи            * количество в связи     / (количество в сделке * Номинал на дату покупки из связи) )*  K  */
        
        v_Sum := 0;
        IF((one_rec.LBAmount * one_rec.NominalAVROnBuyDateLink) != 0) THEN --divide by zero
          v_Sum := (one_rec.t_Sum*v_Kpog * one_rec.NominalAVROnSelDateLink * one_rec.SAmount / (one_rec.LBAmount * one_rec.NominalAVROnBuyDateLink))* v_K; 
        END IF;
      ELSE
        -- prevent error divide by zero
        v_Sum   := 0; 
        v_Sum_0 := 0;

        v_diff := one_rec.LBAmount - v_SumAmount;
        IF(v_diff != 0) THEN 
          v_Sum   := ((one_rec.t_Sum0*v_Kpog - v_SumNDR - v_SumNDR_TS - v_SumNDR_1 - v_SumNDR_TS_1) / v_diff) * (one_rec.SAmount-one_rec.SPrivAmount);
          v_Sum_0 := ((one_rec.t_Sum0*v_Kpog - v_SumNDR - v_SumNDR_TS - v_SumNDR_1 - v_SumNDR_TS_1) / v_diff) * one_rec.SPrivAmount;
        END IF;
      END IF;

      -- не округляем только для последней связи
      IF((v_SumAmount + one_rec.SAmount) != one_rec.LBAmount) THEN
        v_Sum   := ROUND(v_Sum, 2);
        v_Sum_0 := ROUND(v_Sum_0, 2);
      END IF;

      IF v_Sum != 0 OR v_Sum_0 != 0 THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.PLSDealDate, one_rec.PLBBuyDate);
      END IF;

      IF v_Sum != 0 THEN
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.NewObjDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_MAINB;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := RSI_RSB_FIInstr.NATCUR;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := 'Затраты на приобретение (основная сумма)'||(CASE WHEN one_rec.Parent_LnkID <> one_rec.t_ID THEN '. Сделка замещения '||TO_CHAR(one_rec.BuyDealID) ELSE '' END);      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj; 
         
      END IF;

      IF v_Sum_0 != 0 THEN
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.NewObjDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_MAINB_0;                              
        nptxobj.T_SUM            := v_Sum_0;                                                 
        nptxobj.T_CUR            := RSI_RSB_FIInstr.NATCUR;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := 'Затраты на приобретение льготных ц/б (основная сумма)'||(CASE WHEN one_rec.Parent_LnkID <> one_rec.t_ID THEN '. Сделка замещения '||TO_CHAR(one_rec.BuyDealID) ELSE '' END);      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      END IF;

      v_prevBuyID         := one_rec.t_BuyID;
      v_prevSumAmount     := one_rec.SAmount;
      v_prevSum           := v_Sum + v_Sum_0;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

    DELETE FROM DNPTXOP1OPLNK_TMP;

  END;

  --Расчет объектов НДР по связям
  PROCEDURE CreateTaxObjects2_5(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
                    
    v_prevBuyID     NUMBER;
    v_prevSumAmount NUMBER;
    v_prevKind      NUMBER;
    v_prevSum       NUMBER;

    v_SumNDR_TS     NUMBER;
    v_SumNDR_TS_0   NUMBER;
    v_SumAmount_MB  NUMBER;
    v_SumAmount     NUMBER;
    v_SumAmount_0   NUMBER;
    v_SumNDR_TS_1   NUMBER;
    v_SumNDR_TS_0_1 NUMBER;
    v_SumNDR        NUMBER;
    v_SumNDR_0      NUMBER;
    v_SumNDR_1      NUMBER;
    v_SumNDR_0_1    NUMBER;
    v_Sum           NUMBER;
    v_Sum_0         NUMBER;
    v_SumNDR_DelNom NUMBER;
    v_diff          NUMBER;
    v_Dir           NUMBER;
    v_Kind          NUMBER;
    v_Comment       DNPTXOBJ_TMP.T_COMMENT%TYPE; 

    v_K             NUMBER;
    v_CurNKD        NUMBER;

    v_Flag1         BOOLEAN;
    v_SumCom        NUMBER;
    v_SumCom_0      NUMBER;
    v_SumComF1      NUMBER;

    v_AddSumNDR_TS  NUMBER;

    v_Kpog NUMBER;

  BEGIN
  
    pStat := 0;

    v_prevBuyID     := 0;
    v_prevSumAmount := 0;
    v_prevKind      := 0;

    DELETE FROM DNPTXOP1OPLNK_TMP;

    --Вставим все подходящие связи во временную таблицу
    INSERT INTO DNPTXOP1OPLNK_TMP (T_DOCID, T_PARENT_DOCID, T_AMOUNT)
    SELECT DISTINCT S.t_ID, S.t_ID, S.T_AMOUNT 
      FROM (SELECT t_Date, t_Kind, NVL(sum(t_Sum), 0) t_Sum, NVL(sum(t_Sum0), 0) t_Sum0, t_Analitic5, t_AnaliticKind1, t_Analitic1 
              FROM dnptxobj_dbt 
             WHERE t_Client = pClient 
               AND t_Kind IN   (RSI_NPTXC.TXOBJ_COM, 
                                RSI_NPTXC.TXOBJ_DIF, 
                                RSI_NPTXC.TXOBJ_NKD,
                                RSI_NPTXC.TXOBJ_MATERIAL
                              ) 
             GROUP BY t_Date, t_Kind, t_Analitic5, t_AnaliticKind1, t_Analitic1                       
           ) N, v_npx_dnptxlot LB, v_npx_dnptxlot LS, dnptxlnk_dbt S, dfininstr_dbt fin, ddl_tick_dbt tks 
     WHERE S.t_Client = pClient
       AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS
       AND ((pContract IS NULL) OR (pContract <= 0) OR (S.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
       AND N.t_AnaliticKind1 = LB.t_AnaliticKind1 
       AND N.t_Analitic1     = LB.t_Analitic1 
       AND fin.t_FIID        = S.t_FIID 
       AND EXISTS(SELECT Obj.t_Analitic1 
                    FROM dnptxobj_dbt Obj 
                   WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                     AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                     AND Obj.t_Analitic1     = LS.t_Analitic1 
                     AND Obj.t_Client = pClient
                     AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6) = pIIS
                 ) 
       AND LB.t_Kind  = RSI_NPTXC.NPTXLOTS_BUY
       AND S.t_BuyID  = LB.t_ID 
       AND S.t_SaleID = LS.t_ID 
       AND (   LS.t_DocKind <> RSI_NPTXC.TXOBJ_KIND1070
            OR (LS.t_DocKind = RSI_NPTXC.TXOBJ_KIND1070 AND RSB_SECUR.GetMainObjAttr(101, LPAD(LS.t_DocID, 34, '0'), 55, LS.t_DealDate) = 1)
           )
       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
       AND S.t_Type = RSI_NPTXC.NPTXLNK_DELIVER
       AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
       AND ((N.t_Date <= pEndDate AND S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
            (N.t_Date <= pEndDate AND N.t_Date >= pBegDate AND S.t_Date <  pBegDate) OR 
            (N.t_Date <  pBegDate AND S.t_Date <  pBegDate AND (SELECT NVL(MIN(Obj.t_Date), g_ZeroDate) D 
                                                     FROM dnptxobj_dbt Obj 
                                                    WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                      AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                                      AND Obj.t_Analitic1     = LS.t_Analitic1  
                                                      AND Obj.t_Client = pClient
                                                      AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6) = pIIS
                                              ) BETWEEN pBegDate AND pEndDate )  
            )
       AND tks.t_BOfficeKind = LS.t_DocKind
       AND tks.t_DealID = LS.t_DocID;

    AddChildLinksToTMP(pDocID, pBegDate, pEndDate, FALSE);

    FOR one_rec IN (SELECT /*+ leading(TMP) index(S DNPTXLNK_DBT_IDX0) index(PS DNPTXLNK_DBT_IDX0) index(LB DNPTXLOT_DBT_IDX0) index(LS DNPTXLOT_DBT_IDX0) index(PLB DNPTXLOT_DBT_IDX0) index(PLS DNPTXLOT_DBT_IDX0) index(fin DFININSTR_DBT_IDX0)*/
                           N.t_Date, N.t_Kind, N.t_Sum, N.t_Sum0, N.t_Analitic5, 
                           LS.t_AnaliticKind1, LS.t_Analitic1, N.t_AnaliticKind1 t_AnaliticKind1N, N.t_Analitic1 t_Analitic1N,
                           S.t_ID, PS.t_FIID, PS.t_Date SDate, Nvl(TMP.t_Amount,0) SAmount, Nvl(S.t_PrivAmount,0) SPrivAmount, S.t_Contract, S.t_BuyID, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, LB.t_PriceFIID LBPriceFIID, LB.t_DocID AS BuyDealID, LB.t_DealCode as LBDealCode,
                           NVL(rsb_fiinstr.FI_GetNominalOnDate(PS.t_FIID, PS.t_Date ), 0.0) NominalAVROnSelDateLink, 
                           NVL(rsb_fiinstr.FI_GetNominalOnDate(PS.t_FIID, PLB.t_BuyDate ), 0.0) NominalAVROnBuyDateLink, 
                           NVL(rsb_fiinstr.ConvSum(1, fin.t_FaceValueFI, RSI_RSB_FIInstr.NATCUR, PLS.t_saleDate ), 0.0) PLSCourseNominal, 
                           NVL(rsb_fiinstr.ConvSum(1, fin.t_FaceValueFI, RSI_RSB_FIInstr.NATCUR, LB.t_buyDate ), 0.0) LBCourseNominal, 
                           fin.t_FI_Kind, fin.t_AvoirKind, fin.t_FaceValueFI, fin.t_FaceValue, fin.t_FI_Code, 
                           LS.t_DealDate as LSDealDate, LB.t_DealDate as LBDealDate,
                           PLS.t_DealDate as PLSDealDate, PLS.t_SaleDate as PLSSaleDate, PLB.t_BuyDate as PLBBuyDate,
                           NVL(RSB_SECUR.GetMainObjAttr(101, LPAD(LS.t_DocID, 34, '0'), 55, LS.t_DealDate), 0) as IsChSaleRepl,
                           NVL(RSB_SECUR.GetMainObjAttr(101, LPAD(PLS.t_DocID, 34, '0'), 55, PLS.t_DealDate), 0) as IsReplSale,
                           NVL(RSB_SECUR.GetMainObjAttr(101, LPAD(PLB.t_DocID, 34, '0'), 55, PLB.t_DealDate), 0) as IsReplBuy,
                           (CASE WHEN PLB.T_GOID > 0 THEN NVL((SELECT (CASE WHEN comm.t_CorpActionDate = g_ZeroDate THEN PLB.t_DealDate ELSE comm.t_CorpActionDate END)
                                                                 FROM dnptxgo_dbt go, ddl_comm_dbt comm
                                                                WHERE go.t_ID = PLB.T_GOID
                                                                  AND comm.t_DocKind = go.t_DocKind
                                                                  AND comm.t_DocumentID = go.t_DocumentID
                                                              ), PLB.t_DealDate)
                                 ELSE PLB.t_DealDate END) as PLBDealDate,
                           TMP.T_PARENT_DOCID as Parent_LnkID,
                           (CASE WHEN PLS.t_DocKind = RSB_SECUR.DL_RETIREMENT AND NVL(rsb_fiinstr.FI_GetNominalOnDate(PS.t_FIID, PLB.t_BuyDate), 0.0) > 0
                                      AND EXISTS(SELECT 1
                                                   FROM (SELECT DISTINCT obj.t_OutObjID
                                                           FROM dnptxobj_dbt obj
                                                          WHERE obj.t_AnaliticKind1 = RSI_NPTXC.TXOBJ_KIND1020
                                                            AND obj.t_Analitic1 = PLS.t_DocID
                                                            AND obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                            AND obj.t_OutObjID <> CHR(1)
                                                        ) o, dcdrecords_dbt cd
                                                  WHERE cd.t_PartyID = pClient
                                                    AND cd.t_RecordPaymentQtyID = TO_NUMBER(o.t_OutObjID)
                                                    AND cd.t_ID = (SELECT MAX(cd1.t_ID) 
                                                                     FROM dcdrecords_dbt cd1 
                                                                    WHERE cd1.t_PartyID = pClient
                                                                      AND cd1.t_RecordPaymentQtyID = TO_NUMBER(o.t_OutObjID)
                                                                  )
                                                ) THEN RSI_RSB_FIInstr.FI_GetNominalOnDate(PS.t_FIID, NVL((SELECT MAX(fw.t_DrawingDate)
                                                                                                             FROM dfiwarnts_dbt fw
                                                                                                            WHERE fw.t_FIID = PS.t_FIID
                                                                                                                  AND fw.T_ISCLOSED = 'X'
                                                                                                                  AND fw.t_IsPartial = 'X'
                                                                                                         ), PS.t_Date-1)) / rsb_fiinstr.FI_GetNominalOnDate(PS.t_FIID, PLB.t_BuyDate)
                                 ELSE 1 END
                           ) as Kpog,
                           (CASE WHEN PLS.t_DocKind = RSB_SECUR.DL_RETIREMENT AND N.t_Kind IN (RSI_NPTXC.TXOBJ_COM, RSI_NPTXC.TXOBJ_NKD) THEN NVL((SELECT MAX(obj.t_Date)
                                                                                                                                                     FROM dnptxobj_dbt obj
                                                                                                                                                    WHERE obj.t_AnaliticKind1 = RSI_NPTXC.TXOBJ_KIND1020
                                                                                                                                                      AND obj.t_Analitic1 = PLS.t_DocID
                                                                                                                                                      AND obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                                                                                                                      AND obj.t_Direction = RSI_NPTXC.TXOBJ_DIR_IN
                                                                                                                                                   ), PS.t_Date
                                                                                                                                                  )
                                 ELSE PS.t_Date END) as NewObjDate,
                           sf.t_Number as ContrNumber 
                      FROM (SELECT t_Date, t_Kind, NVL(sum(t_Sum), 0) t_Sum, NVL(sum(t_Sum0), 0) t_Sum0, t_Analitic5, t_AnaliticKind1, t_Analitic1 
                              FROM dnptxobj_dbt 
                             WHERE t_Client = pClient 
                               AND t_Kind IN   (RSI_NPTXC.TXOBJ_COM, 
                                                RSI_NPTXC.TXOBJ_DIF, 
                                                RSI_NPTXC.TXOBJ_NKD,
                                                RSI_NPTXC.TXOBJ_MATERIAL
                                              ) 
                             GROUP BY t_Date, t_Kind, t_Analitic5, t_AnaliticKind1, t_Analitic1                       
                           ) N, v_npx_dnptxlot LB, v_npx_dnptxlot LS, dnptxlnk_dbt S, DNPTXOP1OPLNK_TMP TMP, dfininstr_dbt fin, dnptxlnk_dbt PS, v_npx_dnptxlot PLB, v_npx_dnptxlot PLS, dsfcontr_dbt sf 
                     WHERE S.t_ID = TMP.T_DOCID
                       AND PS.t_ID = TMP.T_PARENT_DOCID
                       AND N.t_AnaliticKind1 = LB.t_AnaliticKind1 
                       AND N.t_Analitic1     = LB.t_Analitic1 
                       AND fin.t_FIID        = PS.t_FIID 
                       AND S.t_BuyID         = LB.t_ID 
                       AND S.t_SaleID        = LS.t_ID
                       AND PS.t_BuyID        = PLB.t_ID 
                       AND PS.t_SaleID       = PLS.t_ID
                       AND ((TMP.T_DOCID <> TMP.T_PARENT_DOCID) OR
                            (N.t_Date <= pEndDate AND S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR
                            (N.t_Date <= pEndDate AND N.t_Date >= pBegDate AND S.t_Date <  pBegDate) OR
                            (N.t_Date <  pBegDate AND S.t_Date <  pBegDate AND ( SELECT NVL(MIN(Obj.t_Date), g_ZeroDate) D
                                                                     FROM dnptxobj_dbt Obj
                                                                    WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                                      AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1
                                                                      AND Obj.t_Analitic1     = LS.t_Analitic1
                                                                      AND Obj.t_Client = pClient
                                                                      AND RSI_NPTO.CheckObjIIS (Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                                                                 ) BETWEEN pBegDate AND pEndDate ) 
                           )
                       AND sf.t_ID = PS.t_Contract
                      ORDER BY S.t_BuyID, N.t_Kind
                    )
    LOOP

      IF one_rec.t_Kind <> RSI_NPTXC.TXOBJ_COM AND one_rec.t_Kind <> RSI_NPTXC.TXOBJ_NKD AND one_rec.Parent_LnkID <> one_rec.t_ID THEN  --По связям, где реальная покупка была продана продажей замещения, обрабатываем только комиссии 
        CONTINUE;
      END IF;

      v_Kpog := one_rec.Kpog;

      IF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_COM) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_COMB;
        v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
        v_Comment := 'Затраты на оплату комиссий при покупке'||(CASE WHEN one_rec.Parent_LnkID <> one_rec.t_ID THEN '. Сделка замещения '||TO_CHAR(one_rec.BuyDealID) ELSE '' END);
      ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_DIF) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_DIFB;
        v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
        v_Comment := 'Корректировка затрат по рыночной цене по сделке';
      ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_NKD) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_NKDB;
        v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
        v_Comment := 'Затраты на оплату НКД'||(CASE WHEN one_rec.Parent_LnkID <> one_rec.t_ID THEN '. Сделка замещения '||TO_CHAR(one_rec.BuyDealID) ELSE '' END);
      ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_MATERIAL) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_MATERIALB;
        v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
        v_Comment := 'Сумма мат. выгоды';
      END IF;


      IF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_COM) THEN
        v_Sum   := 0;
        v_Sum_0 := 0;

        IF(one_rec.Parent_LnkID <> one_rec.t_ID) THEN
          v_SumAmount := 0;
          v_SumNDR    := 0;
          v_SumNDR_TS := 0;
        ELSIF((v_prevBuyID != one_rec.t_BuyID) OR (v_prevKind != one_rec.t_Kind)) THEN
          v_SumNDR_TS := 0;
          GetSumNdrByLink(one_rec.t_BuyID, 1, RSI_NPTXC.TXOBJ_COMB_TS, pDocID, pStep, v_SumAmount, v_SumNDR_TS, v_SumNDR_DelNom, 0);
          
          v_SumNDR_TS_0 := 0;
          GetSumNdrByLink(one_rec.t_BuyID, 1, RSI_NPTXC.TXOBJ_COMB_TS_0, pDocID, pStep, v_SumAmount, v_SumNDR_TS_0, v_SumNDR_DelNom, 0);
        
          v_SumNDR_TS := v_SumNDR_TS + v_SumNDR_TS_0;
        
          v_SumNDR_0 := 0;
          GetSumNdrByLink(one_rec.t_BuyID, 1, RSI_NPTXC.TXOBJ_COMB_0, pDocID, pStep, v_SumAmount_0, v_SumNDR_0, v_SumNDR_DelNom, 0, RSI_NPTXC.TXOBJ_COMB);
          
          v_SumNDR := 0;
          GetSumNdrByLink(one_rec.t_BuyID, 1, v_Kind, pDocID, pStep, v_SumAmount, v_SumNDR, v_SumNDR_DelNom, 0);
        
          v_SumAmount := v_SumAmount + v_SumAmount_0;
          v_SumNDR    := v_SumNDR    + v_SumNDR_0;
        
        ELSIF(v_prevSum != 0) THEN
          v_SumNDR    := v_SumNDR + v_prevSum;
          v_SumAmount := v_SumAmount + v_prevSumAmount;
        END IF;

        v_Flag1    := FALSE;
        v_SumComF1 := 0;

        FOR one_com IN (SELECT N.t_Date, N.t_Kind, N.t_Sum, N.t_Sum0, N.t_Analitic5, N.t_cur, 
                               LS.t_AnaliticKind1, LS.t_Analitic1, 
                               S.t_ID, S.t_FIID, S.t_Date SDate, Nvl(S.t_PrivAmount,0) SPrivAmount, S.t_Contract, S.t_BuyID, 
                               LB.t_BuyDate, LB.t_Amount LBAmount, LB.t_PriceFIID LBPriceFIID, 
                               fin.t_FI_Kind, fin.t_AvoirKind, fin.t_FaceValueFI, fin.t_FaceValue
                          FROM (SELECT t_Date, t_Kind, NVL(t_Sum, 0) t_Sum, NVL(t_Sum0, 0) t_Sum0, t_Analitic5, t_AnaliticKind1, t_Analitic1, t_cur 
                                  FROM dnptxobj_dbt 
                                 WHERE t_Client = pClient 
                                   AND t_Kind IN (RSI_NPTXC.TXOBJ_COM)
                               ) N, v_npx_dnptxlot LB, v_npx_dnptxlot LS, dnptxlnk_dbt S, dfininstr_dbt fin 
                         WHERE S.t_ID = one_rec.t_ID
                           AND N.t_AnaliticKind1 = LB.t_AnaliticKind1 
                           AND N.t_Analitic1     = LB.t_Analitic1 
                           AND fin.t_FIID        = S.t_FIID 
                           AND EXISTS ( SELECT Obj.t_Analitic1 
                                          FROM dnptxobj_dbt Obj
                                         WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                           AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                           AND Obj.t_Analitic1     = LS.t_Analitic1 
                                           AND Obj.t_Client = pClient
                                           AND RSI_NPTO.CheckObjIIS (Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                                      ) 
                           AND LB.t_Kind  = RSI_NPTXC.NPTXLOTS_BUY
                           AND S.t_BuyID  = LB.t_ID 
                           AND S.t_SaleID = LS.t_ID 
                           AND (   LS.t_DocKind <> RSI_NPTXC.TXOBJ_KIND1070
                                OR (LS.t_DocKind = RSI_NPTXC.TXOBJ_KIND1070 AND RSB_SECUR.GetMainObjAttr(101, LPAD(LS.t_DocID, 34, '0'), 55, LS.t_DealDate) = 1)
                               ) 
                           AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
                           AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
                           AND ((N.t_Kind = RSI_NPTXC.TXOBJ_COM AND one_rec.Parent_LnkID <> S.t_ID) OR
                                (N.t_Date <= pEndDate AND S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
                                (N.t_Date <= pEndDate AND N.t_Date >= pBegDate AND S.t_Date <  pBegDate) OR 
                                (N.t_Date <  pBegDate AND S.t_Date <  pBegDate AND ( SELECT NVL(MIN(Obj.t_Date), g_ZeroDate) D 
                                                                         FROM dnptxobj_dbt Obj 
                                                                        WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                                          AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                                                          AND Obj.t_Analitic1     = LS.t_Analitic1  
                                                                          AND Obj.t_Client = pClient
                                                                          AND RSI_NPTO.CheckObjIIS (Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                                                                     ) BETWEEN pBegDate AND pEndDate ) 
                               )
                         ORDER BY S.t_BuyID, N.t_Kind, N.t_cur
                        )
        LOOP
            
          v_SumCom   := 0;
          v_SumCom_0 := 0;
       
          IF((one_rec.LBAmount - v_SumAmount) < 0) THEN
            RSI_NPTMSG.PutMsg(RSI_NPTXC.MES_ERROR, one_rec.ContrNumber||' Количество бумаг '||one_rec.t_FI_Code||' в связях превышает количество бумаг в сделке '||one_rec.LBDealCode);

          ELSIF((one_rec.t_FI_Kind = RSI_RSB_FIINSTR.FIKIND_AVOIRISS) AND (one_rec.t_AvoirKind = RSI_RSB_FIINSTR.AVOIRKIND_BOND_OVVZ) AND (one_rec.SDate >= TO_DATE('01.01.2019','DD.MM.YYYY'))) THEN
            /*ОВВЗ и дата продажи больще 1 января 2019 года*/
            v_K := 0.0;
            IF(one_com.t_Cur = RSI_RSB_FIInstr.NATCUR) THEN
              IF(one_rec.LBCourseNominal != 0) THEN --divide by zero
                v_K := one_rec.PLSCourseNominal / one_rec.LBCourseNominal;
              END IF;
            ELSE
              v_K := NVL(rsb_fiinstr.ConvSum(1, one_com.t_Cur, RSI_RSB_FIInstr.NATCUR, (CASE WHEN one_rec.IsChSaleRepl <> 0 or (one_rec.IsReplBuy = 0 and one_rec.IsReplSale = 0) THEN one_rec.PLSSaleDate ELSE one_rec.PLBBuyDate END)), 0.0);
            END IF;
            /*( Сумма НДР 1 ур. из поля <сумма в валюте> * Номинал ц/б на дату связи            * количество в связи     / (количество в сделке * Номинал на дату покупки из связи) )*  K */
            v_SumCom := 0;
            IF(one_com.LBAmount * one_rec.NominalAVROnBuyDateLink != 0) THEN-- divide by zero
              v_SumCom := ROUND((one_com.t_Sum * one_rec.NominalAVROnSelDateLink * one_rec.SAmount / (one_com.LBAmount * one_rec.NominalAVROnBuyDateLink ) )* v_K , 2);
            END IF;
       
          ELSIF(((one_rec.LBAmount - v_SumAmount) = 0)) THEN
            v_SumCom   := 0;
            v_SumCom_0 := 0;
          ELSE 
            v_Flag1 := TRUE;
            v_SumComF1 := v_SumComF1 + one_com.t_Sum0*v_Kpog;
          END IF;

          v_Sum   := v_Sum + v_SumCom;
          v_Sum_0 := v_Sum_0 + v_SumCom_0;
        END LOOP;

        IF(v_Flag1 = TRUE) THEN
          v_Sum   := (v_SumComF1 - v_SumNDR - v_SumNDR_TS) / (one_rec.LBAmount - v_SumAmount) * (one_rec.SAmount - one_rec.SPrivAmount);
          v_Sum_0 := (v_SumComF1 - v_SumNDR - v_SumNDR_TS) / (one_rec.LBAmount - v_SumAmount) * one_rec.SPrivAmount;
        END IF;

        IF((v_SumAmount + one_rec.SAmount) != one_rec.LBAmount) THEN
          v_Sum   := ROUND(v_Sum, 2);
          v_Sum_0 := ROUND(v_Sum_0, 2);
        END IF;
      ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_NKD) THEN

         v_Sum_0 := 0;
         v_CurNKD := GetNDRCurrency(pClient, one_rec.t_Date, one_rec.t_Kind, one_rec.t_Analitic5, one_rec.t_AnaliticKind1N, one_rec.t_Analitic1N );
         IF(one_rec.Parent_LnkID <> one_rec.t_ID) THEN
           v_SumAmount := 0;
           v_SumNDR    := 0;
           v_SumNDR_TS := 0;
         ELSIF((v_prevBuyID != one_rec.t_BuyID) OR (v_prevKind != one_rec.t_Kind)) THEN
           v_SumNDR_TS := 0;
           GetSumNdrByLink(one_rec.t_BuyID, 1, RSI_NPTXC.TXOBJ_NKDB_TS, pDocID, pStep, v_SumAmount, v_SumNDR_TS, v_SumNDR_DelNom, 0);
           
           --В том числе NkdB_TS с той же сделкой покупки в аналитике 1 и номером купона в аналитике 2
           SELECT NVL(SUM(obj.t_Sum0), 0)
             INTO v_AddSumNDR_TS
             FROM dnptxobj_dbt obj
            WHERE obj.t_Client = pClient
              AND obj.t_Date BETWEEN TO_DATE('01.01.'||EXTRACT(YEAR FROM pEndDate),'DD.MM.YYYY') AND TO_DATE('31.12.'||EXTRACT(YEAR FROM pEndDate),'DD.MM.YYYY') --Только объекты этого же налогового периода
              AND obj.t_Kind = RSI_NPTXC.TXOBJ_NKDB_TS
              AND obj.t_AnaliticKind1 IN (RSI_NPTXC.TXOBJ_KIND1010, RSI_NPTXC.TXOBJ_KIND1070)
              AND obj.t_Analitic1 = one_rec.BuyDealID
              AND obj.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2030
              AND obj.t_AnaliticKind6 = RSI_NPTXC.TXOBJ_KIND6020
              AND obj.t_Analitic6 = one_rec.t_Contract;

           v_SumNDR_TS := v_SumNDR_TS + v_AddSumNDR_TS;

           SELECT NVL(SUM(RSI_RSB_FIInstr.ConvSum(obj.T_SUM, obj.t_Cur, RSI_RSB_FIInstr.NATCUR, (case when obj.t_ConvDate > g_ZeroDate then obj.t_ConvDate else obj.t_Date end), 1 )), 0)
             INTO v_AddSumNDR_TS
             FROM dnptxobj_tmp obj
            WHERE obj.t_Client = pClient
              AND obj.t_Date BETWEEN TO_DATE('01.01.'||EXTRACT(YEAR FROM pEndDate),'DD.MM.YYYY') AND TO_DATE('31.12.'||EXTRACT(YEAR FROM pEndDate),'DD.MM.YYYY') --Только объекты этого же налогового периода
              AND obj.t_Kind = RSI_NPTXC.TXOBJ_NKDB_TS
              AND obj.t_AnaliticKind1 IN (RSI_NPTXC.TXOBJ_KIND1010, RSI_NPTXC.TXOBJ_KIND1070)
              AND obj.t_Analitic1 = one_rec.BuyDealID
              AND obj.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2030
              AND obj.t_AnaliticKind6 = RSI_NPTXC.TXOBJ_KIND6020
              AND obj.t_Analitic6 = one_rec.t_Contract;

           v_SumNDR_TS := v_SumNDR_TS + v_AddSumNDR_TS;

           
           v_SumNDR := 0;
           GetSumNdrByLink(one_rec.t_BuyID, 1, RSI_NPTXC.TXOBJ_NKDB, pDocID, pStep, v_SumAmount, v_SumNDR, v_SumNDR_DelNom, 0);

         ELSIF(v_prevSum != 0) THEN
           v_SumNDR    := v_SumNDR + v_prevSum;
           v_SumAmount := v_SumAmount + v_prevSumAmount;
         END IF;

         IF((one_rec.LBAmount - v_SumAmount) < 0) THEN
           RSI_NPTMSG.PutMsg(RSI_NPTXC.MES_ERROR, one_rec.ContrNumber||' Количество бумаг '||one_rec.t_FI_Code||' в связях превышает количество бумаг в сделке '||one_rec.LBDealCode);
         ELSIF((one_rec.LBAmount - v_SumAmount) = 0) THEN
           v_Sum := 0;
         ELSE
           v_Sum := 0;
           v_diff := one_rec.LBAmount - v_SumAmount; -- prevents dividing by zero
           IF( v_diff != 0 ) THEN
             v_Sum := ((one_rec.t_Sum0 - v_SumNDR - v_SumNDR_TS) / v_diff) * one_rec.SAmount;
           END IF;
         END IF;

         IF((one_rec.t_FI_Kind = RSI_RSB_FIINSTR.FIKIND_AVOIRISS) AND (one_rec.t_AvoirKind = RSI_RSB_FIINSTR.AVOIRKIND_BOND_OVVZ) AND (one_rec.SDate >= TO_DATE('01.01.2019','DD.MM.YYYY'))) THEN
           /*ОВВЗ и дата продажи больще 1 января 2019 года*/
           v_K := 0.0;
           IF(v_CurNKD = RSI_RSB_FIInstr.NATCUR) THEN
             IF(one_rec.LBCourseNominal != 0) THEN -- prevents dividing by zero
               v_K := one_rec.PLSCourseNominal / one_rec.LBCourseNominal;
             END IF;
           ELSE
             v_K := NVL(rsb_fiinstr.ConvSum(1, v_CurNKD, RSI_RSB_FIInstr.NATCUR, (CASE WHEN one_rec.IsChSaleRepl <> 0 or (one_rec.IsReplBuy = 0 and one_rec.IsReplSale = 0) THEN one_rec.PLSSaleDate ELSE one_rec.PLBBuyDate END)), 0.0);
           END IF;
           /*( Сумма НДР 1 ур. из поля <сумма в валюте> * Номинал ц/б на дату связи            * количество в связи     / (количество в сделке * Номинал на дату покупки из связи) )*  K */
           v_Sum := (one_rec.t_Sum * one_rec.NominalAVROnSelDateLink * one_rec.SAmount / (one_rec.LBAmount * one_rec.NominalAVROnBuyDateLink ) )* v_K;
         END IF;
         
         IF((v_SumAmount + one_rec.SAmount) != one_rec.LBAmount) THEN
           v_Sum := ROUND(v_Sum, 2);
         END IF;
      ELSE
         v_Sum := one_rec.t_Sum0 * GetFaceValue_Ex(one_rec.t_FIID, one_rec.SDate) * one_rec.SAmount / 
                                (GetFaceValue_Ex(one_rec.t_FIID, one_rec.t_BuyDate) * one_rec.LBAmount);
         v_Sum_0 := 0;
      END IF;

      IF v_Sum != 0 OR v_Sum_0 != 0 THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.PLSDealDate, one_rec.PLBDealDate);
      END IF;

      IF(v_Sum != 0) THEN
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.NewObjDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := RSI_RSB_FIInstr.NATCUR;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF(v_Sum_0 != 0) THEN
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.NewObjDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_COMB_0;                              
        nptxobj.T_SUM            := v_Sum_0;                                                 
        nptxobj.T_CUR            := RSI_RSB_FIInstr.NATCUR;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := 'Затраты на оплату комиссий при покупке льготных ц/б';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj; 
      END IF;

      v_prevSum := v_Sum + v_Sum_0;

      v_prevBuyID         := one_rec.t_BuyID;
      v_prevSumAmount     := one_rec.SAmount;
      v_prevKind          := one_rec.t_Kind;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

    DELETE FROM DNPTXOP1OPLNK_TMP;

  END;

  --Расчет объектов НДР по связям
  PROCEDURE CreateTaxObjects2_6(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
                    
    v_prevBuyID         NUMBER;
    v_prevSumAmount     NUMBER;
    v_prevKind          NUMBER;
    v_prevSum           NUMBER;
    v_prevSumNDR_DelNom NUMBER;

    v_SumNDR_TS     NUMBER;
    v_SumNDR_TS_0   NUMBER;
    v_SumAmount_MB  NUMBER;
    v_SumAmount     NUMBER;
    v_SumAmount_0   NUMBER;
    v_SumNDR_TS_1   NUMBER;
    v_SumNDR_TS_0_1 NUMBER;
    v_SumNDR        NUMBER;
    v_SumNDR_0      NUMBER;
    v_SumNDR_1      NUMBER;
    v_SumNDR_0_1    NUMBER;
    v_Sum           NUMBER;
    v_Sum_0         NUMBER;
    v_SumNDR_DelNom NUMBER;
    v_diff          NUMBER;
    v_Dir           NUMBER;
    v_Kind          NUMBER;
    v_Comment       DNPTXOBJ_TMP.T_COMMENT%TYPE; 

    v_K             NUMBER;
    v_CurN          NUMBER;

    v_FaceValueSDate NUMBER;
    v_FaceValueBDate NUMBER;
                    
  BEGIN
  
    pStat := 0;

    v_prevBuyID     := 0;
    v_prevSumAmount := 0;
    v_prevKind      := 0;

    v_FaceValueSDate := 0;
    v_FaceValueBDate := 0;

    FOR one_rec IN (SELECT N.t_Date, N.t_Kind, N.t_Sum, N.t_Sum0, N.t_Analitic5, 
                           LS.t_AnaliticKind1, LS.t_Analitic1, N.t_AnaliticKind1 t_AnaliticKind1N, N.t_Analitic1 t_Analitic1N, 
                           S.t_ID, S.t_FIID, S.t_Date SDate, S.t_Amount SAmount, S.t_Contract, S.t_BuyID, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, LB.t_PriceFIID LBPriceFIID, 
                           NVL(rsb_fiinstr.FI_GetNominalOnDate(S.t_FIID, S.t_Date ), 0.0) NominalAVROnSelDateLink, 
                           NVL(rsb_fiinstr.FI_GetNominalOnDate(S.t_FIID, LB.t_BuyDate ), 0.0) NominalAVROnBuyDateLink, 
                           NVL(rsb_fiinstr.ConvSum(1, fin.t_FaceValueFI, RSI_RSB_FIInstr.NATCUR, LS.t_saleDate ), 0.0) LSCourseNominal, 
                           NVL(rsb_fiinstr.ConvSum(1, fin.t_FaceValueFI, RSI_RSB_FIInstr.NATCUR, LB.t_buyDate ), 0.0) LBCourseNominal, 
                           NVL(rsb_fiinstr.ConvSum(1, LB.t_PriceFIID, RSI_RSB_FIInstr.NATCUR, LS.t_saleDate ), 0.0) LB_Course_PriseFIID,
                           fin.t_FI_Kind, fin.t_AvoirKind, fin.t_FaceValueFI, fin.t_FaceValue, fin.t_FI_Code,
                           LS.t_DealDate AS LSDealDate, LB.t_DealDate AS LBDealDate, LB.t_DealCode as LBDealCode,
                           sf.t_Number as ContrNumber
                      FROM (SELECT t_Date, t_Kind, NVL(SUM(t_Sum), 0) t_Sum, NVL(SUM(t_Sum0), 0) t_Sum0, t_Analitic5, t_AnaliticKind1, t_Analitic1 
                              FROM dnptxobj_dbt 
                             WHERE t_Client = pClient
                               AND t_Kind IN (RSI_NPTXC.TXOBJ_MAIN,
                                              RSI_NPTXC.TXOBJ_COM,
                                              RSI_NPTXC.TXOBJ_DIF,
                                              RSI_NPTXC.TXOBJ_NKD,
                                              RSI_NPTXC.TXOBJ_MATERIAL
                                             ) 
                             GROUP BY t_Date, t_Kind, t_Analitic5, t_AnaliticKind1, t_Analitic1                       
                           ) N, v_npx_dnptxlot LB, v_npx_dnptxlot LS, dnptxlnk_dbt S, dfininstr_dbt fin, dsfcontr_dbt sf 
                     WHERE S.t_Client = pClient
                       AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (S.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_AnaliticKind1 = LB.t_AnaliticKind1 
                       AND N.t_Analitic1     = LB.t_Analitic1 
                       AND fin.t_FIID        = S.t_FIID 
                       AND EXISTS ( SELECT Obj.t_Analitic1 
                                      FROM dnptxobj_dbt Obj 
                                     WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                       AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                       AND Obj.t_Analitic1     = LS.t_Analitic1 
                                       AND Obj.t_Client = pClient
                                       AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                                  ) 
                       AND LB.t_Kind  = RSI_NPTXC.NPTXLOTS_BUY
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID 
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
                       AND LB.t_Type <> RSI_NPTXC.NPTXDEAL_CALC
                       AND S.t_Type = RSI_NPTXC.NPTXLNK_CLPOS
                       AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
                       AND ((N.t_Date <= pEndDate AND S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
                            (N.t_Date <= pEndDate AND N.t_Date >= pBegDate AND S.t_Date <  pBegDate) OR 
                            (N.t_Date <  pBegDate AND S.t_Date <  pBegDate AND ( SELECT NVL(min(Obj.t_Date), g_ZeroDate) D 
                                                                     FROM dnptxobj_dbt Obj 
                                                                    WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                                      AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                                                      AND Obj.t_Analitic1     = LS.t_Analitic1  
                                                                      AND Obj.t_Client = pClient 
                                                                      AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6) = pIIS
                                                                  ) BETWEEN pBegDate AND pEndDate )  
                           )
                       AND sf.t_ID = S.t_Contract
                      ORDER BY S.t_BuyID, N.t_Kind
                    )
    LOOP

      IF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_MAIN) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_MAINB_SHORT;
        v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
        v_Comment := 'Затраты на приобретение (основная сумма)';
      ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_COM) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_COMB_SHORT;
        v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
        v_Comment := 'Затраты на оплату комиссий при покупке';
      ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_DIF) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_DIFB_SHORT;
        v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
        v_Comment := 'Корректировка затрат по рыночной цене по сделке';
      ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_NKD) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_NKDB_SHORT;
        v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
        v_Comment := 'Затраты на оплату НКД';
      ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_MATERIAL) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_MATERIALB_SHORT;
        v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
        v_Comment := 'Сумма мат. выгоды';
      END IF;

      v_FaceValueSDate := GetFaceValue_Ex(one_rec.t_FIID, one_rec.SDate);
      v_FaceValueBDate := GetFaceValue_Ex(one_rec.t_FIID, one_rec.t_BuyDate);

      IF((one_rec.t_Kind = RSI_NPTXC.TXOBJ_NKD) OR (one_rec.t_Kind = RSI_NPTXC.TXOBJ_COM) OR (one_rec.t_Kind = RSI_NPTXC.TXOBJ_MAIN)) THEN
        IF((v_prevBuyID != one_rec.t_BuyID) or (v_prevKind != one_rec.t_Kind)) THEN
          v_SumAmount     := 0;
          v_SumNDR        := 0;
          v_SumNDR_DelNom := 0;

          GetSumNdrByLink(one_rec.t_BuyID, 1, v_Kind, pDocID, pStep, v_SumAmount, v_SumNDR, v_SumNDR_DelNom, 1);
        ELSIF(v_prevSum != 0) THEN
          v_SumNDR        := v_SumNDR + v_prevSum;
          v_SumAmount     := v_SumAmount + v_prevSumAmount;
          v_SumNDR_DelNom := v_SumNDR_DelNom + v_prevSumNDR_DelNom;
        END IF;

        IF((one_rec.LBAmount - v_SumAmount) < 0) THEN
          RSI_NPTMSG.PutMsg(RSI_NPTXC.MES_ERROR, one_rec.ContrNumber||' Количество бумаг '||one_rec.t_FI_Code||' в связях превышает количество бумаг в сделке '||one_rec.LBDealCode);
        ELSIF((one_rec.LBAmount - v_SumAmount) = 0) THEN
          v_Sum := 0;
        ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_NKD) THEN
          v_Sum := (one_rec.t_Sum0 - v_SumNDR) / (one_rec.LBAmount - v_SumAmount) * one_rec.SAmount;
        ELSIF((one_rec.t_Kind = RSI_NPTXC.TXOBJ_COM) OR (one_rec.t_Kind = RSI_NPTXC.TXOBJ_MAIN)) THEN
          IF(v_FaceValueSDate = v_FaceValueBDate) THEN
            v_Sum := (one_rec.t_Sum0 - v_SumNDR) / (one_rec.LBAmount - v_SumAmount) * one_rec.SAmount;
          ELSE
            v_Sum := (one_rec.t_Sum0 / v_FaceValueBDate - v_SumNDR_DelNom) * v_FaceValueSDate / (one_rec.LBAmount - v_SumAmount) * one_rec.SAmount;
          END IF;
        END IF;

        IF((v_SumAmount + one_rec.SAmount) != one_rec.LBAmount) THEN
           v_Sum := ROUND(v_Sum, 2);
        END IF;
      ELSIF((one_rec.t_FI_Kind = RSI_RSB_FIINSTR.FIKIND_AVOIRISS) AND (one_rec.t_AvoirKind = RSI_RSB_FIINSTR.AVOIRKIND_BOND_OVVZ) AND (one_rec.SDate >= TO_DATE('01.01.2019','DD.MM.YYYY'))
             AND ((v_Kind = RSI_NPTXC.TXOBJ_MAINB_SHORT) OR (v_Kind = RSI_NPTXC.TXOBJ_COMB_SHORT) OR (v_Kind = RSI_NPTXC.TXOBJ_NKDB_SHORT))) THEN
        /*ОВВЗ и дата продажи больще 1 января 2019 года*/
        v_K := 0.0;
        v_CurN := GetNDRCurrency(pClient, one_rec.t_Date, one_rec.t_Kind, one_rec.t_Analitic5, one_rec.t_AnaliticKind1N, one_rec.t_Analitic1N );
        IF(v_CurN = RSI_RSB_FIInstr.NATCUR) THEN
          v_K := one_rec.LSCourseNominal / one_rec.LBCourseNominal;
        ELSE
          v_K := (CASE WHEN v_Kind = RSI_NPTXC.TXOBJ_NKDB_SHORT THEN one_rec.LSCourseNominal ELSE one_rec.LB_Course_PriseFIID END);
        END IF;
              /*( Сумма НДР 1 ур. из поля <сумма в валюте> * Номинал ц/б на дату связи            * количество в связи     / (количество в сделке * Номинал на дату покупки из связи) )*  K */
        v_Sum := (one_rec.t_Sum * one_rec.NominalAVROnSelDateLink * one_rec.SAmount / (one_rec.LBAmount * one_rec.NominalAVROnBuyDateLink ) )* v_K;
      ELSE
        v_Sum := one_rec.t_Sum0 * v_FaceValueSDate * one_rec.SAmount / 
                                 (v_FaceValueBDate * one_rec.LBAmount);
      END IF;

      IF(v_Sum != 0) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.LSDealDate, one_rec.LBDealDate);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.SDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := RSI_RSB_FIInstr.NATCUR;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      v_prevSum           := v_Sum;
      v_prevSumNDR_DelNom := v_Sum / (CASE WHEN v_FaceValueSDate = 0 THEN 1 ELSE v_FaceValueSDate END);

      v_prevBuyID     := one_rec.t_BuyID;
      v_prevSumAmount := one_rec.SAmount;
      v_prevKind      := one_rec.t_Kind;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;


  --Расчет объектов НДР по связям
  PROCEDURE CreateTaxObjects2_7(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
                    
    v_prevSaleID    NUMBER;
    v_prevSumAmount NUMBER;
    v_prevKind      NUMBER;
    v_prevSum       NUMBER;

    v_SumAmount     NUMBER;
    v_SumAmount_0   NUMBER;
    v_SumNDR        NUMBER;
    v_SumNDR_0      NUMBER;
    v_SumNDR_1      NUMBER;
    v_SumNDR_0_1    NUMBER;
    v_Sum           NUMBER;
    v_Sum_0         NUMBER;
    v_SumNDR_DelNom NUMBER;
    v_diff          NUMBER;
    v_Dir           NUMBER;
    v_Kind          NUMBER;
    v_Comment       DNPTXOBJ_TMP.T_COMMENT%TYPE;

  BEGIN
  
    pStat := 0;

    v_prevSaleID    := 0;
    v_prevSumAmount := 0;
    v_prevKind      := 0;
    v_prevSum       := 0;

    DELETE FROM DNPTXOP1OPLNK_TMP;

    --Вставим все подходящие связи во временную таблицу
    INSERT INTO DNPTXOP1OPLNK_TMP (T_DOCID, T_PARENT_DOCID, T_AMOUNT)
    SELECT DISTINCT S.t_ID, S.t_ID, S.T_AMOUNT 
      FROM (SELECT t_Date, t_Cur, t_Kind, NVL(SUM(t_Sum), 0) t_Sum, NVL(SUM(t_Sum0), 0) t_Sum0, t_Analitic5, t_AnaliticKind1, t_Analitic1 
              FROM dnptxobj_dbt 
             WHERE t_Client = pClient
               AND t_Kind IN (RSI_NPTXC.TXOBJ_MAIN,
                              RSI_NPTXC.TXOBJ_DIF,
                              RSI_NPTXC.TXOBJ_NKD
                             ) 
             GROUP BY t_Date, t_Cur, t_Kind, t_Analitic5, t_AnaliticKind1, t_Analitic1                       
           ) N, v_npx_dnptxlot LB, v_npx_dnptxlot LS, dnptxlnk_dbt S, ddl_tick_dbt tks 
     WHERE S.t_Client = pClient
       AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS
       AND ((pContract IS NULL) OR (pContract <= 0) OR (S.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
       AND N.t_AnaliticKind1 = LS.t_AnaliticKind1 
       AND N.t_Analitic1     = LS.t_Analitic1 
       AND LS.t_Kind  = RSI_NPTXC.NPTXLOTS_SALE
       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
       AND S.t_BuyID  = LB.t_ID 
       AND S.t_SaleID = LS.t_ID 
       AND S.t_Type = RSI_NPTXC.NPTXLNK_DELIVER
       AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
       AND ((N.t_Date <= pEndDate AND S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
            (N.t_Date <= pEndDate AND N.t_Date >= pBegDate AND S.t_Date <  pBegDate))
       AND tks.t_BOfficeKind = LS.t_DocKind
       AND tks.t_DealID = LS.t_DocID;

    AddChildLinksToTMP(pDocID, pBegDate, pEndDate, FALSE);

    FOR one_rec IN (SELECT /*+ leading(TMP) index(S DNPTXLNK_DBT_IDX0) index(PS DNPTXLNK_DBT_IDX0) index(LB DNPTXLOT_DBT_IDX0) index(LS DNPTXLOT_DBT_IDX0) index(PLB DNPTXLOT_DBT_IDX0) index(PLS DNPTXLOT_DBT_IDX0)*/
                           N.t_Date, N.t_Cur, N.t_Kind, N.t_Sum, N.t_Analitic5, 
                           LS.t_AnaliticKind1, LS.t_Analitic1, LS.t_SaleDate, LS.t_Amount LSAmount, 
                           S.t_ID, PS.t_FIID, PS.t_Date SDate, TMP.t_Amount SAmount, S.t_PrivAmount SPrivAmount, S.t_Type, S.t_Contract, S.t_SaleID, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, 
                           LS.t_DealDate AS LSDealDate, LB.t_DealDate AS LBDealDate, LS.t_DealCode as LSDealCode, 
                           PLS.t_DealDate AS PLSDealDate, 
                           (CASE WHEN PLB.T_GOID > 0 THEN NVL((SELECT (CASE WHEN comm.t_CorpActionDate = g_ZeroDate THEN PLB.t_DealDate ELSE comm.t_CorpActionDate END)
                                                                 FROM dnptxgo_dbt go, ddl_comm_dbt comm
                                                                WHERE go.t_ID = PLB.T_GOID
                                                                  AND comm.t_DocKind = go.t_DocKind
                                                                  AND comm.t_DocumentID = go.t_DocumentID
                                                              ), PLB.t_DealDate)
                                 ELSE PLB.t_DealDate END) as PLBDealDate,
                           TMP.T_PARENT_DOCID as Parent_LnkID,
                           sf.t_Number as ContrNumber, fin.t_FI_Code
                      FROM (SELECT t_Date, t_Cur, t_Kind, NVL(SUM(t_Sum), 0) t_Sum, NVL(SUM(t_Sum0), 0) t_Sum0, t_Analitic5, t_AnaliticKind1, t_Analitic1 
                              FROM dnptxobj_dbt 
                             WHERE t_Client = pClient
                               AND t_Kind IN (RSI_NPTXC.TXOBJ_MAIN,
                                              RSI_NPTXC.TXOBJ_DIF,
                                              RSI_NPTXC.TXOBJ_NKD
                                             ) 
                             GROUP BY t_Date, t_Cur, t_Kind, t_Analitic5, t_AnaliticKind1, t_Analitic1                       
                           ) N, v_npx_dnptxlot LB, v_npx_dnptxlot LS, DNPTXOP1OPLNK_TMP TMP, dnptxlnk_dbt S, dnptxlnk_dbt PS, v_npx_dnptxlot PLB, v_npx_dnptxlot PLS, dsfcontr_dbt sf, dfininstr_dbt fin  
                     WHERE S.t_ID = TMP.T_DOCID
                       AND PS.t_ID = TMP.T_PARENT_DOCID
                       AND N.t_AnaliticKind1 = LS.t_AnaliticKind1 
                       AND N.t_Analitic1     = LS.t_Analitic1 
                       AND LS.t_Kind  = RSI_NPTXC.NPTXLOTS_SALE
                       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
                       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID 
                       AND PS.t_BuyID  = PLB.t_ID 
                       AND PS.t_SaleID = PLS.t_ID
                       AND S.t_Type = RSI_NPTXC.NPTXLNK_DELIVER
                       AND ((N.t_Kind = RSI_NPTXC.TXOBJ_NKD AND TMP.T_DOCID <> TMP.T_PARENT_DOCID) OR
                            (N.t_Date <= pEndDate AND S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
                            (N.t_Date <= pEndDate AND N.t_Date >= pBegDate AND S.t_Date <  pBegDate))
                       AND fin.t_FIID = S.t_FIID
                       AND sf.t_ID = PS.t_Contract
                      ORDER BY S.t_SaleID, N.t_Kind
                    )
    LOOP

      IF one_rec.t_Kind <> RSI_NPTXC.TXOBJ_NKD AND one_rec.Parent_LnkID <> one_rec.t_ID THEN  --По связям, где реальная покупка была продана продажей замещения, обрабатываем только НКД продаж 
        CONTINUE;
      END IF;

      v_Dir := RSI_NPTXC.TXOBJ_DIR_IN;

      IF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_MAIN) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_MAINS;
        v_Comment := 'Выручка от реализации (основная сумма)';

      ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_DIF) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_DIFS;
        v_Comment := 'Корректировка выручки по рыночной цене по сделке';

      ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_NKD) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_NKDS;
        v_Comment := 'Выручка от полученного НКД';
      END IF;

      IF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_MAIN) THEN
         
        IF(one_rec.Parent_LnkID <> one_rec.t_ID) THEN
          v_SumAmount := 0;
          v_SumNDR    := 0;
        ELSIF((v_prevSaleID != one_rec.t_SaleID) OR (v_prevKind != one_rec.t_Kind)) THEN
          GetSumNdrByLink(one_rec.t_SaleID, 0,RSI_NPTXC.TXOBJ_MAINS_0, pDocID, pStep, v_SumAmount_0, v_SumNDR_0, v_SumNDR_DelNom, 0,RSI_NPTXC.TXOBJ_MAINS);
          GetSumNdrByLink(one_rec.t_SaleID, 0, v_Kind, pDocID, pStep, v_SumAmount, v_SumNDR, v_SumNDR_DelNom, 0);
          v_SumAmount := v_SumAmount + v_SumAmount_0;
          v_SumNDR    := v_SumNDR    + v_SumNDR_0;
        ELSIF(v_prevSum != 0) THEN
          v_SumNDR    := v_SumNDR + v_prevSum;
          v_SumAmount := v_SumAmount + v_prevSumAmount;
        END IF;

        IF((one_rec.LSAmount - v_SumAmount) < 0) THEN
          RSI_NPTMSG.PutMsg(RSI_NPTXC.MES_ERROR, one_rec.ContrNumber||' Количество бумаг '||one_rec.t_FI_Code||' в связях превышает количество бумаг в сделке '||one_rec.LSDealCode);
        ELSIF((one_rec.LSAmount - v_SumAmount) = 0) THEN
          v_Sum   := 0;
          v_Sum_0 := 0;
        ELSE
          v_Sum   := (one_rec.t_Sum - v_SumNDR) / (one_rec.LSAmount - v_SumAmount) * (one_rec.SAmount-one_rec.SPrivAmount);
          v_Sum_0 := (one_rec.t_Sum - v_SumNDR) / (one_rec.LSAmount - v_SumAmount) * one_rec.SPrivAmount;
        END IF;

        IF((v_SumAmount + one_rec.SAmount) != one_rec.LSAmount) THEN
          v_Sum   := ROUND(v_Sum, 2);
          v_Sum_0 := ROUND(v_Sum_0, 2);
        END IF;
      ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_NKD) THEN

        v_Sum_0 := 0;
        
        IF(one_rec.Parent_LnkID <> one_rec.t_ID) THEN
          v_SumAmount := 0;
          v_SumNDR    := 0;
        ELSIF((v_prevSaleID != one_rec.t_SaleID) OR (v_prevKind != one_rec.t_Kind)) THEN
          GetSumNdrByLink(one_rec.t_SaleID, 0, v_Kind, pDocID, pStep, v_SumAmount, v_SumNDR, v_SumNDR_DelNom, 0);
        ELSIF(v_prevSum != 0) THEN
          v_SumNDR    := v_SumNDR + v_prevSum;
          v_SumAmount := v_SumAmount + v_prevSumAmount;
        END IF;

        IF((one_rec.LSAmount - v_SumAmount) < 0 ) THEN
          RSI_NPTMSG.PutMsg(RSI_NPTXC.MES_ERROR, one_rec.ContrNumber||' Количество бумаг '||one_rec.t_FI_Code||' в связях превышает количество бумаг в сделке '||one_rec.LSDealCode);
        ELSIF((one_rec.LSAmount - v_SumAmount) = 0) THEN
          v_Sum := 0;
        ELSE
          v_Sum := (one_rec.t_Sum - v_SumNDR) / (one_rec.LSAmount - v_SumAmount) * one_rec.SAmount;
        END IF;

        IF((v_SumAmount + one_rec.SAmount) != one_rec.LSAmount) THEN
          v_Sum := ROUND(v_Sum, 2);
        END IF;
      ELSE
        v_Sum   := one_rec.t_Sum * one_rec.SAmount / one_rec.LSAmount;
        v_Sum_0 := 0;
      END IF;

      IF(v_Sum != 0 OR v_Sum_0 != 0) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.PLSDealDate, one_rec.PLBDealDate);
      END IF;

      IF(v_Sum != 0) THEN
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := (CASE WHEN v_Kind = RSI_NPTXC.TXOBJ_MAINS THEN one_rec.t_Date ELSE one_rec.SDate END);   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := one_rec.t_Cur;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);
        nptxobj.T_CONVDATE       := one_rec.t_Date;

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF(v_Sum_0 != 0) THEN
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_Date;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_MAINS_0;                              
        nptxobj.T_SUM            := v_Sum_0;                                                 
        nptxobj.T_CUR            := one_rec.t_Cur;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := 'Выручка от реализации льготных ц/б (основная сумма)';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);
        nptxobj.T_CONVDATE       := one_rec.t_Date;

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      v_prevSaleID     := one_rec.t_SaleID;
      v_prevSumAmount  := one_rec.SAmount;
      v_prevKind       := one_rec.t_Kind;
      v_prevSum        := v_Sum+v_Sum_0;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

    DELETE FROM DNPTXOP1OPLNK_TMP;

  END;

  --Расчет объектов НДР по связям
  PROCEDURE CreateTaxObjects2_8(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
                    
    v_prevSaleID    NUMBER;
    v_prevSumAmount NUMBER;
    v_prevKind      NUMBER;
    v_prevSum       NUMBER;

    v_SumAmount     NUMBER;
    v_SumAmount_0   NUMBER;
    v_SumNDR        NUMBER;
    v_SumNDR_0      NUMBER;
    v_SumNDR_1      NUMBER;
    v_SumNDR_0_1    NUMBER;
    v_Sum           NUMBER;
    v_Sum_0         NUMBER;
    v_SumNDR_DelNom NUMBER;
    v_diff          NUMBER;
    v_Dir           NUMBER;
    v_Kind          NUMBER;
    v_Comment       DNPTXOBJ_TMP.T_COMMENT%TYPE;
                    
  BEGIN
  
    pStat := 0;

    v_prevSaleID    := 0;
    v_prevSumAmount := 0;
    v_prevKind      := 0;
    v_prevSum       := 0;


    FOR one_rec IN (SELECT N.t_Date, N.t_Cur, N.t_Kind, N.t_Sum, N.t_Analitic5, 
                           LS.t_AnaliticKind1, LS.t_Analitic1, LS.t_SaleDate, LS.t_Amount LSAmount, 
                           S.t_ID, S.t_FIID, S.t_Date SDate, S.t_Amount SAmount, S.t_Type, S.t_Contract, S.t_SaleID, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, 
                           LS.t_DealDate AS LSDealDate, LB.t_DealDate AS LBDealDate, LS.t_DealCode as LSDealCode, sf.t_Number as ContrNumber, fin.t_FI_Code
                      FROM (SELECT t_Date, t_Cur, t_Kind, NVL(SUM(t_Sum), 0) t_Sum, NVL(SUM(t_Sum0), 0) t_Sum0, t_Analitic5, t_AnaliticKind1, t_Analitic1 
                              FROM dnptxobj_dbt 
                             WHERE t_Client = pClient 
                               AND t_Kind IN (RSI_NPTXC.TXOBJ_MAIN,
                                              RSI_NPTXC.TXOBJ_NKD
                                             )  
                             GROUP BY t_Date, t_Cur, t_Kind, t_Analitic5, t_AnaliticKind1, t_Analitic1                       
                           ) N, v_npx_dnptxlot LB, v_npx_dnptxlot LS, dnptxlnk_dbt S, dsfcontr_dbt sf, dfininstr_dbt fin 
                     WHERE S.t_Client = pClient
                       AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (S.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_AnaliticKind1 = LS.t_AnaliticKind1 
                       AND N.t_Analitic1     = LS.t_Analitic1 
                       AND LS.t_Kind  = RSI_NPTXC.NPTXLOTS_SALE
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
                       AND LB.t_Type <> RSI_NPTXC.NPTXDEAL_CALC
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID 
                       AND S.t_Type = RSI_NPTXC.NPTXLNK_CLPOS
                       AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
                       AND ((N.t_Date <= pEndDate AND S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
                            (N.t_Date <= pEndDate AND N.t_Date >= pBegDate AND S.t_Date < pBegDate))
                       AND sf.t_ID = S.t_Contract
                       AND fin.t_FIID = S.t_FIID      
                      ORDER BY S.t_SaleID, N.t_Kind
                    )
    LOOP

      v_Dir := RSI_NPTXC.TXOBJ_DIR_IN;

      IF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_MAIN) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_MAINS_SHORT;
        v_Comment := 'Выручка от реализации (основная сумма)';
      ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_NKD) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_NKDS_SHORT;
        v_Comment := 'Выручка от полученного НКД';
      END IF;

      IF((v_prevSaleID != one_rec.t_SaleID) OR (v_prevKind != one_rec.t_Kind)) THEN
        GetSumNdrByLink(one_rec.t_SaleID, 0, v_Kind, pDocID, pStep, v_SumAmount, v_SumNDR, v_SumNDR_DelNom, 0);
      ELSIF(v_prevSum != 0) THEN
        v_SumNDR    := v_SumNDR + v_prevSum;
        v_SumAmount := v_SumAmount + v_prevSumAmount;
      END IF;

      IF((one_rec.LSAmount - v_SumAmount) < 0) THEN
        RSI_NPTMSG.PutMsg(RSI_NPTXC.MES_ERROR, one_rec.ContrNumber||' Количество бумаг '||one_rec.t_FI_Code||' в связях превышает количество бумаг в сделке '||one_rec.LSDealCode);
      ELSIF((one_rec.LSAmount - v_SumAmount) = 0) THEN
        v_Sum := 0;
      ELSE
        v_Sum := (one_rec.t_Sum - v_SumNDR) / (one_rec.LSAmount - v_SumAmount) * one_rec.SAmount;
      END IF;

      IF((v_SumAmount + one_rec.SAmount) != one_rec.LSAmount) THEN
        v_Sum := ROUND(v_Sum, 2);
      END IF;

      IF(v_Sum != 0) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.LSDealDate, one_rec.LBDealDate);
        
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.SDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := one_rec.t_Cur;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      END IF;

      v_prevSaleID     := one_rec.t_SaleID;
      v_prevSumAmount  := one_rec.SAmount;
      v_prevKind       := one_rec.t_Kind;
      v_prevSum        := v_Sum;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по связям
  PROCEDURE CreateTaxObjects2_9(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pContract  IN NUMBER,
                                pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
                    
    v_Sum           NUMBER;
    v_Dir           NUMBER;
    v_Kind          NUMBER;
    v_Comment       DNPTXOBJ_TMP.T_COMMENT%TYPE;
                    
  BEGIN
  
    pStat := 0;


    FOR one_rec IN (SELECT N.t_Date, N.t_Cur, N.t_Kind, N.t_Sum, N.t_Analitic5, 
                           LS.t_AnaliticKind1, LS.t_Analitic1, LS.t_SaleDate, LS.t_Amount LSAmount, 
                           S.t_ID, S.t_FIID, S.t_Date SDate, S.t_Amount SAmount, S.t_Type, S.t_Contract, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, 
                           LS.t_DealDate AS LSDealDate, LB.t_DealDate AS LBDealDate
                      FROM dnptxobj_dbt N, v_npx_dnptxlot LB, v_npx_dnptxlot LS, dnptxlnk_dbt S 
                     WHERE N.t_Client = pClient
                       AND S.t_Client = N.t_Client
                       AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (S.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_Kind = RSI_NPTXC.TXOBJ_DIF
                       AND N.t_AnaliticKind1 = LS.t_AnaliticKind1 
                       AND N.t_Analitic1     = LS.t_Analitic1 
                       AND LS.t_Kind  = RSI_NPTXC.NPTXLOTS_SALE
                       AND LS.t_Type <> RSI_NPTXC.NPTXDEAL_CALC -- По реальным сделкам продажи
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
                       AND LB.t_Type <> RSI_NPTXC.NPTXDEAL_CALC
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID 
                       AND S.t_Type = RSI_NPTXC.NPTXLNK_CLPOS
                       AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
                       AND ((N.t_Date <= pEndDate AND S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
                            (N.t_Date <= pEndDate AND N.t_Date >= pBegDate AND S.t_Date <  pBegDate))                        
                   )
    LOOP

      v_Dir     := RSI_NPTXC.TXOBJ_DIR_IN;
      v_Kind    := RSI_NPTXC.TXOBJ_DIFS_SHORT;
      v_Comment := 'Корректировка выручки по рыночной цене по сделке';

      v_Sum := one_rec.t_Sum * one_rec.SAmount / one_rec.LSAmount;

      v_Sum := ROUND(v_Sum, 2);
      
      IF(v_Sum != 0) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.LSDealDate, one_rec.LBDealDate);
        
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_Date;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := one_rec.t_Cur;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по связям
  PROCEDURE CreateTaxObjects2_10(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
                    
    v_Sum           NUMBER;
    v_Dir           NUMBER;
    v_Kind          NUMBER;
    v_Comment       DNPTXOBJ_TMP.T_COMMENT%TYPE;
                    
  BEGIN
  
    pStat := 0;

    FOR one_rec IN (SELECT N.t_Date, N.t_Cur, N.t_Kind, N.t_Sum, N.t_Analitic5, 
                           LS.t_AnaliticKind1, LS.t_Analitic1, LS.t_SaleDate, LS.t_Amount LSAmount, 
                           S.t_ID, S.t_FIID, S.t_Date SDate, S.t_Amount SAmount, S.t_Type, S.t_Contract, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, 
                           LS.t_DealDate AS LSDealDate, LB.t_DealDate AS LBDealDate
                      FROM dnptxobj_dbt N, v_npx_dnptxlot LB, v_npx_dnptxlot LS, v_npx_dnptxlot RealLS, dnptxlnk_dbt S 
                     WHERE N.t_Client = pClient
                       AND S.t_Client = N.t_Client
                       AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (S.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_Kind = RSI_NPTXC.TXOBJ_DIF
                       -- В связи - виртуальная продажа, в НДР - реальная.
                       AND N.t_AnaliticKind1 = RealLS.t_AnaliticKind1 
                       AND N.t_Analitic1     = RealLS.t_Analitic1 
                       AND LS.t_RealID       = RealLS.t_ID 
                       AND LS.t_Type = RSI_NPTXC.NPTXDEAL_CALC -- По виртуальным сделкам продажи
                       AND LS.t_Kind  = RSI_NPTXC.NPTXLOTS_SALE
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
                       AND LB.t_Type <> RSI_NPTXC.NPTXDEAL_CALC
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID 
                       AND S.t_Type = RSI_NPTXC.NPTXLNK_CLPOS
                       AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
                       AND ((N.t_Date <= pEndDate AND S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
                            (N.t_Date <= pEndDate AND N.t_Date >= pBegDate AND S.t_Date <  pBegDate))                        
                   )
    LOOP

      v_Dir     := RSI_NPTXC.TXOBJ_DIR_IN;
      v_Kind    := RSI_NPTXC.TXOBJ_DIFS_SHORT;
      v_Comment := 'Корректировка выручки по рыночной цене по сделке';

      v_Sum := one_rec.t_Sum * one_rec.SAmount / one_rec.LSAmount;

      v_Sum := ROUND(v_Sum, 2);
      
      IF(v_Sum != 0) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.LSDealDate, one_rec.LBDealDate);
        
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_Date;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := one_rec.t_Cur;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по связям
  PROCEDURE CreateTaxObjects2_11(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_prevSaleID    NUMBER;
    v_prevLnkID     NUMBER;
    v_prevSumAmount NUMBER;
    v_prevSum       NUMBER;
                    
    v_Sum           NUMBER;
    v_Sum_0         NUMBER;
    v_Dir           NUMBER;

    v_SumAmount     NUMBER;
    v_SumNDR        NUMBER;
    v_SumNDR_DelNom NUMBER;
    v_SumAmount_0   NUMBER;
    v_SumNDR_0      NUMBER;
                    
  BEGIN
  
    pStat := 0;

    v_prevSaleID    := 0;
    v_prevLnkID     := 0;
    v_prevSumAmount := 0;
    v_prevSum       := 0;


    DELETE FROM DNPTXOP1OPLNK_TMP;

    --Вставим все подходящие связи во временную таблицу
    INSERT INTO DNPTXOP1OPLNK_TMP (T_DOCID, T_PARENT_DOCID, T_AMOUNT)
    SELECT DISTINCT S.t_ID, S.t_ID, S.T_AMOUNT 
      FROM (SELECT t_Date, t_Kind, 
                   NVL(SUM(t_Sum0), 0) t_Sum0, 
                   t_Analitic5, t_AnaliticKind1, t_Analitic1 
              FROM dnptxobj_dbt 
             WHERE t_Client = pClient 
               AND t_Kind = RSI_NPTXC.TXOBJ_COM
             GROUP BY t_Date, t_Kind, t_Analitic5, t_AnaliticKind1, t_Analitic1                       
           ) N, v_npx_dnptxlot LB, v_npx_dnptxlot LS, dnptxlnk_dbt S, ddl_tick_dbt tks 
     WHERE S.t_Client = pClient
       AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS
       AND ((pContract IS NULL) OR (pContract <= 0) OR (S.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
       AND N.t_AnaliticKind1 = LS.t_AnaliticKind1 
       AND N.t_Analitic1     = LS.t_Analitic1 
       AND EXISTS ( SELECT Obj.t_Analitic1 
                      FROM dnptxobj_dbt Obj
                     WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                       AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                       AND Obj.t_Analitic1     = LS.t_Analitic1 
                       AND Obj.t_Client = pClient
                       AND RSI_NPTO.CheckObjIIS (Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                  ) 
       AND LS.t_Kind  = RSI_NPTXC.NPTXLOTS_SALE
       AND (LS.t_DocKind <> RSB_SECUR.DL_AVRWRT 
            OR (LS.t_DocKind = RSB_SECUR.DL_AVRWRT AND RSB_SECUR.GetMainObjAttr(101, LPAD(LS.t_DocID, 34, '0'), 55, LS.t_DealDate) = 1)
           )
       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
       AND S.t_BuyID  = LB.t_ID 
       AND S.t_SaleID = LS.t_ID 
       AND S.t_Type = RSI_NPTXC.NPTXLNK_DELIVER
       AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
       AND tks.t_BOfficeKind = LS.t_DocKind
       AND tks.t_DealID = LS.t_DocID
       AND ((N.t_Date <= pEndDate AND S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
            (N.t_Date <= pEndDate AND N.t_Date >= pBegDate AND S.t_Date <  pBegDate) OR 
            (N.t_Date <  pBegDate AND S.t_Date <  pBegDate AND ( SELECT NVL(MIN(Obj.t_Date), g_ZeroDate) D 
                                                                   FROM dnptxobj_dbt Obj 
                                                                  WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                                    AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                                                    AND Obj.t_Analitic1     = LS.t_Analitic1  
                                                                    AND Obj.t_Client        = pClient 
                                                                    AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                                                               ) BETWEEN pBegDate AND pEndDate)); 

    AddChildLinksToTMP(pDocID, pBegDate, pEndDate, FALSE);

    FOR one_rec IN (SELECT /*+ leading(TMP) index(S DNPTXLNK_DBT_IDX0) index(PS DNPTXLNK_DBT_IDX0) index(LB DNPTXLOT_DBT_IDX0) index(LS DNPTXLOT_DBT_IDX0) index(PLB DNPTXLOT_DBT_IDX0) index(PLS DNPTXLOT_DBT_IDX0))*/
                           N.t_Date, N.t_Kind, N.t_Sum0, N.t_Analitic5, 
                           LS.t_AnaliticKind1, LS.t_Analitic1, LS.t_Amount LSAmount, 
                           S.t_ID, PS.t_FIID, PS.t_Date SDate, TMP.t_Amount SAmount, S.t_PrivAmount SPrivAmount, S.t_Contract, S.t_SaleID, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, 
                           LS.t_DealDate AS LSDealDate, LB.t_DealDate AS LBDealDate, LS.t_DealCode as LSDealCode,
                           PLS.t_DealDate AS PLSDealDate, 
                           (CASE WHEN PLB.T_GOID > 0 THEN NVL((SELECT (CASE WHEN comm.t_CorpActionDate = g_ZeroDate THEN PLB.t_DealDate ELSE comm.t_CorpActionDate END)
                                                                 FROM dnptxgo_dbt go, ddl_comm_dbt comm
                                                                WHERE go.t_ID = PLB.T_GOID
                                                                  AND comm.t_DocKind = go.t_DocKind
                                                                  AND comm.t_DocumentID = go.t_DocumentID
                                                              ), PLB.t_DealDate)
                                 ELSE PLB.t_DealDate END) as PLBDealDate,
                           TMP.T_PARENT_DOCID as Parent_LnkID, sf.t_Number as ContrNumber, fin.t_FI_Code 
                      FROM (SELECT t_Date, t_Kind, 
                                   NVL(SUM(t_Sum0), 0) t_Sum0, 
                                   t_Analitic5, t_AnaliticKind1, t_Analitic1 
                              FROM dnptxobj_dbt 
                             WHERE t_Client = pClient 
                               AND t_Kind = RSI_NPTXC.TXOBJ_COM
                             GROUP BY t_Date, t_Kind, t_Analitic5, t_AnaliticKind1, t_Analitic1                       
                           ) N, v_npx_dnptxlot LB, v_npx_dnptxlot LS, dnptxlnk_dbt S, DNPTXOP1OPLNK_TMP TMP, dnptxlnk_dbt PS, v_npx_dnptxlot PLB, v_npx_dnptxlot PLS, dsfcontr_dbt sf, dfininstr_dbt fin 
                     WHERE S.t_ID = TMP.T_DOCID
                       AND PS.t_ID = TMP.T_PARENT_DOCID
                       AND N.t_AnaliticKind1 = LS.t_AnaliticKind1 
                       AND N.t_Analitic1     = LS.t_Analitic1 
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID 
                       AND PS.t_BuyID  = PLB.t_ID 
                       AND PS.t_SaleID = PLS.t_ID
                       AND ((TMP.T_DOCID <> TMP.T_PARENT_DOCID) OR
                            (N.t_Date <= pEndDate AND S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
                            (N.t_Date <= pEndDate AND N.t_Date >= pBegDate AND S.t_Date <  pBegDate) OR 
                            (N.t_Date <  pBegDate AND S.t_Date <  pBegDate AND ( SELECT NVL(MIN(Obj.t_Date), g_ZeroDate) D 
                                                                                   FROM dnptxobj_dbt Obj 
                                                                                  WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                                                    AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                                                                    AND Obj.t_Analitic1     = LS.t_Analitic1  
                                                                                    AND Obj.t_Client        = pClient 
                                                                                    AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                                                                               ) BETWEEN pBegDate AND pEndDate)) 
                       AND sf.t_ID = PS.t_Contract
                       AND fin.t_FIID = S.t_FIID
                    ORDER BY S.t_SaleID                                                                    
                   )
    LOOP

      v_Dir  := RSI_NPTXC.TXOBJ_DIR_OUT;

      IF(one_rec.Parent_LnkID <> one_rec.t_ID) THEN
          v_SumAmount := 0;
          v_SumNDR    := 0;
      ELSIF(v_prevSaleID != one_rec.t_SaleID) THEN
        GetSumNdrByLink(one_rec.t_SaleID, 0, RSI_NPTXC.TXOBJ_COMS_0, pDocID, pStep, v_SumAmount_0, v_SumNDR_0, v_SumNDR_DelNom, 0, RSI_NPTXC.TXOBJ_COMS);
        GetSumNdrByLink(one_rec.t_SaleID, 0, RSI_NPTXC.TXOBJ_COMS, pDocID, pStep, v_SumAmount, v_SumNDR, v_SumNDR_DelNom, 0);
        v_SumAmount := v_SumAmount + v_SumAmount_0;
        v_SumNDR    := v_SumNDR    + v_SumNDR_0;
      ELSIF((v_prevSum != 0) AND (v_prevLnkID != one_rec.t_ID)) THEN
        v_SumNDR    := v_SumNDR + v_prevSum;
        v_SumAmount := v_SumAmount + v_prevSumAmount;
      END IF;

      IF((one_rec.LSAmount - v_SumAmount) < 0) THEN
        RSI_NPTMSG.PutMsg(RSI_NPTXC.MES_ERROR, one_rec.ContrNumber||' Количество бумаг '||one_rec.t_FI_Code||' в связях превышает количество бумаг в сделке '||one_rec.LSDealCode);
      ELSIF ((one_rec.LSAmount - v_SumAmount) = 0) THEN
        v_Sum   := 0;
        v_Sum_0 := 0;
      ELSE
        v_Sum   := (one_rec.t_Sum0 - v_SumNDR) / (one_rec.LSAmount - v_SumAmount) * (one_rec.SAmount - one_rec.SPrivAmount);
        v_Sum_0 := (one_rec.t_Sum0 - v_SumNDR) / (one_rec.LSAmount - v_SumAmount) * (                  one_rec.SPrivAmount);
      END IF;

      IF((v_SumAmount + one_rec.SAmount) != one_rec.LSAmount) THEN
        v_Sum   := ROUND(v_Sum, 2);
        v_Sum_0 := ROUND(v_Sum_0, 2);
      END IF;

      IF(v_Sum != 0 OR v_Sum_0 != 0) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.PLSDealDate, one_rec.PLBDealDate);
      END IF;

      IF(v_Sum != 0) THEN
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.SDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_COMS;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := RSI_RSB_FIInstr.NATCUR;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := 'Затраты на оплату комиссий при продаже';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF(v_Sum_0 != 0) THEN
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.SDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_COMS_0;                              
        nptxobj.T_SUM            := v_Sum_0;                                                 
        nptxobj.T_CUR            := RSI_RSB_FIInstr.NATCUR;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := 'Затраты на оплату комиссий при продаже льготных ц/б';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      END IF;

      v_prevSaleID    := one_rec.t_SaleID;
      v_prevLnkID     := one_rec.t_ID;
      v_prevSumAmount := one_rec.SAmount;
      v_prevSum       := v_Sum+v_Sum_0;


      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

    DELETE FROM DNPTXOP1OPLNK_TMP;

  END;


  --Расчет объектов НДР по связям
  PROCEDURE CreateTaxObjects2_12(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_prevSaleID    NUMBER;
    v_prevSumAmount NUMBER;
    v_prevSum       NUMBER;
                    
    v_Sum           NUMBER;
    v_Dir           NUMBER;

    v_SumAmount     NUMBER;
    v_SumNDR        NUMBER;
    v_SumNDR_DelNom NUMBER;
                    
  BEGIN
  
    pStat := 0;

    v_prevSaleID    := 0;
    v_prevSumAmount := 0;
    v_prevSum       := 0;

    FOR one_rec IN (SELECT N.t_Date, N.t_Cur, N.t_Kind, N.t_Sum, N.t_Sum0, N.t_Analitic5, 
                           LS.t_AnaliticKind1, LS.t_Analitic1, LS.t_Amount LSAmount, 
                           S.t_ID, S.t_FIID, S.t_Date SDate, S.t_Amount SAmount, S.t_Contract, S.t_SaleID, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, 
                           LS.t_DealDate AS LSDealDate, LB.t_DealDate AS LBDealDate, LS.t_DealCode as LSDealCode, sf.t_Number as ContrNumber, fin.t_FI_Code
                      FROM (SELECT t_Date, t_Cur, t_Kind, NVL(SUM(t_Sum), 0) t_Sum, NVL(SUM(t_Sum0), 0) t_Sum0, t_Analitic5, t_AnaliticKind1, t_Analitic1 
                              FROM dnptxobj_dbt 
                             WHERE t_Client = pCLient 
                               AND t_Kind = RSI_NPTXC.TXOBJ_COM
                             GROUP BY t_Date, t_Cur, t_Kind, t_Analitic5, t_AnaliticKind1, t_Analitic1                       
                           ) N, v_npx_dnptxlot LB, v_npx_dnptxlot LS, dnptxlnk_dbt S, dsfcontr_dbt sf, dfininstr_dbt fin 
                     WHERE S.t_Client = pClient
                       AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (S.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_AnaliticKind1 = LS.t_AnaliticKind1 
                       AND N.t_Analitic1     = LS.t_Analitic1 
                       AND LS.t_Type <> RSI_NPTXC.NPTXDEAL_CALC -- По реальным сделкам продажи
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
                       AND LB.t_Type <> RSI_NPTXC.NPTXDEAL_CALC
                       AND EXISTS ( SELECT Obj.t_Analitic1 
                                      FROM dnptxobj_dbt Obj
                                     WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                       AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                       AND Obj.t_Analitic1     = LS.t_Analitic1 
                                       AND Obj.t_Client        = pClient
                                       AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6) = pIIS
                                  ) 
                       AND LS.t_Kind  = RSI_NPTXC.NPTXLOTS_SALE
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID 
                       AND S.t_Type = RSI_NPTXC.NPTXLNK_CLPOS
                       AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
                       AND ((N.t_Date <= pEndDate AND S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
                            (N.t_Date <= pEndDate AND N.t_Date >= pBegDate AND S.t_Date <  pBegDate) OR 
                            (N.t_Date <  pBegDate AND S.t_Date <  pBegDate AND ( SELECT NVL(MIN(Obj.t_Date), g_ZeroDate) D 
                                                                     FROM dnptxobj_dbt Obj 
                                                                    WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                                      AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                                                      AND Obj.t_Analitic1     = LS.t_Analitic1  
                                                                      AND Obj.t_Client        = pClient 
                                                                      AND RSI_NPTO.CheckObjIIS (Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                                                                 ) BETWEEN pBegDate AND pEndDate ))  
                       AND sf.t_ID = S.t_Contract
                       AND fin.t_FIID = S.t_FIID
                    ORDER BY S.t_SaleID                                                                    
                   )
    LOOP

      v_Dir := RSI_NPTXC.TXOBJ_DIR_OUT;
         
      IF(v_prevSaleID != one_rec.t_SaleID) THEN
        GetSumNdrByLink(one_rec.t_SaleID, 0, RSI_NPTXC.TXOBJ_COMS_SHORT, pDocID, pStep, v_SumAmount, v_SumNDR, v_SumNDR_DelNom, 0);
      ELSIF(v_prevSum != 0) THEN
        v_SumNDR    := v_SumNDR + v_prevSum;
        v_SumAmount := v_SumAmount + v_prevSumAmount;
      END IF;

      IF((one_rec.LSAmount - v_SumAmount) < 0) THEN
        RSI_NPTMSG.PutMsg(RSI_NPTXC.MES_ERROR, one_rec.ContrNumber||' Количество бумаг '||one_rec.t_FI_Code||' в связях превышает количество бумаг в сделке '||one_rec.LSDealCode);
      ELSIF ((one_rec.LSAmount - v_SumAmount) = 0) THEN
        v_Sum := 0;
      ELSE
        v_Sum := (one_rec.t_Sum - v_SumNDR) / (one_rec.LSAmount - v_SumAmount) * one_rec.SAmount;
      END IF;

      IF((v_SumAmount + one_rec.SAmount) != one_rec.LSAmount) THEN
        v_Sum := ROUND(v_Sum, 2);
      END IF;

      IF(v_Sum != 0) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.LSDealDate, one_rec.LBDealDate);
      END IF;

      IF(v_Sum != 0) THEN
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.SDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_COMS_SHORT;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := one_rec.t_Cur;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := 'Затраты на оплату комиссий при продаже';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;


      v_prevSaleID    := one_rec.t_SaleID;
      v_prevSumAmount := one_rec.SAmount;
      v_prevSum       := v_Sum;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по связям
  PROCEDURE CreateTaxObjects2_13(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_prevSaleID    NUMBER;
    v_prevSumAmount NUMBER;
    v_prevSum       NUMBER;
                    
    v_Sum           NUMBER;
    v_Dir           NUMBER;

    v_SumAmount     NUMBER;
    v_SumNDR        NUMBER;
    v_SumNDR_DelNom NUMBER;
                    
  BEGIN
  
    pStat := 0;

    v_prevSaleID    := 0;
    v_prevSumAmount := 0;
    v_prevSum       := 0;

    FOR one_rec IN (SELECT N.t_Date, N.t_Cur, N.t_Kind, N.t_Sum, N.t_Sum0, N.t_Analitic5, 
                           LS.t_AnaliticKind1, LS.t_Analitic1, LS.t_Amount LSAmount, 
                           S.t_ID, S.t_FIID, S.t_Date SDate, S.t_Amount SAmount, S.t_Contract, S.t_SaleID, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, 
                           LS.t_DealDate AS LSDealDate, LB.t_DealDate AS LBDealDate, RealLS.t_Amount as RealAmount,
                           LS.t_DealCode as LSDealCode, sf.t_Number as ContrNumber, fin.t_FI_Code
                      FROM (SELECT t_Date, t_Cur, t_Kind, NVL(SUM(t_Sum), 0) t_Sum, NVL(SUM(t_Sum0), 0) t_Sum0, t_Analitic5, t_AnaliticKind1, t_Analitic1 
                              FROM dnptxobj_dbt 
                             WHERE t_Client = pCLient 
                               AND t_Kind = RSI_NPTXC.TXOBJ_COM
                             GROUP BY t_Date, t_Cur, t_Kind, t_Analitic5, t_AnaliticKind1, t_Analitic1                       
                           ) N, v_npx_dnptxlot LB, v_npx_dnptxlot LS, v_npx_dnptxlot RealLS, dnptxlnk_dbt S, dsfcontr_dbt sf, dfininstr_dbt fin 
                     WHERE S.t_Client = pClient
                       AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (S.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       --В связи - виртуальная продажа, в НДР - реальная.
                       AND N.t_AnaliticKind1 = RealLS.t_AnaliticKind1 
                       AND N.t_Analitic1     = RealLS.t_Analitic1 
                       AND LS.t_RealID       = RealLS.t_ID
                       AND LS.t_Type = RSI_NPTXC.NPTXDEAL_CALC -- По виртуальным сделкам продажи
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
                       AND LB.t_Type <> RSI_NPTXC.NPTXDEAL_CALC
                       AND EXISTS ( SELECT Obj.t_Analitic1 
                                      FROM dnptxobj_dbt Obj
                                     WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                       AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                       AND Obj.t_Analitic1     = LS.t_Analitic1 
                                       AND Obj.t_Client        = pClient
                                       AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6) = pIIS
                                  ) 
                       AND LS.t_Kind  = RSI_NPTXC.NPTXLOTS_SALE
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID 
                       AND S.t_Type = RSI_NPTXC.NPTXLNK_CLPOS
                       AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
                       AND ((N.t_Date <= pEndDate AND S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
                            (N.t_Date <= pEndDate AND N.t_Date >= pBegDate AND S.t_Date <  pBegDate) OR 
                            (N.t_Date <  pBegDate AND S.t_Date <  pBegDate AND ( SELECT NVL(MIN(Obj.t_Date), g_ZeroDate) D 
                                                                     FROM dnptxobj_dbt Obj 
                                                                    WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                                      AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                                                      AND Obj.t_Analitic1     = LS.t_Analitic1  
                                                                      AND Obj.t_Client        = pClient 
                                                                      AND RSI_NPTO.CheckObjIIS (Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                                                                 ) BETWEEN pBegDate AND pEndDate ))
                       AND sf.t_ID = S.t_Contract
                       AND fin.t_FIID = S.t_FIID                                           
                    ORDER BY S.t_SaleID                                                                    
                   )
    LOOP

      v_Dir := RSI_NPTXC.TXOBJ_DIR_OUT;
         
      IF(v_prevSaleID != one_rec.t_SaleID) THEN
        GetSumNdrByLink(one_rec.t_SaleID, 0, RSI_NPTXC.TXOBJ_COMS_SHORT, pDocID, pStep, v_SumAmount, v_SumNDR, v_SumNDR_DelNom, 0);
      ELSIF(v_prevSum != 0) THEN
        v_SumNDR    := v_SumNDR + v_prevSum;
        v_SumAmount := v_SumAmount + v_prevSumAmount;
      END IF;

      IF((one_rec.LSAmount - v_SumAmount) < 0) THEN
        RSI_NPTMSG.PutMsg(RSI_NPTXC.MES_ERROR, one_rec.ContrNumber||' Количество бумаг '||one_rec.t_FI_Code||' в связях превышает количество бумаг в сделке '||one_rec.LSDealCode);
      ELSIF ((one_rec.LSAmount - v_SumAmount) = 0) THEN
        v_Sum := 0;
      ELSE
        v_Sum := (one_rec.t_Sum - v_SumNDR) / (one_rec.RealAmount - v_SumAmount) * one_rec.SAmount;
      END IF;

      IF((v_SumAmount + one_rec.SAmount) != one_rec.LSAmount) THEN
        v_Sum := ROUND(v_Sum, 2);
      END IF;

      IF(v_Sum != 0) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.LSDealDate, one_rec.LBDealDate);
      END IF;

      IF(v_Sum != 0) THEN
        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.SDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_COMS_SHORT;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := one_rec.t_Cur;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := 'Затраты на оплату комиссий при продаже';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;


      v_prevSaleID    := one_rec.t_SaleID;
      v_prevSumAmount := one_rec.SAmount;
      v_prevSum       := v_Sum;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по связям
  PROCEDURE CreateTaxObjects2_14(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_prevFIID     NUMBER;
    v_prevPrAucNom NUMBER;
    v_prevNominal  NUMBER;

    v_PrAucNom     NUMBER;
                    
    v_Sum           NUMBER;
    v_Nom           NUMBER;

    v_Point         NUMBER;
    v_Nominal_lrate NUMBER;
                    
  BEGIN
  
    pStat := 0;

    v_prevFIID    := -1;

    FOR one_rec IN (SELECT LS.t_AnaliticKind1, LS.t_Analitic1, LS.t_SaleDate, LS.t_Amount LSAmount, LS.t_BegSaleDate, 
                           S.t_ID, S.t_FIID, S.t_Date, S.t_Amount SAmount, S.t_Type, S.t_Contract, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, 
                           Fin.t_FaceValueFI Cur,
                           RSI_RSB_FIInstr.FI_GetNominalDrawingDate(Fin.t_FIID, av.t_Termless, pEndDate) as t_DrawingDate, 
                           Fin.t_Issued, Fin.t_FI_Code, 
                           npto.GetPaperTaxGroupNPTX(S.t_FIID) TaxGroup, 
                           LS.t_DealDate AS LSDealDate, LB.t_DealDate AS LBDealDate, 
                           av.t_ISIN, Fin.t_Name
                      FROM v_npx_dnptxlot LB, v_npx_dnptxlot LS, dnptxlnk_dbt S, dfininstr_dbt Fin, davoiriss_dbt av 
                     WHERE S.t_Client = pCLient
                       AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS                             
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (S.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID 
                       AND Fin.t_FIID = S.t_FIID
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
                       AND LB.t_Type <> RSI_NPTXC.NPTXDEAL_CALC
                       AND S.t_Type IN (RSI_NPTXC.NPTXLNK_DELIVER, RSI_NPTXC.NPTXLNK_CLPOS)
                       AND npto.GetPaperTaxGroupNPTX(S.t_FIID) IN (RSI_NPTXC.TXGROUP_40, RSI_NPTXC.TXGROUP_50) 
                       AND RSB_FIInstr.FI_AvrKindsGetRoot( Fin.t_FI_Kind, Fin.t_AvoirKind ) = RSI_RSB_FIINSTR.AVOIRKIND_BOND
                       AND EXISTS ( SELECT Obj.t_Analitic1 
                                      FROM dnptxobj_dbt Obj 
                                     WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                       AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                       AND Obj.t_Analitic1     = LS.t_Analitic1 
                                       AND Obj.t_Client = pClient 
                                       AND RSI_NPTO.CheckObjIIS (Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                                  ) 
                       AND ((S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
                            (S.t_Date <  pBegDate AND ( SELECT NVL(MIN(Obj.t_Date), g_ZeroDate) D 
                                                          FROM dnptxobj_dbt Obj 
                                                         WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                           AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                                           AND Obj.t_Analitic1     = LS.t_Analitic1  
                                                           AND Obj.t_Client = pClient  
                                                           AND RSI_NPTO.CheckObjIIS (Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                                                      ) BETWEEN pBegDate AND pEndDate )) 
                       AND av.t_FIID = Fin.t_FIID 
                     ORDER by S.t_FIID                                                                       
                   )
    LOOP

      v_Circulate := -1;

      IF(v_prevFIID = one_rec.t_FIID) THEN
        v_Nom      := v_prevNominal;
        v_PrAucNom := v_prevPrAucNom;
      ELSE
        v_Nom := RSI_RSB_FIINSTR.FI_GetNominal(one_rec.t_FIID, v_Point, v_Nominal_lrate);

        v_prevFIID    := one_rec.t_FIID;
        v_prevNominal := v_Nom;

        v_PrAucNom := Rsb_SCTX.GetNoteText(RSB_SECUR.OBJTYPE_AVOIRISS, LPAD(one_rec.t_FIID, 10, '0'), 10);
        IF( v_PrAucNom IS NULL OR v_PrAucNom <= 0 ) THEN
         /*PDV id492978 не влияет на расчет, вводит пользователей в заблуждение*/
         --  DL_NPTX_PutMsg( "Для ц/б \"" + DataSet.FI_Code + "\" не задано примечание \"" + ИмяПримечания( OBJTYPE_AVOIRISS, 10 ), 20 );
          v_PrAucNom := 100.0;
        END IF;

        v_prevPrAucNom := v_PrAucNom;
      END IF;

      IF(one_rec.t_DrawingDate != g_ZeroDate) THEN

        v_Sum := one_rec.SAmount * v_Nom * (1 - 0.01 * v_PrAucNom) * 
                (one_rec.t_BegSaleDate - one_rec.t_Issued) / (one_rec.t_DrawingDate - one_rec.t_Issued);

        IF(v_Sum != 0) THEN
          v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.LSDealDate, one_rec.LBDealDate);

          InitNPTXOBJ(nptxobj);

          nptxobj.T_FUNCTIONKIND   := 1;
          nptxobj.T_DATE           := one_rec.t_Date;   
          nptxobj.T_CLIENT         := pClient;
          nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
          nptxobj.T_LEVEL          := 2;
          nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_DISCS;                              
          nptxobj.T_SUM            := ROUND(v_Sum, 2);                                                 
          nptxobj.T_CUR            := one_rec.Cur;                                
          nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
          nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
          nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
          nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
          nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
          nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
          nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
          nptxobj.T_ANALITIC4      := v_Circulate;                                     
          nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
          nptxobj.T_ANALITIC5      := one_rec.TaxGroup;                                      
          nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
          nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
          nptxobj.T_COMMENT        := 'Дисконт при продаже/погашении';      
          nptxobj.T_DOCID          := pDocID;
          nptxobj.T_STEP           := pStep; 
          nptxobj.T_TECHNICAL      := CHR(0);

          nptxobj_ins.extend;
          nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
        END IF;

        v_Sum := one_rec.SAmount * v_Nom * (1 - 0.01 * v_PrAucNom) * 
                (one_rec.t_SaleDate - one_rec.t_Issued) / (one_rec.t_DrawingDate - one_rec.t_Issued);

        IF(v_Sum != 0) THEN
          IF v_Circulate = -1 THEN
            v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.LSDealDate, one_rec.LBDealDate);
          END IF;

          InitNPTXOBJ(nptxobj);

          nptxobj.T_FUNCTIONKIND   := 1;
          nptxobj.T_DATE           := one_rec.t_Date;   
          nptxobj.T_CLIENT         := pClient;
          nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
          nptxobj.T_LEVEL          := 2;
          nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_DISCB;                              
          nptxobj.T_SUM            := ROUND(v_Sum, 2);                                                 
          nptxobj.T_CUR            := one_rec.Cur;                                
          nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
          nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
          nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
          nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
          nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
          nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
          nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
          nptxobj.T_ANALITIC4      := v_Circulate;                                     
          nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
          nptxobj.T_ANALITIC5      := one_rec.TaxGroup;                                      
          nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
          nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
          nptxobj.T_COMMENT        := 'Дисконт при покупке';      
          nptxobj.T_DOCID          := pDocID;
          nptxobj.T_STEP           := pStep; 
          nptxobj.T_TECHNICAL      := CHR(0);

          nptxobj_ins.extend;
          nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
        END IF;
      ELSE
        RSI_NPTMSG.PutMsg(RSI_NPTXC.MES_WARN,'По облигации с признаком "бессрочная" ' || TO_CHAR(one_rec.t_ISIN) || (CASE WHEN one_Rec.t_ISIN != CHR(1) AND one_rec.t_Name != CHR(1) THEN ', ' ELSE '' END) || one_rec.t_Name + ' нельзя определить дату погашения/оферты');
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по связям
  PROCEDURE CreateTaxObjects2_15(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_prevFIID     NUMBER;
    v_prevPrAucNom NUMBER;
    v_prevNominal  NUMBER;

    v_PrAucNom     NUMBER;
                    
    v_Sum           NUMBER;
    v_Nom           NUMBER;

    v_Point         NUMBER;
    v_Nominal_lrate NUMBER;
                    
  BEGIN
  
    pStat := 0;

    v_prevFIID    := -1;

    FOR one_rec IN (SELECT LS.t_AnaliticKind1, LS.t_Analitic1, LS.t_SaleDate, LS.t_Amount LSAmount, 
                           S.t_ID, S.t_FIID, S.t_Date, S.t_Amount SAmount, S.t_Type, S.t_Contract, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, 
                           Fin.t_FaceValueFI Cur, Fin.t_DrawingDate, Fin.t_Issued, Fin.t_FI_Code, 
                           npto.GetPaperTaxGroupNPTX( S.t_FIID ) TaxGroup, 
                           LS.t_DealDate AS LSDealDate, LB.t_DealDate AS LBDealDate
                      FROM v_npx_dnptxlot LB, v_npx_dnptxlot LS, dnptxlnk_dbt S, dfininstr_dbt Fin 
                     WHERE S.t_Client = pClient
                       AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS  
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (S.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID 
                       AND LB.t_BuyDate < S.t_Date 
                       AND Fin.t_FIID = S.t_FIID  
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
                       AND LB.t_Type <> RSI_NPTXC.NPTXDEAL_CALC
                       AND S.t_Type IN (RSI_NPTXC.NPTXLNK_DELIVER,
                                        RSI_NPTXC.NPTXLNK_CLPOS
                                       ) 
                       AND npto.GetPaperTaxGroupNPTX( S.t_FIID ) IN (RSI_NPTXC.TXGROUP_40, 
                                                                     RSI_NPTXC.TXGROUP_50
                                                                    ) 
                       AND RSB_FIInstr.FI_AvrKindsGetRoot(Fin.t_FI_Kind, Fin.t_AvoirKind) = RSI_RSB_FIINSTR.AVOIRKIND_BOND
                       AND EXISTS ( SELECT Obj.t_Analitic1 
                                      FROM dnptxobj_dbt Obj
                                     WHERE Obj.t_Kind =  RSI_NPTXC.TXOBJ_MAIN
                                       AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                       AND Obj.t_Analitic1     = LS.t_Analitic1 
                                       AND Obj.t_Client = pClient
                                       AND RSI_NPTO.CheckObjIIS (Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                                  ) 
                       AND ((S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR
                            (S.t_Date <  pBegDate AND ( SELECT NVL(MIN(Obj.t_Date), g_ZeroDate) D 
                                                   FROM dnptxobj_dbt Obj 
                                                  WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                    AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                                    AND Obj.t_Analitic1     = LS.t_Analitic1  
                                                    AND Obj.t_Client = pClient 
                                                    AND RSI_NPTO.CheckObjIIS (Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                                               ) BETWEEN pBegDate AND pEndDate ))  
                     ORDER BY S.t_FIID                                                                       
                   )
    LOOP

      IF(v_prevFIID = one_rec.t_FIID) THEN
        v_Nom      := v_prevNominal;
        v_PrAucNom := v_prevPrAucNom;
      ELSE
        v_Nom := RSI_RSB_FIINSTR.FI_GetNominal(one_rec.t_FIID, v_Point, v_Nominal_lrate);

        v_prevFIID    := one_rec.t_FIID;
        v_prevNominal := v_Nom;

        v_PrAucNom := Rsb_SCTX.GetNoteText(RSB_SECUR.OBJTYPE_AVOIRISS, LPAD(one_rec.t_FIID, 10, '0'), 10);
        IF( v_PrAucNom IS NULL OR v_PrAucNom <= 0 ) THEN
         /*PDV id492978 не влияет на расчет, вводит пользователей в заблуждение*/
         --  DL_NPTX_PutMsg( "Для ц/б \"" + DataSet.FI_Code + "\" не задано примечание \"" + ИмяПримечания( OBJTYPE_AVOIRISS, 10 ), 20 );
          v_PrAucNom := 100.0;
        END IF;

        v_prevPrAucNom := v_PrAucNom;
      END IF;

      v_Sum := one_rec.SAmount * v_Nom * (1 - 0.01 * v_PrAucNom) * 
              (one_rec.t_Date - one_rec.t_BuyDate) / (one_rec.t_DrawingDate - one_rec.t_Issued);

      IF(v_Sum != 0) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.LSDealDate, one_rec.LBDealDate);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_Date;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_DISCOUNT_LINK;                              
        nptxobj.T_SUM            := ROUND(v_Sum, 2);                                                 
        nptxobj.T_CUR            := one_rec.Cur;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := 'Процентный доход по ц/б';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по связям
  PROCEDURE CreateTaxObjects2_16(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_prevFIID     NUMBER;
    v_prevPrAucNom NUMBER;
    v_prevNominal  NUMBER;

    v_PrAucNom     NUMBER;
                    
    v_Sum           NUMBER;
    v_Nom           NUMBER;

    v_Point         NUMBER;
    v_Nominal_lrate NUMBER;
                    
  BEGIN
  
    pStat := 0;

    v_prevFIID    := -1;

    FOR one_rec IN (SELECT LS.t_AnaliticKind1, LS.t_Analitic1, LS.t_SaleDate, LS.t_Amount LSAmount, LS.t_BegSaleDate, 
                           S.t_ID, S.t_FIID, S.t_Date, S.t_Amount SAmount, S.t_Type, S.t_Contract, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, 
                           Fin.t_FaceValueFI Cur, Fin.t_DrawingDate, Fin.t_Issued, Fin.t_FI_Code, 
                           npto.GetPaperTaxGroupNPTX( S.t_FIID ) TaxGroup, 
                           LS.t_DealDate AS LSDealDate, LB.t_DealDate AS LBDealDate 
                      FROM v_npx_dnptxlot LB, v_npx_dnptxlot LS, dnptxlnk_dbt S, dfininstr_dbt Fin 
                     WHERE S.t_Client = pClient
                       AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS 
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (S.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID 
                       AND S.t_Type = RSI_NPTXC.NPTXLNK_CLPOS
                       AND Fin.t_FIID = S.t_FIID 
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
                       AND LB.t_Type <> RSI_NPTXC.NPTXDEAL_CALC
                       AND npto.GetPaperTaxGroupNPTX( S.t_FIID ) IN (RSI_NPTXC.TXGROUP_40, 
                                                                     RSI_NPTXC.TXGROUP_50
                                                                    )
                       AND RSB_FIInstr.FI_AvrKindsGetRoot( Fin.t_FI_Kind, Fin.t_AvoirKind ) = RSI_RSB_FIINSTR.AVOIRKIND_BOND
                       AND exists ( SELECT Obj.t_Analitic1 
                                      FROM dnptxobj_dbt Obj
                                     WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                       AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                       AND Obj.t_Analitic1     = LS.t_Analitic1 
                                       AND Obj.t_Client = pClient
                                       AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6) = pIIS
                                  ) 
                       AND ((S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
                            (S.t_Date <  pBegDate AND ( SELECT NVL(min(Obj.t_Date), g_ZeroDate) D 
                                                          FROM dnptxobj_dbt Obj 
                                                         WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                           AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                                           AND Obj.t_Analitic1     = LS.t_Analitic1  
                                                           AND Obj.t_Client = pClient 
                                                           AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6) = pIIS
                                                      ) BETWEEN pBegDate AND pEndDate ))   
                     ORDER BY S.t_FIID                                                                       
                   )
    LOOP

      IF(v_prevFIID = one_rec.t_FIID) THEN
        v_Nom      := v_prevNominal;
        v_PrAucNom := v_prevPrAucNom;
      ELSE
        v_Nom := RSI_RSB_FIINSTR.FI_GetNominal(one_rec.t_FIID, v_Point, v_Nominal_lrate);

        v_prevFIID    := one_rec.t_FIID;
        v_prevNominal := v_Nom;

        v_PrAucNom := Rsb_SCTX.GetNoteText(RSB_SECUR.OBJTYPE_AVOIRISS, LPAD(one_rec.t_FIID, 10, '0'), 10);
        IF( v_PrAucNom IS NULL OR v_PrAucNom <= 0 ) THEN
         /*PDV id492978 не влияет на расчет, вводит пользователей в заблуждение*/
         --  DL_NPTX_PutMsg( "Для ц/б \"" + DataSet.FI_Code + "\" не задано примечание \"" + ИмяПримечания( OBJTYPE_AVOIRISS, 10 ), 20 );
          v_PrAucNom := 100.0;
        END IF;

        v_prevPrAucNom := v_PrAucNom;
      END IF;

      v_Sum := one_rec.SAmount * v_Nom * (1 - 0.01 * v_PrAucNom) * 
              (one_rec.t_Date - one_rec.t_BegSaleDate) / (one_rec.t_DrawingDate - one_rec.t_Issued);

      IF(v_Sum != 0) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.LSDealDate, one_rec.LBDealDate);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_Date;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_DISCOUNT_LINK;                              
        nptxobj.T_SUM            := ROUND(v_Sum, 2);                                                 
        nptxobj.T_CUR            := one_rec.Cur;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := 'Процентный расход по ц/б';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по связям
  PROCEDURE CreateTaxObjects2_17(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_prevFIID     NUMBER;
    v_prevPrAucNom NUMBER;
    v_prevNominal  NUMBER;

    v_PrAucNom     NUMBER;
                    
    v_Sum           NUMBER;
    v_Nom           NUMBER;
    v_main_b        NUMBER;

    v_Point         NUMBER;
    v_Nominal_lrate NUMBER;
                    
  BEGIN
  
    pStat := 0;

    v_prevFIID    := -1;

    FOR one_rec IN (SELECT LS.t_AnaliticKind1, LS.t_Analitic1, LS.t_SaleDate, LS.t_Amount LSAmount, LS.t_BegSaleDate, 
                           S.t_ID, S.t_FIID, S.t_Date, S.t_Amount SAmount, S.t_Type, S.t_Contract, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, 
                           Fin.t_FaceValueFI Cur, Fin.t_DrawingDate, Fin.t_Issued, Fin.t_FI_Code, 
                           LS.t_DealDate AS LSDealDate, LB.t_DealDate AS LBDealDate 
                      FROM v_npx_dnptxlot LB, v_npx_dnptxlot LS, dnptxlnk_dbt S, dfininstr_dbt Fin, davoiriss_dbt Avoir 
                     WHERE S.t_Client = pClient
                       AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS 
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (S.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID 
                       AND LS.t_DocKind = RSB_SECUR.DL_RETIREMENT
                       AND Fin.t_FIID = S.t_FIID 
                       AND Fin.t_AvoirKind = RSI_RSB_FIINSTR.AVOIRKIND_BOND_CORPORATE_BOND 
                       AND Fin.t_FaceValueFI = RSI_RSB_FIInstr.NATCUR
                       AND Avoir.t_BegPlacementDate >= TO_DATE('01.01.2017','DD.MM.YYYY') 
                       AND Avoir.t_FIID = Fin.t_FIID  
                       AND LS.t_SaleDate > TO_DATE('01.01.2018','DD.MM.YYYY') 
                       AND LS.t_SaleDate < TO_DATE('01.01.2021', 'DD.MM.YYYY')
                       AND NPTO.IfMarket(Fin.t_FIID,LS.t_SaleDate) = 'X' 
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO 
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
                       AND LB.t_Type <> RSI_NPTXC.NPTXDEAL_CALC
                       AND S.t_Type = RSI_NPTXC.NPTXLNK_DELIVER
                       AND npto.GetPaperTaxGroupNPTX(S.t_FIID) = RSI_NPTXC.TXGROUP_20
                       AND EXISTS ( SELECT Obj.t_Analitic1 
                                      FROM dnptxobj_dbt Obj
                                     WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                       AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                       AND Obj.t_Analitic1     = LS.t_Analitic1 
                                       AND Obj.t_Client = pClient
                                       AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6) = pIIS
                                  ) 
                       AND ((S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
                            (S.t_Date <  pBegDate AND ( SELECT NVL(MIN(Obj.t_Date), g_ZeroDate) D 
                                                   FROM dnptxobj_dbt Obj 
                                                  WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                    AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                                    AND Obj.t_Analitic1     = LS.t_Analitic1  
                                                    AND Obj.t_Client = pClient 
                                                    AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6) = pIIS
                                               ) BETWEEN pBegDate AND pEndDate ))    
                     ORDER BY S.t_FIID                                                                       
                   )
    LOOP

      IF(v_prevFIID = one_rec.t_FIID) THEN
        v_Nom      := v_prevNominal;
        v_PrAucNom := v_prevPrAucNom;
      ELSE
        v_Nom := RSI_RSB_FIINSTR.FI_GetNominal(one_rec.t_FIID, v_Point, v_Nominal_lrate);

        v_prevFIID    := one_rec.t_FIID;
        v_prevNominal := v_Nom;

        v_PrAucNom := Rsb_SCTX.GetNoteText(RSB_SECUR.OBJTYPE_AVOIRISS, LPAD(one_rec.t_FIID, 10, '0'), 10);
        IF( v_PrAucNom IS NULL OR v_PrAucNom <= 0 ) THEN
          v_PrAucNom := 100.0;
        END IF;

        v_prevPrAucNom := v_PrAucNom;
      END IF;

      SELECT NVL(SUM(t_Sum), 0)
        INTO v_main_b
        FROM dnptxobj_tmp
       WHERE t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
         AND t_Analitic2 = one_rec.t_ID
         AND t_Kind = RSI_NPTXC.TXOBJ_MAINB;

      v_Sum := LEAST(v_Nom - v_PrAucNom * v_Nom / 100, v_Nom - v_main_b / one_rec.LSAmount) * one_rec.SAmount;

      IF(v_Sum != 0) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.LSDealDate, one_rec.LBDealDate);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_Date;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_DISCS_0;                              
        nptxobj.T_SUM            := ROUND(v_Sum, 2);                                                 
        nptxobj.T_CUR            := one_rec.Cur;                                
        nptxobj.T_ANALITICKIND1  := one_rec.t_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.t_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := RSI_NPTXC.TXGROUP_20;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := 'Дисконт при погашении, не включаемый в НОБ';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по связям
  PROCEDURE CreateTaxObjects2_18(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_SB    NUMBER;
    v_SBVal NUMBER;
    v_SS    NUMBER;
    v_SSVal NUMBER;
    v_Sum   NUMBER;
                    
  BEGIN
  
    pStat := 0;

    FOR one_rec IN (SELECT LS.t_AnaliticKind1 S_AnaliticKind1, LS.t_Analitic1 S_Analitic1, LS.t_SaleDate, LS.t_Amount LSAmount, 
                           S.t_ID, S.t_FIID, S.t_Date, S.t_Amount SAmount, S.t_Type, S.t_Contract,  
                           LB.t_BuyDate, LB.t_Amount LBAmount, LB.t_AnaliticKind1 B_AnaliticKind1, LB.t_Analitic1 B_Analitic1, 
                           Fin.t_FaceValueFI Cur, Fin.t_DrawingDate, Fin.t_Issued, 
                           npto.GetPaperTaxGroupNPTX( S.t_FIID ) TaxGroup, 
                           LS.t_DealDate AS LSDealDate, LB.t_DealDate AS LBDealDate 
                      FROM v_npx_dnptxlot LB, v_npx_dnptxlot LS, dnptxlnk_dbt S, dfininstr_dbt Fin 
                     WHERE S.t_Client = pClient
                       AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS            
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (S.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID 
                       AND S.t_Type = RSI_NPTXC.NPTXLNK_DELIVER
                       AND Fin.t_FIID = S.t_FIID 
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
                       AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
                       AND npto.GetPaperTaxGroupNPTX(S.t_FIID) IN (RSI_NPTXC.TXGROUP_30,
                                                                   RSI_NPTXC.TXGROUP_40,
                                                                   RSI_NPTXC.TXGROUP_50
                                                                  ) 
                       AND RSB_FIInstr.FI_IsCouponAvoiriss(S.t_FIID) = 1 
                       AND EXISTS ( SELECT Obj.t_Analitic1 
                                      FROM dnptxobj_dbt Obj 
                                     WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                       AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                       AND Obj.t_Analitic1     = LS.t_Analitic1 
                                       AND Obj.t_Client = pClient
                                       AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6) = pClient
                                  ) 
                       AND ((S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
                            (S.t_Date <  pBegDate AND ( SELECT NVL(MIN(Obj.t_Date), g_ZeroDate) D 
                                                          FROM dnptxobj_dbt Obj 
                                                         WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                           AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                                           AND Obj.t_Analitic1     = LS.t_Analitic1  
                                                           AND Obj.t_Client = pClient 
                                                           AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6) = pIIS
                                                      ) BETWEEN pBegDate AND pEndDate ))                                                                        
                   )
    LOOP

      GetNPTXOBJSumByA1(v_SBVal, v_SB, pClient, one_rec.B_AnaliticKind1, one_rec.B_Analitic1, RSI_NPTXC.TXOBJ_NKD, g_ZeroDate, g_MaxDate);

      GetNPTXOBJSumByA1(v_SSVal, v_SS, pClient, one_rec.S_AnaliticKind1, one_rec.S_Analitic1, RSI_NPTXC.TXOBJ_NKD, g_ZeroDate, g_MaxDate);

      v_Sum := one_rec.SAmount * (v_SS / one_rec.LSAmount - v_SB / one_rec.LBAmount); --Может получиться отрицательная величина

      v_Sum := ROUND(v_Sum, 2);

      IF(v_Sum != 0) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.LSDealDate, one_rec.LBDealDate);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_Date;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_PROCSEC_Link;                              
        nptxobj.T_SUM            := ROUND(v_Sum, 2);                                                 
        nptxobj.T_CUR            := RSI_RSB_FIInstr.NATCUR;                                
        nptxobj.T_ANALITICKIND1  := one_rec.S_AnaliticKind1;                           
        nptxobj.T_ANALITIC1      := one_rec.S_Analitic1;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := 'Процентный доход по ц/б';      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  FUNCTION CL(pDate IN DATE, pA IN NUMBER, pD1 IN DATE, pD2 IN DATE, pFIID IN NUMBER) RETURN NUMBER
  AS
    v_CouponCount NUMBER;
  BEGIN
    RETURN RSB_SPREPFUN.GetCouponSumByPeriod_Rub(pFIID, pA, pD1 + 1, pD2, v_CouponCount, g_ZeroDate, 0);
  END;


  --Расчет объектов НДР по связям
  PROCEDURE CreateTaxObjects2_19(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_SB    NUMBER;
    v_SBVal NUMBER;
    v_SS    NUMBER;
    v_SSVal NUMBER;
    v_NKDS  NUMBER;
    v_Sum   NUMBER;
    
                    
  BEGIN
  
    pStat := 0;

    IF Rsb_Common.GetRegIntValue('COMMON\НДФЛ\ПРОВОДИТЬ ПЕРЕТАСОВКУ ДЛЯ НДФЛ', 0) = 0 THEN

      FOR one_rec IN (SELECT LS.t_AnaliticKind1 S_AnaliticKind1, LS.t_Analitic1 S_Analitic1, LS.t_SaleDate, LS.t_Amount LSAmount, LS.t_BegSaleDate, 
                             S.t_ID, S.t_FIID, S.t_Date, S.t_Amount SAmount, S.t_Type, S.t_Contract, 
                             LB.t_BuyDate, LB.t_Amount LBAmount, LB.t_AnaliticKind1 B_AnaliticKind1, LB.t_Analitic1 B_Analitic1, 
                             Fin.t_FaceValueFI Cur, Fin.t_DrawingDate, Fin.t_Issued, 
                             npto.GetPaperTaxGroupNPTX( S.t_FIID ) TaxGroup, 
                             fin.t_FI_Kind, fin.t_AvoirKind, fin.t_FaceValueFI, fin.t_FaceValue, 
                             LS.t_DealDate AS LSDealDate,
                             (CASE WHEN LB.T_GOID > 0 THEN NVL((SELECT (CASE WHEN comm.t_CorpActionDate = g_ZeroDate THEN LB.t_DealDate ELSE comm.t_CorpActionDate END)
                                                                 FROM dnptxgo_dbt go, ddl_comm_dbt comm
                                                                WHERE go.t_ID = LB.T_GOID
                                                                  AND comm.t_DocKind = go.t_DocKind
                                                                  AND comm.t_DocumentID = go.t_DocumentID
                                                              ), LB.t_DealDate)
                                 ELSE LB.t_DealDate END) as LBDealDate 
                        FROM v_npx_dnptxlot LB, v_npx_dnptxlot LS, dnptxlnk_dbt S, dfininstr_dbt Fin 
                       WHERE S.t_Client = pClient
                         AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS     
                         AND ((pContract IS NULL) OR (pContract <= 0) OR (S.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                         AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
                         AND S.t_BuyID  = LB.t_ID 
                         AND S.t_SaleID = LS.t_ID 
                         AND S.t_Type = RSI_NPTXC.NPTXLNK_CLPOS
                         AND Fin.t_FIID = S.t_FIID 
                         AND RSB_FIInstr.FI_IsCouponAvoiriss(S.t_FIID) = 1 
                         AND EXISTS ( SELECT Obj.t_Analitic1 
                                        FROM dnptxobj_dbt Obj 
                                       WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                         AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                         AND Obj.t_Analitic1     = LS.t_Analitic1 
                                         AND Obj.t_Client = pClient
                                         AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                                    ) 
                         AND ((S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
                              (S.t_Date <  pBegDate AND ( SELECT NVL(MIN(Obj.t_Date), g_ZeroDate) D 
                                                            FROM dnptxobj_dbt Obj 
                                                           WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                             AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                                             AND Obj.t_Analitic1     = LS.t_Analitic1  
                                                             AND Obj.t_Client = pClient 
                                                             AND RSI_NPTO.CheckObjIIS (Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                                                        ) BETWEEN pBegDate AND pEndDate ))                                                                         
                     )
      LOOP

        v_Circulate := -1;
        
        GetNPTXOBJSumByA1(v_SBVal, v_SB, pClient, one_rec.B_AnaliticKind1, one_rec.B_Analitic1, RSI_NPTXC.TXOBJ_NKD, g_ZeroDate, g_MaxDate);

        GetNPTXOBJSumByA1(v_SSVal, v_SS, pClient, one_rec.S_AnaliticKind1, one_rec.S_Analitic1, RSI_NPTXC.TXOBJ_NKD, g_ZeroDate, g_MaxDate);

        v_NKDS := RSI_RSB_FIInstr.FI_CalcNKD(one_rec.t_FIID, one_rec.t_Date, 1, 0);
        
        IF ((one_rec.t_FI_Kind = RSI_RSB_FIINSTR.FIKIND_AVOIRISS) AND (one_rec.t_AvoirKind = RSI_RSB_FIINSTR.AVOIRKIND_BOND_OVVZ) and (one_rec.t_Date >= TO_DATE('01.01.2019','DD.MM.YYYY'))) THEN
          /*ОВВЗ и дата продажи больще 1 января 2019 года*/
          v_NKDS := NVL(RSB_FIInstr.ConvSum(v_NKDS, one_rec.Cur, RSI_RSB_FIInstr.NATCUR, one_rec.t_Date),0);
        ELSE
          v_NKDS := NVL(RSB_FIInstr.ConvSum(v_NKDS, one_rec.Cur, RSI_RSB_FIInstr.NATCUR, one_rec.t_SaleDate),0);
        END IF;

        v_Sum := one_rec.SAmount * (v_NKDS - v_SS / one_rec.LSAmount) + CL(one_rec.t_Date, one_rec.SAmount, one_rec.t_BegSaleDate, one_rec.t_Date, one_rec.t_FIID);

        v_Sum := ROUND(v_Sum, 2);

        IF(v_Sum != 0) THEN
          v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.LSDealDate, one_rec.LBDealDate);

          InitNPTXOBJ(nptxobj);

          nptxobj.T_FUNCTIONKIND   := 1;
          nptxobj.T_DATE           := one_rec.t_Date;   
          nptxobj.T_CLIENT         := pClient;
          nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
          nptxobj.T_LEVEL          := 2;
          nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_PROCSEC_Link;                              
          nptxobj.T_SUM            := v_Sum;                                                 
          nptxobj.T_CUR            := RSI_RSB_FIInstr.NATCUR;                                
          nptxobj.T_ANALITICKIND1  := one_rec.S_AnaliticKind1;                           
          nptxobj.T_ANALITIC1      := one_rec.S_Analitic1;                                   
          nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
          nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
          nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
          nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
          nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
          nptxobj.T_ANALITIC4      := v_Circulate;                                     
          nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
          nptxobj.T_ANALITIC5      := one_rec.TaxGroup;                                      
          nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
          nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
          nptxobj.T_COMMENT        := 'Процентный расход по ц/б';      
          nptxobj.T_DOCID          := pDocID;
          nptxobj.T_STEP           := pStep; 
          nptxobj.T_TECHNICAL      := CHR(0);

          nptxobj_ins.extend;
          nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
        END IF;

        v_Sum := one_rec.SAmount * (v_NKDS - v_SB / one_rec.LBAmount) + CL(one_rec.t_Date, one_rec.SAmount, one_rec.t_BuyDate, one_rec.t_Date, one_rec.t_FIID);

        v_Sum := ROUND(v_Sum, 2);

        IF((v_Sum != 0) AND (one_rec.t_BuyDate < one_rec.t_Date)) THEN
          IF v_Circulate = -1 THEN
            v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.LSDealDate, one_rec.LBDealDate);
          END IF;

          InitNPTXOBJ(nptxobj);

          nptxobj.T_FUNCTIONKIND   := 1;
          nptxobj.T_DATE           := one_rec.t_Date;   
          nptxobj.T_CLIENT         := pClient;
          nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_IN;        
          nptxobj.T_LEVEL          := 2;
          nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_PROCSEC_Link;                              
          nptxobj.T_SUM            := v_Sum;                                                 
          nptxobj.T_CUR            := RSI_RSB_FIInstr.NATCUR;                                
          nptxobj.T_ANALITICKIND1  := one_rec.S_AnaliticKind1;                           
          nptxobj.T_ANALITIC1      := one_rec.S_Analitic1;                                   
          nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
          nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
          nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
          nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
          nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
          nptxobj.T_ANALITIC4      := v_Circulate;                                     
          nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
          nptxobj.T_ANALITIC5      := one_rec.TaxGroup;                                      
          nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
          nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
          nptxobj.T_COMMENT        := 'Процентный доход по ц/б';      
          nptxobj.T_DOCID          := pDocID;
          nptxobj.T_STEP           := pStep; 
          nptxobj.T_TECHNICAL      := CHR(0);

          nptxobj_ins.extend;
          nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
        END IF;

        IF nptxobj_ins.COUNT >= g_Limit THEN
          FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
               INSERT INTO DNPTXOBJ_TMP
                    VALUES nptxobj_ins(indx);

          nptxobj_ins.Delete;                                    
          nptxobj_ins := nptxobj_t();
        END IF;

      END LOOP;
    ELSE

      FOR one_rec IN (SELECT LS.t_AnaliticKind1 S_AnaliticKind1, LS.t_Analitic1 S_Analitic1, LS.t_SaleDate, LS.t_Amount LSAmount, LS.t_BegSaleDate, 
                             S.t_ID, S.t_FIID, S.t_Date, S.t_Amount SAmount, S.t_Type, S.t_Contract, 
                             LB.t_BuyDate, LB.t_Amount LBAmount, LB.t_AnaliticKind1 B_AnaliticKind1, LB.t_Analitic1 B_Analitic1, 
                             Fin.t_FaceValueFI Cur, Fin.t_DrawingDate, Fin.t_Issued, 
                             npto.GetPaperTaxGroupNPTX( S.t_FIID ) TaxGroup, 
                             fin.t_FI_Kind, fin.t_AvoirKind, fin.t_FaceValueFI, fin.t_FaceValue, 
                             LS.t_DealDate LSDealDate, LB.t_DealDate LBDealDate 
                        FROM v_npx_dnptxlot LB, v_npx_dnptxlot LS, dnptxlnk_dbt S, dfininstr_dbt Fin 
                       WHERE S.t_Client = pClient
                         AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS                             
                         AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
                         AND S.t_BuyID  = LB.t_ID 
                         AND S.t_SaleID = LS.t_ID 
                         AND S.t_Type = RSI_NPTXC.NPTXLNK_CLPOS
                         AND Fin.t_FIID = S.t_FIID 
                         AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
                         AND LB.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
                         AND LB.t_Type <> RSI_NPTXC.NPTXDEAL_CALC
                         AND RSB_FIInstr.FI_IsCouponAvoiriss(S.t_FIID) = 1 
                         AND EXISTS ( SELECT Obj.t_Analitic1 
                                        FROM dnptxobj_dbt Obj 
                                       WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                         AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                         AND Obj.t_Analitic1     = LS.t_Analitic1 
                                         AND Obj.t_Client = pClient
                                         AND RSI_NPTO.CheckObjIIS (Obj.t_AnaliticKind6, Obj.t_Analitic6 ) = pIIS
                                    ) 
                         AND ((S.t_Date >= pBegDate AND S.t_Date <= pEndDate) OR 
                              (S.t_Date <  pBegDate AND ( SELECT NVL(min(Obj.t_Date), g_ZeroDate) D 
                                                            FROM dnptxobj_dbt Obj 
                                                           WHERE Obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                                             AND Obj.t_AnaliticKind1 = LS.t_AnaliticKind1 
                                                             AND Obj.t_Analitic1     = LS.t_Analitic1  
                                                             AND Obj.t_Client = pClient 
                                                             AND RSI_NPTO.CheckObjIIS(Obj.t_AnaliticKind6, Obj.t_Analitic6) = pIIS      
                                                        ) BETWEEN pBegDate AND pEndDate ))                                                                          
                     )
      LOOP

        v_Circulate := -1;
        
        GetNPTXOBJSumByA1(v_SBVal, v_SB, pClient, one_rec.B_AnaliticKind1, one_rec.B_Analitic1, RSI_NPTXC.TXOBJ_NKD, g_ZeroDate, g_MaxDate);

        GetNPTXOBJSumByA1(v_SSVal, v_SS, pClient, one_rec.S_AnaliticKind1, one_rec.S_Analitic1, RSI_NPTXC.TXOBJ_NKD, g_ZeroDate, g_MaxDate);

        IF ((one_rec.t_FI_Kind = RSI_RSB_FIINSTR.FIKIND_AVOIRISS) AND (one_rec.t_AvoirKind = RSI_RSB_FIINSTR.AVOIRKIND_BOND_OVVZ) and (one_rec.t_Date >= TO_DATE('01.01.2019','DD.MM.YYYY'))) THEN
          v_Sum := one_rec.SAmount * (RSB_SPREPFUN.SmartConvertSum_Ex(v_SSVal, one_rec.t_SaleDate, one_rec.Cur, RSI_RSB_FIInstr.NATCUR, 0) / one_rec.LBAmount - v_SS / one_rec.LSAmount) + CL(one_rec.t_Date, one_rec.SAmount, one_rec.t_BegSaleDate, one_rec.t_Date, one_rec.t_FIID);
        ELSE
          v_Sum := one_rec.SAmount * (v_SB / one_rec.LBAmount - v_SS / one_rec.LSAmount) + CL(one_rec.t_Date, one_rec.SAmount, one_rec.t_BegSaleDate, one_rec.t_Date, one_rec.t_FIID);
        END IF;

        v_Sum := ROUND(v_Sum, 2);

        IF(v_Sum != 0) THEN
          v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.LSDealDate, one_rec.LBDealDate);

          InitNPTXOBJ(nptxobj);

          nptxobj.T_FUNCTIONKIND   := 1;
          nptxobj.T_DATE           := one_rec.t_Date;   
          nptxobj.T_CLIENT         := pClient;
          nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
          nptxobj.T_LEVEL          := 2;
          nptxobj.T_KIND           := RSI_NPTXC.TXOBJ_PROCSEC_Link;                              
          nptxobj.T_SUM            := v_Sum;                                                 
          nptxobj.T_CUR            := RSI_RSB_FIInstr.NATCUR;                                
          nptxobj.T_ANALITICKIND1  := one_rec.S_AnaliticKind1;                           
          nptxobj.T_ANALITIC1      := one_rec.S_Analitic1;                                   
          nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2010;                    
          nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
          nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
          nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
          nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
          nptxobj.T_ANALITIC4      := v_Circulate;                                     
          nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
          nptxobj.T_ANALITIC5      := one_rec.TaxGroup;                                      
          nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
          nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
          nptxobj.T_COMMENT        := 'Процентный расход по ц/б';      
          nptxobj.T_DOCID          := pDocID;
          nptxobj.T_STEP           := pStep; 
          nptxobj.T_TECHNICAL      := CHR(0);

          nptxobj_ins.extend;
          nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
        END IF;

        IF nptxobj_ins.COUNT >= g_Limit THEN
          FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
               INSERT INTO DNPTXOBJ_TMP
                    VALUES nptxobj_ins(indx);

          nptxobj_ins.Delete;                                    
          nptxobj_ins := nptxobj_t();
        END IF;

      END LOOP;

    END IF;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;


  --Расчет объектов НДР по остаткам
  PROCEDURE CreateTaxObjects2_20(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_Dir         NUMBER;
    v_Kind        NUMBER;
    v_Sum         NUMBER;
    v_Sum_0       NUMBER;
    v_SumAmount_0 NUMBER;
    v_Comment     DNPTXOBJ_TMP.T_COMMENT%TYPE;
                    
  BEGIN
  
    pStat := 0;

    FOR one_rec IN (SELECT N.t_Date, N.t_Cur, N.t_Kind, N.t_Sum, N.t_Analitic5, N.t_Analitic6, 
                           T.t_ID, T.t_FIID, T.t_Amount TAmount, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, 
                           TO_NUMBER(DRW.t_Number_Partly) Number_Partly, DRWL.t_Principal, 
                           DRW.t_DealType, DRW.t_BOfficeKind, DRW.t_Flag1, DRW.t_Flag4, DRW.t_DealDate DrawingDate, 
                           DRW.t_DealDate AS DRWDealDate, 
                           (CASE WHEN LB.T_GOID > 0 THEN NVL((SELECT (CASE WHEN comm.t_CorpActionDate = g_ZeroDate THEN LB.t_DealDate ELSE comm.t_CorpActionDate END)
                                                                 FROM dnptxgo_dbt go, ddl_comm_dbt comm
                                                                WHERE go.t_ID = LB.T_GOID
                                                                  AND comm.t_DocKind = go.t_DocKind
                                                                  AND comm.t_DocumentID = go.t_DocumentID
                                                              ), LB.t_DealDate)
                                 ELSE LB.t_DealDate END) as LBDealDate,
                           (SELECT rsb_secur.get_OperationGroup(t_SysTypes) FROM doprkoper_dbt WHERE t_Kind_Operation = DRW.t_DealType) oGrp
                      FROM dnptxobj_dbt N, v_npx_dnptxlot LB, dnptxts_dbt T, ddl_tick_dbt DRW, ddl_leg_dbt DRWL 
                     WHERE N.t_Client = pClient
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_Kind IN (RSI_NPTXC.TXOBJ_MAIN, 
                                        RSI_NPTXC.TXOBJ_COM
                                       ) 
                       AND DRW.t_DealDate >= pBegDate 
                       AND DRW.t_DealDate <= pEndDate 
                       AND N.t_AnaliticKind1 = RSI_NPTXC.TXOBJ_KIND1020
                       AND N.t_Analitic1     = DRW.t_DealID 
                       AND T.t_BuyID         = LB.t_ID 
                       AND T.t_Type          = RSI_NPTXC.NPTXTS_REST
                       AND T.t_Client        = pClient
                       AND RSI_NPTO.CheckContrIIS(T.t_Contract) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (T.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND T.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE T.t_FIID END)
                       AND T.t_Amount           > 0 
                       AND DRW.t_BOfficeKind    = RSB_SECUR.DL_RETIREMENT
                       AND DRW.t_Number_Partly <> CHR(1) 
                       AND DRWL.t_PFI           = T.t_FIID 
                       AND DRW.t_ClientID       = pClient
                       AND RSI_NPTO.CheckContrIIS(DRW.t_ClientContrID) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (DRW.t_ClientContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND DRWL.t_DealID  = DRW.t_DealID 
                       AND DRWL.t_LegID   = 0 
                       AND DRWL.t_LegKind = 0 
                       AND T.t_BegDate    < DRW.t_DealDate 
                       AND (T.t_EndDate >= DRW.t_DealDate OR T.t_EndDate = g_ZeroDate)                                                                        
                   )
    LOOP

      v_SumAmount_0 := RSI_NPTX.GetPrivAmountByTS(one_rec.t_ID, pEndDate, one_rec.DrawingDate);

      v_Sum   := one_rec.t_Sum * (one_rec.TAmount - v_SumAmount_0) / one_rec.t_Principal;
      v_Sum_0 := one_rec.t_Sum * v_SumAmount_0 / one_rec.t_Principal;

      v_Sum   := ROUND(v_Sum, 2);
      v_Sum_0 := ROUND(v_Sum_0, 2);

      IF((v_Sum != 0) AND (RSB_SECUR.IsRet_Issue(one_rec.oGrp) = 0)) THEN
        IF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_MAIN) THEN
          v_Dir     := RSI_NPTXC.TXOBJ_DIR_IN;
          v_Kind    := RSI_NPTXC.TXOBJ_MAINS_TS;
          v_Comment := 'Выручка от реализации (основная сумма)';
        ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_COM) THEN
          v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
          v_Kind    := RSI_NPTXC.TXOBJ_COMS_TS;
          v_Comment := 'Затраты на оплату комиссий при продаже';
        END IF;

        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.DRWDealDate, one_rec.LBDealDate);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_Date;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := one_rec.t_Cur;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1060;                           
        nptxobj.T_ANALITIC1      := one_rec.Number_Partly;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2020;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Analitic6;                                            
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;


      IF((v_Sum_0 != 0) and (RSB_SECUR.IsRet_Issue(one_rec.oGrp) != 0)) THEN

        IF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_MAIN) THEN
          v_Dir     := RSI_NPTXC.TXOBJ_DIR_IN;
          v_Kind    := RSI_NPTXC.TXOBJ_MAINS_TS_0;
          v_Comment := 'Выручка от реализации - основная сумма по сделке для учета выплат от эмитента по льготным ц/б';
        ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_COM) THEN
          v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
          v_Kind    := RSI_NPTXC.TXOBJ_COMS_TS_0;
          v_Comment := 'Затраты на оплату комиссий при продаже для учета выплат от эмитента по льготным ц/б';
        END IF;

        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.DRWDealDate, one_rec.LBDealDate);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_Date;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;                              
        nptxobj.T_SUM            := v_Sum_0;                                                 
        nptxobj.T_CUR            := one_rec.t_Cur;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1060;                           
        nptxobj.T_ANALITIC1      := one_rec.Number_Partly;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2020;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Analitic6;                                            
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по остаткам
  PROCEDURE CreateTaxObjects2_21(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_Dir         NUMBER;
    v_Kind        NUMBER;
    v_Sum         NUMBER;
    v_Comment     DNPTXOBJ_TMP.T_COMMENT%TYPE;
                    
  BEGIN
  
    pStat := 0;

    FOR one_rec IN (SELECt N.t_Date, N.t_Cur, N.t_Kind, N.t_Sum, N.t_Analitic5, N.t_Analitic6, 
                          T.t_ID, T.t_FIID, T.t_Amount TAmount, 
                          LB.t_BuyDate, LB.t_Amount LBAmount, 
                          TO_NUMBER(DRW.t_Number_Coupon) Number_Coupon, DRWL.t_Principal, 
                          DRW.t_DealType, DRW.t_BOfficeKind, DRW.t_Flag1, DRW.t_Flag4, 
                          DRW.t_DealDate AS DRWDealDate, 
                          (CASE WHEN LB.T_GOID > 0 THEN NVL((SELECT (CASE WHEN comm.t_CorpActionDate = g_ZeroDate THEN LB.t_DealDate ELSE comm.t_CorpActionDate END)
                                                                 FROM dnptxgo_dbt go, ddl_comm_dbt comm
                                                                WHERE go.t_ID = LB.T_GOID
                                                                  AND comm.t_DocKind = go.t_DocKind
                                                                  AND comm.t_DocumentID = go.t_DocumentID
                                                              ), LB.t_DealDate)
                                 ELSE LB.t_DealDate END) as LBDealDate,
                          (SELECT RSB_SECUR.get_OperationGroup(t_SysTypes) FROM doprkoper_dbt WHERE t_Kind_Operation = DRW.t_DealType) oGrp
                     FROM dnptxobj_dbt N, v_npx_dnptxlot LB, dnptxts_dbt T, ddl_tick_dbt DRW, ddl_leg_dbt DRWL 
                    WHERE N.t_Client = pClient
                      AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                      AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                      AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                      AND N.t_Kind = RSI_NPTXC.TXOBJ_COM
                      AND DRW.t_DealDate >= pBegDate
                      AND DRW.t_DealDate <= pEndDate
                      AND N.t_AnaliticKind1 = RSI_NPTXC.TXOBJ_KIND1020
                      AND N.t_Analitic1     = DRW.t_DealID 
                      AND T.t_BuyID         = LB.t_ID 
                      AND T.t_Type          = RSI_NPTXC.NPTXTS_REST
                      AND T.t_Client        = pClient
                      AND RSI_NPTO.CheckContrIIS(T.t_Contract) = pIIS
                      AND ((pContract IS NULL) OR (pContract <= 0) OR (T.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                      AND T.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE T.t_FIID END)
                      AND T.t_Amount > 0 
                      AND DRW.t_BOfficeKind = RSB_SECUR.DL_RETIREMENT
                      AND DRW.t_Number_Coupon <> CHR(1)
                      AND DRW.t_Number_Partly = CHR(1) 
                      AND DRWL.t_PFI          = T.t_FIID 
                      AND DRW.t_ClientID      = pClient
                      AND RSI_NPTO.CheckContrIIS(DRW.t_ClientContrID) = pIIS
                      AND ((pContract IS NULL) OR (pContract <= 0) OR (DRW.t_ClientContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                      AND DRWL.t_DealID  = DRW.t_DealID 
                      AND DRWL.t_LegID   = 0 
                      AND DRWL.t_LegKind = 0 
                      AND T.t_BegDate < DRW.t_DealDate 
                      AND (T.t_EndDate >= DRW.t_DealDate OR T.t_EndDate = g_ZeroDate )                                                                        
                   )
    LOOP

      v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
      v_Kind    := RSI_NPTXC.TXOBJ_COMS_TS;
      v_Comment := 'Затраты на оплату комиссий при продаже';

      v_Sum := one_rec.t_Sum * one_rec.TAmount / one_rec.t_Principal;

      v_Sum := ROUND(v_Sum, 2);

      IF((v_Sum != 0) AND (RSB_SECUR.IsRet_Issue(one_rec.oGrp) = 0)) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.DRWDealDate, one_rec.LBDealDate);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_Date;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;                              
        nptxobj.T_SUM            := ROUND(v_Sum, 2);                                                 
        nptxobj.T_CUR            := one_rec.t_Cur;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1050;                           
        nptxobj.T_ANALITIC1      := one_rec.Number_Coupon;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2020;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Analitic6;                                            
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по остаткам
  PROCEDURE CreateTaxObjects2_22(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_Dir         NUMBER;
    v_Kind        NUMBER;
    v_Sum         NUMBER;
    v_Comment     DNPTXOBJ_TMP.T_COMMENT%TYPE;
                    
  BEGIN
  
    pStat := 0;

    FOR one_rec IN (SELECt N.t_Date, N.t_Cur, N.t_Kind, N.t_Sum, N.t_Analitic5, N.t_Analitic6, 
                          T.t_ID, T.t_FIID, T.t_Amount TAmount, 
                          LB.t_BuyDate, LB.t_Amount LBAmount, 
                          TO_NUMBER(DRW.t_Number_Coupon) Number_Coupon, DRWL.t_Principal, 
                          DRW.t_DealType, DRW.t_BOfficeKind, DRW.t_Flag1, DRW.t_Flag4, 
                          DRW.t_DealDate AS DRWDealDate, 
                          (CASE WHEN LB.T_GOID > 0 THEN NVL((SELECT (CASE WHEN comm.t_CorpActionDate = g_ZeroDate THEN LB.t_DealDate ELSE comm.t_CorpActionDate END)
                                                                 FROM dnptxgo_dbt go, ddl_comm_dbt comm
                                                                WHERE go.t_ID = LB.T_GOID
                                                                  AND comm.t_DocKind = go.t_DocKind
                                                                  AND comm.t_DocumentID = go.t_DocumentID
                                                              ), LB.t_DealDate)
                                 ELSE LB.t_DealDate END) as LBDealDate,
                          (SELECT RSB_SECUR.get_OperationGroup(t_SysTypes) FROM doprkoper_dbt WHERE t_Kind_Operation = DRW.t_DealType) oGrp
                     FROM dnptxobj_dbt N, v_npx_dnptxlot LB, dnptxts_dbt T, ddl_tick_dbt DRW, ddl_leg_dbt DRWL 
                    WHERE N.t_Client = pClient
                      AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                      AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                      AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                      AND N.t_Kind = RSI_NPTXC.TXOBJ_NKD
                      AND DRW.t_DealDate >= pBegDate
                      AND DRW.t_DealDate <= pEndDate
                      AND N.t_AnaliticKind1 = RSI_NPTXC.TXOBJ_KIND1020
                      AND N.t_Analitic1     = DRW.t_DealID 
                      AND T.t_BuyID         = LB.t_ID 
                      AND T.t_Type          = RSI_NPTXC.NPTXTS_REST
                      AND T.t_Client        = pClient
                      AND RSI_NPTO.CheckContrIIS(T.t_Contract) = pIIS
                      AND ((pContract IS NULL) OR (pContract <= 0) OR (T.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                      AND T.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE T.t_FIID END)
                      AND T.t_Amount > 0 
                      AND DRW.t_BOfficeKind = RSB_SECUR.DL_RETIREMENT
                      AND DRW.t_Number_Coupon <> CHR(1)
                      AND DRWL.t_PFI          = T.t_FIID 
                      AND DRW.t_ClientID      = pClient
                      AND RSI_NPTO.CheckContrIIS(DRW.t_ClientContrID) = pIIS
                      AND ((pContract IS NULL) OR (pContract <= 0) OR (DRW.t_ClientContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                      AND DRWL.t_DealID  = DRW.t_DealID 
                      AND DRWL.t_LegID   = 0 
                      AND DRWL.t_LegKind = 0 
                      AND T.t_BegDate < DRW.t_DealDate 
                      AND (T.t_EndDate >= DRW.t_DealDate OR T.t_EndDate = g_ZeroDate )                                                                        
                   )
    LOOP

      v_Dir     := RSI_NPTXC.TXOBJ_DIR_IN;
      v_Kind    := RSI_NPTXC.TXOBJ_NKDS_TS;
      v_Comment := 'Выручка от полученного НКД';

      v_Sum := one_rec.t_Sum * one_rec.TAmount / one_rec.t_Principal;

      v_Sum := ROUND(v_Sum, 2);

      IF((v_Sum != 0) AND (RSB_SECUR.IsRet_Issue(one_rec.oGrp) = 0)) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.DRWDealDate, one_rec.LBDealDate);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_Date;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;                              
        nptxobj.T_SUM            := ROUND(v_Sum, 2);                                                 
        nptxobj.T_CUR            := one_rec.t_Cur;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1050;                           
        nptxobj.T_ANALITIC1      := one_rec.Number_Coupon;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2020;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Analitic6;                                            
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по остаткам
  PROCEDURE CreateTaxObjects2_23(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_Dir         NUMBER;
    v_Kind        NUMBER;
    v_Sum         NUMBER;
    v_Comment     DNPTXOBJ_TMP.T_COMMENT%TYPE;
                    
  BEGIN
  
    pStat := 0;

    FOR one_rec IN (SELECT N.t_Date, N.t_Cur, N.t_Kind, N.t_Sum, N.t_Sum0, N.t_Analitic5, N.t_Analitic6, 
                           T.t_ID, T.t_FIID, T.t_Amount TAmount, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, LB.t_AnaliticKind1 B_AnaliticKind1, LB.t_Analitic1 B_Analitic1, 
                           to_number(DRW.t_Number_Coupon) Number_Coupon, DRW.t_DealDate, DRWL.t_Principal, 
                           DRW.t_DealType, DRW.t_BOfficeKind, DRW.t_Flag1, DRW.t_Flag4, 
                           DRW.t_DealDate AS DRWDealDate, 
                           (CASE WHEN LB.T_GOID > 0 THEN NVL((SELECT (CASE WHEN comm.t_CorpActionDate = g_ZeroDate THEN LB.t_DealDate ELSE comm.t_CorpActionDate END)
                                                                 FROM dnptxgo_dbt go, ddl_comm_dbt comm
                                                                WHERE go.t_ID = LB.T_GOID
                                                                  AND comm.t_DocKind = go.t_DocKind
                                                                  AND comm.t_DocumentID = go.t_DocumentID
                                                              ), LB.t_DealDate)
                                 ELSE LB.t_DealDate END) as LBDealDate,
                           (SELECT RSB_SECUR.get_OperationGroup(t_SysTypes) FROM doprkoper_dbt WHERE t_Kind_Operation = DRW.t_DealType) oGrp
                      FROM dnptxobj_dbt N, v_npx_dnptxlot LB, dnptxts_dbt T, ddl_tick_dbt DRW, ddl_leg_dbt DRWL 
                     WHERE N.t_Client = pClient
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_Kind          = RSI_NPTXC.TXOBJ_NKD
                       AND DRW.t_DealDate   >= pBegDate
                       AND DRW.t_DealDate   <= pEndDate
                       AND N.t_AnaliticKind1 = RSI_NPTXC.TXOBJ_KIND1020
                       AND N.t_Analitic1     = DRW.t_DealID 
                       AND T.t_BuyID         = LB.t_ID 
                       AND T.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE T.t_FIID END)
                       AND LB.t_Kind  = RSI_NPTXC.NPTXLOTS_BUY
                       AND T.t_Type   = RSI_NPTXC.NPTXTS_REST
                       AND T.t_Client = pClient
                       AND RSI_NPTO.CheckContrIIS(T.t_Contract) = pIIS 
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (T.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND T.t_Amount > 0 
                       AND DRW.t_BOfficeKind    = RSB_SECUR.DL_RETIREMENT
                       AND DRW.t_Number_Coupon <> CHR(1) 
                       AND DRWL.t_PFI           = T.t_FIID 
                       AND DRW.t_ClientID       = pClient
                       AND RSI_NPTO.CheckContrIIS(DRW.t_ClientContrID) = pIIS 
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (DRW.t_ClientContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND DRWL.t_DealID        = DRW.t_DealID 
                       AND DRWL.t_LegID         = 0 
                       AND DRWL.t_LegKind       = 0 
                       AND T.t_BegDate < DRW.t_DealDate 
                       AND (T.t_EndDate >= DRW.t_DealDate OR T.t_EndDate = g_ZeroDate )                                                                        
                   )
    LOOP

      v_Dir     := RSI_NPTXC.TXOBJ_DIR_IN;
      v_Kind    := RSI_NPTXC.TXOBJ_PROCSEC_TS;
      v_Comment := 'Процентный доход по ц/б';

      v_Sum := one_rec.t_Sum0 * one_rec.TAmount / one_rec.t_Principal;

      v_Sum := ROUND(v_Sum, 2);

      IF((v_Sum != 0) AND (RSB_SECUR.IsRet_Issue(one_rec.oGrp) = 0)) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.DRWDealDate, one_rec.LBDealDate);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_DealDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;                              
        nptxobj.T_SUM            := ROUND(v_Sum, 2);                                                 
        nptxobj.T_CUR            := RSI_RSB_FIINSTR.NATCUR;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1050;                           
        nptxobj.T_ANALITIC1      := one_rec.Number_Coupon;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2020;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Analitic6;                                            
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по остаткам
  PROCEDURE CreateTaxObjects2_24(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_Dir         NUMBER;
    v_Kind        NUMBER;
    v_Sum         NUMBER;
    v_Comment     DNPTXOBJ_TMP.T_COMMENT%TYPE;
                    
  BEGIN
  
    pStat := 0;

    FOR one_rec IN (SELECT N.t_Date, N.t_Cur, N.t_Kind, N.t_Sum0, N.t_Analitic5, N.t_Analitic6, 
                           T.t_ID, T.t_FIID, T.t_Amount TAmount, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, 
                           DRWL.t_Cost, DRWL.t_Principal, 
                           (SELECT t_DrawingDate 
                              FROM dfiwarnts_dbt 
                             WHERE t_FIID = T.t_FIID 
                               AND t_IsPartial = 'X' 
                               AND t_Number = DRW.t_Number_Partly) DrawingDate,  
                           to_number(DRW.t_Number_Partly) Number_Partly, 
                           DRW.t_DealType, DRW.t_BOfficeKind, DRW.t_Flag1, DRW.t_Flag4, 
                           DRW.t_DealDate AS DRWDealDate, 
                           (CASE WHEN LB.T_GOID > 0 THEN NVL((SELECT (CASE WHEN comm.t_CorpActionDate = g_ZeroDate THEN LB.t_DealDate ELSE comm.t_CorpActionDate END)
                                                                 FROM dnptxgo_dbt go, ddl_comm_dbt comm
                                                                WHERE go.t_ID = LB.T_GOID
                                                                  AND comm.t_DocKind = go.t_DocKind
                                                                  AND comm.t_DocumentID = go.t_DocumentID
                                                              ), LB.t_DealDate)
                                 ELSE LB.t_DealDate END) as LBDealDate,
                           (SELECT RSB_SECUR.get_OperationGroup(t_SysTypes) FROM doprkoper_dbt WHERE t_Kind_Operation = DRW.t_DealType) oGrp
                      FROM dnptxobj_dbt N, v_npx_dnptxlot LB, dnptxts_dbt T, ddl_tick_dbt DRW, ddl_leg_dbt DRWL 
                     WHERE N.t_Client = pClient
                       AND RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_Kind IN (RSI_NPTXC.TXOBJ_MAIN, RSI_NPTXC.TXOBJ_COM)
                       AND DRW.t_DealDate   <= pBegDate 
                       AND DRW.t_DealDate   >= pEndDate
                       AND N.t_AnaliticKind1 = LB.t_AnaliticKind1 
                       AND N.t_Analitic1     = LB.t_Analitic1 
                       AND LB.t_Kind         = RSI_NPTXC.NPTXLOTS_BUY
                       AND T.t_BuyID         = LB.t_ID 
                       AND T.t_FIID          = (CASE WHEN pFIID != -1 THEN pFIID ELSE T.t_FIID END)
                       AND T.t_Type          = RSI_NPTXC.NPTXTS_REST
                       AND T.t_Client        = pClient
                       AND RSI_NPTO.CheckContrIIS(T.t_Contract) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (T.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND T.t_Amount           > 0 
                       AND DRW.t_BOfficeKind    = RSB_SECUR.DL_RETIREMENT
                       AND DRW.t_Number_Partly <> CHR(1) 
                       AND DRWL.t_PFI           = T.t_FIID 
                       AND DRW.t_ClientID       = pClient
                       AND RSI_NPTO.CheckContrIIS(DRW.t_ClientContrID) = pIIS  
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (DRW.t_ClientContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND DRWL.t_DealID  = DRW.t_DealID 
                       AND DRWL.t_LegID   = 0 
                       AND DRWL.t_LegKind = 0 
                       AND T.t_BegDate < DRW.t_DealDate 
                       AND (T.t_EndDate >= DRW.t_DealDate OR T.t_EndDate = g_ZeroDate)                                                                         
                   )
    LOOP

      IF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_MAIN) THEN
        v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
        v_Kind    := RSI_NPTXC.TXOBJ_MAINB_TS_0;
        v_Comment := 'Затраты на приобретение льготных ц/б (основная сумма) для учета выплат от эмитента';
      ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_COM) THEN
        v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
        v_Kind    := RSI_NPTXC.TXOBJ_COMB_TS_0;
        v_Comment := 'Затраты на оплату комиссий при покупке льготных ц/б для учета выплат от эмитента';
      END IF;

      v_Sum := one_rec.t_Sum0 * one_rec.t_Cost / one_rec.t_Principal * RSI_NPTX.GetPrivAmountByTS(one_rec.t_ID, pEndDate, one_rec.DrawingDate) / 
                               (GetFaceValue_Ex(one_rec.t_FIID, one_rec.t_BuyDate) * one_rec.LBAmount);

      v_Sum := ROUND(v_Sum, 2);

      IF((v_Sum != 0) AND (RSB_SECUR.IsRet_Issue(one_rec.oGrp) != 0)) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.DRWDealDate, one_rec.LBDealDate);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.DrawingDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := RSI_RSB_FIINSTR.NATCUR;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1060;                           
        nptxobj.T_ANALITIC1      := one_rec.Number_Partly;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2020;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Analitic6;                                            
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по размещенным ц/б
  PROCEDURE CreateTaxObjects2_25(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_Dir     NUMBER;
    v_Kind    NUMBER;
    v_Sum     NUMBER;
    v_Comment DNPTXOBJ_TMP.T_COMMENT%TYPE;
    v_K       NUMBER;
                    
  BEGIN
  
    pStat := 0;

    FOR one_rec IN (SELECT N.t_Date, N.t_Cur, N.t_Kind, N.t_Sum0, N.t_Analitic5, N.t_Analitic6, 
                           T.t_ID, T.t_FIID, T.t_Amount TAmount, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, LB.t_PriceFIID LBPriceFIID, 
                           LS.t_SaleDate SDate, 
                           NVL(rsb_fiinstr.FI_GetNominalOnDate(Fin.t_FIID, LS.t_SaleDate ), 0.0) NominalAVROnSelDateLink, 
                           NVL(rsb_fiinstr.FI_GetNominalOnDate(Fin.t_FIID, LB.t_BuyDate ), 0.0) NominalAVROnBuyDateLink, 
                           NVL(rsb_fiinstr.ConvSum(1, fin.t_FaceValueFI, RSI_RSB_FIINSTR.NATCUR, LS.t_saleDate ), 0.0) LSCourseNominal, 
                           NVL(rsb_fiinstr.ConvSum(1, fin.t_FaceValueFI, RSI_RSB_FIINSTR.NATCUR, LB.t_buyDate ), 0.0) LBCourseNominal, 
                           NVL(rsb_fiinstr.ConvSum(1, LB.t_PriceFIID, RSI_RSB_FIINSTR.NATCUR, LS.t_saleDate ), 0.0) LB_Course_PriseFIID, 
                           DRW.t_DrawingDate, to_number(DRW.t_Number) NumberDRW, DRW.t_IncomeRate, DRW.t_IncomeScale, 
                           Fin.t_FaceValueFI, Fin.t_FaceValue, fin.t_FI_Kind, fin.t_AvoirKind, 
                           DRW.t_DrawingDate AS DRWDrawingDate, 
                           (CASE WHEN LB.T_GOID > 0 THEN NVL((SELECT (CASE WHEN comm.t_CorpActionDate = g_ZeroDate THEN LB.t_DealDate ELSE comm.t_CorpActionDate END)
                                                                 FROM dnptxgo_dbt go, ddl_comm_dbt comm
                                                                WHERE go.t_ID = LB.T_GOID
                                                                  AND comm.t_DocKind = go.t_DocKind
                                                                  AND comm.t_DocumentID = go.t_DocumentID
                                                              ), LB.t_DealDate)
                                 ELSE LB.t_DealDate END) as LBDealDate
                      FROM dnptxobj_dbt N, v_npx_dnptxlot LB,  v_npx_dnptxlot LS, dnptxts_dbt T, dfiwarnts_dbt DRW, dfininstr_dbt Fin 
                     WHERE N.t_Client = pClient
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6 ) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_Kind IN (RSI_NPTXC.TXOBJ_MAIN,
                                        RSI_NPTXC.TXOBJ_COM,
                                        RSI_NPTXC.TXOBJ_NKD,
                                        RSI_NPTXC.TXOBJ_DIF,
                                        RSI_NPTXC.TXOBJ_MATERIAL
                                       ) 
                       AND DRW.t_DrawingDate <= pBegDate 
                       AND DRW.t_DrawingDate >= pEndDate
                       AND N.t_AnaliticKind1 = LB.t_AnaliticKind1 
                       AND N.t_Analitic1     = LB.t_Analitic1 
                       AND LB.t_Kind IN (RSI_NPTXC.NPTXLOTS_BUY,
                                         RSI_NPTXC.NPTXLOTS_BACKREPO,
                                         RSI_NPTXC.NPTXLOTS_LOANGET
                                        ) 
                       AND T.t_BuyID   = LB.t_ID 
                       AND T.t_SaleID  = LS.t_ID 
                       AND T.t_Type    = RSI_NPTXC.NPTXTS_INVST
                       AND T.t_FIID    = (CASE WHEN pFIID != -1 THEN pFIID ELSE T.t_FIID END)
                       AND T.t_Client  = pClient
                       AND RSI_NPTO.CheckContrIIS(T.t_Contract) = pIIS   
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (T.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))                       
                       AND T.t_Amount > 0 
                       AND RSB_FIInstr.FI_AvrKindsGetRoot( Fin.t_FI_Kind, Fin.t_AvoirKind ) = RSI_RSB_FIInstr.AVOIRKIND_BOND
                       AND DRW.t_IsPartial = 'X' 
                       AND DRW.t_FIID = T.t_FIID 
                       AND Fin.t_FIID = T.t_FIID 
                       AND T.t_BegDate < DRW.t_DrawingDate 
                       AND (T.t_EndDate >= DRW.t_DrawingDate OR T.t_EndDate = g_ZeroDate)
                   )
    LOOP

      IF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_MAIN) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_MAINB_TS;
        v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
        v_Comment := 'Затраты на приобретение (основная сумма)';
      ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_COM) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_COMB_TS;
        v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
        v_Comment := 'Затраты на оплату комиссий при покупке';
      ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_DIF) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_DIFB_TS;
        v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
        v_Comment := 'Корректировка затрат по рыночной цене по сделке';
      ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_NKD) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_NKDB_TS;
        v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
        v_Comment := 'Затраты на оплату НКД для учета выплат от эмитента';
      ELSIF(one_rec.t_Kind = RSI_NPTXC.TXOBJ_MATERIAL) THEN
        v_Kind    := RSI_NPTXC.TXOBJ_MATERIALB_TS;
        v_Dir     := RSI_NPTXC.TXOBJ_DIR_OUT;
        v_Comment := 'Сумма мат. выгоды';
      END IF;

      IF(((v_Kind = RSI_NPTXC.TXOBJ_MAINB_TS) OR (v_Kind = RSI_NPTXC.TXOBJ_COMB_TS) OR (v_Kind = RSI_NPTXC.TXOBJ_NKDB_TS) )
            AND
             ((one_rec.t_FI_Kind = RSI_RSB_FIINSTR.FIKIND_AVOIRISS) AND (one_rec.t_AvoirKind = RSI_RSB_FIINSTR.AVOIRKIND_BOND_OVVZ) and (one_rec.SDate >= TO_DATE('01.01.2019','DD.MM.YYYY')))
         ) THEN
        v_K := 0.0;
        IF( one_rec.t_Cur = RSI_RSB_FIINSTR.NATCUR ) THEN
          v_K := one_rec.LSCourseNominal / one_rec.LBCourseNominal;
        ELSE
          v_K := (CASE WHEN v_Kind = RSI_NPTXC.TXOBJ_NKDB_TS THEN one_rec.LSCourseNominal ELSE one_rec.LB_Course_PriseFIID END);
        END IF;
        /*( Сумма НДР 1 ур. из поля <сумма в валюте> * Номинал ц/б на дату связи            * количество в связи     / (количество в сделке * Номинал на дату покупки из связи) )*  K  */
        v_Sum := (one_rec.t_Sum0 * one_rec.NominalAVROnSelDateLink * one_rec.TAmount / (one_rec.LBAmount * one_rec.NominalAVROnBuyDateLink ) )* v_K; 
      ELSE         
        v_Sum := one_rec.t_Sum0 * one_rec.TAmount * one_rec.t_FaceValue * one_rec.t_IncomeRate/GREATEST(1, one_rec.t_IncomeScale)/100.0 / 
                           (GetFaceValue_Ex(one_rec.t_FIID, one_rec.t_BuyDate) * one_rec.LBAmount);
      END IF;
                                   
      v_Sum := ROUND(v_Sum, 2);

      IF(v_Sum != 0) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.DRWDrawingDate, one_rec.LBDealDate);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_DrawingDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := RSI_RSB_FIINSTR.NATCUR;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1060;                           
        nptxobj.T_ANALITIC1      := one_rec.NumberDRW;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2020;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Analitic6;                                            
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по размещенным ц/б
  PROCEDURE CreateTaxObjects2_26(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_Dir     NUMBER;
    v_Kind    NUMBER;
    v_Sum     NUMBER;
    v_Comment DNPTXOBJ_TMP.T_COMMENT%TYPE;
    v_K       NUMBER;
                    
  BEGIN
  
    pStat := 0;

    FOR one_rec IN (SELECT T.t_ID, T.t_FIID, T.t_Amount TAmount, T.t_Contract, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, 
                           DRW.t_DrawingDate, TO_NUMBER(DRW.t_Number) NumberDRW, DRW.t_IncomeRate, DRW.t_IncomeScale, 
                           Fin.t_FaceValueFI, Fin.t_FaceValue, 
                           npto.GetPaperTaxGroupNPTX( T.t_FIID ) TaxGroup, 
                           DRW.t_DrawingDate AS DRWDrawingDate, 
                           (CASE WHEN LB.T_GOID > 0 THEN NVL((SELECT (CASE WHEN comm.t_CorpActionDate = g_ZeroDate THEN LB.t_DealDate ELSE comm.t_CorpActionDate END)
                                                                 FROM dnptxgo_dbt go, ddl_comm_dbt comm
                                                                WHERE go.t_ID = LB.T_GOID
                                                                  AND comm.t_DocKind = go.t_DocKind
                                                                  AND comm.t_DocumentID = go.t_DocumentID
                                                              ), LB.t_DealDate)
                                 ELSE LB.t_DealDate END) as LBDealDate
                      FROM v_npx_dnptxlot LB, dnptxts_dbt T, dfiwarnts_dbt DRW, dfininstr_dbt Fin 
                     WHERE T.t_Client = pClient
                       AND RSI_NPTO.CheckContrIIS(T.t_Contract) = pIIS 
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (T.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))                          
                       AND DRW.t_DrawingDate >= pBegDate 
                       AND DRW.t_DrawingDate <= pEndDate 
                       AND T.t_BuyID          = LB.t_ID 
                       AND T.t_Type           = RSI_NPTXC.NPTXTS_INVST
                       AND T.t_Amount         > 0 
                       AND T.t_FIID           = (CASE WHEN pFIID != -1 THEN pFIID ELSE T.t_FIID END)
                       AND RSB_FIInstr.FI_AvrKindsGetRoot( Fin.t_FI_Kind, Fin.t_AvoirKind ) = RSI_RSB_FIInstr.AVOIRKIND_BOND
                       AND DRW.t_IsPartial = 'X' 
                       AND DRW.t_FIID = T.t_FIID 
                       AND Fin.t_FIID = T.t_FIID 
                       AND T.t_BegDate < DRW.t_DrawingDate 
                       AND (T.t_EndDate >= DRW.t_DrawingDate OR T.t_EndDate = g_ZeroDate )                                                                         
                   )
    LOOP

      v_Dir     := RSI_NPTXC.TXOBJ_DIR_IN;
      v_Kind    := RSI_NPTXC.TXOBJ_MAINS_TS;
      v_Comment := 'Частичные погашения по размещенным ц/б';

      v_Sum := one_rec.t_FaceValue * one_rec.t_IncomeRate/GREATEST(1, one_rec.t_IncomeScale)/100.0 * one_rec.TAmount;
                                   
      v_Sum := ROUND(v_Sum, 2);

      IF(v_Sum != 0) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.DRWDrawingDate, one_rec.LBDealDate);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_DrawingDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := one_Rec.t_FaceValueFI;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1060;                           
        nptxobj.T_ANALITIC1      := one_rec.NumberDRW;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2020;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по размещенным ц/б
  PROCEDURE CreateTaxObjects2_27(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_Dir     NUMBER;
    v_Kind    NUMBER;
    v_Sum     NUMBER;
    v_Comment DNPTXOBJ_TMP.T_COMMENT%TYPE;
    v_K       NUMBER;
                    
  BEGIN
  
    pStat := 0;

    FOR one_rec IN (SELECT T.t_ID, T.t_FIID, T.t_Amount TAmount, T.t_Contract, 
                           LB.t_BuyDate, LB.t_Amount LBAmount, 
                           DRW.t_DrawingDate, TO_NUMBER(DRW.t_Number) NumberDRW, 
                           Fin.t_FaceValueFI, 
                           npto.GetPaperTaxGroupNPTX( T.t_FIID ) TaxGroup, 
                           DRW.t_DrawingDate AS DRWDrawingDate, 
                           (CASE WHEN LB.T_GOID > 0 THEN NVL((SELECT (CASE WHEN comm.t_CorpActionDate = g_ZeroDate THEN LB.t_DealDate ELSE comm.t_CorpActionDate END)
                                                                 FROM dnptxgo_dbt go, ddl_comm_dbt comm
                                                                WHERE go.t_ID = LB.T_GOID
                                                                  AND comm.t_DocKind = go.t_DocKind
                                                                  AND comm.t_DocumentID = go.t_DocumentID
                                                              ), LB.t_DealDate)
                                 ELSE LB.t_DealDate END) as LBDealDate
                      FROM v_npx_dnptxlot LB, dnptxts_dbt T, dfiwarnts_dbt DRW, dfininstr_dbt Fin 
                     WHERE T.t_Client = pClient
                       AND RSI_NPTO.CheckContrIIS(T.t_Contract) = pIIS 
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (T.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))                      
                       AND DRW.t_DrawingDate >= pBegDate 
                       AND DRW.t_DrawingDate <= pEndDate 
                       AND T.t_BuyID          = LB.t_ID 
                       AND T.t_Type           = RSI_NPTXC.NPTXTS_INVST
                       AND T.t_Amount         > 0 
                       AND T.t_FIID           = (CASE WHEN pFIID != -1 THEN pFIID ELSE T.t_FIID END)
                       AND RSB_FIInstr.FI_AvrKindsGetRoot( Fin.t_FI_Kind, Fin.t_AvoirKind ) = RSI_RSB_FIInstr.AVOIRKIND_BOND
                       AND DRW.t_IsPartial != 'X' 
                       AND DRW.t_FIID = T.t_FIID 
                       AND Fin.t_FIID = T.t_FIID 
                       AND T.t_BegDate < DRW.t_DrawingDate 
                       AND (T.t_EndDate >= DRW.t_DrawingDate OR T.t_EndDate = g_ZeroDate )                                                                         
                   )
    LOOP

      v_Dir     := RSI_NPTXC.TXOBJ_DIR_IN;
      v_Kind    := RSI_NPTXC.TXOBJ_NKDS_TS;
      v_Comment := 'Купоны по размещенным ц/б';

      v_Sum := RSI_RSB_FIINSTR.CalcNKD(one_rec.t_FIID, one_rec.t_DrawingDate, one_rec.TAmount, 0);
                                   
      v_Sum := ROUND(v_Sum, 2);

      IF(v_Sum != 0) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.DRWDrawingDate, one_rec.LBDealDate);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_DrawingDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := one_Rec.t_FaceValueFI;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1050;                           
        nptxobj.T_ANALITIC1      := one_rec.NumberDRW;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2020;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.TaxGroup;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Contract;                                            
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  --Расчет объектов НДР по размещенным ц/б
  PROCEDURE CreateTaxObjects2_28(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pContract  IN NUMBER,
                                 pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;

    v_Dir     NUMBER;
    v_Kind    NUMBER;
    v_Sum     NUMBER;
    v_Comment DNPTXOBJ_TMP.T_COMMENT%TYPE;
    v_K       NUMBER;
                    
  BEGIN
  
    pStat := 0;

    FOR one_rec IN (SELECT /*+LEADING(T)*/
                           T.t_ID, T.t_FIID, T.t_Amount TAmount, 
                           --LB.t_BuyDate, LB.t_Amount LBAmount, 
                           DRW.t_DrawingDate, TO_NUMBER(DRW.t_Number) NumberDRW, 
                           Fin.t_FaceValueFI, 
                           DRW.t_DrawingDate AS DRWDrawingDate, 
                           (CASE WHEN LB.T_GOID > 0 THEN NVL((SELECT (CASE WHEN comm.t_CorpActionDate = g_ZeroDate THEN LB.t_DealDate ELSE comm.t_CorpActionDate END)
                                                                 FROM dnptxgo_dbt go, ddl_comm_dbt comm
                                                                WHERE go.t_ID = LB.T_GOID
                                                                  AND comm.t_DocKind = go.t_DocKind
                                                                  AND comm.t_DocumentID = go.t_DocumentID
                                                              ), LB.t_DealDate)
                                 ELSE LB.t_DealDate END) as LBDealDate,
                           N.t_Analitic5, N.t_Analitic6
                      FROM dnptxts_dbt T, dfiwarnts_dbt DRW, dfininstr_dbt Fin, dnptxobj_dbt N, v_npx_dnptxlot LB 
                     WHERE T.t_Client        = pClient
                       AND RSI_NPTO.CheckContrIIS(T.t_Contract) = pIIS
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (T.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND T.t_Type          = RSI_NPTXC.NPTXTS_INVST
                       AND T.t_Amount        > 0 
                       AND T.t_FIID          = (CASE WHEN pFIID != -1 THEN pFIID ELSE T.t_FIID END)
                       AND DRW.t_FIID        = T.t_FIID
                       AND DRW.t_IsPartial   != 'X'
                       AND DRW.t_DrawingDate >= pBegDate 
                       AND DRW.t_DrawingDate <= pEndDate
                       AND T.t_BegDate < DRW.t_DrawingDate 
                       AND (T.t_EndDate >= DRW.t_DrawingDate OR T.t_EndDate = g_ZeroDate)
                       AND Fin.t_FIID = T.t_FIID
                      -- AND RSB_FIInstr.FI_AvrKindsGetRoot( Fin.t_FI_Kind, Fin.t_AvoirKind ) = RSI_RSB_FIInstr.AVOIRKIND_BOND
                       AND LB.t_ID           = T.t_BuyID
                       AND LB.t_Kind         = RSI_NPTXC.NPTXLOTS_BUY
                       AND N.t_AnaliticKind1 = LB.t_AnaliticKind1 
                       AND N.t_Analitic1     = LB.t_Analitic1
                       AND N.t_Kind          = RSI_NPTXC.TXOBJ_NKD
                       AND N.t_Client        = T.t_Client
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                                                                                                
                   )
    LOOP

      v_Dir     := RSI_NPTXC.TXOBJ_DIR_IN;
      v_Kind    := RSI_NPTXC.TXOBJ_PROCSEC_TS;
      v_Comment := 'Процентный доход по ц/б';

      v_Sum := RSI_RSB_FIINSTR.CalcNKD(one_rec.t_FIID, one_rec.t_DrawingDate, one_rec.TAmount, 0);

      v_Sum := RSB_SPREPFUN.SmartConvertSum_Ex(v_Sum, one_rec.t_DrawingDate, one_rec.t_FaceValueFi, RSI_RSB_FIInstr.NATCUR, 0);
                                   
      v_Sum := ROUND(v_Sum, 2);

      IF(v_Sum != 0) THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.DRWDrawingDate, one_rec.LBDealDate);

        InitNPTXOBJ(nptxobj);

        nptxobj.T_FUNCTIONKIND   := 1;
        nptxobj.T_DATE           := one_rec.t_DrawingDate;   
        nptxobj.T_CLIENT         := pClient;
        nptxobj.T_DIRECTION      := v_Dir;        
        nptxobj.T_LEVEL          := 2;
        nptxobj.T_KIND           := v_Kind;                              
        nptxobj.T_SUM            := v_Sum;                                                 
        nptxobj.T_CUR            := one_Rec.t_FaceValueFI;                                
        nptxobj.T_ANALITICKIND1  := RSI_NPTXC.TXOBJ_KIND1050;                           
        nptxobj.T_ANALITIC1      := one_rec.NumberDRW;                                   
        nptxobj.T_ANALITICKIND2  := RSI_NPTXC.TXOBJ_KIND2020;                    
        nptxobj.T_ANALITIC2      := one_rec.t_ID;                                          
        nptxobj.T_ANALITICKIND3  := RSI_NPTXC.TXOBJ_KIND3010;                    
        nptxobj.T_ANALITIC3      := one_rec.t_FIID;                                        
        nptxobj.T_ANALITICKIND4  := RSI_NPTXC.TXOBJ_KIND4010;                    
        nptxobj.T_ANALITIC4      := v_Circulate;                                     
        nptxobj.T_ANALITICKIND5  := RSI_NPTXC.TXOBJ_KIND5010;                    
        nptxobj.T_ANALITIC5      := one_rec.t_Analitic5;                                      
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                             
        nptxobj.T_ANALITIC6      := one_rec.t_Analitic6;                                            
        nptxobj.T_COMMENT        := v_Comment;      
        nptxobj.T_DOCID          := pDocID;
        nptxobj.T_STEP           := pStep; 
        nptxobj.T_TECHNICAL      := CHR(0);

        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;                                    
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;


  /**
  @brief Формирование объектов НДР 3 и 4 уровней
  @param [in] pFUNCTIONKIND Поле T_FUNCTIONID
  @param [in] pEndDate Дата окончания периода расчета
  @param [in] pClient ID клиента
  @param [in] pDirection Направление объекта НДР
  @param [in] pLevel Уровень
  @param [in] pKind Вид объекта НДР
  @param [in] pSum Сумма
  @param [in] pCur Ваюта
  @param [in] pAnaliticKind1 Вид анаитики 1
  @param [in] pAnalitic1 Значение аналитики 1
  @param [in] pAnaliticKind2 Вид аналитики 2
  @param [in] pAnalitic2 Значение аналитики 2
  @param [in] pAnaliticKind3 Вид аналитики 3
  @param [in] pAnalitic3 Значение аналитики 3
  @param [in] pAnaliticKind4 Вид аналитики 4
  @param [in] pAnalitic4 Значение аналитики 4
  @param [in] pAnaliticKind5 Вид аналитики 5
  @param [in] pAnalitic5 Значение аналитики 5
  @param [in] pAnaliticKind6 Вид аналитики 6
  @param [in] pAnalitic6 Значение аналитики 6
  @param [in] pComment Комментарий
  @param [in] pDocID ID операции
  @param [in] pStep ID шага
  @param [in] pTechnical Признак "Технический расчет"
  @param [in] pRecalc Признак "Пересчет"
  @param [in] pExistTechCalc Существуют более ранние операции расчета НОБ с признаком "Технический расчет" = "Технический"
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  */
  FUNCTION CreateNPTXOBJLevel3_4(pFUNCTIONKIND  IN NUMBER,
                                 pEndDate       IN DATE,
                                 pClient        IN NUMBER,
                                 pDirection     IN NUMBER,
                                 pLevel         IN NUMBER,
                                 pKind          IN NUMBER,
                                 pSum           IN NUMBER,
                                 pCur           IN NUMBER,
                                 pAnaliticKind1 IN NUMBER,
                                 pAnalitic1     IN NUMBER,
                                 pAnaliticKind2 IN NUMBER,
                                 pAnalitic2     IN NUMBER,
                                 pAnaliticKind3 IN NUMBER,
                                 pAnalitic3     IN NUMBER,
                                 pAnaliticKind4 IN NUMBER,
                                 pAnalitic4     IN NUMBER,
                                 pAnaliticKind5 IN NUMBER,
                                 pAnalitic5     IN NUMBER,
                                 pAnaliticKind6 IN NUMBER,
                                 pAnalitic6     IN NUMBER,
                                 pComment       IN VARCHAR2,
                                 pDocID         IN NUMBER,
                                 pStep          IN NUMBER,
                                 pTechnical     IN CHAR,
                                 pRecalc        IN CHAR,
                                 pExistTechCalc IN NUMBER,
                                 pTransfDate    IN DATE,
                                 pTransfKind    IN NUMBER,
                                 pHolding_Period IN NUMBER DEFAULT 0) RETURN dnptxobj_tmp%rowtype
  IS
     nptxobj dnptxobj_tmp%rowtype;
     v_Sum NUMBER := 0;
   
     v_AnaliticKind6 NUMBER;
     v_Analitic6     NUMBER;
  BEGIN

     v_AnaliticKind6 := pAnaliticKind6;
     v_Analitic6     := pAnalitic6;    

     IF pLevel >= 3 AND pLevel <= 7 AND pAnaliticKind6 = RSI_NPTXC.TXOBJ_KIND6020 AND RSI_NPTO.CheckContrIIS(pAnalitic6) = 0 THEN
       v_AnaliticKind6 := 0;
       v_Analitic6     := -1;
     END IF;

     IF pLevel = 3 THEN
       v_Sum := pSum;
     ELSE
       v_Sum := pSum + GetSumNPTXOBJTech(pDocID,
                                         pEndDate,
                                         pClient,
                                         pKind,
                                         pAnaliticKind1,
                                         pAnalitic1,
                                         pAnaliticKind2,
                                         pAnalitic2,
                                         pAnaliticKind3,
                                         pAnalitic3,
                                         pAnaliticKind4,
                                         pAnalitic4,
                                         pAnaliticKind5,
                                         pAnalitic5,
                                         v_AnaliticKind6,
                                         v_Analitic6,
                                         pExistTechCalc,
                                         pRecalc,
                                         pTransfKind,
                                         pHolding_Period);

       DeleteNPTXOBJTech(pDocID,
                         pStep,
                         pEndDate,
                         pClient,
                         pKind,
                         pAnaliticKind1,
                         pAnalitic1,
                         pAnaliticKind2,
                         pAnalitic2,
                         pAnaliticKind3,
                         pAnalitic3,
                         pAnaliticKind4,
                         pAnalitic4,
                         pAnaliticKind5,
                         pAnalitic5,
                         v_AnaliticKind6,
                         v_Analitic6,
                         pExistTechCalc,
                         pRecalc,
                         pTransfKind,
                         pHolding_Period);
     END IF;
     

     IF v_Sum <> 0
     THEN
       InitNPTXOBJ(nptxobj);

       nptxobj.T_FUNCTIONKIND   := pFUNCTIONKIND;
       nptxobj.T_DATE           := pEndDate;
       nptxobj.T_CLIENT         := pClient;
       nptxobj.T_DIRECTION      := pDirection;
       nptxobj.T_LEVEL          := pLevel;
       nptxobj.T_KIND           := pKind;
       nptxobj.T_SUM            := v_Sum;
       nptxobj.T_CUR            := pCur;
       nptxobj.T_ANALITICKIND1  := pAnaliticKind1;
       nptxobj.T_ANALITIC1      := pAnalitic1;
       nptxobj.T_ANALITICKIND2  := pAnaliticKind2;
       nptxobj.T_ANALITIC2      := pAnalitic2;
       nptxobj.T_ANALITICKIND3  := pAnaliticKind3;
       nptxobj.T_ANALITIC3      := pAnalitic3;
       nptxobj.T_ANALITICKIND4  := pAnaliticKind4;
       nptxobj.T_ANALITIC4      := pAnalitic4;
       nptxobj.T_ANALITICKIND5  := pAnaliticKind5;
       nptxobj.T_ANALITIC5      := pAnalitic5;
       nptxobj.T_ANALITICKIND6  := v_AnaliticKind6;
       nptxobj.T_ANALITIC6      := v_Analitic6;
       nptxobj.T_COMMENT        := pComment;
       nptxobj.T_DOCID          := pDocID;
       nptxobj.T_STEP           := pStep;
       nptxobj.T_TECHNICAL      := pTechnical;
       nptxobj.T_TRANSFDATE     := pTransfDate;
       nptxobj.T_TRANSFKIND     := pTransfKind;
       nptxobj.T_HOLDING_PERIOD := pHolding_Period;
       
       RETURN nptxobj;
     END IF;
     
     RETURN NULL;
  END;

  /**
  @brief Расчет объектов НДР по связям КП
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pContract ID Договора
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects3_1(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pTechnical IN NUMBER,
                                pRecalc    IN CHAR,
                                pExistTechCalc IN NUMBER,
                                pContract   IN NUMBER,
                                pTransfDate IN DATE,
                                pTransfKind IN NUMBER,
                                pDateNDR    IN DATE,
                                pStat     OUT NUMBER)
  IS

    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

    v_D NUMBER;
    v_R NUMBER;

    v_C1 NUMBER;
    v_C2 NUMBER;

    v_MainS0 NUMBER;
    v_MainB0 NUMBER;
    v_NPS_0  NUMBER;
    v_NPB_0  NUMBER;
    v_CM     NUMBER;
    v_DSC    NUMBER;
    v_NPS    NUMBER;
    v_NPB    NUMBER;

    v_Technical CHAR := CHR(0);

    v_prevLnkID       NUMBER := 0;
    v_AllWrtAmount    NUMBER := 0;
    v_WrtOpAmount     NUMBER := 0;
    v_RestWrtOpAmount NUMBER := 0;
    v_RestD           NUMBER := 0;
    v_RestR           NUMBER := 0;
    v_SD              NUMBER := 0;
    v_SR              NUMBER := 0;

  BEGIN

    pStat := 0;


    DELETE FROM DNPTXOP1OPLNK_TMP;

    --Вставим все подходящие связи во временную таблицу
    INSERT INTO DNPTXOP1OPLNK_TMP (T_DOCID, T_PARENT_DOCID, T_AMOUNT)
    WITH sf as (SELECT t_PartyID, t_ID 
                  FROM dsfcontr_dbt 
                 WHERE t_PartyID = pClient 
                   AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS 
                   AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
               )
    SELECT DISTINCT S.t_ID, S.t_ID, S.T_AMOUNT 
      FROM dnptxlnk_dbt S, sf, v_npx_dnptxlot LB, v_npx_dnptxlot LS, ddl_tick_dbt tks 
     WHERE S.t_Type = RSI_NPTXC.NPTXLNK_DELIVER
       AND S.t_Date >= pBegDate
       AND S.t_Date <= pEndDate
       AND S.t_Client = sf.t_PartyID
       AND S.t_Contract = sf.t_ID                             
       AND LS.t_ID = S.t_SaleID
       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
       AND LB.t_ID = S.t_BuyID
       AND S.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
       AND tks.t_BOfficeKind = LS.t_DocKind
       AND tks.t_DealID = LS.t_DocID;

    --Добавим связи по погашениям прошлых налоговых периодов, по которым выплаты прошли в текущем налоговом периоде
    INSERT INTO DNPTXOP1OPLNK_TMP (T_DOCID, T_PARENT_DOCID, T_AMOUNT)
    WITH sf as (SELECT t_PartyID, t_ID 
                  FROM dsfcontr_dbt 
                 WHERE t_PartyID = pClient 
                   AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS 
                   AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
               )
    SELECT DISTINCT S.t_ID, S.t_ID, S.T_AMOUNT 
      FROM dnptxlnk_dbt S, sf, v_npx_dnptxlot LS, v_npx_dnptxlot LB, ddl_tick_dbt tks 
     WHERE S.t_Type = RSI_NPTXC.NPTXLNK_DELIVER
       AND EXTRACT(YEAR FROM S.t_Date) < EXTRACT(YEAR FROM pBegDate)
       AND S.t_Client = sf.t_PartyID
       AND S.t_Contract = sf.t_ID                             
       AND LS.t_ID    = S.t_SaleID
       AND LS.t_DocKind = RSB_SECUR.DL_RETIREMENT
       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
       AND LB.t_ID = S.t_BuyID
       AND S.t_FIID   = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
       AND tks.t_BOfficeKind = LS.t_DocKind
       AND tks.t_DealID = LS.t_DocID
       AND NVL((SELECT MAX(obj.t_Date)
                 FROM dnptxobj_dbt obj
                WHERE obj.t_AnaliticKind1 = RSI_NPTXC.TXOBJ_KIND1020
                  AND obj.t_Analitic1 = LS.t_DocID
                  AND obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                  AND obj.t_Direction = RSI_NPTXC.TXOBJ_DIR_IN
               ), S.t_Date
              ) BETWEEN pBegDate AND pEndDate;


    AddChildLinksToTMP(pDocID, pBegDate, pEndDate, FALSE);

    FOR one_rec IN (SELECT /*+ leading(TMP) index(S DNPTXLNK_DBT_IDX0) index(PS DNPTXLNK_DBT_IDX0) index(LB DNPTXLOT_DBT_IDX0) index(LS DNPTXLOT_DBT_IDX0) index(PLB DNPTXLOT_DBT_IDX0) index(PLS DNPTXLOT_DBT_IDX0)*/
                           S.t_ID, PS.t_FIID, S.t_Contract, S.t_Amount, TMP.t_Amount SAmount, TMP.t_Amount1 as WrtOpAmount, TMP.t_Amount2 as WrtLnkAmount, S.t_PrivAmount SPrivAmount, 
                           (CASE WHEN PLS.T_DOCKIND = RSB_SECUR.DL_RETIREMENT AND EXTRACT(YEAR FROM PS.t_Date) < EXTRACT(YEAR FROM pBegDate) THEN
                                      NVL((SELECT MAX(obj.t_Date)
                                             FROM dnptxobj_dbt obj
                                            WHERE obj.t_AnaliticKind1 = RSI_NPTXC.TXOBJ_KIND1020
                                              AND obj.t_Analitic1 = PLS.t_DocID
                                              AND obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                              AND obj.t_Direction = RSI_NPTXC.TXOBJ_DIR_IN
                                           ), PS.t_Date)
                                 ELSE PS.t_Date END) as SDate,
                           LS.t_AnaliticKind1, LS.t_Analitic1,
                           (CASE WHEN LB.T_GOID > 0 THEN LB.t_BegBuyDate ELSE LB.t_DealDate END) BuyDealDate, LS.t_DealDate AS SaleDealDate,
                           TMP.T_PARENT_DOCID as Parent_LnkID
                      FROM dnptxlnk_dbt S, v_npx_dnptxlot LB, v_npx_dnptxlot LS, DNPTXOP1OPLNK_TMP TMP, dnptxlnk_dbt PS, v_npx_dnptxlot PLB, v_npx_dnptxlot PLS 
                     WHERE S.t_ID = TMP.T_DOCID
                       AND PS.t_ID = TMP.T_PARENT_DOCID 
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID
                       AND PS.t_BuyID  = PLB.t_ID 
                       AND PS.t_SaleID = PLS.t_ID
                    ORDER BY S.T_ID ASC
                    )
    LOOP

      IF one_rec.t_ID <> one_rec.Parent_LnkID THEN
        IF v_prevLnkID <> one_rec.t_ID THEN

          v_AllWrtAmount := one_rec.WrtLnkAmount; --Количество ц/б дочерней связи, соответствующее проданному количеству замещенных ц/б

          --Количество бумаг из связи замещения, по которым в текущей операции выполняется продажа замещенных бумаг
          v_WrtOpAmount := one_rec.WrtOpAmount; --Количество ц/б по дочерней связи замещения, соответствующее проданному кол-ву в текущей операции (родительской связью)
          v_RestWrtOpAMount := v_WrtOpAmount;


          v_C1 := GetSumByLnkWithSign_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_FR_LINK, g_ZeroDate, pEndDate, 1);

          v_MainS0 := GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINS, g_ZeroDate, pEndDate, 0, 1);
          v_MainB0 := GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINB, g_ZeroDate, pEndDate, 0, 1);
          
          v_NPS_0  := NPS_0(one_rec.t_ID, pEndDate, 1) * one_rec.SPrivAmount / v_AllWrtAmount;
          v_NPB_0  := NPB_0(one_rec.t_ID, pEndDate, 1) * one_rec.SPrivAmount / v_AllWrtAmount;
          v_CM     := CM(one_rec.t_ID, pEndDate, 1);
          v_DSC    := DSC(one_rec.t_ID, g_ZeroDate, pEndDate, 1);
          v_NPS    := NPS(one_rec.t_ID, pEndDate, 1);
          v_NPB    := NPB(one_rec.t_ID, pEndDate, 1);

          v_C2 := v_MainS0 - v_MainB0 - v_CM - v_DSC + v_NPS - v_NPB - v_NPS_0 + v_NPB_0;

          GetSumDR(v_C1, v_C2, v_SD, v_SR);

          v_RestD := v_SD;
          v_RestR := v_SR;
        END IF;

        IF one_rec.SAmount = v_RestWrtOpAMount THEN
          v_D := v_RestD;
          v_R := v_RestR; 
        ELSE
          v_D := v_SD/v_WrtOpAmount*one_rec.SAmount;
          v_R := v_SR/v_WrtOpAmount*one_rec.SAmount;
        END IF;

        v_RestWrtOpAMount := v_RestWrtOpAMount - one_rec.SAmount;
        v_RestD := v_RestD - v_D; 
        v_RestR := v_RestR - v_R;

      ELSE

        v_C1 := GetSumByLnkWithSign_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_FR_LINK, pBegDate, pEndDate, 1);

        v_MainS0 := GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINS, g_ZeroDate, pEndDate, 0, 1);
        v_MainB0 := GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINB, g_ZeroDate, pEndDate, 0, 1);
        
        v_NPS_0  := NPS_0(one_rec.t_ID, pEndDate, 1) * one_rec.SPrivAmount / one_rec.SAmount;
        v_NPB_0  := NPB_0(one_rec.t_ID, pEndDate, 1) * one_rec.SPrivAmount / one_rec.SAmount;
        v_CM     := CM(one_rec.t_ID, pEndDate, 1);
        v_DSC    := DSC(one_rec.t_ID, pBegDate, pEndDate, 1);
        v_NPS    := NPS(one_rec.t_ID, pEndDate, 1);
        v_NPB    := NPB(one_rec.t_ID, pEndDate, 1);

        v_C2 := v_MainS0 - v_MainB0 - v_CM - v_DSC + v_NPS - v_NPB - v_NPS_0 + v_NPB_0;

        GetSumDR(v_C1, v_C2, v_D, v_R);
      END IF;
      

      IF v_D <> 0 OR v_R <> 0 THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.SaleDealDate, one_rec.BuyDealDate); 
        v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_FIID);
      END IF;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_FR_LINK,
                                           3,
                                           one_rec.t_AnaliticKind1,
                                           one_rec.t_Analitic1,
                                           RSI_NPTXC.TXOBJ_KIND2010,
                                           one_rec.t_ID,
                                           RSI_NPTXC.TXOBJ_KIND3010,
                                           one_rec.t_FIID,
                                           RSI_NPTXC.TXOBJ_KIND4010,
                                           v_Circulate,
                                           RSI_NPTXC.TXOBJ_KIND5010,
                                           v_TaxGroup,
                                           RSI_NPTXC.TXOBJ_KIND6020,
                                           one_rec.t_Contract,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN one_rec.SDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_IN,
                                       3,
                                       RSI_NPTXC.TXOBJ_FR_LINK,
                                       v_D,
                                       RSI_RSB_FIInstr.NATCUR,
                                       one_rec.t_AnaliticKind1,
                                       one_rec.t_Analitic1,
                                       RSI_NPTXC.TXOBJ_KIND2010,
                                       one_rec.t_ID,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_FIID,
                                       RSI_NPTXC.TXOBJ_KIND4010,
                                       v_Circulate,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       one_rec.t_Contract,
                                       'Финансовый результат по связи для нельготных ц/б',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN one_rec.SDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_OUT,
                                       3,
                                       RSI_NPTXC.TXOBJ_FR_LINK,
                                       v_R,
                                       RSI_RSB_FIInstr.NATCUR,
                                       one_rec.t_AnaliticKind1,
                                       one_rec.t_Analitic1,
                                       RSI_NPTXC.TXOBJ_KIND2010,
                                       one_rec.t_ID,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_FIID,
                                       RSI_NPTXC.TXOBJ_KIND4010,
                                       v_Circulate,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       one_rec.t_Contract,
                                       'Финансовый результат по связи для нельготных ц/б',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);


      v_prevLnkID := one_rec.t_ID;

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

    DELETE FROM DNPTXOP1OPLNK_TMP;

  END;

  /**
  @brief Расчет объектов НДР по связям КП
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pContract ID Договора
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects3_2(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pTechnical IN NUMBER,
                                pRecalc    IN CHAR,
                                pExistTechCalc IN NUMBER,
                                pContract   IN NUMBER,
                                pTransfDate IN DATE,
                                pTransfKind IN NUMBER,
                                pDateNDR    IN DATE,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_TaxGroup  NUMBER;
    v_Circulate NUMBER;

    v_D NUMBER;
    v_R NUMBER;

    v_C1 NUMBER;
    v_C2 NUMBER;

    v_MainS0 NUMBER;
    v_MainB0 NUMBER;
    v_CM     NUMBER;
    v_DSC    NUMBER;
    v_NPS    NUMBER;
    v_NPB    NUMBER;

    v_AllWrtAmount    NUMBER := 0;

    v_prevLnkID       NUMBER := 0;
    v_WrtOpAmount     NUMBER := 0;
    v_RestWrtOpAmount NUMBER := 0;
    v_RestD           NUMBER := 0;
    v_RestR           NUMBER := 0;
    v_SD              NUMBER := 0;
    v_SR              NUMBER := 0;
    v_RestWrtOpAmount_0 NUMBER := 0;
    v_RestD_0           NUMBER := 0;
    v_RestR_0           NUMBER := 0;
    v_SD_0              NUMBER := 0;
    v_SR_0              NUMBER := 0;

    v_Technical CHAR := CHR(0);
  BEGIN

    pStat := 0;

    DELETE FROM DNPTXOP1OPLNK_TMP;

    --Вставим все подходящие связи во временную таблицу
    INSERT INTO DNPTXOP1OPLNK_TMP (T_DOCID, T_PARENT_DOCID, T_AMOUNT)
    WITH sf as (SELECT t_PartyID, t_ID 
                  FROM dsfcontr_dbt 
                 WHERE t_PartyID = pClient 
                   AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS 
                   AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
               )
    SELECT DISTINCT S.t_ID, S.t_ID, S.T_AMOUNT 
      FROM dnptxlnk_dbt S, sf, v_npx_dnptxlot LS, v_npx_dnptxlot LB, ddl_tick_dbt tks 
     WHERE S.t_Type = RSI_NPTXC.NPTXLNK_DELIVER
       AND S.t_Date >= pBegDate
       AND S.t_Date <= pEndDate
       AND S.t_Client = sf.t_PartyID
       AND S.t_Contract = sf.t_ID                             
       AND LS.t_ID    = S.t_SaleID
       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
       AND LB.t_ID = S.t_BuyID
       AND S.t_FIID   = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
       AND tks.t_BOfficeKind = LS.t_DocKind
       AND tks.t_DealID = LS.t_DocID;

    --Добавим связи по погашениям прошлых налоговых периодов, по которым выплаты прошли в текущем налоговом периоде
    INSERT INTO DNPTXOP1OPLNK_TMP (T_DOCID, T_PARENT_DOCID, T_AMOUNT)
    WITH sf as (SELECT t_PartyID, t_ID 
                  FROM dsfcontr_dbt 
                 WHERE t_PartyID = pClient 
                   AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS 
                   AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
               )
    SELECT DISTINCT S.t_ID, S.t_ID, S.T_AMOUNT 
      FROM dnptxlnk_dbt S, sf, v_npx_dnptxlot LS, v_npx_dnptxlot LB, ddl_tick_dbt tks 
     WHERE S.t_Type = RSI_NPTXC.NPTXLNK_DELIVER
       AND EXTRACT(YEAR FROM S.t_Date) < EXTRACT(YEAR FROM pBegDate)
       AND S.t_Client = sf.t_PartyID
       AND S.t_Contract = sf.t_ID                             
       AND LS.t_ID    = S.t_SaleID
       AND LS.t_DocKind = RSB_SECUR.DL_RETIREMENT
       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
       AND LB.t_ID = S.t_BuyID
       AND S.t_FIID   = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
       AND tks.t_BOfficeKind = LS.t_DocKind
       AND tks.t_DealID = LS.t_DocID
       AND NVL((SELECT MAX(obj.t_Date)
                 FROM dnptxobj_dbt obj
                WHERE obj.t_AnaliticKind1 = RSI_NPTXC.TXOBJ_KIND1020
                  AND obj.t_Analitic1 = LS.t_DocID
                  AND obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                  AND obj.t_Direction = RSI_NPTXC.TXOBJ_DIR_IN
               ), S.t_Date
              ) BETWEEN pBegDate AND pEndDate;

    AddChildLinksToTMP(pDocID, pBegDate, pEndDate, FALSE);

    FOR one_rec IN (SELECT /*+ leading(TMP) index(S DNPTXLNK_DBT_IDX0) index(PS DNPTXLNK_DBT_IDX0) index(LB DNPTXLOT_DBT_IDX0) index(LS DNPTXLOT_DBT_IDX0) index(PLB DNPTXLOT_DBT_IDX0) index(PLS DNPTXLOT_DBT_IDX0)*/
                           S.t_ID, PS.t_FIID, S.t_Contract, S.t_Amount, TMP.t_Amount SAmount, TMP.t_Amount1 as WrtOpAmount, TMP.t_Amount2 as WrtLnkAmount, S.t_PrivAmount SPrivAmount, 
                           (CASE WHEN PLS.T_DOCKIND = RSB_SECUR.DL_RETIREMENT AND EXTRACT(YEAR FROM PS.t_Date) < EXTRACT(YEAR FROM pBegDate) THEN
                                      NVL((SELECT MAX(obj.t_Date)
                                             FROM dnptxobj_dbt obj
                                            WHERE obj.t_AnaliticKind1 = RSI_NPTXC.TXOBJ_KIND1020
                                              AND obj.t_Analitic1 = PLS.t_DocID
                                              AND obj.t_Kind = RSI_NPTXC.TXOBJ_MAIN
                                              AND obj.t_Direction = RSI_NPTXC.TXOBJ_DIR_IN
                                           ), PS.t_Date)
                                 ELSE PS.t_Date END) as SDate, 
                           PS.t_Date LinkDate, 
                           LS.t_AnaliticKind1, LS.t_Analitic1,
                           (CASE WHEN LB.T_GOID > 0 THEN LB.t_BegBuyDate ELSE LB.t_DealDate END) BuyDealDate, LS.t_DealDate AS SaleDealDate,
                           TMP.T_PARENT_DOCID as Parent_LnkID
                      FROM dnptxlnk_dbt S, v_npx_dnptxlot LB, v_npx_dnptxlot LS, DNPTXOP1OPLNK_TMP TMP, dnptxlnk_dbt PS, v_npx_dnptxlot PLB, v_npx_dnptxlot PLS 
                     WHERE S.t_ID = TMP.T_DOCID
                       AND PS.t_ID = TMP.T_PARENT_DOCID 
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID
                       AND PS.t_BuyID  = PLB.t_ID 
                       AND PS.t_SaleID = PLS.t_ID
                    ORDER BY S.T_ID ASC
                    )
    LOOP

      v_TaxGroup := npto.GetPaperTaxGroupNPTX(one_rec.t_FIID);

      IF one_rec.t_ID <> one_rec.Parent_LnkID THEN
        IF v_prevLnkID <> one_rec.t_ID THEN
          v_AllWrtAmount := one_rec.WrtLnkAmount; --Количество ц/б дочерней связи, соответствующее проданному количеству замещенных ц/б

          --Количество бумаг из связи замещения, по которым в текущей операции выполняется продажа замещенных бумаг
          v_WrtOpAmount := one_rec.WrtOpAmount; --Количество ц/б по дочерней связи замещения, соответствующее проданному кол-ву в текущей операции (родительской связью)
          v_RestWrtOpAMount := v_WrtOpAmount;

          v_C1 := GetSumByLnkWithSign_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_TAX_LINK, g_ZeroDate, pEndDate, 1);

          v_MainS0 := GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINS, g_ZeroDate, pEndDate, 0, 1);
          v_MainB0 := GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINB, g_ZeroDate, pEndDate, 0, 1);
          v_CM     := CM(one_rec.t_ID, pEndDate, 1);
          v_DSC    := DSC(one_rec.t_ID, g_ZeroDate, pEndDate, 1);

          IF (v_TaxGroup = RSI_NPTXC.TXGROUP_40 OR v_TaxGroup = RSI_NPTXC.TXGROUP_50) AND one_rec.LinkDate < TO_DATE('01.01.2021','DD.MM.YYYY') THEN
            v_NPS  := 0;
            v_NPB  := 0;
          ELSE
            v_NPS  := NPS(one_rec.t_ID, pEndDate, 1);
            v_NPB  := NPB(one_rec.t_ID, pEndDate, 1);
          END IF;

          v_C2 := v_MainS0 - v_MainB0 - v_CM - v_DSC + v_NPS - v_NPB;

          GetSumDR(v_C1, v_C2, v_SD, v_SR);

          v_RestD := v_SD;
          v_RestR := v_SR;
        END IF;

        IF one_rec.SAmount = v_RestWrtOpAMount THEN
          v_D := v_RestD;
          v_R := v_RestR; 
        ELSE
          v_D := v_SD/v_WrtOpAmount*one_rec.SAmount;
          v_R := v_SR/v_WrtOpAmount*one_rec.SAmount;
        END IF;

        v_RestWrtOpAMount := v_RestWrtOpAMount - one_rec.SAmount;
        v_RestD := v_RestD - v_D; 
        v_RestR := v_RestR - v_R;

      ELSE

        v_C1 := GetSumByLnkWithSign_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_TAX_LINK, pBegDate, pEndDate, 1);

        v_MainS0 := GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINS, g_ZeroDate, pEndDate, 0, 1);
        v_MainB0 := GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINB, g_ZeroDate, pEndDate, 0, 1);
        v_CM     := CM(one_rec.t_ID, pEndDate, 1);
        v_DSC    := DSC(one_rec.t_ID, pBegDate, pEndDate, 1);

        IF (v_TaxGroup = RSI_NPTXC.TXGROUP_40 OR v_TaxGroup = RSI_NPTXC.TXGROUP_50) AND one_rec.LinkDate < TO_DATE('01.01.2021','DD.MM.YYYY') THEN
          v_NPS  := 0;
          v_NPB  := 0;
        ELSE
          v_NPS  := NPS(one_rec.t_ID, pEndDate, 1);
          v_NPB  := NPB(one_rec.t_ID, pEndDate, 1);
        END IF;

        v_C2 := v_MainS0 - v_MainB0 - v_CM - v_DSC + v_NPS - v_NPB;

        GetSumDR(v_C1, v_C2, v_D, v_R);
      END IF;

      v_Circulate := 0;
      IF v_D <> 0 OR v_R <> 0  THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.SaleDealDate, one_rec.BuyDealDate);
      END IF;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_TAX_LINK,
                                           3,
                                           one_rec.t_AnaliticKind1,
                                           one_rec.t_Analitic1,
                                           RSI_NPTXC.TXOBJ_KIND2010,
                                           one_rec.t_ID,
                                           RSI_NPTXC.TXOBJ_KIND3010,
                                           one_rec.t_FIID,
                                           RSI_NPTXC.TXOBJ_KIND4010,
                                           v_Circulate,
                                           RSI_NPTXC.TXOBJ_KIND5010,
                                           v_TaxGroup,
                                           RSI_NPTXC.TXOBJ_KIND6020,
                                           one_rec.t_Contract,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN one_rec.SDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_IN,
                                       3,
                                       RSI_NPTXC.TXOBJ_TAX_LINK,
                                       v_D,
                                       RSI_RSB_FIInstr.NATCUR,
                                       one_rec.t_AnaliticKind1,
                                       one_rec.t_Analitic1,
                                       RSI_NPTXC.TXOBJ_KIND2010,
                                       one_rec.t_ID,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_FIID,
                                       RSI_NPTXC.TXOBJ_KIND4010,
                                       v_Circulate,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       one_rec.t_Contract,
                                       'ФР по связи, включаемый в НОБ',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN one_rec.SDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_OUT,
                                       3,
                                       RSI_NPTXC.TXOBJ_TAX_LINK,
                                       v_R,
                                       RSI_RSB_FIInstr.NATCUR,
                                       one_rec.t_AnaliticKind1,
                                       one_rec.t_Analitic1,
                                       RSI_NPTXC.TXOBJ_KIND2010,
                                       one_rec.t_ID,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_FIID,
                                       RSI_NPTXC.TXOBJ_KIND4010,
                                       v_Circulate,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       one_rec.t_Contract,
                                       'ФР по связи, включаемый в НОБ',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF one_rec.t_ID <> one_rec.Parent_LnkID THEN
        IF v_prevLnkID <> one_rec.t_ID THEN
          v_C1 := GetSumByLnkWithSign_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_TAX_LINK_0, pBegDate, pEndDate);

          IF (v_TaxGroup = RSI_NPTXC.TXGROUP_40 OR v_TaxGroup = RSI_NPTXC.TXGROUP_50) AND one_rec.LinkDate < TO_DATE('01.01.2021','DD.MM.YYYY') THEN 
            v_C2 := NPS(one_rec.t_ID, pEndDate) - NPB(one_rec.t_ID, pEndDate);
          ELSE
            v_C2 := GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINS_0, g_ZeroDate, pEndDate) -
                    GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINB_0, g_ZeroDate, pEndDate) -
                    GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_COMS_0, g_ZeroDate, pEndDate) +
                    GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_COMB_0, g_ZeroDate, pEndDate);      
          END IF;

          GetSumDR(v_C1, v_C2, v_SD_0, v_SR_0);

          v_RestD_0 := v_SD_0;
          v_RestR_0 := v_SR_0;

          v_RestWrtOpAMount_0 := v_WrtOpAmount;
        END IF;

        IF one_rec.SAmount = v_RestWrtOpAMount_0 THEN
          v_D := v_RestD_0;
          v_R := v_RestR_0; 
        ELSE
          v_D := ROUND(v_SD_0/v_WrtOpAmount*one_rec.SAmount, 2);
          v_R := ROUND(v_SR_0/v_WrtOpAmount*one_rec.SAmount, 2);
        END IF;

        v_RestWrtOpAMount_0 := v_RestWrtOpAMount_0 - one_rec.SAmount;
        v_RestD_0 := v_RestD_0 - v_D; 
        v_RestR_0 := v_RestR_0 - v_R;

      ELSE

        v_C1 := GetSumByLnkWithSign_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_TAX_LINK_0, pBegDate, pEndDate);

        IF (v_TaxGroup = RSI_NPTXC.TXGROUP_40 OR v_TaxGroup = RSI_NPTXC.TXGROUP_50) AND one_rec.LinkDate < TO_DATE('01.01.2021','DD.MM.YYYY') THEN 
          v_C2 := NPS(one_rec.t_ID, pEndDate) - NPB(one_rec.t_ID, pEndDate);
        ELSE
          v_C2 := GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINS_0, g_ZeroDate, pEndDate) -
                  GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINB_0, g_ZeroDate, pEndDate) -
                  GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_COMS_0, g_ZeroDate, pEndDate) +
                  GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_COMB_0, g_ZeroDate, pEndDate);      
        END IF;

        GetSumDR(v_C1, v_C2, v_D, v_R);
      END IF;

      IF v_Circulate = 0 AND (v_D <> 0 OR v_R <> 0)  THEN
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.SaleDealDate, one_rec.BuyDealDate);
      END IF;

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN one_rec.SDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_IN,
                                       3,
                                       RSI_NPTXC.TXOBJ_TAX_LINK_0,
                                       v_D,
                                       RSI_RSB_FIInstr.NATCUR,
                                       one_rec.t_AnaliticKind1,
                                       one_rec.t_Analitic1,
                                       RSI_NPTXC.TXOBJ_KIND2010,
                                       one_rec.t_ID,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_FIID,
                                       RSI_NPTXC.TXOBJ_KIND4010,
                                       v_Circulate,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       one_rec.t_Contract,
                                       'ФР по связи, не включаемый в НОБ',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN one_rec.SDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_OUT,
                                       3,
                                       RSI_NPTXC.TXOBJ_TAX_LINK_0,
                                       v_R,
                                       RSI_RSB_FIInstr.NATCUR,
                                       one_rec.t_AnaliticKind1,
                                       one_rec.t_Analitic1,
                                       RSI_NPTXC.TXOBJ_KIND2010,
                                       one_rec.t_ID,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_FIID,
                                       RSI_NPTXC.TXOBJ_KIND4010,
                                       v_Circulate,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       one_rec.t_Contract,
                                       'ФР по связи, не включаемый в НОБ',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      v_prevLnkID := one_rec.t_ID;

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

    DELETE FROM DNPTXOP1OPLNK_TMP;

  END;

  /**
  @brief Расчет объектов НДР по связям ЗКП
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pContract ID Договора
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects3_3(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pTechnical IN NUMBER,
                                pRecalc    IN CHAR,
                                pExistTechCalc IN NUMBER,
                                pContract   IN NUMBER,
                                pTransfDate IN DATE,
                                pTransfKind IN NUMBER,
                                pDateNDR    IN DATE,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

    v_D NUMBER;
    v_R NUMBER;

    v_C1 NUMBER;
    v_C2 NUMBER;

    v_MainS0   NUMBER;
    v_MainB0   NUMBER;
    v_NPS_0    NUMBER;
    v_NPB_0    NUMBER;
    v_CM_Short NUMBER;
    v_DSC      NUMBER;
    v_NPS      NUMBER;
    v_NPB      NUMBER;
    
    v_Technical CHAR := CHR(0);
  BEGIN

    pStat := 0;

    FOR one_rec IN (WITH sf as (SELECT t_PartyID, t_ID 
                                  FROM dsfcontr_dbt 
                                 WHERE t_PartyID = pClient 
                                   AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS 
                                   AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                               )
                    SELECT LS.t_AnaliticKind1, LS.t_Analitic1, 
                           S.t_ID, S.t_FIID, S.t_Contract, S.t_PrivAmount, S.t_Amount, 
                           (CASE WHEN LB.T_GOID > 0 THEN LB.t_BegBuyDate ELSE LB.t_DealDate END) BuyDealDate, LS.t_DealDate AS SaleDealDate,
                           S.t_Date as t_LinkDate
                      FROM dnptxlnk_dbt S, sf, v_npx_dnptxlot LB, v_npx_dnptxlot LS 
                     WHERE S.t_Type = RSI_NPTXC.NPTXLNK_CLPOS
                       AND S.t_Date >= pBegDate
                       AND S.t_Date <= pEndDate
                       AND S.t_Client = sf.t_PartyID
                       AND S.t_Contract = sf.t_ID                             
                       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
                       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID 
                       AND S.t_FIID   = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
                    )
    LOOP

      v_C1 := GetSumByLnkWithSign_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_FR_LINK, pBegDate, pEndDate);

      v_MainS0   := GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINS_SHORT, g_ZeroDate, pEndDate);
      v_MainB0   := GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINB_SHORT, g_ZeroDate, pEndDate);
      v_NPS_0    := NPS_0(one_rec.t_ID, pEndDate) * one_rec.t_PrivAmount / one_rec.t_Amount;
      v_NPB_0    := NPB_0(one_rec.t_ID, pEndDate) * one_rec.t_PrivAmount / one_rec.t_Amount;
      v_CM_Short := CM_Short(one_rec.t_ID, pEndDate);
      v_DSC      := DSC(one_rec.t_ID, pBegDate, pEndDate);
      v_NPS      := NPS(one_rec.t_ID, pEndDate);
      v_NPB      := NPB(one_rec.t_ID, pEndDate);

      v_C2 := v_MainS0 - v_MainB0 - v_CM_Short - v_DSC + v_NPS - v_NPB; 

      GetSumDR(v_C1, v_C2, v_D, v_R);

      IF v_D <> 0 OR v_R <> 0 THEN
        v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_FIID);
        v_Circulate := npto.Market2dates(one_rec.t_FIID, one_rec.BuyDealDate, one_rec.SaleDealDate);
      END IF;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_FR_LINK,
                                           3,
                                           one_rec.t_AnaliticKind1,
                                           one_rec.t_Analitic1,
                                           RSI_NPTXC.TXOBJ_KIND2010,
                                           one_rec.t_ID,
                                           RSI_NPTXC.TXOBJ_KIND3010,
                                           one_rec.t_FIID,
                                           RSI_NPTXC.TXOBJ_KIND4010,
                                           v_Circulate,
                                           RSI_NPTXC.TXOBJ_KIND5010,
                                           v_TaxGroup,
                                           RSI_NPTXC.TXOBJ_KIND6020,
                                           one_rec.t_Contract,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_IN,
                                       3,
                                       RSI_NPTXC.TXOBJ_FR_LINK,
                                       v_D,
                                       RSI_RSB_FIInstr.NATCUR,
                                       one_rec.t_AnaliticKind1,
                                       one_rec.t_Analitic1,
                                       RSI_NPTXC.TXOBJ_KIND2010,
                                       one_rec.t_ID,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_FIID,
                                       RSI_NPTXC.TXOBJ_KIND4010,
                                       v_Circulate,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       one_rec.t_Contract,
                                       'Финансовый результат по связи',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_OUT,
                                       3,
                                       RSI_NPTXC.TXOBJ_FR_LINK,
                                       v_R,
                                       RSI_RSB_FIInstr.NATCUR,
                                       one_rec.t_AnaliticKind1,
                                       one_rec.t_Analitic1,
                                       RSI_NPTXC.TXOBJ_KIND2010,
                                       one_rec.t_ID,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_FIID,
                                       RSI_NPTXC.TXOBJ_KIND4010,
                                       v_Circulate,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       one_rec.t_Contract,
                                       'Финансовый результат по связи',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Расчет объектов НДР по связям ЗКП
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pContract ID Договора
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects3_4(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pTechnical IN NUMBER,
                                pRecalc    IN CHAR,
                                pExistTechCalc IN NUMBER,
                                pContract   IN NUMBER,
                                pTransfDate IN DATE,
                                pTransfKind IN NUMBER,
                                pDateNDR    IN DATE,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

    v_D NUMBER;
    v_R NUMBER;

    v_C1 NUMBER;
    v_C2 NUMBER;

    v_MainS0   NUMBER;
    v_MainB0   NUMBER;
    v_CM_Short NUMBER;
    v_DSC      NUMBER;
    
    v_Technical CHAR := CHR(0);
  BEGIN

    pStat := 0;

    FOR one_rec IN (SELECT LS.t_AnaliticKind1, LS.t_Analitic1, 
                           S.t_ID, S.t_FIID, S.t_Contract, 
                           (CASE WHEN LB.T_GOID > 0 THEN LB.t_BegBuyDate ELSE LB.t_DealDate END) BuyDealDate, LS.t_DealDate AS SaleDealDate,
                           S.t_Date LinkDate
                      FROM dnptxlnk_dbt S, v_npx_dnptxlot LB, v_npx_dnptxlot LS 
                     WHERE S.t_Type = RSI_NPTXC.NPTXLNK_CLPOS
                       AND S.t_Date >= pBegDate
                       AND S.t_Date <= pEndDate
                       AND S.t_Client = pClient
                       AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS                             
                       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
                       AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
                       AND S.t_BuyID  = LB.t_ID 
                       AND S.t_SaleID = LS.t_ID 
                       AND S.t_FIID   = (CASE WHEN pFIID != -1 THEN pFIID ELSE S.t_FIID END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (S.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                    )
    LOOP

      v_TaxGroup := npto.GetPaperTaxGroupNPTX(one_rec.t_FIID);

      v_C1 := GetSumByLnkWithSign_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_TAX_LINK, pBegDate, pEndDate);

      v_MainS0   := GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINS_SHORT, g_ZeroDate, pEndDate);
      v_MainB0   := GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINB_SHORT, g_ZeroDate, pEndDate);
      v_CM_Short := CM_Short(one_rec.t_ID, pEndDate);
      v_DSC      := DSC(one_rec.t_ID, pBegDate, pEndDate);

      v_C2 := v_MainS0 - v_MainB0 - v_CM_Short - v_DSC;
      IF v_TaxGroup != RSI_NPTXC.TXGROUP_40 AND v_TaxGroup != RSI_NPTXC.TXGROUP_50 THEN 
        v_C2 := v_C2 + NPS(one_rec.t_ID, pEndDate) - NPB(one_rec.t_ID, pEndDate);
      END IF;

      GetSumDR(v_C1, v_C2, v_D, v_R);

      IF v_D <> 0 OR v_R <> 0 THEN
        v_Circulate := npto.Market2dates(one_rec.t_ID, one_rec.BuyDealDate, one_rec.SaleDealDate);
      END IF;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_TAX_LINK,
                                           3,
                                           one_rec.t_AnaliticKind1,
                                           one_rec.t_Analitic1,
                                           RSI_NPTXC.TXOBJ_KIND2010,
                                           one_rec.t_ID,
                                           RSI_NPTXC.TXOBJ_KIND3010,
                                           one_rec.t_FIID,
                                           RSI_NPTXC.TXOBJ_KIND4010,
                                           v_Circulate,
                                           RSI_NPTXC.TXOBJ_KIND5010,
                                           v_TaxGroup,
                                           RSI_NPTXC.TXOBJ_KIND6020,
                                           one_rec.t_Contract,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_IN,
                                       3,
                                       RSI_NPTXC.TXOBJ_TAX_LINK,
                                       v_D,
                                       RSI_RSB_FIInstr.NATCUR,
                                       one_rec.t_AnaliticKind1,
                                       one_rec.t_Analitic1,
                                       RSI_NPTXC.TXOBJ_KIND2010,
                                       one_rec.t_ID,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_FIID,
                                       RSI_NPTXC.TXOBJ_KIND4010,
                                       v_Circulate,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       one_rec.t_Contract,
                                       'НОБ по связи',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_OUT,
                                       3,
                                       RSI_NPTXC.TXOBJ_TAX_LINK,
                                       v_R,
                                       RSI_RSB_FIInstr.NATCUR,
                                       one_rec.t_AnaliticKind1,
                                       one_rec.t_Analitic1,
                                       RSI_NPTXC.TXOBJ_KIND2010,
                                       one_rec.t_ID,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_FIID,
                                       RSI_NPTXC.TXOBJ_KIND4010,
                                       v_Circulate,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       one_rec.t_Contract,
                                       'НОБ по связи',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Расчет объектов НДР по остаткам ц/б
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pContract ID Договора
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects3_5(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pTechnical IN NUMBER,
                                pRecalc    IN CHAR,
                                pExistTechCalc IN NUMBER,
                                pContract   IN NUMBER,
                                pTransfDate IN DATE,
                                pTransfKind IN NUMBER,
                                pDateNDR    IN DATE,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_TaxGroup  NUMBER;

    v_D NUMBER;
    v_R NUMBER;

    v_C1 NUMBER;
    v_C2 NUMBER;

    v_MainS_TS0     NUMBER;
    v_NkdS_TS0      NUMBER;
    v_ComS_TS0      NUMBER;
    v_MainB_TS0     NUMBER;
    v_NkdB_TS0      NUMBER;
    v_ComB_TS0      NUMBER;
    v_MaterialB_TS0 NUMBER;
    v_TaxPM_TS0     NUMBER;
    v_TaxFR_TS0     NUMBER;
    v_TaxFR_TS0_1   NUMBER;
    v_MainS_TS_00   NUMBER;
    v_ComS_TS_00    NUMBER;
    v_MainB_TS_00   NUMBER;
    v_ComB_TS_00    NUMBER;
    v_FR_TS_00      NUMBER;
    v_FR_TS_00_1    NUMBER;

    v_ak1 NUMBER := RSI_NPTXC.TXOBJ_KIND1060; --Номер ЧП
    v_ak2 NUMBER := RSI_NPTXC.TXOBJ_KIND2020; --ТС
    v_ak4 NUMBER := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б

    v_Technical CHAR := CHR(0);
  BEGIN

    pStat := 0;

    FOR one_rec IN (SELECT N.t_Analitic1 a1, N.t_Analitic2 a2, N.t_Analitic4 a4, T.t_FIID, T.t_Contract
                      FROM dnptxlot_dbt LB, dnptxts_dbt T, dnptxobj_dbt N 
                     WHERE T.t_Client = pClient
                       AND RSI_NPTO.CheckContrIIS(T.t_Contract) = pIIS                             
                       AND T.t_BuyID = LB.t_ID 
                       AND LB.t_Kind = RSI_NPTXC.NPTXLOTS_BUY
                       AND T.t_Type IN (RSI_NPTXC.NPTXTS_INVST, RSI_NPTXC.NPTXTS_REST)
                       AND N.t_Kind IN (RSI_NPTXC.TXOBJ_MAINS_TS, RSI_NPTXC.TXOBJ_MAINB_TS)
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind1 = v_ak1
                       AND N.t_AnaliticKind2 = v_ak2
                       AND N.t_Analitic2 = T.t_ID 
                       AND N.t_AnaliticKind4 = v_ak4
                       AND T.t_FIID = (CASE WHEN pFIID != -1 THEN pFIID ELSE T.t_FIID END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (T.t_Contract in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                     GROUP BY N.t_Analitic1, N.t_Analitic2, N.t_Analitic4, T.t_FIID, T.t_Contract
                   )
    LOOP

      v_TaxGroup := npto.GetPaperTaxGroupNPTX(one_rec.t_FIID);

      v_MainS_TS0 := GetNPTXOBJSum_0_124(pClient, RSI_NPTXC.TXOBJ_MAINS_TS, pBegDate,   pEndDate, 0, v_ak1,one_rec.a1,v_ak2,one_rec.a2,v_ak4,one_rec.a4);
      v_NkdS_TS0  := GetNPTXOBJSum_0_124(pClient, RSI_NPTXC.TXOBJ_NKDS_TS,  pBegDate,   pEndDate, 0, v_ak1,one_rec.a1,v_ak2,one_rec.a2,v_ak4,one_rec.a4); 
      v_ComS_TS0  := GetNPTXOBJSum_0_124(pClient, RSI_NPTXC.TXOBJ_COMS_TS,  pBegDate,   pEndDate, 0, v_ak1,one_rec.a1,v_ak2,one_rec.a2,v_ak4,one_rec.a4); 
      v_MainB_TS0 := GetNPTXOBJSum_0_124(pClient, RSI_NPTXC.TXOBJ_MAINB_TS, g_ZeroDate, pEndDate, 0, v_ak1,one_rec.a1,v_ak2,one_rec.a2,v_ak4,one_rec.a4); 
      v_ComB_TS0  := GetNPTXOBJSum_0_124(pClient, RSI_NPTXC.TXOBJ_COMB_TS,  g_ZeroDate, pEndDate, 0, v_ak1,one_rec.a1,v_ak2,one_rec.a2,v_ak4,one_rec.a4); 

      v_MaterialB_TS0 := 0;
      IF IsIncludeMaterialInOut <> 0 THEN 
        v_MaterialB_TS0 := GetNPTXOBJSum_0_124(pClient, RSI_NPTXC.TXOBJ_MATERIALB_TS, g_ZeroDate, pEndDate, 0, v_ak1,one_rec.a1,v_ak2,one_rec.a2,v_ak4,one_rec.a4);
      END IF;

      v_TaxPM_TS0   := GetNPTXOBJSum_0_124(pClient, RSI_NPTXC.TXOBJ_TAXPM_TS, g_ZeroDate, pEndDate, 0, v_ak1,one_rec.a1,v_ak2,one_rec.a2,v_ak4,one_rec.a4);
      v_TaxFR_TS0   := GetNPTXOBJSum_0_124(pClient, RSI_NPTXC.TXOBJ_FR_TS,    pBegDate,   pEndDate, RSI_NPTXC.TXOBJ_DIR_IN, v_ak1,one_rec.a1,v_ak2,one_rec.a2,v_ak4,one_rec.a4); 
      v_TaxFR_TS0_1 := GetNPTXOBJSum_0_124(pClient, RSI_NPTXC.TXOBJ_FR_TS,    pBegDate,   pEndDate, RSI_NPTXC.TXOBJ_DIR_OUT, v_ak1,one_rec.a1,v_ak2,one_rec.a2,v_ak4,one_rec.a4);

      v_C1 := v_TaxFR_TS0 - v_TaxFR_TS0_1;
      v_C2 := v_MainS_TS0 + v_NkdS_TS0 - v_ComS_TS0 - v_MainB_TS0 - v_ComB_TS0 - v_MaterialB_TS0 - v_TaxPM_TS0;

      GetSumDR(v_C1, v_C2, v_D, v_R);
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_FR_LINK,
                                           3,
                                           v_ak1,
                                           one_rec.a1,
                                           v_ak2,
                                           one_rec.a2,
                                           RSI_NPTXC.TXOBJ_KIND3010,
                                           one_rec.t_FIID,
                                           v_ak4,
                                           one_rec.a4,
                                           RSI_NPTXC.TXOBJ_KIND5010,
                                           v_TaxGroup,
                                           RSI_NPTXC.TXOBJ_KIND6020,
                                           one_rec.t_Contract,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_IN,
                                       3,
                                       RSI_NPTXC.TXOBJ_FR_TS,
                                       v_D,
                                       RSI_RSB_FIInstr.NATCUR,
                                       v_ak1,
                                       one_rec.a1,
                                       v_ak2,
                                       one_rec.a2,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_FIID,
                                       v_ak4,
                                       one_rec.a4,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       one_rec.t_Contract,
                                       'Финансовый результат при частичном погашении для нельготных бумаг',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_OUT,
                                       3,
                                       RSI_NPTXC.TXOBJ_FR_TS,
                                       v_R,
                                       RSI_RSB_FIInstr.NATCUR,
                                       v_ak1,
                                       one_rec.a1,
                                       v_ak2,
                                       one_rec.a2,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_FIID,
                                       v_ak4,
                                       one_rec.a4,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       one_rec.t_Contract,
                                       'Финансовый результат при частичном погашении для нельготных бумаг',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      v_MainS_TS_00 := GetNPTXOBJSum_0_124(pClient, RSI_NPTXC.TXOBJ_MAINS_TS_0, pBegDate,   pEndDate, 0, v_ak1,one_rec.a1,v_ak2,one_rec.a2,v_ak4,one_rec.a4); 
      v_ComS_TS_00  := GetNPTXOBJSum_0_124(pClient, RSI_NPTXC.TXOBJ_COMS_TS_0,  pBegDate,   pEndDate, 0, v_ak1,one_rec.a1,v_ak2,one_rec.a2,v_ak4,one_rec.a4); 
      v_MainB_TS_00 := GetNPTXOBJSum_0_124(pClient, RSI_NPTXC.TXOBJ_MAINB_TS_0, g_ZeroDate, pEndDate, 0, v_ak1,one_rec.a1,v_ak2,one_rec.a2,v_ak4,one_rec.a4); 
      v_ComB_TS_00  := GetNPTXOBJSum_0_124(pClient, RSI_NPTXC.TXOBJ_COMB_TS_0,  g_ZeroDate, pEndDate, 0, v_ak1,one_rec.a1,v_ak2,one_rec.a2,v_ak4,one_rec.a4); 
      v_FR_TS_00    := GetNPTXOBJSum_0_124(pClient, RSI_NPTXC.TXOBJ_FR_TS_0,    pBegDate,   pEndDate, RSI_NPTXC.TXOBJ_DIR_IN, v_ak1,one_rec.a1,v_ak2,one_rec.a2,v_ak4,one_rec.a4);
      v_FR_TS_00_1  := GetNPTXOBJSum_0_124(pClient, RSI_NPTXC.TXOBJ_FR_TS_0,    pBegDate,   pEndDate, RSI_NPTXC.TXOBJ_DIR_OUT, v_ak1,one_rec.a1,v_ak2,one_rec.a2,v_ak4,one_rec.a4);

      v_C1 := v_FR_TS_00 - v_FR_TS_00_1;
      v_C2 := v_MainS_TS_00 - v_ComS_TS_00 - v_MainB_TS_00 - v_ComB_TS_00;

      GetSumDR(v_C1, v_C2, v_D, v_R);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_IN,
                                       3,
                                       RSI_NPTXC.TXOBJ_FR_TS_0,
                                       v_D,
                                       RSI_RSB_FIInstr.NATCUR,
                                       v_ak1,
                                       one_rec.a1,
                                       v_ak2,
                                       one_rec.a2,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_FIID,
                                       v_ak4,
                                       one_rec.a4,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       one_rec.t_Contract,
                                       'Финансовый результат при частичном погашении, не включаемый в НОБ',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_OUT,
                                       3,
                                       RSI_NPTXC.TXOBJ_FR_TS_0,
                                       v_R,
                                       RSI_RSB_FIInstr.NATCUR,
                                       v_ak1,
                                       one_rec.a1,
                                       v_ak2,
                                       one_rec.a2,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_FIID,
                                       v_ak4,
                                       one_rec.a4,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       one_rec.t_Contract,
                                       'Финансовый результат при частичном погашении, не включаемый в НОБ',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Расчет объектов НДР по сделкам РЕПО
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pContract ID Договора
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects3_6(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pTechnical IN NUMBER,
                                pRecalc    IN CHAR,
                                pExistTechCalc IN NUMBER,
                                pContract   IN NUMBER,
                                pTransfDate IN DATE,
                                pTransfKind IN NUMBER,
                                pDateNDR    IN DATE,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

    v_D NUMBER;
    v_R NUMBER;

    v_C1 NUMBER;
    v_C2 NUMBER;

    v_C2N0 NUMBER;
    v_C2F0 NUMBER;

    v_Technical CHAR := CHR(0);
  BEGIN

    pStat := 0;

    FOR one_rec IN (SELECT Tick.t_DealID, Tick.t_DealDate,
                           Leg.t_PFI, 
                           Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID
                      FROM (SELECT DISTINCT N.t_Analitic1
                              FROM dnptxobj_dbt N 
                             WHERE N.t_Kind IN (RSI_NPTXC.TXOBJ_PROCNORM, RSI_NPTXC.TXOBJ_PROCFACT) 
                               AND N.t_Direction     = RSI_NPTXC.TXOBJ_DIR_OUT
                               AND N.t_AnaliticKind1 = RSI_NPTXC.TXOBJ_KIND1010
                               AND N.t_Client        = pClient
                               AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                               AND N.t_Date         >= pBegDate
                               AND N.t_Date         <= pEndDate 
                           )od, 
                           ddl_tick_dbt Tick, ddl_leg_dbt Leg, 
                           (SELECT t_Kind_Operation 
                              FROM doprkoper_dbt 
                             WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC 
                               AND Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(t_SysTypes)) = 1) Opr 
                     WHERE Tick.t_DealID = od.t_Analitic1
                       AND Opr.t_Kind_Operation = Tick.t_DealType
                       AND ( (Tick.t_ClientID = pClient  AND RSI_NPTO.CheckContrIIS(Tick.t_ClientContrID) = pIIS 
                              AND ((pContract IS NULL) OR (pContract <= 0) OR (Tick.t_ClientContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                             ) 
                            OR (Tick.t_PartyID = pClient AND Tick.t_IsPartyClient = 'X' AND RSI_NPTO.CheckContrIIS(Tick.t_PartyContrID) = pIIS 
                                AND ((pContract IS NULL) OR (pContract <= 0) OR (Tick.t_PartyContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                               )
                           )
                       AND Leg.t_DealID  = Tick.t_DealID 
                       AND Leg.t_LegID   = 0 
                       AND Leg.t_LegKind = 0
                       AND Leg.t_PFI     = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)   
                       AND RSI_NPTX.CheckCateg(RSB_SECUR.OBJTYPE_SECDEAL, 23, LPAD(Tick.t_DealID, 34, '0'), 2)<>1 --категория "Является налоговым Репо" на сделке DDL_TICK.T_DEALID не задана или не равна False
                    )
    LOOP

      v_C1 := GetSumByDealWithSign_0(pClient, one_rec.t_DealID, RSI_NPTXC.TXOBJ_PROCREPOTAX, pBegDate, pEndDate);

      v_C2N0 := GetNPTXOBJSumByDeal_0(pClient, one_rec.t_DealID, RSI_NPTXC.TXOBJ_PROCNORM, pBegDate, pEndDate, RSI_NPTXC.TXOBJ_DIR_OUT); 
      v_C2F0 := GetNPTXOBJSumByDeal_0(pClient, one_rec.t_DealID, RSI_NPTXC.TXOBJ_PROCFACT, pBegDate, pEndDate, RSI_NPTXC.TXOBJ_DIR_OUT); 

      IF v_C2N0 > v_C2F0 THEN 
        v_C2 := -v_C2F0; 
      ELSE 
        v_C2 := -v_C2N0;
      END IF;

      GetSumDR(v_C1, v_C2, v_D, v_R);

      IF v_D <> 0 OR v_R <> 0 THEN
        v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate);
        v_TaxGroup  := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);
      END IF;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_PROCREPOTAX,
                                           3,
                                           RSI_NPTXC.TXOBJ_KIND1010,
                                           one_rec.t_DealID,
                                           0,
                                           -1,
                                           RSI_NPTXC.TXOBJ_KIND3010,
                                           one_rec.t_PFI,
                                           RSI_NPTXC.TXOBJ_KIND4010,
                                           v_Circulate,
                                           RSI_NPTXC.TXOBJ_KIND5010,
                                           v_TaxGroup,
                                           RSI_NPTXC.TXOBJ_KIND6020,
                                           (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END),
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_IN,
                                       3,
                                       RSI_NPTXC.TXOBJ_PROCREPOTAX,
                                       v_D,
                                       RSI_RSB_FIInstr.NATCUR,
                                       RSI_NPTXC.TXOBJ_KIND1010,
                                       one_rec.t_DealID,
                                       0,
                                       -1,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_PFI,
                                       RSI_NPTXC.TXOBJ_KIND4010,
                                       v_Circulate,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END),
                                       'Проценты РЕПО, принимаемые к налогообложению',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_OUT,
                                       3,
                                       RSI_NPTXC.TXOBJ_PROCREPOTAX,
                                       v_R,
                                       RSI_RSB_FIInstr.NATCUR,
                                       RSI_NPTXC.TXOBJ_KIND1010,
                                       one_rec.t_DealID,
                                       0,
                                       -1,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_PFI,
                                       RSI_NPTXC.TXOBJ_KIND4010,
                                       v_Circulate,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END),
                                       'Проценты РЕПО, принимаемые к налогообложению',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Расчет объектов НДР по сделкам РЕПО
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pContract ID Договора
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects3_7(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pTechnical IN NUMBER,
                                pRecalc    IN CHAR,
                                pExistTechCalc IN NUMBER,
                                pContract   IN NUMBER,
                                pTransfDate IN DATE,
                                pTransfKind IN NUMBER,
                                pDateNDR    IN DATE,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

    v_D NUMBER;
    v_R NUMBER;

    v_C1 NUMBER;
    v_C2 NUMBER;

    v_C2F0 NUMBER;

    v_Technical CHAR := CHR(0);
  BEGIN

    pStat := 0;

    FOR one_rec IN (SELECT Tick.t_DealID, Tick.t_DealDate,
                           Leg.t_PFI, 
                           Tick.t_ClientContrID, Tick.t_IsPartyClient, Tick.t_PartyContrID
                      FROM (SELECT DISTINCT N.t_Analitic1
                              FROM dnptxobj_dbt N 
                             WHERE N.t_Kind          = RSI_NPTXC.TXOBJ_PROCFACT 
                               AND N.t_Direction     = RSI_NPTXC.TXOBJ_DIR_IN
                               AND N.t_AnaliticKind1 = RSI_NPTXC.TXOBJ_KIND1010
                               AND N.t_Client        = pClient
                               AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                               AND N.t_Date         >= pBegDate
                               AND N.t_Date         <= pEndDate 
                           )od, 
                           ddl_tick_dbt Tick, ddl_leg_dbt Leg, 
                           (SELECT t_Kind_Operation 
                              FROM doprkoper_dbt 
                             WHERE t_DocKind = RSB_SECUR.DL_SECURITYDOC 
                               AND Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(t_SysTypes)) = 1) Opr 
                     WHERE Tick.t_DealID = od.t_Analitic1
                       AND Opr.t_Kind_Operation = Tick.t_DealType
                       AND ( (Tick.t_ClientID = pClient  AND RSI_NPTO.CheckContrIIS(Tick.t_ClientContrID) = pIIS 
                              AND ((pContract IS NULL) OR (pContract <= 0) OR (Tick.t_ClientContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                             ) 
                            OR (Tick.t_PartyID = pClient AND Tick.t_IsPartyClient = 'X' AND RSI_NPTO.CheckContrIIS(Tick.t_PartyContrID) = pIIS 
                                AND ((pContract IS NULL) OR (pContract <= 0) OR (Tick.t_PartyContrID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                               )
                           ) 
                       AND Leg.t_DealID  = Tick.t_DealID 
                       AND Leg.t_LegID   = 0 
                       AND Leg.t_LegKind = 0
                       AND Leg.t_PFI     = (CASE WHEN pFIID != -1 THEN pFIID ELSE Leg.t_PFI END)   
                       AND RSI_NPTX.CheckCateg(RSB_SECUR.OBJTYPE_SECDEAL, 23, LPAD(Tick.t_DealID, 34, '0'), 2)<>1 --категория "Является налоговым Репо" на сделке DDL_TICK.T_DEALID не задана или не равна False
                   )
    LOOP

      v_C1 := GetSumByDealWithSign_0(pClient, one_rec.t_DealID, RSI_NPTXC.TXOBJ_PROCREPOTAX, pBegDate, pEndDate);

      v_C2F0 := GetNPTXOBJSumByDeal_0(pClient, one_rec.t_DealID, RSI_NPTXC.TXOBJ_PROCFACT, pBegDate, pEndDate, RSI_NPTXC.TXOBJ_DIR_IN); 

      v_C2 := v_C2F0; 

      GetSumDR(v_C1, v_C2, v_D, v_R);

      IF v_D <> 0 OR v_R <> 0 THEN
        v_Circulate := GetSetCirculate(one_rec.t_PFI, one_rec.t_DealDate); 
        v_TaxGroup := npto.GetPaperTaxGroupNPTX(one_rec.t_PFI);
      END IF;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_PROCREPOTAX,
                                           3,
                                           RSI_NPTXC.TXOBJ_KIND1010,
                                           one_rec.t_DealID,
                                           0,
                                           -1,
                                           RSI_NPTXC.TXOBJ_KIND3010,
                                           one_rec.t_PFI,
                                           RSI_NPTXC.TXOBJ_KIND4010,
                                           v_Circulate,
                                           RSI_NPTXC.TXOBJ_KIND5010,
                                           v_TaxGroup,
                                           RSI_NPTXC.TXOBJ_KIND6020,
                                           (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END),
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_IN,
                                       3,
                                       RSI_NPTXC.TXOBJ_PROCREPOTAX,
                                       v_D,
                                       RSI_RSB_FIInstr.NATCUR,
                                       RSI_NPTXC.TXOBJ_KIND1010,
                                       one_rec.t_DealID,
                                       0,
                                       -1,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_PFI,
                                       RSI_NPTXC.TXOBJ_KIND4010,
                                       v_Circulate,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END),
                                       'Проценты РЕПО, принимаемые к налогообложению',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       RSI_NPTXC.TXOBJ_DIR_OUT,
                                       3,
                                       RSI_NPTXC.TXOBJ_PROCREPOTAX,
                                       v_R,
                                       RSI_RSB_FIInstr.NATCUR,
                                       RSI_NPTXC.TXOBJ_KIND1010,
                                       one_rec.t_DealID,
                                       0,
                                       -1,
                                       RSI_NPTXC.TXOBJ_KIND3010,
                                       one_rec.t_PFI,
                                       RSI_NPTXC.TXOBJ_KIND4010,
                                       v_Circulate,
                                       RSI_NPTXC.TXOBJ_KIND5010,
                                       v_TaxGroup,
                                       RSI_NPTXC.TXOBJ_KIND6020,
                                       (CASE WHEN one_rec.t_IsPartyClient = 'X' THEN one_rec.t_PartyContrID ELSE one_rec.t_ClientContrID END),
                                       'Проценты РЕПО, принимаемые к налогообложению',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;
  END;

  --Расчет объектов НДР по связям КП
  PROCEDURE CreateTaxObjects3_8(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pTechnical IN NUMBER,
                                pRecalc    IN CHAR,
                                pExistTechCalc IN NUMBER,
                                pContract   IN NUMBER,
                                pTransfDate IN DATE,
                                pTransfKind IN NUMBER,
                                pDateNDR    IN DATE,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Circulate NUMBER;
    v_TaxGroup  NUMBER;

    v_D   NUMBER;
    v_R   NUMBER;
    v_D_1 NUMBER;
    v_R_1 NUMBER;

    v_C1   NUMBER;
    v_C2   NUMBER;
    v_C1_1 NUMBER;
    v_C2_1 NUMBER;


    v_MainS0  NUMBER;
    v_MainB0  NUMBER;
    v_CM      NUMBER;
    v_DSC     NUMBER;
    v_NPS     NUMBER;
    v_NPB     NUMBER;
    v_FR      NUMBER;

    v_ObjKind NUMBER;
    v_Holding_Period NUMBER := 0;

    v_CalcInv    NUMBER := 0;

    v_Technical CHAR := CHR(0);

    v_prevLnkID       NUMBER := 0;
    v_AllWrtAmount    NUMBER := 0;
    v_WrtOpAmount     NUMBER := 0;
    v_RestWrtOpAmount NUMBER := 0;
    v_RestD           NUMBER := 0;
    v_RestR           NUMBER := 0;
    v_RestD_1         NUMBER := 0;
    v_RestR_1         NUMBER := 0;
    v_SD              NUMBER := 0;
    v_SR              NUMBER := 0;
    v_SD_1            NUMBER := 0;
    v_SR_1            NUMBER := 0;
  BEGIN

    pStat := 0;

    IF pIIS = 0 AND GetPartyResident(pClient, pEndDate) = RSI_NPTXC.NPTXPARTY_RESIDENT THEN

      SELECT (CASE WHEN (NPTO.IsExistsAttr(RSB_SECUR.OBJTYPE_PARTY, LPAD(pClient, 10, '0'), 73, TRUNC(pEndDate), pEndDate, '2') = 0) THEN 1 ELSE 0 END) 
        INTO v_CalcInv 
        FROM DUAL;

      IF v_CalcInv != 0 THEN

        DELETE FROM DNPTXOP1OPLNK_TMP;

        --Вставим все подходящие связи во временную таблицу
        INSERT INTO DNPTXOP1OPLNK_TMP (T_DOCID, T_PARENT_DOCID, T_AMOUNT)
        WITH sf as (SELECT t_PartyID, t_ID 
                      FROM dsfcontr_dbt 
                     WHERE t_PartyID = pClient 
                       AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS 
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                   )
        SELECT DISTINCT S.t_ID, S.t_ID, S.T_AMOUNT 
          FROM dnptxlnk_dbt S, sf, v_npx_dnptxlot LB, v_npx_dnptxlot LS, ddl_tick_dbt tks 
         WHERE S.t_Type = RSI_NPTXC.NPTXLNK_DELIVER 
           AND S.t_Date >= pBegDate
           AND S.t_Date <= pEndDate
           AND S.t_Client = pClient
           AND RSI_NPTO.CheckContrIIS(S.t_Contract) = pIIS
           AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_GO
           AND LS.t_Origin <> RSI_NPTXC.NPTXLOTORIGIN_IN
           AND S.t_BuyID  = LB.t_ID 
           AND S.t_SaleID = LS.t_ID 
           AND LB.t_BuyDate > TO_DATE('31.12.2013','DD.MM.YYYY')
           AND tks.t_BOfficeKind = LS.t_DocKind
           AND tks.t_DealID = LS.t_DocID;

        AddChildLinksToTMP(pDocID, pBegDate, pEndDate, FALSE);


        FOR one_rec IN (SELECT /*+ leading(TMP) index(S DNPTXLNK_DBT_IDX0) index(PS DNPTXLNK_DBT_IDX0) index(LB DNPTXLOT_DBT_IDX0) index(LS DNPTXLOT_DBT_IDX0) index(PLB DNPTXLOT_DBT_IDX0) index(PLS DNPTXLOT_DBT_IDX0)*/
                               PLS.t_AnaliticKind1, PLS.t_Analitic1, 
                               PS.t_ID, PS.t_FIID, PS.t_Contract, PS.t_Amount as PSAmount,  
                               (MONTHS_BETWEEN(PLS.T_SALEDATE, (CASE WHEN PLB.T_GOID > 0 THEN NVL((SELECT CASE WHEN     CM.T_CONSIDERFIRSTBUYDATE = 'X' 
                                                                                                                    AND PLS.T_SALEDATE >= TO_DATE('01.01.2024','DD.MM.YYYY') 
                                                                                                                    AND RSB_FIInstr.FI_AvrKindsGetRoot(Fin.t_FI_Kind, Fin.t_AvoirKind) = RSI_RSB_FIINSTR.AVOIRKIND_SHARE
                                                                                                                    AND RSB_FIInstr.FI_AvrKindsGetRoot(F.t_FI_Kind, F.t_AvoirKind) = RSI_RSB_FIINSTR.AVOIRKIND_DEPOSITORY_RECEIPT
                                                                                                                    THEN PLB.t_BegBuyDate
                                                                                                               WHEN     CM.T_CONSIDERFIRSTBUYDATE = 'X' 
                                                                                                                    AND RSB_FIInstr.FI_AvrKindsGetRoot(Fin.t_FI_Kind, Fin.t_AvoirKind) = RSI_RSB_FIINSTR.AVOIRKIND_SHARE
                                                                                                                    AND RSB_FIInstr.FI_AvrKindsGetRoot(F.t_FI_Kind, F.t_AvoirKind) <> RSI_RSB_FIINSTR.AVOIRKIND_DEPOSITORY_RECEIPT
                                                                                                                    THEN PLB.t_BegBuyDate      
                                                                                                               ELSE CM.T_CORPACTIONDATE END
                                                                                                     FROM DNPTXGO_DBT GO, DDL_COMM_DBT CM, DFININSTR_DBT F
                                                                                                    WHERE PLB.T_GOID > 0
                                                                                                      AND GO.T_ID = PLB.T_GOID
                                                                                                      AND GO.T_KIND = RSI_NPTXC.NPTXLOTORIGIN_GO
                                                                                                      AND CM.T_DOCKIND = GO.T_DOCKIND
                                                                                                      AND CM.T_DOCUMENTID = GO.T_DOCUMENTID
                                                                                                      AND CM.T_OPERSUBKIND = 1 /*Конвертация*/
                                                                                                      AND F.T_FIID = CM.T_FIID
                                                                                                  ), PLB.t_BegBuyDate)
                                                                                         ELSE LB.T_BUYDATE END))/12) Period, 
                               PLS.t_DealDate SaleDealDate, (CASE WHEN PLB.T_GOID > 0 THEN NVL((SELECT CASE WHEN     CM.T_CONSIDERFIRSTBUYDATE = 'X' 
                                                                                                                 AND PLS.T_SALEDATE >= TO_DATE('01.01.2024','DD.MM.YYYY') 
                                                                                                                 AND RSB_FIInstr.FI_AvrKindsGetRoot(Fin.t_FI_Kind, Fin.t_AvoirKind) = RSI_RSB_FIINSTR.AVOIRKIND_SHARE
                                                                                                                 AND RSB_FIInstr.FI_AvrKindsGetRoot(F.t_FI_Kind, F.t_AvoirKind) = RSI_RSB_FIINSTR.AVOIRKIND_DEPOSITORY_RECEIPT
                                                                                                                 THEN PLB.t_BegBuyDate 
                                                                                                            WHEN     CM.T_CONSIDERFIRSTBUYDATE = 'X' 
                                                                                                                 AND RSB_FIInstr.FI_AvrKindsGetRoot(Fin.t_FI_Kind, Fin.t_AvoirKind) = RSI_RSB_FIINSTR.AVOIRKIND_SHARE
                                                                                                                 AND RSB_FIInstr.FI_AvrKindsGetRoot(F.t_FI_Kind, F.t_AvoirKind) <> RSI_RSB_FIINSTR.AVOIRKIND_DEPOSITORY_RECEIPT
                                                                                                                 THEN PLB.t_BegBuyDate
                                                                                                            ELSE CM.T_CORPACTIONDATE END 
                                                                                                  FROM DNPTXGO_DBT GO, DDL_COMM_DBT CM, DFININSTR_DBT F
                                                                                                 WHERE PLB.T_GOID > 0
                                                                                                   AND GO.T_ID = PLB.T_GOID
                                                                                                   AND GO.T_KIND = RSI_NPTXC.NPTXLOTORIGIN_GO
                                                                                                   AND CM.T_DOCKIND = GO.T_DOCKIND
                                                                                                   AND CM.T_DOCUMENTID = GO.T_DOCUMENTID
                                                                                                   AND CM.T_OPERSUBKIND = 1 /*Конвертация*/
                                                                                                   AND F.T_FIID = CM.T_FIID
                                                                                               ), PLB.t_BegBuyDate) ELSE PLB.t_DealDate END) BuyDealDate,
                               TMP.t_Amount SAmount, TMP.t_Amount1 as WrtOpAmount, TMP.t_Amount2 as WrtLnkAmount, TMP.T_PARENT_DOCID as Parent_LnkID, S.t_ID as ChID,
                               NVL((SELECT SUM((GetSumByLnkWithSign_0(TMP1.t_DocID, RSI_NPTXC.TXOBJ_TAX_LINK, g_ZeroDate, pEndDate) + GetSumByLnkWithSign_0_tmp(TMP1.t_DocID, RSI_NPTXC.TXOBJ_TAX_LINK, g_ZeroDate, pEndDate))/TMP1.t_Amount2*TMP1.t_Amount) 
                                      FROM DNPTXOP1OPLNK_TMP TMP1 
                                     WHERE TMP1.T_PARENT_DOCID = PS.T_ID 
                                       AND TMP1.T_DOCID <> TMP1.T_PARENT_DOCID
                                   ), 0) SumChFR,
                               NVL((SELECT SUM(TMP1.t_Amount) 
                                      FROM DNPTXOP1OPLNK_TMP TMP1 
                                     WHERE TMP1.T_PARENT_DOCID = PS.T_ID 
                                       AND TMP1.T_DOCID <> TMP1.T_PARENT_DOCID
                                   ), 0) SumSAmount
                          FROM dnptxlnk_dbt S, v_npx_dnptxlot LB, v_npx_dnptxlot LS, dfininstr_dbt Fin, dparty_dbt issuer, DNPTXOP1OPLNK_TMP TMP, dnptxlnk_dbt PS, v_npx_dnptxlot PLB, v_npx_dnptxlot PLS 
                         WHERE S.t_ID = TMP.T_DOCID
                           AND PS.t_ID = TMP.T_PARENT_DOCID 
                           AND S.t_BuyID  = LB.t_ID 
                           AND S.t_SaleID = LS.t_ID
                           AND PS.t_BuyID  = PLB.t_ID 
                           AND PS.t_SaleID = PLS.t_ID
                           AND Fin.t_FIID = PS.T_FIID
                           AND (MONTHS_BETWEEN(PLS.T_SALEDATE, (CASE WHEN PLB.T_GOID > 0 THEN NVL((SELECT CASE WHEN     CM.T_CONSIDERFIRSTBUYDATE = 'X' 
                                                                                                                    AND PLS.T_SALEDATE >= TO_DATE('01.01.2024','DD.MM.YYYY') 
                                                                                                                    AND RSB_FIInstr.FI_AvrKindsGetRoot(Fin.t_FI_Kind, Fin.t_AvoirKind) = RSI_RSB_FIINSTR.AVOIRKIND_SHARE
                                                                                                                    AND RSB_FIInstr.FI_AvrKindsGetRoot(F.t_FI_Kind, F.t_AvoirKind) = RSI_RSB_FIINSTR.AVOIRKIND_DEPOSITORY_RECEIPT
                                                                                                                    THEN PLB.t_BegBuyDate 
                                                                                                               WHEN     CM.T_CONSIDERFIRSTBUYDATE = 'X' 
                                                                                                                    AND RSB_FIInstr.FI_AvrKindsGetRoot(Fin.t_FI_Kind, Fin.t_AvoirKind) = RSI_RSB_FIINSTR.AVOIRKIND_SHARE
                                                                                                                    AND RSB_FIInstr.FI_AvrKindsGetRoot(F.t_FI_Kind, F.t_AvoirKind) <> RSI_RSB_FIINSTR.AVOIRKIND_DEPOSITORY_RECEIPT
                                                                                                                    THEN PLB.t_BegBuyDate
                                                                                                               ELSE CM.T_CORPACTIONDATE END
                                                                                                     FROM DNPTXGO_DBT GO, DDL_COMM_DBT CM, DFININSTR_DBT F
                                                                                                    WHERE PLB.T_GOID > 0
                                                                                                      AND GO.T_ID = PLB.T_GOID
                                                                                                      AND GO.T_KIND = RSI_NPTXC.NPTXLOTORIGIN_GO
                                                                                                      AND CM.T_DOCKIND = GO.T_DOCKIND
                                                                                                      AND CM.T_DOCUMENTID = GO.T_DOCUMENTID
                                                                                                      AND CM.T_OPERSUBKIND = 1 /*Конвертация*/
                                                                                                      AND F.T_FIID = CM.T_FIID
                                                                                                  ), PLB.t_BegBuyDate)
                                                                                         ELSE LB.T_BUYDATE END))/12) > 3 
                           AND issuer.t_PartyID = fin.t_Issuer
                           AND ( (TMP.T_DOCID <> TMP.T_PARENT_DOCID AND
                                  LB.T_BUYDATE <= TO_DATE('01.03.2022','DD.MM.YYYY') AND
                                  Rsb_SCTX.IsSPGetRate(LB.T_FIID, -1, Rsb_Common.GetRegIntValue('SECUR\ВИД КУРСА СРЕДНЕВЗВЕШЕННАЯ ЦЕНА', 0), TO_DATE('01.03.2022','DD.MM.YYYY'), TO_DATE('01.03.2022','DD.MM.YYYY')-add_months(TO_DATE('01.03.2022','DD.MM.YYYY'),-3), 'RUS') = 0
                                 )
                                 OR 
                                 ( TMP.T_DOCID = TMP.T_PARENT_DOCID AND
                                   (RSB_FIInstr.FI_AvrKindsGetRoot(Fin.t_FI_Kind, Fin.t_AvoirKind) = RSI_RSB_FIINSTR.AVOIRKIND_INVESTMENT_SHARE) AND 
                                   ((SELECT count(1) FROM davrinvst_dbt avrinvst WHERE avrinvst.t_fiid = Fin.t_FIID and avrinvst.T_TYPE = 1) > 0) AND
                                   (NPTO.GetCountryParty(Fin.T_ISSUER) = 'RUS') 
                                 ) 
                                 OR 
                                 ( 
                                   TMP.T_DOCID = TMP.T_PARENT_DOCID AND
                                   LS.T_SALEDATE < TO_DATE('01.01.2025','DD.MM.YYYY') AND 
                                   Rsb_SCTX.IsSPGetRate(LB.T_FIID, -1, Rsb_Common.GetRegIntValue('SECUR\ВИД КУРСА СРЕДНЕВЗВЕШЕННАЯ ЦЕНА', 0), LS.T_SALEDATE, LS.T_SALEDATE-add_months(LS.T_SALEDATE,-3), 'RUS') = 0 
                                 )
                                 OR
                                 (
                                   TMP.T_DOCID = TMP.T_PARENT_DOCID AND
                                   LS.T_SALEDATE >= TO_DATE('01.01.2025','DD.MM.YYYY') AND
                                   (   issuer.t_NotResident = CHR(0) 
                                    OR (RSB_SECUR.IsIssuerEAEU(fin.t_Issuer, LS.T_SALEDATE) = 1 AND
                                        (RSI_rsb_fiinstr.FI_AvrKindsEQ(RSI_RSB_FIInstr.FIKIND_AVOIRISS, RSI_RSB_FIInstr.AVOIRKIND_BOND, fin.t_AvoirKind) = 0 OR RSI_rsb_fiinstr.FI_AvrKindsEQ(RSI_RSB_FIInstr.FIKIND_AVOIRISS, RSI_RSB_FIInstr.AVOIRKIND_BOND_CORPORATE, fin.t_AvoirKind) = 1)
                                       )
                                   ) AND
                                   Rsb_SCTX.IsSPGetRate(LB.T_FIID, -1, Rsb_Common.GetRegIntValue('SECUR\ВИД КУРСА СРЕДНЕВЗВЕШЕННАЯ ЦЕНА', 0), LS.T_SALEDATE, LS.T_SALEDATE-add_months(LS.T_SALEDATE,-3), 'RUS') = 0 
                                 ) 
                               )
                           AND (TMP.T_DOCID <> TMP.T_PARENT_DOCID 
                                OR
                                (TMP.T_DOCID = TMP.T_PARENT_DOCID AND NOT EXISTS(SELECT 1 FROM DNPTXOP1OPLNK_TMP TMP1 WHERE TMP1.T_PARENT_DOCID = TMP.T_DOCID AND TMP1.T_DOCID <> TMP1.T_PARENT_DOCID))
                               )
                           --НАЧИНАЯ с 01.01.2025 (если дата реализации ц/б >= 01.01.2025):
                           --если на налоговом лоте из связи установлен признак "не учитывались на ИИС" = 1 (true),  
                           --иначе, если признак "не учитывались на ИИС" = 0 (false), эти лоты исключаются из расчета ЛДВ
                           AND (LS.T_SALEDATE < TO_DATE('01.01.2025','DD.MM.YYYY') 
                                OR
                                (LB.T_NOTCOUNTEDONIIS = CHR(88) AND LS.T_NOTCOUNTEDONIIS = CHR(88))
                               )
                         ORDER BY PS.T_ID, S.T_ID ASC
                        )
        LOOP

          v_TaxGroup := npto.GetPaperTaxGroupNPTX(one_rec.t_FIID);

          IF one_rec.ChID <> one_rec.Parent_LnkID THEN
            IF v_prevLnkID <> one_rec.t_ID THEN

              v_WrtOpAmount := one_rec.PSAmount;

              --Количество бумаг из связи замещения, по которым в текущей операции выполняется продажа замещенных бумаг
              v_RestWrtOpAMount := one_rec.PSAmount;


              v_MainS0 := GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINS, g_ZeroDate, pEndDate); 
              
              --Так как объект TXOBJ_TAX_LINK по текущей родителской связи мы рассчитывали до этого в этой же операции на этом шаге, то они находятся ещё во временной таблице
              v_FR :=   GetSumByLnkWithSign_0_tmp(one_rec.t_ID, RSI_NPTXC.TXOBJ_TAX_LINK, g_ZeroDate, pEndDate)/one_rec.PSAmount*one_rec.SumSAmount 
                      + one_rec.SumChFR;

              v_SD   := 0;
              v_SR   := 0;
              v_SD_1 := 0; 
              v_SR_1 := 0;
              v_ObjKind := 0;
              v_Holding_Period := 0;
              IF v_FR > 0 THEN
                v_C2 := v_MainS0 + GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_NKDS, g_ZeroDate, pEndDate);
                
                IF one_rec.Period > 3 THEN
                  v_ObjKind := RSI_NPTXC.TXOBJ_PLUSI;
                  v_Holding_Period := FLOOR(one_rec.Period);
                END IF;
                
                v_C1_1 := GetSumByLnkWithSign_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_FR_SEC_3Y, g_ZeroDate, pEndDate);
                v_C2_1 := v_FR;

                v_C1 := GetSumByLnkWithSign_0(one_rec.t_ID, v_ObjKind, g_ZeroDate, pEndDate);

                GetSumDR(v_C1, v_C2, v_SD, v_SR);
                GetSumDR(v_C1_1, v_C2_1, v_SD_1, v_SR_1);

              END IF;


              v_RestD := v_SD;
              v_RestR := v_SR;
              v_RestD_1 := v_SD_1;
              v_RestR_1 := v_SR_1;
            END IF;

            IF one_rec.SAmount = v_RestWrtOpAMount THEN
              v_D := v_RestD;
              v_R := v_RestR;
              v_D_1 := v_RestD_1;
              v_R_1 := v_RestR_1; 
            ELSE
              v_D := v_SD/v_WrtOpAmount*one_rec.SAmount;
              v_R := v_SR/v_WrtOpAmount*one_rec.SAmount;
              v_D_1 := v_SD_1/v_WrtOpAmount*one_rec.SAmount;
              v_R_1 := v_SR_1/v_WrtOpAmount*one_rec.SAmount;
            END IF;

            v_RestWrtOpAMount := v_RestWrtOpAMount - one_rec.SAmount;
            v_RestD := v_RestD - v_D; 
            v_RestR := v_RestR - v_R;
            v_RestD_1 := v_RestD_1 - v_D_1; 
            v_RestR_1 := v_RestR_1 - v_R_1;
          ELSE

            v_MainS0 := GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINS, g_ZeroDate, pEndDate); 
            v_MainB0 := GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_MAINB, g_ZeroDate, pEndDate); 
            v_CM     := CM(one_rec.t_ID, pEndDate);
            v_DSC    := DSC(one_rec.t_ID, pBegDate, pEndDate);
            v_NPS    := NPS(one_rec.t_ID, pEndDate);
            v_NPB    := NPB(one_rec.t_ID, pEndDate); 
            
            v_FR := v_MainS0 - v_MainB0 - v_CM - v_DSC + v_NPS - v_NPB;

            v_D   := 0;
            v_R   := 0;
            v_D_1 := 0; 
            v_R_1 := 0;
            v_ObjKind := 0;
            v_Holding_Period := 0;
            IF v_FR > 0 THEN
              v_C2 := v_MainS0 + GetNPTXOBJSumByLink_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_NKDS, g_ZeroDate, pEndDate);
              
              IF one_rec.Period > 3 THEN
                v_ObjKind := RSI_NPTXC.TXOBJ_PLUSI;
                v_Holding_Period := FLOOR(one_rec.Period);
              END IF;

              v_C1_1 := GetSumByLnkWithSign_0(one_rec.t_ID, RSI_NPTXC.TXOBJ_FR_SEC_3Y, pBegDate, pEndDate);
              v_C2_1 := v_FR;

              v_C1 := GetSumByLnkWithSign_0(one_rec.t_ID, v_ObjKind, pBegDate, pEndDate);

              GetSumDR(v_C1, v_C2, v_D, v_R);
              GetSumDR(v_C1_1, v_C2_1, v_D_1, v_R_1);

            END IF;
          END IF;

          v_Circulate := RSI_NPTXC.NPTX_FI_CIRCULATE;
          
          v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                               pBegDate,
                                               pEndDate,
                                               pClient,
                                               v_ObjKind,
                                               3,
                                               one_rec.t_AnaliticKind1,
                                               one_rec.t_Analitic1,
                                               RSI_NPTXC.TXOBJ_KIND2010,
                                               one_rec.t_ID,
                                               RSI_NPTXC.TXOBJ_KIND3010,
                                               one_rec.t_FIID,
                                               RSI_NPTXC.TXOBJ_KIND4010,
                                               v_Circulate,
                                               RSI_NPTXC.TXOBJ_KIND5010,
                                               v_TaxGroup,
                                               RSI_NPTXC.TXOBJ_KIND6020,
                                               one_rec.t_Contract,
                                               pTechnical,
                                               pRecalc,
                                               CHR(1),
                                               pTransfDate,
                                               pTransfKind,
                                               v_Holding_Period);

          nptxobj := CreateNPTXOBJLevel3_4(1,
                                           CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_DIR_IN,
                                           3,
                                           v_ObjKind,
                                           v_D,
                                           RSI_RSB_FIInstr.NATCUR,
                                           one_rec.t_AnaliticKind1,
                                           one_rec.t_Analitic1,
                                           RSI_NPTXC.TXOBJ_KIND2010,
                                           one_rec.t_ID,
                                           RSI_NPTXC.TXOBJ_KIND3010,
                                           one_rec.t_FIID,
                                           RSI_NPTXC.TXOBJ_KIND4010,
                                           v_Circulate,
                                           RSI_NPTXC.TXOBJ_KIND5010,
                                           v_TaxGroup,
                                           RSI_NPTXC.TXOBJ_KIND6020,
                                           one_rec.t_Contract,
                                           'Доходы от реализации ц/б (Число лет в собственности = '||TO_CHAR(v_Holding_Period)||')',
                                           pDocID,
                                           pStep,
                                           v_Technical,
                                           pRecalc,
                                           pExistTechCalc,
                                           pTransfDate,
                                           pTransfKind,
                                           v_Holding_Period);

          IF nptxobj.t_ID IS NOT NULL
          THEN
            nptxobj_ins.extend;
            nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
          END IF;

          nptxobj := CreateNPTXOBJLevel3_4(1,
                                           CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_DIR_OUT,
                                           3,
                                           v_ObjKind,
                                           v_R,
                                           RSI_RSB_FIInstr.NATCUR,
                                           one_rec.t_AnaliticKind1,
                                           one_rec.t_Analitic1,
                                           RSI_NPTXC.TXOBJ_KIND2010,
                                           one_rec.t_ID,
                                           RSI_NPTXC.TXOBJ_KIND3010,
                                           one_rec.t_FIID,
                                           RSI_NPTXC.TXOBJ_KIND4010,
                                           v_Circulate,
                                           RSI_NPTXC.TXOBJ_KIND5010,
                                           v_TaxGroup,
                                           RSI_NPTXC.TXOBJ_KIND6020,
                                           one_rec.t_Contract,
                                           'Доходы от реализации ц/б (Число лет в собственности = '||TO_CHAR(v_Holding_Period)||')',
                                           pDocID,
                                           pStep,
                                           v_Technical,
                                           pRecalc,
                                           pExistTechCalc,
                                           pTransfDate,
                                           pTransfKind,
                                           v_Holding_Period);

          IF nptxobj.t_ID IS NOT NULL
          THEN
            nptxobj_ins.extend;
            nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
          END IF;

          nptxobj := CreateNPTXOBJLevel3_4(1,
                                           CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_DIR_IN,
                                           3,
                                           RSI_NPTXC.TXOBJ_FR_SEC_3Y,
                                           v_D_1,
                                           RSI_RSB_FIInstr.NATCUR,
                                           one_rec.t_AnaliticKind1,
                                           one_rec.t_Analitic1,
                                           RSI_NPTXC.TXOBJ_KIND2010,
                                           one_rec.t_ID,
                                           RSI_NPTXC.TXOBJ_KIND3010,
                                           one_rec.t_FIID,
                                           RSI_NPTXC.TXOBJ_KIND4010,
                                           v_Circulate,
                                           RSI_NPTXC.TXOBJ_KIND5010,
                                           v_TaxGroup,
                                           RSI_NPTXC.TXOBJ_KIND6020,
                                           one_rec.t_Contract,
                                           'Финансовый результат по ц/б от 3 лет в собственности',
                                           pDocID,
                                           pStep,
                                           v_Technical,
                                           pRecalc,
                                           pExistTechCalc,
                                           pTransfDate,
                                           pTransfKind);

          IF nptxobj.t_ID IS NOT NULL
          THEN
            nptxobj_ins.extend;
            nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
          END IF;

          nptxobj := CreateNPTXOBJLevel3_4(1,
                                           CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_DIR_OUT,
                                           3,
                                           RSI_NPTXC.TXOBJ_FR_SEC_3Y,
                                           v_R_1,
                                           RSI_RSB_FIInstr.NATCUR,
                                           one_rec.t_AnaliticKind1,
                                           one_rec.t_Analitic1,
                                           RSI_NPTXC.TXOBJ_KIND2010,
                                           one_rec.t_ID,
                                           RSI_NPTXC.TXOBJ_KIND3010,
                                           one_rec.t_FIID,
                                           RSI_NPTXC.TXOBJ_KIND4010,
                                           v_Circulate,
                                           RSI_NPTXC.TXOBJ_KIND5010,
                                           v_TaxGroup,
                                           RSI_NPTXC.TXOBJ_KIND6020,
                                           one_rec.t_Contract,
                                           'Финансовый результат по ц/б от 3 лет в собственности',
                                           pDocID,
                                           pStep,
                                           v_Technical,
                                           pRecalc,
                                           pExistTechCalc,
                                           pTransfDate,
                                           pTransfKind);

          IF nptxobj.t_ID IS NOT NULL
          THEN
            nptxobj_ins.extend;
            nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
          END IF;

          IF nptxobj_ins.COUNT >= g_Limit THEN
            FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
                 INSERT INTO DNPTXOBJ_TMP
                      VALUES nptxobj_ins(indx);

            nptxobj_ins.Delete;
            nptxobj_ins := nptxobj_t();
          END IF;

          v_prevLnkID := one_rec.t_ID;

        END LOOP;

        IF nptxobj_ins.COUNT > 0 THEN
          FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
               INSERT INTO DNPTXOBJ_TMP
                    VALUES nptxobj_ins(indx);

          nptxobj_ins.Delete;
        END IF;
      END IF;
    END IF;

  END;

  FUNCTION GetOperDate(pDocID IN NUMBER) RETURN DATE
  AS
    v_OperDate DATE;
  BEGIN

    SELECT t_OperDate INTO v_OperDate FROM dnptxop_dbt WHERE t_ID = pDocID;

    RETURN v_OperDate;
  END;


  /**
  @brief Суммарные расходы по облигациям, где погашение не облагается налогом
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_1(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pContract  IN NUMBER, 
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pTechnical IN NUMBER,
                                pRecalc    IN CHAR,
                                pExistTechCalc IN NUMBER,
                                pTransfDate IN DATE,
                                pTransfKind IN NUMBER,
                                pDateNDR    IN DATE,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;
    
    v_SubKind_Operation NUMBER;
    v_Technical CHAR := CHR(0);

    v_OperDate DATE;
  BEGIN

    pStat := 0;

    v_OperDate := GetOperDate(pDocID);

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_OUT;

    FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, 
                           (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6,
                           NVL(sum( (CASE WHEN N.t_Kind = RSI_NPTXC.TXOBJ_DISCB 
                                          THEN -N.t_Sum0 
                                          ELSE  N.t_Sum0 END 
                                   ) 
                                  ), 0 
                              ) C2 
                      FROM dnptxobj_dbt N, v_npx_dnptxlot LS 
                     WHERE N.t_Client = pClient 
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6 ) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_Direction = v_d
                       AND (  N.t_Kind IN (RSI_NPTXC.TXOBJ_MAINB,
                                           RSI_NPTXC.TXOBJ_COMB,
                                           RSI_NPTXC.TXOBJ_MATERIALB,
                                           RSI_NPTXC.TXOBJ_TAXPM_LINK,
                                           RSI_NPTXC.TXOBJ_DISCB,
                                           RSI_NPTXC.TXOBJ_DIFB
                                         ) 
                          OR rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\ВКЛ. КОМ. С ПРОД. В РАСЧ. ДОХ.', CASE WHEN pIIS = 1 THEN v_OperDate ELSE N.t_Date END) <> 'X' 
                             AND N.t_Kind = RSI_NPTXC.TXOBJ_COMS
                           )
                       AND (CASE WHEN N.t_Kind = RSI_NPTXC.TXOBJ_MATERIALB THEN (CASE WHEN IsIncludeMaterialInOut <> 0 THEN 1 ELSE 0 END) ELSE 1 END) = 1 
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind3 = v_ak3
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND N.t_Analitic5 = RSI_NPTXC.TXGROUP_50
                       AND N.t_AnaliticKind1 = LS.t_AnaliticKind1 
                       AND N.t_Analitic1 = LS.t_Analitic1 
                       AND LS.t_Kind  = RSI_NPTXC.NPTXLOTS_SALE
                       AND LS.t_DocKind != RSB_SECUR.DL_RETIREMENT
                       AND (N.t_Kind != RSI_NPTXC.TXOBJ_DIFB OR
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010 AND
                             Exists( select 1 
                                       from dnptxobj_dbt NL 
                                      where NL.t_Direction = RSI_NPTXC.TXOBJ_DIR_OUT 
                                        and NL.t_Kind = RSI_NPTXC.TXOBJ_FR_LINK
                                        and NL.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
                                        and NL.t_Analitic2 = N.t_Analitic2 
                                        and NL.t_Client = pClient
                                        and RSI_NPTO.CheckObjIIS (NL.t_AnaliticKind6, NL.t_Analitic6 ) = pIIS
                                   ) 
                            ) 
                           ) 
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                     GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_MINUS_SEC, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

      v_S := v_C2 - v_C1;

      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_MINUS_SEC,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           v_ak3,
                                           one_rec.a3,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6,
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       v_d,
                                       4,
                                       RSI_NPTXC.TXOBJ_MINUS_SEC,
                                       v_S,
                                       RSI_RSB_FIInstr.NATCUR,
                                       0,
                                       -1,
                                       0,
                                       -1,
                                       v_ak3,
                                       one_rec.a3,
                                       v_ak4,
                                       one_rec.a4,
                                       v_ak5,
                                       one_rec.a5,
                                       one_rec.t_AnaliticKind6,
                                       one_rec.t_Analitic6,
                                       'Суммарные расходы по облигациям, где погашение не облагается налогом',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Суммарные расходы по обычным облигациям
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_2(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pContract  IN NUMBER, 
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pTechnical IN NUMBER,
                                pRecalc    IN CHAR,
                                pExistTechCalc IN NUMBER,
                                pTransfDate IN DATE,
                                pTransfKind IN NUMBER,
                                pDateNDR    IN DATE,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;
    
    v_Technical CHAR := CHR(0);

    v_OperDate DATE;
    v_NKDBTS_Flag CHAR(1) := CHR(0);
  BEGIN

    pStat := 0;

    v_OperDate := GetOperDate(pDocID);

    v_NKDBTS_Flag := rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\УЧЕТ_NKDB_TS_В_ДОХ', v_OperDate);

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_OUT;  --Расход

    FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, NVL(SUM(N.t_Sum0), 0) C2, 
                           (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6
                      FROM dnptxobj_dbt N 
                     WHERE N.t_Client = pClient
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6 ) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_Direction = v_d
                       AND (  N.t_Kind IN (RSI_NPTXC.TXOBJ_MAINB,
                                           RSI_NPTXC.TXOBJ_MAINB_TS,
                                           RSI_NPTXC.TXOBJ_COMB,
                                           RSI_NPTXC.TXOBJ_COMB_TS,
                                           RSI_NPTXC.TXOBJ_MATERIALB,
                                           RSI_NPTXC.TXOBJ_MATERIALB_TS,
                                           RSI_NPTXC.TXOBJ_DIFB,
                                           RSI_NPTXC.TXOBJ_DIFB_TS,
                                           RSI_NPTXC.TXOBJ_NKDB,
                                           RSI_NPTXC.TXOBJ_NKDB_TS,
                                           RSI_NPTXC.TXOBJ_TAXPM_LINK,
                                           RSI_NPTXC.TXOBJ_TAXPM_TS
                                          )
                              OR rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\ВКЛ. КОМ. С ПРОД. В РАСЧ. ДОХ.', CASE WHEN pIIS = 1 THEN v_OperDate ELSE N.t_Date END) <> 'X' 
                                                                                                                      AND N.t_Kind IN (RSI_NPTXC.TXOBJ_COMS,
                                                                                                                                       RSI_NPTXC.TXOBJ_COMS_TS
                                                                                                                                      )
                           )
                       AND (CASE WHEN N.t_Kind IN (RSI_NPTXC.TXOBJ_MATERIALB, RSI_NPTXC.TXOBJ_MATERIALB_TS) THEN (CASE WHEN IsIncludeMaterialInOut <> 0 THEN 1 ELSE 0 END) ELSE 1 END) = 1 
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind3 = v_ak3
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND (  N.t_Analitic5 = RSI_NPTXC.TXGROUP_20
                              OR (  N.t_Date >= TO_DATE('01.01.2021', 'DD.MM.YYYY') 
                                    AND N.t_Analitic5 = RSI_NPTXC.TXGROUP_40
                                 ) 
                           )
                       AND (N.t_Kind NOT IN (RSI_NPTXC.TXOBJ_MAINB_TS,
                                             RSI_NPTXC.TXOBJ_COMB_TS,
                                             RSI_NPTXC.TXOBJ_MATERIALB_TS,
                                             RSI_NPTXC.TXOBJ_DIFB_TS,
                                             RSI_NPTXC.TXOBJ_COMS_TS,
                                             RSI_NPTXC.TXOBJ_TAXPM_TS
                                            ) OR
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2020 AND
                             EXISTS( SELECT 1 
                                       FROM dnptxts_dbt T, dnptxlot_dbt LB 
                                      WHERE LB.t_Kind <> RSI_NPTXC.NPTXLOTS_BACKREPO
                                        AND N.t_Analitic2 = T.t_ID 
                                        AND T.t_BuyID     = LB.t_ID
                                   ) 
                            )
                           ) 
                       AND (N.t_Kind <> RSI_NPTXC.TXOBJ_DIFB_TS OR
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2020 AND
                             EXISTS( SELECT 1 
                                       FROM dnptxobj_dbt NL 
                                      WHERE NL.t_Direction = RSI_NPTXC.TXOBJ_DIR_OUT
                                        AND NL.t_Kind = RSI_NPTXC.TXOBJ_FR_TS
                                        AND NL.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2020
                                        AND NL.t_Analitic2 = N.t_Analitic2 
                                   ) 
                            )
                           ) 
                       AND (N.t_Kind <> RSI_NPTXC.TXOBJ_DIFB OR
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010 AND
                             EXISTS( SELECT 1 
                                       FROM dnptxobj_dbt NL 
                                      WHERE NL.t_Direction = RSI_NPTXC.TXOBJ_DIR_OUT
                                        AND NL.t_Kind = RSI_NPTXC.TXOBJ_FR_LINK
                                        AND NL.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
                                        AND NL.t_Analitic2 = N.t_Analitic2 
                                   ) 
                            )
                           ) 
                       AND ((v_NKDBTS_Flag = 'X') AND ( N.t_Kind <> RSI_NPTXC.TXOBJ_NKDB_TS OR
                                                       (N.t_AnaliticKind2 <> RSI_NPTXC.TXOBJ_KIND2030 AND
                                                        N.t_Kind = RSI_NPTXC.TXOBJ_NKDB_TS 
                                                       )
                                                      )
                            OR
                            (v_NKDBTS_Flag = CHR(0) AND NOT (N.t_Kind = RSI_NPTXC.TXOBJ_NKDB_TS AND
                                                             N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2030 AND
                                                             N.t_OutSystCode IN ('DEPO','ДЕПО')
                                                            )
                            )
                           )
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                     GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_MINUS_SEC, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

      v_S := v_C2 - v_C1;

      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_MINUS_SEC,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           v_ak3,
                                           one_rec.a3,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6,
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       v_d,
                                       4,
                                       RSI_NPTXC.TXOBJ_MINUS_SEC,
                                       v_S,
                                       RSI_RSB_FIInstr.NATCUR,
                                       0,
                                       -1,
                                       0,
                                       -1,
                                       v_ak3,
                                       one_rec.a3,
                                       v_ak4,
                                       one_rec.a4,
                                       v_ak5,
                                       one_rec.a5,
                                       one_rec.t_AnaliticKind6,
                                       one_rec.t_Analitic6,
                                       'Суммарные расходы по обычным облигациям',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Суммарные расходы по облигациям, где погашение облагается в обычном порядке, а проценты - льготные
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_3(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pContract  IN NUMBER, 
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pTechnical IN NUMBER,
                                pRecalc    IN CHAR,
                                pExistTechCalc IN NUMBER,
                                pTransfDate IN DATE,
                                pTransfKind IN NUMBER,
                                pDateNDR    IN DATE,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;
    
    v_Technical CHAR := CHR(0);

    v_OperDate DATE;
  BEGIN

    pStat := 0;

    v_OperDate := GetOperDate(pDocID);

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_OUT;  --Расход

    FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, 
                           (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6,
                           NVL(SUM( (CASE WHEN N.t_Kind = RSI_NPTXC.TXOBJ_DISCB 
                                          THEN -N.t_Sum0 
                                          ELSE  N.t_Sum0 END 
                                    ) 
                                  ), 0 
                              ) C2 
                      FROM dnptxobj_dbt N 
                     WHERE N.t_Client = pClient 
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_Direction = v_d
                       AND (  N.t_Kind IN (RSI_NPTXC.TXOBJ_MAINB,
                                           RSI_NPTXC.TXOBJ_MAINB_TS,
                                           RSI_NPTXC.TXOBJ_COMB,
                                           RSI_NPTXC.TXOBJ_COMB_TS,
                                           RSI_NPTXC.TXOBJ_MATERIALB,
                                           RSI_NPTXC.TXOBJ_MATERIALB_TS,
                                           RSI_NPTXC.TXOBJ_DIFB,
                                           RSI_NPTXC.TXOBJ_DIFB_TS,
                                           RSI_NPTXC.TXOBJ_TAXPM_LINK,
                                           RSI_NPTXC.TXOBJ_TAXPM_TS,
                                           RSI_NPTXC.TXOBJ_DISCB
                                          ) 
                              OR rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\ВКЛ. КОМ. С ПРОД. В РАСЧ. ДОХ.', CASE WHEN pIIS = 1 THEN v_OperDate ELSE N.t_Date END) <> 'X' AND N.t_Kind IN (RSI_NPTXC.TXOBJ_COMS, RSI_NPTXC.TXOBJ_COMS_TS)
                           )
                       AND (CASE WHEN N.t_Kind IN (RSI_NPTXC.TXOBJ_MATERIALB, RSI_NPTXC.TXOBJ_MATERIALB_TS) THEN (CASE WHEN IsIncludeMaterialInOut <> 0 THEN 1 ELSE 0 END) ELSE 1 END) = 1 
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind3 = v_ak3
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND (  N.t_Analitic5 = RSI_NPTXC.TXGROUP_30
                              OR (  N.t_Date < TO_DATE('01.01.2021', 'DD.MM.YYYY')
                                    AND N.t_Analitic5 = RSI_NPTXC.TXGROUP_40
                                 ) 
                           ) 
                       AND (N.t_Kind NOT IN (RSI_NPTXC.TXOBJ_MAINB_TS,
                                             RSI_NPTXC.TXOBJ_COMB_TS,
                                             RSI_NPTXC.TXOBJ_MATERIALB_TS,
                                             RSI_NPTXC.TXOBJ_DIFB_TS,
                                             RSI_NPTXC.TXOBJ_COMS_TS,
                                             RSI_NPTXC.TXOBJ_TAXPM_TS
                                            ) OR 
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2020 AND
                             EXISTS( SELECT 1 
                                       FROM dnptxts_dbt T, dnptxlot_dbt LB 
                                      WHERE LB.t_Kind <> RSI_NPTXC.NPTXLOTS_BACKREPO
                                        AND N.t_Analitic2 = T.t_ID 
                                        AND T.t_BuyID     = LB.t_ID
                                   ) 
                            )
                           ) 
                       AND (N.t_Kind <> RSI_NPTXC.TXOBJ_DIFB_TS OR
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2020 AND
                             EXISTS( SELECT 1 
                                       FROM dnptxobj_dbt NL 
                                      WHERE NL.t_Direction = RSI_NPTXC.TXOBJ_DIR_OUT
                                        AND NL.t_Kind = RSI_NPTXC.TXOBJ_FR_TS
                                        AND NL.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2020
                                        AND NL.t_Analitic2 = N.t_Analitic2 
                                   ) 
                            )
                           ) 

                       AND (N.t_Kind <> RSI_NPTXC.TXOBJ_DIFB OR
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010 AND
                             EXISTS( SELECT 1 
                                       FROM dnptxobj_dbt NL 
                                      WHERE NL.t_Direction = RSI_NPTXC.TXOBJ_DIR_OUT
                                        AND NL.t_Kind = RSI_NPTXC.TXOBJ_FR_LINK
                                        AND NL.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
                                        AND NL.t_Analitic2 = N.t_Analitic2 
                                   ) 
                            )
                           ) 
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                     GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_MINUS_SEC, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

      v_S := v_C2 - v_C1;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_MINUS_SEC,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           v_ak3,
                                           one_rec.a3,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6,
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       v_d,
                                       4,
                                       RSI_NPTXC.TXOBJ_MINUS_SEC,
                                       v_S,
                                       RSI_RSB_FIInstr.NATCUR,
                                       0,
                                       -1,
                                       0,
                                       -1,
                                       v_ak3,
                                       one_rec.a3,
                                       v_ak4,
                                       one_rec.a4,
                                       v_ak5,
                                       one_rec.a5,
                                       one_rec.t_AnaliticKind6,
                                       one_rec.t_Analitic6,
                                       'Суммарные расходы по облигациям, где погашение облагается в обычном порядке, а проценты - льготные',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Суммарные расходы по акциям
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_4(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pContract  IN NUMBER, 
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pTechnical IN NUMBER,
                                pRecalc    IN CHAR,
                                pExistTechCalc IN NUMBER,
                                pTransfDate IN DATE,
                                pTransfKind IN NUMBER,
                                pDateNDR    IN DATE,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;
    
    v_Technical CHAR := CHR(0);

    v_OperDate DATE;
  BEGIN

    pStat := 0;

    v_OperDate := GetOperDate(pDocID);

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_OUT;  --Расход

    FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, NVL(sum(N.t_Sum0), 0) C2, 
                           (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6 
                      FROM dnptxobj_dbt N 
                     WHERE N.t_Client = pClient 
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6 ) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_Direction = v_d
                       AND ( N.t_Kind IN ( RSI_NPTXC.TXOBJ_MAINB,
                                           RSI_NPTXC.TXOBJ_COMB,
                                           RSI_NPTXC.TXOBJ_MATERIALB,
                                           RSI_NPTXC.TXOBJ_TAXPM_LINK,
                                           RSI_NPTXC.TXOBJ_DIFB
                                         )
                             OR rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\ВКЛ. КОМ. С ПРОД. В РАСЧ. ДОХ.', CASE WHEN pIIS = 1 THEN v_OperDate ELSE N.t_Date END) <> 'X' AND N.t_Kind = RSI_NPTXC.TXOBJ_COMS
                           )
                       AND (CASE WHEN N.t_Kind = RSI_NPTXC.TXOBJ_MATERIALB THEN (CASE WHEN IsIncludeMaterialInOut <> 0 THEN 1 ELSE 0 END) ELSE 1 END) = 1 
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind3 = v_ak3
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND N.t_Analitic5 = RSI_NPTXC.TXGROUP_10
                       AND (N.t_Kind != RSI_NPTXC.TXOBJ_DIFB OR
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010 AND
                             EXISTS( SELECT 1 
                                       FROM dnptxobj_dbt NL 
                                      WHERE NL.t_Direction = RSI_NPTXC.TXOBJ_DIR_OUT
                                        AND NL.t_Kind = RSI_NPTXC.TXOBJ_FR_LINK
                                        AND NL.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
                                        AND NL.t_Analitic2 = N.t_Analitic2 
                                   ) 
                            ) 
                           ) 
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                     GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_MINUS_SEC, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

      v_S := v_C2 - v_C1;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_MINUS_SEC,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           v_ak3,
                                           one_rec.a3,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6, 
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       v_d,
                                       4,
                                       RSI_NPTXC.TXOBJ_MINUS_SEC,
                                       v_S,
                                       RSI_RSB_FIInstr.NATCUR,
                                       0,
                                       -1,
                                       0,
                                       -1,
                                       v_ak3,
                                       one_rec.a3,
                                       v_ak4,
                                       one_rec.a4,
                                       v_ak5,
                                       one_rec.a5,
                                       one_rec.t_AnaliticKind6, 
                                       one_rec.t_Analitic6,
                                       'Суммарные расходы по акциям',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Суммарные расходы по акциям и обычным облигациям по коротким позициям
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_5(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pContract  IN NUMBER, 
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pTechnical IN NUMBER,
                                pRecalc    IN CHAR,
                                pExistTechCalc IN NUMBER,
                                pTransfDate IN DATE,
                                pTransfKind IN NUMBER,
                                pDateNDR    IN DATE,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;
    
    v_Technical CHAR := CHR(0);

    v_OperDate DATE;
  BEGIN

    pStat := 0;

    v_OperDate := GetOperDate(pDocID);

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_OUT;  --Расход

    FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, NVL(SUM(N.t_Sum0), 0) C2, 
                           (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6 
                      FROM dnptxobj_dbt N 
                     WHERE N.t_Client = pClient
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_Direction = v_d
                       AND (  N.t_Kind IN (RSI_NPTXC.TXOBJ_MAINB_SHORT,
                                           RSI_NPTXC.TXOBJ_COMB_SHORT,
                                           RSI_NPTXC.TXOBJ_MATERIALB_SHORT,
                                           RSI_NPTXC.TXOBJ_NKDB_SHORT,
                                           RSI_NPTXC.TXOBJ_TAXPM_LINK_SHORT,
                                           RSI_NPTXC.TXOBJ_DIFB_SHORT
                                          ) 
                              OR rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\ВКЛ. КОМ. С ПРОД. В РАСЧ. ДОХ.', CASE WHEN pIIS = 1 THEN v_OperDate ELSE N.t_Date END) <> 'X' AND N.t_Kind = RSI_NPTXC.TXOBJ_COMS_SHORT
                           )
                       AND (CASE WHEN N.t_Kind = RSI_NPTXC.TXOBJ_MATERIALB_SHORT THEN (CASE WHEN IsIncludeMaterialInOut <> 0 THEN 1 ELSE 0 END) ELSE 1 END) = 1
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind3 = v_ak3
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND (  N.t_Analitic5 IN (RSI_NPTXC.TXGROUP_10, RSI_NPTXC.TXGROUP_20) 
                              OR (  N.t_Date >= TO_DATE('01.01.2021', 'DD.MM.YYYY') 
                                    AND N.t_Analitic5 IN (RSI_NPTXC.TXGROUP_40, RSI_NPTXC.TXGROUP_50)
                                 ) 
                           ) 
                       AND (N.t_Kind != RSI_NPTXC.TXOBJ_DIFB_SHORT OR
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010 AND
                             EXISTS( SELECT 1 
                                       FROM dnptxobj_dbt NL 
                                      WHERE NL.t_Direction = RSI_NPTXC.TXOBJ_DIR_OUT
                                        AND NL.t_Kind = RSI_NPTXC.TXOBJ_FR_LINK
                                        AND NL.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
                                        AND NL.t_Analitic2 = N.t_Analitic2 
                                   ) 
                            ) 
                           )  
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                     GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) 
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_MINUS_SEC_SHORT, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

      v_S := v_C2 - v_C1;

      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_MINUS_SEC_SHORT,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           v_ak3,
                                           one_rec.a3,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6, 
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       v_d,
                                       4,
                                       RSI_NPTXC.TXOBJ_MINUS_SEC_SHORT,
                                       v_S,
                                       RSI_RSB_FIInstr.NATCUR,
                                       0,
                                       -1,
                                       0,
                                       -1,
                                       v_ak3,
                                       one_rec.a3,
                                       v_ak4,
                                       one_rec.a4,
                                       v_ak5,
                                       one_rec.a5,
                                       one_rec.t_AnaliticKind6, 
                                       one_rec.t_Analitic6,
                                       'Суммарные расходы по акциям и обычным облигациям по коротким позициям',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Суммарные расходы по льготным облигациям по коротким позициям
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_6(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pContract  IN NUMBER, 
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pTechnical IN NUMBER,
                                pRecalc    IN CHAR,
                                pExistTechCalc IN NUMBER,
                                pTransfDate IN DATE,
                                pTransfKind IN NUMBER,
                                pDateNDR    IN DATE,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;
    
    v_Technical CHAR := CHR(0);

    v_OperDate DATE;
  BEGIN

    pStat := 0;

    v_OperDate := GetOperDate(pDocID);

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_OUT;  --Расход

    FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, NVL(sum(N.t_Sum0), 0) C2, 
                           (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6 
                      FROM dnptxobj_dbt N 
                     WHERE N.t_Client = pClient
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_Direction = v_d
                       AND (  N.t_Kind IN (RSI_NPTXC.TXOBJ_MAINB_SHORT,
                                           RSI_NPTXC.TXOBJ_COMB_SHORT,
                                           RSI_NPTXC.TXOBJ_MATERIALB_SHORT,
                                           RSI_NPTXC.TXOBJ_TAXPM_LINK_SHORT,
                                           RSI_NPTXC.TXOBJ_DIFB_SHORT
                                          ) 
                              OR rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\ВКЛ. КОМ. С ПРОД. В РАСЧ. ДОХ.', CASE WHEN pIIS = 1 THEN v_OperDate ELSE N.t_Date END) <> 'X' AND N.t_Kind = RSI_NPTXC.TXOBJ_COMS_SHORT
                           )
                       AND (CASE WHEN N.t_Kind = RSI_NPTXC.TXOBJ_MATERIALB_SHORT THEN (CASE WHEN IsIncludeMaterialInOut <> 0 THEN 1 ELSE 0 END) ELSE 1 END) = 1 
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind3 = v_ak3
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND (  N.t_Analitic5 = RSI_NPTXC.TXGROUP_30
                              OR (  N.t_Date < TO_DATE('01.01.2021', 'DD.MM.YYYY') 
                                    AND N.t_Analitic5 IN (RSI_NPTXC.TXGROUP_40, RSI_NPTXC.TXGROUP_50) 
                                 ) 
                           ) 
                       AND (N.t_Kind != RSI_NPTXC.TXOBJ_DIFB_SHORT OR
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010 AND
                             EXISTS( SELECT 1 
                                       FROM dnptxobj_dbt NL 
                                      WHERE NL.t_Direction = RSI_NPTXC.TXOBJ_DIR_OUT
                                        AND NL.t_Kind = RSI_NPTXC.TXOBJ_FR_LINK
                                        AND NL.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
                                        AND NL.t_Analitic2 = N.t_Analitic2 
                                   ) 
                            )
                           ) 
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                     GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_MINUS_SEC_SHORT, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

      v_S := v_C2 - v_C1;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_MINUS_SEC_SHORT,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           v_ak3,
                                           one_rec.a3,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6, 
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       v_d,
                                       4,
                                       RSI_NPTXC.TXOBJ_MINUS_SEC_SHORT,
                                       v_S,
                                       RSI_RSB_FIInstr.NATCUR,
                                       0,
                                       -1,
                                       0,
                                       -1,
                                       v_ak3,
                                       one_rec.a3,
                                       v_ak4,
                                       one_rec.a4,
                                       v_ak5,
                                       one_rec.a5,
                                       one_rec.t_AnaliticKind6, 
                                       one_rec.t_Analitic6,
                                       'Суммарные расходы по льготным облигациям по коротким позициям',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;


  /**
  @brief Суммарные расходы по ПИ
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_7(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pContract  IN NUMBER, 
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pTechnical IN NUMBER,
                                pRecalc    IN CHAR,
                                pExistTechCalc IN NUMBER,
                                pTransfDate IN DATE,
                                pTransfKind IN NUMBER,
                                pDateNDR    IN DATE,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;
    
    v_Technical CHAR := CHR(0);
  BEGIN

    pStat := 0;

    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_OUT;  --Расход

    FOR one_rec IN (SELECT N.t_AnaliticKind3 ak3, N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, NVL(SUM(N.t_Sum0), 0) C2, 
                           (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6 
                      FROM dnptxobj_dbt N 
                     WHERE N.t_Client = pClient 
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_Direction = v_d
                       AND N.t_Kind IN (RSI_NPTXC.TXOBJ_VAR,
                                        RSI_NPTXC.TXOBJ_PREM,
                                        RSI_NPTXC.TXOBJ_COM
                                       ) 
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND N.t_Analitic5 IN (RSI_NPTXC.TXGROUP_80,
                                             RSI_NPTXC.TXGROUP_90
                                            ) 
                       AND N.t_AnaliticKind3 = (CASE WHEN pFIID != -1 THEN RSI_NPTXC.TXOBJ_KIND3010 ELSE N.t_AnaliticKind3 END)
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                     GROUP BY N.t_AnaliticKind3, N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_MINUS_SEC, pBegDate, pEndDate, v_d, one_rec.ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

      v_S := v_C2 - v_C1;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_MINUS_SEC,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           one_rec.ak3,
                                           one_rec.a3,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6, 
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       v_d,
                                       4,
                                       RSI_NPTXC.TXOBJ_MINUS_SEC,
                                       v_S,
                                       RSI_RSB_FIInstr.NATCUR,
                                       0,
                                       -1,
                                       0,
                                       -1,
                                       one_rec.ak3,
                                       one_rec.a3,
                                       v_ak4,
                                       one_rec.a4,
                                       v_ak5,
                                       one_rec.a5,
                                       one_rec.t_AnaliticKind6, 
                                       one_rec.t_Analitic6,
                                       'Суммарные расходы по ПИ',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Суммарные доходы по облигациям, где погашение не облагается налогом
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_8(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pContract  IN NUMBER, 
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pTechnical IN NUMBER,
                                pRecalc    IN CHAR,
                                pExistTechCalc IN NUMBER,
                                pTransfDate IN DATE,
                                pTransfKind IN NUMBER,
                                pDateNDR    IN DATE,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;
    
    v_Technical CHAR := CHR(0);

    v_OperDate DATE;
  BEGIN

    pStat := 0;

    v_OperDate := GetOperDate(pDocID);

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_IN;   --Доход

    FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, 
                           (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6,
                           NVL(SUM( (CASE WHEN N.t_Kind IN (RSI_NPTXC.TXOBJ_DISCS, RSI_NPTXC.TXOBJ_COMS) 
                                          THEN -N.t_Sum0 
                                          ELSE  N.t_Sum0 END 
                                    ) 
                                  ), 0 
                              ) C2 
                      FROM dnptxobj_dbt N, v_npx_dnptxlot LS 
                     WHERE N.t_Client = pClient
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND N.t_Direction = v_d
                       AND (  N.t_Kind IN (RSI_NPTXC.TXOBJ_MAINS,
                                           RSI_NPTXC.TXOBJ_DIFS,
                                           RSI_NPTXC.TXOBJ_DISCS
                                          ) 
                              OR rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\ВКЛ. КОМ. С ПРОД. В РАСЧ. ДОХ.', CASE WHEN pIIS = 1 THEN v_OperDate ELSE N.t_Date END) = 'X' AND N.t_Kind = RSI_NPTXC.TXOBJ_COMS
                           )
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind3 = v_ak3
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND N.t_Analitic5 = RSI_NPTXC.TXGROUP_50
                       AND N.t_AnaliticKind1 = LS.t_AnaliticKind1 
                       AND N.t_Analitic1 = LS.t_Analitic1 
                       AND LS.t_Kind  = RSI_NPTXC.NPTXLOTS_SALE
                       AND LS.t_DocKind != RSB_SECUR.DL_RETIREMENT
                       AND (N.t_Kind != RSI_NPTXC.TXOBJ_DIFS OR
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010 AND
                             EXISTS( SELECT 1 
                                       FROM dnptxobj_dbt NL 
                                      WHERE NL.t_Direction = RSI_NPTXC.TXOBJ_DIR_OUT
                                        AND NL.t_Kind = RSI_NPTXC.TXOBJ_FR_LINK
                                        AND NL.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
                                        AND NL.t_Analitic2 = N.t_Analitic2 
                                   ) 
                            )
                           ) 
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                     GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_PLUS_SEC, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

      v_S := v_C2 - v_C1;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_PLUS_SEC,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           v_ak3,
                                           one_rec.a3,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6, 
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       v_d,
                                       4,
                                       RSI_NPTXC.TXOBJ_MINUS_SEC,
                                       v_S,
                                       RSI_RSB_FIInstr.NATCUR,
                                       0,
                                       -1,
                                       0,
                                       -1,
                                       v_ak3,
                                       one_rec.a3,
                                       v_ak4,
                                       one_rec.a4,
                                       v_ak5,
                                       one_rec.a5,
                                       one_rec.t_AnaliticKind6, 
                                       one_rec.t_Analitic6,
                                       'Суммарные расходы по ПИ',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Суммарные доходы по обычным облигациям
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_9(pBegDate   IN DATE,
                                pEndDate   IN DATE,
                                pClient    IN NUMBER,
                                pContract  IN NUMBER, 
                                pIIS       IN NUMBER,
                                pDocID     IN NUMBER,
                                pStep      IN NUMBER,
                                pFIID      IN NUMBER,
                                pTechnical IN NUMBER,
                                pRecalc    IN CHAR,
                                pExistTechCalc IN NUMBER,
                                pTransfDate IN DATE,
                                pTransfKind IN NUMBER,
                                pDateNDR    IN DATE,
                                pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;
    
    v_Technical CHAR := CHR(0);

    v_OperDate DATE;
  BEGIN

    pStat := 0;

    v_OperDate := GetOperDate(pDocID);

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_IN;   --Доход

    FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, 
                           NVL(SUM(CASE WHEN N.t_Kind IN (RSI_NPTXC.TXOBJ_DISCS_0, RSI_NPTXC.TXOBJ_COMS, RSI_NPTXC.TXOBJ_COMS_TS) THEN -N.t_Sum0 ELSE N.t_Sum0 END), 0) C2,
                           (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6
                      FROM dnptxobj_dbt N 
                     WHERE N.t_Client = pClient 
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                       AND (  N.t_Kind IN (RSI_NPTXC.TXOBJ_MAINS,
                                           RSI_NPTXC.TXOBJ_MAINS_TS,
                                           RSI_NPTXC.TXOBJ_DIFS,
                                           RSI_NPTXC.TXOBJ_NKDS,
                                           RSI_NPTXC.TXOBJ_DISCS_0
                                          ) 
                              OR rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\ВКЛ. КОМ. С ПРОД. В РАСЧ. ДОХ.', CASE WHEN pIIS = 1 THEN v_OperDate ELSE N.t_Date END) = 'X' AND N.t_Kind IN (RSI_NPTXC.TXOBJ_COMS,
                                                                                                                                      RSI_NPTXC.TXOBJ_COMS_TS
                                                                                                                                     )
                           )
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind3 = v_ak3
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND (  N.t_Analitic5 = RSI_NPTXC.TXGROUP_20
                              OR (  N.t_Date >= TO_DATE('01.01.2021', 'DD.MM.YYYY') 
                                    AND N.t_Analitic5 = RSI_NPTXC.TXGROUP_40
                                 ) 
                           ) 
                       AND (N.t_Kind <> RSI_NPTXC.TXOBJ_MAINS_TS OR
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2020 AND
                             EXISTS( SELECT 1 
                                       FROM dnptxts_dbt T, dnptxlot_dbt LB 
                                      WHERE LB.t_Kind <> RSI_NPTXC.NPTXLOTS_BACKREPO
                                        AND N.t_Analitic2 = T.t_ID 
                                        AND T.t_BuyID     = LB.t_ID
                                   )
                            )
                           ) 
                       AND (N.t_Kind != RSI_NPTXC.TXOBJ_DIFS OR
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010 AND
                             EXISTS( SELECT 1 
                                       FROM dnptxobj_dbt NL 
                                      WHERE NL.t_Direction = RSI_NPTXC.TXOBJ_DIR_OUT
                                        AND NL.t_Kind = RSI_NPTXC.TXOBJ_FR_LINK
                                        AND NL.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
                                        AND NL.t_Analitic2 = N.t_Analitic2 
                                   ) 
                            )
                           ) 
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                     GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_PLUS_SEC, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

      v_S := v_C2 - v_C1;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_PLUS_SEC,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           v_ak3,
                                           one_rec.a3,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6, 
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       v_d,
                                       4,
                                       RSI_NPTXC.TXOBJ_PLUS_SEC,
                                       v_S,
                                       RSI_RSB_FIInstr.NATCUR,
                                       0,
                                       -1,
                                       0,
                                       -1,
                                       v_ak3,
                                       one_rec.a3,
                                       v_ak4,
                                       one_rec.a4,
                                       v_ak5,
                                       one_rec.a5,
                                       one_rec.t_AnaliticKind6, 
                                       one_rec.t_Analitic6,
                                       'Суммарные доходы по обычным облигациям',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Суммарные доходы по облигациям, где погашение облагается в обычном порядке, а проценты - льготные
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_10(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pContract  IN NUMBER, 
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pTechnical IN NUMBER,
                                 pRecalc    IN CHAR,
                                 pExistTechCalc IN NUMBER,
                                 pTransfDate IN DATE,
                                 pTransfKind IN NUMBER,
                                 pDateNDR    IN DATE,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;
    
    v_Technical CHAR := CHR(0);

    v_OperDate DATE;
  BEGIN

    pStat := 0;

    v_OperDate := GetOperDate(pDocID);

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_IN;   --Доход

    FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, 
                           (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6,
                           NVL(SUM( (CASE WHEN N.t_Kind IN (RSI_NPTXC.TXOBJ_DISCS,
                                                            RSI_NPTXC.TXOBJ_COMS,
                                                            RSI_NPTXC.TXOBJ_COMS_TS)
                                          THEN -N.t_Sum0 
                                          ELSE  N.t_Sum0 END 
                                    ) 
                                  ), 0 
                              ) C2 
                      FROM dnptxobj_dbt N 
                     WHERE N.t_Client = pClient 
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract))) 
                       AND (  N.t_Kind IN (RSI_NPTXC.TXOBJ_MAINS,
                                           RSI_NPTXC.TXOBJ_MAINS_TS,
                                           RSI_NPTXC.TXOBJ_DIFS,
                                           RSI_NPTXC.TXOBJ_DISCS
                                          ) 
                              OR rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\ВКЛ. КОМ. С ПРОД. В РАСЧ. ДОХ.', CASE WHEN pIIS = 1 THEN v_OperDate ELSE N.t_Date END) = 'X' AND N.t_Kind IN (RSI_NPTXC.TXOBJ_COMS,
                                                                                                                                      RSI_NPTXC.TXOBJ_COMS_TS
                                                                                                                                     )
                           )
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind3 = v_ak3
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND (  N.t_Analitic5 = RSI_NPTXC.TXGROUP_30
                              OR (  N.t_Date < TO_DATE('01.01.2021', 'DD.MM.YYYY') 
                                    AND N.t_Analitic5 = RSI_NPTXC.TXGROUP_40
                                 ) 
                           ) 
                       AND (N.t_Kind <> RSI_NPTXC.TXOBJ_MAINS_TS OR
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2020 AND
                             EXISTS( SELECT 1 
                                       FROM dnptxts_dbt T, dnptxlot_dbt LB 
                                      WHERE LB.t_Kind <> RSI_NPTXC.NPTXLOTS_BACKREPO
                                        AND N.t_Analitic2 = T.t_ID 
                                        AND T.t_BuyID     = LB.t_ID
                                   ) 
                            )
                           ) 
                       AND (N.t_Kind != RSI_NPTXC.TXOBJ_DIFS OR
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010 AND
                             EXISTS( SELECT 1 
                                       FROM dnptxobj_dbt NL 
                                      WHERE NL.t_Direction = RSI_NPTXC.TXOBJ_DIR_OUT
                                        AND NL.t_Kind = RSI_NPTXC.TXOBJ_FR_LINK
                                        AND NL.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
                                        AND NL.t_Analitic2 = N.t_Analitic2 
                                   ) 
                            )
                           ) 
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                     GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_PLUS_SEC, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

      v_S := v_C2 - v_C1;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_PLUS_SEC,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           v_ak3,
                                           one_rec.a3,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6, 
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       v_d,
                                       4,
                                       RSI_NPTXC.TXOBJ_PLUS_SEC,
                                       v_S,
                                       RSI_RSB_FIInstr.NATCUR,
                                       0,
                                       -1,
                                       0,
                                       -1,
                                       v_ak3,
                                       one_rec.a3,
                                       v_ak4,
                                       one_rec.a4,
                                       v_ak5,
                                       one_rec.a5,
                                       one_rec.t_AnaliticKind6, 
                                       one_rec.t_Analitic6,
                                       'Суммарные доходы по облигациям, где погашение облагается в обычном порядке, а проценты - льготные',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Суммарные доходы по акциям
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_11(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pContract  IN NUMBER, 
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pTechnical IN NUMBER,
                                 pRecalc    IN CHAR,
                                 pExistTechCalc IN NUMBER,
                                 pTransfDate IN DATE,
                                 pTransfKind IN NUMBER,
                                 pDateNDR    IN DATE,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;
    
    v_Technical CHAR := CHR(0);

    v_OperDate DATE;
  BEGIN

    pStat := 0;

    v_OperDate := GetOperDate(pDocID);

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_IN;   --Доход

    FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, NVL( SUM(CASE WHEN N.t_KIND = RSI_NPTXC.TXOBJ_COMS THEN -N.t_Sum0
                                                                                               ELSE N.t_Sum0 END
                                                                                         ), 0
                                                                                    ) C2, 
                           (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6 
                      FROM dnptxobj_dbt N 
                     WHERE N.t_Client = pClient 
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract))) 
                       AND (  N.t_Kind IN (RSI_NPTXC.TXOBJ_MAINS,
                                           RSI_NPTXC.TXOBJ_DIFS
                                          ) 
                              OR rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\ВКЛ. КОМ. С ПРОД. В РАСЧ. ДОХ.', CASE WHEN pIIS = 1 THEN v_OperDate ELSE N.t_Date END) = 'X' AND N.t_Kind = RSI_NPTXC.TXOBJ_COMS
                           )
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind3 = v_ak3
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND N.t_Analitic5 = RSI_NPTXC.TXGROUP_10
                       AND (N.t_Kind != RSI_NPTXC.TXOBJ_DIFS OR
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010 AND
                             EXISTS( SELECT 1 
                                       FROM dnptxobj_dbt NL 
                                      WHERE NL.t_Direction = RSI_NPTXC.TXOBJ_DIR_OUT
                                        AND NL.t_Kind = RSI_NPTXC.TXOBJ_FR_LINK
                                        AND NL.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
                                        AND NL.t_Analitic2 = N.t_Analitic2 
                                   ) 
                            ) 
                           )  
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                     GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_PLUS_SEC, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

      v_S := v_C2 - v_C1;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_PLUS_SEC,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           v_ak3,
                                           one_rec.a3,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6, 
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       v_d,
                                       4,
                                       RSI_NPTXC.TXOBJ_PLUS_SEC,
                                       v_S,
                                       RSI_RSB_FIInstr.NATCUR,
                                       0,
                                       -1,
                                       0,
                                       -1,
                                       v_ak3,
                                       one_rec.a3,
                                       v_ak4,
                                       one_rec.a4,
                                       v_ak5,
                                       one_rec.a5,
                                       one_rec.t_AnaliticKind6, 
                                       one_rec.t_Analitic6,
                                       'Суммарные доходы по акциям',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Суммарные доходы по акциям и обычным облигациям по коротким позициям
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_12(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pContract  IN NUMBER, 
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pTechnical IN NUMBER,
                                 pRecalc    IN CHAR,
                                 pExistTechCalc IN NUMBER,
                                 pTransfDate IN DATE,
                                 pTransfKind IN NUMBER,
                                 pDateNDR    IN DATE,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;
    
    v_Technical CHAR := CHR(0);

    v_OperDate DATE;
  BEGIN

    pStat := 0;

    v_OperDate := GetOperDate(pDocID);

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_IN;   --Доход

    FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, NVL(SUM(CASE WHEN N.t_Kind = RSI_NPTXC.TXOBJ_COMS_SHORT THEN -N.t_Sum0
                                                                                              ELSE N.t_Sum0 END
                                                                                        ), 0) C2, 
                           (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6 
                      FROM dnptxobj_dbt N 
                     WHERE N.t_Client = pClient 
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract))) 
                       AND (  N.t_Kind IN (RSI_NPTXC.TXOBJ_MAINS_SHORT,
                                           RSI_NPTXC.TXOBJ_NKDS_SHORT,
                                           RSI_NPTXC.TXOBJ_DIFS_SHORT
                                          ) 
                              OR rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\ВКЛ. КОМ. С ПРОД. В РАСЧ. ДОХ.', CASE WHEN pIIS = 1 THEN v_OperDate ELSE N.t_Date END) = 'X' AND N.t_Kind = RSI_NPTXC.TXOBJ_COMS_SHORT
                           )
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind3 = v_ak3
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND (  N.t_Analitic5 IN (RSI_NPTXC.TXGROUP_10, RSI_NPTXC.TXGROUP_20) 
                              OR (  N.t_Date >= TO_DATE('01.01.2021', 'DD.MM.YYYY') 
                                    AND N.t_Analitic5 IN (RSI_NPTXC.TXGROUP_40, RSI_NPTXC.TXGROUP_50) 
                                 ) 
                           ) 
                       AND (N.t_Kind != RSI_NPTXC.TXOBJ_DIFS_SHORT OR
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010 AND
                             EXISTS( SELECT 1 
                                       FROM dnptxobj_dbt NL 
                                      WHERE NL.t_Direction = RSI_NPTXC.TXOBJ_DIR_OUT
                                        AND NL.t_Kind = RSI_NPTXC.TXOBJ_FR_LINK
                                        AND NL.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
                                        AND NL.t_Analitic2 = N.t_Analitic2 
                                   ) 
                            )
                           ) 
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                     GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_PLUS_SEC_SHORT, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

      v_S := v_C2 - v_C1;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_PLUS_SEC_SHORT,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           v_ak3,
                                           one_rec.a3,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6, 
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       v_d,
                                       4,
                                       RSI_NPTXC.TXOBJ_PLUS_SEC_SHORT,
                                       v_S,
                                       RSI_RSB_FIInstr.NATCUR,
                                       0,
                                       -1,
                                       0,
                                       -1,
                                       v_ak3,
                                       one_rec.a3,
                                       v_ak4,
                                       one_rec.a4,
                                       v_ak5,
                                       one_rec.a5,
                                       one_rec.t_AnaliticKind6, 
                                       one_rec.t_Analitic6,
                                       'Суммарные доходы по акциям и обычным облигациям по коротким позициям',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Суммарные доходы по акциям и обычным облигациям по коротким позициям
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_13(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pContract  IN NUMBER, 
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pTechnical IN NUMBER,
                                 pRecalc    IN CHAR,
                                 pExistTechCalc IN NUMBER,
                                 pTransfDate IN DATE,
                                 pTransfKind IN NUMBER,
                                 pDateNDR    IN DATE,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;
    
    v_Technical CHAR := CHR(0);

    v_OperDate DATE;
  BEGIN

    pStat := 0;

    v_OperDate := GetOperDate(pDocID);

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_IN;   --Доход

    FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, NVL(SUM(CASE WHEN N.t_Kind = RSI_NPTXC.TXOBJ_COMS_SHORT THEN -N.t_Sum0
                                                                                              ELSE N.t_Sum0 END
                                                                                        ), 0) C2, 
                           (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6 
                      FROM dnptxobj_dbt N 
                     WHERE N.t_Client = pClient 
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract))) 
                       AND (  N.t_Kind IN (RSI_NPTXC.TXOBJ_MAINS_SHORT,
                                           RSI_NPTXC.TXOBJ_DIFS_SHORT
                                          ) 
                              OR rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\ВКЛ. КОМ. С ПРОД. В РАСЧ. ДОХ.', CASE WHEN pIIS = 1 THEN v_OperDate ELSE N.t_Date END) = 'X' AND N.t_Kind = RSI_NPTXC.TXOBJ_COMS_SHORT
                           )
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind3 = v_ak3
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND (  N.t_Analitic5 = RSI_NPTXC.TXGROUP_30
                              OR (  N.t_Date < TO_DATE('01.01.2021', 'DD.MM.YYYY')
                                    AND N.t_Analitic5 IN (RSI_NPTXC.TXGROUP_40, RSI_NPTXC.TXGROUP_50) 
                                 ) 
                           ) 
                       AND (N.t_Kind != RSI_NPTXC.TXOBJ_DIFS_SHORT OR
                            (N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010 AND
                             EXISTS( SELECT 1 
                                       FROM dnptxobj_dbt NL 
                                      WHERE NL.t_Direction = RSI_NPTXC.TXOBJ_DIR_OUT
                                        AND NL.t_Kind = RSI_NPTXC.TXOBJ_FR_LINK
                                        AND NL.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010
                                        AND NL.t_Analitic2 = N.t_Analitic2 
                                   ) 
                            )
                           ) 
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                     GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_PLUS_SEC_SHORT, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

      v_S := v_C2 - v_C1;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_PLUS_SEC_SHORT,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           v_ak3,
                                           one_rec.a3,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6, 
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       v_d,
                                       4,
                                       RSI_NPTXC.TXOBJ_PLUS_SEC_SHORT,
                                       v_S,
                                       RSI_RSB_FIInstr.NATCUR,
                                       0,
                                       -1,
                                       0,
                                       -1,
                                       v_ak3,
                                       one_rec.a3,
                                       v_ak4,
                                       one_rec.a4,
                                       v_ak5,
                                       one_rec.a5,
                                       one_rec.t_AnaliticKind6, 
                                       one_rec.t_Analitic6,
                                       'Суммарные доходы по льготным облигациям по коротким позициям',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Суммарные доходы по ПИ
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_14(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pContract  IN NUMBER, 
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pTechnical IN NUMBER,
                                 pRecalc    IN CHAR,
                                 pExistTechCalc IN NUMBER,
                                 pTransfDate IN DATE,
                                 pTransfKind IN NUMBER,
                                 pDateNDR    IN DATE,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;
    
    v_Technical CHAR := CHR(0);
  BEGIN

    pStat := 0;

    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_IN;   --Доход

    FOR one_rec IN (SELECT N.t_AnaliticKind3 ak3, N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, NVL(SUM(N.t_Sum0), 0) C2, 
                           (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6 
                      FROM dnptxobj_dbt N 
                     WHERE N.t_Client = pClient 
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract))) 
                       AND N.t_Direction = v_d
                       AND N.t_Kind IN (RSI_NPTXC.TXOBJ_VAR,
                                        RSI_NPTXC.TXOBJ_PREM
                                       ) 
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND N.t_Analitic5 IN (RSI_NPTXC.TXGROUP_80,
                                             RSI_NPTXC.TXGROUP_90
                                            )  
                       AND N.t_AnaliticKind3 = (CASE WHEN pFIID != -1 THEN RSI_NPTXC.TXOBJ_KIND3010 ELSE N.t_AnaliticKind3 END)
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                     GROUP BY N.t_AnaliticKind3, N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_PLUS_SEC, pBegDate, pEndDate, v_d, one_rec.ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

      v_S := v_C2 - v_C1;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_PLUS_SEC,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           one_rec.ak3,
                                           one_rec.a3,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6, 
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       v_d,
                                       4,
                                       RSI_NPTXC.TXOBJ_PLUS_SEC,
                                       v_S,
                                       RSI_RSB_FIInstr.NATCUR,
                                       0,
                                       -1,
                                       0,
                                       -1,
                                       one_rec.ak3,
                                       one_rec.a3,
                                       v_ak4,
                                       one_rec.a4,
                                       v_ak5,
                                       one_rec.a5,
                                       one_rec.t_AnaliticKind6, 
                                       one_rec.t_Analitic6,
                                       'Суммарные доходы по ПИ',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Доходы по частичному погашению ц/б, для которых сумма погашения не облагается налогом
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_15(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pContract  IN NUMBER, 
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pTechnical IN NUMBER,
                                 pRecalc    IN CHAR,
                                 pExistTechCalc IN NUMBER,
                                 pTransfDate IN DATE,
                                 pTransfKind IN NUMBER,
                                 pDateNDR    IN DATE,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;

    v_i   NUMBER;
    
    v_Technical CHAR := CHR(0);
  BEGIN

    pStat := 0;

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа

    v_i := 0;
    WHILE v_i < 2 LOOP

      IF v_i = 0 THEN
        v_d := RSI_NPTXC.TXOBJ_DIR_OUT;  --Расход
      ELSE
        v_d := RSI_NPTXC.TXOBJ_DIR_IN;   --Доход
      END IF;

      FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, NVL(SUM(N.t_Sum0), 0) C2, 
                             (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6 
                        FROM dnptxobj_dbt N 
                       WHERE N.t_Client = pClient 
                         AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                         AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                         AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract))) 
                         AND N.t_Direction = v_d
                         AND N.t_Kind = RSI_NPTXC.TXOBJ_FR_TS
                         AND N.t_Date >= pBegDate
                         AND N.t_Date <= pEndDate
                         AND N.t_AnaliticKind3 = v_ak3
                         AND N.t_AnaliticKind4 = v_ak4
                         AND N.t_AnaliticKind5 = v_ak5
                         AND N.t_Analitic5 = RSI_NPTXC.TXGROUP_50 
                         AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                       GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                      )
      LOOP

        v_C2 := one_rec.C2;

        v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_EXP_SEC, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

        v_S := v_C2 - v_C1;
        
        v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                             pBegDate,
                                             pEndDate,
                                             pClient,
                                             RSI_NPTXC.TXOBJ_EXP_SEC,
                                             4,
                                             0,
                                             -1,
                                             0,
                                             -1,
                                             v_ak3,
                                             one_rec.a3,
                                             v_ak4,
                                             one_rec.a4,
                                             v_ak5,
                                             one_rec.a5,
                                             one_rec.t_AnaliticKind6, 
                                             one_rec.t_Analitic6,
                                             pTechnical,
                                             pRecalc);

        nptxobj := CreateNPTXOBJLevel3_4(1,
                                         CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                         pClient,
                                         v_d,
                                         4,
                                         RSI_NPTXC.TXOBJ_EXP_SEC,
                                         v_S,
                                         RSI_RSB_FIInstr.NATCUR,
                                         0,
                                         -1,
                                         0,
                                         -1,
                                         v_ak3,
                                         one_rec.a3,
                                         v_ak4,
                                         one_rec.a4,
                                         v_ak5,
                                         one_rec.a5,
                                         one_rec.t_AnaliticKind6, 
                                         one_rec.t_Analitic6,
                                         'Доходы по частичному погашению ц/б, для которых сумма погашения не облагается налогом',
                                         pDocID,
                                         pStep,
                                         v_Technical,
                                         pRecalc,
                                         pExistTechCalc,
                                         pTransfDate,
                                         pTransfKind);

        IF nptxobj.t_ID IS NOT NULL
        THEN
          nptxobj_ins.extend;
          nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
        END IF;

        IF nptxobj_ins.COUNT >= g_Limit THEN
          FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
               INSERT INTO DNPTXOBJ_TMP
                    VALUES nptxobj_ins(indx);

          nptxobj_ins.Delete;
          nptxobj_ins := nptxobj_t();
        END IF;

      END LOOP;

      v_i := v_i + 1;
    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Доходы, не включаемые в НОБ
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_16(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pContract  IN NUMBER, 
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pTechnical IN NUMBER,
                                 pRecalc    IN CHAR,
                                 pExistTechCalc IN NUMBER,
                                 pTransfDate IN DATE,
                                 pTransfKind IN NUMBER,
                                 pDateNDR    IN DATE,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;

    v_Technical CHAR := CHR(0);

    v_OperDate DATE;
  BEGIN

    pStat := 0;

    v_OperDate := GetOperDate(pDocID);

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_IN;   --Доход

    FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, NVL(SUM(CASE WHEN N.t_Kind IN (RSI_NPTXC.TXOBJ_COMS_0,
                                                                                                                RSI_NPTXC.TXOBJ_COMS_TS_0
                                                                                                               ) THEN -N.t_Sum0
                                                                                              ELSE N.t_Sum0 END), 0) C2, 
                           (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6 
                      FROM dnptxobj_dbt N 
                     WHERE N.t_Client = pClient 
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract))) 
                       AND (  N.t_Kind IN (RSI_NPTXC.TXOBJ_MAINS_0, RSI_NPTXC.TXOBJ_MAINS_TS_0, RSI_NPTXC.TXOBJ_DISCS_0) 
                              OR rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\ВКЛ. КОМ. С ПРОД. В РАСЧ. ДОХ.', CASE WHEN pIIS = 1 THEN v_OperDate ELSE N.t_Date END) = 'X' AND N.t_Kind IN (RSI_NPTXC.TXOBJ_COMS_0,
                                                                                                                                      RSI_NPTXC.TXOBJ_COMS_TS_0
                                                                                                                                     )
                           )
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind3 = v_ak3
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                     GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_PLUS_SEC0, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

      v_S := v_C2 - v_C1;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_PLUS_SEC0,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           v_ak3,
                                           one_rec.a3,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6, 
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       v_d,
                                       4,
                                       RSI_NPTXC.TXOBJ_PLUS_SEC0,
                                       v_S,
                                       RSI_RSB_FIInstr.NATCUR,
                                       0,
                                       -1,
                                       0,
                                       -1,
                                       v_ak3,
                                       one_rec.a3,
                                       v_ak4,
                                       one_rec.a4,
                                       v_ak5,
                                       one_rec.a5,
                                       one_rec.t_AnaliticKind6, 
                                       one_rec.t_Analitic6,
                                       'Доходы, не включаемые в НОБ',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;


  /**
  @brief Расходы, не включаемые в НОБ
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_17(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pContract  IN NUMBER, 
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pTechnical IN NUMBER,
                                 pRecalc    IN CHAR,
                                 pExistTechCalc IN NUMBER,
                                 pTransfDate IN DATE,
                                 pTransfKind IN NUMBER,
                                 pDateNDR    IN DATE,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;

    v_Technical CHAR := CHR(0);

    v_OperDate DATE;
  BEGIN

    pStat := 0;

    v_OperDate := GetOperDate(pDocID);

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_OUT;  --Расход

    FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, NVL(SUM(N.t_Sum0), 0) C2, 
                           (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6 
                      FROM dnptxobj_dbt N 
                     WHERE N.t_Client = pClient 
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract))) 
                       AND N.t_Direction = v_d
                       AND (  N.t_Kind IN (RSI_NPTXC.TXOBJ_MAINB_0, RSI_NPTXC.TXOBJ_COMB_0,
                                           RSI_NPTXC.TXOBJ_MAINB_TS_0, RSI_NPTXC.TXOBJ_COMB_TS_0)
                              OR rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\ВКЛ. КОМ. С ПРОД. В РАСЧ. ДОХ.', CASE WHEN pIIS = 1 THEN v_OperDate ELSE N.t_Date END) <> 'X' AND N.t_Kind IN (RSI_NPTXC.TXOBJ_COMS_0, 
                                                                                                                                       RSI_NPTXC.TXOBJ_COMS_TS_0
                                                                                                                                      )
                           )
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind3 = v_ak3
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                     GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_MINUS_SEC0, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

      v_S := v_C2 - v_C1;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_MINUS_SEC0,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           v_ak3,
                                           one_rec.a3,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6, 
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       v_d,
                                       4,
                                       RSI_NPTXC.TXOBJ_MINUS_SEC0,
                                       v_S,
                                       RSI_RSB_FIInstr.NATCUR,
                                       0,
                                       -1,
                                       0,
                                       -1,
                                       v_ak3,
                                       one_rec.a3,
                                       v_ak4,
                                       one_rec.a4,
                                       v_ak5,
                                       one_rec.a5,
                                       one_rec.t_AnaliticKind6, 
                                       one_rec.t_Analitic6,
                                       'Расходы, не включаемые в НОБ',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Доходы по полному погашению ц/б, для которых сумма погашения не облагается налогом
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_18(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pContract  IN NUMBER, 
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pTechnical IN NUMBER,
                                 pRecalc    IN CHAR,
                                 pExistTechCalc IN NUMBER,
                                 pTransfDate IN DATE,
                                 pTransfKind IN NUMBER,
                                 pDateNDR    IN DATE,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;

    v_i   NUMBER;
    
    v_Technical CHAR := CHR(0);
  BEGIN

    pStat := 0;

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа

    v_i := 0;
    WHILE v_i < 2 LOOP

      IF v_i = 0 THEN
        v_d := RSI_NPTXC.TXOBJ_DIR_OUT;  --Расход
      ELSE
        v_d := RSI_NPTXC.TXOBJ_DIR_IN;   --Доход
      END IF;

      FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, NVL(SUM(N.t_Sum0), 0) C2, 
                             (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6 
                        FROM dnptxobj_dbt N, v_npx_dnptxlot LS 
                       WHERE N.t_Client = pClient
                         AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6 ) = pIIS
                         AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                         AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract))) 
                         AND N.t_Direction = v_d
                         AND N.t_Kind = RSI_NPTXC.TXOBJ_FR_LINK
                         AND N.t_Date >= pBegDate
                         AND N.t_Date <= pEndDate
                         AND N.t_AnaliticKind3 = v_ak3
                         AND N.t_AnaliticKind4 = v_ak4
                         AND N.t_AnaliticKind5 = v_ak5
                         AND N.t_Analitic5 = RSI_NPTXC.TXGROUP_50
                         AND N.t_AnaliticKind1 = LS.t_AnaliticKind1 
                         AND N.t_Analitic1 = LS.t_Analitic1 
                         AND LS.t_DocKind = RSB_SECUR.DL_RETIREMENT
                         AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                       GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                      )
      LOOP

        v_C2 := one_rec.C2;

        v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_EXP_SEC, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

        v_S := v_C2 - v_C1;
        
        v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                             pBegDate,
                                             pEndDate,
                                             pClient,
                                             RSI_NPTXC.TXOBJ_EXP_SEC,
                                             4,
                                             0,
                                             -1,
                                             0,
                                             -1,
                                             v_ak3,
                                             one_rec.a3,
                                             v_ak4,
                                             one_rec.a4,
                                             v_ak5,
                                             one_rec.a5,
                                             one_rec.t_AnaliticKind6, 
                                             one_rec.t_Analitic6,
                                             pTechnical,
                                             pRecalc);

        nptxobj := CreateNPTXOBJLevel3_4(1,
                                         CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                         pClient,
                                         v_d,
                                         4,
                                         RSI_NPTXC.TXOBJ_EXP_SEC,
                                         v_S,
                                         RSI_RSB_FIInstr.NATCUR,
                                         0,
                                         -1,
                                         0,
                                         -1,
                                         v_ak3,
                                         one_rec.a3,
                                         v_ak4,
                                         one_rec.a4,
                                         v_ak5,
                                         one_rec.a5,
                                         one_rec.t_AnaliticKind6, 
                                         one_rec.t_Analitic6,
                                         'Доходы по полному погашению ц/б, для которых сумма погашения не облагается налогом',
                                         pDocID,
                                         pStep,
                                         v_Technical,
                                         pRecalc,
                                         pExistTechCalc,
                                         pTransfDate,
                                         pTransfKind);

        IF nptxobj.t_ID IS NOT NULL
        THEN
          nptxobj_ins.extend;
          nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
        END IF;

        IF nptxobj_ins.COUNT >= g_Limit THEN
          FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
               INSERT INTO DNPTXOBJ_TMP
                    VALUES nptxobj_ins(indx);

          nptxobj_ins.Delete;
          nptxobj_ins := nptxobj_t();
        END IF;

      END LOOP;

      v_i := v_i + 1;
    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;


  /**
  @brief Процентный (купонный) доход по ц/б
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_19(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pContract  IN NUMBER, 
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pTechnical IN NUMBER,
                                 pRecalc    IN CHAR,
                                 pExistTechCalc IN NUMBER,
                                 pTransfDate IN DATE,
                                 pTransfKind IN NUMBER,
                                 pDateNDR    IN DATE,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;

    v_i   NUMBER;
    
    v_Technical CHAR := CHR(0);

    v_OperDate DATE;
    v_NKDBTS_Flag CHAR(1) := CHR(0);
  BEGIN

    pStat := 0;

    v_OperDate := GetOperDate(pDocID);

    v_NKDBTS_Flag := rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\УЧЕТ_NKDB_TS_В_ДОХ', v_OperDate);

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа

    v_i := 0;
    WHILE v_i < 2 LOOP

      IF v_i = 0 THEN
        v_d := RSI_NPTXC.TXOBJ_DIR_OUT;  --Расход
      ELSE
        v_d := RSI_NPTXC.TXOBJ_DIR_IN;   --Доход
      END IF;

      FOR one_rec IN (SELECT q.a3, q.ak3, q.a4, q.a5, 
                             (CASE WHEN pIIS = 1 THEN q.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN q.t_Analitic6 ELSE 0 END) as t_Analitic6, 
                             NVL(SUM(q.t_Sum0), 0) C2,
                             NVL(SUM(q.CoupNKDB_TS), 0) as SumCoupNKDB_TS
                        FROM ( SELECT N.t_Analitic3 a3, N.t_AnaliticKind3 ak3, N.t_Analitic4 a4, N.t_Analitic5 a5, N.t_Sum0, 
                                      N.t_AnaliticKind6, N.t_Analitic6,
                                      NVL((SELECT NVL(SUM(obj.t_Sum0), 0)
                                            FROM dnptxobj_dbt obj
                                           WHERE obj.t_Client = pClient
                                             AND obj.t_Kind = RSI_NPTXC.TXOBJ_NKDB_TS
                                             AND obj.t_AnaliticKind2 = N.t_AnaliticKind2
                                             AND obj.t_Analitic2 = N.t_Analitic2
                                             AND obj.t_AnaliticKind3 = N.t_AnaliticKind3
                                             AND obj.t_Analitic3 = N.t_Analitic3
                                             AND obj.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else obj.t_AnaliticKind6 END)
                                             AND ((pContract IS NULL) OR (pContract <= 0) OR (obj.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                                         ), 0) as CoupNKDB_TS
                                 FROM dnptxobj_dbt N 
                                WHERE N.t_Client = pClient 
                                  AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6 ) = pIIS
                                  AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                                  AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract))) 
                                  AND N.t_Direction = v_d
                                  AND ( N.t_Kind IN (RSI_NPTXC.TXOBJ_PROCSEC_TS,RSI_NPTXC.TXOBJ_DISCOUNT_LINK)
                                        OR (    N.t_Kind = RSI_NPTXC.TXOBJ_PROCSEC_Link
                                            AND N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010 --Связь
                                            AND NOT EXISTS(SELECT 1 FROM dnptxlnk_dbt S WHERE s.t_ID = N.t_Analitic2 AND S.t_Type = RSI_NPTXC.NPTXLNK_CLPOS) --исключая ЗКП
                                           )
                                      ) 
                                  AND N.t_Date >= pBegDate
                                  AND N.t_Date <= pEndDate
                                  AND N.t_AnaliticKind3 = v_ak3
                                  AND N.t_AnaliticKind4 = v_ak4
                                  AND N.t_AnaliticKind5 = v_ak5
                                  AND ( N.t_Analitic5 = RSI_NPTXC.TXGROUP_30
                                        OR (  N.t_Date < TO_DATE('01.01.2021', 'DD.MM.YYYY') 
                                              AND N.t_Analitic5 IN (RSI_NPTXC.TXGROUP_40, RSI_NPTXC.TXGROUP_50) 
                                           ) 
                                      ) 
                                  AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                             ) q
                       GROUP BY q.a3, q.ak3, q.a4, q.a5, (CASE WHEN pIIS = 1 THEN q.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN q.t_Analitic6 ELSE 0 END)
                      )
      LOOP

        v_C2 := one_rec.C2;

        v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_PROC_SEC, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

        v_S := v_C2 - v_C1;

        IF v_NKDBTS_Flag = 'X' THEN
          v_S := v_S - one_rec.SumCoupNKDB_TS;
        END IF;
        
        v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                             pBegDate,
                                             pEndDate,
                                             pClient,
                                             RSI_NPTXC.TXOBJ_PROC_SEC,
                                             4,
                                             0,
                                             -1,
                                             0,
                                             -1,
                                             v_ak3,
                                             one_rec.a3,
                                             v_ak4,
                                             one_rec.a4,
                                             v_ak5,
                                             one_rec.a5,
                                             one_rec.t_AnaliticKind6, 
                                             one_rec.t_Analitic6,
                                             pTechnical,
                                             pRecalc);

        nptxobj := CreateNPTXOBJLevel3_4(1,
                                         CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                         pClient,
                                         v_d,
                                         4,
                                         RSI_NPTXC.TXOBJ_PROC_SEC,
                                         v_S,
                                         RSI_RSB_FIInstr.NATCUR,
                                         0,
                                         -1,
                                         0,
                                         -1,
                                         v_ak3,
                                         one_rec.a3,
                                         v_ak4,
                                         one_rec.a4,
                                         v_ak5,
                                         one_rec.a5,
                                         one_rec.t_AnaliticKind6, 
                                         one_rec.t_Analitic6,
                                         'Процентный (купонный) доход по ц/б',
                                         pDocID,
                                         pStep,
                                         v_Technical,
                                         pRecalc,
                                         pExistTechCalc,
                                         pTransfDate,
                                         pTransfKind);

        IF nptxobj.t_ID IS NOT NULL
        THEN
          nptxobj_ins.extend;
          nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
        END IF;

        IF nptxobj_ins.COUNT >= g_Limit THEN
          FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
               INSERT INTO DNPTXOBJ_TMP
                    VALUES nptxobj_ins(indx);

          nptxobj_ins.Delete;
          nptxobj_ins := nptxobj_t();
        END IF;

      END LOOP;

      v_i := v_i + 1;
    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;


  /**
  @brief Процентный (купонный) доход по ц/б
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_20(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pContract  IN NUMBER, 
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pTechnical IN NUMBER,
                                 pRecalc    IN CHAR,
                                 pExistTechCalc IN NUMBER,
                                 pTransfDate IN DATE,
                                 pTransfKind IN NUMBER,
                                 pDateNDR    IN DATE,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;

    v_i   NUMBER;
    
    v_Technical CHAR := CHR(0);

    v_OperDate DATE;
    v_NKDBTS_Flag CHAR(1) := CHR(0);
  BEGIN

    pStat := 0;

    v_OperDate := GetOperDate(pDocID);

    v_NKDBTS_Flag := rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\УЧЕТ_NKDB_TS_В_ДОХ', v_OperDate);

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа

    v_i := 0;
    WHILE v_i < 2 LOOP

      IF v_i = 0 THEN
        v_d := RSI_NPTXC.TXOBJ_DIR_OUT;  --Расход
      ELSE
        v_d := RSI_NPTXC.TXOBJ_DIR_IN;   --Доход
      END IF;

      FOR one_rec IN (SELECT q.a3, q.ak3, q.a4, q.a5, q.t_AnaliticKind6, q.t_Analitic6,
                             NVL(SUM(q.AllSum0), 0) C2,
                             NVL(SUM(q.CoupNKDB_TS), 0) as SumCoupNKDB_TS
                        FROM ( SELECT N.t_Analitic3 a3, N.t_AnaliticKind3 ak3, N.t_Analitic4 a4, N.t_Analitic5 a5, SUM(N.t_Sum0) as AllSum0, 
                                      (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6,
                                      NVL((SELECT NVL(SUM(obj.t_Sum0), 0)
                                            FROM dnptxobj_dbt obj
                                           WHERE obj.t_Client = pClient
                                             AND obj.t_Kind = RSI_NPTXC.TXOBJ_NKDB_TS
                                             AND obj.t_AnaliticKind2 = N.t_AnaliticKind2
                                             AND obj.t_Analitic2 = N.t_Analitic2
                                             AND obj.t_AnaliticKind3 = N.t_AnaliticKind3
                                             AND obj.t_Analitic3 = N.t_Analitic3
                                             AND obj.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else obj.t_AnaliticKind6 END)
                                             AND ((pContract IS NULL) OR (pContract <= 0) OR (obj.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract)))
                                         ), 0) as CoupNKDB_TS
                                 FROM dnptxobj_dbt N 
                                WHERE N.t_Client = pClient 
                                  AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6 ) = pIIS
                                  AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                                  AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract))) 
                                  AND N.t_Direction = v_d
                                  AND ( N.t_Kind IN (RSI_NPTXC.TXOBJ_PROCSEC_TS)
                                               OR (    N.t_Kind = RSI_NPTXC.TXOBJ_PROCSEC_Link
                                                   AND N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010 --Связь
                                                   AND NOT EXISTS(SELECT 1 FROM dnptxlnk_dbt S WHERE s.t_ID = N.t_Analitic2 AND S.t_Type = RSI_NPTXC.NPTXLNK_CLPOS) --исключая ЗКП
                                                  )
                                             ) 
                                  AND N.t_Date >= pBegDate
                                  AND N.t_Date <= pEndDate
                                  AND N.t_AnaliticKind3 = v_ak3
                                  AND N.t_AnaliticKind4 = v_ak4
                                  AND N.t_AnaliticKind5 = v_ak5
                                  AND (  N.t_Analitic5 = RSI_NPTXC.TXGROUP_20
                                         OR (  N.t_Date >= TO_DATE('01.01.2021', 'DD.MM.YYYY')
                                               AND N.t_Analitic5 IN (RSI_NPTXC.TXGROUP_40, RSI_NPTXC.TXGROUP_50)
                                            )
                                      )  
                                  AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                              GROUP BY N.t_Analitic2, N.t_AnaliticKind2, N.t_Analitic3 , N.t_AnaliticKind3, N.t_Analitic4,  N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                             ) q
                       GROUP BY q.a3, q.ak3, q.a4, q.a5, q.t_AnaliticKind6, q.t_Analitic6
                      )
      LOOP

        v_C2 := one_rec.C2;

        v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_PROC_SEC, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

        v_S := v_C2 - v_C1;

        IF v_NKDBTS_Flag = 'X' THEN
          v_S := v_S - one_rec.SumCoupNKDB_TS;
        END IF;
        
        v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                             pBegDate,
                                             pEndDate,
                                             pClient,
                                             RSI_NPTXC.TXOBJ_PROC_SEC,
                                             4,
                                             0,
                                             -1,
                                             0,
                                             -1,
                                             v_ak3,
                                             one_rec.a3,
                                             v_ak4,
                                             one_rec.a4,
                                             v_ak5,
                                             one_rec.a5,
                                             one_rec.t_AnaliticKind6, 
                                             one_rec.t_Analitic6,
                                             pTechnical,
                                             pRecalc);

        nptxobj := CreateNPTXOBJLevel3_4(1,
                                         CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                         pClient,
                                         v_d,
                                         4,
                                         RSI_NPTXC.TXOBJ_PROC_SEC,
                                         v_S,
                                         RSI_RSB_FIInstr.NATCUR,
                                         0,
                                         -1,
                                         0,
                                         -1,
                                         v_ak3,
                                         one_rec.a3,
                                         v_ak4,
                                         one_rec.a4,
                                         v_ak5,
                                         one_rec.a5,
                                         one_rec.t_AnaliticKind6, 
                                         one_rec.t_Analitic6,
                                         'Процентный (купонный) доход по ц/б',
                                         pDocID,
                                         pStep,
                                         v_Technical,
                                         pRecalc,
                                         pExistTechCalc,
                                         pTransfDate,
                                         pTransfKind);

        IF nptxobj.t_ID IS NOT NULL
        THEN
          nptxobj_ins.extend;
          nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
        END IF;

        IF nptxobj_ins.COUNT >= g_Limit THEN
          FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
               INSERT INTO DNPTXOBJ_TMP
                    VALUES nptxobj_ins(indx);

          nptxobj_ins.Delete;
          nptxobj_ins := nptxobj_t();
        END IF;

      END LOOP;

      v_i := v_i + 1;
    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief Процентный (купонный) доход по ц/б
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_21(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pContract  IN NUMBER, 
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pTechnical IN NUMBER,
                                 pRecalc    IN CHAR,
                                 pExistTechCalc IN NUMBER,
                                 pTransfDate IN DATE,
                                 pTransfKind IN NUMBER,
                                 pDateNDR    IN DATE,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;

    v_Technical CHAR := CHR(0);
  BEGIN

    pStat := 0;

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_OUT;  --Расход

    FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, NVL(sum(N.t_Sum0), 0) C2, 
                           (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END) as t_AnaliticKind6, (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END) as t_Analitic6 
                      FROM dnptxobj_dbt N 
                     WHERE N.t_Client = pClient 
                       AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6) = pIIS
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract))) 
                       AND N.t_Direction = v_d
                       AND N.t_Kind = RSI_NPTXC.TXOBJ_PROCSEC_Link 
                       AND N.t_AnaliticKind2 = RSI_NPTXC.TXOBJ_KIND2010 --Связь
                       AND EXISTS(SELECT 1 FROM dnptxlnk_dbt S WHERE s.t_ID = N.t_Analitic2 AND S.t_Type = RSI_NPTXC.NPTXLNK_CLPOS)
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind3 = v_ak3
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                     GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, (CASE WHEN pIIS = 1 THEN N.t_AnaliticKind6 ELSE 0 END), (CASE WHEN pIIS = 1 THEN N.t_Analitic6 ELSE 0 END)
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, pIIS, RSI_NPTXC.TXOBJ_PROC_SEC_SHORT, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6);

      v_S := v_C2 - v_C1;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_PROC_SEC_SHORT,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           v_ak3,
                                           one_rec.a3,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6, 
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);
      
      nptxobj := CreateNPTXOBJLevel3_4(1,
                                         CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                         pClient,
                                         v_d,
                                         4,
                                         RSI_NPTXC.TXOBJ_PROC_SEC_SHORT,
                                         v_S,
                                         RSI_RSB_FIInstr.NATCUR,
                                         0,
                                         -1,
                                         0,
                                         -1,
                                         v_ak3,
                                         one_rec.a3,
                                         v_ak4,
                                         one_rec.a4,
                                         v_ak5,
                                         one_rec.a5,
                                         one_rec.t_AnaliticKind6, 
                                         one_rec.t_Analitic6,
                                         'Расходы, не включаемые в НОБ',
                                         pDocID,
                                         pStep,
                                         v_Technical,
                                         pRecalc,
                                         pExistTechCalc,
                                         pTransfDate,
                                         pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  FUNCTION IsCloseDBO(p_EndDate IN DATE, p_Client IN NUMBER, pIIS IN NUMBER) RETURN NUMBER
  AS
    v_Year VARCHAR2(5);
    v_HasOpenContr NUMBER(5) := 0;
    v_HasContrTax NUMBER(5) := 0;
    v_Last NUMBER(5) := 0;
  BEGIN
    v_Year := EXTRACT(YEAR FROM p_EndDate);

    SELECT count(1) INTO v_HasOpenContr FROM dsfcontr_dbt sf 
     WHERE sf.T_PARTYID = p_Client AND sf.t_dateclose = to_date('01010001', 'ddmmyyyy') AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS;

    SELECT count(1) INTO v_HasContrTax FROM dsfcontr_dbt sf 
     WHERE sf.T_PARTYID = p_Client AND sf.t_dateclose >= to_date('01.01.'||v_Year,'DD.MM.YYYY') AND sf.t_dateclose <= to_date('31.12.'||v_Year,'DD.MM.YYYY') AND RSI_NPTO.CheckContrIIS(t_ID) = pIIS;

    IF( (p_EndDate <> to_date('31.12.'||v_Year,'DD.MM.YYYY')) OR
        ( (p_EndDate = to_date('31.12.'||v_Year,'DD.MM.YYYY')) AND
          (v_HasOpenContr = 0 and v_HasContrTax > 0))
       ) THEN
      v_Last := 1;
    END IF;

    RETURN v_Last;

  END;

  PROCEDURE SetAnalitickCloseDBO(p_EndDate IN DATE, p_Client IN NUMBER, p_Step IN NUMBER, p_DocID IN NUMBER)
  AS
    v_Year VARCHAR2(5);
  BEGIN
    v_Year := EXTRACT(YEAR FROM p_EndDate);
  
    INSERT INTO DNPTXOBJ_TMP(T_ID,  
                            T_DATE,           
                            T_CLIENT,         
                            T_DIRECTION ,     
                            T_LEVEL,          
                            T_KIND,           
                            T_SUM,            
                            T_CUR,            
                            T_ANALITICKIND1,  
                            T_ANALITIC1,      
                            T_ANALITICKIND2,  
                            T_ANALITIC2,      
                            T_ANALITICKIND3,  
                            T_ANALITIC3,      
                            T_ANALITICKIND4,  
                            T_ANALITIC4,      
                            T_ANALITICKIND5,  
                            T_ANALITIC5,      
                            T_ANALITICKIND6,  
                            T_ANALITIC6,      
                            T_COMMENT,  
                            T_DOCID,  
                            T_STEP,     
                            T_FROMOUTSYST,    
                            T_OUTSYSTCODE,    
                            T_OUTOBJID,       
                            T_SOURCEOBJID,    
                            T_TECHNICAL,      
                            T_TAXPERIOD,  
                            T_REALOBJID,  
                            T_ACTION  
                                       )  
               SELECT 0,      
                      T_DATE,           
                      T_CLIENT,         
                      T_DIRECTION ,     
                      T_LEVEL,          
                      T_KIND,           
                      T_SUM,            
                      T_CUR,            
                      T_ANALITICKIND1,  
                      T_ANALITIC1,      
                      T_ANALITICKIND2,
                      T_ANALITIC2,   
                      T_ANALITICKIND3,  
                      T_ANALITIC3,      
                      T_ANALITICKIND4,  
                      T_ANALITIC4,      
                      T_ANALITICKIND5,  
                      T_ANALITIC5,      
                      RSI_NPTXC.TXOBJ_KIND6030,  
                      -1,      
                      T_COMMENT,  
                      p_DocID,  
                      p_Step,       
                      T_FROMOUTSYST,    
                      T_OUTSYSTCODE,    
                      T_OUTOBJID,       
                      T_SOURCEOBJID,    
                      T_TECHNICAL,      
                      T_TAXPERIOD,  
                      T_OBJID,  
                      RSI_NPTXC.NPTXBC_ACTION_UPDATE   
                FROM dnptxobj_dbt  
               WHERE T_CLIENT = p_Client AND ( 
                     (t_Kind = RSI_NPTXC.TXOBJ_PREVIOUSYEAR)
                  OR (t_Kind = RSI_NPTXC.TXOBJ_GENERAL AND EXTRACT(YEAR FROM T_DATE) = v_Year));

    UPDATE DNPTXOBJ_TMP SET T_ANALITICKIND6 = RSI_NPTXC.TXOBJ_KIND6030
               WHERE T_CLIENT = p_Client AND ( 
                     (t_Kind = RSI_NPTXC.TXOBJ_PREVIOUSYEAR)
                  OR (t_Kind = RSI_NPTXC.TXOBJ_GENERAL AND EXTRACT(YEAR FROM T_DATE) = v_Year));
  END;

  /**
  @brief Расчет объектов НДР по общим комиссиям депозитария
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_22(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pContract  IN NUMBER, 
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pTechnical IN NUMBER,
                                 pRecalc    IN CHAR,
                                 pExistTechCalc IN NUMBER,
                                 pTransfDate IN DATE,
                                 pTransfKind IN NUMBER,
                                 pDateNDR    IN DATE,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_S NUMBER := 0;
  BEGIN

    pStat := 0;

    FOR one_rec IN ( SELECT sf.DatePay, sf.AllSum, sf.Currency, sf.t_ID
                       FROM (
                              ( SELECT sfdef.t_DatePay AS DatePay, (sfdef.t_Sum + sfdef.t_SumNDS) AS AllSum, sfdef.t_FIID_Sum AS Currency, sfcontr.t_ID
                                  FROM dsfcontr_dbt sfcontr, dsfdef_dbt sfdef, doproper_dbt opr 
                                 WHERE sfcontr.t_PartyID = pClient                                                          
                                   AND sfcontr.t_ServKind = RSI_NPTO.PTSK_DEPOS 
                                   AND ((pContract IS NULL) OR (pContract <= 0) OR (sfcontr.t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract))) 
                                   AND sfdef.t_SfContrID = sfcontr.t_ID 
                                   AND sfdef.t_DateFee > pBegDate
                                   AND sfdef.t_DateFee <= pEndDate
                                   AND sfdef.t_ID_Operation > 0 
                                   AND opr.t_ID_Operation = sfdef.t_ID_Operation 
                                   AND CASE WHEN (pIIS = 0 OR (pIIS = 1 AND EXISTS(SELECT 1 FROM ddlcontr_dbt dlcontr WHERE dlcontr.t_UniDepoContrID = sfcontr.t_UnionContrID and dlcontr.t_IIS = 'X'))) THEN 1 ELSE 0 END = 1 
                                   AND (  (opr.t_DocKind NOT IN (RSB_DEPO.SP_DEPOPER_UNIVOPERATION,RSB_DEPO.SP_DEPOPER_TRANSFERORDER,RSB_DEPO.SP_DEPOPER_ENROLMENT,RSB_DEPO.SP_DEPOPER_RECORDER,RSB_DEPO.SP_DEPOPER_WITHDRORDER))
                                       OR (opr.t_DocKind IN (RSB_DEPO.SP_DEPOPER_UNIVOPERATION,RSB_DEPO.SP_DEPOPER_TRANSFERORDER,RSB_DEPO.SP_DEPOPER_ENROLMENT,RSB_DEPO.SP_DEPOPER_RECORDER,RSB_DEPO.SP_DEPOPER_WITHDRORDER)
                                           AND NOT EXISTS(SELECT 1
                                                            FROM dspdraft_dbt draft 
                                                           WHERE draft.t_AutoKey = TO_NUMBER(opr.t_DocumentID) 
                                                             AND draft.t_Kind = opr.t_DocKind 
                                                             AND NOT EXISTS(SELECT 1 FROM dspdrprop_dbt spdrprop, ddlrq_dbt RQ 
                                                                             WHERE spdrprop.t_DraftID = draft.t_AutoKey 
                                                                               AND spdrprop.t_PaymentID = RQ.t_ID 
                                                                               AND spdrprop.t_DocumentKind = RSB_SECUR.DL_SECURITYDOC
                                                                               AND RQ.t_DocKind = RSB_SECUR.DL_SECURITYDOC
                                                                            )
                                                         )
                                          )
                                       )
                              ) UNION 
                              ( SELECT (CASE WHEN sfdef.t_DatePay != g_ZeroDate THEN sfdef.t_DatePay ELSE sfdef.t_DateFee END) AS DatePay, (sfdef.t_Sum + sfdef.t_SumNDS) AS AllSum, sfdef.t_FIID_Sum AS Currency, sfcontr.t_ID
                                  FROM dsfcontr_dbt sfcontr, dsfdef_dbt sfdef
                                 WHERE sfcontr.t_PartyID = pClient
                                   AND sfcontr.t_ServKind = RSI_NPTO.PTSK_DEPOS
                                   AND ((pContract IS NULL) OR (pContract <= 0) OR (sfcontr.t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract))) 
                                   AND sfdef.t_SfContrID = sfcontr.t_ID 
                                   AND (CASE WHEN sfdef.t_DatePay != g_ZeroDate THEN sfdef.t_DatePay ELSE sfdef.t_DateFee END) > pBegDate
                                   AND (CASE WHEN sfdef.t_DatePay != g_ZeroDate THEN sfdef.t_DatePay ELSE sfdef.t_DateFee END) <= pEndDate
                                   AND sfdef.t_ID_Operation = 0 
                                   AND sfdef.t_FeeType = 1 /*SF_FEE_TYPE_PERIOD*/
                                   AND SFDEF.T_STATUS = 40 /*SFDEFCOM_STATUS_PAYED*/          
                                   AND CASE WHEN (pIIS = 0 OR (pIIS = 1 AND EXISTS(SELECT 1 FROM ddlcontr_dbt dlcontr WHERE dlcontr.t_UniDepoContrID = sfcontr.t_UnionContrID AND dlcontr.t_IIS = 'X'))) THEN 1 ELSE 0 END = 1 
                              )
                            )sf
                    )
    LOOP

      InitNPTXOBJ(nptxobj);

      nptxobj.T_FUNCTIONKIND   := 1;
      nptxobj.T_DATE           := CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN one_rec.DatePay ELSE pDateNDR END;   
      nptxobj.T_CLIENT         := pCLient;
      nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
      nptxobj.T_LEVEL          := 4;
      nptxobj.T_KIND           := (CASE WHEN pIIS <> 0 THEN RSI_NPTXC.TXOBJ_GENERAL_IIS ELSE RSI_NPTXC.TXOBJ_GENERAL END);                              
      nptxobj.T_SUM            := one_rec.AllSum;                                                 
      nptxobj.T_CUR            := one_rec.Currency;                                
      nptxobj.T_ANALITICKIND1  := 0;                           
      nptxobj.T_ANALITIC1      := -1;                                   
      nptxobj.T_ANALITICKIND2  := 0;                    
      nptxobj.T_ANALITIC2      := -1;                                          
      nptxobj.T_ANALITICKIND3  := 0;                    
      nptxobj.T_ANALITIC3      := -1;                                        
      nptxobj.T_ANALITICKIND4  := 0;                    
      nptxobj.T_ANALITIC4      := -1;                                     
      nptxobj.T_ANALITICKIND5  := 0;                    
      nptxobj.T_ANALITIC5      := -1;

      IF pIIS = 0 THEN
        nptxobj.T_ANALITICKIND6  := 0;                    
        nptxobj.T_ANALITIC6      := -1;
      ELSE
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := one_rec.t_ID;
      END IF;
                                                  
      nptxobj.T_COMMENT        := (CASE WHEN pIIS <> 0 THEN 'Общие расходы по ИИС' ELSE 'Общие расходы' END);      
      nptxobj.T_DOCID          := pDocID;
      nptxobj.T_STEP           := pStep;
      nptxobj.T_TECHNICAL      := CHR(0); --Объекты GENERAL всегда не технические 
      nptxobj.T_TRANSFDATE     := pTransfDate;
      nptxobj.T_TRANSFKIND     := pTransfKind;

      nptxobj_ins.extend;
      nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  /**
  @brief По общим комиссиям по договорам ФД и СР
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_23(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pContract  IN NUMBER, 
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pTechnical IN NUMBER,
                                 pRecalc    IN CHAR,
                                 pExistTechCalc IN NUMBER,
                                 pTransfDate IN DATE,
                                 pTransfKind IN NUMBER,
                                 pDateNDR    IN DATE,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_S NUMBER := 0;
  BEGIN

    pStat := 0;

    --исключим комиссии, распределенные по сделкам в операции расчета периодич комиссиий по завершении торгового дня в БОЦБ, и расчитанные в БОЦБ и ФИССИКО в операциях формирования комиссий ПЗО по сделкам
    FOR one_rec IN (SELECT sf.DatePay, sf.AllSum, sf.Currency, sf.t_ID
                     FROM((SELECT (CASE WHEN sfdef.t_DatePay != g_ZeroDate THEN sfdef.t_DatePay ELSE sfdef.t_DateFee END) AS DatePay, (sfdef.t_Sum + sfdef.t_SumNDS) AS AllSum, sfdef.t_FIID_Sum AS Currency, sfcontr.t_ID 
                             FROM dsfcontr_dbt sfcontr, dsfdef_dbt sfdef 
                            WHERE sfcontr.t_PartyID = pClient
                              AND sfcontr.t_ServKind IN (RSI_NPTO.PTSK_STOCKDL, RSI_NPTO.PTSK_DV)
                              AND RSI_NPTO.CheckContrIIS(sfcontr.t_ID) = pIIS
                              AND ((pContract IS NULL) OR (pContract <= 0) OR (sfcontr.t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract))) 
                              AND sfdef.t_SfContrID = sfcontr.t_ID 
                              AND (CASE WHEN sfdef.t_DatePay != g_ZeroDate THEN sfdef.t_DatePay ELSE sfdef.t_DateFee END) > pBegDate
                              AND (CASE WHEN sfdef.t_DatePay != g_ZeroDate THEN sfdef.t_DatePay ELSE sfdef.t_DateFee END) <= pEndDate
                              AND sfdef.t_FeeType = 1 /*SF_FEE_TYPE_PERIOD*/   
                              AND SFDEF.T_STATUS = 40 /*SFDEFCOM_STATUS_PAYED*/         
                              AND EXISTS(SELECT 1 FROM dsfdefsrvdoc_dbt srv, dsfsrvdoc_dbt sv WHERE SRV.T_SFDEFID = SFDEF.T_ID AND SV.T_ID = SRV.T_SFSRVDOCID) 
                              AND NOT EXISTS(SELECT 1 FROM DNPTXCOMM_TMP t 
                                              WHERE t.T_ID = SFDEF.T_ID 
                                                AND t.t_Type = 2 
                                            )
                            )
                           UNION
                            (SELECT /*+ leading(SFCONTR,COM,SCOM) */ COM.T_FACTPAYDATE AS DatePay, COM.T_SUM AS AllSum, SCOM.T_FIID_COMM AS Currency, COM.T_CONTRACT AS t_id
                               FROM ddlcomis_dbt com, ddl_tick_dbt tick, dsfcomiss_dbt scom,dsfcontr_dbt sfcontr
                              WHERE     COM.T_FACTPAYDATE > pBegDate
                                    AND COM.T_FACTPAYDATE <= pEndDate
                                    AND COM.T_DOCKIND = RSB_SECUR.DL_AVRWRT
                                    AND TICK.T_DEALID = COM.T_DOCID
                                    AND RSI_RSB_FIINSTR.FI_ISKSU(tick.t_pfi) = 1
                                    AND SCOM.T_FEETYPE = COM.T_FEETYPE
                                    AND SCOM.T_NUMBER = COM.T_COMNUMBER
                                    AND sfcontr.t_PartyID = pClient
                                    AND RSI_NPTO.CheckContrIIS(sfcontr.t_ID) = pIIS
                                    AND ((pContract IS NULL) OR (pContract <= 0) OR (sfcontr.t_ID in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract))) 
                                    AND COM.T_CONTRACT=SFCONTR.T_ID
                            )
                          ) sf
                    )
    LOOP
    
      InitNPTXOBJ(nptxobj);

      nptxobj.T_FUNCTIONKIND   := 1;
      nptxobj.T_DATE           := CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN one_rec.DatePay ELSE pDateNDR END;   
      nptxobj.T_CLIENT         := pCLient;
      nptxobj.T_DIRECTION      := RSI_NPTXC.TXOBJ_DIR_OUT;        
      nptxobj.T_LEVEL          := 4;
      nptxobj.T_KIND           := (CASE WHEN pIIS <> 0 THEN RSI_NPTXC.TXOBJ_GENERAL_IIS ELSE RSI_NPTXC.TXOBJ_GENERAL END);                              
      nptxobj.T_SUM            := one_rec.AllSum;                                                 
      nptxobj.T_CUR            := one_rec.Currency;                                
      nptxobj.T_ANALITICKIND1  := 0;                           
      nptxobj.T_ANALITIC1      := -1;                                   
      nptxobj.T_ANALITICKIND2  := 0;                    
      nptxobj.T_ANALITIC2      := -1;                                          
      nptxobj.T_ANALITICKIND3  := 0;                    
      nptxobj.T_ANALITIC3      := -1;                                        
      nptxobj.T_ANALITICKIND4  := 0;                    
      nptxobj.T_ANALITIC4      := -1;                                     
      nptxobj.T_ANALITICKIND5  := 0;                    
      nptxobj.T_ANALITIC5      := -1;
                                        
      IF pIIS = 0 THEN
        nptxobj.T_ANALITICKIND6  := 0;                    
        nptxobj.T_ANALITIC6      := -1;
      ELSE
        nptxobj.T_ANALITICKIND6  := RSI_NPTXC.TXOBJ_KIND6020;                    
        nptxobj.T_ANALITIC6      := one_rec.t_ID;
      END IF;
                                                  
      nptxobj.T_COMMENT        := (CASE WHEN pIIS <> 0 THEN 'Общие расходы по ИИС' ELSE 'Общие расходы' END);      
      nptxobj.T_DOCID          := pDocID;
      nptxobj.T_STEP           := pStep; 
      nptxobj.T_TRANSFDATE     := pTransfDate;
      nptxobj.T_TRANSFKIND     := pTransfKind;

      nptxobj_ins.extend;
      nptxobj_ins(nptxobj_ins.LAST) := nptxobj;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;

  FUNCTION GetNPTXObjSum(p_BegDate IN DATE, p_EndDate IN DATE, p_Client IN NUMBER, p_Kind IN NUMBER, p_IIS IN NUMBER, p_Contract IN NUMBER) RETURN NUMBER
  AS
    v_S NUMBER;
  BEGIN

    IF p_BegDate = g_ZeroDate THEN
      SELECT NVL(SUM(t_Sum0), 0) INTO v_S
        FROM (SELECT t_Sum0 AS t_Sum0                                             
                FROM dnptxobj_dbt
               WHERE t_Date  <= TRUNC(p_EndDate, 'YEAR')-1
                 AND t_Client = p_Client
                 AND t_Kind   = p_Kind
                 AND t_Analitickind6 <> RSI_NPTXC.TXOBJ_KIND6030
                 AND (p_Contract <= 0 OR t_AnaliticKind6 = RSI_NPTXC.TXOBJ_KIND6020)
                 AND t_Analitic6 = p_Contract 
                 AND RSI_NPTO.CheckObjIIS(RSI_NPTXC.TXOBJ_KIND6020, t_Analitic6) = p_IIS
              UNION ALL 
              SELECT RSI_RSB_FiInstr.ConvSum(t_Sum, t_Cur, RSI_RSB_FIINSTR.NATCUR, t_Date, 0) AS t_Sum0
                FROM dnptxobj_tmp
               WHERE t_Date  <= TRUNC(p_EndDate, 'YEAR')-1
                 AND t_Client = p_Client
                 AND t_Kind   = p_Kind
                 AND t_Analitickind6 <> RSI_NPTXC.TXOBJ_KIND6030
                 AND (p_Contract <= 0 OR t_AnaliticKind6 = RSI_NPTXC.TXOBJ_KIND6020)
                 AND t_Analitic6 = p_Contract
                 AND RSI_NPTO.CheckObjIIS(RSI_NPTXC.TXOBJ_KIND6020, t_Analitic6) = p_IIS
             );

      IF p_Kind = RSI_NPTXC.TXOBJ_PREVIOUSYEAR THEN
        v_S := -v_S;
      END IF;
    ELSE
      SELECT NVL(SUM(t_Sum0), 0) INTO v_S 
        FROM (SELECT t_Sum0 AS t_Sum0                                             
                FROM dnptxobj_dbt
               WHERE t_Date  >= p_BegDate
                 AND t_Date  <= p_EndDate
                 AND t_Client = p_Client
                 AND t_Kind   = p_Kind
                 AND t_Analitickind6 <> RSI_NPTXC.TXOBJ_KIND6030
                 AND (p_Contract <= 0 OR t_AnaliticKind6 = RSI_NPTXC.TXOBJ_KIND6020)
                 AND t_Analitic6 = p_Contract
                 AND RSI_NPTO.CheckObjIIS(RSI_NPTXC.TXOBJ_KIND6020, t_Analitic6) = p_IIS
              UNION ALL 
              SELECT RSI_RSB_FiInstr.ConvSum(t_Sum, t_Cur, RSI_RSB_FIINSTR.NATCUR, t_Date, 0) AS t_Sum0
                FROM dnptxobj_tmp
               WHERE t_Date  >= p_BegDate
                 AND t_Date  <= p_EndDate
                 AND t_Client = p_Client
                 AND t_Kind   = p_Kind
                 AND t_Analitickind6 <> RSI_NPTXC.TXOBJ_KIND6030
                 AND (p_Contract <= 0 OR t_AnaliticKind6 = RSI_NPTXC.TXOBJ_KIND6020)
                 AND t_Analitic6 = p_Contract
                 AND RSI_NPTO.CheckObjIIS(RSI_NPTXC.TXOBJ_KIND6020, t_Analitic6) = p_IIS
             );
    END IF;

    RETURN v_S;

  END;

  /**
  @brief По общим комиссиям по договорам ФД и СР
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pTransfDate Дата трансформации ИИС в ИИС-3
  @param [in] pTransfKind Период расчета
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateTaxObjects4_24(pBegDate   IN DATE,
                                 pEndDate   IN DATE,
                                 pClient    IN NUMBER,
                                 pContract  IN NUMBER, 
                                 pIIS       IN NUMBER,
                                 pDocID     IN NUMBER,
                                 pStep      IN NUMBER,
                                 pFIID      IN NUMBER,
                                 pTechnical IN NUMBER,
                                 pRecalc    IN CHAR,
                                 pExistTechCalc IN NUMBER,
                                 pTransfDate IN DATE,
                                 pTransfKind IN NUMBER,
                                 pDateNDR    IN DATE,
                                 pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_Plus_Sec0      NUMBER;
    v_Proc_Sec0      NUMBER;
    v_PlusSec_Short0 NUMBER;
    v_S              NUMBER; 
    v_LastDBO        NUMBER := 0; 
    
    v_Technical CHAR := CHR(0);

    v_CreateNDR BOOLEAN := FALSE;

  BEGIN

    pStat := 0;

    FOR one_sfcontr IN (SELECT MP.T_SFCONTRID as SfContrID
                          FROM DDLCONTRMP_DBT MP 
                         WHERE pContract > 0 AND MP.T_DLCONTRID = pContract
                        UNION
                        SELECT -1 as SfContrIS
                          FROM DUAL
                         WHERE (pContract IS NULL) OR (pContract <= 0)
                       )
    LOOP
      v_Plus_Sec0 := GetNPTXObjSum(pBegDate, pEndDate, pClient, RSI_NPTXC.TXOBJ_PLUS_SEC, pIIS, one_sfcontr.SfContrID);


      SELECT NVL(SUM(t_Sum2), 0) INTO v_Proc_Sec0 
        FROM (SELECT DECODE(N.t_Direction, RSI_NPTXC.TXOBJ_DIR_IN, N.t_Sum0, -N.t_Sum0) AS t_Sum2
                FROM dnptxobj_dbt N, dparty_dbt pt 
               WHERE N.t_Kind = RSI_NPTXC.TXOBJ_PROC_SEC
                 AND N.t_Client = pClient
                 AND pt.t_PartyID = N.t_Client  
                 AND RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6 ) = pIIS
                 AND N.t_AnaliticKind6 = (CASE WHEN one_sfcontr.SfContrID > 0 THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                 AND N.t_Analitic6 = one_sfcontr.SfContrID
                 AND N.t_Date >= pBegDate 
                 AND N.t_Date <= pEndDate 
              UNION
              SELECT DECODE(N1.t_Direction, RSI_NPTXC.TXOBJ_DIR_IN, RSI_RSB_FiInstr.ConvSum(N1.t_Sum, N1.t_Cur, 0, n1.t_Date, 0), -RSI_RSB_FiInstr.ConvSum(N1.t_Sum, N1.t_Cur, 0, n1.t_Date, 0)) AS t_Sum0
                FROM dnptxobj_tmp N1, dparty_dbt pt1
               WHERE N1.t_Kind = RSI_NPTXC.TXOBJ_PROC_SEC
                 AND N1.t_Client = pClient
                 AND pt1.t_PartyID = N1.t_Client  
                 AND RSI_NPTO.CheckObjIIS(N1.t_AnaliticKind6, N1.t_Analitic6) = pIIS
                 AND N1.t_AnaliticKind6 = (CASE WHEN one_sfcontr.SfContrID > 0 THEN RSI_NPTXC.TXOBJ_KIND6020 else N1.t_AnaliticKind6 END)
                 AND N1.t_Analitic6 = one_sfcontr.SfContrID
                 AND N1.t_Date >= pBegDate 
                 AND N1.t_Date <= pEndDate 
             );

      v_PlusSec_Short0 := GetNPTXObjSum(pBegDate, pEndDate, pClient, RSI_NPTXC.TXOBJ_PLUS_SEC_SHORT, pIIS, one_sfcontr.SfContrID);
      IF( (v_Plus_Sec0 + v_Proc_Sec0 + v_PlusSec_Short0) = 0 ) THEN
        v_S := GetNPTXObjSum(pBegDate, pEndDate, pClient, RSI_NPTXC.TXOBJ_GENERAL, pIIS, one_sfcontr.SfContrID);
        IF(rsi_nptx.GetTaxRegFlagValue('COMMON\НДФЛ\УЧЕТ ЗАТРАТ ПРОШЛЫХ ЛЕТ', pEndDate) = 'X') THEN
          v_CreateNDR := TRUE;
          IF (IsCloseDBO(pEndDate, pClient, pIIS) = 1) THEN
            SetAnalitickCloseDBO(pEndDate, pClient, pStep, pDocID);
            v_LastDBO := 1;
          END IF; 
        END IF;
      ELSE
        v_CreateNDR := TRUE;
        v_S := GetNPTXObjSum(g_ZeroDate, pEndDate, pClient, RSI_NPTXC.TXOBJ_PREVIOUSYEAR, pIIS, one_sfcontr.SfContrID);
      END IF;
    
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_PREVIOUSYEAR,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           CASE WHEN v_LastDBO = 1 THEN RSI_NPTXC.TXOBJ_KIND6030 ELSE CASE WHEN one_sfcontr.SfContrID > 0 THEN RSI_NPTXC.TXOBJ_KIND6020 ELSE 0 END END,
                                           one_sfcontr.SfContrID,
                                           pTechnical,
                                           pRecalc);
      IF(v_CreateNDR = TRUE) THEN
        nptxobj := CreateNPTXOBJLevel3_4(1,
                                         CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                         pClient,
                                         RSI_NPTXC.TXOBJ_DIR_OUT,
                                         4,
                                         RSI_NPTXC.TXOBJ_PREVIOUSYEAR,
                                         v_S,
                                         RSI_RSB_FIINSTR.NATCUR,
                                         0,
                                         -1,
                                         0,
                                         -1,
                                         0,
                                         -1,
                                         0,
                                         -1,
                                         0,
                                         -1,
                                         CASE WHEN v_LastDBO = 1 THEN RSI_NPTXC.TXOBJ_KIND6030 ELSE CASE WHEN one_sfcontr.SfContrID > 0 THEN RSI_NPTXC.TXOBJ_KIND6020 ELSE 0 END END,
                                         one_sfcontr.SfContrID,
                                         'Общие затраты прошлых лет',
                                         pDocID,
                                         pStep,
                                         v_Technical,
                                         pRecalc,
                                         pExistTechCalc,
                                         pTransfDate,
                                         pTransfKind);

        INSERT INTO DNPTXOBJ_TMP VALUES nptxobj;
      END IF;
    END LOOP;
  END;


  /**
  @brief Материальная выгода по выпускам ц/б
  @param [in] pBegDate Дата начала расчета
  @param [in] pEndDate Дата окончания расчета
  @param [in] pClient ID клиента
  @param [in] pIIS Признак "Договор ИИС"
  @param [in] pDocID ID текущей операции
  @param [in] pStep  ID шага операции
  @param [in] pFIID  ID ценной бумаги
  @param [in] pTechnical Значение категории "Признак технического расчета" на текущей операции
  @param [in] pRecalc Признак технического расчета из панели операции
  @param [in] pExistTechCalc Существование объектов НДР с признаком "Технический", созданных ранее текущей операции
  @param [in] pDateNDR Дата НДР
  @param [out] pStat Статус расчета
  */
  PROCEDURE CreateMaterialTaxObjects4_1(pBegDate   IN DATE,
                                        pEndDate   IN DATE,
                                        pClient    IN NUMBER,
                                        pContract  IN NUMBER, 
                                        pIIS       IN NUMBER,
                                        pDocID     IN NUMBER,
                                        pStep      IN NUMBER,
                                        pFIID      IN NUMBER,
                                        pTechnical IN NUMBER,
                                        pRecalc    IN CHAR,
                                        pExistTechCalc IN NUMBER,
                                        pTransfDate IN DATE,
                                        pTransfKind IN NUMBER,
                                        pDateNDR    IN DATE,
                                        pStat     OUT NUMBER)
  IS
    TYPE nptxobj_t IS TABLE OF dnptxobj_tmp%ROWTYPE;
    nptxobj     dnptxobj_tmp%rowtype;
    nptxobj_ins nptxobj_t := nptxobj_t();

    v_C1 NUMBER;
    v_C2 NUMBER;
    v_S  NUMBER;

    v_ak3 NUMBER;
    v_ak4 NUMBER;
    v_ak5 NUMBER;
    v_d   NUMBER;

    v_Technical CHAR := CHR(0);

    v_TaxPeriod NUMBER := EXTRACT(YEAR FROM pEndDate);
    v_LucreStartTaxPeriod NUMBER := 0;
  BEGIN

    pStat := 0;

    v_ak3 := RSI_NPTXC.TXOBJ_KIND3010; --ЦБ
    v_ak4 := RSI_NPTXC.TXOBJ_KIND4010; --Категория ц/б   
    v_ak5 := RSI_NPTXC.TXOBJ_KIND5010; --Налоговая группа
    v_d   := RSI_NPTXC.TXOBJ_DIR_IN;   --Доход

    v_LucreStartTaxPeriod := RSI_NPTO.GetLucreStartTaxPeriod();

    FOR one_rec IN (SELECT N.t_Analitic3 a3, N.t_Analitic4 a4, N.t_Analitic5 a5, NVL(SUM(N.t_Sum0), 0) C2, 
                           (CASE WHEN v_TaxPeriod >= v_LucreStartTaxPeriod THEN 0 ELSE N.t_AnaliticKind6 END) as t_AnaliticKind6, 
                           (CASE WHEN v_TaxPeriod >= v_LucreStartTaxPeriod THEN -1 ELSE N.t_Analitic6 END) as t_Analitic6 
                      FROM dnptxobj_dbt N 
                     WHERE N.t_Client = pClient
                       AND (v_TaxPeriod >= v_LucreStartTaxPeriod OR RSI_NPTO.CheckObjIIS(N.t_AnaliticKind6, N.t_Analitic6 ) = pIIS)
                       AND N.t_Direction = v_d
                       AND N.t_Kind = RSI_NPTXC.TXOBJ_MATERIAL
                       AND N.t_Date >= pBegDate
                       AND N.t_Date <= pEndDate
                       AND N.t_AnaliticKind3 = v_ak3
                       AND N.t_AnaliticKind4 = v_ak4
                       AND N.t_AnaliticKind5 = v_ak5
                       AND N.t_Analitic3 = (CASE WHEN pFIID != -1 THEN pFIID ELSE N.t_Analitic3 END)
                       AND N.t_AnaliticKind6 = (CASE WHEN (pContract is not NULL) AND (pContract > 0) THEN RSI_NPTXC.TXOBJ_KIND6020 else N.t_AnaliticKind6 END)
                       AND ((pContract IS NULL) OR (pContract <= 0) OR (N.t_Analitic6 in (SELECT MP.T_SFCONTRID FROM DDLCONTRMP_DBT MP WHERE MP.T_DLCONTRID = pContract))) 
                       AND N.t_OutSystCode <> 'др. ПУ'
                       AND N.t_OutSystCode <> 'РСХБ'
                     GROUP BY N.t_Analitic3, N.t_Analitic4, N.t_Analitic5, 
                              (CASE WHEN v_TaxPeriod >= v_LucreStartTaxPeriod THEN 0 ELSE N.t_AnaliticKind6 END), 
                              (CASE WHEN v_TaxPeriod >= v_LucreStartTaxPeriod THEN -1 ELSE N.t_Analitic6 END)
                    )
    LOOP

      v_C2 := one_rec.C2;

      v_C1 := GetNPTXOBJSum_0_345(pClient, (CASE WHEN EXTRACT(YEAR FROM pEndDate) >= v_LucreStartTaxPeriod THEN -1 ELSE pIIS END), RSI_NPTXC.TXOBJ_MATERIAL_SEC, pBegDate, pEndDate, v_d, v_ak3, one_rec.a3, v_ak4, one_rec.a4, v_ak5, one_rec.a5, one_rec.t_AnaliticKind6, one_rec.t_Analitic6, 1);

      v_S := v_C2 - v_C1;
      
      v_Technical := IsTechnicalOldNPTXOBJ(pDocID, 
                                           pBegDate,
                                           pEndDate,
                                           pClient,
                                           RSI_NPTXC.TXOBJ_MATERIAL_SEC,
                                           4,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           0,
                                           -1,
                                           v_ak4,
                                           one_rec.a4,
                                           v_ak5,
                                           one_rec.a5,
                                           one_rec.t_AnaliticKind6, 
                                           one_rec.t_Analitic6,
                                           pTechnical,
                                           pRecalc);

      nptxobj := CreateNPTXOBJLevel3_4(1,
                                       CASE WHEN pDateNDR = g_ZeroDate or pDateNDR is NULL THEN pEndDate ELSE pDateNDR END,
                                       pClient,
                                       v_d,
                                       4,
                                       RSI_NPTXC.TXOBJ_MATERIAL_SEC,
                                       v_S,
                                       RSI_RSB_FIInstr.NATCUR,
                                       0,
                                       -1,
                                       0,
                                       -1,
                                       v_ak3,
                                       one_rec.a3,
                                       v_ak4,
                                       one_rec.a4,
                                       v_ak5,
                                       one_rec.a5,
                                       one_rec.t_AnaliticKind6, 
                                       one_rec.t_Analitic6,
                                       'Материальная выгода по выпускам ц/б',
                                       pDocID,
                                       pStep,
                                       v_Technical,
                                       pRecalc,
                                       pExistTechCalc,
                                       pTransfDate,
                                       pTransfKind);

      IF nptxobj.t_ID IS NOT NULL
      THEN
        nptxobj_ins.extend;
        nptxobj_ins(nptxobj_ins.LAST) := nptxobj;
      END IF;

      IF nptxobj_ins.COUNT >= g_Limit THEN
        FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
             INSERT INTO DNPTXOBJ_TMP
                  VALUES nptxobj_ins(indx);

        nptxobj_ins.Delete;
        nptxobj_ins := nptxobj_t();
      END IF;

    END LOOP;

    IF nptxobj_ins.COUNT > 0 THEN
      FORALL indx IN nptxobj_ins.FIRST .. nptxobj_ins.LAST
           INSERT INTO DNPTXOBJ_TMP
                VALUES nptxobj_ins(indx);

      nptxobj_ins.Delete;
    END IF;

  END;





END RSI_NPTXCALC;
/
