<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.6.xsd">
    <changeSet id="122_AVT_BOSS-131_metrics" author="Vladimir Zhilin">
        <createView viewName="v_metric_openbrokagreement" remarks="Количество открытых ДБО" replaceIfExists="true">
            SELECT
                COUNT(1) AS count
            FROM
                dsfcontr_dbt
            WHERE
                t_dateclose = TO_DATE ('01.01.0001', 'dd.mm.yyyy')
                AND t_servkind = 0
        </createView>
        <createView viewName="v_metric_closebrokagreement" remarks="Количество закрытых ДБО" replaceIfExists="true">
            SELECT
                COUNT(1) AS count
            FROM
                dsfcontr_dbt
            WHERE
                t_dateclose != TO_DATE ('01.01.0001', 'dd.mm.yyyy')
                AND t_servkind = 0
        </createView>
        <createView viewName="v_metric_rshb_brokclients" remarks="Количество клиентов на брокерском обслуживании, которые изначально заключили ДБО с РСХБ" replaceIfExists="true">
            SELECT
                COUNT(*) AS count
            FROM
                    (
                SELECT
                    DISTINCT
                        dsfcontr_dbt.t_partyid,
                        dobjcode_dbt.t_code
                FROM
                        dsfcontr_dbt
                LEFT JOIN dobjcode_dbt ON
                        (dsfcontr_dbt.t_partyid = dobjcode_dbt.t_objectid
                        AND dobjcode_dbt.t_codekind = 109)
                WHERE
                        t_dateclose = TO_DATE ('01.01.0001', 'dd.mm.yyyy')
                    AND t_servkind = 0)
            WHERE
                t_code IS NULL
        </createView>
        <createView viewName="v_metric_vtb_brokclients" remarks="Количество клиентов на брокерском обслуживании, которые изначально заключили ДБО с ВТБ, но были переведены в РСХБ" replaceIfExists="true">
            SELECT
                COUNT(*) AS count
            FROM
                    (
                SELECT
                    DISTINCT
                        dsfcontr_dbt.t_partyid,
                        dobjcode_dbt.t_code
                FROM
                        dsfcontr_dbt
                LEFT JOIN dobjcode_dbt ON
                        (dsfcontr_dbt.t_partyid = dobjcode_dbt.t_objectid
                        AND dobjcode_dbt.t_codekind = 109)
                WHERE
                        t_dateclose = TO_DATE ('01.01.0001', 'dd.mm.yyyy')
                    AND t_servkind = 0)
            WHERE
                t_code IS NOT NULL
        </createView>
        <createView viewName="v_metric_le_money" remarks="Остаток на брокерских счетах ЮЛ" replaceIfExists="true">
            SELECT
                DECODE(dmcaccdoc_dbt.t_currency, 0, 'RUB', 7, 'USD', 8, 'EUR', 11, 'CNY', 20, 'GBP', 19, 'CHF', 'UNKNOWN') AS ccy,
                SUM(RSB_ACCOUNT.RESTAC(dmcaccdoc_dbt.t_account, dmcaccdoc_dbt.t_currency, TRUNC(SYSDATE), 1, NULL)) AS sum
            FROM
                dmcaccdoc_dbt,
                dparty_dbt,
                dpartyown_dbt
            WHERE
                dmcaccdoc_dbt.t_owner = dparty_dbt.t_partyid
                AND dmcaccdoc_dbt.t_owner = dpartyown_dbt.t_partyid
                AND t_catid = 70
                AND dmcaccdoc_dbt.t_iscommon = 'X'
                AND dparty_dbt.t_legalform = 1
                AND dpartyown_dbt.t_partykind != 65
            GROUP BY
                dmcaccdoc_dbt.t_currency
        </createView>
        <createView viewName="v_metric_individ_money" remarks="Остаток на брокерских счетах ФЛ" replaceIfExists="true">
            SELECT
                DECODE(dmcaccdoc_dbt.t_currency, 0, 'RUB', 7, 'USD', 8, 'EUR', 11, 'CNY', 20, 'GBP', 19, 'CHF', dmcaccdoc_dbt.t_currency) AS ccy,
                SUM(RSB_ACCOUNT.RESTAC(dmcaccdoc_dbt.t_account, dmcaccdoc_dbt.t_currency, TRUNC(SYSDATE), 1, NULL)) AS sum
            FROM
                dmcaccdoc_dbt,
                dparty_dbt,
                dpersn_dbt
            WHERE
                dparty_dbt.t_partyid = dmcaccdoc_dbt.t_owner
                AND dparty_dbt.t_partyid = dpersn_dbt.t_personid
                AND t_catid = 70
                AND dmcaccdoc_dbt.t_iscommon = 'X'
                AND dparty_dbt.t_legalform = 2
                AND dpersn_dbt.t_isemployer != 'X'
            GROUP BY
                dmcaccdoc_dbt.t_currency
        </createView>
        <createView viewName="v_metric_indpred_money" remarks="Остаток на брокерских счетах ИП" replaceIfExists="true">
            SELECT
                DECODE(dmcaccdoc_dbt.t_currency, 0, 'RUB', 7, 'USD', 8, 'EUR', 11, 'CNY', 20, 'GBP', 19, 'CHF', 'UNKNOWN') AS ccy,
                SUM(RSB_ACCOUNT.RESTAC(dmcaccdoc_dbt.t_account, dmcaccdoc_dbt.t_currency, TRUNC(SYSDATE), 1, NULL)) AS sum
            FROM
                dmcaccdoc_dbt,
                dparty_dbt,
                dpersn_dbt
            WHERE
            	dparty_dbt.t_partyid = dmcaccdoc_dbt.t_owner
                AND dparty_dbt.t_partyid = dpersn_dbt.T_personid
                AND t_catid = 70
                AND dmcaccdoc_dbt.t_iscommon = 'X'
                AND dparty_dbt.t_legalform = 2
                AND dpersn_dbt.t_isemployer = 'X'
            GROUP BY
                dmcaccdoc_dbt.t_currency
        </createView>
        <createView viewName="v_metric_ucom_money" remarks="Остаток на брокерских счетах УК" replaceIfExists="true">
            SELECT
                DECODE(dmcaccdoc_dbt.t_currency, 0, 'RUB', 7, 'USD', 8, 'EUR', 11, 'CNY', 20, 'GBP', 19, 'CHF', 'UNKNOWN') AS ccy,
                SUM(RSB_ACCOUNT.RESTAC(dmcaccdoc_dbt.t_account, dmcaccdoc_dbt.t_currency, TRUNC(SYSDATE), 1, NULL)) AS sum
            FROM
                dmcaccdoc_dbt,
                dparty_dbt,
                dpartyown_dbt
            WHERE
                dparty_dbt.t_partyid = dmcaccdoc_dbt.t_owner
                AND dmcaccdoc_dbt.t_owner = dpartyown_dbt.t_partyid
                AND t_catid = 70
                AND dmcaccdoc_dbt.t_iscommon = 'X'
                AND dparty_dbt.t_legalform = 1
                AND dpartyown_dbt.t_partykind = 65
            GROUP BY
                dmcaccdoc_dbt.t_currency
        </createView>
        <createView viewName="v_metric_withdrawls" remarks="Общая сумма списаний/выводов c 306-счетов" replaceIfExists="true">
            SELECT
                DECODE(t_currency, 0, 'RUB', 7, 'USD', 8, 'EUR', 11, 'CNY', 20, 'GBP', 19, 'CHF', t_currency) AS ccy,
                SUM(t_outsum) AS sum,
                COUNT(1) AS count
            FROM
                dnptxop_dbt
            WHERE
                t_subkind_operation = 20
            GROUP BY t_currency
        </createView>
        <createView viewName="v_metric_replenishment" remarks="Общая сумма зачислений/пополнений 306-счета" replaceIfExists="true">
            SELECT
                DECODE(t_currency, 0, 'RUB', 7, 'USD', 8, 'EUR', 11, 'CNY', 20, 'GBP', 19, 'CHF', t_currency) AS ccy,
                SUM(t_outsum) AS sum,
                COUNT(1) AS count
            FROM
                dnptxop_dbt
            WHERE
                t_subkind_operation = 10
            GROUP BY t_currency
        </createView>
    </changeSet>
</databaseChangeLog>                                                                                                                            