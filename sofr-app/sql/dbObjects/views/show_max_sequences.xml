<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:pro="http://www.liquibase.org/xml/ns/pro"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.6.xsd
                            http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-4.6.xsd ">

    <changeSet id="create_view_Show_max_sequences" runOnChange="true" author="Yepanchintsev">
        <createView viewName="Show_max_sequences" replaceIfExists="true">
		 select sequence_Name, 
				 Max_Value, 
				 Min_Value, 
				 Last_Number
		  from user_sequences
		  where Max_Value > 0
			and sequence_Name in ('U_F503_SEQ',
								  (select 'U_' || (select max(t_code) from dllvalues_dbt where t_list=5053) || '_SEQ' from dual) )
			and (Last_Number / (Max_Value - 1) * 100) > 95
			
				   UNION ALL

		  select sequence_Name, 
				 Max_Value, 
				 Min_Value, 
				 Last_Number
		  from user_sequences
		  where Max_Value > 0
			and substr(sequence_Name, 1, 3) <> 'U_F'
			and (Last_Number / (Max_Value - 1) * 100) > 95
			
				   UNION ALL

		  -- есть последовательности, где числа отрицательные
		  select sequence_Name, 
				 Max_Value, 
				 Min_Value, 
				 Last_Number
		  from user_sequences
		  where Max_Value < 0
			and substr(sequence_Name, 1, 3) <> 'U_F'
			and (Last_Number / (Min_Value + 1) * 100) > 95
        </createView>
    </changeSet>
  
</databaseChangeLog>
