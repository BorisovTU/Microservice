<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:pro="http://www.liquibase.org/xml/ns/pro"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.6.xsd
                            http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-4.6.xsd ">

    <changeSet id="create_view_commissions_parameters_plans" runOnChange="true" author="Simanov">
        <createView viewName="commissions_parameters_plans" replaceIfExists="true">
        select 'comissionid:' || c.t_comissid || '-planid:' || cm.t_objectid id,
               c.t_comissid comiss_id,
               cm.t_objectid plan_id,
               case when tar.t_sign in (1, 2) then tar.t_basesum else 0 end min_base,
               case when tar.t_sign in (3, 4) then tar.t_basesum else 0 end max_base,
               case when tar.t_sign = 2 then 'true' else 'false' end is_inclusive_min_base,
               case when tar.t_sign = 4 then 'true' else 'false' end is_inclusive_max_base,
               decode(tar.t_basetype, 1, 'SUM', 2, 'QTY') base_type,
               tar.t_tariftype tariff_type,
               tar.t_tarifsum tariff_sum,
               tar.t_minvalue min_value,
               tar.t_maxvalue max_value
          from dsfconcom_dbt cm
          join dsfcomiss_dbt c on c.t_feetype = cm.t_feetype
                              and c.t_number = cm.t_commnumber
          join dsftarscl_dbt tarscl on tarscl.t_concomid = cm.t_id
          join dsftarif_dbt tar on tar.t_tarsclid = tarscl.t_id
         where cm.t_objecttype = 57
           and cm.t_objectid in (select p.t_sfplanid
                                   from dsfplan_dbt p) --to use index DSFCONCOM_DBT_IDX0
        </createView>
    </changeSet>
  
</databaseChangeLog>