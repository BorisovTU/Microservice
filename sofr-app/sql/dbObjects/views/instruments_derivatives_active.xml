<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:pro="http://www.liquibase.org/xml/ns/pro"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.6.xsd
                            http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-4.6.xsd ">

    <changeSet id="create_view_instruments_derivatives_active" runOnChange="true" author="Simanov">
        <createView viewName="instruments_derivatives_active" replaceIfExists="true">
         with rates as (
              select r.t_otherfi fiid,
                     r.t_fiid rate_fiid,
                     r.t_rate * power(10, -r.t_point) rate
                from dratedef_dbt r
                join dfideriv_dbt fd on fd.t_fiid = r.t_otherfi
               where r.t_type = 8
                 and r.t_fiid = 0
                 and fd.t_lastcirculationdate >= trunc(sysdate)
                 and r.t_sincedate = (select max(r2.t_sincedate)
                                        from dratedef_dbt r2
                                       where r2.t_fiid = r.t_fiid
                                         and r2.t_otherfi = r.t_otherfi
                                         and r2.t_type = r.t_type)         
             )
            select fd.t_fiid id,
                   decode(fi.t_avoirkind, 1, 'ФЬЮЧЕРС',
                                          2, 'ОПЦИОН') pfi_kind,
                   fi.t_fi_code fi_code,
                   fi.t_name name,
                   fi.t_definition definition,
                   fi.t_facevaluefi facevalue_fiid,
                   case when base_kind.t_name is not null then base_kind.t_name
                        when base_fi.t_fi_kind = 1 then 'Валюта'
                        when base_fi.t_fi_kind = 2 then 'Ценная бумага'
                        when base_fi.t_fi_kind = 3 then 'Индекс'
                        when base_fi.t_fi_kind = 4 then 'Производный инструмент'
                        when base_fi.t_fi_kind = 6 then 'Драгоценный металл'
                        when base_fi.t_fi_kind = 7 then 'Артикул'
                        when base_fi.t_fi_kind = 8 then 'Спец. фин. инструмент'
                   end facevalue_fi_kind,
                   case when base_fi.t_fi_kind in (fininstr_read.fi_kind_index, fininstr_read.fi_kind_derivative)
                        then null
                        else base_fi.t_facevaluefi
                   end rate_fiid,
                   fi.t_facevalue facevalue,
                   fi.t_drawingdate drawing_date,
                   fd.t_tick tick,
                   fd.t_tickpoint tick_point,
                   fd.t_tickfiid tick_fiid,
                   fd.t_pricemode pricemode,
                   decode(fd.t_optiontype, 1, 'PUT',
                                           2, 'CALL') option_type,
                   decode(fd.t_optionstyle, 1, 'Американский',
                                            2, 'Европейский') option_style,
                   fd.t_strike strike,
                   fd.t_strikefiid strike_fiid,
                   fd.t_strikepoint strike_point,
                   decode(fd.t_ismarginop, 'X', 'true', 'false') is_margin_op,
                   fininstr_read.get_mmvb_code(p_fiid => fd.t_fiid) marketplace_code,
                   r.rate as tick_cost
              from dfideriv_dbt fd
              join dfininstr_dbt fi on fi.t_fiid = fd.t_fiid
              join dfininstr_dbt base_fi on base_fi.t_fiid = fi.t_facevaluefi
              left join davrkinds_dbt base_kind on base_kind.t_fi_kind = base_fi.t_fi_kind
                                               and base_kind.t_avoirkind = base_fi.t_avoirkind
              left join rates r on r.fiid = fd.t_fiid
             where fd.t_lastcirculationdate >= trunc(sysdate)
        </createView>
    </changeSet>
  
</databaseChangeLog>