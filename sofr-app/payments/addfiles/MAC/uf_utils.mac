/*voikin 29.11.2013*/
import uf_general/*, ips_utils*/, Utils;

macro GetEDNo(SystemCode)
/*В зависимости от SystemCode возвращает EDNo для УФЭБС или для БЭСП*/
  var GetEDNo;
  var EDNo = 0;

  /*Получение EDNo для запроса*/
  GetEDNo = TRslOraQuery();
  if(SystemCode == UFSysCodeBESP)
    GetEDNo.SqlText = " begin select SEQUENCE_BESP.NEXTVAL into :EDNo from dual; end;";
  elif(SystemCode == UFSysCodeCOS)
    GetEDNo.SqlText = " begin select SEQUENCE_COS.NEXTVAL into :EDNo from dual; end;";
  else
    GetEDNo.SqlText = " begin select SEQUENCE_UFEBS.NEXTVAL into :EDNo from dual; end;";
  end;
  GetEDNo.DeclareAndSet("EDNo",EDNo);

  if(not GetEDNo.Execute())
    RunError(toansi("макрофункция GetEDNo:\r\n"+ToANSi(GetEDNo.Error)));
  end;

  EDNo = GetEDNo.GetVariable("EDNo");
  return EDNo;
end;

macro GetXMLFileName(EDNo)
/*возвращает имя xml-файла*/
  var NameFile = UFPrefixFileName+int(EDNo)+".xml";

  return NameFile;
end;

macro GetID_SU(SUname,Code,Text)
/*Возвращает из справочника SUname ID по коду Code, в третий параметр возвращается значение поля TEXT из справочника*/
  var GetSU;
  var SUID = 0;
  var SUText = "";

  GetSU = TRslOraQuery();

  GetSU.SqlText = " select t.ID_"+SUname+" as ID, t.TEXT as TEXT from "+SUname+" t where t.CODE = :CODE and RSP_COMMON.Get_DateOperDay between t.d_begin and t.d_end";

  GetSU.DeclareAndSet("CODE",Code);

  if(not GetSU.Execute())
    RunError(toansi("макрофункция GetID_SU:\r\n"+ToANSi(GetSU.Error)));
  end;

  if(not GetSU.Eof)
    SUID   = GetSU.GetByName("ID").AsInteger;
    SUTEXT = GetSU.GetByName("TEXT").AsString;
  end;
  SetParm(2,SUTEXT);

  return SUID;
end;

macro GetCODE_SU(SUname,ID,Text)
/*Возвращает из справочника SUname Code по ID, в третий параметр возвращается значение поля TEXT из справочника*/
  var GetSU;
  var SUCODE = "";
  var SUText = "";

  GetSU = TRslOraQuery();

  GetSU.SqlText = " select t.CODE as CODE, t.TEXT as TEXT from "+SUname+" t where t.ID_"+SUname+" = :ID and RSP_COMMON.Get_DateOperDay between t.d_begin and t.d_end";

  GetSU.DeclareAndSet("ID",ID);

  if(not GetSU.Execute())
    RunError(toansi("макрофункция GetCODE_SU:\r\n"+ToANSi(GetSU.Error)));
  end;

  if(not GetSU.Eof)
    SUCODE = GetSU.GetByName("CODE").AsString;
    SUTEXT = GetSU.GetByName("TEXT").AsString;
  end;
  SetParm(2,SUTEXT);

  return SUCODE;
end;


macro GetKSAccount(Korr_Code, KS_Code, FI_Code, TA_Code, IsFrn)
/*Возвращает номер счета (во внешней системе, если IsFrn == true)
по кодам контрагента, корсхемы, валюты, типа счета*/

  var AccNum = "";
  var GetKSA = TRslOraQuery();

  GetKSA.SqlText = " select ksa.accnum as accnum, ksa.accfrn as accfrn "+
                   " from nkorr k, nks ks, nksa ksa, sfi fi, sacc ta "+
                   " where k.id_nkorr = ks.id_nkorr "+
                   " and ksa.id_nks = ks.id_nks "+
                   " and fi.id_sfi = ks.id_sfi "+
                   " and ta.id_sacc = ksa.id_sacc "+
                   " and k.code = :KORR "+
                   " and ks.code = :KS "+
                   " and fi.code = :FI "+
                   " and ta.code = :TA";

  GetKSA.DeclareAndSet("KORR",Korr_Code);
  GetKSA.DeclareAndSet("KS",KS_Code);
  GetKSA.DeclareAndSet("FI",FI_Code);
  GetKSA.DeclareAndSet("TA",TA_Code);

  if(not GetKSA.Execute())
    RunError(toansi("макрофункция GetKSAccount:\r\n"+ToANSi(GetKSA.Error)));
  end;

  if(not GetKSA.Eof)
    if(IsFrn)
      AccNum = GetKSA.GetByName("accfrn").AsString;
    else
      AccNum = GetKSA.GetByName("accnum").AsString;
    end;
  end;

  return AccNum;
end;

macro GetOurBIC(Code)
/*Возвращает наши алиасы*/

  var GetBIC = TRslOraQuery();
  var OurBIC = "";

  GetBIC.SqlText = " select t.bic as ourbic "+
                   " from NROUTE t, STBIC b "+
                   " where t.id_stbic = b.id_stbic "+
                   " and b.code = :CODE "+
                   " and t.id_nkorr is null";

  GetBIC.DeclareAndSet("CODE",Code);

  if(not GetBIC.Execute())
    RunError(toansi("макрофункция GetOurBIC:\r\n"+ToANSi(GetBIC.Error)));
  end;

  if(not GetBIC.Eof)
    OurBIC = GetBIC.GetByName("ourbic").AsString;
  end;

  return OurBIC;
end;

macro GetBICKorr(Code,IDKorr)
/*Возвращает алиасы контрагента*/

  var GetBIC = TRslOraQuery();
  var KorrBIC = "";

  GetBIC.SqlText = " select t.bic as korrbic "+
                   " from NROUTE t, STBIC b "+
                   " where t.id_stbic = b.id_stbic "+
                   " and b.code = :CODE "+
                   " and t.id_nkorr = :IDKorr";

  GetBIC.DeclareAndSet("CODE",Code);
  GetBIC.DeclareAndSet("IDKorr",IDKorr);

  if(not GetBIC.Execute())
    RunError(toansi("макрофункция GetKorrBIC:\r\n"+ToANSi(GetBIC.Error)));
  end;

  if(not GetBIC.Eof)
    KorrBIC = GetBIC.GetByName("korrbic").AsString;
  end;

  return KorrBIC;
end;

macro GetSystemCodeByID(ID,IsQuery)
/*Возвращает значение поля EPD.SystemCode или ESID.SystemCode(если IsQuery == true)*/

  var GetSystemCode = TRslOraQuery();
  var SystemCode = "";
  var NameTable;

  if(IsQuery)
    NameTable = "EDQUERY";
  else
    NameTable = "EPD";
  end;

  GetSystemCode.SqlText = " select t.SystemCode as SystemCode "+
                          " from "+NameTable+" t "+
                          " where t.ID_"+NameTable+" = :ID ";

  GetSystemCode.DeclareAndSet("ID",ID);

  if(not GetSystemCode.Execute())
    RunError(toansi("макрофункция GetSystemCodeByID:\r\n"+ToANSi(GetSystemCode.Error)));
  end;

  if(not GetSystemCode.Eof)
    SystemCode = GetSystemCode.GetByName("SystemCode").AsString;
  end;

  return SystemCode;
end;

macro GetEDbyID(TableName, ID_ED)
/*Возвращает выборку из таблицы TableName с ID_ED*/
/*Для поиска ЭПС/ЭСИС*/
  if(ValType(ID_ED) == V_UNDEF)
    return;
  end;

  var GetED = TRslOraQuery();

  GetED.SqlText = " select t.* "+
                  " from "+TableName+" t "+
                  " where t.ID_"+TableName+" = :ID";

  GetED.DeclareAndSet("ID",ID_ED);

  if(not GetED.Execute())
    RunError(toansi("макрофункция GetEDbyID:\r\n"+GetED.Error));
  end;

  if(GetED.Eof)
    return;
  end;

  return GetED;
end;

macro GetEPDbyPAYM(ID_PAYM)

  var GetED = TRslOraQuery();

  GetED.SqlText = " select t.* "+
                  " from EPD t "+
                  " where t.ID_PAYM = :ID "+
                  " order by t.id_epd desc";

  GetED.DeclareAndSet("ID",ID_PAYM);

  if(not GetED.Execute())
    RunError(toansi("макрофункция GetEPDbyPAYM:\r\n"+GetED.Error));
  end;

  return GetED;

end;

macro GetPAYMbyEPD(ID_EPD)
  if(ValType(ID_EPD) == V_UNDEF)
    return null;
  end;

  var GetED = TRslOraQuery();

  GetED.SqlText = " select t.* "+
                  " from EPD t "+
                  " where t.ID_EPD = :ID "+
                  " order by t.id_epd desc";

  GetED.DeclareAndSet("ID",ID_EPD);

  if(not GetED.Execute())
    RunError(toansi("макрофункция GetPAYMbyEPD:\r\n"+GetED.Error));
  end;

  if(GetED.eof or (ValType(GetED.rec.ID_PAYM)==V_UNDEF))
    return null;
  end;

  var PayObj = GetPaymByID(int(GetED.rec.ID_PAYM));

  return PayObj;

end;

macro GetNextID(TBNAME)
  var GetID;
  var ID = 0;

  GetID = TRslOraQuery();
  GetID.SqlText = " begin select SEQUENCE_"+TBNAME+".NEXTVAL into :ID from dual; end;";
  GetID.DeclareAndSet("ID",ID);

  if(not GetID.Execute())
    RunError(toansi("макрофункция GetNextID:\r\n"+ToANSi(GetID.Error)));
  end;

  ID = GetID.GetVariable("ID");
  return ID;
end;


macro GetIDPacketInit(ID_PACKETED)

  var GetED = TRslOraQuery();
  var ID = 0;

  GetED.SqlText = "SELECT id_packeted as ID_INITPACK "+
                  "  FROM packeted                   "+
                  "  WHERE id_initpack = "+ID_PACKETED;

  if(not GetED.Execute())
    RunError(toansi("макрофункция GetIDPacketInit:\r\n"+ToANSi(GetED.Error)));
  end;

  ID = GetED.GetByName("ID_INITPACK");

  return ID;

end;
