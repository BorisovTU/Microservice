/*Сервис печати*/
import ws_file;

private macro createPayDoc(item)
  var cmd = TRslOraQuery();
  var tableName: string = "";
  var fieldName: string = "";
  var formId = int(item.ID_NFORM);

  cmd.SqlText = "begin :Table := RSP_FORM.GET_MAINTABLEFORM(:FormId, 0); :PK := RSP_FORM.GET_PK_TABLE(:Table); end;";
  cmd.DeclareAndSet("Table", tableName, "FormId", formId, "PK", fieldName);

  if(not cmd.Execute())
    RunError(ToANSI(cmd.Error));
  end;

  tableName = cmd.GetVariable("Table");
  fieldName = cmd.GetVariable("PK");
  var recordId = int(GenGetProp(item, tableName + "8" + fieldName));
  return TRslPayDoc(formId, recordId);
end;

macro printList(params)
  if (params.CurrentRow == null)
      return WebServiceResult(WebServiceResultType.Message, IMessage("Ошибка", "Нет выделенных записей", MessageBoxType.Error));
  end;

  var i = 0;
  var ListNum, item;
  var cmd = TRslOraQuery();
  var MacroName, ProcName, payDoc;
  var RepStr = "";
  cmd.SqlText = "SELECT nf.prnfileweb, nf.prnprocweb FROM nform nf WHERE nf.id_nform = :NFORM AND nf.prnprocweb IS NOT NULL";

  ListNum = IIF(params.SelectedRows.Size == 0, 1, params.SelectedRows.Size);

//  CaptureOutput();

  while(i < ListNum)
    if(params.SelectedRows.Size == 0)
      item = params.CurrentRow;
    else
      item = params.SelectedRows[i];
    end;

    cmd.DeclareAndSet("NFORM", item.ID_NFORM);

    if(not cmd.Execute())
      RunError(ToANSI(cmd.Error));
    end;

    if(cmd.Eof)
      i = i + 1;
      continue;
    end;

    MacroName = cmd.GetByName("prnfileweb").AsString;
    ProcName = cmd.GetByName("prnprocweb").AsString;
    payDoc = createPayDoc(item);
    RepStr=RepStr+RunMacro(MacroName, ProcName, payDoc);
//    ExecMacroFile(MacroName, ProcName, payDoc);
    i = i + 1;
  end;

//  RepStr = StopCaptureOutput();

  if(RepStr)
    var idrep = SaveReportHTML(RepStr, "Печать_Списка_ИД_"+params.ScrollingId+".html",""); // "text/plain");
    return GetReportFile(idrep, "Печать_Списка_ИД_"+params.ScrollingId+".html");
  end;
end;

macro printForm(params)
  var RepStr = "";
  var wParams = Xml2Rsl(params.Params);

  params.Model.ID_NFORM = params.WindowId;

  var payDoc = createPayDoc(params.Model);

  CaptureOutput();
//  RunMacro(wParams.MacroFile, wParams.MacroProc, payDoc);
  ExecMacroFile(wParams.MacroFile, wParams.MacroProc, payDoc);
  RepStr = StopCaptureOutput();

  if(RepStr)
    var idrep = SaveReportHTML(RepStr, "Печать_" + wParams.MacroFile + "." + wParams.MacroProc + ".html",""); // "text/plain");
    return GetReportFile(idrep, "Печать_" + wParams.MacroFile + "." + wParams.MacroProc + ".html");
  end;
end;
