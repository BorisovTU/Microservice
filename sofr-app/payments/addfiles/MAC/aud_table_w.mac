/*25.02.2015 karlov*/
import ws_types;

private macro UpdateNTable(NameTable, Action)
  var UpdateNTable  = TRslOraQuery();

  if(Action == "Create")
     UpdateNTable.SqlText = " UPDATE ntable t SET t.istrigger = 1, t.isLog = 1 where t.name = :NameTable";
  elif(Action == "Delete")
     UpdateNTable.SqlText = " UPDATE ntable t SET t.istrigger = null, t.isLog = null where t.name = :NameTable";
  elif(Action == "Enable")
     UpdateNTable.SqlText = " UPDATE ntable t SET t.isLog = 1 where t.name = :NameTable";
  elif(Action == "Disable")
     UpdateNTable.SqlText = " UPDATE ntable t SET t.isLog = null where t.name = :NameTable";
  end;

  UpdateNTable.DeclareAndSet("NameTable", NameTable);

  if(not UpdateNTable.Execute)
    RunError(toansi(UpdateNTable.Error));
  end;

  OraTrnCommit();
end;

macro Create_Trigger(params)
/*создание триггеров аудита для таблиц схемы*/
  var NameTable      = params.CurrentRow.NTABLE8NAME;
  var CreateTrigger = TRslOraQuery();

  CreateTrigger.SqlText = " begin RSP_AUDIT.Crt_TriggerLog(:TABLE, 'I'); end;";
  CreateTrigger.DeclareAndSet("TABLE", NameTable);

  if(not CreateTrigger.Execute)
    RunError(toansi(CreateTrigger.Error));
  else
    addptk("Создан триггер TR_LOG_" + NameTable + "_I.");
  end;

  CreateTrigger.SqlText = " begin RSP_AUDIT.Crt_TriggerLog(:TABLE, 'U'); end;";
  CreateTrigger.DeclareAndSet("TABLE", NameTable);

  if(not CreateTrigger.Execute)
    RunError(toansi(CreateTrigger.Error));
  else
    addptk("Создан триггер TR_LOG_" + NameTable + "_U.");
  end;

  CreateTrigger.SqlText = " begin RSP_AUDIT.Crt_TriggerLog(:TABLE, 'D'); end;";
  CreateTrigger.DeclareAndSet("TABLE", NameTable);

  if(not CreateTrigger.Execute)
    RunError(toansi(CreateTrigger.Error));
  else
    addptk("Создан триггер TR_LOG_" + NameTable + "_D.");
  end;

  UpdateNTable(NameTable, "Create");
  return makeArray(WebServiceResult(WebServiceResultType.Message,
                                    IMessage("Сообщение", "Созданы триггеры для аудита таблицы " + NameTable, MessageBoxType.Ok)
                                   ),
                   WebServiceResult(WebServiceResultType.Action,
                                    IAction(WebServiceActionType.Refresh)
                                   )
                  );
end;

macro EnableTrigger(params)
  var NameTable      = params.CurrentRow.NTABLE8NAME;
  var EnableTrigger = TRslOraQuery();

  EnableTrigger.SqlText = " begin RSP_AUDIT.SwitchTrigger(:TABLE, 1); end;";
  EnableTrigger.DeclareAndSet("TABLE", NameTable);

  if(not EnableTrigger.Execute)
    RunError(toansi(EnableTrigger.Error));
  else
    addptk("Включен аудит таблицы " + NameTable + ".");
  end;

  UpdateNTable(NameTable, "Enable");
  return makeArray(WebServiceResult(WebServiceResultType.Message,
                                    IMessage("Сообщение", "Включен аудит таблицы " + NameTable, MessageBoxType.Ok)
                                   ),
                   WebServiceResult(WebServiceResultType.Action,
                                    IAction(WebServiceActionType.Refresh)
                                   )
                  );
end;

macro DisableTrigger(params)
  var NameTable      = params.CurrentRow.NTABLE8NAME;
  var DisableTrigger = TRslOraQuery();

  DisableTrigger.SqlText = " begin RSP_AUDIT.SwitchTrigger(:TABLE, 0); end;";
  DisableTrigger.DeclareAndSet("TABLE", NameTable);

  if(not DisableTrigger.Execute)
    RunError(toansi(DisableTrigger.Error));
  else
    addptk("Отключен аудит таблицы "+NameTable+".");
  end;

  UpdateNTable(NameTable, "Disable");
  return makeArray(WebServiceResult(WebServiceResultType.Message,
                                    IMessage("Сообщение", "Отключен аудит таблицы " + NameTable, MessageBoxType.Ok)
                                   ),
                   WebServiceResult(WebServiceResultType.Action,
                                    IAction(WebServiceActionType.Refresh)
                                   )
                  );
end;

macro DeleteTrigger(params)
  var NameTable     = params.CurrentRow.NTABLE8NAME;
  var DeleteTrigger = TRslOraQuery();

  DeleteTrigger.SqlText = " begin RSP_AUDIT.DeleteTrigger(:TABLE); end;";
  DeleteTrigger.DeclareAndSet("TABLE", NameTable);
  if(not DeleteTrigger.Execute)
    RunError(toansi(DeleteTrigger.Error));
  else
    addptk("Удален триггер аудит таблицы "+NameTable+".");
  end;

  UpdateNTable(NameTable, "Delete");
  return makeArray(WebServiceResult(WebServiceResultType.Message,
                                    IMessage("Сообщение", "Удалены триггеры аудита таблицы " + NameTable, MessageBoxType.Ok)
                                   ),
                   WebServiceResult(WebServiceResultType.Action,
                                    IAction(WebServiceActionType.Refresh)
                                   )
                  );
end;
