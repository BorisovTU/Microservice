import ws_login;

/*Проверка монопольного режима*/
macro CountUser()
  var cmd = TRslOraQuery();
  var i;
  var p = ErrorInfo();

  cmd.sqltext = " SELECT count(*) cnt                                           "+
                "   FROM v$session                                              "+
                "   WHERE schemaname = SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA') ";

  if(not cmd.execute)
     runError(toansi(cmd.error));
  end;

  i = cmd.GetByName("CNT").AsInteger;

  if(i > 1)
    return("Не могу перейти в монопольный режим! Есть "+i+" пользователей, работающие с системой.");
  end;

end;


/*Открытие опердня*/
macro DayOpen(params, OperDate)
  var str = CountUser();
  var p   = ErrorInfo();
  var cmd = TRslOraQuery();
  var i;


  if(strLen(str))
    p.Code = 1;
    p.Str  = str;

    Return p;
  end;

  cmd.sqltext = " SELECT count(*) cnt              "+
                "   FROM dates t                   "+
                "   WHERE t.DATES = '"+OperDate+"' ";

  if(not cmd.execute)
    runError(toansi(cmd.error));
  end;

  i = cmd.GetByName("CNT").AsInteger;

  if(i > 0)
  /*Уже был такой день - переоткрытие*/
    cmd.sqltext = " UPDATE dates t                   "+
                  "   SET t.ISZ = 0                  "+
                  "   WHERE t.DATES = '"+OperDate+"' ";
  else
  /*Открытие нового дня*/
    cmd.sqltext = " INSERT INTO dates(dates, isv, isz, isblk) "+
                  "   VALUES('"+OperDate+"', 0, 0, 0)         ";
  end;

  if(not cmd.execute)
    runError(toansi("Не могу открыть день! "+cmd.error));
  end;

  OraTrnCommit();

  p.Code = 0;
  Return p;
end;


/*Закрытие опердня*/
macro DayClose
  var str = CountUser();
  var p   = ErrorInfo();
  var cmd = TRslOraQuery();

  if(strLen(str))
    p.Code = 1;
    p.Str  = str;
    Return p;
  end;

  cmd.sqltext = " UPDATE dates t                    "+
                "   SET t.ISZ = 1                   "+
                "   WHERE t.DATES = '"+{CurDate}+"' ";

  if(not cmd.execute)
    runError(toansi("Не могу закрыть день! "+cmd.error));
  end;

  OraTrnCommit();

  p.Code = 0;
  Return p;

end;
