/*25.02.2015 karlov*/

private macro SelectTable(ID)
  var NameTable  = "";
  var SelectName = TRslOraQuery();

  SelectName.SqlText = "SELECT name FROM ntable WHERE id_ntable = "+ID;

  if(not SelectName.Execute())
    RunError(toansi("Макрофункция SelectName:\r\n"+SelectName.Error));
  else
    NameTable = SelectName.GetByName("name").AsString;
    Return NameTable;
  end;

end;

private macro UpdateNTable(ID, Action)
  var UpdateNTable  = TRslOraQuery();
  if(Action == "Create")
     UpdateNTable.SqlText = " UPDATE ntable t SET t.istrigger = 1, t.isLog = 1 where t.id_ntable = :IDRow";
  elif(Action == "Delete")
     UpdateNTable.SqlText = " UPDATE ntable t SET t.istrigger = null, t.isLog = null where t.id_ntable = :IDRow";
  elif(Action == "Enable")
     UpdateNTable.SqlText = " UPDATE ntable t SET t.isLog = 1 where t.id_ntable = :IDRow";
  elif(Action == "Disable")
     UpdateNTable.SqlText = " UPDATE ntable t SET t.isLog = null where t.id_ntable = :IDRow";
  elif(Action == "Delete")
     UpdateNTable.SqlText = " UPDATE ntable t SET t.istrigger = null, t.isLog = null where t.id_ntable = :IDRow";
  end;

  UpdateNTable.DeclareAndSet("IDRow", ID);

  if(not UpdateNTable.Execute)
    RunError(toansi(UpdateNTable.Error));
  end;
  OraTrnCommit();
end;

macro Create_Trigger(ID)
/*создание триггеров аудита для таблиц схемы*/
  var CreateTrigger = TRslOraQuery();
  var NameTable     = SelectTable(ID);

  CreateTrigger.SqlText = " begin RSP_AUDIT.Crt_TriggerLog(:TABLE, 'I'); end;";
  CreateTrigger.DeclareAndSet("TABLE", NameTable);
  if(not CreateTrigger.Execute)
    RunError(toansi(CreateTrigger.Error));
  else
    addptk("Создан триггер TR_LOG_" + NameTable + "_I.");
  end;
  CreateTrigger.SqlText = " begin RSP_AUDIT.Crt_TriggerLog(:TABLE, 'U'); end;";
  CreateTrigger.DeclareAndSet("TABLE", NameTable);
  if(not CreateTrigger.Execute)
    RunError(toansi(CreateTrigger.Error));
  else
    addptk("Создан триггер TR_LOG_" + NameTable + "_U.");
  end;
  CreateTrigger.SqlText = " begin RSP_AUDIT.Crt_TriggerLog(:TABLE, 'D'); end;";
  CreateTrigger.DeclareAndSet("TABLE", NameTable);
  if(not CreateTrigger.Execute)
    RunError(toansi(CreateTrigger.Error));
  else
    addptk("Создан триггер TR_LOG_" + NameTable + "_D.");
  end;
  UpdateNTable(ID, "Create");
  RefreshScreen;
end;

macro EnableTrigger(ID)
  var EnableTrigger = TRslOraQuery();
  var NameTable     = SelectTable(ID);

  EnableTrigger.SqlText = " begin RSP_AUDIT.SwitchTrigger(:TABLE, 1); end;";
  EnableTrigger.DeclareAndSet("TABLE", NameTable);
  if(not EnableTrigger.Execute)
    RunError(toansi(EnableTrigger.Error));
  else
    addptk("Включен аудит таблицы "+NameTable+".");
  end;
  UpdateNTable(ID, "Enable");
  RefreshScreen;
end;

macro DisableTrigger(ID)
  var DisableTrigger = TRslOraQuery();
  var NameTable      = SelectTable(ID);

  DisableTrigger.SqlText = " begin RSP_AUDIT.SwitchTrigger(:TABLE, 0); end;";
  DisableTrigger.DeclareAndSet("TABLE", NameTable);
  if(not DisableTrigger.Execute)
    RunError(toansi(DisableTrigger.Error));
  else
    addptk("Отключен аудит таблицы "+NameTable+".");
  end;
  UpdateNTable(ID, "Disable");
  RefreshScreen;
end;

macro DeleteTrigger(ID)
  var NameTable     = SelectTable(ID);
  var DeleteTrigger = TRslOraQuery();

  DeleteTrigger.SqlText = " begin RSP_AUDIT.DeleteTrigger(:TABLE); end;";
  DeleteTrigger.DeclareAndSet("TABLE", NameTable);
  if(not DeleteTrigger.Execute)
    RunError(toansi(DeleteTrigger.Error));
  else
    addptk("Удалены триггеры аудита таблицы "+NameTable+".");
  end;
  UpdateNTable(ID, "Delete");
  RefreshScreen;
end;
