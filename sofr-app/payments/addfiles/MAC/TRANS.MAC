/* Процедуры транслитерации сообщений SWIFT по рекомендациям
   Национального Комитета СВИФТ РФ от 15 февраля 1995 года */
                       
Import general, TRANSFLD;


file Pay(p_Paym) Write Key 0;
file ftrr("trans_sw.usr","swift.def");
file ftr("translit.usr","swift.def");


MACRO begtr(d,tr,st);           
       i=FldNumber(st);
       in=0;
       while(in<i)
          if(ValType(st(in))==V_String)
            nfld=FldName(st,in);
            st(in)=transfield(nfld,st(in),d,tr);
          end;
          in=in+1;
       end;

       if(Not Update(Pay,GetRecordSize(rmain)+GetRecordSize(st)))
         VclMsgBox("Ошибка обновления записи");
       end;
       RefreshScreen();
end;

macro translit(PayId)

 array a;

   Pay.PaymentId = PayId;
   if(not GetEQ(Pay))
     VclMsgBox("не найден платёж " + Pay.PaymentId);
     return;
   end;
       SetRecordAddr(rmain, Pay);
       if(Pay.DocKind == Type_Doc_MT100)
         SetRecordAddr(mt100, Pay, 0,  GetRecordSize(rmain));
         st=mt100;
       elif(Pay.DocKind == Type_Doc_MT200)
         SetRecordAddr(mt200, Pay, 0,  GetRecordSize(rmain));
         st=mt200;
       elif(Pay.DocKind == Type_Doc_MT202)
         SetRecordAddr(mt202, Pay, 0,  GetRecordSize(rmain));
         st=mt202;
       elif(Pay.DocKind == Type_Doc_SFT100)
         SetRecordAddr(sft100, Pay, 0,  GetRecordSize(rmain));
         st=sft100;
       elif(Pay.DocKind == Type_Doc_SFT200)
         SetRecordAddr(sft200, Pay, 0,  GetRecordSize(rmain));
         st=sft200;
       elif(Pay.DocKind == Type_Doc_SFT202)
         SetRecordAddr(sft202, Pay, 0,  GetRecordSize(rmain));
         st=sft202;
       else
         VclMsgBox("Не умею транслитерировать форму платежа "+Pay.DocKind);
         return;
       end;
       if(((Pay.DocKind == Type_Doc_MT100)OR
          (Pay.DocKind == Type_Doc_MT200)OR
          (Pay.DocKind == Type_Doc_MT202))AND
          (Substr(st.Reference,1,1)=="'"))
         a(0)="  RUS  ->  RUR4 ";
         a(1)="  RUR4 ->  RUS  ";
       else
         a(0)="  RUS  ->  LAT  ";
         a(1)="  LAT  ->  RUS  ";
       end;

  Ind=VclMenu(a,"Выбор напрвления транслитерации",241,210);
  if(Ind==-1)
   return;
  end;

  if(a(Ind)=="  RUS  ->  LAT  ")
   begtr(0,ftr,st);
  elif(a(Ind)=="  LAT  ->  RUS  ")
   begtr(1,ftr,st);
  elif(a(Ind)=="  RUS  ->  RUR4 ")
   begtr(0,ftrr,st);
  elif(a(Ind)=="  RUR4 ->  RUS  ")
   begtr(1,ftrr,st);
  end;

end;