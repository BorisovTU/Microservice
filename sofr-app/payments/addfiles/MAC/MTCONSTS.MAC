Const IsBank = false/*ExistFile("bank.ini")*/;

Const DUMMY_BIC = "1";
Const DUMMY_BIC_TRIC = "1000";
Const FAKE_BIC = "2";
Const PB_SPLITTER = "*";

Const DUMMY_NAME = "???NAME???";
Const DUMMY_NARRATIVE_INFORMATION = "???NARRATIVE_INFORMATION???";

Const PALATADBDIR_MT = GetInit("PALATADBDIR", "BANK.INI");
Const BANK_TXT_FILE = GetInit("TEXTDIR", "BANK.INI");
Var   BANK_DBT_DIR;

If (IsBank)
   BANK_DBT_DIR = GetInit("DATABASEDIR", "BANK.INI");
Else
   BANK_DBT_DIR = GetInit("BANKDATADIR", "PALATA.INI");
End;

If (SubStr(BANK_DBT_DIR, StrLen(BANK_DBT_DIR), 1) != "\\")
   BANK_DBT_DIR = BANK_DBT_DIR + "\\";
End;

Const Verified = "V";
Const Denied   = "-";
Const Inputed  = " ";

Const NO_FIELD_OPTION = "X";
Const NO_FIELD_OPTION_PRINTABLE = "";
Const FIELD_OPTIONAL = "O", FIELD_MANDATORY = "M";
Const FIELD_STRING_SPLITTER = "\r\n";
Const FIELD_DELIM = FIELD_STRING_SPLITTER + ":";
Const KEY_CNTRL_INS = 402;
Const RussiaCountryCode = "RU";
Const RussiaCurrencyCode = "RUB";
Const AlphaStr = "0123456789abcdefghijklmnopqrstuvwxyz";
Const DigitStr = "0123456789";
Const NULL_SWIFT_DATE = Date(31, 12, 1999);
Const NULL_DATE =       Date(0, 0, 0);
Const BLOCK1_HEAD = "{1:";
Const BLOCK2_HEAD = "{2:";
Const BLOCK3_HEAD = "{3:";
Const BLOCK4_HEAD = "{4:" + FIELD_STRING_SPLITTER;
Const BLOCK5_HEAD = "{5:";
Const BLOCK_S_HEAD = "{S:";
Const BLOCK_S_MDG = "{MDG:";
Const BLOCK4_TAIL = FIELD_STRING_SPLITTER + "-}";
Const DOUBLE_MSG  = "PDM:";
Const DOUBLE_MSG2 = "PDE:";

Const MT103Sign = "MT103";
Const MT100Sign = "MT100";
Const MT200Sign = "MT200";
Const MT202Sign = "MT202";
Const MT910Sign = "MT910";

Const MT103EmptyTmpl = FIELD_STRING_SPLITTER + ":20:?" +
                       FIELD_STRING_SPLITTER + ":23B:CRED" +
                       FIELD_STRING_SPLITTER + ":32A:0000000000,0" +
                       FIELD_STRING_SPLITTER + ":50K:/?" +
                       FIELD_STRING_SPLITTER + DUMMY_NAME +
                       FIELD_STRING_SPLITTER + ":56A:" + FAKE_BIC +
                       FIELD_STRING_SPLITTER + ":57A:" + FAKE_BIC +
                       FIELD_STRING_SPLITTER + ":59:/?" +
                       FIELD_STRING_SPLITTER + DUMMY_NAME +
                       FIELD_STRING_SPLITTER + ":71A:OUR";

Const MT100EmptyTmpl = FIELD_STRING_SPLITTER + ":20:?" +
                       FIELD_STRING_SPLITTER + ":32A:0000000000,0" +
                       FIELD_STRING_SPLITTER + ":50:" + DUMMY_NAME +
                       FIELD_STRING_SPLITTER + ":56A:" + FAKE_BIC +
                       FIELD_STRING_SPLITTER + ":57A:" + FAKE_BIC +
                       FIELD_STRING_SPLITTER + ":59:/?" +
                       FIELD_STRING_SPLITTER + DUMMY_NAME +
                       FIELD_STRING_SPLITTER + ":70:" + DUMMY_NARRATIVE_INFORMATION +
                       FIELD_STRING_SPLITTER + ":71A:OUR";

Const MT200EmptyTmpl = FIELD_STRING_SPLITTER + ":20:?" +
                       FIELD_STRING_SPLITTER + ":32A:0000000000,0" +
                       FIELD_STRING_SPLITTER + ":57A:" + FAKE_BIC;

Const MT202EmptyTmpl = FIELD_STRING_SPLITTER + ":20:?" +
                       FIELD_STRING_SPLITTER + ":21:?" +
                       FIELD_STRING_SPLITTER + ":32A:0000000000,0" +
                       FIELD_STRING_SPLITTER + ":58A:" + FAKE_BIC;


ARRAY FieldSubScribe;
FieldSubScribe(13) = "@C@Time Indication@";
FieldSubScribe(20) = "@" + NO_FIELD_OPTION + "@Sender's Reference@";
FieldSubScribe(21) = "@" + NO_FIELD_OPTION + "@Related Reference@";
FieldSubScribe(23) = "@" + NO_FIELD_OPTION + "@Bank Operation Code@B@Bank Operation Code@E@Instruction Code@";
FieldSubScribe(25) = "@" + NO_FIELD_OPTION + "@Account Identification";
FieldSubScribe(26) = "@T@Transaction Type Code@";
FieldSubScribe(32) = "@A@Value Date/Currency/Amount@";
FieldSubScribe(33) = "@B@Currency/Instructed Amount@";
FieldSubScribe(36) = "@"+ NO_FIELD_OPTION + "@Exchange Rate@";
FieldSubScribe(50) = "Ordering Customer";
FieldSubScribe(51) = "Sending Institution";
FieldSubScribe(52) = "Ordering Institution";
FieldSubScribe(53) = "Sender's Correspondent";
FieldSubScribe(54) = "Receiver's Correspondent";
FieldSubScribe(55) = "Third Reimbursement Institution";
FieldSubScribe(56) = "Intermediary Institution";
FieldSubScribe(57) = "Account With Institution";
FieldSubScribe(58) = "Beneficiary Institution";
FieldSubScribe(59) = "Beneficiary Customer";
FieldSubScribe(70) = "@"+ NO_FIELD_OPTION + "@Remittance Information@";
FieldSubScribe(71) = "@A@Details of Charges@F@Sender's Charges@G@Receiver's Charges@";
FieldSubScribe(72) = "@"+ NO_FIELD_OPTION + "@Sender to Receiver Information@";

ARRAY Field23Values;
Field23Values(0) = "CREDIT";
Field23Values(1) = "CHQB";
Field23Values(2) = "CRTST";
Field23Values(3) = "SPAY";
FieldSubScribe(77) = "@B@Regulatory Reporting@T@Envelope Contents@";

ARRAY Field23BValues;
Field23BValues(0) = "CRED";
Field23BValues(1) = "CRTS";
Field23BValues(2) = "SPAY";
Field23BValues(3) = "SPRI";
Field23BValues(4) = "SSTD";

ARRAY Field23EValues;
Field23EValues(0) = "SDVA";
Field23EValues(1) = "INTC";
Field23EValues(2) = "REPA";
Field23EValues(3) = "CORT";
Field23EValues(4) = "BONL";
Field23EValues(5) = "HOLD";
Field23EValues(6) = "CHQB";
Field23EValues(7) = "PHOB";
Field23EValues(8) = "TELB";
Field23EValues(9) = "PHON";
Field23EValues(10) = "TELE";
Field23EValues(11) = "PHOI";
Field23EValues(12) = "TELI";

ARRAY Field70Values100;
Field70Values100(ASize(Field70Values100)) = "INV";
Field70Values100(ASize(Field70Values100)) = "RFB";
Field70Values100(ASize(Field70Values100)) = "ROC";

ARRAY Field70Values103;
Field70Values103(0) = "INV";
Field70Values103(1) = "RFB";
Field70Values103(2) = "ROC";
Field70Values103(3) = "IPI";

ARRAY Field71AValues100;
Field71AValues100(0) = "OUR";
Field71AValues100(1) = "BEN";

ARRAY Field71AValues103;
Field71AValues103(0) = "OUR";
Field71AValues103(1) = "BEN";
Field71AValues103(2) = "SHA";

ARRAY Field72Values103;
Field72Values103(ASize(Field72Values103)) = "ACC";
Field72Values103(ASize(Field72Values103)) = "INS";
Field72Values103(ASize(Field72Values103)) = "INT";
Field72Values103(ASize(Field72Values103)) = "REC";
Field72Values103(ASize(Field72Values103)) = "DAS";
Field72Values103(ASize(Field72Values103)) = "RPP";
Field72Values103(ASize(Field72Values103)) = "NZP";
Field72Values103(ASize(Field72Values103)) = "BNF";
Field72Values103(ASize(Field72Values103)) = "IMAD";
Field72Values103(ASize(Field72Values103)) = "FEES";
Field72Values103(ASize(Field72Values103)) = "DRRTV";

ARRAY Field72Values200;
Field72Values200(ASize(Field72Values200)) = "ACC";
Field72Values200(ASize(Field72Values200)) = "INT";
Field72Values200(ASize(Field72Values200)) = "PHON";
Field72Values200(ASize(Field72Values200)) = "PHONIBK";
Field72Values200(ASize(Field72Values200)) = "REC";
Field72Values200(ASize(Field72Values200)) = "TELE";
Field72Values200(ASize(Field72Values200)) = "TELEIBK";
Field72Values200(ASize(Field72Values200)) = "REJT";
Field72Values200(ASize(Field72Values200)) = "RETN";
Field72Values200(ASize(Field72Values200)) = "RPP";
Field72Values200(ASize(Field72Values200)) = "DAS";
Field72Values200(ASize(Field72Values200)) = "IMAD";


ARRAY Field72Values202;
Field72Values202(ASize(Field72Values202)) = "ACC";
Field72Values202(ASize(Field72Values202)) = "INS";
Field72Values202(ASize(Field72Values202)) = "INT";
Field72Values202(ASize(Field72Values202)) = "REC";
Field72Values202(ASize(Field72Values202)) = "BNF";
Field72Values202(ASize(Field72Values202)) = "PHON";
Field72Values202(ASize(Field72Values202)) = "PHONBEN";
Field72Values202(ASize(Field72Values202)) = "PHONIBK";
Field72Values202(ASize(Field72Values202)) = "TELE";
Field72Values202(ASize(Field72Values202)) = "TELEBEN";
Field72Values202(ASize(Field72Values202)) = "TELEIBK";
Field72Values202(ASize(Field72Values202)) = "NZP";
Field72Values202(ASize(Field72Values202)) = "REJT";
Field72Values202(ASize(Field72Values202)) = "RETN";
Field72Values202(ASize(Field72Values202)) = "RPP";
Field72Values202(ASize(Field72Values202)) = "DAS";
Field72Values202(ASize(Field72Values202)) = "IMAD";
Field72Values202(ASize(Field72Values202)) = "OCMT";
Field72Values202(ASize(Field72Values202)) = "CHGS";


ARRAY Field72Values100;
Field72Values100(0) = "ACC";
Field72Values100(1) = "INS";
Field72Values100(2) = "INT";
Field72Values100(3) = "RCB";
Field72Values100(4) = "BENONLY";
Field72Values100(5) = "CHEQUE";
Field72Values100(6) = "CORPTRAD";
Field72Values100(7) = "HOLD";
Field72Values100(8) = "INTRACOM";
Field72Values100(9) = "PHON";
Field72Values100(10)= "PHONBEN";
Field72Values100(11)= "PHONIBK";
Field72Values100(12)= "TELE";
Field72Values100(13)= "TELEBEN";
Field72Values100(14)= "TELEIBK";
Field72Values100(15)= "NZP";
Field72Values100(16)= "REJT";
Field72Values100(17)= "RETN";
Field72Values100(17)= "RPP";

ARRAY Field77BValues;
Field77BValues(0) = "BENEFRES";
Field77BValues(1) = "ORDERRES";

ARRAY Field13TimeCodes;
Field13TimeCodes(0) = "CLSTIME";
Field13TimeCodes(1) = "RNCTIME";
Field13TimeCodes(2) = "SNDTIME";

ARRAY Field13TimeSigns;
Field13TimeSigns(0) = "+";
Field13TimeSigns(1) = "-";

ARRAY Field26TTransactionTypeCodes;
/*Field26TTransactionTypeCodes(0) = "K90";
Field26TTransactionTypeCodes(1) = "K91";*/

ARRAY OptionD_NCSC, OptionD_NCSC_Format;
OptionD_NCSC(0) = "AT"; OptionD_NCSC_Format(0) = "05!05n";
OptionD_NCSC(1) = "AU"; OptionD_NCSC_Format(1) = "06!06n";
OptionD_NCSC(2) = "BL"; OptionD_NCSC_Format(2) = "08!08n";
OptionD_NCSC(3) = "CC"; OptionD_NCSC_Format(3) = "09!09n";
OptionD_NCSC(4) = "CH"; OptionD_NCSC_Format(4) = "06!06n";
OptionD_NCSC(5) = "CP"; OptionD_NCSC_Format(5) = "04!04n";
OptionD_NCSC(6) = "ES"; OptionD_NCSC_Format(6) = "08!09n";
OptionD_NCSC(7) = "FW"; OptionD_NCSC_Format(7) = "09!09n";
OptionD_NCSC(8) = "HK"; OptionD_NCSC_Format(8) = "03!03n";
OptionD_NCSC(9) = "IE"; OptionD_NCSC_Format(9) = "06!06n";
OptionD_NCSC(10)= "IT"; OptionD_NCSC_Format(10)= "11!23x";
OptionD_NCSC(11)= "PT"; OptionD_NCSC_Format(11)= "08!08n";
OptionD_NCSC(12)= "RU"; OptionD_NCSC_Format(12)= "09!09n.20!20n";
OptionD_NCSC(13)= "SC"; OptionD_NCSC_Format(13)= "06!06n";
OptionD_NCSC(14)= "SW"; OptionD_NCSC_Format(14)= "03!06n";
OptionD_NCSC(15)= "RU"; OptionD_NCSC_Format(15)= "09!09n";

ARRAY OptionA_NCSC, OptionA_NCSC_Format;
OptionA_NCSC(0) = "AT"; OptionA_NCSC_Format(0) = "05!05n";
OptionA_NCSC(1) = "AU"; OptionA_NCSC_Format(1) = "06!06n";
OptionA_NCSC(2) = "BL"; OptionA_NCSC_Format(2) = "08!08n";
OptionA_NCSC(3) = "CC"; OptionA_NCSC_Format(3) = "09!09n";
OptionA_NCSC(4) = "ES"; OptionA_NCSC_Format(4) = "08!09n";
OptionA_NCSC(5) = "FW"; OptionA_NCSC_Format(5) = "09!09n";
OptionA_NCSC(6) = "HK"; OptionA_NCSC_Format(6) = "03!03n";
OptionA_NCSC(7) = "IE"; OptionA_NCSC_Format(7) = "06!06n";
OptionA_NCSC(8) = "IT"; OptionA_NCSC_Format(8) = "11!23x";
OptionA_NCSC(9) = "PT"; OptionA_NCSC_Format(9) = "08!08n";
OptionA_NCSC(10)= "SC"; OptionA_NCSC_Format(10)= "06!06n";

Const ORIGIN_FORWARD = "f";
Const DOC_APP_KIND = 8;
Const SYMBOL_CASH = "  0";
Const RESULT_CARRY = 7;
Const KIND_OPER = " 1";
Const PAYMENT_PAYMENT = 6;
Const SYMBNOTBAL = "  0";

Const FIND_SWIFT = 0;
Const FIND_NATIONAL = 1;

File SerDlgCurrency(isocur, "bank.def") Key 0;
File SerDlgBIC     (bicdir, "bank.def") Key 1;
File SerDlgBIC_NAT (bankdprt, "bank.def") Key 0;

Macro FindBIC(BIC, WHAT_TO_FIND)
   If ((ValType(WHAT_TO_FIND) != V_INTEGER) OR (WHAT_TO_FIND == FIND_SWIFT))
      SerDlgBIC.BIC_Key = BIC;
      Return GetEQ(SerDlgBIC);
   Else
      SerDlgBIC_NAT.MFO_Depart = BIC;
      SerDlgBIC_NAT.Corr_Acc   = "";
      Return (GetGE(SerDlgBIC_NAT) AND (SerDlgBIC_NAT.MFO_Depart == BIC));
   End;
End;

Macro FindISOCur(Cur)
   SerDlgCurrency.ISOCode = Cur;
   Return GetEQ(SerDlgCurrency);
End;

Macro Str0L(Str, Num)
   Str = String(Str);
   Return MkStr("0", Num - StrLen(Str)) + Str;
End;

Var ClientsMPD;
Var AccountsRMPD;
Var AccountsCMPD;
Var BanksRMPD;
Var BanksCMPD;
Var CorSchsMPD;
Var PostDocCMPD;
Var PostDocRMPD;
Var BankTool;
Var DocumentMRC;

File PostDocCMPDF("postdoc$.dbt", "bank.def") Write;
File PostDocRMPDF("postdoc.dbt", "bank.def") Write;

If (IsBank)
   ClientsMPD = TBFile("client.dbt", "R", 0, NULL, "bank.def");
   AccountsRMPD = TBFile("account.dbt", "R", 0, NULL, "bank.def");
   AccountsCMPD = TBFile("account$.dbt", "R", 0, NULL, "bank.def");
   BanksRMPD = TBFile("bankdprt.dbt", "R", 0, NULL, "bank.def");
   BanksCMPD = TBFile("codebank.dbt", "R", 0, NULL, "bank.def");
   CorSchsMPD = TBFile("corschem.dbt", "R", 0, NULL, "bank.def");
   PostDocCMPD = TBFile("postdoc$.dbt", "R", 0, NULL, "bank.def");
   PostDocRMPD = TBFile("postdoc.dbt", "R", 0, NULL, "bank.def");
   BankTool    = TBFile("bank.dbt", "R", 0, NULL, "bank.def");
   DocumentMRC = TBFile("documnt$.dbt", "W", 6, NULL, "bank.def");
   If (NOT Open(PostDocCMPDF))
      MsgBox("Не могу открыть POSTDOC$.DBT");
      Exit(1);
   End;
   If (NOT Open(PostDocRMPDF))
      MsgBox("Не могу открыть POSTDOC.DBT");
      Exit(1);
   End;

End;

Macro FindMPDAccount(AccF, Cur)
   Var Acc = AccountsCMPD;
   If (Cur == 0)
      Acc = AccountsRMPD;
   End;

   Acc.Rec.Account = AccF;
   Acc.Rec.Code_Currency = Cur;

   Return Acc.GetEQ();
End;

Macro FindMPDCorSch(Num, Cur)
   CorSchsMPD.Rec.Number = Num;
   CorSchsMPD.Rec.Code_Currency = Cur;

   If (CorSchsMPD.GetEQ())
      Return TRUE;
   End;

   CorSchsMPD.Rec.Number = 0;
   CorSchsMPD.Rec.Code_Currency = Cur;

   Return CorSchsMPD.GetEQ();
End;

Macro FindMPDBank(BnkF, Cur)
   Var Bnk = BanksCMPD;
   If (Cur == 0)
      Bnk = BanksRMPD;
   End;

   Bnk.Rec.MFO_Depart = BnkF;
   Bnk.Rec.Corr_Acc = "";

   Return (Bnk.GetGE() AND (Bnk.Rec.MFO_Depart == BnkF));
End;

Macro FindMPDClient(Clnt)
   ClientsMPD.Rec.Client = Clnt;
   Return ClientsMPD.GetEQ();
End;
macro SafeGetWeakRef(_Obj)
  if (ValType(_Obj)==V_GENOBJ)
    return weakref(_Obj);
  else
    return _Obj;
  end;
end;

macro MyGetApplicationKey()
  macro AddString(str,len,symb)
    var s;
    if(ValType(str)!= V_STRING)
      str=String(str);
    end;
    var i=strlen(trim(str));

    if(i<len)
     s=MkStr(symb,len-i);
     s=s+str;
     return(s);
    else
     return(Substr(str,1,len));
    end;
  end;

  var day, mon, year, h, m, s;
  DateSplit(date(),day,mon,year);
  TimeSplit(time(),h,m,s);
  var un = UserNumber();
  return(addString(year,4,"0")+addString(mon,2,"0")+AddString(day,2,"0")+
         addString(h,2,"0")+AddString(m,2,"0")+AddString(s,2,"0")+
         addString(Random(),5,"0")+AddString(String(un),5,"0"));
end;
/*
Macro MyMakePostDoc(Doc, ErrTxt)
   Var CurAcc, CurBnk, CurDoc, Offs;

   If (FindMPDAccount(Doc.Account_Payer, Doc.Code_Currency))
      If (Doc.Code_Currency != 0)
         CurAcc = AccountsCMPD;
         CurBnk = BanksCMPD;
         CurDoc = PostDocCMPDF;
      Else
         CurAcc = AccountsRMPD;
         CurBnk = BanksRMPD;
         CurDoc = PostDocRMPDF;
      End;
   Else
      SetParm(1, "Не найден счет плательщика");
      Return 1;
   End;

   If (NOT FindMPDClient(CurAcc.Rec.Client))
      SetParm(1, "Не найден клиент счета плательщика");
      Return 2;
   End;

   Doc.Real_Payer = Doc.Account_Payer;
   Doc.OKPO_Payer = ClientsMPD.Rec.szOKPO;

   BankTool.Rec.identID = 3;
   BankTool.Rec.szName = "      ";
   BankTool.Rewind();
   While (BankTool.Next() AND (BankTool.Rec.MFO_Bank != {MFO_Bank}))
   End;
   If (BankTool.Rec.MFO_Bank == {MFO_Bank})
      If (BankTool.Rec.NameClnt == 0)
         Doc.Payer = ClientsMPD.Rec.Name_Client;
      Elif (BankTool.Rec.NameClnt == 1)
         Doc.Payer = CurAcc.Rec.NameAccount;
      Elif (BankTool.Rec.NameClnt == 2)
         Doc.Payer = ClientsMPD.Rec.Name_Client +
                     " (" +
                     CurAcc.Rec.NameAccount +
                     ")";
      Else
         Doc.Payer = ClientsMPD.Rec.szShortName +
                     " (" +
                     CurAcc.Rec.NameAccount +
                     ")";
      End;
   Else
      SetParm(1, "Не могу найти настройки банка");
      Return 6;
   End;
   Doc.Bank_Payer = {NAME_BANK};
   Doc.Origin = ORIGIN_FORWARD;

   If (Doc.Code_Currency != 0)
      Offs = 3;
   Else
      Offs = 0;
   End;

   If (NOT FindMPDBank(Doc(7), Doc.Code_Currency))
      SetParm(1, "Не найден банк получателя");
      Return 3;
   End;

   If (Trim(Doc.Bank_Receiver) == "")
       If ((Doc(7 + Offs) != DUMMY_BIC) AND (Doc(7 + Offs) != DUMMY_BIC_TRIC))
          Doc.Bank_Receiver = CurBnk.Rec.Name_Depart;
       Else
          Doc.Bank_Receiver = ".";
       End;
   End;
   Doc.Dispatch = CurBnk.Rec.Dispatch;

   If (NOT FindMPDCorSch(CurBnk.Rec.Schem, Doc.Code_Currency))
      SetParm(1, "Не найдена схема расчетов " + CurBnk.Rec.Schem + " в валюте " + Doc.Code_Currency);
      Return 4;
   End;

   Doc.Real_Receiver = CorSchsMPD.Rec.FKreditCAD;

   Doc.ApplicationKey = MyGetApplicationKey();
   Doc.iApplicationKind = DOC_APP_KIND;
   Doc.Oper = {OPER};
   Doc.Symbol_Cach = SYMBOL_CASH;
   Doc.Result_Carry = RESULT_CARRY;
   Doc.Date_Document = {CURDATE};
   Doc.Kind_Oper = KIND_OPER;
   Doc.Payment = PAYMENT_PAYMENT;
   Doc.SymbNotBal = SYMBNOTBAL;

   Copy(CurDoc, Doc);

   If (NOT Insert(CurDoc))
      SetParm(1, "Не могу вставить отложенный документ");
      Return 5;
   End;

   Return 0;
End;
*/
