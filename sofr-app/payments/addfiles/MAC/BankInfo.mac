/*********************************************************************
 Macro  : BankInfo.mac
 Created: 08-19-2009 04:36 PM
 Вспомомогательный класс для получения информации о банках
**********************************************************************/
import /*fakesql,*/general, Utils;

CLASS SQLBankInfo ( )
  var BankName = "",
      Superior = 0,
      SuperiorBic = "",
      LatName = "",
      Bic = "",
      Country = "",
      Place = "",
      NamePlace = "",
      CorAcc = "",
      Adress = "";

  MACRO ClearValues ()
      BankName = "";
      Superior = 0;
      SuperiorBic = "";
      LatName = "";
      Bic = "";
      Country = "";
      Place = "";
      NamePlace = "";
      CorAcc = "";
      Adress = "";
  END;


  MACRO FindBank (_bic, codeKind)
    var qry = "",
        Recordset = null, Ret = false;
    ClearValues();
    _bic = trim(_bic);
    if(_bic == "")
     return false;
    end;


    Recordset = TRslOraQuery();
    Recordset.SqlText = "select b.name as bankname, b.id_tbic as id_tbic, b.bic as BIC, b.bic_ext as coracc, '' as latname, b.country as country, b.city as place, '' as NamePlace, b.adres as Adress "+
                        "from sbanks b "+
                        "where b.bic = :bic "; 
    Recordset.DeclareAndSet("bic",_bic);

    if(Valtype(codekind) != V_UNDEF)
      Recordset.SqlText = Recordset.SqlText+"and b.id_tbic = :id_tbic";
      Recordset.DeclareAndSet("id_tbic",codeKind);
    end;

    if(not Recordset.Execute())
      RunError(toansi("SQLBankInfo.FindBank:"+Recordset.Error));
    end;

    if (Recordset.RowCount == 0)
      AddPtk ("Поиск банка с БИК =" + _Bic + " вида " + CodeKind + ": ошибка в запросе");
      Ret = false;
    else
      BankName    = Recordset.GetByName("BankName").AsString;
      Bic         = Recordset.GetByName("BIC").AsString;
      Country     = Recordset.GetByName("Country").AsString;
      Place       = Recordset.GetByName("Place").AsString;
      Adress      = Recordset.GetByName("Adress").AsString;
      Ret         = true;
    end;

    return Ret;
  END;
END;

var BankListRset = SQLBankInfo();


/* поиск в ОДБ БИКа BIC типа CodeKind*/
MACRO FindBank (bic, codeKind)
  var ret ;
/*
  if (valtype(codeKind) == V_UNDEF)
  //   codeKind = ODBBankCodeSwift;
     codeKind = BicRUS_ID;  
  end;
*/
  ret = BankListRset.FindBank(bic, codeKind);
  if (not ret)
    AddPtk("В справочнике отсутствует банк с БИК " + Bic + " вида " + CodeKind);
  end;
  return ret;
END;
