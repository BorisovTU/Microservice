/*voikin 09.04.2014*/
const ArmXRightCode = 130;

macro GetRightID(RightCode)
  var RightID;
  var Query = TRslOraQuery();

  Query.SqlText = " select t.ID_SRIGHT from SRIGHT t where t.CODE = :CODE";
  Query.DeclareAndSet("CODE",ArmXRightCode);

  if(not Query.Execute())
    RunError(toansi("макрофункция GetRightID:\r\n"+ToANSi(Query.Error)));
  end;

  if(not Query.Eof)
    RightID = Query.GetByName("ID_SRIGHT").AsInteger;
  end;

  return RightID;
end;

macro Get_Right_By_User(RightID, Razr)

  var RES = 0;
  var Query = TRslOraQuery();

  Query.SqlText = " begin  :RES := RSP_FORM.GET_RIGHT_BY_USER (:IDRIGHT,:RAZR); end;";
  Query.DeclareAndSet("RES",RES,"IDRIGHT",RightID,"RAZR",Razr);

  if(not Query.Execute())
    RunError(toansi("макрофункция Get_Right_By_User:\r\n"+ToANSi(Query.Error)));
  end;

  RES = Query.GetVariable("RES");

  return RES;
end;

macro Get_Right_By_Select(RightID,USERNICK)

  var RES = 0;
  var Query = TRslOraQuery();

  Query.SqlText = " select t.ID_URIGHT from URIGHT t where t.ID_SRIGHT = :ID_SRIGHT and USERNICK = :USERNICK";
  Query.DeclareAndSet("ID_SRIGHT",RightID,"USERNICK",USERNICK);

  if(not Query.Execute())
    RunError(toansi("макрофункция Get_Right_By_Select:\r\n"+ToANSi(Query.Error)));
  end;

  if(not Query.Eof)
    return true;
  end;

  return false;
end;


macro Get_Context_Var(Var_)
  var RES = "";
  var Query = TRslOraQuery();

  Query.SqlText = " begin  :RES := SYS_CONTEXT ('RSP_ADM_CTX',:VAR); end;";
  Query.DeclareAndSet("RES",RES,"VAR",Var_);

  if(not Query.Execute())
    RunError(toansi("макрофункция Get_Context_Var:\r\n"+ToANSi(Query.Error)));
  end;

  RES = Query.GetVariable("RES");

  return RES;
end;


macro TestUserRight()
  var ArmXRightID = GetRightID(ArmXRightCode);
  var Razr = "";
  var Context_Var = "USERID";

  AddPtk("Проверка полномочий пользователя");
  AddPtk("Пользователь:"+{Oper});
  AddPtk("GET_RIGHT_BY_USER("+ArmXRightID+",'"+Razr+"')="+Get_Right_By_User(ArmXRightID, Razr));
  AddPtk("Получение полномочия с помощью запроса (из URIGHT):"+String(Get_Right_By_Select(ArmXRightID,{Oper})));
  AddPtk("Контекстная переменная "+Context_Var+" = "+Get_Context_Var(Context_Var));

end;
