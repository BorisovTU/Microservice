/*****T:\payments_security\payments_test\MAC\SSWIFT.MAC*************************************************************************
 Выгрузка документов в АБС (НРД-Репозитарий)

Настройка:
Изменения: 14.06.2018 karlov
*******************************************************************************/
import general, Utils, "unistr.d32", delzero;

Macro LoadToABS(p)
  var Insert_TMP_XML = TRslOraQuery();

  var PayObj = p;
  var PayRec = PayObj.paym;
  var Msg    = p.msgrepo;
var a = payrec.inputdate;

  Insert_TMP_XML.SqlText = " insert into IR_SRS_TMP (t_fmtclobdata_xxxx, t_loaddatetime) values(:IMP_STRING, :INPUTDATE) ";
  Insert_TMP_XML.DeclareAndSetLOB("IMP_STRING", Msg.str);
  Insert_TMP_XML.DeclareAndSet("INPUTDATE", payrec.inputdate);

  if(not Insert_TMP_XML.Execute())
    RunError(toansi(Insert_TMP_XML.Error));
  end;

  var LoadABS = TRslOraQuery();

  var Ret = 0;
  var InterMesID = 0;
  var Txt = "";
  LoadABS.SqlText = " begin :Ret := RSB_PAYMENTS_API.GenerationSRSFromInput(:Text, :InterMesID); end;";
  LoadABS.DeclareAndSet("Ret",Ret, "Text", Txt, "InterMesID", InterMesID);

  if(not LoadABS.Execute)
    RunError(toansi(LoadABS.Error));
  end;

  Ret = LoadABS.GetVariable("Ret");

  if(Ret != 0)
    return false;
  end;

  return true;
end;

Macro LoadToABSmas(TbName)
var a = TbName;

   var cmd = TRslOraQuery();
   var Delete_TMP_XML = TRslOraQuery();
   var Insert_TMP_XML = TRslOraQuery();
   var InsertProtocol = TRslOraQuery();
   var InsertProtHeader = TRslOraQuery();
   var InsertProtLoad = TRslOraQuery();
   var InsertProtProc = TRslOraQuery();
   var LoadABS = TRslOraQuery();
   var ProcABS = TRslOraQuery();
   var Ret = 0;
   var InterMesID = 0;
   var Txt = "";
   var str, indate, paym, vr;
   var UpdateTMP = TRslOraQuery();
   var Insert_OP = TRslOraQuery();
   var Date_OP   = {curdate};
   var OperDprt = 1;  // получить корректный департамент
   var OperDprtNode = 1; // получить корректный филиал
   var ID_OP     = 0;
   var ID_oper   = 0;
   var stat      = 0;
   var first     = true;
   var state;
   var Protocol  = "";
   var Property  = "";

   cmd.sqlText = "  select m.str, p.inputdate, "+
                 "         t.id_paym, t.vr     "+
                 "  from paym p,               "+
                 "       msgrepo m,            "+
                 "       "+TbName+" t          "+
                 " where p.id_paym = m.id_paym "+
                 "   and p.id_paym = t.id_paym "+
                 "   and p.versionrec= t.vr";

   if(not cmd.Execute)
     RunError(toansi(cmd.Error));
   end;
//debugbreak;
   while(not cmd.EoF)
////// создаем операцию для входящих сообщений
////// пока не создаем, может переделаем на ТК
////// если запуск не через ТК, тогда надо устанавливать контексты (опердень, филиал, подразделение; может еще какие-либо)

     if(first)
       Insert_OP.SqlText = "begin :STAT := RSB_PAYMENTS_API.InsertOP_SRS(:ID_OP,:ID_OPER); end;";
       Insert_OP.DeclareAndSet("STAT",0,"ID_OP",0,"ID_OPER",0);

       if(not Insert_OP.Execute)
         RunError(toansi(Insert_OP.Error));
       end;
        stat  = Insert_OP.GetVariable("STAT");
        ID_OP = Insert_OP.GetVariable("ID_OP");
        ID_oper = Insert_OP.GetVariable("ID_OPER");

        if(stat != 0)
           Txt = "Ошибка создания операции в АБС.";
           UpdateTMP.sqlText = "update "+TbName+" t                     "+
                               "   set t.id_sstate = "+StateErrorABS+", "+
                               "       t.varlen    = '"+Txt+"'";
           UpdateTMP.Execute();
           Addptk ("Ошибка создания в АБС операции обработки входящих сообщений.");
           break;
        end;

       first = false;
       Protocol = "<ReportNumber Number=\"0\">\r\n";
     end;

     str    = cmd.Rec.str;
     indate = cmd.Rec.inputdate;
     paym   = cmd.Rec.id_paym;
     vr     = cmd.Rec.vr;

     Delete_TMP_XML.SqlText = " delete from IR_SRS_TMP";

     if(not Delete_TMP_XML.Execute())
       RunError(toansi(Delete_TMP_XML.Error));
     end;

     Insert_TMP_XML.SqlText = " insert into IR_SRS_TMP (t_fmtclobdata_xxxx, t_loaddatetime) values(:IMP_STRING, :INPUTDATE) ";
     Insert_TMP_XML.DeclareAndSetLOB("IMP_STRING", str);
     Insert_TMP_XML.DeclareAndSet("INPUTDATE", indate);

     if(not Insert_TMP_XML.Execute())
       RunError(toansi(Insert_TMP_XML.Error));
     end;

     LoadABS.SqlText = " begin :Ret := RSB_PAYMENTS_API.GenerationSRSFromInput(:Text, :InterMesID, :ID_OP, :Property); end;";       //вместо 0 надо передавать ID операции
     LoadABS.DeclareAndSet("Ret",Ret, "Text", Txt, "InterMesID", InterMesID, "ID_OP", ID_OP, "Property", Property);

     if(not LoadABS.Execute)
       Txt = LoadABS.Error;
       Ret = 1;
       state = StateErrorABS;
       AddPtk ("Ошибка выгрузки в АБС СРС ИД = "+int(paym)+": "+LoadABS.Error);
     else
       Txt = LoadABS.GetVariable("Text");
       Ret = LoadABS.GetVariable("Ret");
       if(Ret == 1)
         state = StateErrorABS;
       elif(Ret > 1)
         state = StateIgnorABS;
       end;
     end;

     if(Ret != 0)
       UpdateTMP.sqlText = "update "+TbName+" t             "+
                           "   set t.id_sstate = "+state+", "+
                           "       t.varlen = '"+Txt+"'     "+
                           " where t.id_paym = "+paym+"     "+
                           "   and t.vr = "+vr;
     else
       UpdateTMP.sqlText = "update "+TbName+" t         "+
                           "   set t.varlen = '"+Txt+"' "+
                           " where t.id_paym = "+paym+" "+
                           "   and t.vr = "+vr;
     end;

     UpdateTMP.Execute();
     Property = LoadABS.GetVariable("Property");
     Protocol = Protocol + Property +"\r\n";
     cmd.Next();
   end;

   Protocol = Protocol +"</ReportNumber>";
   InsertProtLoad.SqlText = "begin RSB_PAYMENTS_API.InsertLogDate(:ID_OP, 4869, 1,:ID_OPER,:Protocol); end;";
   InsertProtLoad.DeclareAndSet("ID_OP",ID_OP,"ID_OPER",ID_OPER,"Protocol", Protocol);

   if(not InsertProtLoad.Execute)
     RunError(toansi(InsertProtLoad.Error));
   end;
/*
   InsertProtocol.SqlText = " begin RSB_PAYMENTS_API.InsertProtocol(:Protocol); end; ";
   InsertProtocol.DeclareAndSet("Protocol", Protocol);

   if(not InsertProtocol.Execute())
     RunError(toansi(InsertProtocol.Error));
   end;
*/
   Protocol = "<ReportNumber Number=\"0\">\r\n";
   var Prot32 = "";
   ProcABS.SqlText = " begin :Ret := RSB_PAYMENTS_API.ProcInboundSRS(:Prot32,:ID_OP); end;";
   ProcABS.DeclareAndSet("Ret",Ret, "ID_OP",ID_OP);
   ProcABS.DeclareAndSetLob("Prot32", Prot32);

   if(not ProcABS.Execute)
     RunError(toansi(ProcABS.Error));
   end;
   Prot32 = ProcABS.GetVariable("Prot32");

   Protocol = Protocol + Prot32 +"</ReportNumber>";

   InsertProtProc.SqlText = "begin RSB_PAYMENTS_API.InsertLogDate(:ID_OP, 4869, 4,:ID_OPER,:Protocol); end;";
   InsertProtProc.DeclareAndSet("ID_OP",ID_OP,"ID_OPER",ID_OPER,"Protocol", Protocol);

   if(not InsertProtProc.Execute)
     RunError(toansi(InsertProtProc.Error));
   end;


   return true;

OnError(e)
  AddPtk ("Выгрузка СРС в АБС: " + ToOem(e.Message) + " | Модуль " + e.Module + " | Строка " + e.Line);
  return false;
end;