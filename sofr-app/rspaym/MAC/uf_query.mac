
/*23.12.2013 voikin*/
import uf_general, uf_utils, ips_general, ips_utils;

var OEPD_ID_paym;

macro SetEDQuery(EDQuery,EDNO,TYP,SYSTEMCODE)

  EDQuery.EDNO       = EDNO;
  EDQuery.EDDATE     = {CurDate};
  EDQuery.EDAUTHOR   = UFEDAuthor;
  EDQuery.EDRECEIVER = UFEDReceiver;
  EDQuery.TYP        = TYP;
  EDQuery.USERS      = {Oper};
  EDQuery.SYSTEMCODE = SYSTEMCODE;
  EDQuery.IN_OUT     = 1;
  EDQuery.STATUS     = 0;

end;

macro GetEDREceiverFromBIC(BIC)
/*Возвращает значение для поля EDReceiver на основании БИКа (BIC):
два первых символа отрезает, в конец добавляет "000"*/

  return SubStr(BIC,3)+"000";
end;


/*функция создания запроса ED999*/
macro create_999(SystemCode)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SystemCode);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_QUERY,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED999",SYSTEMCODE);

  if(not QueryObj.Save())
    RunError(ToANSi(QueryObj.Error));
  end;

  OraTrnCommit();
  AddPtk("Создание ED999: создан запрос ИД = "+int(QueryObj.EDQuery.ID_EDQUERY));
  MsgBox("Создан запрос ED999 ИД = "+int(QueryObj.EDQuery.ID_EDQUERY));

  OnError(e)
    OraTrnRollBack();
    AddPtk ("Создание ED999: " + ToOem(e.Message) + " | Модуль " + e.Module + " | Строка " + e.Line);
    MsgBox(ToOem(e.Message));

end;

/*функция создания запроса ED573*/
macro create_573

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(UFSysCodeCOS);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED573,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED573",UFSysCodeCOS);

  return QueryObj;

end;

/*функция создания запроса ED599*/
macro create_599

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(UFSysCodeCOS);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_QUERY,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED599",UFSysCodeCOS);

  if(not QueryObj.Save())
    RunError(ToANSi(QueryObj.Error));
  end;

  OraTrnCommit();
  AddPtk("Создание ED599: создан запрос ИД = "+int(QueryObj.EDQuery.ID_EDQUERY));
  MsgBox("Создан запрос ED599 ИД = "+int(QueryObj.EDQuery.ID_EDQUERY));

  OnError(e)
    OraTrnRollBack();
    AddPtk ("Создание ED599: " + ToOem(e.Message) + " | Модуль " + e.Module + " | Строка " + e.Line);
    MsgBox(ToOem(e.Message));

end;

/*функция создания запроса ED202*/
macro create_202(ID,SYSTEMCODE,INQUIRYCODE)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED202,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED202",SYSTEMCODE);

  if(INQUIRYCODE == 3)
    QueryObj.EDQuery.ID_INITPACK = ID;
  else
    QueryObj.EDQuery.ID_EPD     = ID;
  end;

  if(INQUIRYCODE != Null)
    QueryObj.ED202.ID_SUEDCODE = INQUIRYCODE;
  end;

  if(not QueryObj.Save())
    RunError(ToANSi(QueryObj.Error));
  end;
  return(int(QueryObj.EDQuery.ID_EDQUERY));

end;

/*функция создания запроса ED203*/
macro create_203(SYSTEMCODE)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED203,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED203",SYSTEMCODE);

  QueryObj.ED203.ACC              = GetKSAccount(NumKor, NumKS, 0, TypeAccKor, true);
  QueryObj.ED203.ID_SUSTATUS      = GetID_SU("SUSTATUS",SUSTATUS_DEF,QueryObj.ED203.ID_SUSTATUS8TEXT);
  QueryObj.ED203.ID_SUGRCODE      = GetID_SU("SUGRCODE",SUGRCODE_DEF,QueryObj.ED203.ID_SUGRCODE8TEXT);

  return QueryObj;
end;


/*функция создания запроса на отзыв*/
macro create_204(ID,SYSTEMCODE,CODE/*0 - не пакет, 1 - пакет*/)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED204,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED204",SYSTEMCODE);

  if(CODE == 1)
    QueryObj.EDQuery.ID_INITPACK = ID;
  else
    QueryObj.EDQuery.ID_EPD     = ID;
  end;

  if(CODE != Null)
    QueryObj.ED204.Code     = CODE;/*0 - не пакет, 1 - пакет*/
  end;

  if(not QueryObj.Save())
    RunError(ToANSi(QueryObj.Error));
  end;
  return(int(QueryObj.EDQuery.ID_EDQUERY));

end;

/*функция создания запроса ED210*/
macro create_210(SYSTEMCODE)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED210,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED210",SYSTEMCODE);

  QueryObj.ED210.ABSTRACTDATE = {CurDate};
  QueryObj.ED210.ACC = GetKSAccount(NumKor, NumKS, 0, TypeAccKor, true);
  QueryObj.ED210.ID_SUREQUEST = GetID_SU("SUREQUEST",SUREQUEST_DEF,QueryObj.ED210.ID_SUREQUEST8TEXT);

  return QueryObj;
end;

/*функция создания ответа ED214*/
macro create_214(SYSTEMCODE,ID_EPD,ID_PACKETED,EDRECEIVER)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED214,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  QueryObj.EDANSWER.EDNO       = EDNO;
  QueryObj.EDANSWER.EDDATE     = {CurDate};
  QueryObj.EDANSWER.EDAUTHOR   = UFEDAuthor;
  QueryObj.EDANSWER.EDRECEIVER = EDRECEIVER;/*должен быть банк-отправитель инф. платежа*/
  QueryObj.EDANSWER.TYP        = "ED214";
  QueryObj.EDANSWER.USERS      = {Oper};
  QueryObj.EDANSWER.IN_OUT     = 1;
  QueryObj.EDANSWER.STATUS     = 0;

  QueryObj.EDANSWER.ID_EPD        = ID_EPD;
  QueryObj.EDANSWER.ID_INITPACK   = ID_PACKETED;

  return QueryObj;
end;


/*функция создания запроса ED218*/
macro create_218(SYSTEMCODE)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED218,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED218",SYSTEMCODE);

  QueryObj.ED218.REPORTDATE = {CurDate};
  QueryObj.ED218.ID_SUMAKCODE = GetID_SU("SUMAKCODE",SUMAKCODE_DEF,QueryObj.ED218.ID_SUMAKCODE8TEXT);

  return QueryObj;
end;

/*11.02.2015 функция создания запроса ED240*/
macro create_240(SYSTEMCODE)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED240,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED240",SYSTEMCODE);

  return QueryObj;
end;

/*функция создания запроса ED243*/
macro create_243(Type_Doc,SYSTEMCODE,ID, ID_PAYM)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED243",SYSTEMCODE);
  QueryObj.EDQuery.ID_EPD     = ID;

  var IDPaym = GetNextID("PAYM");
  var ID_EDQuery = GetNextID("EDQUERY");

  QueryObj.paym.ID_Paym       = IDPaym;
  QueryObj.paym.NODEPAYMENTID = IDPaym;
  QueryObj.paym.NODEID        = {NumNode};
  QueryObj.paym.ID_SSTATE     = STATE_ESIDCREATED;
  QueryObj.paym.CURRSTATEDATE = Date();
  QueryObj.paym.id_spClass    = Class_Doc_Out;
  QueryObj.paym.ISINF         = 1;/*Информационный*/

  QueryObj.paym.VALUEDATE     = QueryObj.EDQUERY.EDDATE;
  QueryObj.paym.DATEREFERDOC  = QueryObj.EDQUERY.EDDATE;
  QueryObj.paym.INPUTDATE     = Date();
  QueryObj.paym.NUMREFERDOC   = QueryObj.EDQUERY.EDNO;


  QueryObj.EDQUERY.ID_EDQUERY = ID_EDQUERY;
  QueryObj.EDQUERY.ID_NFORM   = Type_Doc_ED243;
  QueryObj.ED243.ID_EDQUERY   = ID_EDQUERY;

  if(ValType(ID_PAYM) != V_UNDEF)
      var MainPayObj = GetPaymByID(int(ID_PAYM));
      if(ValType(MainPayObj) == V_GENOBJ)
          QueryObj.ED243.ACCDOCDATE    =  MainPayObj.paym.DATEREFERDOC;
          QueryObj.ED243.ACCDOCNO  =  MainPayObj.paym.NUMREFERDOC;
          QueryObj.ED243.SUM     =  MainPayObj.paym.AMOUNT;
          QueryObj.ED243.PAYERACC=  MainPayObj.paym.PAYERACCOUNT;
          QueryObj.ED243.PAYEEACC=  MainPayObj.paym.RECEIVERACCOUNT;
          QueryObj.ED243.PAYERNAME=  MainPayObj.rmain.PAYER;
          QueryObj.ED243.PAYEENAME=  MainPayObj.rmain.RECEIVER;
      end;
  end;

  return QueryObj;
end;

/*13.02.2015 karlov*/
/*функция создания запроса ED242 из списка Запросов*/
macro create_242(SYSTEMCODE,ID)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED242,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED242",SYSTEMCODE);

  QueryObj.ED242.ID_SUREPEAT = GetID_SU("SUREPEAT",SUREPEAT242_DEF,QueryObj.ED242.ID_SUREPEAT8TEXT);

  return QueryObj;

end;

/*13.02.2015 karlov*/
/*функция создания запроса ED242 из форм Отправленных ЭПС/пакетов ЭПС*/
macro create_ED242EPDOUT(SYSTEMCODE,EDTYP,ID)
  var Text = "";
  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);
  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED242,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED242",SYSTEMCODE);
  QueryObj.EDQuery.ID_EPD = ID;

  QueryObj.ED242.ID_SUREPEAT = GetID_SU("SUREPEAT",SUREPEAT242ESOUT_DEF,QueryObj.ED242.ID_SUREPEAT8TEXT);
  QueryObj.ED242.ID_SUEDTYP  = GetID_SU("SUEDTYP",StrSubst(EDTYP,"ED","0"),Text);

  return QueryObj;
end;

/*функция создания ответа ED244*/
macro create_244(Type_Doc,EPD_ESID,IsEPD)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  if(IsEPD)
    EDNo = GetEDNo(EPD_ESID.EPD.SYSTEMCODE);
  else
    EDNo = GetEDNo(EPD_ESID.EDQuery.SYSTEMCODE);
  end;

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  var IDPaym = GetNextID("PAYM");
  var ID_EDAnswer = GetNextID("EDANSWER");

  QueryObj.paym.ID_Paym       = IDPaym;
  QueryObj.paym.NODEPAYMENTID = IDPaym;
  QueryObj.paym.NODEID        = {NumNode};
  QueryObj.paym.ID_SSTATE     = STATE_ESIDCREATED;
  QueryObj.paym.CURRSTATEDATE = Date();
  QueryObj.paym.id_spClass    = Class_Doc_Out;
  QueryObj.paym.ISINF         = 1;/*Информационный*/

  QueryObj.EDANSWER.ID_EDANSWER = ID_EDANSWER;
  QueryObj.EDANSWER.ID_NFORM    = Type_Doc_ED244;
  QueryObj.ED244.ID_EDANSWER    = ID_EDANSWER;


  QueryObj.EDANSWER.EDNO       = EDNO;
  QueryObj.EDANSWER.EDDATE     = {CurDate};
  QueryObj.EDANSWER.EDAUTHOR   = UFEDAuthor;
  //QueryObj.EDANSWER.EDRECEIVER = UFEDReceiver; zmp 22.12.2015 закоментировал
  QueryObj.EDANSWER.EDRECEIVER = EPD_ESID.EDQuery.EDAuthor;
  QueryObj.EDANSWER.TYP        = "ED244";
  QueryObj.EDANSWER.USERS      = {Oper};
  QueryObj.EDANSWER.IN_OUT     = 1;
  QueryObj.EDANSWER.STATUS     = 0;

  if(IsEPD)
    QueryObj.EDANSWER.ID_EPD          = EPD_ESID.EPD.ID_EPD;
    QueryObj.ED244.ID_SUQUERY         = GetID_SU("SUQUERY",SUQUERY_DEF,QueryObj.ED244.ID_SUQUERY8TEXT);
  else
    QueryObj.EDANSWER.ID_EPD          = EPD_ESID.EDQuery.ID_EPD;
    QueryObj.EDANSWER.ID_EDQUERY      = EPD_ESID.EDQuery.ID_EDQUERY;
    QueryObj.ED244.ID_SUQUERY         = EPD_ESID.ED243.ID_SUQUERY;
    GetCODE_SU("SUQUERY",int(EPD_ESID.ED243.ID_SUQUERY),QueryObj.ED244.ID_SUQUERY8TEXT);
  end;

  return QueryObj;
end;

/*функция создания ответа ED274*/
macro create_274(SYSTEMCODE,ID_EPD,ID_PACKETED,EDRECEIVER)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED274,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  QueryObj.EDANSWER.EDNO        = EDNO;
  QueryObj.EDANSWER.EDDATE      = {CurDate};
  QueryObj.EDANSWER.EDAUTHOR    = UFEDAuthor;
  QueryObj.EDANSWER.EDRECEIVER  = EDRECEIVER;/*должен быть банк-отправитель инф. платежа*/
  QueryObj.EDANSWER.TYP         = "ED274";
  QueryObj.EDANSWER.USERS       = {Oper};
  QueryObj.EDANSWER.IN_OUT      = 1;
  QueryObj.EDANSWER.STATUS      = 0;
  QueryObj.EDANSWER.ID_EPD      = ID_EPD;
  QueryObj.EDANSWER.ID_INITPACK = ID_PACKETED;

  return QueryObj;
end;


/*функция создания запроса ED275*/
macro create_275(SYSTEMCODE,EPD)

  var EDNo = 0;
  var QueryObj;
  var Doc = TRslPayDoc(Type_Doc_RUS, int(epd.epd.id_paym));

  if(ValType(Doc) != V_GENOBJ)
    RunError(toansi("Не удалось создать объект TRslPayDoc"));
  end;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED275,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError(toansi("Не удалось создать  объект TRslPayDoc"));
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED275",SYSTEMCODE);
  QueryObj.EDQuery.EDRECEIVER = epd.epd.EDRECEIVER;
  QueryObj.EDQuery.ID_EPD     = epd.epd.ID_EPD;

  if(epd.epd.TYP == "ED113")
    QueryObj.ED275.TRANSKIND  = 2;
  else
    QueryObj.ED275.TRANSKIND  = 6;
  end;

  QueryObj.ED275.SUM      = Doc.paym.AMOUNT;
  QueryObj.ED275.PACC     = Doc.paym.PAYERACCOUNT;
  QueryObj.ED275.PBIC     = Doc.paym.PAYERBANKID;
  QueryObj.ED275.PCORRACC = Doc.rmain.CORACC_PAYER;
  QueryObj.ED275.RACC     = Doc.paym.RECEIVERACCOUNT;
  QueryObj.ED275.RBIC     = Doc.paym.RECEIVERBANKID;
  QueryObj.ED275.RCORRACC = Doc.rmain.CORACC_RECEIVER;

  return QueryObj;
end;

/*функция создания ответа ED276*/
macro create_276(ED275,INFOCODE)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(ED275.EDQuery.SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED276,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  QueryObj.EDANSWER.EDNO       = EDNO;
  QueryObj.EDANSWER.EDDATE     = {CurDate};
  QueryObj.EDANSWER.EDAUTHOR   = UFEDAuthor;
  QueryObj.EDANSWER.EDRECEIVER = ED275.EDQuery.EDAuthor;/*должен быть банк-отправитель инф. платежа*/
  QueryObj.EDANSWER.TYP        = "ED276";
  QueryObj.EDANSWER.USERS      = {Oper};
  QueryObj.EDANSWER.IN_OUT     = 1;
  QueryObj.EDANSWER.STATUS     = 0;

  QueryObj.EDANSWER.ID_EPD          = ED275.EDQuery.ID_EPD;
  QueryObj.EDANSWER.ID_EDQUERY      = ED275.EDQuery.ID_EDQUERY;
  QueryObj.ED276.INFOCODE           = INFOCODE;

  QueryObj.EDANSWER.OEDNO           = ED275.EDQuery.OEDNO;
  QueryObj.EDANSWER.OEDDATE         = ED275.EDQuery.OEDDATE;
  QueryObj.EDANSWER.OEDAUTHOR       = ED275.EDQuery.OEDAUTHOR;

  return QueryObj;
end;

/*функция создания запроса ED813*/
macro create_813(SYSTEMCODE,ID_EPD,PayObj)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED813,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery, EDNo, "ED813", SYSTEMCODE);
  QueryObj.EDQuery.ID_EPD = ID_EPD;

  QueryObj.ED813.EDDate   = {CurDate};
  QueryObj.ED813.EDAuthor = UFEDAuthor;
  QueryObj.EDQuery.ID_EDQUERY = GetNextID("EDQUERY");

  return QueryObj;

end;

/*14.11.2014 karlov*/
/*функция создания запроса ED540*/
macro create_540

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(UFSysCodeCOS);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED540,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED540",UFSysCodeCOS);

  QueryObj.ED540.ID_SUEXCH = GetID_SU("SUEXCH",SUEXCH_DEF,QueryObj.ED540.ID_SUEXCH8TEXT);
  QueryObj.ED540.EDTYP = "0503";

  return QueryObj;
end;

/*функция создания запроса ED542*/
macro create_542

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(UFSysCodeCOS);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED542,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED542",UFSysCodeCOS);

  QueryObj.ED542.ID_SUREPEAT = GetID_SU("SUREPEAT",SUREPEAT542_DEF,QueryObj.ED542.ID_SUREPEAT8TEXT);
  QueryObj.ED542.EDTYP = "0503";

  return QueryObj;

end;

/*функция создания запроса ED801*/
macro create_801(SYSTEMCODE)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED801,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED801",SYSTEMCODE);

  QueryObj.ED801.BIC          = GetOurBIC(BICRus);
  QueryObj.ED801.ID_SULIQCODE = GetID_SU("SULIQCODE","",QueryObj.ED801.ID_SULIQCODE8TEXT);

  return QueryObj;
end;

/*функция создания запроса ED804*/
macro create_804(SYSTEMCODE)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED804,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED804",SYSTEMCODE);

  QueryObj.ED804.BIC          = GetOurBIC(BICRus);
  QueryObj.ED804.ID_SUQUEUE = GetID_SU("SUQUEUE","",QueryObj.ED804.ID_SUQUEUE8TEXT);

  return QueryObj;
end;

/*функция создания запроса ED806*/
macro create_806(SYSTEMCODE)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED806,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED806",SYSTEMCODE);

  QueryObj.ED806.BIC          = GetOurBIC(BICRus);
  QueryObj.ED806.UIS          = UFEDAuthor;
  QueryObj.ED806.ID_SUDICTREQ = GetID_SU("SUDICTREQ","",QueryObj.ED806.ID_SUDICTREQ8TEXT);

  return QueryObj;
end;

/*функция создания запроса ED810*/
macro create_810(SYSTEMCODE)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED810,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED810",SYSTEMCODE);

  QueryObj.ED810.BIC          = GetOurBIC(BICRus);
  QueryObj.ED810.UIS          = UFEDAuthor;
  QueryObj.ED810.ID_SULIMT   = GetID_SU("SULIMT","",QueryObj.ED810.ID_SULIMT8TEXT);
  QueryObj.ED810.ID_SULIQUID = GetID_SU("SULIQUID","",QueryObj.ED810.ID_SULIQUID8TEXT);

  return QueryObj;
end;

/*функция создания запросов ED542 и ED242 из формы Неполученных ЭС. Вызывается из create_ED242_ED542()*/
macro create_EDMISSING(SYSTEMCODE,EDTYP,ID)
  var Text = "";
  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  if(EDTYP == GetID_SU("SUEDTYP","0503",Text))
    /*создание запроса*/
    QueryObj = TRslPayDoc(Type_Doc_ED542,0);
    if(ValType(QueryObj) != V_GENOBJ)
      RunError("Не удалось создать объект");
    end;

    SetEDQuery(QueryObj.EDQuery,EDNo,"ED542",SYSTEMCODE);
    QueryObj.EDQuery.ID_EDMISSING = ID;

    QueryObj.ED542.ID_SUREPEAT = GetID_SU("SUREPEAT",SUREPEAT542ES_DEF,QueryObj.ED542.ID_SUREPEAT8TEXT);
    Text = "ED542";
  else
    /*создание запроса*/
    QueryObj = TRslPayDoc(Type_Doc_ED242,0);

    if(ValType(QueryObj) != V_GENOBJ)
      RunError(toansi("Не удалось создать объект"));
    end;

    SetEDQuery(QueryObj.EDQuery,EDNo,"ED242",SYSTEMCODE);
    QueryObj.EDQuery.ID_EDMISSING = ID;

    QueryObj.ED242.ID_SUREPEAT = GetID_SU("SUREPEAT",SUREPEAT242ES_DEF,QueryObj.ED242.ID_SUREPEAT8TEXT);
    Text = "ED242";
  end;

  if(not QueryObj.Save())
    OraTrnRollBack();
    AddPtk("Создание "+Text+": ошибка создания запроса.");
  else
    OraTrnCommit();
    AddPtk("Создание "+Text+": создан запрос ИД = "+int(QueryObj.EDQuery.ID_EDQUERY));
    MsgBox("Создан запрос "+Text+" ИД = "+int(QueryObj.EDQuery.ID_EDQUERY));
  end;

end;

/*функция создания запроса ED542*/
macro create_542ES(Type_Doc,ID)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(UFSysCodeCOS);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED542,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError("Не удалось создать объект");
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED542",UFSysCodeCOS);
  QueryObj.EDQuery.ID_EDUES = ID;

  QueryObj.ED542.ID_SUREPEAT = GetID_SU("SUREPEAT",SUREPEAT542ES_DEF,QueryObj.ED542.ID_SUREPEAT8TEXT);

  return QueryObj;
end;


/*"вешается" как меню панели ЭПС*/
macro recall_epd(epd)

  if(not VCLGetTrue("Создать запрос об отзыве?"))
    return;
  end;

  var  ID_EDQUERY =  create_204(epd.epd.ID_EPD,epd.epd.SYSTEMCODE,0/*0 - не пакет, 1 - пакет*/);
  OraTrnCommit();
  AddPtk("Отзыв ЭПС: создан запрос ИД = "+ID_EDQUERY+" об отзыве ЭПС ИД = "+int(epd.epd.ID_EPD));
  MsgBox("Создан запрос ИД = "+ID_EDQUERY+" об отзыве ЭПС ИД = "+int(epd.epd.ID_EPD));

  OnError(e)
    OraTrnRollBack();
    AddPtk ("Отзыв ЭПС: " + ToOem(e.Message) + " | Модуль " + e.Module + " | Строка " + e.Line);
    MsgBox(ToOem(e.Message));

end;


macro recall_packet(packet)
/*"вешается" как меню панели*/

  if(not VCLGetTrue("Создать запрос об отзыве?"))
    return;
  end;

  var  ID_EDQUERY =  create_204(packet.PacketED.ID_PACKETED,UFSystemCodeUFEBS,1/*0 - не пакет, 1 - пакет*/);
  OraTrnCommit();
  AddPtk("Отзыв пакета: создан запрос ИД = "+ID_EDQUERY+" об отзыве пакета ИД = "+int(packet.PacketED.ID_PACKETED));
  MsgBox("Cоздан запрос ИД = "+ID_EDQUERY+" об отзыве пакета ИД = "+int(packet.PacketED.ID_PACKETED));

  OnError(e)
    OraTrnRollBack();
    AddPtk ("Отзыв пакета: " + ToOem(e.Message) + " | Модуль " + e.Module + " | Строка " + e.Line);
    MsgBox(ToOem(e.Message));

end;

/*"вешается" как меню панели ЭПС*/
macro create_202_epd(epd)

  var  ID_EDQUERY;
  Array EDInquiryCode;
        EDInquiryCode[0] = "Статус ЭПС/ результат контроля ЭПС";
        EDInquiryCode[1] = "Копия полей ЭПС";

  var MenuInd = VclMenu(EDInquiryCode,"Код запроса по ЭПС");
  if(MenuInd >= 0)
    ID_EDQUERY =  create_202(epd.epd.ID_EPD,epd.epd.SYSTEMCODE,MenuInd+1);
    OraTrnCommit();
    AddPtk("Создание ED202: создан запрос ИД = "+ID_EDQUERY+" на ЭПС ИД = "+int(epd.epd.ID_EPD));
    MsgBox("Создан запрос ИД = "+ID_EDQUERY+" на ЭПС ИД = "+int(epd.epd.ID_EPD));
  end;

  OnError(e)
    OraTrnRollBack();
    AddPtk ("Создание ED202: " + ToOem(e.Message) + " | Модуль " + e.Module + " | Строка " + e.Line);
    MsgBox(ToOem(e.Message));

end;


macro create_202_packet(packet)
/*"вешается" как меню панели*/

  if(not VCLGetTrue("Создать ED202?"))
    return;
  end;

  var  ID_EDQUERY =  create_202(packet.PacketED.ID_PACKETED,UFSystemCodeUFEBS,3);

  OraTrnCommit();
  AddPtk("Создание ED202: создан запрос ИД = "+ID_EDQUERY+" на пакет ИД = "+int(packet.PacketED.ID_PACKETED));
  MsgBox("Создан запрос ИД = "+ID_EDQUERY+" на пакет ИД = "+int(packet.PacketED.ID_PACKETED));

  OnError(e)
    OraTrnRollBack();
    AddPtk ("Создание ED202: " + ToOem(e.Message) + " | Модуль " + e.Module + " | Строка " + e.Line);
    MsgBox(ToOem(e.Message));

end;

/*"вешается" как меню панели платежа*/
macro create_214_paym(PayObj)

  var epd = GetEPDbyPAYM(int(PayObj.paym.ID_PAYM));

  if(epd.RowCount == 0)
    MsgBox("Для платежа с ИД = "+int(PayObj.paym.ID_PAYM)+" не найдено ни одного ЭПС!");
    return;
  end;

  var obj = create_214(epd.GetByName("SYSTEMCODE").AsString,epd.GetByName("ID_EPD").AsInteger,epd.GetByName("ID_PACKETED").AsInteger,epd.GetByName("EDAUTHOR").AsString);
  obj.ED214.SUMPT = PayObj.paym.Amount;


  RefreshScreen;
  return obj;

end;


/*"вешается" как меню панели ЭПС*/
macro create_243_epd(epd)

  var obj = create_243(Type_Doc_ED243p,epd.epd.SYSTEMCODE,epd.epd.ID_EPD,epd.epd.ID_PAYM);
  /*Для запросов, создаваемых из списка ЭПС получатель ЭД:
     - для ответных ЭПС - EDAuthor ЭПС,
     - для начальных ЭПС - EDReceiver ЭПС*/
  if(epd.epd.IN_OUT == 1)/*начальный ЭПС*/
    obj.EDQuery.EDRECEIVER = epd.epd.EDRECEIVER;
  elif(epd.epd.IN_OUT == 2)/*ответный ЭПС*/
    obj.EDQuery.EDRECEIVER = epd.epd.EDAuthor;
  end;

  RefreshScreen;
  return obj;

end;

/*"вешается" как меню панели ЭС*/
macro create_ED542(ESID)

  var obj = create_EDMISSING(UFSysCodeCOS,ESID.EDMISSING.ID_SUEDTYP,ESID.EDMISSING.ID_EDMISSING);
  var QueryObj = TRslPayDoc(Type_Doc_EDMISSING,0);

  ESID.EDMissing.STATUS = 1;
  if(not ESID.Save())
    OraTrnRollBack();
    RunError(ToANSi(ESID.Error));
    AddPtk("Создание: ошибка создания запроса.");
  else
    OraTrnCommit();
  end;

  RefreshScreen;
  return obj;

end;

/*"вешается" как меню панели ЭС*/
macro create_ED242(ESID)

  var obj = create_EDMISSING(UFSystemCodeUFEBS,ESID.EDMISSING.ID_SUEDTYP,ESID.EDMISSING.ID_EDMISSING);
  var QueryObj = TRslPayDoc(Type_Doc_EDMISSING,0);

  ESID.EDMissing.STATUS = 1;
  if(not ESID.Save())
    OraTrnRollBack();
    RunError(ToANSi(ESID.Error));
    AddPtk("Создание: ошибка создания запроса.");
  else
    OraTrnCommit();
  end;

  RefreshScreen;
  return obj;

end;

/*"вешается" как меню панели ЭС*/
macro create_542_ES(ES)

  var obj = create_542ES(Type_Doc_ED542,ES.EDCOS.ID_EDCOS);

  RefreshScreen;
  return obj;

end;


/*"вешается" как меню панели платежа*/
macro create_243_paym(PayObj)

  var epd = GetEPDbyPAYM(int(PayObj.paym.ID_PAYM));

  if(epd.RowCount == 0)
    MsgBox("Для платежа с ИД = "+int(PayObj.paym.ID_PAYM)+" не найдено ни одного ЭПС!");
    return;
  end;

  var obj = create_243(Type_Doc_ED243p,epd.GetByName("SYSTEMCODE").AsString,epd.GetByName("ID_EPD").AsInteger);

  /*Для запросов, создаваемых из Проведенных в РКЦ получатель ЭД - банк, куда отправляли ЭПС*/
  obj.EDQuery.EDRECEIVER = GetEDREceiverFromBIC(PayObj.paym.RECEIVERBANKID);

  RefreshScreen;
  return obj;

end;


/*"вешается" как меню панели ED243*/
macro create_244_esid(esid)
  /*На несозданный ED243 нельзя создавать ED244*/
  if((ValType(esid.EDQUERY.ID_EDQUERY) == V_UNDEF)or(esid.EDQUERY.ID_EDQUERY == 0))
    MsgBox("Нельзя создать ED244 на несохраненный в базе данных ED243!");
    return;
  end;

  /*На неотправленный ED243 нельзя создавать ED244*/
  if((ValType(esid.EDQUERY.STATUS) == V_UNDEF)or(esid.EDQUERY.STATUS == 0))
    MsgBox("Нельзя создать ED244 на неотправленный ED243!");
    return;
  end;

  if(esid.EDQUERY.TYP != "ED243")
    MsgBox("ED244 можно создать только в ответ на ED243!");
    return;
  end;

  var obj = create_244(Type_Doc_ED244p,esid);

  /* получатель ЭД - EDAuthor из ED243*/
  obj.EDANSWER.EDRECEIVER = esid.EDQUERY.EDAuthor;

  RefreshScreen;
  return obj;

end;

/*"вешается" как меню панели платежа*/
macro create_244_paym(PayObj)

  var epd_Query = GetEPDbyPAYM(int(PayObj.paym.ID_PAYM));

  if(epd_Query.RowCount == 0)
    MsgBox("Для платежа с ИД = "+int(PayObj.paym.ID_PAYM)+" не найдено ни одного ЭПС!");
    return;
  end;

  var epd = TRslPayDoc(Type_Doc_EPD, epd_Query.GetByName("ID_EPD").AsInteger);

  if(ValType(epd) != V_GENOBJ)
    RunError("Не удалось создать объект TRslPayDoc");
  end;

  var obj = create_244(Type_Doc_ED244p,epd,true);

  /*Для запросов, создаваемых из Проведенных в РКЦ получатель ЭД - банк, куда отправляли ЭПС*/
  obj.EDAnswer.EDRECEIVER = GetEDREceiverFromBIC(PayObj.paym.RECEIVERBANKID);

  RefreshScreen;
  return obj;

end;


/*"вешается" как меню панели ЭПС*/
macro create_274_epd(epd)

  var obj = create_274(epd.epd.SYSTEMCODE,epd.epd.ID_EPD,epd.epd.ID_PACKETED,epd.epd.EDAuthor);

  RefreshScreen;
  return obj;

end;

macro create274BeforeCommit(ED274Obj)
  if(OEPD_ID_paym == 0)
    OraTrnRollBack();
    AddPtk("Ошибка при сохранении ED274 ИД=" +  int(ED274Obj.EDANSWER.ID_ANSWER)+": сброшены значения глобальных переменных");
    return false;
  end;

  /*Меняем состояние инф. платежа*/
  var PaymEPD = GetPaymByID(OEPD_ID_paym);
  if(not PaymEPD.ChangeState(int(UFStateInfHas274),0,"Создан ответ ED274 ИД = "+int(ED274Obj.EDAnswer.ID_EDAnswer)))
    OraTrnRollBack();
    AddPtk("Ошибка при создании ответа ИД " +  int(ED274Obj.EDANSWER.ID_ANSWER));
    return false;
  end;

  return true;
end;

macro create813BeforeCommit(ED813Obj)
  var ID_EDQUERY = int(ED813Obj.EDQUERY.ID_EDQUERY);
  if(OEPD_ID_paym == 0)
    OraTrnRollBack();
    AddPtk("Ошибка при сохранении ED813 ИД=" +ID_EDQUERY+": сброшены значения глобальных переменных");
    return false;
  end;

  /*Меняем состояние инф. платежа*/
  var PaymEPD = GetPaymByID(OEPD_ID_paym);
  if(not PaymEPD.ChangeState(int(UFStateQueue),0,"Создан запрос ED813 ИД = "+ID_EDQUERY+" на изменение порядка ЭПС ИД = "+int(ED813Obj.EDQUERY.ID_EPD)))
    OraTrnRollBack();
    AddPtk("Ошибка при создании запроса ИД " +ID_EDQUERY);
    return false;
  end;

  return true;
end;

/*"вешается" как меню панели платежа*/
macro create_274_paym(PayObj)

  var epd = GetEPDbyPAYM(int(PayObj.paym.ID_PAYM));

  if(epd.RowCount == 0)
    MsgBox("Для платежа с ИД = "+int(PayObj.paym.ID_PAYM)+" не найдено ни одного ЭПС!");
    return;
  end;

  var obj = create_274(epd.GetByName("SYSTEMCODE").AsString,epd.GetByName("ID_EPD").AsInteger,epd.GetByName("ID_PACKETED").AsInteger,epd.GetByName("EDAUTHOR").AsString);

  OEPD_ID_paym = int(PayObj.paym.id_paym);

  if(not Obj.SetMacro("uf_query","create274BeforeCommit"))
    OraTrnRollBack();
    RunError(ToANSI("Ошибка при установке макрофункции для документа:"+Obj.Error));
    return;
  end;

  RefreshScreen;
  return obj;

end;


/*"вешается" как меню панели ЭПС*/
macro create_275_epd(epd)

  if((epd.EPD.TYP != "ED113")and(epd.EPD.TYP != "ED114"))
    MsgBox("ED275 можно создать только для платежного требования (ED113) или инкассового поручения (ED114)!");
    return;
  end;

  if(not VCLGetTrue("Создать ED275?"))
    return;
  end;

  var obj = create_275(epd.epd.SYSTEMCODE,epd);

  if(not obj.Save())
    RunError(ToANSi(Obj.Error));
  end;

  OraTrnCommit();
  AddPtk("Создан запрос ED275 ИД = "+int(Obj.EDQuery.ID_EDQUERY));
  MsgBox("Создан запрос ED275 ИД = "+int(Obj.EDQuery.ID_EDQUERY));

//  RefreshScreen;

end;

/*"вешается" как меню панели запроса*/
macro create_276_esid(esid)

  if(esid.EDQUERY.TYP != "ED275")
    MsgBox("ED276 можно создать только в ответ на ED275!");
    return;
  end;

  Array INFOCODE;
        INFOCODE[0] = "ЭС отозвано";
        INFOCODE[1] = "Безотзывное ЭС";

  var MenuInd = VclMenu(INFOCODE,"Код уведомления");
  if(MenuInd < 0)
    return;
  end;

  var obj = create_276(esid, MenuInd+1);
  if(not obj.Save())
    RunError(ToANSi(Obj.Error));
  end;

  OraTrnCommit();
  AddPtk("Создан ответ ED276 ИД = "+int(Obj.EDAnswer.ID_EDANSWER));
  MsgBox("Создан ответ ED276 ИД = "+int(Obj.EDAnswer.ID_EDANSWER));

end;

/*функция создания запроса ED813*/
macro create_813_post_card(PayObj)
/*макропроцедура "вешается" на пункт меню панели*/
  var GetEPD;
  var ID_Paym = PayObj.Paym.ID_Paym;
  var ID_EPD = 0;
  var SYSTEMCODE;

  /*поиск ЭПС*/
  GetEPD = TRslOraQuery();
  GetEPD.SqlText = " select t.id_epd ID_EPD, t.systemcode SYSTEMCODE from epd t where t.id_paym = :id_paym order by t.id_epd desc";
  GetEPD.DeclareAndSet("id_paym",ID_Paym);

  if(not GetEPD.Execute())
    RunError(ToANSi(GetEPD.Error));
  end;

  if(GetEPD.RowCount == 0)
    OraTrnRollBack();
    MsgBox("Для платежа "+ID_Paym+" не найден ЭПС");
    AddPtk("Для платежа "+ID_Paym+" не найден ЭПС");
    return false;
  end;

  if(GetEPD.GetByName("SYSTEMCODE").AsString != UFSysCodeBESP)
    MsgBox("ЭПС был отправлен сервисом несрочного перевода. ED382 можно отправить только на ЭПС, отправленный сервисов срочного перевода");
    return;
  end;

  if(not VCLGetTrue("Изменить расположение ЭПС в очереди?"))
    return;
  end;

  ID_EPD = GetEPD.GetByName("ID_EPD").AsInteger;

  OEPD_ID_paym = int(ID_Paym);

  var obj = create_813(SYSTEMCODE,ID_EPD,PayObj);

  if(not Obj.SetMacro("uf_query","create813BeforeCommit"))
    OraTrnRollBack();
    RunError(ToANSI("Ошибка при установке макрофункции для документа:"+Obj.Error));
    return;
  end;

  return obj;

  OnError(e)
    OraTrnRollBack();
    AddPtk ("Изменение расположение в очереди отложенного: " + ToOem(e.Message) + " | Модуль " + e.Module + " | Строка " + e.Line);
    MsgBox(ToOem(e.Message));
    return false;
end;

/*функция создания запроса ED462*/
macro create_462(SYSTEMCODE,INQUIRYCODE)
  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED462p,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError(ToOem("Не удалось создать объект"));
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED462",SYSTEMCODE);

  var IDPaym = GetNextID("PAYM");
  var ID_EDQuery = GetNextID("EDQUERY");

  QueryObj.paym.ID_Paym       = IDPaym;
  QueryObj.paym.NODEPAYMENTID = IDPaym;
  QueryObj.paym.NODEID        = {NumNode};
  QueryObj.paym.ID_SSTATE     = UFStateED462ToSend;
  QueryObj.paym.CURRSTATEDATE = DtTm(date(), time());
  QueryObj.paym.id_spClass    = Class_Doc_Out;
  QueryObj.paym.ISINF         = 1;/*Информационный*/
  QueryObj.paym.DC            = INQUIRYCODE;
  QueryObj.paym.ID_SFI        = GetIdByCode("sfi","ID_SFI",0);
  QueryObj.paym.PRIORITY      = 6;
  QueryObj.paym.NUMPACK       = 0;
  QueryObj.paym.VALUEDATE     = QueryObj.EDQUERY.EDDATE;
  QueryObj.paym.DATEREFERDOC  = QueryObj.EDQUERY.EDDATE;
  QueryObj.paym.INPUTDATE     = DtTm(date(), time());
  QueryObj.paym.NUMREFERDOC   = QueryObj.EDQUERY.EDNO;

  QueryObj.EDQUERY.ID_EDQUERY = ID_EDQUERY;
  QueryObj.EDQUERY.ID_NFORM   = Type_Doc_ED462;

  QueryObj.ED462.ID_EDQUERY   = ID_EDQUERY;
  QueryObj.ED462.DOCDATE      = {CurDate};
  QueryObj.ED462.OPERDATE     = {CurDate};
  QueryObj.ED462.ORGBIC       = GetOurBIC(10);
  QueryObj.ED462.CLIENTNAME   = BankName;
  QueryObj.ED462.PBRBIC       = GetBICKorr(10, GetKorrIDKorr(NumKor));
  QueryObj.ED462.PBRNAME      = GetKorrName(GetKorrIDKorr(NumKor));
  QueryObj.ED462.ACC          = GetKSAccount(NumKor, NumKS, 0, 10, True);

  if(INQUIRYCODE == 0)
     QueryObj.ED462.OPERTYPE  = 2;
  elif(INQUIRYCODE == 1)
     QueryObj.ED462.OPERTYPE  = 1;
  end;

  QueryObj.paym.PAYERBANKID     = QueryObj.ED462.ORGBIC;
  QueryObj.paym.RECEIVERBANKID  = QueryObj.ED462.PBRBIC;
  QueryObj.paym.PAYERACCOUNT    = GetKSAccount(NumKor, NumKS, 0, 10, false);
  QueryObj.paym.RECEIVERACCOUNT = QueryObj.ED462.ACC;

  QueryObj.paym.ID_NKORROUTPUT  = GetKorrIDKorr(NumKor);
  QueryObj.paym.ID_NKSOUTPUT    = GetID_NKS (QueryObj.paym.ID_NKORROUTPUT, QueryObj.paym.ID_SFI, NumKS);
  QueryObj.paym.ID_SFIOUTPUT    = QueryObj.paym.ID_SFI;

  return QueryObj;
end;

/*функция создания запроса ED464*/
macro create_464(ESID)

  var EDNo = 0;
  var QueryObj;

  /*Получение EDNo для запроса*/
  EDNo = GetEDNo(ESID.edquery.SYSTEMCODE);

  /*создание запроса*/
  QueryObj = TRslPayDoc(Type_Doc_ED464,0);

  if(ValType(QueryObj) != V_GENOBJ)
    RunError(ToANSi("Не удалось создать объект"));
  end;

  SetEDQuery(QueryObj.EDQuery,EDNo,"ED464",ESID.edquery.SYSTEMCODE);

  QueryObj.EDQuery.ID_REFQUERY = ESID.edquery.ID_EDQUERY;
  QueryObj.ED464.OrgBIC = ESID.ED462.OrgBIC;
  QueryObj.ED464.PBRBIC = ESID.ED462.PBRBIC;

  if(not QueryObj.Save())
    RunError(ToANSi(QueryObj.Error));
  end;
  return(int(QueryObj.EDQuery.ID_EDQUERY));

end;

macro recall_post_card(PayObj, InList)
/*макропроцедура "вешается" на пункт меню панели*/

  var GetEPD;
  var ID_Paym = PayObj.Paym.ID_Paym;
  var ID_EPD = 0;
  var SYSTEMCODE;

  if(not InList)
    if(not VCLGetTrue("Создать запрос об отзыве?"))
      return;
    end;
  end;

  /*поиск ЭПС*/
  GetEPD = TRslOraQuery();
  GetEPD.SqlText = " select t.id_epd ID_EPD, t.systemcode SYSTEMCODE from epd t where t.id_paym = :id_paym order by t.id_epd desc";
  GetEPD.DeclareAndSet("id_paym",ID_Paym);

  if(not GetEPD.Execute())
    RunError(ToANSi(GetEPD.Error));
  end;

  if(GetEPD.RowCount == 0)
    OraTrnRollBack();
    MsgBox("Для платежа "+ID_Paym+" не найден ЭПС");
    AddPtk("Для платежа "+ID_Paym+" не найден ЭПС");
    return false;
  end;

  ID_EPD     = GetEPD.GetByName("ID_EPD").AsInteger;
  SYSTEMCODE = GetEPD.GetByName("SYSTEMCODE").AsString;

  var  ID_EDQUERY =  create_204(ID_EPD,SYSTEMCODE,0/*0 - не пакет, 1 - пакет*/);


  if(not PayObj.ChangeState(int(PayObj.paym.ID_SSTATE),0,"Создан запрос ИД = "+ID_EDQUERY+" об отзыве находящегося в очереди в РКЦ ЭПС ИД = "+ID_EPD))
    RunError(ToANSi(PayObj.Error));
  end;

  OraTrnCommit();
  if(not InList)
    MsgBox("Создан запрос ИД = "+ID_EDQUERY+" об отзыве находящегося в очереди в РКЦ ЭПС ИД = "+ID_EPD);
  end;
  return true;

  OnError(e)
    OraTrnRollBack();
    AddPtk ("Отзыв находящегося в очереди в РКЦ ЭПС: " + ToOem(e.Message) + " | Модуль " + e.Module + " | Строка " + e.Line);
    MsgBox(ToOem(e.Message));
    return false;

end;


macro recall_post_list()
/*макропроцедура "вешается" на пункт меню списка*/
  var i;
  var ListNum = PayListNum();
  var PayObj;

  if(not VCLGetTrue("Создать запросы об отзыве отмеченных документов?"))
    RefreshScreen;
    return;
  end;

  VclInitProgress(ListNum, "Отзыв отложенных");
  i = 0;

  while(i < ListNum)
    /*поиск ЭПС*/
    PayObj = PayListElem(i);

    if(not recall_post_card(PayObj,true))
      VclRemProgress();
      RefreshScreen;
      return
    end;

    VclUseProgress(i = i + 1);
  end;

  VclRemProgress();
  RefreshScreen;

end;

/*-------Макрофункции пунктов меню списка-------------*/
macro ED203_UFEBS()
/*пункт меню списка запросов*/
  var obj = create_203(UFSystemCodeUFEBS);
  RefreshScreen;
  return obj;
end;

macro ED210_UFEBS()
/*пункт меню списка запросов*/
  var obj = create_210(UFSystemCodeUFEBS);
  RefreshScreen;
  return obj;
end;

macro ED218_UFEBS()
/*пункт меню списка запросов*/
  var obj = create_218(UFSystemCodeUFEBS);
  RefreshScreen;
  return obj;
end;

macro ED240_UFEBS()
/*пункт меню списка запросов*/
  var obj = create_240(UFSystemCodeUFEBS);
  RefreshScreen;
  return obj;
end;

macro ED801_PSBR()
/*пункт меню списка запросов*/
  var obj = create_801(UFSystemCodeUFEBS);
  RefreshScreen;
  return obj;
end;

macro ED999_UFEBS()
/*пункт меню списка запросов*/
  create_999(UFSystemCodeUFEBS);
  RefreshScreen;
end;

macro ED999_BESP()
/*пункт меню списка запросов*/
  create_999(UFSystemCodeBESP);
  RefreshScreen;
end;

macro ED540_COS()
/*пункт меню списка запросов*/
  var obj = create_540(UFSystemCodeUFEBS);
  RefreshScreen;
  return obj;
end;

macro ED542_COS()
/*пункт меню списка запросов*/
  var obj = create_542(UFSystemCodeUFEBS);
  RefreshScreen;
  return obj;
end;

macro ED573_COS()
/*пункт меню списка запросов*/
  var obj = create_573(UFSystemCodeUFEBS);
  RefreshScreen;
  return obj;
end;

macro ED599_COS()
/*пункт меню списка запросов*/
  create_599(UFSystemCodeUFEBS);
  RefreshScreen;
end;

macro ED462_UFEBS()
/*пункт меню списка запросов*/
  Array EDInquiryCode;
        EDInquiryCode[0] = "Получение налички";
        EDInquiryCode[1] = "Сдача налички";

  var MenuInd = VclMenu(EDInquiryCode,"Вид операции");
  if(MenuInd >= 0)
    var obj = create_462(UFSystemCodeUFEBS, MenuInd);

    OraTrnCommit();
  end;

  RefreshScreen;
  return obj;
end;

macro ED464_UFEBS(ESID)
/*"вешается" как меню панели ED462*/
AddPtk(ESID.edquery.ID_EDQUERY);
AddPtk(ESID.ED462.PBRBIC);
  var ID_EDQUERY = create_464(ESID);
  OraTrnCommit();
  AddPtk("Создание ED464: создан запрос ИД = "+ID_EDQUERY+" на ЭС ИД = "+int(ESID.edquery.ID_EDQUERY));
  MsgBox("Создан запрос ИД = "+ID_EDQUERY+" на ЭС ИД = "+int(ESID.edquery.ID_EDQUERY));

  OnError(e)
    OraTrnRollBack();
    AddPtk ("Создание ED464 " + ToOem(e.Message) + " | Модуль " + e.Module + " | Строка " + e.Line);
    MsgBox(ToOem(e.Message));

end;

macro IgnoreQuery(ESIS)
	ESIS.EDQUERY.Status = ESIS_STATUS_IGNORE;

  if(not ESIS.Save())
    RunError(ToANSi(ESIS.Error));
  end;

  OraTrnCommit();
  AddPtk("Игнорирован запрос ИД = "+int(ESIS.EDQUERY.ID_EDQUERY));
  RefreshScreen;
  ExitScreen();
end;

macro IgnoreAnsw(ESIS)
	ESIS.EDANSWER.Status = ESIS_STATUS_IGNORE;

  if(not ESIS.Save())
    RunError(ToANSi(ESIS.Error));
  end;

  OraTrnCommit();
  AddPtk("Игнорирован ответ ИД = "+int(ESIS.EDAnswer.ID_EDANSWER));
  RefreshScreen;
  ExitScreen();
end;


/*-------Макрофункции проверки заполнения полей форм------------*/
macro Check_ED203(ESID)
  if  (ESID.ED203.ID_SUSTATUS == NULL)
    MsgBox("Код статуса должен быть заполнен");
    return false;
  elif(ESID.ED203.ID_SUGRCODE == NULL)
    MsgBox("Код запроса по группе ЭПС должен быть заполнен");
    return false;
  end;
  return true;
end;


macro Check_ED210(ESID)
  if(ESID.ED210.ABSTRACTDATE == NULL)
    MsgBox("Дата выписки должна быть заполнена");
    return false;
  elif(ESID.ED210.ID_SUREQUEST == NULL)
    MsgBox("Код запроса должен быть заполнен");
    return false;
  end;
  return true;
end;

macro Check_ED214(ESID)
  if(ESID.ED214.ID_SUACPT == NULL)
    MsgBox("Поле \"Акцепт\" должно быть заполнен");
    return false;
  elif(ESID.ED214.SUMPT == NULL)
    MsgBox("Сумма, предъявленная к акцепту, должна быть заполнена");
    return false;
  end;
  return true;
end;


macro Check_ED218(ESID)
  if(ESID.ED218.REPORTDATE == NULL)
    MsgBox("Дата информации должна быть заполнена");
    return false;
  elif(ESID.ED218.ID_SUMAKCODE == NULL)
    MsgBox("Код признака формирования формы должен быть заполнен");
    return false;
  end;
  return true;
end;

macro Check_ED243(ESID)
  if(ESID.ED243.ID_SUQUERY == NULL)
    MsgBox("Код запроса должен быть заполнен");
    return false;
  end;
  return true;
end;

macro Check_ED243Field(ESID)
  if(ESID.ED243FIELD.FIELDNO == "")
    MsgBox("Номер реквизита должен быть заполнен");
    return false;
  end;
  return true;
end;

macro Check_ED244(ESID)
  if(ESID.ED244.ID_SUQUERY == NULL)
    MsgBox("Код запроса должен быть заполнен");
    return false;
  elif(ESID.ED244.ID_SUANSWER == NULL)
    MsgBox("Код ответа должен быть заполнен");
    return false;
  end;
  return true;
end;

macro Check_ED244Field(ESID)
  if(ESID.ED244FIELD.FIELDNO == "")
    MsgBox("Номер реквизита должен быть заполнен");
    return false;
  end;
  return true;
end;

macro Check_ED274(ESID)
  if(ESID.ED274.ID_SUINFOCODE == NULL)
    MsgBox("Код уведомления должен быть заполнен");
    return false;
  elif(ESID.ED274.ANNOTATION == "")
    MsgBox("Текст пояснения должен быть заполнен");
    return false;
  end;
  return true;
end;

macro Check_ED275(ESID)
  if(ESID.ED275.SUM == NULL)
    MsgBox("Сумма должна быть заполнена");
    return false;
  elif(ESID.ED275.PBIC == "")
    MsgBox("БИК плательщика должен быть заполнен");
    return false;
  elif(ESID.ED275.RBIC == "")
    MsgBox("БИК получателя должен быть заполнен");
    return false;
  end;
  return true;
end;
