/*
Gen_Paym.mac

07.04.2013 Ойкин В. Генерация платежей для теста

*/


import generalora, utilsora;

const BEGIN_NUM_REF_DOC = 1;/*номер первого документа*/
const NUM_DOCS = 10;         /*количество документов*/
const ID_GEN_STATE = 161; /*7900 Отправляектся на узел*/



MACRO InitDoc (_State, _TpID, _tmpKind, _Amount, _ValueDate, _NumReferDoc, _Route)
/*_Route - направление маршрута*/
  var tmp = 0, j = 0, newDocKind,
      tmpKind = 0, PayObj, paym, rmain, mtrec, newState, TpID ;



/*
  AddPtk ("Загружается платеж " + ODBPaymId);
*/
  TpID = _TpID;
  tmpKind = _tmpKind;

  if (TpID==TpIdSwift)
    if (tmpKind == 103)
      newDocKind = Type_Doc_MT103;
    elif(tmpKind == 202)
      newDocKind = Type_Doc_MT202;
    elif(tmpKind == 200)
      newDocKind = Type_Doc_MT200;
    end;
  else
     newDocKind = Type_Doc_Rus;
  end;

  payObj = TRslPayDoc (newDocKind, 0);
  paym  = payObj.paym;
  rmain = payObj.rmain;

  paym.NodeId ={NumNode};
  paym.id_spClass = Class_Doc_ODB;

  paym.InputDate = DtTm(date(), time());
  paym.DateInput = {curdate};
  paym.DC = 0;

  paym.id_sFI   = 1;/*нацвалюта*/
  paym.AccCurrAmount   = "30301810200009000501";
  paym.Amount = _Amount;
  paym.id_sFIOutput = paym.id_sFIInput = paym.id_sFICurrAmount = paym.id_sFI;
  paym.ValueDate  = _ValueDate;

  if  (_Route == 0)
    /*из ГО в филиал 3*/
    paym.PayerBankId     = "044525562";
    paym.ReceiverBankId  = "042202843";

    paym.ID_NKORROUTPUT  = 3;
    paym.ID_NKSOUTPUT    = 13;
    paym.ID_NODEOUTPUT   = 3;
  elif(_Route == 1)

    /*из филиала 1 в ГО*/
    paym.PayerBankId     = "042202843";
    paym.ReceiverBankId  = "044525562";
    paym.ID_NKORRINPUT   = 1;
    paym.ID_NKSINPUT     = 1;
    paym.ID_NODEINPUT    = 1;
  elif(_Route == 2)

    /*из филиала 2 в филиал 1*/
    paym.PayerBankId     = "043601976";
    paym.ReceiverBankId  = "042202843";

    paym.ID_NKORRINPUT   = 2;
    paym.ID_NKSINPUT     = 7;
    paym.ID_NODEINPUT    = 2;
/*
    paym.ID_NKORROUTPUT  = 1;
    paym.ID_NKSOUTPUT    = 1;
    paym.ID_NODEOUTPUT   = 1;
*/
  elif(_Route == 3)
    /*из филиала 3 в филиал 2*/
    paym.PayerBankId     = "046577892";
    paym.ReceiverBankId  = "043601976";
    paym.ID_NKORRINPUT   = 3;
    paym.ID_NKSINPUT     = 13;
    paym.ID_NODEINPUT    = 3;
/*
    paym.ID_NKORROUTPUT  = 1;
    paym.ID_NKSOUTPUT    = 1;
    paym.ID_NODEOUTPUT   = 1;
*/
  elif(_Route == 4)
    /*из филиала 4 в филиал 3*/
    paym.PayerBankId     = "047501963";
    paym.ReceiverBankId  = "046577892";
    paym.ID_NKORRINPUT   = 4;
    paym.ID_NKSINPUT     = 23;
    paym.ID_NODEINPUT    = 4;
/*
    paym.ID_NKORROUTPUT  = 1;
    paym.ID_NKSOUTPUT    = 1;
    paym.ID_NODEOUTPUT   = 1;
*/
  elif(_Route == 5)
    /*из филиала 5 в филиал 4*/
    paym.PayerBankId     = "042748864";
    paym.ReceiverBankId  = "047501963";
    paym.ID_NKORRINPUT   = 5;
    paym.ID_NKSINPUT     = 31;
    paym.ID_NODEINPUT    = 5;
/*
    paym.ID_NKORROUTPUT  = 1;
    paym.ID_NKSOUTPUT    = 1;
    paym.ID_NODEOUTPUT   = 1;
*/
  elif(_Route == 6)

    /*из филиала 6 в филиал 5*/
    paym.PayerBankId     = "047888736";
    paym.ReceiverBankId  = "042748864";
    paym.ID_NKORRINPUT   = 6;
    paym.ID_NKSINPUT     = 37;
    paym.ID_NODEINPUT    = 6;
/*
    paym.ID_NKORROUTPUT  = 1;
    paym.ID_NKSOUTPUT    = 1;
    paym.ID_NODEOUTPUT   = 1;
*/
  elif(_Route == 7)

    /*из филиала 7 в филиал 6*/
    paym.PayerBankId     = "046311841";
    paym.ReceiverBankId  = "047888736";
    paym.ID_NKORRINPUT   = 7;
    paym.ID_NKSINPUT     = 45;
    paym.ID_NODEINPUT    = 7;
/*
    paym.ID_NKORROUTPUT  = 1;
    paym.ID_NKSOUTPUT    = 1;
    paym.ID_NODEOUTPUT   = 1;
*/
  elif(_Route == 8)

    /*из филиала 8 в филиал 7*/
    paym.PayerBankId     = "043209755";
    paym.ReceiverBankId  = "046311841";
    paym.ID_NKORRINPUT   = 8;
    paym.ID_NKSINPUT     = 59;
    paym.ID_NODEINPUT    = 8;
/*
    paym.ID_NKORROUTPUT  = 1;
    paym.ID_NKSOUTPUT    = 1;
    paym.ID_NODEOUTPUT   = 1;
*/
  else

    /*филиал 1 сам на себя*/
    paym.PayerBankId     = "042202843";
    paym.ReceiverBankId  = "042202843";
    paym.ID_NKORRINPUT   = 1;
    paym.ID_NKSINPUT     = 1;
    paym.ID_NODEINPUT    = 1;
/*
    paym.ID_NKORROUTPUT  = 1;
    paym.ID_NKSOUTPUT    = 1;
    paym.ID_NODEOUTPUT   = 1;
*/
  end;

  paym.PayerAccount    = "11111111111111111111";
  paym.ReceiverAccount = "22222222222222222222";
  paym.NumReferDoc     = _NumReferDoc;
  paym.DateReferDoc    = paym.ValueDate;
  paym.NumPack         = "8888";

  paym.Priority = 6;

  if(paym.PayerBankId == "")
    if (TpID == TpIdSwift)
      paym.PayerBankId = mySWIFTBic;
    else
      paym.PayerBankId = myBic;
    end;
  end;

  Paym.AccCurrAmount = _Amount;

  rmain.pay_date           = paym.ValueDate;
  rmain.shifr_oper         = "01";
  rmain.kind_oper          = "1";
/*
  rmain.dispathname
  rmain.dispatch
*/
  rmain.payer              = "Плательщик " + _NumReferDoc;
  rmain.inn_payer          = "1234567890";
  rmain.kpp_payer          = "234567890";
  rmain.bank_payer         = "Банк плательщика " + _NumReferDoc;
  rmain.place_payer        = "PlacePayer " + _NumReferDoc;
  rmain.nameplace_payer    = "NamePlacePayer "  + _NumReferDoc;
  rmain.coracc_payer       = "";
  rmain.bank_receiver      = "Банк получателя "  + _NumReferDoc;
  rmain.place_receiver     = "PlaceReceiver "  + _NumReferDoc;
  rmain.nameplace_receiver = "NamePlaceReceiver "  + _NumReferDoc;
  rmain.coracc_receiver    = "";
  rmain.inn_reciver        = "0987654321";
  rmain.kpp_reciver        = "109876543";
  rmain.receiver           = "Получатель " + _NumReferDoc;
  rmain.typedocument       = "";
  /*  rmain.paygoal*/
  rmain.payment            = 6;
//  rmain.CONDITION          = 1;
  rmain.usertypedocument   = "";
  rmain.oper               = {Oper};
  /*  rmain.paycode
  rmain.payreserve
  rmain.bic_route
  rmain.real_payer
  */
  rmain.ground             = "Основание " + _NumReferDoc;
/*
  rmain.date_inp
  rmain.date_kart
  rmain.date_sp
  rmain.date_bpol

  rmain.status_own
  rmain.code_bj
  rmain.code_okato
  rmain.ground_np
  rmain.nal_per
  rmain.nal_num
  rmain.nal_date
  rmain.nal_type
  rmain.pdoc_partnum
  rmain.pdoc_shifr
  rmain.pdoc_num
  rmain.pdoc_date
  rmain.amm_rest
  rmain.pri_sost
*/
/*
  rmain.valamount = _Amount;
  rmain.id_sfi    = paym.id_sFI;
  rmain.valrate   = 1;
*/

  if( not payObj.ChangeState(_State, 0, " Тестовый платеж "+_TpID+"/"+_tmpKind+"/"+_NumReferDoc+"/"+_ValueDate+"("+Time()+")"))
    AddPtk("ошибка \"" + payObj.Error+ "\" при изменении состояния платежа " +  payObj.paym.id_paym);
    return false;
  end;

  /*AddPTk("Сгенерирован платеж " + int(payObj.paym.id_paym));*/
  return true;
END;

macro Gen_Paym()
  var i = BEGIN_NUM_REF_DOC;


  VclInitProgress(NUM_DOCS, "Генерация платежей...");
  while(i < BEGIN_NUM_REF_DOC + NUM_DOCS)
/*    if(not InitDoc (101/*99999*/, 0, 0, i * 0.01, Date(), i))*/
    if(not InitDoc (ID_GEN_STATE, 0, 0, i * 0.01, Date(), i, /*Random (10)*/ 0))
      MsgBox("Платеж НЕ добавлен");
      OraTrnRollback();
      return;
    end;
    VclUseProgress((i = i + 1)-BEGIN_NUM_REF_DOC);
  end;

  VclRemProgress();
  AddPTk("Сгенерировано "+NUM_DOCS+" платеж(ей)");
  MsgBox("Сгенерировано "+NUM_DOCS+" платеж(ей)");
  OraTrnCommit();
end;


