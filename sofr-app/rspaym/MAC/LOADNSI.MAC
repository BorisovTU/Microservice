import "nsidef.mac";
const sprBanksID = 1;
file   bicbank (p_sBanks) write;
RECORD bb (p_sBanks);
file sprdbf() dbf;
file sprtxt() txt 2048;

/* константы определяющие какой справочник будет удалять функция
   DeleteNsiFile
*/
DelBnkseek = 0;
DelFiDat   = 1;

NSIInName = NSIShortName = "";
TrnMsg = BtrMsg = "";
TotalCount = MaxProgress = 0;
/* не выводить Msgbox с сообщениями */
OffMsgBox = false;

array tnp;
tnp(0)="";
tnp(1)="Г.";
tnp(2)="П.";
tnp(3)="С.";
tnp(4)="ПГТ.";
tnp(5)="СТ-ЦА ";
tnp(6)="АУЛ ";
tnp(7)="РП.";
//open (bicbank , null, null, true);

var msg = "";

macro StrDbf2Date(s)
  return date(int(substr(s,1,2)), int(substr(s,4,2)), int(substr(s,7,4)));
end;

MACRO NsiMsgBox (msg)
 if (not OffMsgBox)
   VclMsgBox (msg);
 end;
END;
/*----------------------------------------------------------------------------*/
/*
MACRO SprPrepare (type)

  KeyNum(bicbank,1);
  i =  0;
  VclInitProgress(NRecords(bicbank),"Подготовка справочника банков к загрузке");
  clearrecord(bicbank);
  bicbank.type = type;
  bicbank.bic  = "";
  found = GetGE(bicbank) AND (bicbank.type == type);
  while (found)
    bicbank.ModFlag = 1;
    if (not Update (bicbank))
      msg = "Невозможно обновить файл "+ FileName(bicbank) + "."+
            " Код ошибки " + Status();
      AddPtk(msg);
      NsiMsgBox(msg);
      VclRemProgress();
      return false;
    end;
    found = next(bicbank) AND (bicbank.type == type);
    i = i + 1;
    VclUseProgress (i);
  end;
  if (i < NRecords(bicbank))
   i = NRecords(bicbank);
   VclUseProgress (i);
  end;
  VclRemProgress();
  return true;
END;
/*----------------------------------------------------------------------------*/
MACRO SprDeleteOld (type)
  KeyNum(bicbank,1);
  i =  0;
  VclInitProgress(NRecords(bicbank),"Удаление устаревших записей из справочника банков");
  clearrecord(bicbank);
  bicbank.type = type;
  bicbank.bic  = "";
  found = GetGE(bicbank) AND (bicbank.type == type);
  while (found)
    if (bicbank.ModFlag)
      copy (BB, bicbank);
      if (not SprDelete(sprBanksID, BB))
       msg = "Невозможно удалить запись из справочника банков.";
       AddPtk(msg);
       NsiMsgBox(msg);
       VclRemProgress();
       return false;
      end;
    end;
    found = next(bicbank) AND (bicbank.type == type);
    i = i + 1;
    VclUseProgress (i);
  end;
  if (i < NRecords(bicbank))
   i = NRecords(bicbank);
   VclUseProgress (i);
  end;
  VclRemProgress();
  return true;
END;
/*----------------------------------------------------------------------------*/
MACRO Equal (strdbt, strdbf)
  result = false;
  if (valtype(strdbf) == V_DBFFILE)
   /*AddPtk (String("BIC = " + strdbt.bic,
   " Type  " + string (strdbt.type == TypeBankMCI),
   " BIC   " + string (strdbt.bic  == Trim(String(sprdbf.NewNum))),
   " BIC_ext " + string (strdbt.bic_ext ==Trim(String(sprdbf.Ksnp))),
   " City " + string (strdbt.city == tnp(int(sprdbf.Tnp))+Trim(String(sprdbf.Nnp))),
   " Adres " + string (strdbt.adres== Trim(String(sprdbf.Adr))),
   " Name " + string (strdbt.name == Trim(String(sprdbf.Namep))),
   " dispatch " + string (strdbt.dispath ==int(sprdbf.Uer)),
   " date " + string (strdbt.date_stamp == StrDbf2Date(string(sprdbf.Dt_izm)))));
   */
   result =((strdbt.type == TypeBankMCI)AND
           (strdbt.bic  == Trim(String(sprdbf.NewNum)))AND
           (strdbt.bic_ext ==Trim(String(sprdbf.Ksnp)) )AND
           (strdbt.city == tnp(int(sprdbf.Tnp))+Trim(String(sprdbf.Nnp)))AND
           (strdbt.adres== Trim(String(sprdbf.Adr)))AND
           (strdbt.name == Trim(String(sprdbf.Namep)))AND
           (strdbt.dispath ==int(sprdbf.Uer))AND
           (strdbt.date_stamp == StrDbf2Date(string(sprdbf.Dt_izm))))
  elif (valtype (strdbf) == V_STRING)
       tmpBic = substr(strdbf,4,11);
       tmpTypeOwner = 0;
       tmpOwner = "";
       if(substr(tmpBic,9,3)=="XXX");
         tmpBic = substr(tmpBic ,1,8);
       else
         tmpTypeOwner = TypeBankSWIFT;
         tmpOwner =substr(tmpBic,1,8);
       end;
       tmpAddress = trim(substr(strdbf,324,35));
       if(Trim(substr(strdbf,359,35))!="")
         tmpAddress=Trim(tmpAddress + " " + Trim(substr(strdbf,359,35)));
       end;
       tmpName = trim(substr(strdbf,15,105));
       if(Trim(substr(strdbf,120,71))!="")
         tmpName = Trim(tmpName+" "+Trim(substr(strdbf,120,70)));
       end;
       tmpName = trim(Substr(tmpName, 1, 80));
       strdbt.country = trim(substr(strdbf,569,35));
       result =((strdbt.type == TypeBankSWIFT)AND
                (strdbt.bic  == tmpBic)AND
                (strdbt.city == trim(substr(strdbf,190,35)))AND
                (strdbt.adres== tmpAddress)AND
                (trim(strdbt.name) == tmpName)AND
                (strdbt.country == trim(substr(strdbf,569,35)))AND
                (strdbt.Type_owner == tmpTypeOwner) AND
                (strdbt.bic_owner == tmpOwner));
   /*   AddPtk (String("BIC = " + tmpBic,
   " Type  " + string (strdbt.type == TypeBankSWIFT),
   " BIC   " + string (strdbt.bic  == tmpBic),
   " City " + string (strdbt.city == trim(substr(strdbf,190,35))),
   " Adres " + string (strdbt.adres== tmpAddress),
   " Name " + string (trim(strdbt.name) == tmpName),
   " country " + string (strdbt.country == trim(substr(strdbf,569,35))),
   " typ_owner " + string (strdbt.Type_owner == tmpTypeOwner)),
   " owner " + string(strdbt.bic_owner == tmpOwner));
   */
  end;
  return result;
END;
*/
macro ExistBank(ID_TBIC,BIC)
  var q = TRslOraQuery();
      q.SqlText = "select * from sbanks where ID_TBIC=:ID_TBIC and BIC=:BIC";

  q.DeclareAndSet("ID_TBIC",ID_TBIC,"BIC",BIC);
  if(NOT q.Execute())
      runerror(ToAnsi("Ошибка ExistBank: "+q.Error + ". Параметры: " + ID_TBIC+","+BIC));
  end;

  if(q.RowCount)
    return true;
  end;

  return false;
end;

/*----------------------------------------------------------------------------*/
/*                             */
/*----------------------------------------------------------------------------*/
macro LoadFileRB(namefile)
  TrnMsg = BtrMsg = "";
  TotalCount = MaxProgress = 0;

  var CountIns = 0;
  var CountUpd = 0;

  if(Not Open(sprdbf,namefile))
    AddPtk("НСИ:Ошибка:Невозможно открыть файл "+ FileName(sprdbf));
    NsiMsgBox("Невозможно открыть файл "+FileName(sprdbf));
    return false;
  end;
  AddPtk("НCИ:Для загрузки открыт файл " + FileName(sprdbf));
//  open(bicbank,"p_sbanks.dbt", null, true);
  Rewind(sprdbf);
/*
  if (not SprPrepare (TypeBankMCI))
   return false;
  end;
*/
//  KeyNum(bicbank,1);
  var SQLStrInsert = "insert into sbanks(ID_TBIC,BIC,TYPE_EXT,BIC_EXT,NAME,COUNTRY,CITY,ADRES,TYPE_OWNER,BIC_OWNER,TYPE_ME,BIC_ME,ISLOCK,DISPATH,DATE_STAMP,TIME_STAMP,MODFLAG) "+
                                 "values(:ID_TBIC,:BIC,:TYPE_EXT,:BIC_EXT,:NAME,:COUNTRY,:CITY,:ADRES,:TYPE_OWNER,:BIC_OWNER,:TYPE_ME,:BIC_ME,:ISLOCK,:DISPATH,:DATE_STAMP,:TIME_STAMP,:MODFLAG)";

  var SQLStrUpdate = "update sbanks "+
                     "set TYPE_EXT=:TYPE_EXT,BIC_EXT=:BIC_EXT,NAME=:NAME,COUNTRY=:COUNTRY,CITY=:CITY,ADRES=:ADRES,TYPE_OWNER=:TYPE_OWNER, "+
                         "BIC_OWNER=:BIC_OWNER,TYPE_ME=:TYPE_ME,BIC_ME=:BIC_ME,ISLOCK=:ISLOCK,DISPATH=:DISPATH,DATE_STAMP=:DATE_STAMP,TIME_STAMP=:TIME_STAMP,MODFLAG=:MODFLAG "+
                     "where ID_TBIC=:ID_TBIC and BIC=:BIC";

  var q = TRslOraQuery();




  VclInitProgress(NRecords(sprdbf),"Загрузка справочника банков МЦИ");
  while(Next(sprdbf))
     if((sprdbf.Real != "ИЗМР") AND (sprdbf.Real != "ИСКЛ") AND (sprdbf.Real != "ОТЗВ") AND
        (not ExistBank(TypeBankMCI,sprdbf.NewNum)))

       q.SqlText = SQLStrInsert;
       CountIns = CountIns + 1;

     elif ((sprdbf.Real != "ИЗМР") AND (sprdbf.Real != "ИСКЛ") AND (sprdbf.Real != "ОТЗВ") AND
           (ExistBank(TypeBankMCI,sprdbf.NewNum)))

       q.SqlText = SQLStrUpdate;
       CountUpd = CountUpd + 1;
     end;

     q.DeclareAndSet("ID_TBIC",TypeBankMCI,
                     "BIC",Trim(String(sprdbf.NewNum)),
                     "TYPE_EXT","",
                     "BIC_EXT",Trim(String(sprdbf.Ksnp)),
                     "NAME",Trim(String(sprdbf.Namep)),
                     "COUNTRY","",
                     "CITY",tnp(int(sprdbf.Tnp))+Trim(String(sprdbf.Nnp)),
                     "ADRES",Trim(String(sprdbf.Adr)),
                     "TYPE_OWNER",0,
                     "BIC_OWNER","",
                     "TYPE_ME",0,
                     "BIC_ME","",
                     "ISLOCK",0,
                     "DISPATH",int(sprdbf.Uer),
                     "DATE_STAMP",StrDbf2Date(string(sprdbf.Dt_izm)),
                     "TIME_STAMP",time(),
                     "MODFLAG",0);

     if(NOT q.Execute())
       OraTrnRollback();
       msg = "Невозможно обновить справочник банков МЦИ:"+q.Error;
       AddPtk(msg);
       NsiMsgBox(msg);
       VclRemProgress();
       Close(sprdbf);
       return false;
     end;

     VclUseProgress(TotalCount = TotalCount + 1);
  end;

  OraTrnCommit();
  VclRemProgress();
  AddPtk("НCИ:Загрузка окончена. Всего обработано:"+TotalCount+", обновлено: "+CountUpd+", добавлено:"+CountIns);
  Close(sprdbf);
  return true;
end;
/*----------------------------------------------------------------------------*/
/*  Подтверждение загрузки справочника МФО */
macro LoadRB(noninteract)
   var ret = false;
   NSIShortName = NSIInDir +"\\"+ fileMCIBic;
   if (valtype(noninteract)==V_UNDEF)
     noninteract = false;
   end;
   OffMsgBox = noninteract;
   if(FindFirst(NSIShortName))
     if (not noninteract)
      if(VCLGetTrue("Начать загрузку справочника\r\n"+NSIShortName))
        LoadFileRB(NSIShortName);
      end;
     else
       return LoadFileRB(NSIShortName);
     end;
   else
     NsiMsgBox(" Нет файлов для загрузки ");
     return true;
   end;
onError (e)
   AddPtk ("Загрузка справочника " + fileMCIBic + ": " +ToOem(e.Message) + " | Модуль " + e.Module + " | Строка " + e.Line);
   return false;
end;



macro LoadFileSWB(namefile)
  TrnMsg = BtrMsg = "";
  TotalCount = MaxProgress = 0;
  var msgtype = "";

  var CountIns = 0;
  var CountUpd = 0;

  var BIC, Type_owner=0, BIC_owner = "", adres, name;


  if(Not Open(sprtxt,namefile))
    AddPtk("НСИ:Ошибка:Невозможно открыть файл "+ FileName(sprtxt));
    NsiMsgBox("Невозможно открыть файл "+FileName(sprtxt));
    return false;
  end;
  AddPtk("НCИ:Для загрузки открыт файл " + FileName(sprtxt));
  Rewind(sprtxt);

  var SQLStrInsert = "insert into sbanks(ID_TBIC,BIC,TYPE_EXT,BIC_EXT,NAME,COUNTRY,CITY,ADRES,TYPE_OWNER,BIC_OWNER,TYPE_ME,BIC_ME,ISLOCK,DISPATH,DATE_STAMP,TIME_STAMP,MODFLAG) "+
                                 "values(:ID_TBIC,:BIC,:TYPE_EXT,:BIC_EXT,:NAME,:COUNTRY,:CITY,:ADRES,:TYPE_OWNER,:BIC_OWNER,:TYPE_ME,:BIC_ME,:ISLOCK,:DISPATH,:DATE_STAMP,:TIME_STAMP,:MODFLAG)";

  var SQLStrUpdate = "update sbanks "+
                     "set TYPE_EXT=:TYPE_EXT,BIC_EXT=:BIC_EXT,NAME=:NAME,COUNTRY=:COUNTRY,CITY=:CITY,ADRES=:ADRES,TYPE_OWNER=:TYPE_OWNER, "+
                         "BIC_OWNER=:BIC_OWNER,TYPE_ME=:TYPE_ME,BIC_ME=:BIC_ME,ISLOCK=:ISLOCK,DISPATH=:DISPATH,DATE_STAMP=:DATE_STAMP,TIME_STAMP=:TIME_STAMP,MODFLAG=:MODFLAG "+
                     "where ID_TBIC=:ID_TBIC and BIC=:BIC";

  var q = TRslOraQuery();

  VclInitProgress(10000,"Загрузка справочника банков SWIFT");
    while(Next(sprtxt))

       BIC = substr(sprtxt.str,4,11);
       Type_owner=0;
       BIC_owner = "";

       if(substr(BIC,9,3)=="XXX");
         BIC  = substr(BIC,1,8);
       else
         Type_owner = TypeBankSWIFT;
         bic_owner  = substr(BIC,1,8);
       end;

       adres = trim(substr(sprtxt.str,324,35));
       if(Trim(substr(sprtxt.str,359,35))!="")
        adres=Trim(adres+" "+Trim(substr(sprtxt.str,359,35)));
       end;
       name =trim(substr(sprtxt.str,15,105));
       if(Trim(substr(sprtxt.str,120,71))!="")
         name=Trim(name+" "+Trim(substr(sprtxt.str,120,70)));
         name = trim(Substr(name, 1, 80))
       end;

       msgtype = trim(substr(sprtxt.str,1,3));
      if ((( msgtype == "FIA") OR ( msgtype == "FIM") OR ( msgtype == "FIU")))
       if (not ExistBank(TypeBankSWIFT,BIC))
        q.SqlText = SQLStrInsert;
        CountIns = CountIns + 1;
       else
        q.SqlText = SQLStrUpdate;
        CountUpd = CountUpd + 1;
       end; /* GetEQ or not Equal*/
      end;

      q.DeclareAndSet("ID_TBIC",TypeBankSWIFT,
                      "BIC",BIC,
                      "TYPE_EXT","",
                      "BIC_EXT","",
                      "NAME",name,
                      "COUNTRY",trim(substr(sprtxt.str,569,35)),
                      "CITY",trim(substr(sprtxt.str,190,35)),
                      "ADRES",adres,
                      "TYPE_OWNER",Type_owner,
                      "BIC_OWNER",bic_owner,
                      "TYPE_ME",0,
                      "BIC_ME","",
                      "ISLOCK",0,
                      "DISPATH",0,
                      "DATE_STAMP",date(),
                      "TIME_STAMP",time(),
                      "MODFLAG",0);

      if(NOT q.Execute())
        OraTrnRollback();
        msg = "Невозможно обновить справочник банков МЦИ:"+q.Error;
        AddPtk(msg);
        NsiMsgBox(msg);
        VclRemProgress();
        Close(sprdbf);
        return false;
      end;

      VclUseProgress(TotalCount = TotalCount + 1);
      if(TotalCount==10000)
        TotalCount=0;
      end;
    end;
  VclRemProgress();
/*
  if (not SprDeleteOld(TypeBankSWIFT))
   return false;
  end;
*/
  OraTrnCommit();
  close(sprtxt);
  AddPtk("НCИ:Загрузка окончена. Всего обработано:"+TotalCount+", обновлено: "+CountUpd+", добавлено:"+CountIns);
  return true;
end;

/* удаление файла справочника
   wich = 0 - bnkseek.dbf
          1 - fi.dat
  Возвращает false , если справочник есть , но его нельзя удалить
                     или если передан неправильный параметр wich.
  Если справочника нет -  возвращает true
*/
MACRO DeleteNsiFile (wich)
  var ppath = "";
  var ret = true;
  if (wich == DelBnkSeek)
   ppath = NSIInDir + fileMCIBic;
  elif (wich == DelFiDat)
   ppath = NSIInDir + fileSWIFTBic;
  else
   return false;
  end;
  if (ExistFile (ppath) )
    ret = DeleteFile (ppath);
    if (ret)
       AddPtk ("Загрузка НСИ : удален файл " + ppath);
    end;
  end;
  return ret;
END;


macro LoadSWB(noninteract)
   var ret = false;
   if (valtype(noninteract)==V_UNDEF)
     noninteract = false;
   end;
   OffMsgBox = noninteract;
   NSIShortName = NSIInDir+"\\" + fileSWIFTBic;
   if(FindFirst(NSIShortName))
     if (not noninteract)
      if(VCLGetTrue("Начать загрузку справочника\r\n"+NSIShortName))
        LoadFileSWB(NSIShortName);
      end;
     else
       return LoadFileSWB(NSIShortName);
     end;
   else
      NsiMsgBox(" Нет файлов для загрузки ");
      return true;
   end;
onError (e)
   AddPtk ("Загрузка справочника " + fileSWIFTBic + ": " +ToOem(e.Message) + " | Модуль " + e.Module + " | Строка " + e.Line);
   return false;
end;
