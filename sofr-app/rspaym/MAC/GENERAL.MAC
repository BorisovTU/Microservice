/*
   Макрофайл описания общих переменных
*/
import get;

const RN = "\r\n";

MACRO GetID_NKS (id_korr, id_sfi, KS_Code)
/*Возвращае ИД корсхемы контрагента id_korr в валюте id_sfi с кодом схемы KS_Code
Если KS_Code не задан или равен нулю, то вернется схема с минимальным кодом
*/

//  var SQLtext;
  var q = TRslOraQuery();;

  q.SQLtext = " select ks.id_nks "+
              " from nks ks "+
              " where ks.id_nkorr = :p1 and ks.id_sfi = :p2 ";

  q.DeclareAndSet("p1", id_korr, "p2", id_sfi);

  if(KS_Code)
    q.SQLtext = q.SQLtext +" and ks.code = :p3 ";
    q.DeclareAndSet("p3", KS_Code);
  else
    q.SQLtext = q.SQLtext +" order by ks.code";
  end;

  if (not q.Execute())
    RunError (toansi("Запрос выборки корсхемы: ошибка в запросе"));
  end;

  if(q.eof)
    return null;
  end;

  return int(q.rec.id_nks);

END;

/*формы документов*/
const Type_Doc_Paym   = GetIdByCode("nform","ID_NFORM",1);
const Type_Doc_RUS    = GetIdByCode("nform","ID_NFORM",4100);
const Type_Doc_MT100  = GetIdByCode("nform","ID_NFORM",4101);
const Type_Doc_MT103  = GetIdByCode("nform","ID_NFORM",4200);
const Type_Doc_MT200  = GetIdByCode("nform","ID_NFORM",4102);
const Type_Doc_MT202  = GetIdByCode("nform","ID_NFORM",4103);
const Type_Doc_MT900  = GetIdByCode("nform","ID_NFORM",4190);
const Type_Doc_MT910  = GetIdByCode("nform","ID_NFORM",4191);
const Type_Exp_Origin = GetIdByCode("nform","ID_NFORM",5000);
const Type_Doc_MT9XX  = GetIdByCode("nform","ID_NFORM",9000); /* Выписки 940, 950 */
const Type_Doc_MTn9X  = GetIdByCode("nform","ID_NFORM",6000); /*  */
const Type_Doc_MTn95  = GetIdByCode("nform","ID_NFORM",6005);/*MTn95*/
const Type_Doc_MTn96  = GetIdByCode("nform","ID_NFORM",6006);/*MTn96*/
const Type_Doc_MT54X  = GetIdByCode("nform","ID_NFORM",1540);
const Type_Doc_MT53X  = GetIdByCode("nform","ID_NFORM",1530);
const Type_Doc_MT518  = GetIdByCode("nform","ID_NFORM",1518);
const Type_Doc_MT3XX  = GetIdByCode("nform","ID_NFORM",1300);
const Type_Doc_MT6XX  = GetIdByCode("nform","ID_NFORM",1600);
const Type_JRNSPFS    = GetIdByCode("nform","ID_NFORM",60000);
const Type_Ass        = GetIdByCode("nform","ID_NFORM",   4); /*  */
const Type_Keys       = GetIdByCode("nform","ID_NFORM",   7); /*  */


/*классы документов*/
const Class_Doc_ODB    = GetIdByCode("spclass","ID_SPCLASS",1);
const Class_Doc_FIL    = GetIdByCode("spclass","ID_SPCLASS",2);
const Class_Doc_SWIFT  = GetIdByCode("spclass","ID_SPCLASS",3);
const Class_Doc_TELEX  = GetIdByCode("spclass","ID_SPCLASS",4);
const Class_Doc_MCI    = GetIdByCode("spclass","ID_SPCLASS",5);


/*Типы БИК */
const BICRus    = 10; /*тип  бика национальный */
const BicSWIFT  = 20; /*тип свифт бика*/
const BicTELEX  = 30; /*тип телекс бика*/
const BICRepo   = 40; /*тип репо бика*/


/*ID типов БИК*/
const BICRus_ID    = GetIdByCode("stbic","ID_stbic",10); /*тип  бика ЦБ РФ*/
const BicSWIFT_ID  = GetIdByCode("stbic","ID_stbic",20); /*тип свифт бика*/
const BicTELEX_ID  = GetIdByCode("stbic","ID_stbic",30); /*тип телекс бика*/
const BICRepo_ID   = GetIdByCode("stbic","ID_stbic",40); /*тип репо бика*/


/* Виды ассоциаций */
const ASS_RECV_REF       = GetIdByCode("sass","ID_SASS",1);
const ASS_SENT_REF       = GetIdByCode("sass","ID_SASS",2);
const ASS_SWIFT_REF      = GetIdByCode("sass","ID_SASS",3);
const ASS_SRS_REF        = GetIdByCode("sass","ID_SASS",4);
const ASS_RECV_ALLREF    = GetIdByCode("sass","ID_SASS",6);
const ASS_SENT_ALLREF    = GetIdByCode("sass","ID_SASS",5);


/* состояния*/
const StateSwiftLoaded        = GetIdByCode("sstate","ID_SSTATE",GetSetupValue("Депозитарий\\Состояния отправки/приема\\Принят")); /*Состояние после загрузки SWIFT               */
const StateSwiftProc          = GetIdByCode("sstate","ID_SSTATE",GetSetupValue("Депозитарий\\Состояния отправки/приема\\Обработан")); /*Состояние после обработки принятого               */
const StateSwiftProcErr       = GetIdByCode("sstate","ID_SSTATE",GetSetupValue("Депозитарий\\Состояния отправки/приема\\Обработан с ошибками")); /*Состояние после обработки принятого с ошибками               */
const StateSwiftNotLoaded     = GetIdByCode("sstate","ID_SSTATE",9500); /* SWIFT-сообщение непринято */
const StateNoKorr             = GetIdByCode("sstate","ID_SSTATE",5020); /* Не определен контрагент */
const StateYesDubl            = GetIdByCode("sstate","ID_SSTATE",5050); /* Дубликаты сообщений                         */
const ErrorStateSendSWIFT     = GetIdByCode("sstate","ID_SSTATE",9999); /*!!!*//* состояние если возникла ошибка при отправке в SWIFT*/

const StateSWIFTTERMGOOD      = GetIdByCode("sstate","ID_SSTATE",7510);
const StateSWIFTTERMREJE      = GetIdByCode("sstate","ID_SSTATE",7520);

const StateToSWIFT            = GetIdByCode("sstate","ID_SSTATE",7902); /* Отправляется в SWIFT */
const StateSent2SWIFT         = GetIdByCode("sstate","ID_SSTATE",7960); /* Отправлен в SWIFT                            */

const State_VIPReady          = GetIdByCode("sstate","ID_SSTATE",8000); /*Выписка готова к обработке*/
const StateIgnored            = GetIdByCode("sstate","ID_SSTATE",9300); /* Игнорирован */

const StateToREPO             = GetIdByCode("sstate","ID_SSTATE",7910); /* Отправляется в Репозитарий*/
const StateSent2REPO          = GetIdByCode("sstate","ID_SSTATE",7911); /* Отправлен в Репозитарий*/
const ErrorStateSendREPO      = GetIdByCode("sstate","ID_SSTATE",9990); /*!!!*//* состояние если возникла ошибка при отправке в Репозитарий*/
const StateIgnorABS           = GetIdByCode("sstate","ID_SSTATE",7914); /* Игнорирован АБС*/
const StateReceivedFromREPO   = GetIdByCode("sstate","ID_SSTATE",7912); /* Получен из НРД*/
const StateErrorABS           = GetIdByCode("sstate","ID_SSTATE",7915); /* Ошибка выгрузки в АБС*/

const StateToSPFS             = GetIdByCode("sstate","ID_SSTATE",7908); /* Отправляется в СПФС */
const StateSent2SPFS          = GetIdByCode("sstate","ID_SSTATE",7962); /* Отправлен в СПФС */

const StateToTelex            = GetIdByCode("sstate","ID_SSTATE",7909); /* Отправляется в Telex */
const StateSent2Telex         = GetIdByCode("sstate","ID_SSTATE",7961); /* Отправлен в Telex */

const StateNoKvit             = GetIdByCode("sstate","ID_SSTATE",5019); /* Не сквитовано */
const StateKvit               = GetIdByCode("sstate","ID_SSTATE",5018); /* Сквитовано */


/*идентификаторы шлюзов*/
const SwiftIdGate     = "SWIFT";
const SwiftRUR5IdGate = "SWIFT5";
const SPFSIdGate      = "СПФС";


Const SwiftImpFileNameMask = "*.*";
Const RepoImpFileNameMask  = "*.*";
Const SPFSImpFileNameMask  = "*.*";
/* расширение для отправляемых в SWIFT файлов*/
Const SwiftOutExt = ".mxl";

/* расширение для отправляемых в REPO файлов*/
Const RepoOutExt  = ".xml";

/* каталоги*/
const SwiftKvitDir      = GetSetupValue("SWIFT\\Каталоги\\SwiftKvitDir");
const SwiftOutDir       = GetSetupValue("SWIFT\\Каталоги\\SwiftOutDir");
const SwiftInDir        = GetSetupValue("SWIFT\\Каталоги\\SwiftInDir");
const SwiftArcDir       = GetSetupValue("SWIFT\\Каталоги\\SwiftArcDir");
const SwiftOutNostroDir = GetSetupValue("SWIFT\\Каталоги\\SwiftOutNostroDir");

const RepoKvitDir = GetSetupValue("Репозитарий\\Каталоги\\RepoKvitDir");
const RepoOutDir  = GetSetupValue("Репозитарий\\Каталоги\\RepoOutDir");
const RepoInDir   = GetSetupValue("Репозитарий\\Каталоги\\RepoInDir");
const RepoArcDir  = GetSetupValue("Репозитарий\\Каталоги\\RepoArcDir");
const RepoErrDir  = GetSetupValue("Репозитарий\\Каталоги\\RepoErrDir");

const TELEXOutDir  = GetSetupValue("TELEX\\Каталоги\\TelexOutDir");
const TELEXInDir   = GetSetupValue("TELEX\\Каталоги\\TelexInDir");
const TELEXArcDir  = GetSetupValue("TELEX\\Каталоги\\TelexArcDir");

const SPFSOutDir   = GetSetupValue("СПФС\\Каталоги\\SPFSOutDir");
const SPFSInDir    = GetSetupValue("СПФС\\Каталоги\\SPFSInDir");
const SPFSArcDir   = GetSetupValue("СПФС\\Каталоги\\SPFSArcDir");
const SPFSArcDirIn = GetSetupValue("СПФС\\Каталоги\\SPFSArcDir");

/* мои БИКи*/
const MyBic = GetKorrBic(BICRus);
const MySWIFTBic = GetKorrBic(BICSwIFT);


const ID_NKS_RUR6  = "SWIFTRU";/*ИД шлюза при котором транслитерировать по RUR6*/
const ID_NKS_RUS9  = "SWIFTRUS9";/*ИД шлюза при котором транслитерировать по RUS9*/
const ID_NKS_CLEAR = "SWIFT";  /*ИД шлюза при котором транслитерировать по CLEAR*/

const RepoTblTmpXML = "TMP_XML";

var   BankName = GetSetupValue("Настройки инициализации\\OWNNAME");
var   BankNode = GetSetupValue("Настройки инициализации\\OWNNODE");
var   O_RM_I   = GetSetupValue("Обмен с ПС БР\\Операционист");

var MTRecCls = Null;
var stdCls = NULL,
    mt103Cls = NULL,
    mt202Cls = NULL,
    mt200Cls = NULL,
    mtReccls9XX = NULL,
    mtReccls910 = NULL,
    mtReccls900 = NULL,
    mtRecclsn92 = NULL,
    mtRecclsn95 = NULL,
    mtRecclsn96 = NULL,
    mtRecclsn99 = NULL;

var CommentStr = "";
var OrigNameFile = "";
var NameFile_ = "";
var InpStr_ = "";

/*ШИФРОВАНИЕ*/
const MDG = GetSetupValue("SWIFT\\Формировать MDG");

const TlxBeginMarker = RN + ":20:",
      TlxEndMarker   = RN + ":END:",
      TlxFromIdMarker = "FROM:",
      TlxToIdMarker   = "TO:",
      TlxTypeFormMarker = ":TFM:";
const TlxBeginTag = "SFT YZYZ";
const TlxEndTag   = "NNNN SFT";

var FieldVersion = GetSetupValue("Настройки инициализации\\FIELDVERSION");

if(not StrLen(FieldVersion))
  FieldVersion = "VERSIONREC";
end;


const JRNSent2SPFS          = GetIdByCode("SCONFSTATE","ID_SCONFSTATE",1);
const JRNWaitKvi            = GetIdByCode("SCONFSTATE","ID_SCONFSTATE",2);
const JRNErrABS             = GetIdByCode("SCONFSTATE","ID_SCONFSTATE",7);
const JRNReceiveSPFS        = GetIdByCode("SCONFSTATE","ID_SCONFSTATE",102);

const EmailGroup = 25;
