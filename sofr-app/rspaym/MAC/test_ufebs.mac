/*15.11.2013 voikin Тестирование функций и процедур пакета RSP_UFEBS*/
const ToStateID = 101;
const NameFile = "..\\Text\\XML_UFEBS";


macro test_01
  var i;
  var ListNum = PayListNum();
  var ID = "";
  var VersionRec = "";
  var q0 = TRslOraQuery();
  var q1 = TRslOraQuery();
  var q2 = TRslOraQuery();
  var q3 = TRslOraQuery();
  var q4 = TRslOraQuery();
  var imp;
  var EDNo;
  var XML;
  var FullNameFile;

  AddPtk("PayListNum="+ListNum);


  VclInitProgress(ListNum, "ЋвЇа ўЄ  д ©«®ў 01");

  i = 0;
  q0.SqlText = " insert into TMP_STEPDOC(ID_PAYM,VARLEN,VR) values(:ID_PAYM,'Test UFEBS 01',:VR)";
  q1.SqlText = " begin  :ret := RSP_UFEBS.InsertTMPEPD('TMP_STEPDOC','01'); end;";
  //q1.SqlText = " begin  :ret := RSP_UFEBS.InsertEPDID(:ID_PAYM,:VR,'01'); end;";
  q1.DeclareAndSet("ret",0);
//  q2.SqlText = " begin  :OutXML := RSP_UFEBS.CreateXMLEPD('01',:EDNo); end;";
  q2.SqlText = " begin  :OutXML := RSP_UFEBS.CrtXMLUpd('01',:EDNo,:FileName); end;";
  q2.DeclareAndSetLOB("OutXML",XML);

  q3.SqlText = " begin  RSP_UFEBS.UpdateFileName(:FName,:EDNo); end;";
  q4.SqlText = " begin  :ret := RSP_GATE.MASSCHANGESTATE(:STATEID,'TMP_STEPDOC'); end;";
  q4.DeclareAndSet("STATEID",ToStateID);
  q4.DeclareAndSet("ret",0);

  XML = "";
  AddPtk("Start");

  while(i < ListNum)

    ID=VersionRec=0;
    PayListField(i,0,"id_paym",ID,"VersionRec",VersionRec);
//  AddPtk("ID="+ID+" VersionRec="+VersionRec);
    if(NOT ID)
     runerror (toansi("ЋиЁЎЄ  Ї®«гзҐ­Ёп Ё¤Ґ­вЁдЁЄ в®а "));
    end;

    q0.DeclareAndSet("ID_PAYM",ID, "VR", VersionRec);
    if(NOT q0.Execute)/*вставка во временную таблицу*/
     runerror(toansi(q0.Error));
    end;

    if(NOT q1.Execute)   /*InsertEPDTMP*/
     runerror(toansi(q1.Error));
    end;


    EDNo = q1.GetVariable("ret");

//  AddPtk("EDNo="+EDNo);

    if(NOT EDNo)
     runerror (toansi("ЋиЁЎЄ  Ї®«гзҐ­Ёп Ё¤Ґ­вЁдЁЄ в®а  ¤®Єг¬Ґ­в "));
    end;

//  AddPtk("EDNo="+EDNo);
    


    q2.DeclareAndSet("EDNo", EDNo);

    FullNameFile = NameFile+EDNo+".xml";

    q2.DeclareAndSet("FileName", FullNameFile);
    q2.Execute;/*CreateXMLEPD - формирование XML*/
    XML = q2.GetVariable("OutXML");
//  AddPtk("XML="+XML);
//    XML="33333";

    if(XML!="")
//      FullNameFile = NameFile+EDNo+".xml";
      /*вывод в файл сформированного XML*/
//      if(WriteStrToFile(toansi(XML), FullNameFile))

//        q3.DeclareAndSet("FName",FullNameFile, "EDNo", EDNo);
//        q3.Execute;/*устанавливаем название файла и статус в таблице EPD*/

        q4.Execute;/*Смена состояния платежа*/
        imp = q4.GetVariable("ret");
        if(NOT imp)
          runerror (toansi("ЋиЁЎЄ  б¬Ґ­л б®бв®п­Ёп"));
        end;

//      OraTrnRollBack();

        OraTrnCommit();
//      else
//        OraTrnRollBack();
//      end;
    else
      OraTrnRollBack();
      runerror (toansi("ЋиЁЎЄ  Ї®«гзҐ­Ёп XML"));
    end;

    VclUseProgress(i = i + 1);
  end;

  VclRemProgress();
  AddPtk("Stop");
  RefreshScreen;
end;


macro test_02
  var i;
  var ListNum = PayListNum();
  var ID = "";
  var VersionRec = "";
  var q0 = TRslOraQuery();
  var q1 = TRslOraQuery();
  var q2 = TRslOraQuery();
  var q3 = TRslOraQuery();
  var q4 = TRslOraQuery();
  var imp;
  var EDNo;
  var XML;
  var FullNameFile;

  AddPtk("PayListNum="+ListNum);

  AddPtk("Start:");

  VclInitProgress(ListNum,"”®а¬Ёа®ў ­ЁҐ Ї ЄҐв ");

  i = 0;
  q0.SqlText = " insert into TMP_STEPDOC(ID_PAYM,VARLEN,VR) values(:ID_PAYM,'Test UFEBS 02',:VR)";


  while(i < ListNum)

    PayListField(i,0,"id_paym",ID,"VersionRec",VersionRec);
// AddPtk("ID="+ID+" VersionRec="+VersionRec);

    q0.DeclareAndSet("ID_PAYM",ID, "VR", VersionRec);
    q0.Execute;/*вставка во временную таблицу*/

	  VclUseProgress(i = i + 1);
  end;

  q1.SqlText = " begin  :ret := RSP_UFEBS.InsertEPDTMP('TMP_STEPDOC','02'); end;";
  q1.DeclareAndSet("ret",0);
  q2.SqlText = " begin  :OutXML := RSP_UFEBS.CreateXMLEPD('02',:EDNo); end;";
  q2.DeclareAndSetLOB("OutXML",XML);
  q3.SqlText = " begin  RSP_UFEBS.UpdateFileName(:FName,:EDNo); end;";
  q4.SqlText = " begin  :ret := RSP_GATE.MASSCHANGESTATE(:STATEID,'TMP_STEPDOC'); end;";
  q4.DeclareAndSet("STATEID",ToStateID);
  q4.DeclareAndSet("ret",0);


 AddPtk("”®а¬Ёа®ў ­ЁҐ Ї ЄҐв ");

  q1.Execute;/*InsertEPDTMP*/
  EDNo = q1.GetVariable("ret");
 AddPtk("EDNo ="+EDNo);

  q2.DeclareAndSet("EDNo", EDNo);
  q2.Execute;/*CreateXMLEPD - формирование XML*/
  XML = q2.GetVariable("OutXML");
//  AddPtk("XML ="+XML);

  if(XML!="")
    FullNameFile = NameFile+EDNo+".xml";
    /*вывод в файл сформированного XML*/
    if(WriteStrToFile(toansi(XML), FullNameFile))
      AddPtk("б®§¤ ­ д ©« "+FullNameFile);

 AddPtk("Ё§¬Ґ­Ґ­ЁҐ бв вгб  Ї ЄҐв ");
      q3.DeclareAndSet("FName",FullNameFile, "EDNo", EDNo);
      q3.Execute;/*устанавливаем название файла и статус в таблице EPD*/


 AddPtk("Ё§¬Ґ­Ґ­ЁҐ б®бв®п­Ё©");


      q4.Execute;/*Смена состояния платежа*/
      imp = q4.GetVariable("ret");

 AddPtk("‡ ўҐаиҐ­ЁҐ ва ­§ ЄжЁЁ");
      OraTrnCommit();
 AddPtk("ЋЄ");
    else
      OraTrnRollBack();
    end;
  else
    OraTrnRollBack();
  end;

  VclRemProgress();
  AddPtk("Stop:");
  RefreshScreen;
end;


macro test_01_PayDoc
  var i;
  var ListNum = PayListNum();
  var ID = "";
  var VersionRec = "";
  var q0 = TRslOraQuery();
  var q1 = TRslOraQuery();
  var q2 = TRslOraQuery();
  var q3 = TRslOraQuery();
  var imp;
  var EDNo;
  var XML;
  var FullNameFile;
  var PayDoc;

  PrintLn("PayListNum="+ListNum);

  PrintLN("Start:"+Time());

  VclInitProgress(ListNum);

  i = 0;
  q0.SqlText = " insert into TMP_STEPDOC(ID_PAYM,VR) values(:ID_PAYM,:VR)";
  q1.SqlText = " begin  :ret := RSP_UFEBS.InsertEPDTMP('TMP_STEPDOC','01'); end;";
  q1.DeclareAndSet("ret",0);
  q2.SqlText = " begin  :ret := RSP_UFEBS.CreateXMLEPD('01'); end;";
  q2.DeclareAndSet("ret","");
  q3.SqlText = " begin  RSP_UFEBS.UpdateFileName(:FName,:EDNo); end;";


  while(i < ListNum)

    PayDoc = PayListElem(i);

    q0.DeclareAndSet("ID_PAYM",PayDoc.Paym.ID_paym, "VR", PayDoc.Paym.VersionRec);
    q0.Execute;/*вставка во временную таблицу*/

    q1.Execute;/*InsertEPDTMP*/
    EDNo = q1.GetVariable("ret");

    q2.Execute;/*CreateXMLEPD - формирование XML*/
    XML = q2.GetVariable("ret");

    if(StrLen(XML) > 0)
      FullNameFile = NameFile+EDNo+".xml";
      /*вывод в файл сформированного XML*/
      if(WriteStrToFile(toansi(XML), FullNameFile))

        q3.DeclareAndSet("FName",FullNameFile, "EDNo", EDNo);
        q3.Execute;/*устанавливаем название файла и статус в таблице EPD*/

        if(PayDoc.ChangeState(ToStateID, 0, "Test UFEBS PayDoc"))
          OraTrnCommit();
        else
          OraTrnRollBack();
        end;
      else
        OraTrnRollBack();
      end;
    else
      OraTrnRollBack();
    end;

   VclUseProgress(i = i + 1);
  end;

	VclRemProgress();
  PrintLN("Stop:"+Time());
  RefreshScreen;
end;



