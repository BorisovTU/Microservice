/*****T:\payments_security\payments_test\MAC\SSWIFT.MAC*************************************************************************
 Отправка и прием документов в Swift формате

Настройка:
Изменения: 06.02.2013 voikin Добавлен поиск признаков дубликатов (PDM, PDE) в
                              блоках 4 и 5
*******************************************************************************/
import general, delzero,"empty.cls", bankinfo, utils,mtconsts/*, pcre_dlm*/,Fields,TransFld, ips_utils, sswift;

MACRO Sec_UnloadDocTrn(paymObj)
   var SentReference = "", NameFile, ArcPath = "", OutPath="", paym, mtrec, hdrform = "", tmp, strmsg;
   var ID_NKS = "";
   var fldIdxArr;
   var CurFld, CurFldNum, StrForTranslit;
   var i;
   var TextStart;
   var PrefixStr;
   Array TranslitedArr;

   paym  = paymObj.paym;
   if(paym.id_nform == Type_Doc_MTn9X)
     mtrec = paymObj.mtn9x;
   else
     mtrec = paymObj.mtrec;
   end;

   /* определение имени файла */
   NameFile = GetNewNameFile(paymObj);
   ArcPath = SwiftArcDir + NameFile;
   OutPath = SwiftOutDir + NameFile;

   if  (mtrec.type == 540)
     hdrform = "540";
   elif(mtrec.type == 541)
     hdrform = "541";
   elif(mtrec.type == 542)
     hdrform = "542";
   elif(mtrec.type == 543)
     hdrform = "543";
   elif(mtrec.type == 535)
     hdrform = "535";
   elif(mtrec.type == 536)
     hdrform = "536";
   elif(mtrec.type == 518)
     hdrform = "518";
   elif(mtrec.type == 599)
     hdrform = "599";
   end;

   /* подготовка строки сообщения для записи в файл */
   ID_NKS = GetFrnSys(paym.ID_NKSOUTPUT);
/*
   if((ID_NKS == ID_NKS_RUR6)or(ID_NKS == ID_NKS_RUS9))
     SentReference = "+";/*признак наличия в сообщение 3-го блока*/
   end;
*/
   if(hdrform == 599)
     strmsg = mtrec.text;
   else
     strmsg = mtrec.str;
   end;

   fldIdxArr = Re_SearchStr(RN+strmsg, "(?m)\\xd\\xa:\\d{2}[A-Z]?.*:", 1, 1);

   if (not fldIdxArr.size OR mod (fldIdxArr, 2))
     CommentStr = "Ошибка при разборе полей сообщения ";
     return false;
   end;


   if (not ParceFields2 (RN+strmsg, fldIdxArr))
     CommentStr = ErrMsg;
     return false;
   end;

   CurFldNum = 0;
   while(CurFldNum < CurMsgFields.Size)

     CurFld = CurMsgFields[CurFldNum];
     StrForTranslit = "";

     if(ValType(CurFld) != V_UNDEF)
       if(CurFld.Num == "35")
         var TransName = false;
         i = 0;
         while(i < CurFld.SubFields.size)
           if(   (not index(CurFld.GetSubField(i),"ISIN"))
              and(not index(CurFld.GetSubField(i),"/RU/"))
//              and(not index(CurFld.GetSubField(i),"/XX/CORP/")))/*если пошла информация о ФИ в текстовом виде*/
              and(not index(CurFld.GetSubField(i),"/XX/")))/*если пошла информация о ФИ в текстовом виде*/
              if(StrForTranslit == "")/*если еще не взяли поле*/
                StrForTranslit = Trim(CurFld.GetFldString(i,false,false));
                TextStart = i;/*Запомним, с какой подстроки начинается текст*/
              end;
              CurFld.Clear(i);/*чистим подполе*/
              TransName = true;
           end;
           i = i + 1;
         end;

         if(TransName)
            TranslitStrAndSplit(StrForTranslit,0,ID_NKS,TranslitedArr,35);
            CopyArrToSubfields(CurFld,TranslitedArr,TextStart);
         end;

       elif(   (CurFld.Num == "70")
            or((CurFld.Num == "95")and(CurFld.Option == "Q")))

         StrForTranslit = Trim(CurFld.GetFldString(0,false,false));

         TextStart = 0;
         ClearSubFields(CurFld,TextStart);
         TranslitStrAndSplit(StrForTranslit,0,ID_NKS,TranslitedArr,35);

         CopyArrToSubfields(CurFld,TranslitedArr,TextStart);
       elif   (CurFld.Num == "36")

         StrForTranslit = Trim(CurFld.GetFldString(0,false,false));

         TextStart = 0;
         ClearSubFields(CurFld,TextStart);
         TranslitStrAndSplit(StrForTranslit,0,ID_NKS,TranslitedArr,35);

         CopyArrToSubfields(CurFld,TranslitedArr,TextStart);
       elif    (CurFld.Num == "97")
         StrForTranslit = Trim(CurFld.GetFldString(0,false,false));
         PrefixStr = SubStr(StrForTranslit,1,7);/*первые 5 символов + 2 слеша - не транслитерируем*/
         StrForTranslit = "12345//"+SubStr(StrForTranslit,8);

         TextStart = 0;
         ClearSubFields(CurFld,TextStart);
         TranslitStrAndSplit(StrForTranslit,0,ID_NKS,TranslitedArr,35);
         TranslitedArr(0) = PrefixStr + SubStr(TranslitedArr(0),8);

         CopyArrToSubfields(CurFld,TranslitedArr,TextStart);
       elif   (CurFld.Num == "79")

         StrForTranslit = Trim(CurFld.GetFldString(0,false,false));

         TextStart = 0;
         ClearSubFields(CurFld,TextStart);
         TranslitStrAndSplit(StrForTranslit,0,ID_NKS,TranslitedArr,35," ");

         CopyArrToSubfields(CurFld,TranslitedArr,TextStart);
       end;
     end;


     CurFldNum = CurFldNum + 1;
   end;
   tmp = prheader(hdrform, /*SentReference*/ID_NKS, paym.ReceiverBankID) + RN;
   i = 0;
   while(i < CurMsgFields.Size)
     CurFld = CurMsgFields[i];
     if(ValType(CurFld) != V_UNDEF)
       tmp = tmp + CurFld.GetFldString(Null, False, True);
     end;
     i = i + 1;
   end;

//   tmp = tmp + RN + mtrec.str + RN;
   tmp = tmp + prend();
/*
   println("----------------------");
   println(tmp);
   return false;
*/
/*
   if (not SaveExp (paymObj, Tmp, Type_Exp_Origin, "Отправленное сообщение", CommentStr))
      return false;
   end;

   /* Сохранение исходящего референса */
   var qText = "begin RSP_PAYM_API.CRT_PAYMASSOCIATE (:p1,:p2,:p3); end;";
   var qry = ExecQuery (qText, paym.NUMREFERDOC, paym.ID_PAYM, ASS_SENT_REF);
   if (not TstObj (qry))
     CommentStr = "Ошибка при cохранении исходящего референса ";
     return false;
   end;

   CommentStr = "";

   if(not paymObj.ChangeState(StateSent2SWIFT, 0,"сформирован файл "+NameFile))
     CommentStr = "ошибка " + paymObj.Error + " при изменении состояния платежа " + ToId(paymObj.id_paym);
     return false;
   end;
*/
   return tmp;

END;
