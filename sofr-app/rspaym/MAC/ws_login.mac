/*
$Name:        ws_login.mac
$Module:      Web-®¡é¥¥
$Description: Œ ªà®á á à¥ «¨§ æ¨¥© á¥à¢¨á®¢ ¢å®¤  ¢ á¨áâ¥¬ã
*/

import "ws_usermenu.mac";


class LoginResponse

  var LoginInfoStr;
  var OperData;
  var VersionInfo;

end;

class VersionInfo
  var ProgramVersion : string;   /* ‚¥àá¨ï ¯à®£à ¬¬ë */
  var DBVersion      : string;   /* ‚¥àá¨ï „ */
end;





class ErrorInfo
  var Code;
  var Str = "";
end;


class OperData

  var Oper;
  var kbdlockmethod;
  var kbdlocktime;

  var BPromUse;
  var BranchCurDate;
  var Name_Oper;
  var OurBank;
  var curdate;
  var Name_Boss;
  var FIO_Boss;
  var Name_Book;
  var FIO_Book;
  var NumDprt;
  var MFO_Bank;
  var Name_Bank;
  var Post_Addr;
  var Real_Addr;
  var Legal_Addr;
  var CORAC_Bank;
  var INN_Bank;
  var MFO_RCC;
  var OperDprt;
  var OperDprtName;
  var OperDprtBranchName;
  var OperDprtNode;
  var OperDprtNodeName;
  var OperDprtNodeBranchName;
  var cTypePerson;
  var cRealTypePerson;
  var GroupOperL;
  var GroupOperF;
  var ISONatCur;
  var CCYNatCur;
  var ResidentCountryCode;
  var ResidentCountryCodeNum;
  var HeadBankID;
  var DprtCurDate;
  var OperMenu;
  var MaxRowsOnPageInDataGrid;
  var RowsOnPageInDataGrid;
  var IsSpellCheckingEnabled;
  var IsCriticalActionEnabled;
  var TermPath;
  var TermPathSettingName;
  var AccNumberTemplateList;
  var AccNumberTemplateDefault;

end;

macro _GetVersionInfo()
    var info = VersionInfo();
    GetProgramInformation(info.ProgramVersion, info.DBVersion);
    return info;
end;

macro GetOperData()

  var p = OperData();
  p.Oper={Oper};

  //p.BPromUse = {BPromUse};
  //p.BranchCurDate = {BranchCurDate};
  //p.Name_Oper = {Name_Oper};
  //p.OurBank = {OurBank};

  if ({CurDate} == Date(0, 0, 0))
//      p.CurDate = Date(1, 1, 1);
      p.CurDate = null;
  else
      p.CurDate = {CurDate};
  end;
  if ({BankDate} == Date(0, 0, 0))
//      p.DprtCurDate = Date(1, 1, 1);
      p.DprtCurDate = null;
  else
      p.DprtCurDate = {BankDate};
  end;
  //p.Name_Boss = {Name_Boss};
  //p.FIO_Boss = {FIO_Boss};
  //p.Name_Book = {Name_Book};
  //p.FIO_Book = {FIO_Book};
  p.NumDprt = {NumNode};
  //p.MFO_Bank = {MFO_Bank};
  //p.Name_Bank= {Name_Bank};
  //p.Post_Addr= {Post_Addr};
  //p.Real_Addr= {Real_Addr};
  //p.Legal_Addr= {Legal_Addr};
  //p.CORAC_Bank= {CORAC_Bank};
  //p.INN_Bank= {INN_Bank};
  //p.MFO_RCC= {MFO_RCC};
  p.OperDprt = {NumNode};
  //p.OperDprt= {OperDprt};
  p.OperDprtBranchName=string({NumNode});
  //p.OperDprtName=string("wwww");

  //GetBranchName({OperDprt}, p.OperDprtBranchName, p.OperDprtName);
  p.OperDprtNode= {NumNode};
  //GetBranchName({OperDprtNode}, p.OperDprtNodeBranchName, p.OperDprtNodeName);
  //p.cTypePerson= {cTypePerson};
  //p.cRealTypePerson= {cRealTypePerson};
  //p.GroupOperL= {GroupOperL};
  //p.GroupOperF= {GroupOperF};
  //p.ISONatCur= {ISONatCur};
  //p.CCYNatCur= {CCYNatCur};
  //p.ResidentCountryCode= {ResidentCountryCode};
  //p.ResidentCountryCodeNum= {ResidentCountryCodeNum};
  //p.HeadBankID= {HeadBankID};





  p.kbdlockmethod   = int(GetSetupValue("WEBCLIENT\\…‡Ž€‘Ž‘’œ\\KBDLOCKMETHOD"));       //p.GetRegValue("BANK_INI\\Ž™ˆ… €€Œ…’›\\…‡Ž€‘Ž‘’œ\\KBDLOCKMETHOD", V_INTEGER);
  p.kbdlocktime     = int(GetSetupValue("WEBCLIENT\\…‡Ž€‘Ž‘’œ\\KBDLOCKTIME"));         //p.GetRegValue("BANK_INI\\Ž™ˆ… €€Œ…’›\\…‡Ž€‘Ž‘’œ\\KBDLOCKTIME"  , V_INTEGER);
  p.RowsOnPageInDataGrid     = int(GetSetupValue("WEBCLIENT\\‘ŠŽ‹‹ˆƒ\\‘’ŽŠ € ‘’€ˆ–…"));      //p.GetRegValue("WEBCLIENT\\‘ŠŽ‹‹ˆƒ\\‘’ŽŠ € ‘’€ˆ–…"      , V_INTEGER);
  p.MaxRowsOnPageInDataGrid  = int(GetSetupValue("WEBCLIENT\\‘ŠŽ‹‹ˆƒ\\‘’ŽŠ € ‘’€ˆ–… Œ€Š‘")); //p.GetRegValue("WEBCLIENT\\‘ŠŽ‹‹ˆƒ\\‘’ŽŠ € ‘’€ˆ–… Œ€Š‘" , V_INTEGER);
  p.IsSpellCheckingEnabled   = GetSetupValue("WEBCLIENT\\Ž”Žƒ€”ˆŸ\\‚Š‹ž—ˆ’œ Ž‚…Š“");     //p.GetRegValue("WEBCLIENT\\Ž”Žƒ€”ˆŸ\\‚Š‹ž—ˆ’œ Ž‚…Š“"     , V_BOOL);
  //p.IsCriticalActionEnabled  = p.GetRegValue("COMMON\\Šˆ’ˆ—›… Ž…€–ˆˆ\\‚Š‹ž—…_WEB"      , V_BOOL);

  //p.TermPathSettingName = "WEBCLIENT\\EASYWIN_EXECUTION\\TERMINAL_PATH";
  //p.TermPath = p.GetRegValue(p.TermPathSettingName, V_STRING);
  p.TermPath = GetSetupValue("WEBCLIENT\\EASYWIN_EXECUTION\\TERMINAL_PATH");
  p.AccNumberTemplateList = TArray();

  //GetAccountNumberMaskTemplate( @p.AccNumberTemplateDefault, p.AccNumberTemplateList );
  p.AccNumberTemplateDefault = "$$$$$.$$$.$.$$$$$$$$$$$";

  p.OperMenu = GetProgramsWithMenu();

  return p;

end;

macro GetOperMenu()
//runerror("menu");
  return GetProgramsWithMenu();
end;


/*
 *  ‘¥à¢¨á à §¡«®ª¨à®¢ª¨ íªà ­ 
 */

macro Unblock(InStr : string)
  return WebUnblock(InStr);
end;


/*
 *  ‘¥à¢¨á ¢ëå®¤  ¨§ á¨áâ¥¬ë
 */

macro Logout( InStr : string )
  WebLogout( InStr );
end;


/*
 *  ‘¥à¢¨á ¨­ä®à¬¨à®¢ ­¨ï ®¡  ªâ¨¢­®áâ¨ Web-á¥áá¨¨
 */

macro Ping(InStr : string)
  return WebPing(InStr);
end;



/*
 *  ‘¥à¢¨á ãáâ ­®¢ª¨ ­®¢®£® ¯ à®«ï ¯®«ì§®¢ â¥«ï
 */
macro SetNewOperPwd(InStr : string)
  return WebSetNewOperPassword(InStr);
end;



//á¥à¢¨á ¯à®¢¥àª¨ ¢®§¬®¦­®áâ¨ á¬¥­ë ¯ à®«ï
macro CheckChangePwd(Oper)
  var p = ErrorInfo();

  p.Code=0;  //¢á¥£¤  ¬®¦­® ¬¥­ïâì.
  return p;
end;


/*
 *  ‘¥à¢¨á ¯à®¢¥àª¨ ¯ à®«ï ¯®«ì§®¢ â¥«ï
 */
macro CheckPwd(InStr : string)
  return WebCheckPassword(InStr);
end;


// 6

macro OpWriteAuditLog(Oper)
  var p = ErrorInfo();
/*  p.Code = OperWriteAuditLog(Oper);
  if(p.Code > 0)
    p.GetStr();
  end;
*/

  addptk("ˆ§¬¥­¥­ ¯ à®«ì ¯®«ì§®¢ â¥«¥¬ "+{Oper});
  p.Code=0;

  return p;
end;




/*
 *  ‘¥à¢¨á ¢å®¤  ¢ á¨áâ¥¬ã
 */

macro LoginProc(InStr : string, sysinput)
  var response = LoginResponse();
  response.LoginInfoStr = WebLogin(InStr,sysinput);
  response.OperData     = GetOperData();
  response.VersionInfo  = _GetVersionInfo();

  return response;
end;

 
/*
 *  ‘¥à¢¨á ¢å®¤  ¢ á¨áâ¥¬ã ¯® ¯ à®«î
 */
macro Login(InStr : string)
  var tmpoper = {oper};
  var response = LoginProc(InStr);

  if( NOT strlen({oper})) //­¥â ¯®«ì§®¢ â¥«¥©
     response.OperData.Oper = tmpoper;
  end;

  return response;
end;


/*
 *  ‘¥à¢¨á ¢å®¤  ¢ á¨áâ¥¬ã  ç¥à¥§ SSO
 */
macro SSOLogin(InStr : string)
  return LoginProc(InStr , 2);
end;
