import general, ws_panel;

class (IWindow) GetKeysPanel(params)
    var wParams = Xml2Rsl(params);
    var Side = wParams.Side;

    Title = "Ввод "+IIF(Side == "L", "левой", "правой")+" части ключа";
    WindowParams = makeObj(
                           "IWindowParams",
                           "Width", 360,
                           "Height", 200,
                           "HelpPage", "",
                           "IsModal", true,
                           "IsResizing", false
                          );
    Appearance = WindowAppearanceType.ExecutePanel;
    SysButtons = makeArray(
                           makeObj(
                                   "ISysButton",
                                   "Name", PredefinedSysButton.Execute,
                                   "Service", WebServiceCallback("keys_w", IIF(Side == "L", "KeyLeft", "KeyRight"), params)
                                  )
                          );
    Fields = makeArray(
		       makeObj("IPanelItem",
                                "Id", Id,
                                "Row", 0,
                                "Type", PanelItemType.Input,
                                "Field", makeObj("IInput",
  			                         "Type", PanelInputFieldType.String,
			                         "Label", "Ключ  ",
			                         "ReadOnly", false,
			                         "Enabled", true,
			                         "TabStop", true,
			                         "ClearButton", false,
			                         "Required", false,
                                                 "MaxLength",16,
			                         "Source", "Operation",
			                         "DefaultValue", "*",
                                                 "Location", makeObj(
                                                                     "ILocation",
                                                                     "MinWidth", 260,
                                                                     "Width", 260,
                                                                     "StretchHorizontal", false,
                                                                     "StretchVertical", false,
                                                                     "MarginLeft", 40
                                                                    )
                     	                        )
			      )
                      );
    Model = makeObj("TDynamicBean", "Operation", "");
end;

macro SaveKeyLeft (params)
  var keyDate = params.Model.KEYS8KEYDATE;

  if(ValType(keyDate) == V_DATE)
    var wParams = Xml2Rsl(params.Params);
    wParams.Side = "L";
    wParams.CurrentRow = params.Model;
    return WebServiceResult(WebServiceResultType.Window, GetKeysPanel(Rsl2Xml(wParams)));
  else
     return WebServiceResult(WebServiceResultType.Message, IMessage("Ошибка", "Не задана дата действия ключа.", MessageBoxType.Error));
  end;
end;

private macro CodingKey (key)
  var EncrKey = "";
  var Encrypt = TRslOraQuery();

  Encrypt.SqlText = "begin :EncrKey := RSP_ENCODE.Encrypt(:Str); end;";
  Encrypt.DeclareAndSet("EncrKey", EncrKey, "Str", Key);

  if(not Encrypt.Execute)
    RunError(toansi(Encrypt.Error));
  end;

  EncrKey = Encrypt.GetVariable("EncrKey");

  return EncrKey;
end;

macro KeyLeft (params)
  var wParams = Xml2Rsl(params.Params);
  var CurrentRow = wParams.CurrentRow;
  var key = params.Model.Operation;
  var KeysId = 0;

  if(CurrentRow.KEYS8ID_KEYS)
    KeysId = int(CurrentRow.KEYS8ID_KEYS);
  end;

  var PayDoc = TRslPayDoc(Type_Keys, KeysId);
  PayDoc.rec.KEYS8KEYDATE = CurrentRow.KEYS8KEYDATE;

  if(key)
    PayDoc.rec.KEYS8KEYLEFT = CodingKey(key);
  else
    PayDoc.rec.KEYS8KEYLEFT = key;
  end;

  CurrentRow.KEYS8ID_KEYS    = PayDoc.rec.KEYS8ID_KEYS;
  CurrentRow.KEYS8VERSIONREC = PayDoc.rec.KEYS8VERSIONREC;
  CurrentRow.KEYS8KEYLEFT    = PayDoc.rec.KEYS8KEYLEFT;

  return WebServiceResult(WebServiceResultType.Action, makeArray(IAction(WebServiceActionType.Close),
                                                                 IAction(WebServiceActionType.UpdateParentModel, CurrentRow)));
end;

macro SaveKeyRight (params)
  var keyDate = params.Model.KEYS8KEYDATE;

  if(ValType(keyDate) == V_DATE)
    var wParams = Xml2Rsl(params.Params);
    wParams.Side = "R";
    wParams.CurrentRow = params.Model;
    return WebServiceResult(WebServiceResultType.Window, GetKeysPanel(Rsl2Xml(wParams)));
  else
    return WebServiceResult(WebServiceResultType.Message, IMessage("Ошибка", "Не задана дата действия ключа.", MessageBoxType.Error));
  end;
end;

macro KeyRight (params)
  var wParams = Xml2Rsl(params.Params);
  var CurrentRow = wParams.CurrentRow;
  var key = params.Model.Operation;
  var KeysId = 0;

  if(CurrentRow.KEYS8ID_KEYS)
    KeysId = int(CurrentRow.KEYS8ID_KEYS);
  end;

  var PayDoc = TRslPayDoc(Type_Keys, KeysId);
  PayDoc.rec.KEYS8KEYDATE  = CurrentRow.KEYS8KEYDATE;

  if(key)
    PayDoc.rec.KEYS8KEYRIGHT = CodingKey(key);
  else
    PayDoc.rec.KEYS8KEYRIGHT = key;
  end;

  CurrentRow.KEYS8ID_KEYS    = PayDoc.rec.KEYS8ID_KEYS;
  CurrentRow.KEYS8VERSIONREC = PayDoc.rec.KEYS8VERSIONREC;
  CurrentRow.KEYS8KEYRIGHT   = PayDoc.rec.KEYS8KEYRIGHT;

  return WebServiceResult(WebServiceResultType.Action, makeArray(IAction(WebServiceActionType.Close),
                                                                 IAction(WebServiceActionType.UpdateParentModel, CurrentRow)));
end;
